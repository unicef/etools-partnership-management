<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-behavior.html">

<link rel="import" href="../../../app-config/app-dexie-db-config.html">
<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">
<link rel="import" href="../../../app-elements/static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="agreement-item-data">

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'agreement-item-data',
        behaviors: [
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsLogsBehavior,
          EtoolsPmpApp.Behaviors.AjaxServerErrors,
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore
        ],
        properties: {
          agreementEndpoints: {
            type: Object,
            value: {
              DETAILS: 'agreementDetails',
              CREATE: 'agreements'
            }
          },
          agreement: {
            type: Object,
            readOnly: true,
            notify: true
          },
          _partners: {
            type: Object
          },

          agreementId: {
            type: Number,
            notify: true,
            observer: '_agreementIdChanged'
          },

          handleSuccResponseAdditionalCallback: Object,
          /**
           * ajaxLoadingMsgSource use is required for request errors handling in AjaxServerErrorsBehavior
           */
          ajaxLoadingMsgSource: {
            type: String,
            value: 'ag-data'
          }
        },
        actions: {
          addEditAgreement: function(agreement) {
            return {
              type: 'ADD_EDIT_AGREEMENT',
              agreement: agreement
            };
          }
        },

        _triggerAgreementRequest: function(options) {
          let self = this;
          let ajaxMethod = options.method || 'GET';
          this.sendRequest(options).then(function(resp) {
            self._handleSuccResponse(resp, ajaxMethod);
          }).catch(function(error) {
            self.handleErrorResponse(error, ajaxMethod, true);
          });
        },

        _agreementIdChanged: function(newId) {
          if (newId) {
            this.fire('global-loading', {
              message: 'Loading agreement data...',
              active: true,
              loadingSource: this.ajaxLoadingMsgSource
            });
            this._triggerAgreementRequest({endpoint: this.getEndpoint(this.agreementEndpoints.DETAILS, {id: newId})});
          }
        },
        /**
         * Handle received data from request
         */
        _handleSuccResponse: function(response, ajaxMethod) {
          this._setAgreement(response);

          // call additional callback, if any
          if (typeof this.handleSuccResponseAdditionalCallback === 'function') {
            this.handleSuccResponseAdditionalCallback.bind(this, response)();
            // reset callback
            this.set('handleSuccResponseAdditionalCallback', null);
          }
          if (ajaxMethod !== 'GET') {
            this.dispatch('addEditAgreement', this._getMinimalAgreementData(response));

            let self = this;
            // update the agreement list in dexieDB
            EtoolsPmpApp.DexieDb.table('agreements').put(response).then(function() {
              self.fire('reload-list');
            });
          }
          this.fire('global-loading', {active: false, loadingSource: this.ajaxLoadingMsgSource});
        },

        _getMinimalAgreementData: function(detail) {
          let minimalAgrData = {
            agreement_number: '',
            agreement_type: '',
            end: null,
            id: null,
            partner: null,
            partner_name: null,
            signed_by: null,
            signed_by_partner_date: null,
            signed_by_unicef_date: null,
            start: null,
            status: ''
          };
          let propName;
          for (propName in minimalAgrData) {
            if (!detail.hasOwnProperty(propName)) {
              this.logWarn('Mapping property not found');
            } else {
              minimalAgrData[propName] = detail[propName];
            }
          }
          return minimalAgrData;
        },

        /**
         * Update agreement status. In addition set a callback to be called after request is complete.
         */
        updateAgreementStatus: function(data, callback) {
          if (!data.agreementId) {
            this.fire('toast', {text: 'Invalid agreement ID', showCloseBtn: true});
          } else {
            if (['signed', 'suspended', 'terminated'].indexOf(data.status) > -1) {
              // status change is allowed
              // set additional callback if any
              if (callback) {
                this.set('handleResponseAdditionalCallback', callback);
              }
              this.fire('global-loading', {
                message: 'Changing agreement status...',
                active: true,
                loadingSource: this.ajaxLoadingMsgSource
              });
              let endpoint = this.getEndpoint(this.agreementEndpoints.DETAILS, {id: data.agreementId});
              // fire in the hole
              this._triggerAgreementRequest({
                method: 'PATCH',
                endpoint: endpoint,
                body: {
                  status: data.status
                }
              });
            } else {
              this.fire('toast',
                  {text: 'Changing status to \'' + data.status + '\' is not allowed!', showCloseBtn: true});
            }
          }
        },

        _hasFiles: function(list, property) {
          if (!Array.isArray(list) || (Array.isArray(list) && list.length === 0)) {
            return false;
          }
          let hasF = false;
          let i;
          for (i = 0; i < list.length; i++) {
            if (list[i][property] instanceof File) {
              hasF = true;
            } else {
              delete list[i][property];
            }
          }
          return hasF;
        },

        /**
         * Save agreement data
         */
        saveAgreement: function(agreement, succCallback) {
          if (typeof agreement === 'object' && Object.keys(agreement).length === 0) {
            this.fire('toast', {text: 'Invalid agreement data!', showCloseBtn: true});
          } else {
            let endpoint = null;
            let isNew = false;

            if (agreement.id) {
              // prepare PATCH endpoint
              endpoint = this.getEndpoint(this.agreementEndpoints.DETAILS, {id: agreement.id});
            } else {
              // new agreement, use POST method for the same endpoint
              endpoint = this.getEndpoint(this.agreementEndpoints.CREATE);
              isNew = true;
            }
            // remove id from data
            if (agreement.id) {
              delete agreement.id;
            }
            if (Object.keys(agreement).length > 0) {
              // set additional callback if any
              if (succCallback) {
                this.set('handleSuccResponseAdditionalCallback', succCallback);
              }
              let withUpload = false; // used to set multipart prop on etools-ajax
              if (agreement.hasOwnProperty('attached_agreement')) {
                if (agreement.attached_agreement instanceof File) {
                  withUpload = true;
                } else {
                  delete agreement.attached_agreement;
                }
              }
              if (this._hasFiles(agreement.amendments, 'signed_amendment')) {
                withUpload = true;
              }
              this.fire('global-loading', {
                message: 'Saving agreement data...',
                active: true,
                loadingSource: this.ajaxLoadingMsgSource
              });
              // fire in the hole
              let method = (isNew) ? 'POST' : 'PATCH';
              this._triggerAgreementRequest({method: method, endpoint: endpoint, body: agreement,
                multiPart: withUpload, prepareMultipartData: withUpload});
            } else {
              this.fire('toast', {
                text: 'There is nothing to save. No change detected on this agreement.',
                showCloseBtn: true
              });
            }
          }
        }

      });
    })();
  </script>

</dom-module>
