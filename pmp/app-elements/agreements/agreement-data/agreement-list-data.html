<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../../scripts/lodash/lodash.html">

<link rel="import" href="../../../app-behaviors/data-element-behavior.html">
<link rel="import" href="../../../app-config/etools-app-config.html">
<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="agreement-list-data">

  <template>

    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="agreements"
                 renew-data-on-expiry
                 on-success="_handleMyResponse"></etools-ajax>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'agreement-list-data',

        behaviors: [
          pmpBehaviors.DataElementBehavior,
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          etoolsAppConfig.globals
        ],

        properties: {

          endpointName: {
            type: String,
            value: 'agreements'
          },

          dataLoadedEventName: {
            type: String,
            value: 'agreements-loaded'
          },

          filteredAgreements: {
            type: Array,
            readOnly: true,
            notify: true
          },

          totalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },

          currentQuery: {
            type: Object,
            value: null
          }
        },
        actions: {
          setAgreements: function(agreements) {
            return {
              type: 'SET_AGREEMENTS',
              agreementsList: agreements
            };
          }
        },

        _handleMyResponse: function(res) {
          this._handleResponse(res);
          this.dispatch('setAgreements', res.detail);
        },

        query: function(field, order, searchString, agreementType,
                        agreementStatus, selectedPartnerNames, startDate,
                        endDate, pageNumber, pageSize, showQueryLoading) {

          // If an active query transaction exists, abort it and start
          // a new one
          if (this.currentQuery) {
            this.currentQuery.abort();
          }

          var _this = this;

          if (showQueryLoading) {
            this.fire('global-loading', {
              message: 'Loading agreements list data...',
              active: true,
              loadingSource: 'ag-list'
            });
          }

          this.db.transaction('r', this.db.agreements, function() {
            this.currentQuery = Dexie.currentTransaction;

            var queryResult = _this.db.agreements;
            if (field) {
              // note: null values don't appear in result set of sort
              queryResult = queryResult.orderBy(field);
            }
            if (order === 'desc') {
              queryResult = queryResult.reverse();
            }

            queryResult = queryResult.filter(function(agreement) {

              if (selectedPartnerNames &&
                  selectedPartnerNames.length &&
                  !_.includes(selectedPartnerNames, agreement.partner_name)) {
                return false;
              }

              if (agreementType && agreement.agreement_type !== agreementType) {
                return false;
              }

              if (agreementStatus && agreement.status !== agreementStatus) {
                return false;
              }

              if (startDate && startDate.length &&
                  (!agreement.start || agreement.start <= startDate)) {
                return false;
              }

              if (endDate && endDate.length &&
                  (!agreement.end || agreement.end >= endDate)) {
                return false;
              }

              if (searchString && searchString.length &&
                  agreement.agreement_number.toLowerCase().indexOf(searchString) < 0 &&
                  agreement.partner_name.toLowerCase().indexOf(searchString) < 0) {
                return false;
              }

              return true;
            });

            // This special Dexie function allows the work of counting
            // the number of query results to be done in a parallel process,
            // instead of blocking the main query
            Dexie.ignoreTransaction(function() {
              queryResult.count(function(count) {
                _this._setTotalResults(count);
              });
            });

            return queryResult
                .offset((pageNumber - 1) * pageSize)
                .limit(pageSize)
                .toArray();

          }).then(function(result) {
            _this._setFilteredAgreements(result);
            _this.fire('global-loading', {active: false, loadingSource: 'ag-list'});
          }).catch(function(error) {
            console.error('Error querying agreements: ' + error);
            _this.fire('global-loading', {active: false, loadingSource: 'ag-list'});
          });
        }

      });
    })();
  </script>

</dom-module>
