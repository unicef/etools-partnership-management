<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">1
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../../bower_components/etools-loading/etools-loading-behavior.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<link rel="import" href="../required-field-flag/required-field-flag-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">

<link rel="import" href="../partners/partners-data/partners-data.html">

<link rel="import" href="agreement-behaviors/agreements-common-behavior.html">
<link rel="import" href="partner-authorized-officers.html">
<link rel="import" href="agreement-status.html">

<dom-module id="new-agreement">

  <template>

    <style include="page-layout-styles grid-layout-styles shared-styles file-styles">
      :host {
        @apply(--layout-horizontal);
        width: 100%;
        padding-bottom: 70px;
      }

      paper-input {
        width: 100%;
      }

    </style>

    <partners-data partners-dropdown-data="{{partnersDropdownData}}" prepare-dropdown-data></partners-data>

    <!-- main page content start -->
    <div id="pageContent">
      <etools-content-panel class="content-section" title="Agreement Details">
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Partner name -->
            <etools-searchable-multiselection-menu id="partner"
                                                   label="Partner Name"
                                                   placeholder="&#8212;"
                                                   options="[[partnersDropdownData]]"
                                                   on-value-change="_partnerSelected"
                                                   error-message="Please select a partner"
                                                   required>
            </etools-searchable-multiselection-menu>
          </div>
          <div class="col col-3">
            <!-- Agreement Type -->
            <etools-searchable-multiselection-menu id="agreementType"
                                                   label="Agreement Type"
                                                   placeholder="&#8212;"
                                                   options="[[_agreementTypes]]"
                                                   hide-search
                                                   on-value-change="_agreementTypeSelected"
                                                   error-message="Please select agreement type"
                                                   required>
            </etools-searchable-multiselection-menu>
          </div>
          <div class="col col-3">
            <!-- Reference Number -->
            <paper-input label="Reference Number"
                         placeholder="&#8212;"
                         disabled></paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-3">
            <!-- Start date -->
            <paper-input label="Start date"
                         value="[[prettyDate(agreement.start)]]"
                         on-down="openDatePicker"
                         data-selector="startDate"
                         placeholder="&#8212;">
              <etools-datepicker-button prefix
                                        id="startDate"
                                        format="YYYY-MM-DD"
                                        pretty-date="{{agreement.start}}"
                                        no-init show-clear-btn></etools-datepicker-button>
            </paper-input>
          </div>
          <div class="col col-3">
            <!-- End date -->
            <paper-input id="endDateField"
                         label="End date"
                         value="[[prettyDate(agreement.end)]]"
                         on-down="openDatePicker"
                         data-selector="endDate"
                         placeholder="&#8212;"
                         error-message="Please select end date"
                         required$="[[_validateStringValue(agreement.start)]]">
              <etools-datepicker-button prefix
                                        id="endDate"
                                        format="YYYY-MM-DD"
                                        pretty-date="{{agreement.end}}"
                                        no-init show-clear-btn></etools-datepicker-button>
            </paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed By Partner -->
            <etools-searchable-multiselection-menu id="signedBy"
                                                   label="Signed By Partner"
                                                   placeholder="&#8212;"
                                                   options="[[preparedDropdownOfficersData]]"
                                                   on-value-change="_signedByPartnerSelected"
                                                   error-message="Please select authorized officer"
                                                   required$="[[_validateStringValue(agreement.signed_by_partner_date)]]">
            </etools-searchable-multiselection-menu>
          </div>
          <div class="col col-3">
            <!-- Signed By Partner Date -->
            <paper-input id="signedByPartnerDateField"
                         label="Signed By Partner Date"
                         value="[[prettyDate(agreement.signed_by_partner_date)]]"
                         on-down="openDatePicker"
                         data-selector="signedByPartnerDate"
                         placeholder="&#8212;"
                         error-message="Please select signed by partner date"
                         required$="[[_validateIdValue(agreement.signed_by)]]">
              <etools-datepicker-button prefix
                                        id="signedByPartnerDate"
                                        format="YYYY-MM-DD"
                                        pretty-date="{{agreement.signed_by_partner_date}}"
                                        no-init show-clear-btn></etools-datepicker-button>
            </paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed By UNICEF -->
            <etools-searchable-multiselection-menu id="signedByUnicef"
                                                   label="Signed By UNICEF"
                                                   placeholder="&#8212;"
                                                   options="[[partnerSeniorManagers]]"
                                                   on-value-change="_signedByUnicefSelected"
                                                   error-message="Please select UNICEF staff"
                                                   required$="[[_validateStringValue(agreement.signed_by_unicef_date)]]">
            </etools-searchable-multiselection-menu>
          </div>
          <div class="col col-3">
            <!-- Signed By UNICEF Date -->
            <paper-input id="signedByUnicefDateField"
                         label="Signed By UNICEF Date"
                         value="[[prettyDate(agreement.signed_by_unicef_date)]]"
                         on-down="openDatePicker"
                         data-selector="signedByUnicefDate"
                         placeholder="&#8212;"
                         error-message="Please select signed by UNICEF date"
                         required$="[[_validateIdValue(agreement.partner_manager)]]">
              <etools-datepicker-button prefix
                                        id="signedByUnicefDate"
                                        format="YYYY-MM-DD"
                                        pretty-date="{{agreement.signed_by_unicef_date}}"
                                        no-init show-clear-btn></etools-datepicker-button>
            </paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6 no-overflow">
            <div class="file-wrapper">
              <etools-file files="{{agreement.attached_agreement}}"
                           label="Signed Agreement"
                           accept=".doc,.docx,.pdf,.jpg,.png"></etools-file>
            </div>
          </div>
        </div>
      </etools-content-panel>

      <!-- Partner Authorized Officers (partner staff members) -->
      <etools-content-panel class="content-section"
                            title$="Partner Authorized Officers ([[authorizedOfficersIds.length]])">
        <partner-authorized-officers id="authorizedOfficers"
                                     selected-officers-ids="{{authorizedOfficersIds}}"
                                     dropdown-officers-data="[[preparedDropdownOfficersData]]"
                                     edit-mode required$="[[_signedByValuesFilledAndValid(agreement.signed_by, agreement.signed_by_partner_date, agreement.partner_manager, agreement.signed_by_unicef_date)]]"></partner-authorized-officers>
      </etools-content-panel>

    </div> <!-- main page content end -->

    <!-- sidebar content start -->
    <div id="sidebar">
      <agreement-status status="draft" on-save-agreement="_saveAgreement"></agreement-status>
    </div>
    <!-- sidebar content end -->


  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'new-agreement',

        behaviors: [
          pmpBehaviors.requiredFieldFlagBehavior,
          pmpBehaviors.DateBehavior,
          pmpBehaviors.AgreementsCommonBehavior,
          etoolsBehaviors.LoadingBehavior
        ],

        properties: {
          agreement: {
            type: Object,
            value: {
              id: null,
              partner: null,
              agreement_type: null,
              start: null,
              end: null,
              signed_by: null,
              signed_by_partner_date: null,
              partner_manager: null,
              signed_by_unicef_date: null,
              attached_agreement: [] // 1 file
            }
          },

          partnerAuthorizedOfficers: {
            type: Array,
            value: []
          },

          preparedDropdownOfficersData: {
            type: Array,
            notify: true
          }
        },

        observers: [
          '_startOrEndDateChanged(agreement.start, agreement.end)',
          '_signedByFieldsChanged(agreement.signed_by, agreement.signed_by_partner_date, ' +
            'agreement.partner_manager, agreement.signed_by_unicef_date)',
        ],

        ready: function() {

          // create loading element, used for saving functionality
          this.savingAgreementLoading = this.createLoading('Saving the new agreement, please wait...');
          this.set('authorizedOfficersIds', []);

          this.set('_agreementTypes', [
            {
              value: 1,
              label: 'PCA'
            },
            {
              value: 2,
              label: 'SSFA'
            },
            {
              value: 3,
              label: 'MOU'
            },
          ]);

          // TODO: replace this placeholder data with the right partner authorized officers data (staff members data)
          this.set('partnerAuthorizedOfficers', [
            {
              id: 1,
              position: 'Program Officer',
              first_name: 'John',
              last_name: 'Doe',
              phone_number: '345345345',
              email_address: 'john.doe@unknown.com',
              active: true
            },
            {
              id: 2,
              position: 'Program Officer',
              first_name: 'Jane',
              last_name: 'Doe',
              phone_number: '345345345',
              email_address: 'jane.doe@unknown.com',
              active: true
            }
          ]);

          this.prepareDropdownOfficersData(this.partnerAuthorizedOfficers);

          // TODO: get etools(List of Staff) WHERE Group = 'Senior Management'
          this.set('partnerSeniorManagers', [
            {
              value: 1,
              label: 'John Doe from UNICEF Staff'
            },
            {
              value: 2,
              label: 'Jane Doe from UNICEF Staff'
            }
          ]);
        },

        attached: function() {
          // add required field flag to the label for the fields
          // that are required without depending on other fields values
          var requiredDropdownElements = Polymer.dom(this.root).querySelectorAll('#partner, #agreementType');
          if (requiredDropdownElements.length > 0) {
            requiredDropdownElements.forEach(function(element) {
              setTimeout(function() {
                this.addRequiredFieldFlag([Polymer.dom(element.root).querySelector('#singleSelectionDropdown')]);
              }.bind(this), 0);
            }.bind(this));
          }
        },

        detached: function() {
          // clean: remove loading element if the element is detached
          this.removeLoading(this.savingAgreementLoading);
        },

        /**
         * Get partner id from dropdown selection and add it to agreement
         */
        _partnerSelected: function(event) {
          var selectedPartner = event.detail.selectedValues;
          if (selectedPartner !== null) {
            this.set('agreement.partner', selectedPartner.value);
            this.$.partner.invalid = false;
          }
        },

        /**
         * Get agreement type string from dropdown selection and add it to the agreement
         */
        _agreementTypeSelected: function(event) {
          var selectedType = event.detail.selectedValues;
          if (selectedType !== null) {
            this.set('agreement.agreement_type', selectedType.label);
            this.$.agreementType.invalid = false;
          }
        },

        /**
         * End date is conditioned by the start date
         * if start date is entered, then the end date is required;
         * also, when end date changes, trigger the validation again.
         */
        _startOrEndDateChanged: function(start, end) {
          var endDateField = this.$.endDateField;
          endDateField.validate();
        },

        /**
         * SignedBy fields require condition depend on the selected values;
         * also officers are required if at least one of these fields are populated.
         */
        _signedByFieldsChanged: function(singedByPartnerId, signedByDateString,
                                         singedByUnicefId, signedByUnicefDateString) {
          /**
           * Signed by partner field is required in case signed by partner date field is filed, and
           * signed by partner date field is required in case signed by partner is selected
           */
          var signedByPartnerField = this.$.signedBy;
          var signedByPartnerDateField = this.$.signedByPartnerDateField;
          if (singedByPartnerId !== null || signedByDateString !== null) {
            signedByPartnerField.validate();
            signedByPartnerDateField.validate();
          }

          /**
           * Signed by unicef field is required in case signed by unicef date field is filed, and
           * signed by unicef date field is required in case signed by unicef manager is selected
           */
          var signedByUnicefField = this.$.signedByUnicef;
          var signedByUnicefDateField = this.$.signedByUnicefDateField;
          if (singedByUnicefId !== null || signedByUnicefDateString !== null) {
            signedByUnicefField.validate();
            signedByUnicefDateField.validate();
          }

          // also partner authorized officers field is required if at least one of these 4 fields was filed
          this.$.authorizedOfficers.validateOfficersSelection();
        },

        /**
         * Handling signed by partner selection. The partner id is needed and must be assigned to agreement.
         */
        _signedByPartnerSelected: function(event) {
          var selectedOfficer = event.detail.selectedValues;
          if (selectedOfficer !== null) {
            this.set('agreement.signed_by', selectedOfficer.value);
            this.$.signedBy.invalid = false;
          }
        },

        /**
         * Handling signed by unicef selection. The partner manager id is needed and must be assigned to agreement.
         */
        _signedByUnicefSelected: function(event) {
          var selectedUnicefManager = event.detail.selectedValues;
          if (selectedUnicefManager !== null) {
            this.set('agreement.partner_manager', selectedUnicefManager.value);
            this.$.signedByUnicef.invalid = false;
          }
        },

        /**
         * Save agreement if all fields are validated
         * beware: FAKE DATA :) ... until API integration
         */
        _saveAgreement: function() {
          if (this._validateAgreement()) {
            // fake new agreement save, only add it to localStorage to be able to use it later on details page
            // TODO: use the API to submit agreement data
            this.savingAgreementLoading.active = true;

            setTimeout(function() {
              // just a save simulation, put data in localstorage and wait 2 sec then close loading
              // fake id, this will be assigned on backend
              this.agreement.id = 1;
              // fake agreement_number, this will be assigned on backend too
              this.agreement.agreement_number = 'PCA 2015/29-3';
              localStorage.setItem('newAgreement', JSON.stringify(this.agreement));
              this.savingAgreementLoading.active = false;
              // TODO: check this event when API will be used here
              this.fire('new-agreement-saved', this.agreement);
            }.bind(this), 2000);
          } else {
            this.fire('toast', {text: 'Some fields are invalid!', showCloseBtn: true});
          }
        },

        /**
         * Validate agreement fields
         */
        _validateAgreement: function() {
          var valid = true;

          // validate partner
          if (this._validateIdValue(this.agreement.partner) === false) {
            valid = false;
            this.$.partner.invalid = true;
          }

          // validate agreement type
          if (this._validateStringValue(this.agreement.agreement_type) === false) {
            valid = false;
            this.$.agreementType.invalid = true;
          }

          // validate start date
          if (this._validateStringValue(this.agreement.start)) {
            // end date is required only if start date was selected
            if (this.$.endDateField.validate() === false) {
              valid = false;
            }
          }

          // validate signedByPartner and signedByPartnerDate and signedByManager and signedByManagerDate fields
          var validSignedByFields = this._validSignedByFields(this.agreement.signed_by,
              this.agreement.signed_by_partner_date, this.agreement.partner_manager,
              this.agreement.signed_by_unicef_date, true);
          if (validSignedByFields === false) {
            valid = false;
          }

          // validate partner authorized officers in case
          if (this._validateSelectedOfficers() === false) {
            valid = false;
          }

          return valid;
        },

        /**
         * Validate integer value
         */
        _validateIdValue: function(idValue) {
          var id = parseInt(idValue, 10);
          if (isNaN(id) || (!isNaN(id) && id <= 0)) {
            return false;
          }
          return true;
        },

        /**
         * Validate string value
         */
        _validateStringValue: function(stringValue) {
          if (typeof stringValue === 'string' && stringValue !== '') {
            return true;
          }
          return false;
        },

        /**
         * Validate signed by fields
         */
        _validSignedByFields: function(partnerId, partnerSignedDate, managerId, managerSignedDate, updateUi) {
          var valid = true;

          // validate signedByPartner and signedByPartnerDate
          var validSignedByPartner = this._validateIdValue(partnerId);
          var validSignedByPartnerDate = this._validateStringValue(partnerSignedDate);

          if (validSignedByPartnerDate) {
            // signed_by is required only if sign_by_partner_date was selected
            if (validSignedByPartner === false) {
              valid = false;
              if (updateUi) {
                this.$.signedBy.invalid = true;
              }
            }
          }

          if (validSignedByPartner) {
            if (validSignedByPartnerDate === false) {
              valid = false;
              if (updateUi) {
                this.$.signedByPartnerDateField.validate();
              }
            }
          }

          // validate signedByManager and signedByManagerDate fields
          var validSignedByPartnerManager = this._validateIdValue(managerId);
          var validSignedByPartnerManagerDate = this._validateStringValue(managerSignedDate);

          if (validSignedByPartnerManagerDate) {
            // signed by partner manager is required only if sign_by_unicef_date was selected
            if (validSignedByPartnerManager === false) {
              valid = false;
              if (updateUi) {
                this.$.signedByUnicef.invalid = true;
              }
            }
          }

          // validate signedByManagerDate
          if (validSignedByPartnerManager) {
            if (validSignedByPartnerManagerDate === false) {
              valid = false;
              if (updateUi) {
                this.$.signedByUnicefDateField.validate();
              }
            }
          }

          return valid;
        },

        /**
         * Validate officers selection
         */
        _validateSelectedOfficers: function() {
          var valid = true;
          if (this._signedByValuesFilledAndValid(this.agreement.signed_by, this.agreement.signed_by_partner_date,
                  this.agreement.partner_manager, this.agreement.signed_by_unicef_date)) {
            if (this.$.authorizedOfficers.validateOfficersSelection() === false) {
              valid = false;
            }
          }
          return valid;
        },

        /**
         * Check if signed by fields have at least one valid value
         */
        _signedByValuesFilledAndValid: function(signedByPartnerId, signedByPartnerDate,
                                         signedByPartnerManagerId, signedByPartnerManagerDate) {
          return this._validateIdValue(signedByPartnerId)
              || this._validateStringValue(signedByPartnerDate)
              || this._validateIdValue(signedByPartnerManagerId)
              || this._validateStringValue(signedByPartnerManagerDate);

        }

      });

    })();
  </script>

</dom-module>
