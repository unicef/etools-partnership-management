<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../app-elements/etools-status/etools-status.html">
<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<dom-module id="agreement-status">
  <template strip-whitespace>
    <style>
       :host {
        width: 100%;
      }
    </style>
    <etools-status statuses="[[possibleStatuses]]"
                    actions="[[possibleActions]]"
                    on-agreement-suspend-event="_setStatusSuspended"
                    on-agreement-terminate-event="_setStatusTerminated"
                    on-agreement-unsuspend-event="_unsuspendAgreement">
    </etools-status>
  </template>

  <script>
    (function() {
      'use strict';

      // TODO: Very important! this is 99% the same as agreement status.
      // Check if the statuses are the same and refactor this 2 elements

      Polymer({
        is: 'agreement-status',

        behaviors: [
          etoolsBehaviors.DynamicDialogBehavior,
          EtoolsLogsBehavior,
        ],
        properties: {
          agreementId: {
            value: null
          },
          agreementType: {
            type: String,
            value: ''
          },
          status: {
            type: String,
            value: ''
          },
          newStatus: {
            type: String,
            value: ''
          },
          newAgreement: {
            type: Boolean,
            value: false
          },
          possibleStatuses: {
            type: Array,
            value: function() {
              return [
                {
                  label: 'Draft',
                  hidden: false,
                  completed: false
                },
                {
                  label: 'Signed',
                  hidden: false,
                  completed: false
                },
                {
                  label: 'Suspended',
                  icon: 'av:pause-circle-filled',
                  iconStyles: 'color: ' + this.getComputedStyleValue('--warning-color'),
                  hidden: false,
                  completed: false
                },
                {
                  label: 'Terminated',
                  icon: 'report-problem',
                  iconStyles: 'color: ' + this.getComputedStyleValue('--error-color'),
                  hidden: false,
                  completed: false
                },
                {
                  label: 'Ended',
                  hidden: false,
                  completed: false
                },
              ];
            }
          },
          possibleActions: {
            type: Array,
            value: [
              {
                label: 'Save',
                hidden: true,
                primary: true,
                event: 'save-agreement'
                // save-agreement event is handeled by the parnent
              },
              {
                label: 'Suspend',
                hidden: true,
                event: 'agreement-suspend-event'
              },
              {
                label: 'Unsuspend',
                hidden: true,
                event: 'agreement-unsuspend-event'
              },
              {
                label: 'Terminate',
                hidden: true,
                event: 'agreement-terminate-event'
              },
            ]
          },
          warningDialog: Object,
          statusChangeWarningDialogContent: Object,
        },
        observers: [
          '_computeStatusesAndActions(status, agreementId)'
        ],

        ready: function() {
          this.statusChangeWarningDialogContent = document.createElement('p');
          this.statusChangeWarningDialogContent.setAttribute('id', 'statusChangeWarningContent');
          this.warningDialog = this.createDialog('Agreement status change', 'md', 'Yes', 'No',
              this._statusChangeConfirmationCallback.bind(this), this.statusChangeWarningDialogContent);
          this.warningDialog.customStyle['--paper-dialog-scrollable'] = 'var(--pmp-paper-dialog-content)';
          this.warningDialog.updateStyles();
        },

        detached: function() {
          if (this.warningDialog) {
            this.removeDialog(this.warningDialog);
          }
        },

        _showStatusChangeConfirmationDialog: function() {
          if (this.warningDialog) {
            var warningMessage = 'Are you sure you want to change status from: <strong>\''
              + this.status + '\'</strong> to <strong>\'' + this.newStatus + '\'</strong> ?';

            if (this.statusChangeWarningDialogContent) {
              this.statusChangeWarningDialogContent.innerHTML = warningMessage;
              this.warningDialog.opened = true;
            } else {
              this.logWarn('#statusChangeWarningContent element not found!', 'pmp agreement status change');
            }
          } else {
            this.logWarn('warningDialog not created!', 'pmp agreement status change');
          }
        },

        _setAllActionsToHidden: function() {
          var possibleActions = this.possibleActions;
          possibleActions.forEach(function(elem) {
            elem.hidden = true;
          });

          this.set('possibleActions', possibleActions);
        },
        _setAllStatusesToHidden: function() {
          var possibleStatuses = this.possibleStatuses;
          possibleStatuses.forEach(function(elem) {
            elem.hidden = true;
          });

          this.set('possibleStatuses', possibleStatuses);
        },

        _computeAvailableActions: function(status) {
          this._setAllActionsToHidden();
          let availableOptions = ['Save'];

          switch (status) {
            case 'signed':
              if (this.agreementType !== 'SSFA') {
                availableOptions.push('Suspend');
                availableOptions.push('Terminate');
              }
              break;
            case 'suspended':
              // removes Save option
              availableOptions.pop();
              availableOptions.push('Unsuspend');
              break;
            case 'terminated':
              // removes Save option
              availableOptions.pop();
              break;
            case 'ended':
              // removes Save option
              availableOptions.pop();
              break;
          }

          for (let key in this.possibleActions) {
            let actionName = this.possibleActions[key].label;
            let config = this.possibleActions[key];

            if (availableOptions.indexOf(actionName) > -1) {
              config.hidden = false;
            }

            this.set(['possibleActions', key], null);
            this.set(['possibleActions', key], config);
          }
        },

        _computeAvailableStatuses: function(status) {
          this._setAllStatusesToHidden();
          let availableStatuses = [];
          let completedFlag = false;
          let activeStatus;

          switch (status) {
            case 'draft':
              availableStatuses = [
                'Draft',
                'Signed',
                'Ended',
              ];
              activeStatus = 'Draft';
              break;

            case 'signed':
              availableStatuses = [
                'Draft',
                'Signed',
                'Ended',
              ];
              activeStatus = 'Signed';
              break;

            case 'suspended':
              availableStatuses = [
                'Draft',
                'Signed',
                'Suspended',
                'Ended',
              ];
              activeStatus = 'Suspended';
              break;

            case 'terminated':
              availableStatuses = [
                'Draft',
                'Signed',
                'Terminated',
                'Ended',
              ];
              activeStatus = 'Terminated';
              break;

            case 'ended':
              availableStatuses = [
                'Draft',
                'Signed',
                'Ended',
              ];
              activeStatus = 'Ended';
              break;
            default:
              availableStatuses = [
                'Draft',
                'Signed',
                'Ended',
              ];
              activeStatus = '';
              break;
          }

          for (let key = this.possibleStatuses.length - 1; key >= 0; key--) {
            let workingStatus = this.possibleStatuses[key];
            if (workingStatus.label === activeStatus && !this.newAgreement) {
              completedFlag = true;
            }
            if (availableStatuses.indexOf(workingStatus.label) > -1) {
              workingStatus.hidden = false;
            }
            workingStatus.completed = completedFlag;
            this.set(['possibleStatuses', key], null);
            this.set(['possibleStatuses', key], workingStatus);
          }
        },

        _computeStatusesAndActions: function(status) {
          this.debounce('compute-statuses-and-actions', function() {
            this._computeAvailableStatuses(status);
            this._computeAvailableActions(status);
          }.bind(this), 50);
        },
        _statusChangeConfirmationCallback: function(event) {
          if (event.detail.confirmed) {
            this.fire('update-agreement-status', {
              agreementId: this.agreementId,
              status: this.newStatus + ''
            });
            this.fire('reload-list');
          }
          this.set('newStatus', '');
        },

        _updateStatus: function(newStatus) {
          if (!this._statusChangeIsValid(newStatus)) {
            return;
          }

          this.set('newStatus', newStatus);
          this._showStatusChangeConfirmationDialog();
        },
        _statusChangeIsValid: function(newStatus) {
          if (this.newAgreement) {
            return false;
          }

          if (newStatus === 'draft') { //TODO Is this check necessary?
            // if agreement was not saved (is new) or the status is already changed
            // from draft, stop status change
            if (this.status !== 'draft') {
              return false;
            }
          }
          if (['suspended', 'terminated'].indexOf(newStatus) > -1) {
            if (this.status !== 'signed') {
              //prevent suspending or terminating anything other than signed agreement
              return false;
            }
          }
          return true;
        },

        _setStatusTerminated: function() {
          this._updateStatus('terminated');
        },

        _setStatusSuspended: function() {
          this._updateStatus('suspended');
        },

        _unsuspendAgreement: function() {
          this._updateStatus('signed');
        },

      });
    })();
  </script>
</dom-module>
