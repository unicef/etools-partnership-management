<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">

<link rel="import" href="../common-elements/etools-form-element-wrapper.html">
<link rel="import" href="../common-elements/etools-single-file.html">
<link rel="import" href="../common-elements/etools-error-messages-box.html">


<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/esmm-missing-options/missing-dropdown-options-behavior.html">

<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../partners/partners-data/partner-staff-members-data.html">

<link rel="import" href="agreement-behaviors/agreements-common-behavior.html">
<link rel="import" href="partner-authorized-officers.html">
<link rel="import" href="agreement-amendments.html">
<link rel="import" href="agreement-status.html">
<link rel="import" href="generate-PCA-dialog.html">

<dom-module id="agreement-details">

  <template strip-whitespace>

    <style include="page-layout-styles grid-layout-styles shared-styles buttons-styles">
      :host {
        @apply(--layout-horizontal);
        width: 100%;

        --esmm-list-wrapper: {
          max-height: 400px;
        }
      }

      paper-input,
      etools-date-input {
        width: 100%;
      }

      #generate-pca {
        /* TODO: change Generate PCA btn template - this should be applied on etools-form-element-wrapper with width auto */
        border-right: 1px solid var(--dark-divider-color);
      }

    </style>

    <partner-staff-members-data partner-id="[[agreement.partner]]"
                                prepared-staff-members-data="{{staffMembers}}">
    </partner-staff-members-data>

    <!-- main page content start -->
    <div id="pageContent">

      <etools-error-messages-box id="errorsBox"
                                 title="Errors Saving Agreement"
                                 errors="{{serverErrors}}"></etools-error-messages-box>

      <etools-content-panel class="content-section" panel-title="Agreement Details">

        <div class="row-h flex-c headings-row row-second-bg">
          <div class="col col-6">
            <!-- Agreement Type -->
            <etools-single-selection-menu
                id="agreementType"
                label="Agreement Type"
                placeholder="&#8212;"
                options="[[agreementTypes]]"
                selected="{{agreement.agreement_type}}"
                dynamic-align
                hide-search
                readonly$="[[!_allowFieldEditing('agreementType', agreement.status)]]"
                error-message="Please select agreement type"
                required>
            </etools-single-selection-menu>
          </div>
          <div class="col col-2">
            <!-- Reference Number -->
            <paper-input label="Reference Number"
                         value="[[agreement.agreement_number]]"
                         title$="[[agreement.agreement_number]]"
                         hidden$="[[!agreement.id]]"
                         placeholder="&#8212;"
                         readonly></paper-input>
          </div>
          <div class="col col-4">
            <etools-form-element-wrapper label="Duration (Signed Date - CP End Date)" hidden$="[[!agreement.id]]">
              <span class="placeholder">&#8212;</span>
            </etools-form-element-wrapper>
          </div>
        </div>

        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Partner name -->
            <etools-single-selection-menu
                id="partner"
                label="Partner Name"
                placeholder="&#8212;"
                options="[[partnersDropdownData]]"
                selected="{{agreement.partner}}"
                dynamic-align
                readonly$="[[!_allowFieldEditing('partnerName', agreement.status)]]"
                error-message="Please select a partner"
                required>
            </etools-single-selection-menu>
          </div>
          <template is="dom-if" if="[[_showIfTypeMatches(agreement.agreement_type, 'MOU')]]">
            <div class="col col-3">
              <!-- Start date -->
              <etools-date-input id="startDateField"
                                 label="Start date"
                                 value="{{agreement.start}}"
                                 readonly$="[[!_allowFieldEditing('startDate', agreement.status)]]"
                                 no-init show-clear-btn>
              </etools-date-input>
            </div>
            <div class="col col-3">
              <!-- End date -->
              <etools-date-input id="endDateField"
                                 label="End date"
                                 value="{{agreement.end}}"
                                 readonly$="[[!_allowFieldEditing('endDate', agreement.status)]]"
                                 error-message="Please select end date"
                                 required$="[[validateStringValue(agreement.start)]]"
                                 no-init show-clear-btn>
              </etools-date-input>
            </div>
          </template>
          <template is="dom-if" if="[[_showIfTypeMatches(agreement.agreement_type, 'PCA')]]">
            <div class="col col-6">
              <etools-single-selection-menu
                  id="cpStructure"
                  label="CP Structure"
                  placeholder="&#8212;"
                  options="[[cpStructureOptions]]"
                  error-message="Please select CP Structure"
                  required>
              </etools-single-selection-menu>
            </div>
          </template>
        </div>

        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed By Partner -->
            <etools-single-selection-menu
                id="signedByPartner"
                label="Signed By Partner"
                placeholder="&#8212;"
                options="[[staffMembers]]"
                option-value="id"
                option-label="name"
                selected="{{agreement.partner_manager}}"
                dynamic-align
                readonly$="[[!_allowFieldEditing('signedByPartner', agreement.status)]]"
                error-message="Please select a partner"
                required$="[[validateStringValue(agreement.signed_by_partner_date)]]">
            </etools-single-selection-menu>
          </div>
          <div class="col col-3">
            <!-- Signed By Partner Date -->
            <etools-date-input id="signedByPartnerDateField"
                               label="Signed By Partner Date"
                               value="{{agreement.signed_by_partner_date}}"
                               readonly$="[[!_allowFieldEditing('signedByPartnerDate', agreement.status)]]"
                               error-message="Please select signed by partner date"
                               required$="[[validateIdValue(agreement.partner_manager)]]"
                               no-init show-clear-btn>
            </etools-date-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed By UNICEF -->
            <etools-single-selection-menu
                id="signedByUnicef"
                label="Signed By UNICEF"
                placeholder="&#8212;"
                options="[[unicefSeniorStaff]]"
                option-value="user_id"
                option-label="full_name"
                selected="{{agreement.signed_by}}"
                dynamic-align
                readonly$="[[!_allowFieldEditing('signedByUnicef', agreement.status)]]"
                error-message="Please select UNICEF staff"
                required$="[[validateStringValue(agreement.signed_by_unicef_date)]]">
            </etools-single-selection-menu>
          </div>
          <div class="col col-3">
            <!-- Signed By UNICEF Date -->
            <etools-date-input id="signedByUnicefDateField"
                               label="Signed By UNICEF Date"
                               value="{{agreement.signed_by_unicef_date}}"
                               readonly$="[[!_allowFieldEditing('signedByUnicefDate', agreement.status)]]"
                               error-message="Please select signed by UNICEF date"
                               required$="[[validateIdValue(agreement.signed_by)]]"
                               no-init show-clear-btn>
            </etools-date-input>
          </div>
        </div>
        <div class="row-h flex-c t-border">
          <div id="generate-pca" class="col col-3" hidden="[[!_showGeneratePCABtn(agreement, agreement.agreement_type)]]">
            <paper-input-container
                class="form-field-wrapper secondary-btn-wrapper"
                always-float-label
                >
              <!--hidden$="[[!_showGenerateReportBtn(agreement.agreement_type, agreement.attached_agreement, agreement.attached_agreement_file)]]"-->
              <!-- Generate PCA -->
              <label aria-hidden="true">PCA Agreement to Sign</label>
                <paper-button class="paper-input-input secondary-btn" on-tap="_openGeneratePCADialog">
                  <iron-icon icon="refresh"></iron-icon>
                  GENERATE
                </paper-button>
            </paper-input-container>
          </div>
          <div class="col col-9">
            <etools-single-file
                file="{{agreement.attached_agreement}}"
                internal-file="[[agreement.attached_agreement_file]]"
                label="Signed Agreement"
                accept=".doc,.docx,.pdf,.jpg,.png"
                hide-delete-btn="[[_hideDeleteBtn(agreement.status,agreement.attached_agreement)]]"
                readonly$="[[!_allowEditAgreementDoc(agreement.status)]]"></etools-single-file>
          </div>
        </div>
      </etools-content-panel>

      <!-- Partner Authorized Officers (partner staff members) -->
      <etools-content-panel class="content-section"
                            panel-title="Partner Authorized Officers ([[agreement.authorized_officers.length]])">
        <partner-authorized-officers id="authorizedOfficers"
                                     selected-officers="{{agreement.authorized_officers}}"
                                     officers-dropdown-data="[[staffMembers]]"
                                     edit-mode="[[_allowFieldEditing('officers', agreement.status)]]"
                                     required$="[[_signedByValuesFilledAndValid(agreement.signed_by, agreement.signed_by_unicef_date, agreement.partner_manager, agreement.signed_by_partner_date)]]">
        </partner-authorized-officers>
      </etools-content-panel>

      <template is="dom-if" if="[[_showAmendments(agreement.agreement_type, agreement.status)]]">
        <!-- Amendments -->
        <etools-content-panel class="content-section" panel-title="Amendments ([[agreement.amendments.length]])">
          <agreement-amendments id="agreementAmendments" data-items="{{agreement.amendments}}"
                                staff-members="[[staffMembers]]"
                                partner-name="[[agreement.partner_name]]"
                                partner-authorized-officers="[[_getAuthorizedOfficers(staffMembers, agreement.authorized_officers)]]"
                                edit-mode$="[[editMode]]"></agreement-amendments>
        </etools-content-panel>
      </template>

    </div> <!-- main page content end -->

    <!-- sidebar content start -->
    <div id="sidebar">
      <agreement-status status="[[agreement.status]]"
                        new-agreement$="[[isNewAgreement]]"
                        agreement-id$="[[agreement.id]]"
                        on-save-agreement="_validateAndTriggerAgreementSave"
                        show-save-btn$="[[editMode]]"></agreement-status>
    </div>
    <!-- sidebar content end -->

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'agreement-details',

        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior,
          pmpBehaviors.AgreementsCommonBehavior,
          pmpBehaviors.MissingDropdownOptionsBehavior
        ],

        properties: {
          agreement: {
            type: Object,
            notify: true,
            observer: '_agreementChanged'
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          },
          allowEditRegardlessStatus: {
            type: Boolean,
            value: false
          },
          isNewAgreement: {
            type: Boolean,
            value: false,
            observer: '_isNewAgreementChanged'
          },
          partnersDropdownData: {
            type: Array,
            statePath: 'partnersDropdownData'
          },
          agreementTypes: {
            type: Array,
            statePath: 'agreementTypes'
          },
          staffMembers: {
            type: Array
          },
          unicefSeniorStaff: {
            type: Array,
            statePath: 'signedByUnicefUsers'
          },
          originalAgreementData: {
            type: Object,
            value: null
          },
          amendments: {
            type: Array,
            value: []
          },
          serverErrors: {
            type: Array,
            value: []
          },
          oldSelectedPartnerId: Number,
          countryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          cpStructureOptions: {
            type: Object,
            value: []
          }
        },

        observers: [
          '_agreementFieldChanged(agreement.*)',
          '_partnerChanged(agreement.partner)'
        ],
        ready: function() {
          this.setDropdownMissingOptionsAjaxDetails(this.$.signedByUnicef, 'unicefUsers', {dropdown: true});

          this.generatePCADialog = document.createElement('generate-pca-dialog');
          this.generatePCADialog.setAttribute('id','generatePCADialog');
          Polymer.dom(document.querySelector('body')).appendChild(this.generatePCADialog);
        },
        detached: function() {
          if (this.generatePCADialog) {
            Polymer.dom(document.querySelector('body')).removeChild(this.generatePCADialog);
          }
        },
        _showGeneratePCABtn: function() {
          return this.agreement && this.agreement.agreement_type === 'PCA';
        },
        _hideDeleteBtn: function() {
          if (this.agreement && this.agreement.status === 'draft' && this.agreement.attached_agreement_file) {
            return true;
          }
          return false;
        },
        _allowEditAgreementDoc: function() {
          if (!this.editMode) {
            return false;
          }
          if (!this.agreement || !this.agreement.id) {//new agreement
            return true;
          }
          return (this.agreement.status === 'draft' || !this.agreement.attached_agreement_file);
        },
        _isNewAgreementChanged: function(isNew) {
          this._setDraftStatus(this.editMode, isNew);
        },

        _editModeChanged: function(editMode) {
          this._setDraftStatus(editMode, this.isNewAgreement);
        },

        _setDraftStatus: function(editMode, isNewAgreement) {
          if (editMode && isNewAgreement && this.agreement && this.agreement.status !== 'draft') {
            this.set('agreement.status', 'draft');
          }
        },

        _showAmendments: function(type, status) {
          if (type === 'PCA' && status !== 'draft') {
            return true;
          }
          return false;
        },

        /**
         * When agreement data is changed we need to check and prepare attached agreement file and
         * display amendments if needed
         */
        _agreementChanged: function(agreement) {
          this.generatePCADialog.agreementId = agreement.id;
          this.set('serverErrors', []);
          if (typeof agreement === 'object' && agreement !== null && agreement.id) {
            if (agreement.id > 0) {
              // prevent wrong new agreement value
              this.set('isNewAgreement', false);
            }

            this.set('oldSelectedPartnerId', agreement.partner);

            // reset invalid state for signed by values
            this._resetSignedByValidations();

            // reset authorized officers invalid messages
            this._resetOfficersField();

            // keep a copy of the agreement before changes are made and use it later to save only the changes
            this.set('originalAgreementData', JSON.parse(JSON.stringify(agreement)));

            // forces etools-single-file to redraw the element
            if (!agreement.attached_agreement) {
              this.set('agreement.attached_agreement', {});
            }
            if (!agreement.attached_agreement_file) {
              this.set('agreement.attached_agreement_file', '');
            }
          } else {
            this.set('agreement.attached_agreement', {});
            this.set('agreement.attached_agreement_file', '');
            // new agreement, update status to draft and reset fields
            this._setDraftStatus(this.editMode, this.isNewAgreement);
            this._resetDropdown('#partner');
            this._resetDropdown('#agreementType');
            this._resetDropdown('#signedByUnicef');
            this._resetDropdown('#signedByPartner', true);
            this._resetSignedByValidations();
            this._resetOfficersField();
          }
          this.fire('global-loading', {active: false});
        },

        _resetDropdown: function(selector, clearOptions) {
          if (!clearOptions) {
            clearOptions = false;
          }
          var field = this.fieldValidationReset(selector);
          if (field) {
            field.value = [];
            field.selectedValues = null;
            field.search = '';
            if (clearOptions) {
              field.options = [];
            }
          }
        },

        _resetSignedByValidations: function() {
          this.fieldValidationReset('#endDateField');
          this.fieldValidationReset('#signedByPartner');
          this.fieldValidationReset('#signedByPartnerDateField');
          this.fieldValidationReset('#signedByUnicef');
          this.fieldValidationReset('#signedByUnicefDateField');
        },

        _resetOfficersField: function() {
          var selectedOfficers = this.$.authorizedOfficers;
          selectedOfficers._updateInvalidState(false);
          selectedOfficers.resetSelection();
        },

        /**
         * Verify if agreement status is 'draft'
         */
        _isDraft: function() {
          if (!this.agreement || !this.agreement.status) {
            return false;
          }
          return this.agreement.status === 'draft';
        },

        _allowEdit: function(agreementStatus) {
          if (!this.editMode) {
            return false;
          }
          if (this.allowEditRegardlessStatus) {
            // TODO: revise this temporary permission
            // temporary edit permission for PM regardless status
            return true;
          }
          if (!(this.agreement && this.agreement.id > 0) || (agreementStatus && this._isDraft())) {
            return true;
          }
          return false;
        },

        /**
         * Check field edit permissions
         */
        _allowFieldEditing: function(fieldName, agreementStatus) {

          var allowEdit = false;
          if (['partnerName', 'agreementType', 'startDate', 'endDate', 'signedByPartner',
                'signedByUnicef', 'signedByPartnerDate', 'signedByUnicefDate', 'officers'].indexOf(fieldName) > -1) {
            allowEdit = this._allowEdit(agreementStatus);
          }
          return allowEdit;
        },

        _showGenerateReportBtn: function(type, attachedAgreementFile, attachedAgreementFilePath) {
          return type === 'PCA' && (attachedAgreementFile instanceof File === false &&
              (!attachedAgreementFilePath || attachedAgreementFilePath === ''));
        },

        /**
         * Check if signed by fields have at least one valid value
         */
        _signedByValuesFilledAndValid: function(signedByUnicefStaffId, signedByUnicefDate,
                                                signedByPartnerStaffId, signedByPartnerDate) {
          return this.validateIdValue(signedByUnicefStaffId)
              || this.validateStringValue(signedByUnicefDate)
              || this.validateIdValue(signedByPartnerStaffId)
              || this.validateStringValue(signedByPartnerDate);

        },

        _partnerChanged: function(currentPartnerId) {
          if (this.agreement && currentPartnerId !== this.oldSelectedPartnerId) {
            // partner not set or changed, reset related fields
            this.set('agreement.partner_manager', null);
            this.set('staffMembers', []);
            this.set('agreement.authorized_officers', []);
            this.fieldValidationReset('#signedByPartnerDateField', true);
            this._resetOfficersField();
            this.set('oldSelectedPartnerId', currentPartnerId);
          }
        },

        /**
         * Validate agreements fields on change
         */
        _agreementFieldChanged: function(agreementProperty) {
          // check edit permissions and continue only if true; no validations in view mode
          if (this.agreement && !this._allowEdit(this.agreement.status)) {
            return;
          }

          if (agreementProperty) {
            if (agreementProperty.path === 'agreement.start' || agreementProperty.path === 'agreement.end') {
              this._validateStartAndEndDateField();
            } else if (agreementProperty.path === 'agreement.signed_by'
                || agreementProperty.path === 'agreement.signed_by_unicef_date') {
              this._validateSignedByUnicefFields(this.agreement.signed_by, this.agreement.signed_by_unicef_date);
            } else if (agreementProperty.path === 'agreement.partner_manager'
                || agreementProperty.path === 'agreement.signed_by_partner_date') {
              this._validateSignedByPartnerFields(this.agreement.partner_manager,
                  this.agreement.signed_by_partner_date);
            } else if (agreementProperty.path === 'agreement.partner') {
              this.fieldValidationReset('#partner');
            } else if (agreementProperty.path === 'agreement.agreement_type') {
              this.fieldValidationReset('#agreementType');
            }
          }

        },

        /**
         * End date is conditioned by the start date
         * if start date is entered, then the end date is required;
         * also, when end date changes, trigger the validation again.
         */
        _validateStartAndEndDateField: function() {
          // check edit permissions and continue only if true
          if (!this._allowEdit(this.agreement.status)) {
            return;
          }
          var endDateField = this.$$('#endDateField');
          if (endDateField) {
            endDateField.validate();
          }
        },

        /**
         * Signed by unicef field is required in case signed by unicef date field is filed, and
         * signed by unicef date field is required in case signed by unicef is selected.
         * Also officers are required if at least one of these fields are populated.
         */
        _validateSignedByUnicefFields: function(singedByUnicefStaffId, signedByUnicefDateString) {
          setTimeout(function() {
            // setTimeout with 0 delay will ensure signedByUnicef dropdown
            // selected value will be set before this validation
            var signedByUnicefField = this.$$('#signedByUnicef');
            var signedByUnicefDateField = this.$$('#signedByUnicefDateField');
            if (singedByUnicefStaffId !== null || signedByUnicefDateString !== null) {
              if (signedByUnicefField) {
                signedByUnicefField.validate();
              }
              if (signedByUnicefDateField) {
                signedByUnicefDateField.validate();
              }
            }
            // also partner authorized officers field is required if at least one of these 2 fields was filed
            var authorizedOfficers = this.$$('#authorizedOfficers');
            if (authorizedOfficers) {
              authorizedOfficers.validateOfficersSelection();
            }
          }.bind(this), 0);
        },

        /**
         * Signed by partner field is required in case signed by partner date field is filed, and
         * signed by partner date field is required in case signed by partner is selected.
         * Also officers are required if at least one of these fields are populated.
         */
        _validateSignedByPartnerFields: function(singedByPartnerStaffId, signedByPartnerDateString) {
          setTimeout(function() {
            // setTimeout with 0 delay will ensure signedByPartner dropdown
            // selected value will be set before this validation
            var signedByPartnerField = this.$$('#signedByPartner');
            var signedByPartnerDateField = this.$$('#signedByPartnerDateField');
            if (singedByPartnerStaffId !== null || signedByPartnerDateString !== null) {
              if (signedByPartnerField) {
                signedByPartnerField.validate();
              }
              if (signedByPartnerDateField) {
                signedByPartnerDateField.validate();
              }
            }
            // also partner authorized officers field is required if at least one of these 2 fields was filed
            var authorizedOfficers = this.$$('#authorizedOfficers');
            if (authorizedOfficers) {
              authorizedOfficers.validateOfficersSelection();
            }
          }.bind(this), 0);
        },

        /**
         * Validate agreement fields
         */
        _validateAgreement: function() {
          var valid = true;

          // validate partner
          if (this.validateIdValue(this.agreement.partner) === false) {
            valid = false;
            var partnerField = this.$$('#partner');
            if (partnerField) {
              this.$$('#partner').invalid = true;
            }
          }

          // validate agreement type
          if (this.validateStringValue(this.agreement.agreement_type) === false) {
            valid = false;
            var agreementTypeField = this.$$('#agreementType');
            if (agreementTypeField) {
              this.$$('#agreementType').invalid = true;
            }
          }

          // validate start date
          if (this.validateStringValue(this.agreement.start)) {
            // end date is required only if start date was selected
            var endDateField = this.$$('#endDateField');
            if (endDateField && endDateField.validate() === false) {
              valid = false;
            }
          }

          // validate signedByPartner and signedByPartnerDate and signedByManager and signedByManagerDate fields
          if (this._validSignedByFields(this.agreement.partner_manager, this.agreement.signed_by_partner_date,
                  this.agreement.signed_by, this.agreement.signed_by_unicef_date) === false) {
            valid = false;
          }

          // validate partner authorized officers in case
          if (this._validateSelectedOfficers() === false) {
            valid = false;
          }

          if (!this._validateAmendments()) {
            valid = false;
          }

          return valid;
        },
        _validateAmendments: function() {
           var agreementAmendmentsElem = this.$$('#agreementAmendments');
           if (agreementAmendmentsElem) {
             return agreementAmendmentsElem.validate();
           }
           return true;
        },
        /**
         * Validate signed by fields
         */
        _validSignedByFields: function(partnerStaffId, partnerSignedDate, unicefStaffId, unicefSignedDate) {
          var valid = true;

          // validate signedByPartner and signedByPartnerDate
          var validSignedByPartner = this.validateIdValue(partnerStaffId);
          var validSignedByPartnerDate = this.validateStringValue(partnerSignedDate);

          if (validSignedByPartnerDate) {
            // partner_manager is required only if sign_by_partner_date was selected
            if (validSignedByPartner === false) {
              valid = false;
              var signedByPartnerField = this.$$('#signedByPartner');
              if (signedByPartnerField) {
                signedByPartnerField.invalid = true;
              }
            }
          }

          if (validSignedByPartner) {
            if (validSignedByPartnerDate === false) {
              valid = false;
              var signedByPartnerDateField = this.$$('#signedByPartnerDateField');
              if (signedByPartnerDateField) {
                signedByPartnerDateField.validate();
              }
            }
          }

          // validate signedByUnicef and signedByUnicefDate fields
          var validSignedByUnicefStaff = this.validateIdValue(unicefStaffId);
          var validSignedByUnicefDate = this.validateStringValue(unicefSignedDate);

          if (validSignedByUnicefDate) {
            // signed_by is required only if sign_by_unicef_date was selected
            if (validSignedByUnicefStaff === false) {
              valid = false;
              var signedByUnicefField = this.$$('#signedByUnicef');
              if (signedByUnicefField) {
                signedByUnicefField.invalid = true;
              }
            }
          }

          // validate signedByUnicefDate
          if (validSignedByUnicefStaff) {
            if (validSignedByUnicefDate === false) {
              valid = false;
              var signedByUnicefDateField = this.$$('#signedByUnicefDateField');
              if (signedByUnicefDateField) {
                signedByUnicefDateField.validate();
              }
            }
          }

          return valid;
        },

        /**
         * Validate officers selection
         */
        _validateSelectedOfficers: function() {
          var valid = true;
          if (this._signedByValuesFilledAndValid(this.agreement.signed_by, this.agreement.signed_by_unicef_date,
                  this.agreement.partner_manager, this.agreement.signed_by_partner_date)) {
            if (this.$.authorizedOfficers.validateOfficersSelection() === false) {
              valid = false;
            }
          }
          return valid;
        },

        /**
         * Get agreement changed properties
         */
        _getCurrentChanges: function() {
          var changes = {};
          if (this.agreement && this.agreement.id === this.originalAgreementData.id) {
            // check for missing start date
            if (!(typeof this.agreement.start === 'string' && this.agreement.changes !== '')) {
              var maxDateStr = this.getMaxDateStr(this.agreement.signed_by_partner_date,
                  this.agreement.signed_by_unicef_date);
              if (maxDateStr) {
                this.set('agreement.start', maxDateStr);
                this.fire('toast', {text: '\'Start date\' has been set to latest date between' +
                  ' \'Signed By Partner Date\' and \'Signed By UNICEF Date\'', showCloseBtn: true});
              }
            }

            // prevent the possibility of checking 2 different agreements
            var availableChangingFields = ['partner', 'agreement_type', 'start', 'end', 'attached_agreement',
              'partner_manager', 'signed_by_partner_date', 'signed_by', 'signed_by_unicef_date',
              'authorized_officers', 'amendments'];
            // TODO: include amendments to above array with proper checkings
            availableChangingFields.forEach(function(fieldName) {
              if (fieldName === 'authorized_officers') {
                // TODO: authorized_officers more checkings?
                changes[fieldName] = this.agreement.authorized_officers.map(function(officer) {
                  return officer.id;
                });
              } else if (fieldName === 'attached_agreement') {
                if ((this.agreement.hasOwnProperty('attached_agreement')) &&
                    (this.agreement.attached_agreement instanceof File)) {
                  changes.attached_agreement = this.agreement.attached_agreement;
                }
              } else if (fieldName === 'amendments') {
                changes[fieldName] = this.agreement[fieldName];
              } else {
                if (this.agreement[fieldName] !== this.originalAgreementData[fieldName]) {
                  changes[fieldName] = this.agreement[fieldName];
                }
              }
            }.bind(this));
          }
          return changes;
        },
        /**
         * Save agreement if all fields are validated
         */
        _validateAndTriggerAgreementSave: function(event) {
          event.stopImmediatePropagation();
          if (!this.editMode) {
            return;
          }
          if (this._validateAgreement()) {
            if (!this.isNewAgreement) {
              // check/get only changed content to be used as a body to the save request
              var changedAgreementProperties = this._getCurrentChanges();
              // we also need the id
              changedAgreementProperties.id = this.agreement.id;
              // fire update agreement
              this.fire('save-agreement', changedAgreementProperties);
            } else {
              this.fire('save-agreement', this._prepareNewAgreementDataForSave(this.agreement));
            }
          } else {
            this.fire('toast', {text: 'Please review invalid fields data!', showCloseBtn: true});
          }
        },

        _prepareNewAgreementDataForSave: function(agreement) {
          // we do not need all the agreement object data for the first save
          return {
            id: null,
            authorized_officers: agreement.authorized_officers.map(function(officer) {
              return officer.id;
            }),
            agreement_type: agreement.agreement_type,
            attached_agreement: agreement.attached_agreement,
            start: agreement.start,
            end: agreement.end,
            signed_by_unicef_date: agreement.signed_by_unicef_date,
            signed_by_partner_date: agreement.signed_by_partner_date,
            status: 'draft',
            partner: agreement.partner,
            signed_by: agreement.signed_by,
            partner_manager: agreement.partner_manager
          };
        },

        _getAuthorizedOfficers: function(staffMembers, agreementAuthorizedOfficers) {
          if (Array.isArray(staffMembers) && staffMembers.length > 0) {
            if (Array.isArray(agreementAuthorizedOfficers) && agreementAuthorizedOfficers.length > 0) {
              var agreementAuthorizedOfficersIds = agreementAuthorizedOfficers.map(function(authOfficer) {
                return parseInt(authOfficer.id, 10);
              });
              return staffMembers.filter(function(sm) {
                return agreementAuthorizedOfficersIds.indexOf(parseInt(sm.id, 10)) === -1;
              });
            } else {
              return staffMembers;
            }
          }
          return [];
        },

        _showIfTypeMatches: function(agreementType, expectedType) {
          return agreementType === expectedType;
        },

        _filterCountryProgrammesForAgreements: function(countryProgrammes) {
          var self = this;
          return countryProgrammes.filter(function(cp) {
            // return self.isFutureDate(cp.to_date + 'T23:59:59') && ;
          });
        },
        _openGeneratePCADialog: function() {
          this.generatePCADialog.open();
        }

      });

    })();
  </script>

</dom-module>
