<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">

<link rel="import" href="../users-data/unicef-staff-data.html">
<link rel="import" href="../partners/partners-data/partner-item-data.html">

<link rel="import" href="agreement-behaviors/agreements-common-behavior.html">
<link rel="import" href="partner-authorized-officers.html">
<link rel="import" href="agreement-amendments.html">

<dom-module id="agreement-details">

  <template>

    <style include="page-layout-styles grid-layout-styles shared-styles buttons-styles">
      :host {
        @apply(--layout-horizontal);
        width: 100%;
      }
      paper-input {
        width: 100%;
      }

    </style>

    <partner-item-data partner-id="[[agreement.partner]]" partner="{{partner}}"></partner-item-data>

    <unicef-staff-data data="{{unicefStaff}}"></unicef-staff-data>

    <!-- main page content start -->
    <div id="pageContent">
      <etools-content-panel class="content-section" title="Agreement Details">
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Partner name -->
            <template is="dom-if" if="[[!_allowFieldEditing('partnerName', agreement.status)]]">
              <paper-input label="Partner Name"
                           value="[[agreement.partner_name]]"
                           placeholder="&#8212;"
                           readonly></paper-input>
            </template>
            <template is="dom-if" if="[[_allowFieldEditing('partnerName', agreement.status)]]">
              <etools-searchable-multiselection-menu id="partner"
                                                     label="Partner Name"
                                                     placeholder="&#8212;"
                                                     options="[[partnersDropdownData]]"
                                                     on-value-change="_partnerSelected"
                                                     error-message="Please select a partner"
                                                     required>
              </etools-searchable-multiselection-menu>
            </template>
          </div>
          <div class="col col-3">
            <!-- Agreement Type -->
            <template is="dom-if" if="[[!_allowFieldEditing('partnerType', agreement.status)]]">
              <paper-input label="Agreement Type"
                           value="[[agreement.agreement_type]]"
                           placeholder="&#8212;"
                           readonly></paper-input>
            </template>
            <template is="dom-if" if="[[_allowFieldEditing('partnerType', agreement.status)]]">
              <etools-searchable-multiselection-menu id="agreementType"
                                                     label="Agreement Type"
                                                     placeholder="&#8212;"
                                                     options="[[agreementTypesOptions]]"
                                                     hide-search
                                                     on-value-change="_agreementTypeSelected"
                                                     error-message="Please select agreement type"
                                                     required>
              </etools-searchable-multiselection-menu>
            </template>
          </div>
          <div class="col col-3">
            <!-- Reference Number -->
            <paper-input label="Reference Number"
                         value="[[agreement.agreement_number]]"
                         placeholder="&#8212;"
                         readonly></paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-3">
            <!-- Start date -->
            <template is="dom-if" if="[[!_allowFieldEditing('startDate', agreement.status)]]">
              <paper-input label="Start date"
                           value$="[[prettyDate(agreement.start)]]"
                           placeholder="&#8212;"
                           readonly></paper-input>
            </template>
            <template is="dom-if" if="[[_allowFieldEditing('startDate', agreement.status)]]">
              <paper-input label="Start date"
                           value="[[prettyDate(agreement.start)]]"
                           on-down="openDatePicker"
                           data-selector="startDate"
                           placeholder="&#8212;">
                <etools-datepicker-button prefix
                                          id="startDate"
                                          date="[[prepareDate(agreement.start)]]"
                                          format="YYYY-MM-DD"
                                          pretty-date="{{agreement.start}}"
                                          no-init show-clear-btn></etools-datepicker-button>
              </paper-input>
            </template>
          </div>
          <div class="col col-3">
            <!-- End date -->
            <template is="dom-if" if="[[!_allowFieldEditing('endDate', agreement.status)]]">
              <paper-input label="End date"
                           value$="[[prettyDate(agreement.end)]]"
                           placeholder="&#8212;"
                           readonly></paper-input>
            </template>
            <template is="dom-if" if="[[_allowFieldEditing('endDate', agreement.status)]]">
              <paper-input id="endDateField"
                           label="End date"
                           value="[[prettyDate(agreement.end)]]"
                           on-down="openDatePicker"
                           data-selector="endDate"
                           placeholder="&#8212;"
                           error-message="Please select end date"
                           required$="[[validateStringValue(agreement.start)]]">
                <etools-datepicker-button prefix
                                          id="endDate"
                                          date="[[prepareDate(agreement.end)]]"
                                          format="YYYY-MM-DD"
                                          pretty-date="{{agreement.end}}"
                                          no-init show-clear-btn></etools-datepicker-button>
              </paper-input>
            </template>
          </div>
          <div class="col col-6">
            <paper-input-container class="form-field-wrapper secondary-btn-wrapper"
                                   always-float-label
                                   hidden$="[[!_showGenerateReportBtn(agreement.agreement_type, agreement.attached_agreement)]]">
              <!-- Generate PCA -->
              <label aria-hidden="true">Auto-generated PCA</label>
              <paper-button class="paper-input-input secondary-btn">
                <iron-icon icon="refresh"></iron-icon>
                GENERATE PCA
              </paper-button>
            </paper-input-container>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed By Partner -->
            <template is="dom-if" if="[[!_allowFieldEditing('signedByPartner', agreement.status)]]">
              <paper-input label="Signed By Partner"
                           value="[[_getPartnerName(agreement.partner_signatory)]]"
                           placeholder="&#8212;"
                           readonly></paper-input>
            </template>
            <template is="dom-if" if="[[_allowFieldEditing('signedByPartner', agreement.status)]]">
              <etools-searchable-multiselection-menu id="signedByPartner"
                                                     label="Signed By Partner"
                                                     placeholder="&#8212;"
                                                     options="[[preparedOfficersDropdownData]]"
                                                     on-value-change="_signedByPartnerSelected"
                                                     error-message="Please select authorized officer"
                                                     required$="[[validateStringValue(agreement.signed_by_partner_date)]]">
              </etools-searchable-multiselection-menu>
            </template>
          </div>
          <div class="col col-3">
            <!-- Signed By Partner Date -->
            <template is="dom-if" if="[[!_allowFieldEditing('signedByPartnerDate', agreement.status)]]">
              <paper-input label="Signed By Partner Date"
                           value$="[[prettyDate(agreement.signed_by_partner_date)]]"
                           placeholder="&#8212;"
                           readonly></paper-input>
            </template>
            <template is="dom-if" if="[[_allowFieldEditing('signedByPartnerDate', agreement.status)]]">
              <paper-input id="signedByPartnerDateField"
                           label="Signed By Partner Date"
                           value="[[prettyDate(agreement.signed_by_partner_date)]]"
                           on-down="openDatePicker"
                           data-selector="signedByPartnerDate"
                           placeholder="&#8212;"
                           error-message="Please select signed by partner date"
                           required$="[[validateIdValue(agreement.partner_manager)]]">
                <etools-datepicker-button prefix
                                          id="signedByPartnerDate"
                                          date="[[prepareDate(agreement.signed_by_partner_date)]]"
                                          format="YYYY-MM-DD"
                                          pretty-date="{{agreement.signed_by_partner_date}}"
                                          no-init show-clear-btn></etools-datepicker-button>
              </paper-input>
            </template>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed By UNICEF -->
            <template is="dom-if" if="[[!_allowFieldEditing('signedByUnicef', agreement.status)]]">
              <paper-input label="Signed By UNICEF"
                           value="[[_getPartnerManagerName(agreement.unicef_signatory)]]"
                           placeholder="&#8212;"
                           readonly></paper-input>
            </template>
            <template is="dom-if" if="[[_allowFieldEditing('signedByUnicef', agreement.status)]]">
              <etools-searchable-multiselection-menu id="signedByUnicef"
                                                     label="Signed By UNICEF"
                                                     placeholder="&#8212;"
                                                     options="[[partnerSeniorManagers]]"
                                                     on-value-change="_signedByUnicefSelected"
                                                     error-message="Please select UNICEF staff"
                                                     required$="[[validateStringValue(agreement.signed_by_unicef_date)]]">
              </etools-searchable-multiselection-menu>
            </template>
          </div>
          <div class="col col-3">
            <!-- Signed By UNICEF Date -->
            <template is="dom-if" if="[[!_allowFieldEditing('signedByUnicefDate', agreement.status)]]">
              <paper-input label="Signed By UNICEF Date"
                           value$="[[prettyDate(agreement.signed_by_unicef_date)]]"
                           placeholder="&#8212;"
                           readonly></paper-input>
            </template>
            <template is="dom-if" if="[[_allowFieldEditing('signedByUnicefDate', agreement.status)]]">
              <paper-input id="signedByUnicefDateField"
                           label="Signed By UNICEF Date"
                           value="[[prettyDate(agreement.signed_by_unicef_date)]]"
                           on-down="openDatePicker"
                           data-selector="signedByUnicefDate"
                           placeholder="&#8212;"
                           error-message="Please select signed by UNICEF date"
                           required$="[[validateIdValue(agreement.signed_by)]]">
                <etools-datepicker-button prefix
                                          id="signedByUnicefDate"
                                          date="[[prepareDate(agreement.signed_by_unicef_date)]]"
                                          format="YYYY-MM-DD"
                                          pretty-date="{{agreement.signed_by_unicef_date}}"
                                          no-init show-clear-btn></etools-datepicker-button>
              </paper-input>
            </template>
          </div>
        </div>
        <div class="row-h flex-c">
          <etools-file files="[[_signedAgreementFiles]]"
                       label="Signed Agreement"
                       accept=".doc,.docx,.pdf,.jpg,.png"
                       readonly$="[[!editMode]]"></etools-file>
        </div>
      </etools-content-panel>

      <!-- Partner Authorized Officers (partner staff members) -->
      <etools-content-panel class="content-section" title$="Partner Authorized Officers ([[agreement.authorized_officers.length]])">
        <partner-authorized-officers id="authorizedOfficers"
           selected-officers="{{agreement.authorized_officers}}"
           available-officers="[[partner.staff_members]]"
           officers-dropdown-data="[[preparedOfficersDropdownData]]"
           edit-mode="[[_allowFieldEditing('officers', agreement.status)]]"
           required$="[[_signedByValuesFilledAndValid(agreement.signed_by, agreement.signed_by_unicef_date, agreement.partner_manager, agreement.signed_by_partner_date)]]">
        </partner-authorized-officers>
      </etools-content-panel>

      <template is="dom-if" if="[[_showAmendments]]">
        <!-- Amendments -->
        <etools-content-panel class="content-section" title$="Amendments ([[amendments.length]])">
          <agreement-amendments data-items="{{agreement.amendments}}"
                                partner="[[partner]]"
                                partner-authorized-officers="[[preparedOfficersDropdownData]]"
                                edit-mode$="[[editMode]]"></agreement-amendments>
        </etools-content-panel>
      </template>

    </div> <!-- main page content end -->

    <!-- sidebar content start -->
    <div id="sidebar">
      <agreement-status status="[[agreement.status]]"
                        new-agreement$="[[isNewAgreement]]"
                        agreement-id$="[[agreement.id]]"
                        on-save-agreement="_validateAndTriggerAgreementSave"
                        show-save-btn$="[[editMode]]"></agreement-status>
    </div>
    <!-- sidebar content end -->

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'agreement-details',

        behaviors: [
          pmpBehaviors.CommonGeneralBehavior,
          pmpBehaviors.AgreementsCommonBehavior
        ],

        properties: {
          user: Object,
          permissions: Object,

          agreement: {
            type: Object,
            notify: true,
            observer: '_agreementChanged'
          },
          partner: {
            type: Object,
            observer: '_partnerChanged'
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          },
          isNewAgreement: {
            type: Boolean,
            value: false,
            observer: '_isNewAgreementChanged'
          },
          partnersDropdownData: {
            type: Array,
            value: []
          },
          agreementTypesOptions: Array,
          agreementTypes: {
            type: Array,
            observer: '_prepareAgreementTypesOptions'
          },
          preparedOfficersDropdownData: {
            type: Array,
            value: []
          },
          partnerSeniorManagers: {
            type: Array,
            value: []
          },
          unicefStaff: {
            type: Array,
            observer: '_unicefStaffChanged'
          },
          originalAgreementData: {
            type: Object,
            value: null
          },
          amendments: {
            type: Array,
            value: []
          }
        },

        observers: [
          '_partnersDropdownChanged(partnersDropdownData.length)',
          '_agreementFieldChanged(agreement.*)'
        ],

        ready: function() {
//          this.set('amendments', [
//            {
//              id: 1,
//              signed_date: '2015-07-28',
//              signed_agreement: 'https://pbs.twimg.com/profile_images/616542814319415296/McCTpH_E.jpg',
//              amendment_types: [
//                {
//                  amendment_type_id: 1,
//                  amendment_type: 'Change Authorized Officer',
//                  officer_id: 342,// staff member id
//                  bank_info: null,
//                  legal_name_of_ip: null,
//                  cp_cycle_end: null,
//                  additional_clauses: null,
//                  existing_clause_amended: null
//                },
//                {
//                  amendment_type_id: 2,
//                  amendment_type: 'Banking Information',
//                  officer_id: null,
//                  bank_info: 'Bank of Lebanon: #3234234',
//                  legal_name_of_ip: null,
//                  cp_cycle_end: null,
//                  additional_clauses: null,
//                  existing_clause_amended: null
//                },
//                {
//                  amendment_type_id: 3,
//                  amendment_type: 'Change in Legal Name of Implementing Partner',
//                  officer_id: null,
//                  bank_info: null,
//                  legal_name_of_ip: 'Some partner full name',
//                  cp_cycle_end: null,
//                  additional_clauses: null,
//                  existing_clause_amended: null
//                },
//                {
//                  amendment_type_id: 3,
//                  amendment_type: 'Extension of Country Programme Cycle',
//                  officer_id: null,
//                  bank_info: null,
//                  legal_name_of_ip: null,
//                  cp_cycle_end: '2018-08-30',
//                  additional_clauses: null,
//                  existing_clause_amended: null
//                },
//                {
//                  amendment_type_id: 5,
//                  amendment_type: 'Additional Clause',
//                  officer_id: null,
//                  bank_info: null,
//                  legal_name_of_ip: null,
//                  cp_cycle_end: null,
//                  additional_clauses: 'Some Additional Clause text...',
//                  existing_clause_amended: null
//                },
//                {
//                  amendment_type_id: 6,
//                  amendment_type: 'Amend Existing Clause',
//                  officer_id: null,
//                  bank_info: null,
//                  legal_name_of_ip: null,
//                  cp_cycle_end: null,
//                  additional_clauses: null,
//                  existing_clause_amended: 'Existing clause amended text...'
//                }
//              ]
//            }
//          ]);

        },

        _isNewAgreementChanged: function(isNew) {
          this._setDraftStatus(this.editMode, isNew);
        },

        _editModeChanged: function(editMode) {
          this._setDraftStatus(editMode, this.isNewAgreement);
        },

        _setDraftStatus: function(editMode, isNewAgreement) {
          if (editMode && isNewAgreement && this.agreement && this.agreement.status !== 'draft') {
            this.set('agreement.status', 'draft');
          }
        },

        /**
         * When agreement data is changed we need to check and prepare attached agreement file and
         * display amendments if needed
         */
        _agreementChanged: function(agreement) {
          console.log(agreement);
          if (typeof agreement === 'object' && agreement !== null && agreement.id) {
            if (agreement.agreement_type === 'PCA' && agreement.status !== 'draft') {
              this.set('_showAmendments', true);
            } else {
              this.set('_showAmendments', false);
            }
            // prepare attached agreement data
            this.set('_signedAgreementFiles', this.prepareEtoolsFileDataFromUrl(agreement.attached_agreement));
            // check for partners dropdown selected values; reset invalid state
            this._partnersDropdownChanged(this.partnersDropdownData.length);
            // check agreement type dropdown selected value; reset invalid state
            this._setAgreementTypeDropdownValue(agreement);
            // reset invalid state for endDateField
            this.fieldValidationReset('#endDateField');
            // set signed by dropdown value; reset invalid state
            this._setSignedByPartnerDropdownValue(agreement.partner_manager);
            // reset invalid state for signedByPartnerDateField0
            this.fieldValidationReset('#signedByPartnerDateField');
            // set signed by unicef value; reset invalid state
            this._setSignedByUnicefDropdownValue(agreement.signed_by);
            this.fieldValidationReset('#signedByUnicef');
            // reset invalid state for signedByUnicefDateField
            this.fieldValidationReset('#signedByUnicefDateField');
            // reset authorized officers invalid messages
            var selectedOfficers = this.$.authorizedOfficers;
            selectedOfficers._updateInvalidState(false);
            selectedOfficers.resetSelection();

            // keep a copy of the agreement before changes are made and use it later to save only the changes
            this.set('originalAgreementData', JSON.parse(JSON.stringify(agreement)));
          } else {
            // new agreement, update status to draft
            this._setDraftStatus(this.editMode, this.isNewAgreement);

            // TODO: Reset new agreement fields if an agreement was selected previously

          }
          this.fire('global-loading', {active: false});
        },

        /**
         * Verify if agreement status is 'draft'
         */
        _isDraft: function() {
          if (!this.agreement || !this.agreement.status) {
            return false;
          }
          return this.agreement.status === 'draft';
        },

        _allowEdit: function(agreementStatus) {
          if (!this.editMode) {
            return false;
          }
          if (this.isNewAgreement || (agreementStatus && this._isDraft())) {
            return true;
          }
          return false;
        },

        /**
         * Check field edit permissions
         */
        _allowFieldEditing: function(fieldName, agreementStatus) {

          var allowEdit = false;
          if (['partnerName', 'partnerType', 'startDate', 'endDate', 'signedByPartner',
                'signedByUnicef', 'signedByPartnerDate', 'signedByUnicefDate', 'officers'].indexOf(fieldName) > -1) {
              allowEdit = this._allowEdit(agreementStatus);
          }

          return allowEdit;
        },

        /**
         * Get partner id from dropdown selection and add it to agreement
         */
        _partnerSelected: function(event) {
          var selectedPartner = event.detail.selectedValues;
          if (selectedPartner !== null) {
            this.set('agreement.partner', selectedPartner.value);
            this.async(function() {
              this.$$('#partner').invalid = false;
            });
          }
        },

        /**
         * When partners dropdown data is received, check for agreement selected partner
         */
        _partnersDropdownChanged: function(partnersDropdownDataLength) {
          if (partnersDropdownDataLength) {
            this._setPartnerDropdownSelectedValue();
          } else {
            this.fieldValidationReset('#partner');
          }
        },

        /**
         * Init partners dropdown selected value
         */
        _setPartnerDropdownSelectedValue: function() {
          this.debounce('setPartnersDropdownValue', function() {
            var partnersField = this.fieldValidationReset('#partner');
            if (!this.isNewAgreement && this.agreement && this.agreement.partner
                && this._allowFieldEditing('partnerName', this.agreement.status)) {
              var agreementPartnerId = parseInt(this.agreement.partner, 10);
              var selectedPartner = this.partnersDropdownData.filter(function(partner) {
                return parseInt(partner.value, 10) === agreementPartnerId;
              });
              if (selectedPartner.length) {
                this.async(function() {
                  if(!partnersField) {
                    partnersField = this.fieldValidationReset('#partner');
                  }
                  if (partnersField) {
                    partnersField.value = selectedPartner;
                  }
                });
              }
            }
          }.bind(this), 50);
        },

        /**
         * Get agreement type string from dropdown selection and add it to the agreement
         */
        _agreementTypeSelected: function(event) {
          var selectedType = event.detail.selectedValues;
          if (selectedType !== null) {
            var type = this.agreementTypes.filter(function(type) {
              return type.label === selectedType.label;
            })[0];
            if (type) {
              this.set('agreement.agreement_type', type.name);
              this.async(function() {
                this.$$('#agreementType').invalid = false;
              });
            }
          }
        },

        /**
         * Prepare agreement types dropdown options
         */
        _prepareAgreementTypesOptions: function(agreementTypes) {
          if (Array.isArray(agreementTypes) && agreementTypes.length > 0) {
            var preparedOptions = agreementTypes.map(function(type, index) {
              return {
                value: (index + 1),
                label: type.label
              }
            });
            this.set('agreementTypesOptions', preparedOptions)
          }
        },

        /**
         * Set agreement type selected value
         */
        _setAgreementTypeDropdownValue: function(agreement) {
          var agreementTypeField = this.fieldValidationReset('#agreementType');
          if (!this.isNewAgreement && this._allowFieldEditing('partnerType', agreement.status)) {
            var type = this.agreementTypes.filter(function(type) {
              return type.name === agreement.agreement_type;
            })[0];
            if (type) {
              var selectedType = this.agreementTypesOptions.filter(function(option) {
                return option.label === type.label;
              });
              if (selectedType.length) {
                this.async(function() {
                  if(!agreementTypeField) {
                    agreementTypeField = this.$$('#agreementType');
                  }
                  if (agreementTypeField) {
                    agreementTypeField.value = selectedType;
                  }
                });
              }
            }
          }
        },

        _showGenerateReportBtn: function(type, attachment) {
          return type === 'PCA' && attachment === null;
        },

        /**
         * Get signed by partner name
         */
        _getPartnerName: function(partner) {
          if (partner && partner.id) {
            return partner.first_name + ' ' + partner.last_name;
          }
        },

        /**
         * Get partner manager name
         */
        _getPartnerManagerName: function(partnerManager) {
          if (partnerManager && partnerManager.user_id) {
            return partnerManager.full_name;
          }
        },

        /**
         * When partner data is received, update partnerName, needed for page title
         */
        _partnerChanged: function(partner) {
          if (partner && Array.isArray(partner.staff_members) && partner.staff_members.length > 0) {
            var partnerStaff = partner.staff_members.map(function(staffMember) {
              return {
                value: staffMember.id,
                label: staffMember.first_name + ' ' + staffMember.last_name
              }
            });
            this.set('preparedOfficersDropdownData', partnerStaff);

            if (this.agreement && this.agreement.partner_manager) {
              this._setSignedByPartnerDropdownValue(this.agreement.partner_manager);
            }
          }
        },

        /**
         * Handling signed by partner selection. The partner id is needed and must be assigned to agreement.
         */
        _signedByPartnerSelected: function(event) {
          var selectedOfficer = event.detail.selectedValues;
          if (selectedOfficer !== null) {
            this.set('agreement.partner_manager', selectedOfficer.value);
            this.async(function() {
              this.$$('#signedByPartner').invalid = false;
            });
          }
        },

        /**
         * Handling signed by unicef selection. The partner manager id is needed and must be assigned to agreement.
         */
        _signedByUnicefSelected: function(event) {
          var selectedUnicefStaff = event.detail.selectedValues;
          if (selectedUnicefStaff !== null) {
            this.set('agreement.signed_by', selectedUnicefStaff.value);
            this.async(function() {
              this.$$('#signedByUnicef').invalid = false;
            });
          }
        },

        /**
         * Update esmm dropdown
         */
        _updateSignedByEsmmDropdown: function(esmm, selector, selectedValue) {
          this.async(function() {
            if (!esmm){
              esmm = this.fieldValidationReset(selector);
            }
            if (esmm) {
              esmm.value = selectedValue;
            }
          });
        },

        /**
         * Check is there is a selected signed by partner value when agreement data is received
         * and set it on the dropdown
         */
        _setSignedByPartnerDropdownValue: function(partnerStaffId) {
          var signedByPField = this.fieldValidationReset('#signedByPartner');
          if (partnerStaffId && Array.isArray(this.preparedOfficersDropdownData)
              && this.preparedOfficersDropdownData.length > 0
              && this._allowFieldEditing('signedByPartner', this.agreement.status)) {
            this.debounce('setSelectedSignedByPartner', function() {
              partnerStaffId = parseInt(partnerStaffId, 10);
              var selected = this.preparedOfficersDropdownData.filter(function(staff) {
                return parseInt(staff.value, 0) === partnerStaffId;
              });
              if (selected.length) {
                this._updateSignedByEsmmDropdown(signedByPField, '#signedByPartner', selected);
              }
            }.bind(this), 50);
          } else {
            this._updateSignedByEsmmDropdown(signedByPField, '#signedByPartner', []);
          }
        },

        _setSignedByUnicefDropdownValue: function(unicefStaffId) {
          var signedByUField = this.fieldValidationReset('#signedByUnicef');
          if (unicefStaffId && Array.isArray(this.partnerSeniorManagers)
              && this.partnerSeniorManagers.length > 0
              && this._allowFieldEditing('signedByUnicef', this.agreement.status)) {
            this.debounce('setSelectedSignedByUnicef', function() {
              unicefStaffId = parseInt(unicefStaffId, 10);
              var selected = this.partnerSeniorManagers.filter(function(staff) {
                return parseInt(staff.value, 0) === unicefStaffId;
              });
              if (selected.length) {
                this._updateSignedByEsmmDropdown(signedByUField, '#signedByUnicef', selected);
              }
            }.bind(this), 50);
          } else {
            this._updateSignedByEsmmDropdown(signedByUField, '#signedByUnicef', []);
          }
        },

        /**
         * Unicef staff data has changed observer
         */
        _unicefStaffChanged: function(unicefStaff) {
          if (Array.isArray(unicefStaff) && unicefStaff.length > 0) {
            var signedByUnicefOptions = unicefStaff.map(function(unicefUser) {
              return {
                value: parseInt(unicefUser.user_id, 10),
                label: unicefUser.full_name
              }
            });
            this.set('partnerSeniorManagers', signedByUnicefOptions);

            if (this.agreement && this.agreement.signed_by) {
              this._setSignedByUnicefDropdownValue(this.agreement.signed_by);
            }
          }
        },

        /**
         * Check if signed by fields have at least one valid value
         */
        _signedByValuesFilledAndValid: function(signedByUnicefStaffId, signedByUnicefDate,
                                                signedByPartnerStaffId, signedByPartnerDate) {
          return this.validateIdValue(signedByUnicefStaffId)
              || this.validateStringValue(signedByUnicefDate)
              || this.validateIdValue(signedByPartnerStaffId)
              || this.validateStringValue(signedByPartnerDate);

        },

        /**
         * Validate agreements fields on change
         */
        _agreementFieldChanged: function(agreementProperty) {
          // check edit permissions and continue only if true; no validations in view mode
          if (this.agreement && !this._allowEdit(this.agreement.status)) {
            return;
          }

          if (agreementProperty) {
            if (agreementProperty.path === 'agreement.start' || agreementProperty.path === 'agreement.end') {
              this._validateStartAndEndDateField();
            } else if (agreementProperty.path === 'agreement.signed_by'
                || agreementProperty.path === 'agreement.signed_by_unicef_date') {
              this._validateSignedByUnicefFields(this.agreement.signed_by, this.agreement.signed_by_unicef_date);
            } else if (agreementProperty.path === 'agreement.partner_manager'
                || agreementProperty.path === 'agreement.signed_by_partner_date') {
              this._validateSignedByPartnerFields(this.agreement.partner_manager, this.agreement.signed_by_partner_date);
            }
          }

        },

        /**
         * End date is conditioned by the start date
         * if start date is entered, then the end date is required;
         * also, when end date changes, trigger the validation again.
         */
        _validateStartAndEndDateField: function() {
          // check edit permissions and continue only if true
          if (!this._allowEdit(this.agreement.status)) {
            return;
          }
          var endDateField = this.$$('#endDateField');
          if (endDateField) {
            endDateField.validate();
          }
        },

        /**
         * Signed by unicef field is required in case signed by unicef date field is filed, and
         * signed by unicef date field is required in case signed by unicef is selected.
         * Also officers are required if at least one of these fields are populated.
         */
        _validateSignedByUnicefFields: function(singedByUnicefStaffId, signedByUnicefDateString) {
          var signedByUnicefField = this.$$('#signedByUnicef');
          var signedByUnicefDateField = this.$$('#signedByUnicefDateField');
          if (singedByUnicefStaffId !== null || signedByUnicefDateString !== null) {
            if (signedByUnicefField) {
              signedByUnicefField.validate();
            }
            if (signedByUnicefDateField) {
              signedByUnicefDateField.validate();
            }
          }
          // also partner authorized officers field is required if at least one of these 2 fields was filed
          var authorizedOfficers = this.$$('#authorizedOfficers');
          if (authorizedOfficers) {
            authorizedOfficers.validateOfficersSelection();
          }
        },

        /**
         * Signed by partner field is required in case signed by partner date field is filed, and
         * signed by partner date field is required in case signed by partner is selected.
         * Also officers are required if at least one of these fields are populated.
         */
        _validateSignedByPartnerFields: function(singedByPartnerStaffId, signedByPartnerDateString) {
          var signedByPartnerField = this.$$('#signedByPartner');
          var signedByPartnerDateField = this.$$('#signedByPartnerDateField');
          if (singedByPartnerStaffId !== null || signedByPartnerDateString !== null) {
            if (signedByPartnerField) {
              signedByPartnerField.validate();
            }
            if (signedByPartnerDateField) {
              signedByPartnerDateField.validate();
            }
          }
          // also partner authorized officers field is required if at least one of these 2 fields was filed
          var authorizedOfficers = this.$$('#authorizedOfficers');
          if (authorizedOfficers) {
            authorizedOfficers.validateOfficersSelection();
          }
        },

        /**
         * Validate agreement fields
         */
        _validateAgreement: function() {
          var valid = true;

          // validate partner
          if (this.validateIdValue(this.agreement.partner) === false) {
            valid = false;
            var partnerField = this.$$('#partner');
            if (partnerField) {
              this.$$('#partner').invalid = true;
            }
          }

          // validate agreement type
          if (this.validateStringValue(this.agreement.agreement_type) === false) {
            valid = false;
            var agreementTypeField = this.$$('#agreementType');
            if (agreementTypeField) {
              this.$$('#agreementType').invalid = true;
            }
          }

          // validate start date
          if (this.validateStringValue(this.agreement.start)) {
            // end date is required only if start date was selected
            var endDateField = this.$$('#endDateField');
            if (endDateField && endDateField.validate() === false) {
              valid = false;
            }
          }

          // validate signedByPartner and signedByPartnerDate and signedByManager and signedByManagerDate fields
          if (this._validSignedByFields(this.agreement.partner_manager, this.agreement.signed_by_partner_date,
                  this.agreement.signed_by, this.agreement.signed_by_unicef_date) === false) {
            valid = false;
          }

          // validate partner authorized officers in case
          if (this._validateSelectedOfficers() === false) {
            valid = false;
          }

          return valid;
        },

        /**
         * Validate signed by fields
         */
        _validSignedByFields: function(partnerStaffId, partnerSignedDate, unicefStaffId, unicefSignedDate) {
          var valid = true;

          // validate signedByPartner and signedByPartnerDate
          var validSignedByPartner = this.validateIdValue(partnerStaffId);
          var validSignedByPartnerDate = this.validateStringValue(partnerSignedDate);

          if (validSignedByPartnerDate) {
            // partner_manager is required only if sign_by_partner_date was selected
            if (validSignedByPartner === false) {
              valid = false;
              var signedByPartnerField = this.$$('#signedByPartner');
              if (signedByPartnerField) {
                signedByPartnerField.invalid = true;
              }
            }
          }

          if (validSignedByPartner) {
            if (validSignedByPartnerDate === false) {
              valid = false;
              var signedByPartnerDateField = this.$$('#signedByPartnerDateField');
              if (signedByPartnerDateField) {
                signedByPartnerDateField.validate();
              }
            }
          }

          // validate signedByUnicef and signedByUnicefDate fields
          var validSignedByUnicefStaff = this.validateIdValue(unicefStaffId);
          var validSignedByUnicefDate = this.validateStringValue(unicefSignedDate);

          if (validSignedByUnicefDate) {
            // signed_by is required only if sign_by_unicef_date was selected
            if (validSignedByUnicefStaff === false) {
              valid = false;
              var signedByUnicefField = this.$$('#signedByUnicef');
              if (signedByUnicefField) {
                signedByUnicefField.invalid = true;
              }
            }
          }

          // validate signedByUnicefDate
          if (validSignedByUnicefStaff) {
            if (validSignedByUnicefDate === false) {
              valid = false;
              var signedByUnicefDateField = this.$$('#signedByUnicefDateField');
              if (signedByUnicefDateField) {
                signedByUnicefDateField.validate();
              }
            }
          }

          return valid;
        },

        /**
         * Validate officers selection
         */
        _validateSelectedOfficers: function() {
          var valid = true;
          if (this._signedByValuesFilledAndValid(this.agreement.signed_by, this.agreement.signed_by_unicef_date,
                  this.agreement.partner_manager, this.agreement.signed_by_partner_date)) {
            if (this.$.authorizedOfficers.validateOfficersSelection() === false) {
              valid = false;
            }
          }
          return valid;
        },

        /**
         * Get agreement changed properties
         */
        _getCurrentChanges: function() {
          var changes = {};
          if (this.agreement && this.agreement.id === this.originalAgreementData.id) {
            // prevent the possibility of checking 2 different agreements
            var availableChangingFields = ['partner', 'agreement_type', 'start', 'end',
              'partner_manager', 'signed_by_partner_date', 'signed_by', 'signed_by_unicef_date',
              'authorized_officers'];
            // TODO: include amendments to above array with proper checkings
            availableChangingFields.forEach(function(fieldName) {
              if (fieldName === 'authorized_officers') {
                // TODO: authorized_officers more checkings?
                changes[fieldName] = this.agreement.authorized_officers.map(function(officer) {
                  return officer.id;
                });
              } else if (fieldName === 'agreements') {
                changes[fieldName] = this.agreement[fieldName];
              } else {
                if (this.agreement[fieldName] !== this.originalAgreementData[fieldName]) {
                  changes[fieldName] = this.agreement[fieldName];
                }
              }
            }.bind(this));
          }
          return changes;
        },

        /**
         * Save agreement if all fields are validated
         */
        _validateAndTriggerAgreementSave: function(event) {
          event.stopImmediatePropagation();
          if (!this.editMode) {
            return;
          }
          if (this._validateAgreement()) {
            if (!this.isNewAgreement) {
              // check/get only changed content to be used as a body to the save request
              var changedAgreementProperties = this._getCurrentChanges();
              // we also need the id
              changedAgreementProperties.id = this.agreement.id;
              // fire update agreement
              console.log('changes to be saved: ', changedAgreementProperties);
              this.fire('save-agreement', changedAgreementProperties);
            } else {
              this.fire('save-agreement', this._prepareNewAgreementDataForSave(this.agreement));
            }
          } else {
            this.fire('toast', {text: 'Please review invalid fields data!', showCloseBtn: true});
          }
        },

        _prepareNewAgreementDataForSave: function(agreement) {
          // we do not need all the agreement object data for the first save
          return {
            id: null,
            // authorized_officers: agreement.authorized_officers.map(function(officer) {
            //   return officer.id;
            // }),
            agreement_type: agreement.agreement_type,
            // TODO set attached_agreement after etools-file flow is decided
            // attached_agreement: null,
            start: agreement.start,
            end: agreement.end,
            signed_by_unicef_date: agreement.signed_by_unicef_date,
            signed_by_partner_date: agreement.signed_by_partner_date,
            status: 'draft',
            partner: agreement.partner,
            signed_by: agreement.signed_by,
            partner_manager: agreement.partner_manager
          }
        }

      });

    })();
  </script>

</dom-module>
