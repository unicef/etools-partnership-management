<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">

<link rel="import" href="../common-elements/etools-form-element-wrapper.html">
<link rel="import" href="../common-elements/etools-single-file.html">
<link rel="import" href="../common-elements/etools-error-messages-box.html">


<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/required-field-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/esmm-missing-options/missing-dropdown-options-behavior.html">

<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../partners/partners-data/partner-staff-members-data.html">

<link rel="import" href="agreement-amendments.html">
<link rel="import" href="agreement-status.html">
<link rel="import" href="generate-PCA-dialog.html">

<dom-module id="agreement-details">

  <template strip-whitespace>

    <style include="page-layout-styles grid-layout-styles shared-styles required-field-starred-styles buttons-styles">
      :host {
        @apply(--layout-horizontal);
        width: 100%;

        --esmm-list-wrapper: {
          max-height: 400px;
        }
      }

      paper-input,
      etools-date-input {
        width: 100%;
      }

      #generate-pca {
        /* TODO: change Generate PCA btn template - this should be applied on etools-form-element-wrapper with width auto */
        border-right: 1px solid var(--dark-divider-color);
      }
      #generate-pca[hidden] + .col {
        padding-left: 0;
      }

    </style>

    <partner-staff-members-data partner-id="[[agreement.partner]]"
                                prepared-staff-members-data="{{staffMembers}}">
    </partner-staff-members-data>

    <!-- main page content start -->
    <div id="pageContent">

      <etools-error-messages-box id="errorsBox"
                                 title="Errors Saving Agreement"
                                 errors="{{serverErrors}}"></etools-error-messages-box>

      <etools-content-panel class="content-section" panel-title="Agreement Details">

        <div class="row-h flex-c b-border row-second-bg">
          <div class="col col-6">
            <!-- Agreement Type -->
            <etools-single-selection-menu
                id="agreementType"
                label="Agreement Type"
                placeholder="&#8212;"
                options="[[agreementTypes]]"
                selected="{{agreement.agreement_type}}"
                dynamic-align
                hide-search
                readonly$="[[_isAgreementTypeReadonly(agreement)]]"
                auto-validate
                error-message="Please select agreement type"
                required>
            </etools-single-selection-menu>
          </div>
          <div class="col col-2">
            <!-- Reference Number -->
            <paper-input label="Reference Number"
                         value="[[agreement.agreement_number]]"
                         title$="[[agreement.agreement_number]]"
                         hidden$="[[!agreement.id]]"
                         placeholder="&#8212;"
                         readonly></paper-input>
          </div>
          <template is="dom-if" if="[[_showIfTypeMatches(agreement.agreement_type, 'PCA')]]">
            <div class="col col-4">
              <etools-form-element-wrapper label="Duration (Signed Date - CP End Date)" hidden$="[[!agreement.id]]">
                <span>[[prettyDate(agreement.start)]] &#8212; [[prettyDate(agreement.end)]]</span>
              </etools-form-element-wrapper>
            </div>
          </template>
        </div>

        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Partner name -->
            <etools-single-selection-menu
                id="partner"
                label="Partner Name"
                placeholder="&#8212;"
                options="[[partnersDropdownData]]"
                selected="{{agreement.partner}}"
                dynamic-align
                readonly$="[[!agreement.permissions.edit.partner]]"
                auto-validate
                error-message="Please select a partner"
                required>
            </etools-single-selection-menu>
          </div>
          <template is="dom-if" if="[[_showIfTypeMatches(agreement.agreement_type, 'MOU')]]" restamp>
            <div class="col col-3">
              <!-- Start date -->
              <etools-date-input id="startDateField"
                                 label="Start date"
                                 value="{{agreement.start}}"
                                 readonly$="[[!agreement.permissions.edit.start]]"
                                 no-init show-clear-btn
                                  required$="[[agreement.permissions.required.start]]">
              </etools-date-input>
            </div>
            <div class="col col-3">
              <!-- End date -->
              <etools-date-input id="endDateField"
                                 label="End date"
                                 value="{{agreement.end}}"
                                 readonly$="[[!agreement.permissions.edit.end]]"
                                 no-init show-clear-btn
                                 required$="[[agreement.permissions.required.end]]">
              </etools-date-input>
            </div>
          </template>
          <template is="dom-if" if="[[_showIfTypeMatches(agreement.agreement_type, 'PCA')]]" restamp>
            <div class="col col-6">
              <etools-single-selection-menu
                  id="cpStructure"
                  label="CP Structure"
                  placeholder="&#8212;"
                  options="[[cpStructureOptions]]"
                  option-value="id"
                  option-label="name"
                  hide-search
                  selected="{{agreement.country_programme}}"
                  readonly$="[[!agreement.permissions.edit.country_programme]]"
                  error-message="Please select CP Structure"
                  required$="[[agreement.permissions.required.country_programme]]">
              </etools-single-selection-menu>
            </div>
          </template>
        </div>

        <div hidden$="[[_showIfTypeMatches(agreement.agreement_type, 'SSFA')]]">
          <div class="row-h flex-c">
            <div class="col col-6">
              <!-- Signed By Partner -->
              <etools-single-selection-menu
                  id="signedByPartner"
                  label="Signed By Partner"
                  placeholder="&#8212;"
                  options="[[staffMembers]]"
                  option-value="id"
                  option-label="name"
                  selected="{{agreement.partner_manager}}"
                  dynamic-align
                  readonly$="[[!agreement.permissions.edit.partner_manager]]"
                  required$="[[agreement.permissions.required.partner_manager]]">
              </etools-single-selection-menu>
            </div>
            <div class="col col-3">
              <!-- Signed By Partner Date -->
              <etools-date-input id="signedByPartnerDateField"
                                label="Signed By Partner Date"
                                value="{{agreement.signed_by_partner_date}}"
                                readonly$="[[!agreement.permissions.edit.signed_by_partner_date]]"
                                no-init show-clear-btn
                                required$="[[agreement.permissions.required.signed_by_partner_date]]">
              </etools-date-input>
            </div>
          </div>
          <div class="row-h flex-c">
            <div class="col col-6">
              <!-- Signed By UNICEF -->
              <etools-single-selection-menu
                  id="signedByUnicef"
                  label="Signed By UNICEF"
                  placeholder="&#8212;"
                  options="[[unicefSeniorStaff]]"
                  option-value="user_id"
                  option-label="full_name"
                  selected="{{agreement.signed_by}}"
                  dynamic-align
                  readonly$="[[!agreement.permissions.edit.signed_by]]"
                  required$="[[agreement.permissions.required.signed_by]]">
              </etools-single-selection-menu>
            </div>
            <div class="col col-3">
              <!-- Signed By UNICEF Date -->
              <etools-date-input id="signedByUnicefDateField"
                                label="Signed By UNICEF Date"
                                value="{{agreement.signed_by_unicef_date}}"
                                readonly$="[[!agreement.permissions.edit.signed_by_unicef_date]]"
                                no-init show-clear-btn
                                required$="[[agreement.permissions.required.signed_by_unicef_date]]">
              </etools-date-input>
            </div>
          </div>
        </div>
        <div class="row-h flex-c">
          <!-- Partner Authorized Officers (partner staff members) -->
          <etools-multi-selection-menu id="officers"
                                       label="Authorized Officers"
                                       placeholder="&#8212;"
                                       options="[[_getAvailableAuthOfficers(staffMembers, agreement.authorized_officers)]]"
                                       option-value="id"
                                       option-label="name"
                                       selected-values="{{authorizedOfficers}}"
                                       readonly$="[[!_allowAuthorizedOfficersEditing(agreement.status, editMode, enableEditForAuthorizedOfficers)]]"
                                       error-message="Please enter the Partner Authorized Officer(s)"
                                       required$="[[enableEditForAuthorizedOfficers]]"
                                       auto-validate$="[[enableEditForAuthorizedOfficers]]">
          </etools-multi-selection-menu>
        </div>
        <div class="row-h flex-c t-border">
          <div id="generate-pca" class="col col-3"
               hidden$="[[!_showGeneratePcaBtn(agreement.agreement_type)]]">
            <paper-input-container
                class="form-field-wrapper secondary-btn-wrapper"
                always-float-label>
              <!-- Generate PCA -->
              <label aria-hidden="true">PCA Agreement to Sign</label>
              <paper-button class="paper-input-input secondary-btn" on-tap="_openGeneratePCADialog">
                <iron-icon icon="refresh"></iron-icon>
                GENERATE
              </paper-button>
            </paper-input-container>
          </div>
          <div class="col col-9">
            <etools-single-file
                file="{{agreement.attached_agreement}}"
                internal-file="[[agreement.attached_agreement_file]]"
                label="Signed Agreement"
                accept=".doc,.docx,.pdf,.jpg,.png"
                hide-delete-btn="[[_hideDeleteBtn(agreement.status, agreement.attached_agreement)]]"
                readonly$="[[!agreement.permissions.edit.attached_agreement]]"></etools-single-file>
          </div>
        </div>
      </etools-content-panel>

      <template is="dom-if" if="[[_showAmendments(agreement.agreement_type, agreement.status)]]">
        <!-- Amendments -->
        <etools-content-panel class="content-section" panel-title="Amendments ([[agreement.amendments.length]])">
          <agreement-amendments id="agreementAmendments"
                                data-items="{{agreement.amendments}}"
                                agreement-type="[[agreement.agreement_type]]"
                                edit-mode$="[[agreement.permissions.edit.amendments]]"
                                on-unlock-authorized-officers="_unlockAuthorizedOfficers"
                                on-lock-authorized-officers="_lockAuthorizedOfficersAndRestoreSelection">
          </agreement-amendments>
        </etools-content-panel>
      </template>

    </div> <!-- main page content end -->

    <!-- sidebar content start -->
    <div id="sidebar">
      <agreement-status status$="[[agreement.status]]"
                        new-agreement$="[[isNewAgreement]]"
                        agreement-id$="[[agreement.id]]"
                        agreement-type="[[agreement.agreement_type]]"
                        on-save-agreement="_validateAndTriggerAgreementSave"
                        show-save-btn$="[[editMode]]"></agreement-status>
    </div>
    <!-- sidebar content end -->

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'agreement-details',

        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior,
          pmpBehaviors.MissingDropdownOptionsBehavior
        ],

        properties: {
          agreement: {
            type: Object,
            notify: true,
            observer: '_agreementChanged'
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          },
          isNewAgreement: {
            type: Boolean,
            value: false,
            observer: '_isNewAgreementChanged'
          },
          partnersDropdownData: {
            type: Array,
            statePath: 'partnersDropdownData'
          },
          agreementTypes: {
            type: Array,
            statePath: 'agreementTypes'
          },
          staffMembers: {
            type: Array,
            value: []
          },
          authorizedOfficers: Array,
          unicefSeniorStaff: {
            type: Array,
            statePath: 'signedByUnicefUsers'
          },
          originalAgreementData: {
            type: Object,
            value: null
          },
          amendments: {
            type: Array,
            value: []
          },
          serverErrors: {
            type: Array,
            value: []
          },
          oldSelectedPartnerId: Number,
          countryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          cpStructureOptions: {
            type: Object,
            value: []
          },
          enableEditForAuthorizedOfficers: {
            type: Boolean,
            value: false
          }
        },

        observers: [
          '_agreementFieldChanged(agreement.*)',
          '_partnerChanged(agreement.partner)',
          '_countryProgrammesChanged(countryProgrammes, agreement)'
        ],
        ready: function() {
          this.generatePCADialog = document.createElement('generate-pca-dialog');
          this.generatePCADialog.setAttribute('id', 'generatePCADialog');
          Polymer.dom(document.querySelector('body')).appendChild(this.generatePCADialog);
        },
        attached: function() {
          this.async(function() {
              this.setDropdownMissingOptionsAjaxDetails(this.$$('#signedByUnicef'), 'unicefUsers', {dropdown: true});
            }
          );
        },
        detached: function() {
          if (this.generatePCADialog) {
            Polymer.dom(document.querySelector('body')).removeChild(this.generatePCADialog);
          }
        },

        // Editing Agreement Type is allowed only if Agreement is new/unsaved
        _isAgreementTypeReadonly: function() {
          return (this.agreement && this.agreement.id);
        },
        _hideDeleteBtn: function() {
          if (this._isDraft() && this.agreement && this.agreement.attached_agreement_file) {
            return true;
          }
          return false;
        },

        _isNewAgreementChanged: function(isNew) {
          this._setDraftStatus(this.editMode, isNew);
        },

        _editModeChanged: function(editMode) {
          this._setDraftStatus(editMode, this.isNewAgreement);
        },

        _setDraftStatus: function(editMode, isNewAgreement) {
          if (editMode && isNewAgreement && this.agreement && this.agreement.status !== 'draft') {
            this.set('agreement.status', 'draft');
          }
        },

        _showAmendments: function(type, status) {
          if (type !== 'MOU' && status !== 'draft') {
            return true;
          }
          return false;
        },

        /**
         * When agreement data is changed we need to check and prepare attached agreement file and
         * display amendments if needed
         */
        _agreementChanged: function(agreement) {
          console.log('agreement', agreement);
          if (this.generatePCADialog) {
            this.generatePCADialog.agreementId = agreement.id;
          }

          this.set('serverErrors', []);
          if (typeof agreement === 'object' && agreement !== null && agreement.id) {
            if (agreement.id > 0) {
              // prevent wrong new agreement value
              this.set('isNewAgreement', false);
            }

            this.set('oldSelectedPartnerId', agreement.partner);

            // keep a copy of the agreement before changes are made and use it later to save only the changes
            this.set('originalAgreementData', JSON.parse(JSON.stringify(agreement)));

            this.fieldValidationReset('#cpStructure');
            this.set('enableEditForAuthorizedOfficers', false);

            // forces etools-single-file to redraw the element
            if (!agreement.attached_agreement) {
              this.set('agreement.attached_agreement', {});
            }
            if (!agreement.attached_agreement_file) {
              this.set('agreement.attached_agreement_file', '');
            }
            this._initAuthorizedOfficers(agreement.authorized_officers);

          } else {
            this.set('agreement.attached_agreement', {});
            this.set('agreement.attached_agreement_file', '');
            // new agreement, update status to draft and reset fields
            this._setDraftStatus(this.editMode, this.isNewAgreement);
            this._resetDropdown('#partner');
            this._resetDropdown('#agreementType');
          }
          this.fire('global-loading', {active: false});

        },

        _resetDropdown: function(selector) {
          var field = this.fieldValidationReset(selector);
          if (field) {
            field.set('selected', null);
          }
        },

        /**
         * Verify if agreement status is 'draft'
         */
        _isDraft: function() {
          if (!this.agreement || !this.agreement.status) {
            return false;
          }
          return this.agreement.status === 'draft' || this.agreement.status === '';
        },

        _allowEdit: function(agreementStatus, editMode) {
          editMode = editMode || this.editMode;
          if (!editMode) {
            return false;
          }
          if (!(this.agreement && this.agreement.id > 0) || (agreementStatus && this._isDraft())) {
            return true;
          }
          return false;
        },

        _showGeneratePcaBtn: function(type) {
          return type === 'PCA' && this._isDraft();
        },

        _partnerChanged: function(currentPartnerId) {
          if (this.agreement && currentPartnerId !== this.oldSelectedPartnerId) {
            // partner not set or changed, reset related fields
            this.set('agreement.partner_manager', null);
            this.set('staffMembers', []);
            this.set('authorizedOfficers', []);
            this.set('agreement.authorized_officers', []);
            this.set('oldSelectedPartnerId', currentPartnerId);
          }
        },

        /**
         * Validate agreements fields on change
         */
        _agreementFieldChanged: function(agreementProperty) {
          // check edit permissions and continue only if true; no validations in view mode
          if (this.agreement && !this._allowEdit(this.agreement.status)) {
            return;
          }

          if (agreementProperty && agreementProperty.path === 'agreement.agreement_type') {
            if (agreementProperty.value !== 'PCA') {
              // reset country_programme as it's available only for PCA type
              this.set('agreement.country_programme', null);
              // reset start and end date
              // TODO: decide if we reset start and end dates when type is changed
              // this.set('agreement.start', null);
              // this.set('agreement.end', null);
            } else {
              if (this.cpStructureOptions instanceof Array && this.cpStructureOptions.length === 1) {
                this.set('agreement.country_programme', this.cpStructureOptions[0].id);
              }
            }
          }

        },

        /**
         * Validate agreement fields
         */
        _validateAgreement: function() {
          var valid = true;
          var self = this;
          var requiredFieldsSelectors = ['#partner', '#agreementType','#officers', '#agreementAmendments'];
          if (this.agreement.agreement_type === 'PCA') {
            requiredFieldsSelectors.push('#cpStructure');
          }
          requiredFieldsSelectors.forEach(function(fSelector) {
            let field = self.$$(fSelector);
            if (field && !field.validate()) {
              valid = false;
            }
          });
          return valid;
        },
        _objectFieldIsModified: function(fieldName) {
          // jscs:disable maximumLineLength
          return JSON.stringify(this.originalAgreementData[fieldName]) !== JSON.stringify(this.agreement[fieldName]);
          // jscs:enable maximumLineLength
        },
        _authorizedOfficersChanged: function() {
          var initialAuthOfficers = this._getInitialAuthorizedOfficersIds();
          return JSON.stringify(initialAuthOfficers) !== JSON.stringify(this.authorizedOfficers);
        },
        _primitiveFieldIsModified: function(fieldName) {
          return this.originalAgreementData[fieldName] !== this.agreement[fieldName];
        },
        _getInitialAuthorizedOfficersIds: function() {
          if (!this.originalAgreementData.authorized_officers) {
            return null;
          }
          return this.originalAgreementData.authorized_officers.map(function(off) {
              return off.id.toString();
            }
          );
        },
        /**
         * Get agreement changed properties
         */
        _getCurrentChanges: function() {
          var changes = {};
          if (!this.agreement || this.agreement.id !== this.originalAgreementData.id) {
            // prevent the possibility of checking 2 different agreements
             return {};
          }

          if (this._primitiveFieldIsModified('partner')) {
            changes.partner = this.agreement.partner;
          }

          if (this._authorizedOfficersChanged()) {
            changes.authorized_officers = this.authorizedOfficers;
          }

          if ((this.agreement.hasOwnProperty('attached_agreement')) &&
                  (this.agreement.attached_agreement instanceof File)) {
            changes.attached_agreement = this.agreement.attached_agreement;
          }

          if (this.agreement.agreement_type !== 'MOU' && this._objectFieldIsModified('amendments')) {
              changes.amendments = this.agreement.amendments;
          }

          if (this.agreement.agreement_type === 'MOU') {
            ['start','end'].forEach(function(fieldName) {
              if (this._primitiveFieldIsModified(fieldName)) {
                changes[fieldName] = this.agreement[fieldName];
              }
            }.bind(this));
          }

          if (this.agreement.agreement_type === 'PCA') {
            if (this._primitiveFieldIsModified('country_programme')) {
              changes.country_programme = this.agreement.country_programme;
            }
          }

          if (this.agreement.agreement_type !== 'SSFA') {
            var signedByFields = ['partner_manager',  'signed_by', 'signed_by_partner_date', 'signed_by_unicef_date'];
            signedByFields.forEach(function(fieldName) {
              if (this._primitiveFieldIsModified(fieldName)) {
                changes[fieldName] = this.agreement[fieldName];
              }
            }.bind(this));
          }
          return changes;
        },
        /**
         * Save agreement if all fields are validated
         */
        _validateAndTriggerAgreementSave: function(event) {
          event.stopImmediatePropagation();
          if (!this.editMode) {
            return;
          }
          if (!this._validateAgreement()) {
            this.fire('toast', {text: 'Please review invalid fields data!', showCloseBtn: true});
            return;
          }

          if (this.isNewAgreement) {
            this.fire('save-agreement', this._prepareNewAgreementDataForSave(this.agreement));
          } else {
            // check/get only changed content to be used as a body to the save request
            var changedAgreementProperties = this._getCurrentChanges();
            // we also need the id
            changedAgreementProperties.id = this.agreement.id;
            // fire update agreement
            this.fire('save-agreement', changedAgreementProperties);
          }
        },

        _prepareNewAgreementDataForSave: function(agreement) {
          // we do not need all the agreement object data for the first save
          var newAgreement = {
            id: null,
            status: '',
            agreement_type: agreement.agreement_type,
            partner: agreement.partner,
            authorized_officers: this.authorizedOfficers,
            start: agreement.agreement_type === 'MOU' ? agreement.start : null,
            end: agreement.agreement_type === 'MOU' ? agreement.end : null,
            country_programme:  agreement.agreement_type === 'PCA' ? agreement.country_programme : null,
            attached_agreement: agreement.attached_agreement,
          };

          if (newAgreement.agreement_type !== 'SSFA') {
            newAgreement.signed_by_unicef_date = agreement.signed_by_unicef_date;
            newAgreement.signed_by_partner_date = agreement.signed_by_partner_date;
            newAgreement.signed_by = agreement.signed_by;
            newAgreement.partner_manager = agreement.partner_manager;
          }
          return newAgreement;
        },

        _getAvailableAuthOfficers: function(staffMembers, agreementAuthorizedOfficers) {
          if (staffMembers instanceof Array && staffMembers.length) {
            return staffMembers;
          }
          if (agreementAuthorizedOfficers instanceof Array && agreementAuthorizedOfficers.length) {
            return agreementAuthorizedOfficers.map(function(staffMember) {
              return {
                id: staffMember.id,
                name: staffMember.first_name + ' ' + staffMember.last_name
              };
            });
          }
          return [];
        },

        /**
         * Check if agreement type is expected type
         */
        _showIfTypeMatches: function(agreementType, expectedType) {
          return agreementType === expectedType;
        },

        /**
         * Filter Country programmes:
         *    - omit any CP where the end date is in the past
         *    - omit any CP with indicator 99 as the last two digits of WBS (e.g. 3930/A0/99)
         *    - omit any CP that has an indicator other than “A0” after the first slash (e.g. omit 2490/PC/07)
         */
        _filterCountryProgrammesForAgreements: function(countryProgrammes) {
          var self = this;
          return countryProgrammes.filter(function(cp) {
            return (cp.active || cp.future) && !cp.special;
          });
        },

        _openGeneratePCADialog: function() {
          this.generatePCADialog.open();
        },

        /**
         * Filter CP to obtain agreement CP Structure options.
         * If the result is just one option then set it as selected by default, make dropdown readonly
         */
        _countryProgrammesChanged: function(cp, agreement) {
          let cpStructure = [];
          let isEditableField = agreement.permissions.edit.country_programme;
          if (agreement && !isEditableField) {
            // old agreement / agreement not in 'draft' status
            cpStructure = cp;
          } else {
            // editable agreement
            cpStructure = this._filterCountryProgrammesForAgreements(cp);
          }

          this.set('cpStructureOptions', cpStructure);
          let cpStructureIsOld = this._hasNotAvailableCpAssigned(this.agreement.country_programme);
          if (cpStructure.length === 1 && !cpStructureIsOld) {
            this.set('agreement.country_programme', cpStructure[0].id);
          }
          if (cpStructureIsOld && isEditableField && this.agreement && this.agreement.agreement_type === 'PCA') {
            // let the user know cp structure is expired/old
            this.fire('toast', {text: 'This agreement has an old/expired CP Structure!', showCloseBtn: true});
            this.set('agreement.country_programme', null);
          }
        },

        _initAuthorizedOfficers: function(authOfficers) {
          if (authOfficers instanceof Array && authOfficers.length) {
            this.set('authorizedOfficers', authOfficers.map(function(authOfficer) {
              return authOfficer.id + '';
            }));
            return;
          }
          this.set('authorizedOfficers', []);
        },

        // trigger authorized officers field to be locked/unlocked
        _unlockAuthorizedOfficers: function(e) {
          e.stopImmediatePropagation();
          this.set('enableEditForAuthorizedOfficers', true);
        },

        // set authorized officers field readonly mode
        _allowAuthorizedOfficersEditing: function(agreementStatus, editMode, enableEditForAuthorizedOfficers) {
          if (!editMode) {
            // used has no edit permissions
            return false;
          }
          /**
           * canBeEdited = false - either field is locked or the user has no edit permissions;
           * not knowing exactly why is false we need to check user editMode first(first method lines)
           */
          let canBeEdited = this.agreement.permissions.edit.authorized_officers;
          // if is locked (in signed status), enableEditForAuthorizedOfficers will make this field editable
          if (!canBeEdited && enableEditForAuthorizedOfficers) {
            // reset existing officers selection
            this.set('authorizedOfficers', []);
            return true;
          }
          return canBeEdited;
        },

        // trugger authorized officers field lock and restore initial value(if needed)
        _lockAuthorizedOfficersAndRestoreSelection: function(e) {
          e.stopImmediatePropagation();
          if (!this.enableEditForAuthorizedOfficers) {
            // stop; enableEditForAuthorizedOfficers already set to false
            return;
          }
          // restore officers selection (because you do not have any new amendment for changing this field)
          this._initAuthorizedOfficers(this.originalAgreementData.authorized_officers);
          this.set('enableEditForAuthorizedOfficers', false);
        },

        _hasNotAvailableCpAssigned: function(agCp) {
          if (agCp > 0 && this.cpStructureOptions instanceof Array) {
            let cp = this.cpStructureOptions.find(function(cp) {
              return parseInt(cp.id, 10) === parseInt(agCp, 10);
            });
            if (!cp) {
              return true;
            }
          }
          return false;
        }

      });
    })();
  </script>

</dom-module>
