<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="./agreement-behaviors/agreement-amendments-behavior.html">
<link rel="import" href="./agreement-behaviors/agreements-common-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">

<dom-module id="agreement-amendment-types">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles buttons-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;
      }

      .item-container {
        background-color: #EDEDED; /* TODO: replace with app-theme var */
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
      }

      .item-container,
      .item-container + .item-container {
        margin-top: 15px;
      }

      .item-container .item-content {
        border-left-style: dashed;
      }

      .action.delete:not(:hover) {
        color: #929292 /* TODO: replace with app-theme var */
      }

      .add-amendment-type-wrapper {
        margin-top: 25px;
      }

      paper-input,
      paper-dropdown-menu,
      etools-searchable-multiselection-menu {
        width: 380px;
      }

      paper-textarea {
        width: 100%;
      }

      .item-content {
        padding-top: 10px;
        padding-bottom: 10px;
      }

      .item-content .row-h + .row-h {
        margin-top: 0;
      }

    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="row-h item-actions-container">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">
            <div class="row-h">
              <etools-searchable-multiselection-menu id$="amendmentType_[[index]]"
                                                     label="Amendment Type"
                                                     placeholder="&#8212;"
                                                     options="[[_amendmentTypes]]"
                                                     on-value-change="_amendmentTypeSelected"
                                                     error-message="Please select amendment type"
                                                     custom-object-options>
              </etools-searchable-multiselection-menu>
            </div>

            <div class="row-h">
              <!-- Officer -->
              <etools-searchable-multiselection-menu id$="officersDropdown_[[index]]"
                                                     label="Officer"
                                                     placeholder="&#8212;"
                                                     options="[[preparedDropdownOfficersData]]"
                                                     hidden="[[!showAmendmentTypeOfficer(item.amendment_type)]]"
                                                     on-value-change="_officerSelected"
                                                     error-message="Please select an officer">
              </etools-searchable-multiselection-menu>


              <!-- Bank information -->
              <!-- TODO: it seems bank information from partner details was removed from specs ...
              this field supposed to be maped with that data as a dropdown ... ???? ...
              will remain as text until it's clarified -->
              <paper-input id$="bankInfo_[[index]]"
                           hidden="[[!showAmendmentTypeBankInfo(item.amendment_type)]]"
                           label="New Bank Account"
                           placeholder="&#8212;"
                           value="{{item.bank_info}}"
                           error-message="Please select bank information">
              </paper-input>

              <!-- Legal name of IP -->
              <paper-input hidden="[[!showAmendmentTypeLegalNameOfIp(item.amendment_type)]]"
                           label="Full Name of Implementing Partner"
                           value="[[item.legal_name_of_ip]]"
                           readonly>
              </paper-input>

              <!-- End Date -->
              <paper-input hidden="[[!showAmendmentTypeExtensionProgrammeCycle(item.amendment_type)]]"
                           label="CP Cycle End Date"
                           value="[[prettyDate(_countryProgrammeCycleEndDate)]]"
                           readonly>
              </paper-input>

              <!-- Additional Clauses -->
              <paper-textarea id$="additionalClause_[[index]]"
                              hidden="[[!showAmendmentTypeAdditionalClauses(item.amendment_type)]]"
                              label="Additional Clauses"
                              placeholder="&#8212;"
                              value="{{item.additional_clauses}}"
                              error-message="Please enter additional clause">
              </paper-textarea>

              <!-- Change Existing Clauses -->
              <paper-textarea id$="existingClauseAmended_[[index]]"
                              hidden="[[!showAmendmentTypeExistingClauseAmended(item.amendment_type)]]"
                              label="Clause Change"
                              placeholder="&#8212;"
                              value="{{item.existing_clause_amended}}"
                              error-message="Please enter additional amended clause">
              </paper-textarea>
            </div>

          </div>

        </div>
      </template>
    </div>

    <div class="row-h add-amendment-type-wrapper">
      <paper-button class="secondary-btn"
                    on-tap="_addNewAmendmentType"
                    title="Add Amendment Type">
        Add Amendment Type
      </paper-button>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'agreement-amendment-types',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.AgreementsCommonBehavior,
          pmpBehaviors.AgreementAmendmentsBehavior,
          pmpBehaviors.DateBehavior
        ],

        properties: {
          partner: {
            type: Object
          },
          partnerAuthorizedOfficers: {
            type: Array, // partner staff members
          },
          _amendmentTypes: {
            type: Array,
            statePath: 'agreementAmendmentTypes'
          }
        },

        observers: ['_amendmentTypePropertyChanged(dataItems.*)'],

        ready: function() {
          // TODO: refactor this data model, might not have the same properties with the API data
          this.dataSetModel = {
            amendment_type_id: null,
            amendment_type: null,
            officer_id: null,
            bank_info: null,
            legal_name_of_ip: null,
            cp_cycle_end: null,
            additional_clauses: null,
            existing_clause_amended: null
          };
          this.set('editMode', true);
          // this.set('_amendmentTypes', [
          //   {value: 1, label: 'Change in Legal Name of Implementing Partner'},
          //   {value: 2, label: 'Extension of Country Programme Cycle'},
          //   {value: 3, label: 'Change Authorized Officer'},
          //   {value: 4, label: 'Banking Information'},
          //   {value: 5, label: 'Additional Clause'},
          //   {value: 6, label: 'Amend Existing Clause'}
          // ]);

          // TODO: get countryProgrammeCycle from patner/API ?
          this._countryProgrammeCycleEndDate = '2017-07-25';
          this.prepareDropdownOfficersData(this.partnerAuthorizedOfficers);
        },

        /**
         * Validate last amendment type; if valid add a new one.
         */
        _addNewAmendmentType: function() {
          if (this.dataItems.length === 0) {
            this._addElement();
          } else {
            var lastAmendmentTypeIndex = this.dataItems.length - 1;
            var lastAmendmentType = this.dataItems[lastAmendmentTypeIndex];

            if (lastAmendmentType.amendment_type === null) {
              this._invalidAmendmentTypeField(true, '#amendmentType_' + lastAmendmentTypeIndex);
            } else {
              var validation = this.validAmendmentType(lastAmendmentType, lastAmendmentTypeIndex);
              if (validation.result === false) {
                this._invalidAmendmentTypeField(true, '#' + validation.elementId);
              } else {
                this._addElement();
              }
            }
          }
        },

        /**
         * Amendment type property observer
         */
        _amendmentTypePropertyChanged: function(dataItem) {
          if (dataItem.path !== 'dataItems' && dataItem.path !== 'dataItems.splices'
              && dataItem.path !== 'dataItems.length' && this.get(dataItem.path) !== null) {
            var changedValuePath = dataItem.path.split('.');
            changedValuePath.pop();
            var itemPath = changedValuePath.join('.');

            var item = this.get(itemPath);
            var itemIndex = this.dataItems.indexOf(item);

            if (this.showAmendmentTypeLegalNameOfIp(item.amendment_type)) {
              this.set(itemPath + '.legal_name_of_ip', this.partner.name);
              this._resetPaths(itemIndex, ['legal_name_of_ip']);
              // reset selected officers
              this._resetOfficersDropdownSelection(itemIndex);
            }

            if (this.showAmendmentTypeExtensionProgrammeCycle(item.amendment_type)) {
              this.set(itemPath + '.cp_cycle_end', this._countryProgrammeCycleEndDate);
              this._resetPaths(itemIndex, ['cp_cycle_end']);
              // reset selected officers
              this._resetOfficersDropdownSelection(itemIndex);
            }

            if (this.showAmendmentTypeOfficer(item.amendment_type)) {
              this._resetPaths(itemIndex, ['officer_id']);
              if (item.officer_id > 0) {
                this._invalidAmendmentTypeField(false, '#officersDropdown_' + itemIndex);
              }
            }

            if (this.showAmendmentTypeBankInfo(item.amendment_type)) {
              this._resetPaths(itemIndex, ['bank_info']);
              if (item.bank_info !== null || item.bank_info !== '') {
                this._invalidAmendmentTypeField(false, '#bankInfo_' + itemIndex);
              }
            }

            if (this.showAmendmentTypeAdditionalClauses(item.amendment_type)) {
              this._resetPaths(itemIndex, ['additional_clauses']);
              if (item.additional_clauses !== null || item.additional_clauses !== '') {
                this._invalidAmendmentTypeField(false, '#additionalClause_' + itemIndex);
              }
            }

            if (this.showAmendmentTypeExistingClauseAmended(item.amendment_type)) {
              this._resetPaths(itemIndex, ['existing_clause_amended']);
              if (item.existing_clause_amended !== null || item.existing_clause_amended !== '') {
                this._invalidAmendmentTypeField(false, '#existingClauseAmended_' + itemIndex);
              }
            }

          }
        },

        /**
         * Reset amendment type fields when the type changes
         */
        _resetPaths: function(index, exceptions) {
          if (index > 0) {
            Object.keys(this.dataSetModel).forEach(function(property) {
              if (exceptions.indexOf(property) === -1 && property !== 'amendment_type') {
                this.set('dataItems.' + index + '.' + property, null);
              }
            }.bind(this));
          }
        },

        /**
         * Reset officers dropdown
         */
        _resetOfficersDropdownSelection: function(itemIndex) {
          var officersDropdown = this.$$('#officersDropdown_' + itemIndex);
          officersDropdown.selectedValues = [];
          officersDropdown.value = '';
        },

        /**
         * When a amendment type is selected or not, validate this field and notify parent, to revalidate signed date
         */
        _amendmentTypeSelected: function(event) {
          var selectedAmendmentType = null;
          var amendmentTypeId = '#amendmentType_' + event.model.index;
          if (event.detail.selectedValues !== null) {
            selectedAmendmentType = event.detail.selectedValues.value;
            this._invalidAmendmentTypeField(false, amendmentTypeId);
          } else {
            this._invalidAmendmentTypeField(true, amendmentTypeId);
          }
          this.set('dataItems.' + event.model.index + '.amendment_type', selectedAmendmentType);
          this.fire('amendment-selected', {type: selectedAmendmentType});
        },

        /**
         * Handle officer selection
         */
        _officerSelected: function(event) {
          var officerId = null;
          if (event.detail.selectedValues !== null) {
            officerId = event.detail.selectedValues.value;
          }
          this.set('dataItems.' + event.model.index + '.officer_id', officerId);
        },

        /**
         * Set invalid value of the amendment type field
         */
        _invalidAmendmentTypeField: function(value, selector) {
          this.$$(selector).invalid = value;
        },

      });
    })();
  </script>
</dom-module>
