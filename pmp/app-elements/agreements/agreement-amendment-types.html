<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="./agreement-behaviors/agreement-amendments-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">

<dom-module id="agreement-amendment-types">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;
      }

      .add-amendment-type-wrapper {
        margin-top: 25px;
      }

    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="row-h item-actions-container">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">
            <div class="row-h">
              <paper-dropdown-menu label="Amendment Type"
                                   horizontal-align="left"
                                   vertical-align="top">
                <paper-listbox class="dropdown-content" selected="{{item.amendment_type}}"
                               attr-for-selected="name">
                  <template is="dom-repeat" items="[[_amendmentTypes]]"
                            as="amendmentTypeValue" index-as="amendmentTypeValueIndex">
                    <paper-item name$="[[amendmentTypeValue]]">[[amendmentTypeValue]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>

            <div class="row-h">
              <!-- Officer -->
              <etools-searchable-multiselection-menu id$="officersDropdown_[[index]]"
                                                     label="Officer"
                                                     options="[[_getAuthorizedOfficersData(partnerAuthorizedOfficers)]]"
                                                     hidden="[[!showAmendmentTypeOfficer(item.amendment_type)]]">
              </etools-searchable-multiselection-menu>


              <!-- Bank information -->
              <!-- TODO: it seems bank information from partner details was removed from specs ...
              this field supposed to be maped with that data as a dropdown ... ???? ...
              will remain as text until it's clarified -->
              <paper-input hidden="[[!showAmendmentTypeBankInfo(item.amendment_type)]]"
                           label="New Bank Account"
                           value="{{item.bank_info}}">
              </paper-input>

              <!-- Legal name of IP -->
              <paper-input hidden="[[!showAmendmentTypeLegalNameOfIp(item.amendment_type)]]"
                           label="Full Name of Implementing Partner"
                           value="[[item.legal_name_of_ip]]"
                           readonly>
              </paper-input>

              <!-- End Date -->
              <paper-input hidden="[[!showAmendmentTypeExtensionProgrammeCycle(item.amendment_type)]]"
                           label="CP Cycle End Date"
                           value="[[prettyDate(_countryProgrammeCycleEndDate)]]"
                           readonly>
              </paper-input>

              <!-- Additional Clauses -->
              <paper-textarea hidden="[[!showAmendmentTypeAdditionalClauses(item.amendment_type)]]"
                              label="Additional Clauses"
                              value="{{item.additional_clauses}}">
              </paper-textarea>

              <!-- Change Existing Clauses -->
              <paper-textarea hidden="[[!showAmendmentTypeExistingClauseAmended(item.amendment_type)]]"
                              label="Clause Change"
                              value="{{item.existing_clause_amended}}">
              </paper-textarea>
            </div>

          </div>

        </div>
      </template>
    </div>

    <div class="row-h add-amendment-type-wrapper">
      <paper-button class="basic-btn"
                    on-tap="_addNewAmendmentType"
                    title="Add Amendment Type">
        Add Amendment Type
      </paper-button>
    </div>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'agreement-amendment-types',

        behaviors: [
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.AgreementAmendmentsBehavior,
          pmpBehaviors.DateBehavior
        ],

        properties: {
          partner: {
            type: Object
          },
          partnerAuthorizedOfficers: {
            type: Array, // partner staff members
          }
        },

        observers: ['_amendmentTypePropertyChanged(dataItems.*)'],

        ready: function () {
          // TODO: refactor this data model, might not have the same properties with the API data
          this.dataSetModel = {
            amendment_type_id: null,
            amendment_type: null,
            officer_id: null,
            bank_info: null,
            legal_name_of_ip: null,
            cp_cycle_end: null,
            additional_clauses: null,
            existing_clause_amended: null
          };

          this.set('editMode', true);
          this.set('_amendmentTypes', [
            'Change in Legal Name of Implementing Partner',
            'Extension of Country Programme Cycle',
            'Change Authorized Officer',
            'Banking Information',
            'Additional Clause',
            'Amend Existing Clause'
          ]);

          // TODO: get countryProgrammeCycle from patner/API ?
          this._countryProgrammeCycleEndDate = '2017-07-25';

        },

        _addNewAmendmentType: function () {

          this._addElement();

        },

        _amendmentTypePropertyChanged: function(dataItem) {
          if (dataItem.path !== 'dataItems' && dataItem.path !== 'dataItems.splices'
              && dataItem.path !== 'dataItems.length' && this.get(dataItem.path) !== null) {
            var changedValuePath = dataItem.path.split('.');
            changedValuePath.pop();
            var itemPath = changedValuePath.join('.');

            var item = this.get(itemPath);
            var itemIndex = this.dataItems.indexOf(item);

            if (this.showAmendmentTypeLegalNameOfIp(item.amendment_type)) {
              this.set(itemPath + '.legal_name_of_ip', this.partner.name);
              this.set(itemPath + '.cp_cycle_end', null);

              // reset selected officers
              this._resetOfficersDropdownSelection(itemIndex);

              this.set(itemPath + '.officer_id', null);
              this.set(itemPath + '.bank_info', null);
              this.set(itemPath + '.additional_clauses', null);
              this.set(itemPath + '.existing_clause_amended', null);
            }
            if (this.showAmendmentTypeExtensionProgrammeCycle(item.amendment_type)) {
              this.set(itemPath + '.legal_name_of_ip', null);
              this.set(itemPath + '.cp_cycle_end', this._countryProgrammeCycleEndDate);

              // reset selected officers
              this._resetOfficersDropdownSelection();

              this.set(itemPath + '.officer_id', null);
              this.set(itemPath + '.bank_info', null);
              this.set(itemPath + '.additional_clauses', null);
              this.set(itemPath + '.existing_clause_amended', null);
            }
            if (this.showAmendmentTypeOfficer(item.amendment_type)) {
              this.set(itemPath + '.legal_name_of_ip', null);
              this.set(itemPath + '.cp_cycle_end', null);
              this.set(itemPath + '.officer_id', this._getSelectedOfficerId(itemIndex));
              this.set(itemPath + '.bank_info', null);
              this.set(itemPath + '.additional_clauses', null);
              this.set(itemPath + '.existing_clause_amended', null);
            }


          }
        },

        _getAuthorizedOfficersData: function(partnerAuthorizedOfficers) {
          if (Array.isArray(partnerAuthorizedOfficers) && !Array.isArray(this._officersData)) {
            var _officersD = [];
            partnerAuthorizedOfficers.forEach(function(officer) {
              _officersD.push({
                value: officer.id,
                label: this._computeOfficerName(officer.first_name, officer.last_name)
              });
            }.bind(this));
            this.set('_officersData', _officersD);
          }
          return this._officersData;
        },

        _computeOfficerName: function (firstName, lastName) {
          return firstName + ' ' + lastName;
        },

        _resetOfficersDropdownSelection: function(itemIndex) {

        },

        _getSelectedOfficerId: function(itemIndex) {

        }

      });
    })();
  </script>
</dom-module>
