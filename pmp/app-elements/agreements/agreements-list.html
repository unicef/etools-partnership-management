<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../agreements-data/agreements-data.html">
<link rel="import" href="../partners-data/partners-data.html">

<link rel="import" href="../../../styles/shared-styles.html">

<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">

<link rel="import" href="../../app-behaviors/dropdown-behavior.html">

<dom-module id="agreements-list">

  <template>

    <style include="shared-styles iron-flex iron-flex-factors">

      :host {
        display: block;
      }

      :host([hidden]) {
        display: none;
      }

      .header {
        @apply(--layout-horizontal);
        @apply(--layout-center);

        padding: 0 39px 0 49px;
        line-height: 56px;
        font-size: 12px;
        font-weight: bold;
        border-bottom: 1px solid var(--dark-divider-color);
      }

      .header > div {
        min-width: 100px;
        margin-right: 10px;
      }

      .header > div > span {
        cursor: pointer;
      }

      #list {
        display: block;
        position: relative;
        margin: 20px auto;
        opacity: 1;
        transition: opacity 0.4s;
        max-width: 920px;
        background-color: #FFFFFF;
      }

      #temp {
        @apply(--layout-horizontal);
      }

      #list.hidden {
        transition: none;
        opacity: 0;
      }

      .row {
        @apply(--layout-vertical);

        cursor: pointer;
        overflow: hidden;
        padding: 15px 15px;
        font-size: 13px;
        border-bottom: 1px solid var(--dark-divider-color);
      }

      .row:hover {
        background: var(--dark-hover-color);
      }

    </style>

    <agreements-data id="agreements" filtered-agreements="{{filteredAgreements}}" total-results="{{totalResults}}"></agreements-data>

    <h3>Showing [[visibleRange.0]] - [[visibleRange.1]] of [[totalResults]] results</h3>

    <paper-material id="listControls" elevation="1">

      <input id="query"
          type="search"
          autocomplete="off"
          value="{{q::keyup}}"
          placeholder="Search"
          on-search="_onSearch"></input>

      <paper-icon-button icon="close" on-tap="clearDropdown"></paper-icon-button>
      <paper-dropdown-menu label="Agreement Type" noink>
        <paper-menu class="dropdown-content" attr-for-selected="filter-value" selected="{{agreementType}}" on-iron-activate="_dropdownSelected">
          <!-- un-accounted for types here! -->
          <paper-item filter-value="MOU">Momarendum of Understanding</paper-item>
          <paper-item filter-value="PCA">Programme Cooperation Agreement</paper-item>
          <paper-item filter-value="SSFA">Small Scale Funding Agreement</paper-item>
        </paper-menu>
      </paper-dropdown-menu>

      <paper-icon-button icon="close" on-tap="clearDropdown"></paper-icon-button>
      <paper-dropdown-menu label="Agreement Status" noink>
        <paper-menu class="dropdown-content" attr-for-selected="text-content" selected="{{agreementStatus}}" on-iron-activate="_dropdownSelected">
          <!-- status is currently not a field on agreements -->
          <paper-item>Draft</paper-item>
          <paper-item>Active</paper-item>
          <paper-item>Suspended</paper-item>
          <paper-item>Terminated</paper-item>
        </paper-menu>
      </paper-dropdown-menu>

      <partners-data partners="{{partners}}"></partners-data>
      <etools-searchable-multiselection-menu
          label="Partner"
          options="[[uga]]"
          value="{{name}}" multi></etools-searchable-multiselection-menu>

      <paper-input label="Starts After" value="[[prettyStartDate]]" readonly>
        <etools-datepicker-button prefix date="[[_convertToDate(startDate)]]" json-date="{{startDate}}" pretty-date="{{prettyStartDate}}" no-init></etools-datepicker-button>
      </paper-input>

      <paper-input label="Ends Before" value="[[prettyEndDate]]" readonly>
        <etools-datepicker-button prefix date="[[_convertToDate(endDate)]]" json-date="{{endDate}}" pretty-date="{{prettyEndDate}}" no-init></etools-datepicker-button>
      </paper-input>

      <button type="button" name="first-page" on-tap="_firstPage"> |< </button>
      <button type="button" name="page-left" on-tap="_pageLeft"> < </button>
      <button type="button" name="page-right" on-tap="_pageRight"> > </button>
      <button type="button" name="last-page" on-tap="_lastPage"> >| </button>

      <paper-menu-button>
        <paper-item class="dropdown-trigger">[[pageSize]]</paper-item>
        <paper-menu class="dropdown-content" attr-for-selected="text-content" selected="[[pageSize]]" on-iron-activate="_pageSizeSelected">
          <paper-item>5</paper-item>
          <paper-item>10</paper-item>
          <paper-item>25</paper-item>
          <paper-item>50</paper-item>
        </paper-menu>
      </paper-menu-button>

    </paper-material>

    <paper-material id="list">

      <div class="header">
        <!-- first class of div must be name of field -->
        <div class="name flex-2"><span on-tap="_buildSortOrder">Name</span></div>
        <div class="agreement_type flex-2">Type</div>
        <div class="rating flex"><span on-tap="_buildSortOrder">Risk</span></div>
      </div>

      <template id="rows" is="dom-repeat" items="[[filteredAgreements]]" initial-count="10">
        <div id="temp">
          <p>[[item.reference_number]]</p>
          <p>___[[item.partner_name]]</p>
          <p>___[[item.agreement_type]]</p>
          <p>___[[item.start]]</p>
          <p>___[[item.end]]</p>
        </div>
      </template>

    </paper-material>

  </template>

  <script>

    var _lastNavigated = null;

    Polymer({

      is: 'agreements-list',

      behaviors: [pmpBehaviors.DropdownBehavior],

      properties: {

        uga: {
          type: Array,
          value: function() {
            return [{value: 1, label: 'nerd'}, {value: 2, label: 'gonp'}, {value: 3, label: 'geek'}, {value: 4, label: 'gook'}];
          }
        },

        filteredAgreements: {
          type: Array,
          notify: true,
          observer: '_agreementsChanged'
        },

        q: {
          type: String,
          notify: true,
          observer: '_qChanged'
        },

        agreementType: {
          type: String
        },

        startDate: {
          type: String,
          observer: '_dateChanged'
        },

        endDate: {
          type: String,
          observer: '_dateChanged'
        },

        sortOrder: {
          type: Array
        },

        pageNumber: {
          type: Number
        },

        totalPages: {
          type: Number,
          computed: '_computeTotalPages(pageSize, totalResults)',
        },

        visibleRange: {
          type: Array,
          computed: '_computeVisibleRange(pageNumber, pageSize, totalResults, totalPages)'
        },

        pageSize: {
          type: Number
        },

        debounceTime: {
          type: Number,
          value: 50
        },

      },

      observers: [
        '_updateURL(q, agreementType, startDate, endDate, pageNumber, pageSize, sortOrder)',
      ],

      ready: function() {
        this.$.list.classList.add('hidden');
      },

      // Input: URL query params
      // Initializes the properties of the list at page load
      // to the params interpretted from the URL string.
      init: function(urlParams) {
        if (!urlParams) {
          return;
        }
        this.set('q', urlParams.q ? urlParams.q : '');
        this.set('agreementType', urlParams.agreement_type ? urlParams.agreement_type : '');
        this.set('startDate', urlParams.start ? urlParams.start + 'T12:00:00' : '');
        this.set('endDate', urlParams.end ? urlParams.end + 'T12:00:00' : '');
        this.set('pageNumber', urlParams.page ? parseInt(urlParams.page) : 1);
        this.set('pageSize', urlParams.size ? parseInt(urlParams.size) : 5);
        // format of sort param is sort=field.order ex: sort=name.asc
        var result = [{field: 'id', order: 'asc'}];
        if (urlParams.sort) {
          var p = urlParams.sort.split('.');
          result = [{field: p[0], order: p[1]}];
        }
        this.set('sortOrder', result);
      },

      // Updates URL state with new query string, and launches query
      _updateURL: function() {
        var qs = this._buildQueryString();
        if (qs !== _lastNavigated) {
          _lastNavigated = qs;
          // Using replace state to change the URL here ensures the browser's
          // back button doesn't take you through every query
          var currentState = window.history.state;
          window.history.replaceState(currentState, null, 'list' + (qs.length ? '?' + qs : ''));
          // This event lets app-location and app-route know
          // the URL has changed
          window.dispatchEvent(new CustomEvent('location-changed'));

          // Query is debounced with a debounce time
          // set depending on what action the user takes
          this.debounce('query', function() {
            this.$.agreements.query(
              this.sortOrder[0].field,
              this.sortOrder[0].order,
              this.q.toLowerCase(),
              this.agreementType,
              this._addDays(this._convertToDate(this.startDate), -1),
              this.endDate,
              this.pageNumber,
              this.pageSize);
          }, this.debounceTime);

        }
      },

      // Outputs the query string for the list
      _buildQueryString: function() {
        var out = [];
        if (this.pageNumber && this.pageNumber > 1) {
          out.push('page=' + this.pageNumber);
        }
        if (this.pageSize) {
          out.push('size=' + this.pageSize);
        }
        if (this.q && this.q.length) {
          out.push('q=' + this.q);
        }
        if (this.agreementType && this.agreementType.length) {
          out.push('agreement_type=' + this.agreementType);
        }
        if (this.startDate && this.startDate.length) {
          out.push('start=' + this._shortenDate(this.startDate));
        }
        if (this.endDate && this.endDate.length) {
          out.push('end=' + this._shortenDate(this.endDate));
        }
        if (this.sortOrder && this.sortOrder.length) {
          var sortQuery = [];
          this.sortOrder.forEach(function(sort) {
            if (sort.field && sort.order) {
              sortQuery.push('' + sort.field + '.' + sort.order);
            }
          });
          out.push('sort=' + sortQuery.join('+'));
        }
        return out.join('&');
      },

      // Run when a list header is clicked
      // uses the first class of the header to determine the field name
      _buildSortOrder: function(e) {
        var _field = e.path[1].classList[0];
        var _order = 'asc';
        if (this.sortOrder[0] && this.sortOrder[0].field === _field) {
          _order = this.sortOrder[0].order === 'asc' ? 'desc' : 'asc';
        }
        this.set('debounceTime', 150);
        this.set('sortOrder', [{field: _field, order: _order}]);
      },

      _pageLeft: function() {
        this.set('debounceTime', 50);
        if (this.pageNumber > 1) {
          this.set('pageNumber', this.pageNumber - 1);
        }
      },

      _pageRight: function() {
        this.set('debounceTime', 50);
        if (this.pageNumber < this.totalPages) {
          this.set('pageNumber', this.pageNumber + 1);
        }
      },

      _firstPage: function() {
        this.set('debounceTime', 50);
        if (this.pageNumber > 1) {
          this.set('pageNumber', 1);
        }
      },

      _lastPage: function() {
        this.set('debounceTime', 50);
        if (this.pageNumber < this.totalPages) {
          this.set('pageNumber', this.totalPages);
        }
      },

      _onSearch: function() {
        this.q = this.$.query.value;
      },

      _qChanged: function(q) {
        if (q) {
          this.async(function() {
            this.$.query.focus();
          });
        }
        this.set('debounceTime', 300);
        this.set('pageNumber', 1);
      },

      _pageSizeSelected: function(e, detail) {
        this.set('debounceTime', 200);
        this.set('pageNumber', 1);
        this.set('pageSize', parseInt(detail.selected));
      },

      _dropdownSelected: function() {
        this.set('debounceTime', 200);
        this.set('pageNumber', 1);
      },

      _computeTotalPages: function(pageSize, totalResults) {
        var result = 1;
        if (pageSize < totalResults) {
          result = Math.ceil(totalResults / pageSize);
        }
        return result;
      },

      _computeVisibleRange: function(pageNumber, pageSize, totalResults, totalPages) {
        var start = 1;
        var end = totalResults;

        if (pageNumber !== 1) {
          start = (pageNumber - 1) * pageSize + 1;
        }
        if (pageNumber !== totalPages) {
          end = start + pageSize - 1;
        }

        return [start, end];
      },

      _dateChanged: function(date) {
        this.set('pageNumber', 1);
      },

      _convertToDate(date) {
        if (date && date.length) {
          return new Date(date);
        }
      },

      _shortenDate: function(date) {
        if (date && date.length) {
          return date.slice(0, date.indexOf('T'));
        }
      },

      _addDays: function(date, numDays) {
        if (date instanceof Date && date !== 'Invalid Date') {
          date.setDate(date.getDate() + numDays);
          return date;
        }
      },

      // List fade in fade out effect
      _agreementsChanged: function() {
        this.$.list.classList.add('hidden');
        this.async(function() {
          this.$.list.classList.remove('hidden');
        }, 50);
      }

    });

  </script>

</dom-module>
