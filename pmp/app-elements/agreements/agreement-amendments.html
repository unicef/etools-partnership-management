<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../../bower_components/etools-file/etools-file.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<dom-module id="agreement-amendments">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;

        --paper-fab-keyboard-focus-background: #8dc63f; /* TODO: replace with app-theme var */
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .item-actions-container .action.delete[disabled] {
        visibility: hidden;
      }

      etools-file:not([multiple]) {
        --etools-file-filename-container: {
          width: auto;
        };
        --etools-file-readonly-filename-container: {
          width: auto;
        };
      }

      .row-h.notes {
        font-style: italic;
        margin-top: 0;
      }

      .amendment-type-item + .amendment-type-item {
        margin-top: 15px;
      }

      paper-input, paper-textarea {
        width: 100%;
      }



    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="row-h item-actions-container">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled="[[!_canBeRemoved(index)]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">

            <!-- already saved amendment, readonly -->
            <template is="dom-if" if="[[!_canBeRemoved(index)]]">

              <div class="row-h">
                <div class="col col-3">
                  <!-- Signed Date -->
                  <paper-input label="Signed Date"
                               value="[[prettyDate(item.signed_date)]]"
                               readonly>
                  </paper-input>
                </div>
                <div class="col col-9">
                  <!-- Signed Amendment -->
                  <etools-file label="Signed Amendment"
                               files="[[_prepareAttachementFile(item.signed_agreement)]]"
                               readonly>
                  </etools-file>
                </div>
              </div>

              <template is="dom-repeat" items="[[item.amendment_types]]" as="amendmentType"
                        index-as="amendmentTypeIndex">

                <div class="amendment-type-item">

                  <div class="row-h">
                    <!-- Amendment Type -->
                    <paper-input label="Amendment Type"
                                 value="[[amendmentType.amendment_type]]"
                                 readonly>
                    </paper-input>
                  </div>

                  <template is="dom-if" if="[[_showNotes(amendmentType.amendment_type)]]">
                    <div class="row-h notes">
                      [[amendmentType.notes]]
                    </div>
                  </template>

                  <template is="dom-if" if="[[_showAmendmentTypeOfficer(amendmentType.amendment_type)]]">
                    <div class="row-h">
                      <!-- Officer -->
                      <paper-input label="Officer"
                                   value="[[_getOfficerName(amendmentType.officer_id)]]"
                                   readonly>
                      </paper-input>
                    </div>
                  </template>

                  <template is="dom-if" if="[[_showAmendmentTypeBankInfo(amendmentType.amendment_type)]]">
                    <div class="row-h">
                      <!-- Bank information -->
                      <paper-input label="New Bank Account"
                                   value="[[amendmentType.bank_info]]"
                                   readonly>
                      </paper-input>
                    </div>
                  </template>

                  <template is="dom-if" if="[[_showAmendmentTypeLegalNameOfIp(amendmentType.amendment_type)]]">
                    <div class="row-h">
                      <!-- Legal name of IP -->
                      <paper-input label="Full Name of Implementing Partner"
                                   value="[[amendmentType.legal_name_of_ip]]"
                                   readonly>
                      </paper-input>
                    </div>
                  </template>

                  <template is="dom-if"
                            if="[[_showAmendmentTypeExtensionProgrammeCycle(amendmentType.amendment_type)]]">
                    <div class="row-h">
                      <div class="col col-3">
                        <!-- Start Date -->
                        <paper-input label="CP Cycle Start Date"
                                     value="[[prettyDate(amendmentType.cp_cycle_start)]]"
                                     readonly>
                        </paper-input>
                      </div>
                      <div class="col col-3">
                        <!-- End Date -->
                        <paper-input label="CP Cycle End Date"
                                     value="[[prettyDate(amendmentType.cp_cycle_end)]]"
                                     readonly>
                        </paper-input>
                      </div>
                    </div>
                  </template>

                  <template is="dom-if" if="[[_showAmendmentTypeAdditionalClauses(amendmentType.amendment_type)]]">
                    <div class="row-h">
                      <!-- Additional Clauses -->
                      <paper-textarea label="Additional Clauses"
                                      value="[[amendmentType.additional_clauses]]"
                                      readonly>
                      </paper-textarea>
                    </div>
                  </template>

                  <template is="dom-if" if="[[_showAmendmentTypeExistingClauseAmended(amendmentType.amendment_type)]]">
                    <div class="row-h">
                      <!-- Change Existing Clauses -->
                      <paper-textarea label="Clause Change"
                                      value="[[amendmentType.existing_clause_amended]]"
                                      readonly>
                      </paper-textarea>
                    </div>
                  </template>

                </div>

              </template>

            </template>

            <!-- new, unsaved amendment, edit mode -->
            <template is="dom-if" if="[[!_canBeRemoved(index)]]"></template>


          </div>

        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no amendments added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewAmendment"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'agreement-amendments',

        behaviors: [
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.DateBehavior
        ],

        properties: {},

        ready: function () {
          this.dataSetModel = {
            id: null,
            signed_date: null,
            signed_agreement: null,
            amendment_types: []
          };

          this.set('_amendmentTypes', [
            'Change in Legal Name of Implementing Partner',
            'Extension of Country Programme Cycle',
            'Change Authorized Officer',
            'Banking Information',
            'Additional Clause',
            'Amend Existing Clause'
          ]);
        },

        _canBeRemoved: function (index) {
          var amendment = this.dataItems[index];
          var amendmentId = parseInt(amendment.id, 10);
          if (amendment && isNaN(amendmentId) === false && amendmentId > 0) {
            // amendment already saved (has an id assigned)
            return false;
          }
          return true
        },

        _prepareAttachementFile: function (filePath) {
          if (typeof filePath === 'string' && filePath != '') {
            return [{
              id: null,
              file_name: filePath.substr(filePath.lastIndexOf('/') + 1),
              path: filePath
            }];
          }
          return [];
        },

        _getOfficerName: function (officerId) {
          // officerId === staff member id
          // TODO: get officer date by id and return it's name
          return 'John Doe Jr.'
        },

        _showAmendmentTypeOfficer: function (amendmentTypeStr) {
          return amendmentTypeStr === 'Change Authorized Officer';
        },

        _showAmendmentTypeBankInfo: function (amendmentTypeStr) {
          return amendmentTypeStr === 'Banking Information';
        },

        _showAmendmentTypeLegalNameOfIp: function (amendmentTypeStr) {
          return amendmentTypeStr === 'Change in Legal Name of Implementing Partner';
        },

        _showAmendmentTypeExtensionProgrammeCycle: function (amendmentTypeStr) {
          return amendmentTypeStr === 'Extension of Country Programme Cycle';
        },

        _showAmendmentTypeAdditionalClauses: function (amendmentTypeStr) {
          return amendmentTypeStr === 'Additional Clause';
        },

        _showAmendmentTypeExistingClauseAmended: function (amendmentTypeStr) {
          return amendmentTypeStr === 'Amend Existing Clause';
        },

        _showNotes: function(amendmentTypeStr) {
          return !this._showAmendmentTypeAdditionalClauses(amendmentTypeStr)
              && !this._showAmendmentTypeExistingClauseAmended(amendmentTypeStr);
        }


      });
    })();
  </script>
</dom-module>
