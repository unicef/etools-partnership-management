<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">
<link rel="import" href="./agreement-behaviors/agreement-amendments-behavior.html">
<link rel="import" href="agreement-amendment-details.html">
<link rel="import" href="agreement-amendment-types.html">

<dom-module id="agreement-amendments">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles file-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;

        --paper-fab-keyboard-focus-background: #8dc63f; /* TODO: replace with app-theme var */
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .item-container {
        padding: 8px 15px;
      }

      .item-actions-container .action.delete[disabled] {
        visibility: hidden;
      }

      .item-actions-container {
        position: relative;
        padding-right: 10px;
        border-right: 2px solid #00aeef; /* TODO: replace with app-theme var */;
        margin-top: 25px;
      }

      .item-actions-container:before {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        position: absolute;
        top: -32px;
        right: -12px;
        background-color: #00aeef; /* TODO: replace with app-theme var */;
        color: #fff;
        content: attr(data-item-nr);
        text-align: center;
        font-size: 12px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        z-index: 1;
      }

      .item-actions-container.amendment-locked {
        border-right-color: var(--darker-divider-color);
      }

      .item-actions-container.amendment-locked:before {
        background-color: var(--darker-divider-color);
      }

      .item-container .item-content {
        margin-left: 0;
        border-left: none;
        padding-bottom: 25px;
      }

    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class$="row-h item-actions-container [[_getLockedClass(index)]]" data-item-nr$="[[_getItemNr(index)]]">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled="[[!_canBeRemoved(index)]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">

            <!-- already saved amendment, readonly -->
            <template is="dom-if" if="[[!_canBeRemoved(index)]]">
              <agreement-amendment-details amendment="[[item]]"></agreement-amendment-details>
            </template>

            <!-- new, unsaved amendment, edit mode -->
            <template is="dom-if" if="[[_canBeRemoved(index)]]">
              <div class="row-h">
                <div class="col col-3">
                  <paper-input-container class="form-field-wrapper basic-btn-wrapper" always-float-label>
                    <!-- Auto-generated PCA Amendment -->
                    <label aria-hidden="true">Auto-generated PCA Amendment</label>
                    <paper-button class="paper-input-input basic-btn">
                      <iron-icon icon="refresh"></iron-icon>
                      GENERATE PCA
                    </paper-button>
                  </paper-input-container>
                </div>
                <div class="col col-3">
                  <!-- Signed Date -->
                  <paper-input label="Signed Date"
                               value="[[prettyDate(item.signed_date)]]"
                               placeholder="&#8212;"
                               on-down="_openSignedDatePicker">
                    <etools-datepicker-button prefix
                                              id$="datePicker[[index]]"
                                              json-date="{{item.signed_date}}"
                                              no-init show-clear-btn></etools-datepicker-button>
                  </paper-input>
                </div>
                <div class="col col-6 file-container space-left">
                  <!-- Signed Agreement -->
                  <etools-file label="Signed Agreement"
                               accept=".doc,.docx,.pdf,.jpg,.png"></etools-file>
                </div>
              </div>

              <agreement-amendment-types data-items="{{item.amendment_types}}"
                                         partner="[[partner]]"
                                         partner-authorized-officers="[[partnerAuthorizedOfficers]]">
              </agreement-amendment-types>

            </template>

          </div>

        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no amendments added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewAmendment"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'agreement-amendments',

        behaviors: [
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.DateBehavior
        ],

        properties: {
          partner: {
            type: Object
          },
          partnerAuthorizedOfficers: {
            type: Array,
            notify: true
          }
        },

        ready: function () {
          this.dataSetModel = {
            id: null,
            signed_date: null,
            signed_agreement: null,
            amendment_types: []
          };
          this.set('editMode', true);
        },

        _canBeRemoved: function (index) {
          var amendment = this.dataItems[index];
          var amendmentId = parseInt(amendment.id, 10);
          if (amendment && isNaN(amendmentId) === false && amendmentId > 0) {
            // amendment already saved (has an id assigned)
            return false;
          }
          return true
        },

        _getLockedClass: function (index) {
          if (!this._canBeRemoved(index)) {
            return 'amendment-locked';
          }
          return '';
        },

        _getItemNr: function (index) {
          return parseInt(index, 10) + 1;
        },

        _openSignedDatePicker: function (event) {
          this.$$('#datePicker' + event.model.index).open = true;
        },

        _addNewAmendment: function () {
          var lastAmendmentItem = this.dataItems[this.dataItems.length - 1];
//          if (lastAmendmentItem.signed_date !== null) {
//            this.fire('toast', {text: 'Last amendment fields are empty!', showCloseBtn: false});
//          } else {
          this._addElement();
//          }
        },


      });
    })();
  </script>
</dom-module>
