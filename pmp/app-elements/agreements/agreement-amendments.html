<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">

<link rel="import" href="../../../scripts/lodash/lodash.html">

<link rel="import" href="../common-elements/etools-single-file.html">
<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../common-elements/etools-form-element-wrapper.html">

<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/file-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">

<link rel="import" href="../validators/required-and-not-future-date-validator.html">

<dom-module id="agreement-amendments">
  <template strip-whitespace>
    <style
        include="grid-layout-styles shared-styles repeatable-data-sets-styles repeatable-data-sets-styles-v2 file-styles buttons-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;

        --paper-fab-keyboard-focus-background: var(--add-button-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .file-wrapper {
        width: 100%;
        max-width: 100%;
      }

      #amendments-wrapper {
        margin-top: 16px;
      }
      :host(:not([edit-mode])) #amendments-wrapper {
        margin-bottom: 24px;
      }

      /* amendment template download section styles start */
      #download-template-wrapper {
        @apply(--layout-justified);
      }
      #download-template-msg {
        max-width: calc(100% - 210px);
      }
      #download-template-btn {
        max-width: 220px;
        margin: 0 0 0 24px;
        padding: 0;
      }
      #download-template-a {
        display: inherit;
      }
      /* amendment template download section styles end */
    </style>

    <!-- include required and not future date validator -->
    <required-and-not-future-date-validator></required-and-not-future-date-validator>

    <div id="download-template-wrapper" class="row-h flex-c row-second-bg b-border">
      <!-- Amendments template download -->
      <div id="download-template-msg">
        Use the amendment template for documenting changes and signing.
      </div>
      <!-- Download template btn -->
      <a id="download-template-a" target="_blank" href="/static/agreements/amendment_template.docx">
        <paper-button id="download-template-btn" class="secondary-btn">
          <iron-icon icon="cloud-download"></iron-icon>
          Download template
        </paper-button>
      </a>
    </div>

    <div id="amendments-wrapper" hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class$="item-actions-container [[_getLockedClass(item.id)]]" data-item-nr$="[[_getItemNr(index)]]">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="item-content">

            <div class="row-h flex-c">
              <div class="col col-4">
                <!-- Signed Date -->
                <etools-date-input id$="signedDate_[[index]]"
                                   label="Signed Date"
                                   value="{{item.signed_date}}"
                                   error-message="Please select signed date"
                                   no-init show-clear-btn
                                   readonly$="[[_showReadonlyDetails(item.id)]]"
                                   validator="required-and-not-future-date-validator"
                                   auto-validate$="[[!_showReadonlyDetails(item.id)]]"
                                   error-message$="[[_getSignedDateErrorMessage(item.signed_date)]]">
                </etools-date-input>
              </div>
              <div class="col col-8 file-container">
                <!-- Signed Agreement -->
                <div class="file-wrapper">
                  <etools-single-file id$="fileUpload_[[index]]"
                                      label="Signed Amendment"
                                      file="{{item.signed_amendment}}"
                                      internal-file="{{item.signed_amendment_file}}"
                                      error-message="Signed Amendment file is required"
                                      required
                                      auto-validate
                                      accept=".doc,.docx,.pdf,.jpg,.png"
                                      readonly$="[[_showReadonlyDetails(item.id)]]"></etools-single-file>
                </div>
              </div>
            </div>
            <div class="row-h flex-c">
              <template is="dom-if" if="[[!_showReadonlyDetails(item.id)]]">
                <etools-multi-selection-menu id$="amendmentTypes_[[index]]"
                                             label="Amendment Types"
                                             placeholder="&#8212;"
                                             trigger-value-change-event$="[[!_showReadonlyDetails(item.id)]]"
                                             options="[[_getAmendmentTypes(agreementType, _amendmentTypes)]]"
                                             selected-values="{{item.types}}"
                                             hide-search
                                             error-message="Please select amendment type"
                                             required
                                             on-etools-selected-items-changed="_onAmendmentTypesSelected"
                                             on-focused-changed="_onAmendmentTypesFocusChanged">
                </etools-multi-selection-menu>
              </template>
              <template is="dom-if" if="[[_showReadonlyDetails(item.id)]]">
                <!-- readonly amendment types -->
                <etools-form-element-wrapper label="Amendment Types">
                  <span class="placeholder" hidden$="[[item.types.length]]">&#8212;</span>
                  <span hidden$="[[!item.types.length]]">
                    [[_getReadonlyAmendmentTypes(item.types)]]
                  </span>
                </etools-form-element-wrapper>
              </template>

            </div>


          </div>

        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no amendments added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewAmendment"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'agreement-amendments',

        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
          EtoolsPmpApp.Behaviors.RepeatableDataSets
        ],

        properties: {
          _deleteEpName: {
            type: String,
            value: 'agreementAmendmentsDelete',
            readOnly: true,
          },
          agreementType: {
            type: String,
            value: ''
          },
          _amendmentTypes: {
            type: Array,
            statePath: 'agreementAmendmentTypes'
          }
        },

        observers: [
          '_dataItemsChanged(dataItems.length)',
        ],

        ready: function() {
          this.dataSetModel = {
            id: null,
            signed_date: null,
            signed_amendment: null,
            types: []
          };
        },
        _getAmendmentTypes: function(agreementType, _amendmentTypes) {
          if (['PCA', 'SSFA'].indexOf(agreementType) === -1 ||
              !(_amendmentTypes instanceof Array && _amendmentTypes.length > 0)) {
            return [];
          }
          if (agreementType === 'SSFA') {
            return _amendmentTypes.filter(function(type) {
              return type.value === 'Change authorized officer';
            });
          }
          return _amendmentTypes;
        },
        validate: function() {
          if (!this.dataItems) {
            return true;
          }
          var isValid = true;
          this.dataItems.forEach(function(amendm, index) {
            if (amendm.id) {
              return;
            }
            let signedDateEl = this.$$('#signedDate_' + index);
            if (signedDateEl) {
              signedDateEl.errorMessage = this._getSignedDateErrorMessage(amendm.signed_date);
              if (!signedDateEl.validate()) {
                isValid = false;
              }
            }
            if (!amendm.signed_amendment) {
              this.$$('#fileUpload_' + index).invalid = true;
              isValid = false;
            }
            let amendmentTypes = this.$$('#amendmentTypes_' + index);
            if (amendmentTypes && !amendmentTypes.validate()) {
              isValid = false;
            }
          }.bind(this));
          return isValid;
        },

        _signedDateIsInTheFuture: function(signedDate) {
          var signedDt = Date.parse(signedDate);
          if (signedDt) {
            return signedDt > Date.now();
          }
          return false;
        },

        /**
         * If the amendment can be removed, the left border and top badge needs to have a different style.
         * This class will help with that.
         */
        _getLockedClass: function(amendmentId) {
          if (this._showReadonlyDetails(amendmentId)) {
            return 'locked';
          }
          return '';
        },

        _showReadonlyDetails: function(amendmentId) {
          if (parseInt(amendmentId, 10) > 0) {
            return true;
          }
          return false;
        },

        _getItemNr: function(index) {
          return parseInt(index, 10) + 1;
        },

        /**
         * Check if amendment fields are empty
         */
        _amendmentFieldsAreEmpty: function(amendmentItem, index) {
          return (amendmentItem.signed_date === null || amendmentItem.signed_date === '')
              && !amendmentItem.signed_amendment &&
              ((amendmentItem.types instanceof Array && amendmentItem.types.length === 0) ||
              !amendmentItem.types);
        },

        /**
         * Validate last added amendment and if is not empty add a new one
         */
        _addNewAmendment: function() {
          var lastAmendmentItemIndex = this.dataItems.length - 1;
          if (lastAmendmentItemIndex > 0 && this.dataItems[lastAmendmentItemIndex] &&
              !this._showReadonlyDetails(this.dataItems[lastAmendmentItemIndex].id)) {
            var lastAmendmentItem = this.dataItems[lastAmendmentItemIndex];
            if (this._amendmentFieldsAreEmpty(lastAmendmentItem, lastAmendmentItemIndex)) {
              this.fire('toast', {text: 'Last amendment fields are empty!', showCloseBtn: true});
            } else {
              this._addElement();
            }
          } else {
            this._addElement();
          }
        },

        _dataItemsChanged: function(dataLength) {
          let self = this;
           this.debounce('itemsChangeDebouncer', function() {
             // check for 'Change authorized officer' when amendments length changes
             self._handleNoChangeAuthorizedOfficersTypeInAmendments();
           }, 10);
        },

        // types array contains 'Change authorized officer'
        _changeAuthorizedOfficersTypeSelected: function(amendmentTypes) {
          if (!(amendmentTypes instanceof Array && amendmentTypes.length > 0)) {
            return false;
          }
          return amendmentTypes.indexOf('Change authorized officer') > -1;
        },

        // unlock authorized officers field from agreement details
        _triggerAuthorizedOfficersUnlock: function() {
          this.fire('unlock-authorized-officers');
        },
        // lock authorized officers field from agreement details
        _triggerAuthorizedOfficersLock: function() {
          this.fire('lock-authorized-officers');
        },

        _newAmendmentsHaveChangeAuthOfficersSelected: function() {
          let self = this;
          let changeAuthOfficersTypeSelected = this.dataItems.find(function(amendment) {
            return !amendment.id && self._changeAuthorizedOfficersTypeSelected(amendment.types);
          });

          return !!changeAuthOfficersTypeSelected;
        },
        _handleNoChangeAuthorizedOfficersTypeInAmendments: function() {
          if (!this._newAmendmentsHaveChangeAuthOfficersSelected()) {
            // lock authorized officers
            this._triggerAuthorizedOfficersLock();
          }
        },
        _getSignedDateErrorMessage: function(signedDate) {
          return this._signedDateIsInTheFuture(signedDate)
              ? 'Signed Date can not be in the future'
              : 'Please select Signed Date';
        },

        _onAmendmentTypesSelected: function(e) {
          e.stopImmediatePropagation();
          if (!_.isEmpty(this.dataItems) && this.dataItems[e.model.index] &&
              this._changeAuthorizedOfficersTypeSelected(this.dataItems[e.model.index].types)) {
            // unlock authorized officers
            this._triggerAuthorizedOfficersUnlock();
          } else {
            this._handleNoChangeAuthorizedOfficersTypeInAmendments();
          }
        },

        // set autoValidate to true on first focus
        // TODO: revise auto validate behavior, this could be made global using a behavior
        _onAmendmentTypesFocusChanged: function(e) {
          let target = e.target;
          this.debounce('dropdown-focus', function() {
            if (e.detail && e.detail.value) {
              if (target.is && target.is === 'etools-multi-selection-menu' &&
                  !target.autoValidate) {
                target.set('autoValidate', true);
              }
            }
          }, 10);
        },

        _getReadonlyAmendmentTypes: function(types) {
          if (types instanceof Array && types.length > 0) {
            // search for item amendments types
            let amTypes = this._amendmentTypes.filter(function(t) {
              return types.indexOf(t.value) > -1;
            });
            if (amTypes.length) {
              // map to get the labels
              let amTypesFiltered = amTypes.map(function(t) {
                return t.label;
              });
              return amTypesFiltered.join(' | ');
            }
          }
          return null;
        }

      });
    })();
  </script>
</dom-module>
