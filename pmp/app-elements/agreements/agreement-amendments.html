<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../common-elements/etools-single-file.html">
<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/file-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="./agreement-behaviors/agreement-amendments-behavior.html">
<link rel="import" href="./agreement-behaviors/agreements-common-behavior.html">
<link rel="import" href="agreement-amendment-details.html">
<link rel="import" href="agreement-amendment-types.html">

<dom-module id="agreement-amendments">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles repeatable-data-sets-styles-v2 file-styles buttons-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;

        --paper-fab-keyboard-focus-background: var(--add-button-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .file-wrapper {
        width: 450px;
        max-width: 100%;
      }

    </style>
    <etools-ajax id="deleteAjax"
                 on-success="_handleDeleteResponse"
                 on-fail="_handleDeleteError"></etools-ajax>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class$="row-h item-actions-container [[_getLockedClass(item.id)]]" data-item-nr$="[[_getItemNr(index)]]">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"></paper-icon-button>
                                 <!-- TODO: can we delete any amendment any time?
                                 disabled="[[!_canBeRemoved(index, editMode)]]" -->
            </div>
          </div>
          <div class="row-v flex-c item-content">

            <!-- already saved amendment, readonly -->
            <template is="dom-if" if="[[_showReadonlyDetails(item.id)]]">
              <agreement-amendment-details amendment="[[item]]"
                staff-members="[[staffMembers]]"></agreement-amendment-details>
            </template>

            <!-- new, unsaved amendment, edit mode -->
            <template is="dom-if" if="[[!_showReadonlyDetails(item.id)]]">
              <div class="row-h">

                <!-- Uncomment this block once PCA agreement generation is ready on backend side -->

                <!--<div class="col col-3" hidden$="[[_hideGenerateBtn(item.signed_amendment)]]">-->
                  <!--<paper-input-container class="form-field-wrapper secondary-btn-wrapper" always-float-label>-->
                    <!--&lt;!&ndash; Auto-generated PCA Amendment &ndash;&gt;-->
                    <!--<label aria-hidden="true">Auto-generated PCA Amendment</label>-->
                    <!--<paper-button class="paper-input-input secondary-btn">-->
                      <!--<iron-icon icon="refresh"></iron-icon>-->
                      <!--GENERATE PCA-->
                    <!--</paper-button>-->
                  <!--</paper-input-container>-->
                <!--</div>-->
                <div class="col col-4">
                  <!-- Signed Date -->
                  <etools-date-input id$="signedDate_[[index]]"
                                     label="Signed Date"
                                     value="{{item.signed_date}}"
                                     error-message="Please select signed date"
                                     no-init show-clear-btn>
                  </etools-date-input>
                </div>
                <div class="col col-8 file-container">
                  <!-- Signed Agreement -->
                  <div class="file-wrapper">
                    <etools-single-file id$="fileUpload_[[index]]" label="Signed Amendment"
                               file="{{item.signed_amendment}}"
                               internal-file="{{item.signed_amendment_file}}"
                               error-message="Signed Amendment file is required"
                               accept=".doc,.docx,.pdf,.jpg,.png"></etools-single-file>
                  </div>
                </div>
              </div>

              <agreement-amendment-types id$="amendmentTypes_[[index]]"
                                         data-items="{{item.amendment_types}}"
                                         partner-name="[[partnerName]]"
                                         partner-authorized-officers="[[partnerAuthorizedOfficers]]"
                                         on-amendment-selected="_amendmentTypeSelected">
              </agreement-amendment-types>

            </template>

          </div>

        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no amendments added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewAmendment"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'agreement-amendments',

        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.AgreementsCommonBehavior
        ],

        properties: {
          _deleteEpName: {
            type: String,
            value: 'agreementAmendmentsDelete',
            readOnly: true,
          },
          partnerName: {
            type: String
          },
          partnerAuthorizedOfficers: {
            type: Array,
            notify: true
          },
          staffMembers: Array
        },

        observers: [
          '_dataItemsChanged(dataItems.*)',
          ],

        ready: function() {
          this.dataSetModel = {
            id: null,
            signed_date: null,
            signed_agreement: [],
            amendment_types: [{ //TODO - how to not duplicate model here and in agreement-amendment-types.html?
              id: null,
              type: null,
              officer: null,
              bank_info: null,
              legal_name_of_ip: null,
              cp_cycle_end: null,
              additional_clauses: null,
              existing_clause_amended: null
           }]
          };
        },
        validate: function() {
          if (!this.dataItems) {
            return true;
          }
          var isValid = true;
          this.dataItems.forEach(function (amendm, index) {
              if (amendm.id) {
                 return;
              }
              if (!amendm.signed_date) {
                 this.$$('#signedDate_' + index).invalid = true;
                 isValid = false;
              } else if (this._signedDateIsInTheFuture(amendm.signed_date)) {
                 this.$$('#signedDate_' + index).errorMessage = "Signed Date can not be in the future";
                 this.$$('#signedDate_' + index).invalid = true;
                 isValid = false;
              }
              if (!amendm.signed_amendment) {
                 this.$$('#fileUpload_' + index).invalid = true;
                 isValid = false;
              }

              var amendmTypesEl =  this.$$('#amendmentTypes_' + index);
              if (!this._validateAmendmentTypes(amendm, amendmTypesEl)) {
                isValid = false;
              }

           }.bind(this));

           return isValid;
        },
        _validateAmendmentTypes: function(amendment, amendmentTypesEl) {
          var isValid = true;
          amendment.amendment_types.forEach(function(amendmType, index) {
            if (!amendmType.type) {
              isValid = false;
              amendmentTypesEl._invalidAmendmentTypeField(true, "#amendmentType_" + index);
            }
          });
          return isValid;
        },
        _signedDateIsInTheFuture: function(signed_date) {
          var signed_dt = Date.parse(signed_date)
          if (signed_dt) {
            return signed_dt > Date.now();
          }
          return false;
        },
        /**
         * The amendment can be removed only if it doesn't have and id assigned(only if is not saved)
         */
        // TODO: this might not be needed; clarify when agreement amendments can be removed !!!
        // _canBeRemoved: function(index, editMode) {
        //   if (!editMode) {
        //     return false;
        //   }
        //   var amendment = this.dataItems[index];
        //   var amendmentId = parseInt(amendment.id, 10);
        //   if (amendment && isNaN(amendmentId) === false && amendmentId > 0 && amendment.signed_amendment) {
        //     // amendment already saved (has an id assigned)
        //     return false;
        //   }
        //   return true;
        // },

        /**
         * If the amendment can be removed, the left border and top badge needs to have a different style.
         * This class will help with that.
         */
        _getLockedClass: function(amendmentId) {
          if (this._showReadonlyDetails(amendmentId)) {
            return 'locked';
          }
          return '';
        },

        _showReadonlyDetails: function(amendmentId) {
          if (parseInt(amendmentId, 10) > 0) {
            return true;
          }
          return false;
        },

        _getItemNr: function(index) {
          return parseInt(index, 10) + 1;
        },

        /**
         * Check if amendment fields are empty
         */
        _amendmentFieldsAreEmpty: function(amendmentItem, index) {
          return (amendmentItem.signed_date === null || amendmentItem.signed_date === '')
              && (amendmentItem.signed_agreement)
              && (amendmentItem.amendment_types.length === 0
              || (amendmentItem.amendment_types.length > 0
              && this._hasAmendmentTypesSelected(index) === false));
        },

        /**
         * Validate last added amendment and if is not empty add a new one
         */
        _addNewAmendment: function() {
          var lastAmendmentItemIndex = this.dataItems.length - 1;
          if (lastAmendmentItemIndex > 0 && this.dataItems[lastAmendmentItemIndex] &&
              !this._showReadonlyDetails(this.dataItems[lastAmendmentItemIndex].id)) {
            var lastAmendmentItem = this.dataItems[lastAmendmentItemIndex];
            if (this._amendmentFieldsAreEmpty(lastAmendmentItem, lastAmendmentItemIndex)) {
              this.fire('toast', {text: 'Last amendment fields are empty!', showCloseBtn: true});
            } else {
              this._addElement();
            }
          } else {
            this._addElement();
          }
        },

        /**
         * Check if amendment signed date is required
         */
        _requireSignedDate: function(signedAmendment, date, index) {
          if (signedAmendment || this._hasAmendmentTypesSelected(index)) {
            if (date === null || date === '') {
              return true;
            }
          }
          return false;
        },

        /**
         *  TODO: to be revised
         *  uncomment when PCA Amendment generation will be available
         */
        /* _hideGenerateBtn: function(signedAmendment) {
          if (signedAmendment) {
            return true;
          }
          return false;
        }, */

        /**
         * Check if amendment has at least an amendment type selected
         */
        _hasAmendmentTypesSelected: function(index) {
          var amendmentItem = this.dataItems[index];
          if (amendmentItem && amendmentItem.amendment_types.length > 0) {
            var atLeastOneIsSelected = false;
            for (var i = 0; i <= amendmentItem.amendment_types.length - 1; i++) {
              if (amendmentItem.amendment_types[i].amendment_type !== null
                  && amendmentItem.amendment_types[i].amendment_type !== '') {
                atLeastOneIsSelected = true;
                break;
              }
            }
            return atLeastOneIsSelected;
          }
          return false;
        },

        /**
         * Validate signed date if an amendment type is selected
         */
        _amendmentTypeSelected: function(event) {
          var amendmentIndex = event.model.index;
          var amendment = this.dataItems[amendmentIndex];
          this.$$('#signedDate_' + amendmentIndex).invalid = this._requireSignedDate(amendment.signed_amendment,
              amendment.signed_date, amendmentIndex);
        },

        _dataItemsChanged: function(data) {
          var path = data.path.slice(data.path.lastIndexOf('.') + 1);
          var ind = data.path.slice(data.path.indexOf('#') + 1);
          var index = ind.slice(0, ind.indexOf('.'));
          if (path === 'signed_date') {
            // reset invalid state is field is not empty
            var signedDateEl = this.$$('#signedDate_' + index);
            if (signedDateEl && typeof data.value === 'string' && data.value !== '') {
                if (this._signedDateIsInTheFuture(data.value)) {
                   signedDateEl.errorMessage = "Signed Date can not be in the future";
                   signedDateEl.invalid = true;
                } else {
                  signedDateEl.invalid = false;
                  signedDateEl.errorMessage = "Please select signed date";
                }
              } else {
                  signedDateEl.invalid = true;
                  signedDateEl.errorMessage = "Please select signed date";
              }
          }
          if (path === 'signed_amendment') {
            var uploadFileEl = this.$$('#fileUpload_' + index);
            if (uploadFileEl && data.value) {
              if (data.value instanceof File) {
                uploadFileEl.invalid = false;
              }
            } else {
                uploadFileEl.invalid = true;
            }
          }
        }
      });
    })();
  </script>
</dom-module>
