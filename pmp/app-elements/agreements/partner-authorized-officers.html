<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">

<dom-module id="partner-authorized-officers">
  <template>
    <style include="grid-layout-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
      }
      paper-input {
        --paper-input-container-underline: {
          display: none;
        };
        --paper-input-container-underline-focus: {
          display: none;
        }	;
        --paper-input-container-underline-disabled: {
          display: none;
        };
      }
      .officer {
        padding-top: 15px;
        padding-bottom: 15px;
      }
      .row-h + .row-h {
        margin-top: 0;
      }
      .item-wrapper {
        margin-left: 63px;
        padding-left: 25px;
        border-left: 1px solid var(--darker-divider-color);
      }
    </style>
    <template is="dom-if" if="[[editMode]]">
      <div class="row-h flex-c">
        <etools-searchable-multiselection-menu id="officers"
                                               label="Officers"
                                               placeholder="Select authorized officers"
                                               options="[[officersDropdownData]]"
                                               custom-object-options
                                               option-value="id"
                                               option-label="name"
                                               value="[[_selectedDropdownOfficers]]"
                                               on-value-change="_officersSelected"
                                               error-message="Please select authorized officers"
                                               auto-validate$="[[_autoValidateIsOn(editMode, required)]]"
                                               required$="[[_autoValidateIsOn(editMode, required)]]"
                                               readonly$="[[!editMode]]"
                                               dynamic-align
                                               multi>
        </etools-searchable-multiselection-menu>
      </div>
    </template>

    <template is="dom-if" if="[[!editMode]]">
      <template is="dom-repeat" items="[[selectedOfficers]]">
        <div class="row-h flex-c officer">
          <div class="item-wrapper">
            <paper-input label="Officer" value="[[_computeName(item)]]" readonly></paper-input>
          </div>
        </div>
      </template>

      <div class="row-h flex-c" hidden$="[[!_noOfficersSelected(selectedOfficers.length)]]">
        <p>There are no partner authorized officers selected</p>
      </div>
    </template>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'partner-authorized-officers',

        properties: {
          selectedOfficers: {
            type: Array,
            value: [],
            notify: true,
            observer: '_selectedOfficersChanged'
          },

          officersDropdownData: {
            type: Array,
            value: [],
            observer: '_dropdownOptionsChanged'
          },

          editMode: {
            type: Boolean,
            value: false
          },

          required: {
            type: Boolean,
            value: false
          },

          _selectedOfficersValuesAlreadyInit: {
            type: Boolean,
            value: false
          },

          _selectedDropdownOfficers: {
            type: Array,
            value: []
          }
        },

        _selectedOfficersChanged: function(selectedOfficers) {
          if (!this.editMode) {
            return;
          }
          if (!this._selectedOfficersValuesAlreadyInit) {
            this._initSelectedOfficers(selectedOfficers);
          }
        },

        _initSelectedOfficers: function(selectedOfficers) {
          if (Array.isArray(selectedOfficers) && selectedOfficers.length > 0) {
            var selected = selectedOfficers.map(function(officer) {
              return {
                id: officer.id,
                name: this._computeName(officer)
              };
            }.bind(this));
            this.set('_selectedDropdownOfficers', selected);
            this._selectedOfficersValuesAlreadyInit = true;
          } else {
            this.set('_selectedDropdownOfficers', []);
          }
        },

        _dropdownOptionsChanged: function(newOptions) {
          if (!this.editMode) {
            return;
          }
          if (this._selectedOfficersValuesAlreadyInit) {
            if (Array.isArray(newOptions) && newOptions.length > 0) {
              this.resetSelection();
              this._updateInvalidState(false);
            }
          }
        },

        resetSelection: function() {
          this._selectedOfficersValuesAlreadyInit = false;
          this._initSelectedOfficers(this.selectedOfficers);
        },

        _officersSelected: function(event) {
          var selectedOfficersData = event.detail.selectedValues;
          if (selectedOfficersData !== null) {
            var officersSelectedIds = selectedOfficersData.map(function(selectedOfficer) {
              return selectedOfficer.id;
            });
            var selected = this.officersDropdownData.filter(function(officer) {
              return officersSelectedIds.indexOf(officer.id) > -1;
            });
            this.set('selectedOfficers', selected);
          } else {
            this.set('selectedOfficers', []);
          }
          this.validateOfficersSelection();
        },

        validateOfficersSelection: function() {
          if (this.selectedOfficers.length === 0 && this.required) {
            this._updateInvalidState(true);
            return false;
          }
          this._updateInvalidState(false);
          return true;
        },

        _autoValidateIsOn: function(editMode, required) {
          if (editMode && required) {
            return true;
          }
          return false;
        },

        _noOfficersSelected: function(selectedLength) {
          return selectedLength === 0;
        },

        _updateInvalidState: function(value) {
          this.async(function() {
            var dropdown = this.$$('#officers');
            if (dropdown) {
              dropdown.invalid = value;
            }
          });
        },

        _computeName: function(officer) {
          if (officer && officer.name) {
            return officer.name;
          }
          return officer.first_name + ' ' + officer.last_name;
        }

      });
    })();
  </script>
</dom-module>
