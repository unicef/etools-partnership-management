<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">

<link rel="import" href="../../../app-behaviors/data-element-behavior.html">

<dom-module id="user-profile-data">

  <template>

    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 on-success="_handleResponse"
                 on-fail="_handleErrorResponse"></etools-ajax>
  </template>

  <script>
    Polymer({
      is: 'user-profile-data',
      behaviors: [
          pmpBehaviors.DataElementBehavior,
          etoolsAppConfig.globals
      ],
      properties: {
        endpointName: {
          type: String,
          value: 'myProfile'
        },
        userProfile: {
          type: Object,
          notify: true
        }
      },
      saveProfile: function(profile) {
        var url = this.endpoint.url;
        if (_.isEmpty(profile)) {
            return;
        }
        if (!_.isEmpty(profile)) {
          this.fire('hacky-global-loading', {message: 'Saving profile data...', active: true});
          this._prepareAndFireRequest('PATCH', profile, url);
        } else {
          this.fire('toast', {
            text: 'There is nothing to save. No change detected on your profile.',
            showCloseBtn: true
          });
        }
      },
      _prepareAndFireRequest: function(method, data, url) {
        this._resetAjax();
        if (!method) {
          method = 'GET';
        }
        this.$.ajax.set('method', method);
        if (typeof data === 'object' && Object.keys(data).length > 0
            && ['PATCH', 'POST'].indexOf(method) > -1) {
          this.$.ajax.set('body', data);
          this.$.ajax.set('url', url);
        }
      },
      _resetAjax: function() {
        this.$.ajax.set('params', null);
        this.$.ajax.set('body', null);
        this.$.ajax.set('url', null);
      },
      _handleResponse: function(response) {
        this.set('userProfile', response.detail);
        this.fire('hacky-global-loading', {active: false});
      },
      _handleErrorResponse: function(response) {
        this.fire('hacky-global-loading', {active: false});
        var errors = response.detail.request.detail.request.response;
        if (this.ajaxEl.method === 'POST' || this.ajaxEl.method === 'PATCH') {
          // TODO: improve etools-ajax on-fail event data model (received errors)
          var errorMessage = 'An error occurred during save!';
          if (errors) {
            var errorMessages = ['Errors occurred:\n'];
            if (Array.isArray(errors) && errors.length > 0) {
              errors.forEach(function(err) {
                errorMessages.push(err + '\n');
              });
            } else if (typeof errors === 'object' && Object.keys(errors).length > 0) {
              for (var errField in errors) {
                if (typeof errors[errField] === 'string') {
                  errorMessages.push('Field ' + errField + ' - ' + errors[errField] + '\n');
                } else if (typeof errors[errField] === 'object' && Object.keys(errors[errField]).length > 0) {
                  for (var errF in errors[errField]) {
                    errorMessages.push('Field ' + errField + '(' + errF + ') - ' + errors[errField][errF] + '\n');
                  }
                } else if (Array.isArray(errors[errField]) && errors[errField].length > 0) {
                  for (var key in errors[errField]) {
                    errorMessages.push(errors[errField][key] + '\n');
                  }
                }
              }
            }
            if (errorMessages.length > 1) {
              errorMessage = errorMessages.join('');
            }
          }
          this.fire('toast', {text: errorMessage, showCloseBtn: true});
        }
      },
    });

  </script>

</dom-module>
