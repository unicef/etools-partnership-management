<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">

<dom-module id="user-profile-data">

  <script>
    Polymer({
      is: 'user-profile-data',
      behaviors: [
        EtoolsLogsBehavior,
        EtoolsAjaxRequestBehavior,
        EtoolsPmpApp.Behaviors.Endpoints,
        EtoolsPmpApp.Behaviors.AjaxServerErrors
      ],
      properties: {
        endpoint: {
          type: String
        },
        userProfile: {
          type: Object,
          notify: true
        },
        _saveActionInProgress: Boolean,
        ajaxLoadingMsgSource: {
          type: String,
          value: 'profile-modal'
        }
      },

      ready: function() {
        this.set('endpoint', this.getEndpoint('myProfile'));
        this._makeProfileRequest();
      },

      _makeProfileRequest: function(additionalConfig) {
        let self = this;
        let config = {
          endpoint: this.endpoint
        };
        additionalConfig = additionalConfig || {};

        this.sendRequest(Object.assign({}, config, additionalConfig)).then(function(resp) {
          self._handleResponse(resp);
        }).catch(function(error) {
          // TODO: refactor ajax error handler, error response has changed
          self.handleErrorResponse(error.response);
        });
      },

      saveProfile: function(profile) {
        if (_.isEmpty(profile)) {
          return;
        }
        if (!_.isEmpty(profile)) {
          this.fire('global-loading', {
            message: 'Saving profile data...',
            active: true,
            loadingSource: this.ajaxLoadingMsgSource
          });
          this.set('_saveActionInProgress', true);
          this._makeProfileRequest({method: 'PATCH', body: profile});
        } else {
          // TODO: this ain't right, each profile property value should be checked for changes,
          // if no changes found, then fire this toast
          this.fire('toast', {
            text: 'There is nothing to save. No change detected on your profile.',
            showCloseBtn: true
          });
        }
      },

      _handleResponse: function(response) {
        this.set('userProfile', response);
        if (this._saveActionInProgress) {
          this.fire('global-loading', {active: false, loadingSource: this.ajaxLoadingMsgSource});
          this.set('_saveActionInProgress', false);
        }
      }
    });

  </script>

</dom-module>
