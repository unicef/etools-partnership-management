<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/etools-loading/etools-loading.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">"

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="user-profile-data/user-profile-data.html">

<dom-module id="user-profile-dialog">
  <template>
    <style include="shared-styles grid-layout-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        --etools-checkable-input-label: {
          font-size: 14px;
        };
      }

      etools-checkable-input:not(:last-of-type) {
        margin-right: 30px;
      }

      paper-input,
      paper-textarea,
      paper-material {
        width: 100%;
      }

      paper-material {
        padding: 0;
      }

      paper-material paper-toolbar {
        --paper-toolbar-height: 40px;
        --paper-toolbar-background: var(--medium-theme-background-color);
        --paper-toolbar: {
          -webkit-border-radius: 8px;
          -moz-border-radius: 8px;
          border-radius: 8px;
        };
        --paper-toolbar-title: {
          @apply(--nested-content-panel-title);
          margin-left: 0;
        };
      }

      #profile-content {
        max-height: 600px;
        overflow-y: auto;
        margin: 0 -20px;
        padding: 0 15px;
      }

    </style>

    <etools-dialog id="userProfileDialog" size="lg" ok-btn-text="Save" dialog-title="My Profile"
                   on-close="_closeUserProfileDialog">
      <div id="profile-content">
        <div class="row-h flex-c">
          <div class="col col-6">
            <etools-searchable-multiselection-menu id="office"
                                                   label="Office"
                                                   placeholder="&#8212;"
                                                   selected="{{profile.office}}"
                                                   options="[[allOffices]]"
                                                   no-change-event
                                                   update-selected
                                                   auto-validate
                                                   error-message="Please select an office">
            </etools-searchable-multiselection-menu>
          </div>
          <div class="col col-6">
            <etools-searchable-multiselection-menu id="section"
                                                   label="Section"
                                                   placeholder="&#8212;"
                                                   selected="{{profile.section}}"
                                                   options="[[allSections]]"
                                                   update-selected
                                                   auto-validate
                                                   error-message="Please select a section">
            </etools-searchable-multiselection-menu>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <paper-input label="Job title" value="{{profile.job_title}}" placeholder="&#8212;"></paper-input>
          </div>
          <div class="col col-6">
            <paper-input label="Phone number" value="{{profile.phone_number}}" placeholder="&#8212;"></paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <paper-input id="supervisor"
                         label="My supervisor"
                         placeholder="&#8212;"
                         value="[[profile.supervisor]]"
                         readonly>
            </paper-input>
          </div>
          <div class="col col-6">
            <etools-searchable-multiselection-menu id="oic"
                                                   label="My OIC"
                                                   placeholder="&#8212;"
                                                   selected="{{profile.oic}}"
                                                   options="[[allUsers]]"
                                                   update-selected
                                                   no-change-event
                                                   auto-validate
                                                   error-message="Please select an OIC">
            </etools-searchable-multiselection-menu>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-12">
            <etools-searchable-multiselection-menu id="workspaces"
                                                   label="Available workspaces"
                                                   placeholder="&#8212;"
                                                   selected="[[availableCountryIds]]"
                                                   options="[[profile.countries_available]]"
                                                   custom-object-options
                                                   update-selected
                                                   option-value="id"
                                                   option-label="name"
                                                   no-change-event
                                                   multi
                                                   readonly>
            </etools-searchable-multiselection-menu>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-12">
            <etools-searchable-multiselection-menu id="groups"
                                                   label="My Groups"
                                                   placeholder="&#8212;"
                                                   selected="[[availableGroups]]"
                                                   options="[[profile.groups]]"
                                                   custom-object-options
                                                   update-selected
                                                   option-value="id"
                                                   option-label="name"
                                                   no-change-event
                                                   multi
                                                   readonly>
            </etools-searchable-multiselection-menu>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-12">
            <etools-searchable-multiselection-menu id="supervisees"
                                                   label="My supervisees"
                                                   placeholder="&#8212;"
                                                   selected="[[profile.supervisees]]"
                                                   options="[[allUsers]]"
                                                   custom-object-options
                                                   update-selected
                                                   multi
                                                   readonly>
            </etools-searchable-multiselection-menu>
          </div>
        </div>
      </div>
      <etools-loading id="profileDataLoading"></etools-loading>
    </etools-dialog>
    <template is="dom-if" if="[[_showEtoolsAjaxEl]]">
      <user-profile-data id="userProfileData" user-profile="{{profile}}"></user-profile-data>
    </template>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'user-profile-dialog',
        behaviors: [pmpBehaviors.EtoolsStaticCommonDataReduxBehavior],
        properties: {
          profile: {
            type: Object
          },
          allOffices: {
            type: Object,
            statePath: 'offices'
          },
          allSections: {
            type: Object,
            statePath: 'sections'
          },
          allUsers: {
            type: Object,
            statePath: 'unicefUsersData'
          },
          availableCountryIds: Array,
          availableGroups: Array,
          userProfileModel: {
            type: Object,
            value: {
              office: null,
              section: null,
              supervisor: null,
              countries_available: [],
              oic: null,
              groups: [],
              supervisees: [],
              job_title: '',
              phone_number: '',
            }
          },
          _showUserProfileDataEl: {
            type: Boolean,
            value: false
          },
          _loadingEl: {
            type: Object
          },
          _defaultLoadingMsg: {
            type: String,
            value: 'Loading profile data...'
          },
          _showEtoolsAjaxEl: {
            type: Boolean,
            value: false
          }
        },
        observers: [
          '_mapIds(profile)',
          '_recenterDialog(profile.supervisees.*, availableCountryIds.*, availableGroups.*)'
        ],
        listeners: {
          'my-profile-ajax-loading': '_handleMyProfileAjaxLoading',
          'toast': '_handleErrorsToastEvent'
        },
        ready: function() {
          var d = Polymer.dom(this.$.userProfileDialog.root).querySelector('paper-dialog');
          if (d) {
            d.addEventListener('iron-overlay-opened', this._stampProfileDataElement.bind(this));
          }
          if (!this.profile) {
            this.set('profile', this.userProfileModel);
          }
        },
        _stampProfileDataElement: function() {
          if (!this._showEtoolsAjaxEl) {
            this._setLoadingMsgAndActivate(this._defaultLoadingMsg);
            this.set('_showEtoolsAjaxEl', true);
          }
        },
        _recenterDialog: function(superviseesData, countryIdsData, groupsData) {
          this.debounce('recenterMyProfileDialog', function() {
            this._centerDialog();
          }.bind(this), 300);
        },
        _getLoadingEl: function() {
          if (!this._loadingEl) {
            this._loadingEl = this.$.profileDataLoading;
          }
          return this._loadingEl;
        },
        _setLoadingMsgAndActivate: function(msg) {
          var loadingEl = this._getLoadingEl();
          if (loadingEl) {
            loadingEl.loadingText = msg;
            loadingEl.active = true;
          }
        },
        _deactivateLoading: function() {
          var loadingEl = this._getLoadingEl();
          if (loadingEl) {
            loadingEl.active = false;
          }
        },
        _handleMyProfileAjaxLoading: function(e) {
          e.stopImmediatePropagation();
          if (e.detail && e.detail.message) {
            this._setLoadingMsgAndActivate(e.detail.message);
          } else {
            this._deactivateLoading();
          }
        },
        _handleErrorsToastEvent: function(e) {
          e.stopImmediatePropagation();
          this._deactivateLoading();
          this.fire('user-profile-toast', e.detail);
        },
        openUserProfileDialog: function() {
          this.$.userProfileDialog.opened = true;
        },
        _centerDialog: function() {
          var d = Polymer.dom(this.$.userProfileDialog.root).querySelector('paper-dialog');
          if (d) {
            d.center();
          }
        },
        _closeUserProfileDialog: function(event) {
          if (event.detail.confirmed) {
            this.saveData();
          }
        },
        _mapIds: function() {
          var availableCountryIds = _.map(this.profile.countries_available, 'id');
          var availableGroups = _.map(this.profile.groups, 'id');

          this.set('availableCountryIds', availableCountryIds);
          this.set('availableGroups', availableGroups);
        },
        resetData: function() {
          this.set('profile', JSON.parse(JSON.stringify(this.userProfileModel)));
        },
        saveData: function() {
          var profileDataEl = this.$$('#userProfileData');
          if (profileDataEl) {
            profileDataEl.saveProfile(this.profile);
          }
        },
      });
    })();
  </script>
</dom-module>

