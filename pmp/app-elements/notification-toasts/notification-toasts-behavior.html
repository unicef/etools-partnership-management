<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">
<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};
  /** @polymerBehavior EtoolsPmpApp.Behaviors.NotificationToasts */
  EtoolsPmpApp.Behaviors.NotificationToasts = {

    properties: {
      _toast: {
        type: Object,
        value: null
      },
      _toastQueue: {
        type: Array,
        value: function() { return []; }
      },
      currentToastMessage: {
        type: String,
        value: ''
      }
    },

    listeners: {
      'toast': 'queueToast'
    },

    queueToast: function(e, detail) {
      e.stopPropagation();
      if (!this._toast) {
        this._toast = document.createElement('paper-toast');
        this._toast.classList.add('toast-general-style');
        let messageWrapper = this._toast.$.label;
        if (messageWrapper) {
          messageWrapper.style.whiteSpace = 'pre-wrap';
        }
        this.listen(this._toast, 'iron-overlay-closed', 'dequeueToast');
        let closeToastBtn = document.createElement('paper-button');
        closeToastBtn.innerHTML = 'Ok';
        closeToastBtn.classList.add('toast-dismiss-btn-general-style');
        closeToastBtn.addEventListener('tap', this._toggleToast.bind(this, this._toast));
        Polymer.dom(this._toast).appendChild(closeToastBtn);
        // this.$.layout is app-drawer-layout element from app-shell.html
        let layout = this.$.layout;
        if (layout) {
          Polymer.dom(layout).appendChild(this._toast);
        } else {
          console.warn('app-drawer-layout element from app-shell must have id="layout"');
        }
      }

      if (!this._toastQueue.length) {
        this.push('_toastQueue', detail);
        let toastProperties = this._prepareToastAndGetShowProperties(detail);
        this._showToast(toastProperties);
      } else {
        let alreadyInQueue = this._toastQueue.filter(function(toastDetail) {
          return JSON.stringify(toastDetail) === JSON.stringify(detail);
        });
        if (alreadyInQueue.length === 0) {
          this.push('_toastQueue', detail);
        } // else already in the queue
      }
    },
    _isMultiLine: function(message) {
      if (!message) {
        return false;
      }
      return message.toString().length > 80;
    },
    dequeueToast: function() {
      this.shift('_toastQueue');
      if (this._toastQueue.length) {
        let toastProperties = this._prepareToastAndGetShowProperties(this._toastQueue[0]);
        this._showToast(toastProperties);
      }
    },

    _prepareToastAndGetShowProperties: function(detail) {
      let closeToastBtn = Polymer.dom(this._toast).querySelector('paper-button');

      if (this._isMultiLine(detail.text)) {
        this._toast.classList.remove('toast');
        this._toast.classList.add('toast-multi-line');

        closeToastBtn.classList.remove('toast-dismiss-btn');
        closeToastBtn.classList.add('toast-dismiss-btn-multi-line');
      } else {
        this._toast.classList.remove('toast-multi-line');
        this._toast.classList.add('toast');

        closeToastBtn.classList.remove('toast-dismiss-btn-multi-line');
        closeToastBtn.classList.add('toast-dismiss-btn');
      }
      closeToastBtn.updateStyles();

      // clone detail obj
      let toastProperties = JSON.parse(JSON.stringify(detail));

      toastProperties.duration = 0;
      if (typeof detail === 'object' && typeof detail.showCloseBtn !== 'undefined') {
        if (detail.showCloseBtn === true) {
          closeToastBtn.removeAttribute('hidden');
        } else {
          closeToastBtn.setAttribute('hidden', true);
          if (!detail.duration) {
            toastProperties.duration = 5000;
          }
        }
        delete toastProperties.showCloseBtn;
      } else {
        closeToastBtn.setAttribute('hidden', true);
      }

      return toastProperties;
    },

    _toggleToast: function(toast) {
      if (toast) {
        toast.toggle();
      }
    },

    _showToast: function(toastProperties) {
      this.set('currentToastMessage', toastProperties.text);
      this._toast.show(toastProperties);
    }

  };
</script>
