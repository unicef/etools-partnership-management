<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../../styles/file-styles.html">
<link rel="import" href="../../../styles/required-field-styles.html">
<dom-module id="etools-single-file">

  <template>
    <style include="file-styles required-field-starred-styles">
      :host {
        @apply(--layout-horizontal);
        width: 100%;
        min-height: 62px;
      }
      #file-wrapper {
        width: 100%;
      }
    </style>
    <div id="file-wrapper" class="file-container">
      <etools-file id="files"
                   files="{{attachments}}"
                   label="[[label]]"
                   accept="[[accept]]"
                   readonly$="[[readonly]]"
                   invalid$="[[invalid]]"
                   error-message=[[errorMessage]]
                   hide-delete-btn="[[hideDeleteBtn]]">
      </etools-file>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'etools-single-file',
        behaviors: [
          pmpBehaviors.CommonGeneralBehavior
        ],
        properties: {
          attachments: {
            type: Array,
            value: function() {
              return [];
            }
          },
          readonly: {
            type: Boolean,
            value: false
          },
          required: {
            type: Boolean,
            value: false,
            observer: '_requiredChanged'
          },
          autoValidate: Boolean,
          accept: String,
          label: String,
          file: {
            type: Object,
            notify: true,
            observer: '_autoValidateFile'
          },
          internalFile: {
            type: Object,
            observer: '_fileChanged'
          },
          invalid: {
            type: Boolean,
            value: false
          },
          errorMessage: {
            type: String,
            value: 'Please select a file'
          },
          hideDeleteBtn: {
            type: Boolean,
            reflectToAttribute: true
          }
        },
        observers: [
          '_attachmentChanged(attachments.length)',
          '_fileReplaced(attachments.*)',
          '_refreshStyles(readonly, required)'
        ],

        _fileChanged: function(intr) {
          if (this.internalFile) {
            this.set('attachments', this.prepareEtoolsFileDataFromUrl(this.internalFile));
          } else {
            this.set('attachments', []);
          }
        },
        _attachmentChanged: function(filesLength) {
          if (filesLength > 0) {
            if (this.attachments[0].raw instanceof File) {
              this.set('file', this.attachments[0].raw);
            } else if (typeof this.internalFile === 'string' && !!this.internalFile.length) {
              this.set('file', this.internalFile);
            } else {
              this.set('file', null);
            }
          } else {
            this.set('file', null);
          }
        },

        _fileReplaced: function(data) {
          if ((data.path.indexOf('attachments.#') > -1)) {
            // file changed
            this._attachmentChanged(this.attachments.length);
          }
        },

        validate: function() {
          if (this.required && !this.readonly && this.file instanceof File === false &&
              (typeof this.file === 'string' ? !!!this.file.length : true)) {
            this.set('invalid', true);
            return false;
          }
          this.set('invalid', false);
          return true;
        },

        _autoValidateFile: function() {
          if (this.autoValidate) {
            this.validate();
          }
        },

        _refreshStyles: function() {
          this.updateStyles();
        },

        _requiredChanged: function(req) {
          if (req === false) {
            this.validate();
          }
        }


      });
    })();
  </script>

</dom-module>
