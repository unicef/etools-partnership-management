<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../../bower_components/etools-checkable-input/etools-checkable-input.html">
<link rel="import" href="../../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<link rel="import" href="../partners/partners-data/partners-list-data.html">
<link rel="import" href="../agreements/agreement-data/agreement-list-data.html">
<link rel="import" href="../interventions/intervention-data/interventions-list-data.html">
<link rel="import" href="../governments/governments-data/governments-list-data.html">


<dom-module id="data-refresh-dialog">
  <template>
    <style include="shared-styles grid-layout-styles">
      [hidden] {
        display: none !important;
      }

      paper-material {
        width: 100%;
      }

      paper-material {
        padding: 0;
      }

      #content-box {
        max-height: 600px;
        overflow-y: auto;
        margin: 0 -20px;
        padding: 0 15px;
        height: 100%;
      }
    </style>
    <etools-dialog
            id="dataRefreshDialog"
            size="sm"
            ok-btn-text="Refresh data"
            cancel-btn-text="Cancel"
            dialog-title="Refresh data"
            disable-confirm-btn="[[isRefreshDisabled]]"
            on-close="_handleDialogClosed">
      <div id="content-box">
        <iron-label> Select the data you want to refresh: </iron-label>

        <div class="custom-field-wrapper">
          <etools-checkable-input checked="{{partnersSelected}}"
                                  label="Partners data"
                                  label-alignment="right">
          </etools-checkable-input>
          <etools-checkable-input checked="{{agreementsSelected}}"
                                  label="Agreements data"
                                  label-alignment="right">
          </etools-checkable-input>
          <etools-checkable-input checked="{{interventionsSelected}}"
                                  label="PD/SSFA ToR data"
                                  label-alignment="right">
          </etools-checkable-input>
          <etools-checkable-input checked="{{governmentsSelected}}"
                                  label="Governments data"
                                  label-alignment="right">
          </etools-checkable-input>

          <etools-checkable-input checked="{{allSelected}}"
                                  label="All"
                                  label-alignment="right">
          </etools-checkable-input>

        </div>
      </div>
      <!--<etools-loading id="profileDataLoading"></etools-loading>-->
    </etools-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'data-refresh-dialog',
        behaviors: [
            etoolsAppConfig,
            EtoolsLogsBehavior
          ],
        properties: {
          name: String,
          governmentsSelected: {
            type: Boolean,
            value: false
          },
          interventionsSelected: {
            type: Boolean,
            value: false
          },
          partnersSelected: {
            type: Boolean,
            value: false
          },
          agreementsSelected: {
            type: Boolean,
            value: false
          },
          allSelected: {
            type: Boolean,
            value: false
          },
          isRefreshDisabled: {
            type: Boolean,
            value: false
          },
        },
        observers: [
          '_selectedObserver(governmentsSelected, interventionsSelected, partnersSelected, agreementsSelected)',
          '_otherSelectedObserver(allSelected)'
        ],
        ready: function() {
        },

        open: function() {
          this.$.dataRefreshDialog.opened = true;
        },

        clearSelectedFromDexie: function(collectionName) {
          return this.db[collectionName].clear()
            .then(function() {
              return this.db.collectionsList.delete(collectionName);
            }.bind(this))
            .then(function() {
              this.logInfo('Dexie data refreshed for collection: ' + collectionName, null);
              console.log('done for', collectionName);
              return true;
            }.bind(this))
            .catch(function(err) {
              this.logWarn('Dexie data clearing failed for collection: ' + collectionName, 'data-refresh-dialog');
              return false;
            }.bind(this));
        },

        _handleDialogClosed: function(closingReason) {
            if (closingReason.detail.confirmed) {
              this.fire('global-loading', {message: 'Refreshing data...', active: true});

              var promises = [];
              for (var key in this.selected) {
                if(this.selected[key]) {
                  promises.push(this.clearSelectedFromDexie(key));
                }
              }

              Promise.all(promises).then(function(results) {
                console.log('all k', results);
                this._refreshPage();
              }.bind(this)).catch(function(error) {
                console.log('oops', error);
                this.fire('global-loading', {active: false})
              }.bind(this));

            }
        },

        _refreshPage: function() {
          // window.location.reload(true);
          this.fire('global-loading', {active: false})
        },
        _otherSelectedObserver: function() {
          this.debounce('_selectedRefreshCheckbox', function() {
            if(!this.allSelected) {
              return;
            }

            this.set('governmentsSelected', true);
            this.set('interventionsSelected', true);
            this.set('partnersSelected', true);
            this.set('agreementsSelected', true);
          }.bind(this), 150);
        },

        _selectedObserver: function() {
          this.debounce('_selectedRefreshCheckbox', function() {
            var allSelected = this.governmentsSelected &&
                this.interventionsSelected &&
                this.partnersSelected &&
                this.agreementsSelected;

            this.set('allSelected', allSelected);
          }.bind(this), 150);
        },

      });
    })();
  </script>
</dom-module>

