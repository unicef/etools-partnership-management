<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../../bower_components/etools-checkable-input/etools-checkable-input.html">
<link rel="import" href="../../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<link rel="import" href="../partners/partners-data/partners-list-data.html">
<link rel="import" href="../agreements/agreement-data/agreement-list-data.html">
<link rel="import" href="../interventions/intervention-data/interventions-list-data.html">
<link rel="import" href="../governments/governments-data/governments-list-data.html">


<dom-module id="data-refresh-dialog">
  <template>
    <style include="shared-styles grid-layout-styles">
      [hidden] {
        display: none !important;
      }

      paper-material {
        width: 100%;
      }

      paper-material {
        padding: 0;
      }

      #content-box {
        max-height: 600px;
        min-height: 160px;
        overflow-y: auto;
        margin: 0 -20px;
        padding: 0 15px;
        height: 100%;
      }
    </style>
    <etools-dialog
            id="dataRefreshDialog"
            size="sm"
            ok-btn-text="Refresh data"
            cancel-btn-text="Cancel"
            dialog-title="Refresh data"
            disable-confirm-btn="[[!anySelected]]"
            on-iron-overlay-opened="_refreshDialogOpened"
            on-close="_handleDialogClosed">
      <div id="content-box">
        <iron-label> Select the data you want to refresh: </iron-label>

        <div class="custom-field-wrapper flex-c">

          <div class="row-h">
            <div class="col-6">
              <etools-checkable-input checked="{{partnersSelected}}"
                                      label="Partners data"
                                      label-alignment="right">
              </etools-checkable-input>
            </div>
            <div class="col-6">
              <etools-checkable-input checked="{{interventionsSelected}}"
                                      label="PD/SSFA ToR data"
                                      label-alignment="right">
              </etools-checkable-input>
            </div>
          </div>
          <div class="row-h">
            <div class="col-6">
              <etools-checkable-input checked="{{agreementsSelected}}"
                                      label="Agreements data"
                                      label-alignment="right">
              </etools-checkable-input>
            </div>
            <div class="col-6">
              <etools-checkable-input checked="{{governmentsSelected}}"
                                      label="Governments data"
                                      label-alignment="right">
              </etools-checkable-input>
            </div>
          </div>

          <div class="row-h">
            <div class="col-12">
              <etools-checkable-input checked="{{allSelected}}"
                                      label="All"
                                      label-alignment="right">
              </etools-checkable-input>
            </div>
          </div>

        </div>
      </div>
      <!--<etools-loading id="profileDataLoading"></etools-loading>-->
    </etools-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'data-refresh-dialog',
        behaviors: [
            etoolsAppConfig,
            EtoolsLogsBehavior
          ],
        properties: {
          name: String,
          governmentsSelected: {
            type: Boolean,
            value: false
          },
          interventionsSelected: {
            type: Boolean,
            value: false
          },
          partnersSelected: {
            type: Boolean,
            value: false
          },
          agreementsSelected: {
            type: Boolean,
            value: false
          },
          allSelected: {
            type: Boolean,
            value: false
          },
          anySelected: {
            type: Boolean,
            value: false
          },
          page: {
            type: String,
            notify: true
          }
        },
        observers: [
          '_singleSectionChanged(governmentsSelected, interventionsSelected, partnersSelected, agreementsSelected)',
          '_allSelectedChanged(allSelected)'
        ],

        open: function() {
          this.$.dataRefreshDialog.opened = true;
        },

        _allSelectedChanged: function() {
          this.debounce('_selectedRefreshCheckbox', function() {
            if (!this.allSelected) {
              return;
            }

            this.set('governmentsSelected', true);
            this.set('interventionsSelected', true);
            this.set('partnersSelected', true);
            this.set('agreementsSelected', true);
            this.set('anySelected', true);
          }.bind(this), 150);
        },

        _singleSectionChanged: function() {
          this.debounce('_selectedRefreshCheckbox', function() {
            var allSelected = this.governmentsSelected &&
                this.interventionsSelected &&
                this.partnersSelected &&
                this.agreementsSelected;

            var anySelected = this.governmentsSelected ||
                this.interventionsSelected ||
                this.partnersSelected ||
                this.agreementsSelected;

            this.set('allSelected', allSelected);
            this.set('anySelected', anySelected);
          }.bind(this), 150);
        },

        _handleDialogClosed: function(closingReason) {
            if (closingReason.detail.confirmed) {
              var promises = [];

              this.fire('global-loading', {message: 'Refreshing data...', active: true});

              if (this.governmentsSelected) {
                promises.push(this._clearSelectedFromDexie('governments'));
              }
              if (this.interventionsSelected) {
                promises.push(this._clearSelectedFromDexie('interventions'));
              }
              if (this.partnersSelected) {
                promises.push(this._clearSelectedFromDexie('partners'));
              }
              if (this.agreementsSelected) {
                promises.push(this._clearSelectedFromDexie('agreements'));
              }

              Promise.all(promises)
              .then(function(results) {
                if (results.indexOf(false) < 0) {
                  this._handleSuccess();
                } else {
                  this._handleFailure();
                }
              }.bind(this))
              .catch(function(error) {
                this._handleFailure();
              }.bind(this));
            } else {

            }
        },

        _clearSelectedFromDexie: function(collectionName) {
          return this.db[collectionName].clear()
            .then(function() {
              return this.db.collectionsList.delete(collectionName);
            }.bind(this))
            .then(function() {
              this.logInfo('Dexie data refreshed for collection: ' + collectionName, null);
              return true;
            }.bind(this))
            .catch(function(err) {
              this.logWarn('Dexie data clearing failed for collection: ' + collectionName, 'data-refresh-dialog');
              return false;
            }.bind(this));
        },

        _handleSuccess: function() {
          this.fire('global-loading', {active: false});
          this.fire('update-main-path', {path: '', restoreHomePage: true});
          this.fire('toast', {text: 'Data successfully refreshed', showCloseBtn: true});
        },

        _handleFailure: function() {
            this.fire('global-loading', {active: false});
            this.fire('update-main-path', {path: ''});
            this.fire('toast', {text: 'There was an error while refreshing the data', showCloseBtn: true});
        },

        _refreshDialogOpened: function(e) {
          e.stopImmediatePropagation();
          this.set('page', null);
        }

      });
    })();
  </script>
</dom-module>

