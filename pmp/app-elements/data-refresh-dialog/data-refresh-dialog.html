<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<dom-module id="data-refresh-dialog">
  <template>
    <style include="shared-styles grid-layout-styles">
      [hidden] {
        display: none !important;
      }

      paper-input,
      paper-textarea,
      paper-material {
        width: 100%;
      }

      paper-material {
        padding: 0;
      }
      paper-dropdown-menu {
        width: 100%;
      }

      #content-box {
        max-height: 600px;
        overflow-y: auto;
        margin: 0 -20px;
        padding: 0 15px;
      }
    </style>
    <etools-dialog
            id="dataRefreshDialog"
            size="sm"
            ok-btn-text="Refresh data"
            cancel-btn-text="Cancel"
            dialog-title="Refresh data"
            disable-confirm-btn="[[isRefreshDisabled]]"
            on-close="_handleDialogClosed">
      <div id="content-box">
        <paper-dropdown-menu label="Select the data you would like to refresh">
          <paper-menu class="dropdown-content"
                      attr-for-selected="name"
                      selected="{{selected}}">

            <paper-item name="partners">Partners</paper-item>
            <paper-item name="agreements">Agreements</paper-item>
            <paper-item name="governments">Governments</paper-item>
            <paper-item name="interventions">PD/SSFA ToR</paper-item>
          </paper-menu>
        </paper-dropdown-menu>
      </div>
      <!--<etools-loading id="profileDataLoading"></etools-loading>-->
    </etools-dialog>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'data-refresh-dialog',
        behaviors: [
            etoolsAppConfig,
            EtoolsLogsBehavior
          ],
        properties: {
          selected: String,
          name: String,
          isRefreshDisabled: {
            type: Boolean,
            value: true
          }
        },
        observers: [
          'valueChanged(selected)'
        ],
        ready: function() {
          console.log('ready');
        },

        open: function() {
          this.$.dataRefreshDialog.opened = true;
          console.log(this.selected);
          // this.clear('governments');
        },

        clearSelectedFromDexie: function() {
          var collectionName = this.selected;
          console.log(collectionName);
          this.db[collectionName].clear()
            .then(function() {
              return this.db.collectionsList.delete(collectionName);
            }.bind(this))
            .then(function() {
              this.logInfo('Dexie data refreshed for collection: ' + collectionName, null);
              this._refreshPage();
            }.bind(this))
            .catch(function(err) {
              this.logWarn('Dexie data clearing failed for collection: ' + collectionName, 'data-refresh-dialog');
              this.fire('global-loading', {active: false});
            }.bind(this));
        },

        valueChanged: function(selected) {
          this.isRefreshDisabled = false;
        },

        _handleDialogClosed: function(closingReason) {
            if (closingReason.detail.confirmed) {
              this.clearSelectedFromDexie();
              this.fire('global-loading', {message: 'Refreshing data...', active: true});
            }
        },

        // Is there a way to do this without refreshing the page?
        _refreshPage: function() {
          this.refreshInProgress = false;
          window.location.reload(true);
        }

      });
    })();
  </script>
</dom-module>

