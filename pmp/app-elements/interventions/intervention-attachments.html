<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">

<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<dom-module id="intervention-attachments">

  <template>

    <style include="page-layout-styles grid-layout-styles shared-styles file-styles">
      :host {
        @apply(--layout-vertical);
        width: 100%;

        --etools-file-label: {
          display: none;
        };

        --ecp-content: {
          padding: 0;
          overflow: hidden;
        };

      }

      #attachments {
        padding-bottom: 17px;
        --etools-file-upload-button-paper-btn: {
          font-weight: bold;
          padding: 5px 10px;
          background-color: var(--secondary-color);
        };

        --etools-file-upload-button: {
          color: var(--light-primary-text-color, #FFFFFF) !important;
          max-width: 200px;
          margin-left: 25px;
          margin-top: 25px !important;
        };

        --etools-file-area-with-type: {
          padding: 15px 25px;
        };
      }

      #no-attach-warning {
        display: inline-block;
        width: 100%;
        padding: 20px 25px;
        position: absolute;
      }

      #no-attach-warning p {
        margin: 0;

      }

    </style>

    <etools-content-panel class="content-section" panel-title="Attachments">

      <div id="no-attach-warning" hidden$=[[_hideNoAttachmentsWarning(attachments.length)]]>
        <p>There are no attachments added.</p>
      </div>

      <etools-file id="attachments"
                   files="{{attachments}}"
                   file-model="[[fileModel]]"
                   file-types=[[fileTypes]]
                   label="Attachments"
                   multiple activate-file-types use-delete-events
                   hide-delete-btn
                   on-delete-file="_deleteAttachment"
                   readonly$=[[!intervention.permissions.edit.attachments]]
                   no-file-attached-msg=""></etools-file>

    </etools-content-panel>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-attachments',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior
        ],

        properties: {
          active: {
            type: Boolean
          },
          intervention: {
            type: Object
          },
          attachments: {
            type: Array,
            value: [],
            notify: true,
            observer: '_attachmentsChanged'
          },
          fileTypes: {
            type: Array,
            statePath: 'fileTypes'
          },
          fileModel: {
            type: Object,
            value: null
          },
          preparedAttachments: {
            type: Boolean,
            value: false
          }
        },

        observers: ['_checkEmptyFileTypesData(fileTypes, active)'],

        _attachmentsChanged: function(attachments) {
          if (Array.isArray(attachments) &&
              attachments.length > 0 && !this._hasPath(attachments[0]) && !this.preparedAttachments) {
            // this should run only one time when attachments(intervention.attachments) are provided
            this.set('preparedAttachments', true);
            this.set('attachments', attachments.map(function(attachment) {
              return {
                id: attachment.id,
                intervention: attachment.intervention,
                type: attachment.type,
                attachment_file: attachment.attachment_file ? attachment.attachment_file : null,
                attachment: null,
                file_name: this._getFileName(attachment),
                path: this._getPath(attachment)
              };
            }.bind(this)));
          }
        },

        _getPath: function(attachment) {
          if (typeof attachment.attachment_file === 'string' && attachment.attachment_file !== '') {
            return attachment.attachment_file;
          }
          if (typeof attachment.attachment === 'string' && attachment.attachment !== '') {
            return attachment.attachment;
          }
          return null;
        },

        _getFileName: function(attachment) {
          if (typeof attachment.attachment_file === 'string' && attachment.attachment_file !== '') {
            return this.getFileNameFromURL(attachment.attachment_file);
          }
          if (typeof attachment.attachment === 'string' && attachment.attachment !== '') {
            return this.getFileNameFromURL(attachment.attachment);
          }
          return null;
        },

        _hasPath: function(file) {
          return typeof file.path === 'string' && file.path !== '';
        },

        _hideNoAttachmentsWarning: function(length) {
          return length > 0;
        },

        _deleteAttachment: function(event) {
          try {
            let attachment = this.get('attachments.' + event.detail.index);
            if (attachment) {
              if (attachment.id) {
                // delete from serve using endpoint
                // TODO: use an endpoint(once is implemented on backend) to delete attachments
                this.fire('toast', {
                  text: 'Delete file not implemented yet for already saved attachments!',
                  showCloseBtn: true
                });
              } else {
                // file not saved yet(only selected), delete from local data
                this.splice('attachments', event.detail.index, 1);
              }
            }
          } catch (err) {
            console.error('An error occurred on deleting attachment no: #' + (event.detail.index + 1), err);
          }
        },

        _checkEmptyFileTypesData: function(fileTypes, active) {
          if (active && !fileTypes.length) {
            // there are no file types in the current workspace
            this.fire('toast', {
              text: 'File Type data required to save attachments is missing from current workspace!',
              showCloseBtn: true
            });
          }
        }

      });

    })();
  </script>

</dom-module>
