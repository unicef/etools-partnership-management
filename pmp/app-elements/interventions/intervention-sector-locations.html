<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="intervention-sector-locations">
  <template strip-whitespace>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;

        --paper-fab-keyboard-focus-background: var(--success-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .item-container {
        padding: 15px 0;
      }

      .action.delete[disabled] {
        visibility: hidden;
      }
    </style>

    <etools-ajax id="deleteAjax"
                 on-success="_handleDeleteResponse"
                 on-fail="_handleDeleteError"></etools-ajax>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="row-h item-actions-container">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled="[[!editMode]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">
            <div class="row-h">
              <div class="col col-3">
                <etools-searchable-multiselection-menu id$="sector_[[index]]"
                                                       class="sector"
                                                       label="Sectors"
                                                       placeholder="&#8212;"
                                                       value="[[_setSector(item.sector, sectors.length)]]"
                                                       options="[[sectors]]"
                                                       custom-object-options
                                                       option-label="name"
                                                       option-value="id"
                                                       on-value-change="_sectorSelected"
                                                       required$="[[required]]"
                                                       auto-validate
                                                       error-message="Please select a sector"
                                                       readonly$="[[!editMode]]">
                </etools-searchable-multiselection-menu>
              </div>
              <div class="col col-9">
                <etools-searchable-multiselection-menu id$="locations_[[index]]"
                                                       label="Locations"
                                                       placeholder="&#8212;"
                                                       value="[[_setSectorLocations(item.locations, locations.length)]]"
                                                       options="[[locations]]"
                                                       custom-object-options
                                                       option-label="name"
                                                       option-value="id"
                                                       on-value-change="_locationsSelected"
                                                       multi
                                                       required$="[[required]]"
                                                       auto-validate
                                                       error-message="Please select sector locations"
                                                       readonly$="[[!editMode]]">
                </etools-searchable-multiselection-menu>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no sector locations added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewSectorLocation"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-sector-locations',

        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.RepeatableDataSetsBehavior
        ],

        properties: {
          locations: {
            type: Array,
            statePath: 'locations'
          },
          sectors: {
            type: Array,
            statePath: 'sectors'
          },
          required: {
            type: Boolean,
            value: false
          },
          _deleteEpName: {
            type: String,
            value: 'sectorLocationsDelete',
            readOnly: true,
          }
        },
        observers: [
          '_dataItemsChanged(dataItems)',
        ],

        ready: function() {
          this.dataSetModel = {
            id: null,
            sector: null,
            locations: []
          };
        },

        _dataItemsChanged: function(dataItems) {
          if (!Array.isArray(dataItems)) {
            this.set('dataItems', []);
          }
        },

        _sectorSelected: function(event) {
          var sectorSelected = event.detail.selectedValues;
          if (sectorSelected && Object.keys(sectorSelected).length > 0) {
            var sectorId = parseInt(sectorSelected.id, 10);
            if (this._sectorAlreadySelected(sectorId, event.model.index)) {
              this.fire('toast', {text: 'Sector already selected.', showCloseBtn: true});
              var sectorDropdown = this.$$('#sector_' + event.model.index);
              if (sectorDropdown) {
                sectorDropdown.value = [];
                sectorDropdown.selectedValues = null;
              }
              return;
            }
            this.set('dataItems.' + event.model.index + '.sector', {
              id: sectorId,
              name: sectorSelected.name
            });
          } else {
            this.set('dataItems.' + event.model.index + '.sector', null);
          }
        },

        _setSector: function(sector) {
          if (sector && Object.keys(sector).length > 0 && this.sectors.length) {
            return this.sectors.filter(function(s) {
              return parseInt(s.id, 10) === parseInt(sector.id, 10);
            });
          }
          return [];
        },

        _setSectorLocations: function(locations) {
          if (Array.isArray(locations) && locations.length > 0 && this.locations.length) {
            var selectedLocationsIds = locations.map(function(location) {
              return parseInt(location.id, 10);
            });
            return this.locations.filter(function(l) {
              return selectedLocationsIds.indexOf(parseInt(l.id, 10)) > -1;
            });
          }
          return [];
        },

        _locationsSelected: function(event) {
          var locationsSelected = event.detail.selectedValues;
          if (Array.isArray(locationsSelected) && locationsSelected.length > 0) {
            this.set('dataItems.' + event.model.index + '.locations', locationsSelected.map(function(l) {
              return {
                id: parseInt(l.id, 10),
                name: l.name
              };
            }));
          } else {
            this.set('dataItems.' + event.model.index + '.locations', []);
          }
        },

        _sectorAlreadySelected: function(sectorId, dropdownIdx) {
          var dropdowns = Polymer.dom(this.root).querySelectorAll('.sector');
          var selected = false;
          if (dropdowns && dropdowns.length) {
            for (var i = 0; i < dropdowns.length; i++) {
              if (dropdownIdx !== i && dropdowns[i].value && dropdowns[i].value.value) {
                if (dropdowns[i].value.value === sectorId) {
                  // already selected sector
                  selected = true;
                  break;
                }
              }
            }
          }
          return selected;
        },

        /**
         * Validate last added sector location and if is not empty add a new one
         */
        _addNewSectorLocation: function() {
          this._addElement();
        },

        /**
         * Validation
         */
        validate: function() {
          var valid = true;
          if (this.dataItems.length === 0 && this.required) {
            this.fire('toast', {text: 'Please add sector location data.', showCloseBtn: true});
            valid = false;
          } else {
            if (!this.required) {
              return valid;
            }
            this.dataItems.forEach(function(item, index) {
              var sectorEl = this.$$('#sector_' + index);
              var locationsEl = this.$$('#locations_' + index);
              if (!sectorEl.validate()) {
                valid = false;
              }
              if (!locationsEl.validate()) {
                valid = false;
              }
            }.bind(this));
          }
          return valid;
        },

        /**
         * Reset any error msg from a previous validation
         */
        resetValidations: function() {
          if (this.dataItems.length > 0) {
            this.dataItems.forEach(function(item, index) {
              var sectorEl = this.$$('#sector_' + index);
              if (sectorEl) {
                sectorEl.invalid = false;
              }
              var locationsEl = this.$$('#locations_' + index);
              if (locationsEl) {
                locationsEl.invalid = false;
              }
            }.bind(this));
          }
        }

      });
    })();
  </script>
</dom-module>
