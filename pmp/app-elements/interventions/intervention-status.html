<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import" href="../../app-elements/etools-status/etools-status.html">

<link rel="import" href="../../../styles/buttons-styles.html">

<dom-module id="intervention-status">
  <template strip-whitespace>
    <etools-status statuses="[[possibleStatuses]]"
                       actions="[[possibleActions]]"
                       on-intervention-save-event="_validateAndSaveIntervention"
                       on-intervention-draft-event="_setStatusDraft"
                       on-intervention-active-event="_setStatusActive"
                       on-intervention-cancel-event="_setStatusCanceled"
                       on-intervention-suspend-event="_setStatusSuspended"
                       on-intervention-terminate-event="_setStatusTerminated">
        </etools-status>
  </template>

  <script>
    (function() {
      'use strict';

      // TODO: Very important! this is 99% the same as agreement status.
      // Check if the statuses are the same and refactor this 2 elements

      Polymer({
        is: 'intervention-status',

        behaviors: [etoolsBehaviors.DynamicDialogBehavior],

        properties: {
          interventionId: {
            type: Number
          },
          status: {
            type: String,
            value: 'draft'
          },
          possibleStatuses: {
          type: Array,
          value:  [
              {
                label: 'Draft',
                completed: false
              },
              {
                label: 'Signed',
                completed: true
              },
              {
                label: 'Active',
                completed: false
              },
              {
                label: 'Ended',
                completed: false
              },
              {
                label: 'Closed',
                completed: false
              },
              {
                label: 'Suspended',
                completed: false
              },
              {
                label: 'Terminated',
                completed: false
              },
            ]
          },
          possibleActions: {
            type: Array,
            value: [
              {
                label: 'Save',
                available: false,
                primary: true,
                event: 'intervention-save-event'
              },
              {
                label: 'Change to draft',
                available: false,
                event: 'intervention-draft-event'
              },
              {
                label: 'Activate',
                available: false,
                event: 'intervention-active-event'
              },
              {
                label: 'Suspend',
                available: false,
                event: 'intervention-suspend-event'
              },
              {
                label: 'Terminate',
                available: false,
                event: 'intervention-terminate-event'
              },
              {
                label: 'Cancel',
                available: false,
                event: 'intervention-cancel-event'
              },
            ]
          },
          warningDialog: Object,
        },
        observers: [
            '_handleStatusChange(status)'
        ],

        ready: function() {
          var statusChangeWarningDialogContent = document.createElement('p');
          statusChangeWarningDialogContent.setAttribute('id', 'statusChangeWarningContent');
          this.warningDialog = this.createDialog('PD/SSFA ToR status change', 'md', 'Yes', 'No',
              this._statusChangeConfirmationCallback.bind(this), statusChangeWarningDialogContent);
        },

        detached: function() {
          if (this.warningDialog) {
            this.removeDialog(this.warningDialog);
          }
        },

        _showStatusChangeConfirmationDialog: function() {
          if (this.warningDialog) {
            var warningMessage = 'Are you sure you want to change agreement status from: <strong>\''
                + this.status + '\'</strong> to <strong>\'' + this.newStatus + '\'</strong>';
            var msgEl = Polymer.dom(this.warningDialog.root).querySelector('#statusChangeWarningContent');
            if (msgEl) {
              msgEl.innerHTML = warningMessage;
              this.warningDialog.opened = true;
            } else {
              console.warn('[pmp agreement status change] #statusChangeWarningContent element not found!');
            }
          } else {
            console.warn('[pmp agreement status change] warningDialog not created!');
          }
        },

        _setAllActionsToUnavailable: function() {
          var possibleActions = this.possibleActions;
          possibleActions.forEach(function(elem) {
            elem.available = false;
          });

          this.set('possibleActions', possibleActions);
          console.log(this.possibleActions);
        },

        _computeAvailableActions: function(status) {
            this._setAllActionsToUnavailable();
            let availableOptions = ['Save'];

            switch(status) {
              case 'draft':
                availableOptions.push('Cancel');
                break;
              case 'active':
                availableOptions.push('Suspend');
                availableOptions.push('Terminate');
                break;
              case 'suspended':
                availableOptions.push('Terminate');
                break;
              case 'terminated':
                // removes Save option
                availableOptions.pop();
                availableOptions.push('Activate');
                availableOptions.push('Suspend');
                break;
              case 'cancelled':
                // removes Save option
                availableOptions.pop();
                availableOptions.push('Change to draft');
              case 'closed':
                // removes Save option
                availableOptions.pop();
                break;
            };

            for(let key in this.possibleActions) {
              let actionName = this.possibleActions[key].label;
              if (availableOptions.indexOf(actionName) > -1 ) {
                let config = this.possibleActions[key];
                config.available = true;
                this.set(['possibleActions', key], config);
              }
            }
            // this.notifyPath('possibleActions');
        },





        _handleStatusChange: function(status) {
          this.debounce('reset-status-actions', this._computeAvailableActions.bind(this, status), 50);
        },









        _statusChangeConfirmationCallback: function(event) {
          if (event.detail.confirmed) {
            this.fire('update-intervention-status', {
              interventionId: this.interventionId,
              status: this.newStatus + ''
            });
          }
          this.set('newStatus', '');
        },

        _updateStatus: function(newStatus) {
          if (this.newAgreement) {
            return;
          }

          if (newStatus === 'draft' || newStatus === 'canceled') {
            // if agreement was not saved (is new) or the status is already changed
            // from draft/canceled, stop status change
            if (this.status !== 'draft' && this.status !== 'cancelled') {
              return false;
            }
          }

          if (newStatus === 'active' && this.interventionAgreementStatus === 'suspended') {
            // prevent changing status from suspended to active is the agreement status is suspended
            return false;
          }

          if (newStatus === 'active' || newStatus === 'suspended' || newStatus === 'terminated') {

            if (this.status !== 'active' && this.status !== 'suspended' && this.status !== 'terminated') {
              return false;
            }

          }
          this.set('newStatus', newStatus);
          this._showStatusChangeConfirmationDialog();
        },

        _setStatusTerminated: function() {
          this._updateStatus('terminated');
          console.log('status change: terminated');
        },

        _setStatusDraft: function() {
          this._updateStatus('draft');
          console.log('status change: draft');
        },

        _setStatusActive: function() {
          this._updateStatus('active');
          console.log('status change: active');
        },

        _setStatusSuspended: function() {
          this._updateStatus('suspended');
          console.log('status change: suspended');
        },

        _setStatusCanceled: function() {
          this._updateStatus('canceled');
          console.log('status change: canceled');
        },

        /**
         * Fire custom event to notify parent element to execute intervention save
         */
        _triggerInterventionSave: function() {
          this.fire('save-intervention', {});
        },

        _agreementStatusChanged: function(status, oldStatus) {
          if ((typeof oldStatus === 'undefined' || oldStatus === null) && status) {
            this.set('_hideSecondaryButtons', false);
          }
        }

      });
    })();

  </script>
</dom-module>
