<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../common-elements/etools-form-element-wrapper.html">

<dom-module id="intervention-planned-visits">
  <template strip-whitespace>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles buttons-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }
      paper-input {
        width: 100%;
      }
      etools-form-element-wrapper {
        --paper-input-container: {
          text-align: center;
        };
      }
      div.col-1 {
        min-width: 85px;
      }
      div.col-1.yearContainer {
        min-width: 100px;
      }
      .error-msg {
        color: var(--error-color);
        font-size: 12px;

        @apply --layout-vertical;
        @apply --layout-flex;
        @apply --layout-center-justified;
      }

      .no-top-padd {
        padding-top: 0;
      }
      .padd-left-with-items {
        margin-left: 46px;
      }
      .extra-top-padd {
        padding-top: 24px;
      }
      .pv-container {
        @apply --layout-vertical-reverse;
      }

    </style>

    <div class="row-h extra-top-padd" hidden$="[[!editMode]]">
      <paper-button class$="secondary-btn [[_getAddBtnPadding(dataItems.length)]]" on-tap="_addNewPlannedVisit">
          ADD YEAR
      </paper-button>
    </div>

    <div hidden$="[[_emptyList(dataItems.length)]]" class="pv-container">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="item-actions-container">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled="[[!_canBeRemoved(index, editMode)]]"
                                 icon="cancel">
              </paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h">
              <div class="col col-1 yearContainer">
                <etools-single-selection-menu id$="year_[[index]]"
                                              class="year"
                                              label="Year"
                                              placeholder="&#8212;"
                                              selected="{{item.year}}"
                                              options="[[years]]"
                                              required
                                              error-message="Required"
                                              on-iron-select="_yearChanged"
                                              readonly$="[[!editMode]]">
                </etools-single-selection-menu>
              </div>
              <div class="col col-1">
                <paper-input id$="visit_[[index]]_q1"
                             label="Quarter 1"
                             value="{{item.programmatic_q1}}"
                             type="number"
                             min="0"
                             allowed-pattern="[0-9\.]"
                             placeholder="&#8212;"
                             required$="[[item.year]]"
                             error-message="Required"
                             auto-validate
                             readonly$="[[!editMode]]">
                </paper-input>
              </div>
              <div class="col col-1">
                <paper-input id$="visit_[[index]]_q2"
                             label="Quarter 2"
                             value="{{item.programmatic_q2}}"
                             type="number"
                             min="0"
                             allowed-pattern="[0-9\.]"
                             placeholder="&#8212;"
                             required$="[[item.year]]"
                             error-message="Required"
                             auto-validate
                             readonly$="[[!editMode]]">
                </paper-input>
              </div>
              <div class="col col-1">
                <paper-input id$="visit_[[index]]_q3"
                             label="Quarter 3"
                             value="{{item.programmatic_q3}}"
                             type="number"
                             min="0"
                             allowed-pattern="[0-9\.]"
                             placeholder="&#8212;"
                             required$="[[item.year]]"
                             error-message="Required"
                             auto-validate
                             readonly$="[[!editMode]]">
                </paper-input>
              </div>
              <div class="col col-1">
                <paper-input id$="visit_[[index]]_q4"
                             label="Quarter 4"
                             value="{{item.programmatic_q4}}"
                             type="number"
                             min="0"
                             allowed-pattern="[0-9\.]"
                             placeholder="&#8212;"
                             required$="[[item.year]]"
                             error-message="Required"
                             auto-validate
                             readonly$="[[!editMode]]">
                </paper-input>
              </div>
              <div class="col col-1">
                <etools-form-element-wrapper label="TOTAL" class="row-second-bg" >
                  [[_getTotal(item.programmatic_q1, item.programmatic_q2, item.programmatic_q3, item.programmatic_q4)]]
                </etools-form-element-wrapper>

              </div>
              <div class="col col-4"
                  hidden$="[[!_showErrorMsg(item.year, item.programmatic_q1, item.programmatic_q2, item.programmatic_q3, item.programmatic_q4)]]">
                  <div class="error-msg">Total has to be greater than 0</div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <div class="row-h no-top-padd" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no planned visits added.</p>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-planned-visits',

        behaviors: [
          EtoolsPmpApp.Behaviors.RepeatableDataSets
        ],

        properties: {
          years: {
            type: Array,
            value: []
          },
          editMode: {
            type: Boolean,
            observer: '_editModeChanged'
          }
        },
        observers: [
          '_dataItemsChanged(dataItems)'
        ],

        ready: function() {
          this.dataSetModel = {
            id: null,
            year: null,
            programmatic_q1: 0,
            programmatic_q2: 0,
            programmatic_q3: 0,
            programmatic_q4: 0,
          };
        },
        _getAddBtnPadding: function(itemsLength) {
          if (!itemsLength) {
            return '';
          }
          return 'padd-left-with-items';
        },
        _getTotal: function(q1, q2, q3, q4) {
          return (Number(q1) || 0) + (Number(q2) || 0) + (Number(q3) || 0) + (Number(q4) || 0);
        },
        _showErrorMsg: function(year, q1, q2, q3, q4) {
          if (!year) {
            return false;
          }
          if (this._getTotal(q1, q2, q3, q4)) {
            return false;
          }
          return true;
        },
        validate: function() {
          let valid = true;
          this.dataItems.forEach(function(item, index) {
            if (!(this._validateYear(index) && this._validateQuarters(item, index))) {
              valid = false;
            }
          }.bind(this));

          return valid;
        },
        _validateYear: function(index) {
          let valid = true;
          let yearEl = this.$$('#year_' + index);

          if (yearEl && !yearEl.validate()) {
            valid = false;
          }
          return valid;
        },
        _validateQuarters: function(item, index) {
          let valid = true;
          let q1 = this.$$('#visit_' + index + '_q1');
          let q2 = this.$$('#visit_' + index + '_q2');
          let q3 = this.$$('#visit_' + index + '_q3');
          let q4 = this.$$('#visit_' + index + '_q4');

          [q1, q2, q3, q4].forEach(function(q) {
            if (q) {
              if (!q.validate()) {
                valid = false;
              }
            }
          });
          if (!this._getTotal(item.programmatic_q1, item.programmatic_q2, item.programmatic_q3, item.programmatic_q4)) {
            valid = false;
          }
          return valid;
        },

        _editModeChanged: function(newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        },

        _dataItemsChanged: function(dataItems) {
          if (!Array.isArray(dataItems)) {
            this.set('dataItems', []);
          }
        },

        /**
         * The planned visit row data can be removed only if it doesn't have and id assigned(only if is not saved)
         */
        _canBeRemoved: function(index, editMode) {
          if (!editMode || !this.dataItems || !this.dataItems.length) {
            return false;
          }
          var plannedVisit = this.dataItems[index];
          var plannedVisitId = parseInt(plannedVisit.id, 10);
          if (plannedVisitId && isNaN(plannedVisitId) === false && plannedVisitId > 0) {
            // planned visit already saved (has an id assigned)
            return false;
          }
          return true;
        },

        _getSelectedYear: function(year) {
          if (year && this.years.length) {
            return this.years.filter(function(y) {
              return y.value === parseInt(year, 10);
            });
          }
          return [];
        },

        _yearChanged: function(event) {
          if (this._plannedVisitIsAlreadySaved(event)) {// Avoid executing logic on page load
            return;
          }
          var yearSelected = event.detail.item.item ? event.detail.item.item.value : null;
          var yearDropdown = this.$$('#year_' + event.model.index);

          if (this._yearAlreadySelected(yearSelected, event.model.index)) {
            this.fire('toast', {text: 'Year already selected on other planned visit item.', showCloseBtn: true});
            if (yearDropdown) {
              yearDropdown.selected = null;
            }
            this.set('dataItems.' + event.model.index + '.year', null);
            event.preventDefault();
          } else {
            this.set('dataItems.' + event.model.index + '.year', yearSelected);
            yearDropdown.invalid = false; // Needed because auto-validate has been removed to avoid eager validation
          }
        },
        _plannedVisitIsAlreadySaved: function(event) {
          return event.model.item && event.model.item.id;
        },
        _yearAlreadySelected: function(year, dropdownIdx) {
          var dropdowns = Polymer.dom(this.root).querySelectorAll('.year');
          if (!dropdowns || !dropdowns.length) {
            return false;
          }
          for (var i = 0; i < dropdowns.length; i++) {
            if (dropdowns[i].selected) {
              if (dropdownIdx !== i && dropdowns[i].selected === year) {
                // already selected sector
              return true;
              }
            }
          }
          return false;
        },

        /**
         * Validate last added planned visit and if is not empty add a new one
         */
        _addNewPlannedVisit: function() {
          if (!this.validate()) {
            this.fire('toast', {text: 'Already added planned visit data is not valid yet', showCloseBtn: true});
            return;
          }
          this._addElement();
        }

      });
    })();
  </script>
</dom-module>
