<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">

<dom-module id="intervention-planned-visits">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;

        --paper-fab-keyboard-focus-background: #8dc63f; /* TODO: replace with app-theme var */
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }
      paper-input {
        width: 100%;
      }

      .action.delete[disabled] {
        visibility: hidden;
      }
    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="row-h item-actions-container">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled="[[!_canBeRemoved(index, editMode)]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">
            <div class="row-h">
              <div class="col col-2">
                <etools-searchable-multiselection-menu id$="year_[[index]]"
                                                       class="year"
                                                       label="Year"
                                                       placeholder="&#8212;"
                                                       value="[[_getSelectedYear(item.year, years.length)]]"
                                                       options="[[years]]"
                                                       on-value-change="_yearChanged"
                                                       readonly$="[[!editMode]]">
                </etools-searchable-multiselection-menu>
              </div>
              <div class="col col-3">
                <!-- TODO: min="0" not enought, re-check and restrict to values >= 0 -->
                <paper-input label="Programmatic Visits"
                             value="{{item.programmatic}}"
                             type="number"
                             min="0"
                             placeholder="&#8212;"
                             readonly$="[[!editMode]]">
                </paper-input>
              </div>
              <div class="col col-3">
                <paper-input label="Spot Checks"
                             value="{{item.spot_checks}}"
                             type="number"
                             min="0"
                             hidden
                             placeholder="&#8212;"
                             readonly$="[[!editMode]]">
                </paper-input>
              </div>
              <div class="col col-3">
                <paper-input label="Audit"
                             value="{{item.audit}}"
                             type="number"
                             min="0"
                             hidden
                             placeholder="&#8212;"
                             readonly$="[[!editMode]]">
                </paper-input>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no planned visits added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewPlannedVisit"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-planned-visits',

        behaviors: [
          pmpBehaviors.RepeatableDataSetsBehavior
        ],

        properties: {
          years: {
            type: Array,
            value: []
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          }
        },
        observers: [
          '_dataItemsChanged(dataItems)',
        ],

        ready: function() {
          this.dataSetModel = {
            id: null,
            year: null,
            programmatic: null,
            spot_checks: null,
            audit: null
          };
        },

        _editModeChanged: function(newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        },

        _dataItemsChanged: function(dataItems) {
          if (!Array.isArray(dataItems)) {
            this.set('dataItems', []);
          }
        },

        /**
         * The planned visit row data can be removed only if it doesn't have and id assigned(only if is not saved)
         */
        _canBeRemoved: function(index, editMode) {
          if (!editMode) {
            return false;
          }
          var plannedVisit = this.dataItems[index];
          var plannedVisitId = parseInt(plannedVisit.id, 10);
          if (plannedVisitId && isNaN(plannedVisitId) === false && plannedVisitId > 0) {
            // planned budget already saved (has an id assigned)
            return false;
          }
          return true;
        },

        _getSelectedYear: function(year) {
          if (year && this.years.length) {
            return this.years.filter(function(y) {
              return y.value === parseInt(year, 10);
            });
          }
          return [];
        },

        _yearChanged: function(event) {
          var yearSelected = (event.detail.selectedValues && event.detail.selectedValues.value)
              ? event.detail.selectedValues.value : null;

          if (this._yearAlreadySelected(yearSelected, event.model.index)) {
            this.fire('toast', {text: 'Year already selected on other planned visit item.', showCloseBtn: true});
            var yearDropdown = this.$$('#year_' + event.model.index);
            if (yearDropdown) {
              yearDropdown.value = [];
              yearDropdown.selectedValues = null;
            }
            return;
          }

          this.set('dataItems.' + event.model.index + '.year', yearSelected);
        },

        _yearAlreadySelected: function(year, dropdownIdx) {
          var dropdowns = Polymer.dom(this.root).querySelectorAll('.year');
          var selected = false;
          if (dropdowns && dropdowns.length) {
            for (var i = 0; i < dropdowns.length; i++) {
              if (dropdownIdx !== i && dropdowns[i].value && dropdowns[i].value.value) {
                if (dropdowns[i].value.value === year) {
                  // already selected sector
                  selected = true;
                  break;
                }
              }
            }
          }
          return selected;
        },

        /**
         * Validate last added planned visit and if is not empty add a new one
         */
        _addNewPlannedVisit: function() {
          this._addElement();
        }

      });
    })();
  </script>
</dom-module>
