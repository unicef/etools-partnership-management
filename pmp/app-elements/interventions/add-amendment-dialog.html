<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<link rel="import" href="../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../app-behaviors/ajax-errors-parser-behavior.html">
<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../validators/required-and-not-future-date-validator.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/file-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">


<dom-module id="add-amendment-dialog">
  <template>
    <style include="grid-layout-styles buttons-styles file-styles shared-styles">

    </style>

    <etools-dialog keep-dialog-open
                   id="etoolsDialog"
                   opened="{{opened}}"
                   size="lg"
                   ok-btn-text="Save"
                   dialog-title="Add Amendment"
                   disable-confirm-btn="[[disableConfirmBtn]]"
                   on-confirm-btn-clicked="_validateAndSaveAmendment">

          <div class="row-h flex-c">
            <div class="col col-4">
              <!-- Amendment Type -->
              <etools-multi-selection-menu id$="amendmentTypes"
                                          label="Amendment Types"
                                          placeholder="&#8212;"
                                          options="[[filteredAmendmentTypes]]"
                                          selected-values="{{item.types}}"
                                          dynamic-align
                                          required
                                          hide-search
                                          error-message="Type is required"
                                          on-focused-changed="_onFocusChangedUpdateAutovalidate">
              </etools-multi-selection-menu>

            </div>
            <div class="col col-3">
              <required-and-not-future-date-validator validator-name="signedDate_validator"
                                                      required
                                                      error-message="{{item.errorMessage}}">
              </required-and-not-future-date-validator>
              <!-- Signed Date -->
              <etools-date-input id$="signedDate"
                                label="Signed date"
                                value="{{item.signed_date}}"
                                required
                                validator="signedDate_validator"
                                error-message="Please select signed date"
                                auto-validate
                                error-message$="[[item.errorMessage]]"
                                no-init show-clear-btn>
              </etools-date-input>
            </div>
            <div class="col col-5 file-container">
              <!-- Signed Agreement -->
              <etools-single-file id="fileUpload"
                                  label="Signed Agreement"
                                  internal-file=[[item.signed_amendment_file]]
                                  file={{item.signed_amendment}}
                                  accept=".doc,.docx,.pdf,.jpg,.png"
                                  error-message="Attachment required"
                                  required
                                  auto-validate></etools-single-file>
            </div>
          </div>
          <div class="row-h flex-c" hidden$="[[!item.types]]">
            <span class="type-warning">
              [[_getSelectedAmendmentTypeWarning(item.types, item.types.length)]]
            </span>
          </div>
          <div class="row-h" hidden$="[[!_showOtherInput(item.types, item.types.length)]]">
            <paper-input id="other"
                        placeholder="&#8212;"
                        label="Other"
                        value="{{item.other_description}}">
            </paper-input>
          </div>
    </etools-dialog>

 </template>
</dom-module>

<script>
  (function() {
    'use strict';
    Polymer({
      is: 'add-amendment-dialog',
      behaviors: [
        EtoolsPmpApp.Behaviors.Endpoints,
        EtoolsPmpApp.Behaviors.AjaxErrorsParser,
        EtoolsAjaxRequestBehavior,
        EtoolsPmpApp.Behaviors.Dropdown,
        EtoolsPmpApp.Behaviors.EtoolsDataReduxStore
      ],

      properties: {
        toastEventSource: {
          type: Object
        },
        disableConfirmBtn: {
          type: Boolean,
          value: false
        },
        opened: {
          type: Boolean,
          notify: true
        },
        interventionDocumentType: {
          type: String
        },
        amendmentTypes: {
          type: Object,
          statePath: 'interventionAmendmentTypes'
        },
        item: {
          type: Object,
          value: {"id":null,"types":[],"other_description":null,"signed_date":null,"signed_amendment":null,"signed_amendment_file":"","amendment_number":null}
        },
        filteredAmendmentTypes: Object,
      },
      observers: [
        '_filterAmendmentTypes(amendmentTypes, interventionDocumentType)'
      ],
      ready: function() {
        console.log('add amendment dialog ready');
      },
      // validate fields
      validate: function() {
        var valid = true;
        if (!this.dataItems.length) {
          return valid;
        }
        this.dataItems.forEach(function(amendment, index) {
          // validate only new(not saved yet) amendments
          if (!this._isReadonlyAmendment(amendment.id) && !this._validateAmendment(index)) {
            valid = false;
          }
        }.bind(this));
        return valid;
      },
      _validateAndSaveAmendment: function() {
        console.log('implementation pending');
      },

      _filterAmendmentTypes: function(amendmentTypes, interventionDocumentType) {
        if (interventionDocumentType === 'SSFA') {
          this.filteredAmendmentTypes = this.amendmentTypes.filter(function(item) {
            return ['Dates', 'Other'].indexOf(item.label) > -1;
          });
        } else {
          this.filteredAmendmentTypes = JSON.parse(JSON.stringify(this.amendmentTypes));
        }
      },

      _showOtherInput: function(selectedAmdTypes, selectedAmdTypesLength) {
        if (!selectedAmdTypes || !selectedAmdTypes.length) {
          return false;
        }
        if (selectedAmdTypes.indexOf('other') > -1) {
          return true;
        }
        this._clearOtherInput();
        return false;
      },

      _clearOtherInput: function() {
        var otherInput = this.$$('#other');
        if (otherInput) {
          otherInput.value = null;
        }
      },
      _validateAmendment: function(index) {
          var amendment = this.dataItems[index];
          if (!amendment || this._isReadonlyAmendment(amendment.id)) {
            //Avoid validation for existing readonly amendments
            return true;
          }
          var isValid1 = this._validateAmendmentTypes(index);
          var isValid2 = this._validateSignedDate(amendment, index);
          var isValid3 = this._validateFileUpload(amendment, index);

          return (isValid1 && isValid2 && isValid3);
        },
        _validateAmendmentTypes: function(index) {
          var valid = true;
          var typeEl = this.$$('#amendmentTypes_' + index);
          if (typeEl && !typeEl.validate()) {
            valid = false;
          }
          return valid;
        },
        _validateFileUpload: function(amendment, index) {
          var valid = true;
          var fileUplodEl = this.$$('#fileUpload_' + index);
          if (fileUplodEl) {
            valid = !!amendment.signed_amendment;
            fileUplodEl.invalid = !valid;
          }
          return valid;
        },
        _validateSignedDate: function(amendment, index) {
          var isValid = true;

          let signedDateEl = this.$$('#signedDate_' + index);
          if (signedDateEl) {
            if (!signedDateEl.validate()) {
              isValid = false;
            }
          }
          return isValid;
        },
/**
         * Check if amendment fields are empty
         */
        _amendmentFieldsAreEmpty: function(amendment) {
          if (amendment.id) {
            return false;
          }
          return (this._amendmentTypeIsEmpty(amendment) ||
          this._signedDateIsEmpty(amendment) || this._newAttachmentIsEmpty(amendment));
        },
 _signedDateIsEmpty: function(amendment) {
          return amendment.signed_date === null || amendment.signed_date === '';
        },
        _newAttachmentIsEmpty: function(amendment) {
          return amendment.signed_amendment instanceof File === false;
        },
        _amendmentTypeIsEmpty: function(amendment) {
          return !amendment.types;
        },
/**
         * Validate last added amendment and if is not empty add a new one
         */
        _addNewAmendment: function() {
          var lastAmendmIndex = this.dataItems.length - 1;

          if (lastAmendmIndex > -1) {
            let lastAmendm = this.dataItems[lastAmendmIndex];
            if (!lastAmendm.id && this._amendmentFieldsAreEmpty(lastAmendm)) {
              this.fire('toast', {text: 'Last amendment fields are empty!', showCloseBtn: true});
              return;
            }
          }
          if (this._thereAreUnsavedAmendments()) {
            // Avoid showing the dialog when adding amendments consecutively
            this._addElement();
          } else {
            this._showAddAmendmentConfirmationDialog();
          }

        },
        resetValidations: function() {
          if (!this.dataItems.length) {
            return;
          }
          this.dataItems.forEach(function(amendment, index) {
            if (!this._isReadonlyAmendment(amendment.id)) {
              this._resetAmendmentValidations(index);
            }
          }.bind(this));
        },

        _resetAmendmentValidations: function(index) {
          var typeEl = this.$$('#amendmentTypes_' + index);
          if (typeEl) {
            typeEl.invalid = false;
          }
          var signedDateEl = this.$$('#signedDate_' + index);
          if (signedDateEl) {
            signedDateEl.invalid = false;
          }
          var fileUpload = this.$$('#fileUpload_' + index);
          if (fileUpload) {
            fileUpload.invalid = false;
          }
        },

        _isReadonlyAmendment: function(amendmentId) {
          return !!amendmentId;
        },
      _getSelectedAmendmentTypeWarning: function(types) {//TODO
        if (!types || !types.length) {
          return;
        }
        var message = 'Please make sure you update ';
        types.forEach(function(amdType) {
          switch (amdType) {
            case 'dates':
              message += 'Dates, ';
              break;
            case 'results':
              message += 'Programme Results, ';
              break;
            case 'budget':
              message += 'Planned Budget, ';
              break;
            case 'other':
              message += 'Other, ';
              break;
          }
        });
        message = message.substring(0, message.length - 2);
        message += ' section' + (message.indexOf(',') > -1 ? 's' : '') + ' of this PD/SSFA';
        return message;
      }
    });
  })();
</script>
