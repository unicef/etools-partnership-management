<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<link rel="import" href="../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/ajax-errors-parser-behavior.html">
<link rel="import" href="../validators/required-and-not-future-date-validator.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/file-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">


<dom-module id="add-amendment-dialog">
  <template>
    <style include="grid-layout-styles buttons-styles file-styles shared-styles">

    </style>

    <etools-dialog keep-dialog-open
                   id="addAmendmentDialog"
                   opened="{{opened}}"
                   size="lg"
                   ok-btn-text="Save"
                   dialog-title="Add Amendment"
                   disable-confirm-btn="[[disableConfirmBtn]]"
                   on-confirm-btn-clicked="_validateAndSaveAmendment">

          <div class="row-h flex-c">
            <div class="col col-4">
              <!-- Amendment Type -->
              <etools-multi-selection-menu id$="amendmentTypes"
                                          label="Amendment Types"
                                          placeholder="&#8212;"
                                          options="[[filteredAmendmentTypes]]"
                                          selected-values="{{item.types}}"
                                          dynamic-align
                                          required
                                          hide-search
                                          error-message="Type is required"
                                          on-focused-changed="_onFocusChangedUpdateAutovalidate">
              </etools-multi-selection-menu>

            </div>
            <div class="col col-3">
              <required-and-not-future-date-validator validator-name="signedDate_validator"
                                                      required
                                                      error-message="{{item.errorMessage}}">
              </required-and-not-future-date-validator>
              <!-- Signed Date -->
              <etools-date-input id$="signedDate"
                                label="Signed date"
                                value="{{item.signed_date}}"
                                required
                                validator="signedDate_validator"
                                error-message="Please select signed date"
                                auto-validate
                                error-message$="[[item.errorMessage]]"
                                no-init show-clear-btn>
              </etools-date-input>
            </div>
            <div class="col col-5 file-container">
              <!-- Signed Agreement -->
              <etools-single-file id="fileUpload"
                                  label="Signed Agreement"
                                  internal-file=[[item.signed_amendment_file]]
                                  file={{item.signed_amendment}}
                                  accept=".doc,.docx,.pdf,.jpg,.png"
                                  error-message="Attachment required"
                                  required
                                  auto-validate></etools-single-file>
            </div>
          </div>
          <div class="row-h flex-c" hidden$="[[!item.types]]">
            <span class="type-warning">
              [[_getSelectedAmendmentTypeWarning(item.types, item.types.length)]]
            </span>
          </div>
          <div class="row-h" hidden$="[[!_showOtherInput(item.types, item.types.length)]]">
            <paper-input id="other"
                        placeholder="&#8212;"
                        label="Other"
                        value="{{item.other_description}}">
            </paper-input>
          </div>
    </etools-dialog>

 </template>
</dom-module>

<script>
  (function() {
    'use strict';
    Polymer({
      is: 'add-amendment-dialog',
      behaviors: [
        EtoolsAjaxRequestBehavior,
        EtoolsPmpApp.Behaviors.Endpoints,
        EtoolsPmpApp.Behaviors.AjaxErrorsParser,
        EtoolsPmpApp.Behaviors.Dropdown,
        EtoolsPmpApp.Behaviors.EtoolsDataReduxStore
      ],

      properties: {
        endpointName: {
          type: String,
          value: 'interventionAmendmentAdd'
        },
        toastEventSource: {
          type: Object
        },
        disableConfirmBtn: {
          type: Boolean,
          value: true
        },
        opened: {
          type: Boolean,
          notify: true,
          observer: '_resetAmendmentValidations'
        },
        interventionDocumentType: {
          type: String
        },
        amendmentTypes: {
          type: Object,
          statePath: 'interventionAmendmentTypes'
        },
        item: {
          type: Object,
          value: {"id":null,"types":[],"other_description":null,"signed_date":null,"signed_amendment":null,"signed_amendment_file":"","amendment_number":null}
        },
        filteredAmendmentTypes: Object,
      },

      observers: [
        '_filterAmendmentTypes(amendmentTypes, interventionDocumentType)',
        '_disableConfirmBtn(item.types.length, item.signed_date, item.signed_amendment.size)'
      ],
      startSpinner: function() {
        this.$.addAmendmentDialog.startSpinner();
      },

      stopSpinner: function() {
        this.$.addAmendmentDialog.stopSpinner();
      },

      _disableConfirmBtn: function(typesLength, signedDate, fileSize) {
        this.set('disableConfirmBtn', !typesLength || !signedDate || !fileSize);
      },

      _filterAmendmentTypes: function(amendmentTypes, interventionDocumentType) {
        if (interventionDocumentType === 'SSFA') {
          this.filteredAmendmentTypes = this.amendmentTypes.filter(function(item) {
            return ['Dates', 'Other'].indexOf(item.label) > -1;
          });
        } else {
          this.filteredAmendmentTypes = JSON.parse(JSON.stringify(this.amendmentTypes));
        }
      },

      _showOtherInput: function(selectedAmdTypes, selectedAmdTypesLength) {
        if (!selectedAmdTypes || !selectedAmdTypes.length) {
          return false;
        }
        if (selectedAmdTypes.indexOf('other') > -1) {
          return true;
        }
        this._clearOtherInput();
        return false;
      },

      _clearOtherInput: function() {
        var otherInput = this.$$('#other');
        if (otherInput) {
          otherInput.value = null;
        }
      },

      isValidAmendment: function() {
        var isValid1 = this._validateAmendmentTypes();
        var isValid2 = this._validateSignedDate(this.item);
        var isValid3 = this._validateFileUpload(this.item);

        return (isValid1 && isValid2 && isValid3);
      },

      _validateAmendmentTypes: function() {
        var valid = true;
        var typeEl = this.$$('#amendmentTypes');
        if (typeEl && !typeEl.validate()) {
          valid = false;
        }
        return valid;
      },

      _validateFileUpload: function(amendment) {
        var valid = true;
        var fileUplodEl = this.$$('#fileUpload');
        if (fileUplodEl) {
          valid = !!amendment.signed_amendment;
          fileUplodEl.invalid = !valid;
        }
        return valid;
      },

      _validateSignedDate: function(amendment) {
        var isValid = true;

        let signedDateEl = this.$$('#signedDate');
        if (signedDateEl) {
          if (!signedDateEl.validate()) {
            isValid = false;
          }
        }
        return isValid;
      },

      _amendmentFieldsAreEmpty: function(amendment) {
        if (amendment.id) {
          return false;
        }
        return (this._amendmentTypeIsEmpty(amendment) ||
        this._signedDateIsEmpty(amendment) || this._newAttachmentIsEmpty(amendment));
      },

      _signedDateIsEmpty: function(amendment) {
        return amendment.signed_date === null || amendment.signed_date === '';
      },

      _newAttachmentIsEmpty: function(amendment) {
        return amendment.signed_amendment instanceof File === false;
      },

      _amendmentTypeIsEmpty: function(amendment) {
        return !amendment.types;
      },

      _resetAmendmentValidations: function() {
        var typeEl = this.$$('#amendmentTypes');
        if (typeEl) {
          typeEl.invalid = false;
        }
        var signedDateEl = this.$$('#signedDate');
        if (signedDateEl) {
          signedDateEl.invalid = false;
        }
        var fileUpload = this.$$('#fileUpload');
        if (fileUpload) {
          fileUpload.invalid = false;
        }
      },

      _isReadonlyAmendment: function(amendmentId) {
        return !!amendmentId;
      },

      _getSelectedAmendmentTypeWarning: function(types) {//TODO
        if (!types || !types.length) {
          return;
        }
        var message = 'Please make sure you update ';
        types.forEach(function(amdType) {
          switch (amdType) {
            case 'dates':
              message += 'Dates, ';
              break;
            case 'results':
              message += 'Programme Results, ';
              break;
            case 'budget':
              message += 'Planned Budget, ';
              break;
            case 'other':
              message += 'Other, ';
              break;
          }
        });
        message = message.substring(0, message.length - 2);
        message += ' section' + (message.indexOf(',') > -1 ? 's' : '') + ' of this PD/SSFA';
        return message;
      },

      _validateAndSaveAmendment: function() {
        if (!this.isValidAmendment()) {
          return;
        }
        this.startSpinner();

        let self = this;
        let options = {
          method: 'POST',
          endpoint: this.getEndpoint(this.endpointName, {intervId: this.interventionId}),
          body: this.item,
          multiPart: true,
          prepareMultipartData: true
        };

        this.sendRequest(options)
          .then(function(resp) {
          self._handleResponse();
        }).catch(function(error) {
          self._handleErrorResponse(error);
        });
      },

      _handleResponse: function(reponse) {
        this.fire('amendment-added', reponse);
        this.stopSpinner();
        this.set('opened', false);
      },

      _handleErrorResponse: function(error) {
        this.stopSpinner();
        this.parseRequestErrorsAndShowAsToastMsgs(error, this.toastEventSource);
      },

    });
  })();
</script>
