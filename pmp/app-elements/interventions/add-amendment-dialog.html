<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">
<link rel="import" href="../common-elements/etools-single-file.html">
<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../validators/required-and-not-future-date-validator.html">

<link rel="import" href="../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/ajax-errors-parser-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/file-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">


<dom-module id="add-amendment-dialog">
  <template>
    <style include="grid-layout-styles buttons-styles file-styles shared-styles">
      .type-warning {
        color: var(--warning-color);
      }

      paper-input#other {
        width: 100%;
      }

      .row-h {
        padding-top: 8px;
        padding-bottom: 8px;
      }
    </style>

    <etools-dialog no-padding
                   keep-dialog-open
                   id="addAmendmentDialog"
                   opened="{{opened}}"
                   size="md"
                   hidden$="[[datePickerOpen]]"
                   ok-btn-text="Save"
                   dialog-title="Add Amendment"
                   on-confirm-btn-clicked="_validateAndSaveAmendment">

            <div class="row-h flex-c">
              <required-and-not-future-date-validator validator-name="signedDate_validator"
                                                      required
                                                      error-message="{{newAmendment.errorMessage}}">
              </required-and-not-future-date-validator>
              <!-- Signed Date -->
              <etools-date-input id="signedDate"
                                label="Signed date"
                                value="{{newAmendment.signed_date}}"
                                required
                                open="{{datePickerOpen}}"
                                validator="signedDate_validator"
                                error-message="Please select signed date"
                                auto-validate
                                error-message$="[[newAmendment.errorMessage]]"
                                no-init show-clear-btn>
              </etools-date-input>
            </div>
            <div class="row-h flex-c">
              <!-- Amendment Type -->
              <etools-multi-selection-menu id="amendmentTypes"
                                          label="Amendment Types"
                                          placeholder="&#8212;"
                                          options="[[filteredAmendmentTypes]]"
                                          selected-values="{{newAmendment.types}}"
                                          dynamic-align
                                          required
                                          hide-search
                                          error-message="Type is required"
                                          on-focused-changed="_onFocusChangedUpdateAutovalidate">
              </etools-multi-selection-menu>
            </div>
            <div class="row-h flex-c" hidden$="[[!newAmendment.types.length]]">
              <span class="type-warning">
                [[_getSelectedAmendmentTypeWarning(newAmendment.types, newAmendment.types.length)]]
              </span>
            </div>
            <div class="row-h" hidden$="[[!_showOtherInput(newAmendment.types, newAmendment.types.length)]]">
              <paper-input id="other"
                          placeholder="&#8212;"
                          label="Other"
                          invalid
                          required
                          auto-validate
                          error-message="This is required"
                          value="{{newAmendment.other_description}}">
              </paper-input>
            </div>
            <div class="row-h flex-c">
              <!-- Signed Agreement -->
              <etools-single-file id="fileUpload"
                                  label="Signed Agreement"
                                  internal-file="[[newAmendment.signed_amendment_file]]"
                                  file="{{newAmendment.signed_amendment}}"
                                  accept=".doc,.docx,.pdf,.jpg,.png"
                                  error-message="Attachment required"
                                  required
                                  auto-validate></etools-single-file>
            </div>
    </etools-dialog>

 </template>
</dom-module>

<script>
  (function() {
    'use strict';
    Polymer({
      is: 'add-amendment-dialog',
      behaviors: [
        EtoolsAjaxRequestBehavior,
        EtoolsPmpApp.Behaviors.Endpoints,
        EtoolsPmpApp.Behaviors.AjaxErrorsParser,
        EtoolsPmpApp.Behaviors.Dropdown,
        EtoolsPmpApp.Behaviors.EtoolsDataReduxStore
      ],

      properties: {
        endpointName: {
          type: String,
          value: 'interventionAmendmentAdd'
        },
        toastEventSource: {
          type: Object
        },
        datePickerOpen: {
          type: Boolean,
          value: false
        },
        opened: {
          type: Boolean,
          notify: true,
          observer: '_resetFields'
        },
        interventionDocumentType: {
          type: String
        },
        amendmentTypes: {
          type: Object,
          statePath: 'interventionAmendmentTypes'
        },
        newAmendmentModel: {
          type: Object,
          value: {
            'types': [],
            'other_description': null,
            'signed_date': null,
            'signed_amendment': null,
            'signed_amendment_file': '',
            'amendment_number': null
          }
        },
        newAmendment: {
          type: Object
        },
        filteredAmendmentTypes: Object,
      },

      observers: [
        '_filterAmendmentTypes(amendmentTypes, interventionDocumentType)'
      ],

      ready: function() {
        this.resetAmendment();
      },

      resetAmendment: function() {
        // this is to trigger change detection on etools-single-file
        this.set('newAmendment.signed_amendment_file', null);
        this.set('newAmendment', JSON.parse(JSON.stringify(this.newAmendmentModel)));
      },

      startSpinner: function() {
        this.$.addAmendmentDialog.startSpinner();
      },

      stopSpinner: function() {
        this.$.addAmendmentDialog.stopSpinner();
      },


      _filterAmendmentTypes: function(amendmentTypes, interventionDocumentType) {
        if (interventionDocumentType === 'SSFA') {
          this.filteredAmendmentTypes = this.amendmentTypes.filter(function(newAmendment) {
            return ['Dates', 'Other'].indexOf(newAmendment.label) > -1;
          });
        } else {
          this.filteredAmendmentTypes = JSON.parse(JSON.stringify(this.amendmentTypes));
        }
      },

      _showOtherInput: function() {
        let amdTypes = this.newAmendment.types;
        if (!amdTypes || !amdTypes.length) {
          return false;
        }
        if (amdTypes.indexOf('other') > -1) {
          return true;
        }
        return false;
      },

      isValidAmendment: function() {
        let isValid1 = this._validateAmendmentTypes();
        let isValid2 = this._validateOtherInput();
        let isValid3 = this._validateSignedDate(this.newAmendment);
        let isValid4 = this._validateFileUpload(this.newAmendment);

        return (isValid1 && isValid2 && isValid3 && isValid4);
      },

      _validateOtherInput: function() {
        let valid = true;
        if (this._showOtherInput()) {
          let otherEl = this.$$('#other');
          if (otherEl && !otherEl.validate()) {
            valid = false;
          }
        }
        return valid;
      },

      _validateAmendmentTypes: function() {
        let valid = true;
        let typeEl = this.$$('#amendmentTypes');
        if (typeEl && !typeEl.validate()) {
          valid = false;
        }
        return valid;
      },

      _validateFileUpload: function(amendment) {
        let valid = true;
        let fileUplodEl = this.$$('#fileUpload');
        if (fileUplodEl) {
          valid = !!amendment.signed_amendment;
          fileUplodEl.invalid = !valid;
        }
        return valid;
      },

      _validateSignedDate: function(amendment) {
        let isValid = true;

        let signedDateEl = this.$$('#signedDate');
        if (signedDateEl) {
          if (!signedDateEl.validate()) {
            isValid = false;
          }
        }
        return isValid;
      },

      _amendmentFieldsAreEmpty: function(amendment) {
        if (amendment.id) {
          return false;
        }
        return (this._amendmentTypeIsEmpty(amendment) ||
        this._signedDateIsEmpty(amendment) || this._newAttachmentIsEmpty(amendment));
      },

      _signedDateIsEmpty: function(amendment) {
        return amendment.signed_date === null || amendment.signed_date === '';
      },

      _newAttachmentIsEmpty: function(amendment) {
        return amendment.signed_amendment instanceof File === false;
      },

      _amendmentTypeIsEmpty: function(amendment) {
        return !amendment.types;
      },

      _resetFields: function() {
        this.resetAmendment();
        this._resetAmendmentValidations();
      },

      _resetAmendmentValidations: function() {
        let typeEl = this.$$('#amendmentTypes');
        if (typeEl) {
          typeEl.invalid = false;
        }
        let signedDateEl = this.$$('#signedDate');
        if (signedDateEl) {
          signedDateEl.invalid = false;
        }
        let fileUpload = this.$$('#fileUpload');
        if (fileUpload) {
          fileUpload.invalid = false;
        }
        let otherField = this.$$('#other');
        if (otherField) {
          otherField.invalid = false;
        }
      },

      _getSelectedAmendmentTypeWarning: function(types) {//TODO
        if (!types || !types.length) {
          return;
        }
        let message = 'Please make sure you update ';
        types.forEach(function(amdType) {
          switch (amdType) {
            case 'dates':
              message += 'Dates, ';
              break;
            case 'results':
              message += 'Programme Results, ';
              break;
            case 'budget':
              message += 'Planned Budget, ';
              break;
            case 'other':
              message += 'Other, ';
              break;
          }
        });
        message = message.substring(0, message.length - 2);
        message += ' section' + (message.indexOf(',') > -1 ? 's' : '') + ' of this PD/SSFA';
        return message;
      },

      _validateAndSaveAmendment: function() {
        if (!this.isValidAmendment()) {
          return;
        }
        this.startSpinner();

        let self = this;
        let options = {
          method: 'POST',
          endpoint: this.getEndpoint(this.endpointName, {intervId: this.interventionId}),
          body: this.newAmendment,
          multiPart: true,
          prepareMultipartData: true
        };

        this.sendRequest(options)
          .then(function(resp) {
          self._handleResponse(resp);
        }).catch(function(error) {
          self._handleErrorResponse(error);
        });
      },

      _handleResponse: function(reponse) {
        this.fire('amendment-added', reponse);
        this.stopSpinner();
        this.set('opened', false);
        this.resetAmendment();
      },

      _handleErrorResponse: function(error) {
        this.stopSpinner();
        this.parseRequestErrorsAndShowAsToastMsgs(error, this.toastEventSource);
      }
    });
  })();
</script>
