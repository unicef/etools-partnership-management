<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../bower_components/iron-label/iron-label.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="monitoring-visits-list.html">

<dom-module id="intervention-overview">

  <template strip-whitespace>

    <style include="page-layout-styles grid-layout-styles shared-styles">
      :host {
        @apply(--layout-vertical);
        width: 100%;
      }

      .block {
        display: block;
      }

      .content {
        margin-top: 8px;
      }

      iron-label {
        color: var(--dark-secondary-text-color);
      }

      .secondary {
        color: var(--dark-secondary-text-color);
      }

      .blue {
        color: var(--paper-blue-500);
      }

      .sector-label {
        white-space: nowrap;
        height: 19px;
        text-align: center;
        padding: 7px 10px;
        background-color: var(--warning-color);
        text-transform: capitalize;
        font-weight: bold;
        color: var(--light-primary-text-color, #FFFFFF);
      }

      #monitoring-visits-panel {
        --ecp-content: {
          padding: 10px 0 25px;
        }
      }

      #top-container {
        margin-bottom: 20px;
      }
    </style>

    <paper-material elevation="1" id="top-container">
      <div class="row-h flex-c">
        <div class="col col-12 block">
          <iron-label for="cp_outputs_list">
            Cp Output(s)
          </iron-label>
          <br/>
          <div class="content" id="cp_outputs_list">
            <template is="dom-repeat" items="[[cpOutputs]]" as="cpOut">
              <strong> [[ cpOut ]] </strong> <br/>
            </template>
          </div>
        </div>
      </div>

      <div class="row-h flex-c">
        <div class="col col-12 block">
          <iron-label for="document_title">
            Document Title
          </iron-label>
          <br/>
          <div class="content" id="document_title">
            [[ intervention.title ]]
          </div>

          <div class="secondary">
            Under <strong class="blue">[[interventionAgreement.agreement_type]]</strong> with <strong class="blue">[[intervention.partner]]</strong>
          </div>
        </div>
      </div>

      <div class="row-h flex-c">
        <div class="col col-12 block">
          <iron-label for="intervention_locations">
            Locations
          </iron-label>
          <br/>
          <div class="content" id="intervention_locations">
            <iron-icon icon="maps:place"></iron-icon>
            [[ getDisplayValue(locations) ]]
          </div>
        </div>
      </div>

      <div class="row-h flex-c">
        <div class="col col-6 block">
          <iron-label for="interventions_timeline">
            Timeline
          </iron-label>
          <br/>
          <div class="content" id="interventions_timeline">
            [[getDateDisplayValue(intervention.start)]] - [[getDateDisplayValue(intervention.end)]]
          </div>
        </div>
        <div class="col col-6 block">
          <iron-label for="interventions_sectors">
            Sectors
          </iron-label>
          <br/>
          <div class="content" id="interventions_sectors">
            <template is="dom-repeat" items="[[sectors]]" as="sector">
              <span class="sector-label" style="[[_getBackgroundStyleFromColor(sector.color)]]">[[sector.label]]</span>
            </template>
          </div>
        </div>
      </div>
    </paper-material>

    <etools-content-panel id="monitoring-visits-panel" class="content-section" title="Monitoring Visits">
      <monitoring-visits-list intervention-id="[[intervention.id]]"></monitoring-visits-list>
    </etools-content-panel>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-overview',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior
        ],

        properties: {
          intervention: {
            type: Object,
            observer: '_interventionChanged'
          },
          interventionAgreement: {
            type: Object,
          },
          monitoringVisit: {
            type: Array,
          },
          allCpOutputs: {
            type: Array,
            statePath: 'cpOutputs'
          },
          cpOutputs: {
            type: Array
          },
          locations: {
            type: Array
          },
          allSectors: {
            type: Array,
            statePath: 'sectors'
          },
          sectors: {
            type: Array
          },
        },

        _interventionChanged: function(intervention) {
          if (intervention && typeof intervention === 'object' && parseInt(intervention.id, 10) > 0) {
            this._parseCpOutputs();
            this._parseLocationsAndSectors();
          }

          // ensure loading msg close
          this.fire('global-loading', {active: false});
        },

        _parseCpOutputs: function() {
          var resultLinks = this.intervention.result_links;
          var ids = {};
          var uniqueIds = [];
          var cpOutputs = [];

          resultLinks.forEach(function(res) {
            ids[res.cp_output] = true;
          });

          for (var id in ids) {
            uniqueIds.push(parseInt(id));
          }
          if (Array.isArray(this.allCpOutputs) && this.allCpOutputs.length > 0) {
            this.allCpOutputs.forEach(function(cpo) {
              if (uniqueIds.indexOf(cpo.id) > -1) {
                cpOutputs.push(cpo.name);
              }
            });

            this.set('cpOutputs', cpOutputs);
          }
        },

        _parseLocationsAndSectors: function() {
          var sectorLocations = [];
          var sectorIds = [];
          var sectors = [];

          this.intervention.sector_locations.forEach(function(locLvl1) {
            locLvl1.locations.forEach(function(locLvl2) {
              sectorLocations.push(locLvl2.name);
            });
            sectorIds.push(locLvl1.sector.id);
          });

          sectors = [];
          if (Array.isArray(this.allSectors) && this.allSectors.length > 0) {
            sectors = this.allSectors.filter(function(elem) {
              return (sectorIds.indexOf(elem.value) > -1);
            });
          }
          this.set('sectors', sectors);
          this.set('locations', sectorLocations);
        },

        _getBackgroundStyleFromColor: function(color) {
          return 'background-color: ' + color;
        },

      });

    })();
  </script>

</dom-module>
