<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../bower_components/iron-label/iron-label.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="monitoring-visits-list.html">
<link rel="import" href="../agreements/agreement-data/agreement-item-data.html">
  
<dom-module id="intervention-overview">

  <template>

    <style include="page-layout-styles grid-layout-styles shared-styles">
      :host {
        @apply(--layout-horizontal);
        width: 100%;
      }
      .block {
        display: block;
      }
      .content {
        margin-top: 8px;
      }
      iron-label {
        color: var(--dark-secondary-text-color);
      }
      .secondary {
        color: var(--dark-secondary-text-color);
      }
      .blue {
        color: var(--paper-blue-500);        
      }
      .sector-label {
        white-space: nowrap;        
        height: 19px;
        text-align: center;
        padding: 7px 10px;
        background-color: #FF9640; /* TODO: replace with app-theme var */
        text-transform: capitalize;        
        font-weight: bold;
        color: #fff;
      }
      #monitoring-visits-panel {
        --ecp-content: {
          padding: 10px 0 25px;
        }
      }
    </style>

    <agreement-item-data id="agreement"
                         agreement-id="[[intervention.agreement]]"
                         agreement="{{interventionAgreement}}"></agreement-item-data>


    <partner-item-data id="partner" partner-id="[[selectedPartnerId]]" partner="{{partner}}"></partner-item-data>

    <div id="pageContent">
      <etools-content-panel class="content-section" title="">
        <div class="row-h flex-c">
          <div class="col col-12 block">
              <iron-label for="cp_outputs_list"> 
                Cp Output(s)                                
              </iron-label>
              <br/>
              <div class="content" id="cp_outputs_list">
                <template is="dom-repeat" items="[[cpOutputs]]" as="cpOut">
                    <strong> [[ cpOut ]] </strong> <br/>
                </template>
              </div>              
          </div>
        </div>

        <div class="row-h flex-c">
          <div class="col col-12 block">
              <iron-label for="cp_outputs_list"> 
                Document Title
              </iron-label>
              <br />
              <div class="content" id="cp_outputs_list">
                [[ intervention.title ]]                 
              </div>              
              
              <div class="secondary"> 
                Under <strong class="blue">[[interventionAgreement.agreement_type]]</strong> with <strong class="blue">[[intervention.partner]]</strong> 
              </div>
          </div>
        </div>

        <div class="row-h flex-c">
          <div class="col col-12 block">
              <iron-label for="intervention_locations"> 
                Locations
              </iron-label>
              <br />
              <div class="content" id="intervention_locations">
                <iron-icon icon="maps:place"></iron-icon> [[ getDisplayValue(locations) ]]                               
              </div>              
          </div>
        </div>
        
        <div class="row-h flex-c">
          <div class="col col-6 block">
              <iron-label for="interventions_timeline"> 
                Timeline
              </iron-label>
              <br />
              <div class="content" id="interventions_timeline">
                [[_checkAndShowDate(interventionAgreement.start)]] - [[_checkAndShowDate(interventionAgreement.end)]]
              </div>              
          </div>
          <div class="col col-6 block">
              <iron-label for="interventions_sectors"> 
                Sectors
              </iron-label>
              <br />
              <div class="content" id="interventions_sectors">
                <template is="dom-repeat" items="[[sectors]]" as="sector">
                  <span class="sector-label" style="[[_getBackgroundStyleFromColor(sector.color)]]">[[sector.label]]</span>
                </template>  
              </div>              
          </div>
        </div>
        
      </etools-content-panel>
      <etools-content-panel id="monitoring-visits-panel" class="content-section" title="Monitoring Visits">
          <monitoring-visits-list></monitoring-visits-list>
      </etools-content-panel>
    </div> <!-- main page content end -->

    <!-- sidebar content start -->
    <div id="sidebar">
      <intervention-status status="[[intervention.status]]"></intervention-status>
    </div>
    <!-- sidebar content end -->


  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-overview',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior
        ],

        properties: {
          intervention: {
            type: Object,
            observer: '_interventionChanged'
          },
          interventionAgreement: {
            type: Object,
          },
          monitoringVisit: {
            type: Array,
          },
          allCpOutputs: {
            type: Array,
            statePath: 'cpOutputs'
          },
          cpOutputs: {
            type: Array
          },
          locations: {
            type: Array
          },
          allSectors: {
            type: Array,             
            statePath: 'sectors'
          },
          sectors: {
            type: Array
          },
        },
        ready: function() {
          this.monitoringVisits = [
            {
              id: 1,
              number: '2016/646-3',
              traveler_name: 'Jane Doe',
              traveler_type: 'Spot Check',
              date: '2016-05-05',
              locations: [],
              status: 'planned'
            },
            {
              id: 2,
              number: '2016/646-1',
              traveler_name: 'John Doe',
              traveler_type: 'Programmatic Visit',
              date: '2016-03-03',
              locations: [],
              status: 'approved'
            },
            {
              id: 3,
              number: '2016/646-2',
              traveler_name: 'Peter Scoodlypooper',
              traveler_type: 'Spot Check',
              date: '2016-06-06',
              locations: [],
              status: 'completed'
            },
          ];

        },
        _interventionChanged: function(intervention) {          
          if (intervention && typeof intervention === 'object' && Object.keys(intervention).length > 0) {            
            this._parseCpOutputs();  
            this._parseLocationsAndSectors();
          }

          // ensure loading msg close
          this.fire('global-loading', {active: false});
        },

        _parseCpOutputs: function() {
          var resultLinks = this.intervention.result_links;
          var ids = {};
          var uniqueIds = [];
          var cpOutputs = [];

          resultLinks.forEach(function(res) {
            ids[res.cp_output.id] = true;
          });

          for(var id in ids) {
            uniqueIds.push(parseInt(id));
          }

          this.allCpOutputs.forEach(function(cpo){           
            if(uniqueIds.indexOf(cpo.value) > -1) {
              cpOutputs.push(cpo.label);  
            }
          });

          this.set('cpOutputs', cpOutputs);
        },

        _parseLocationsAndSectors: function() {
          var sectorLocations = [];
          var sectorIds = [];
          var sectors = [];

          this.intervention.sector_locations.forEach(function(locLvl1){
            locLvl1.locations.forEach(function(locLvl2){
              sectorLocations.push(locLvl2.name);
            });
            sectorIds.push(locLvl1.sector.id);
          });                   

          sectors = this.allSectors.filter(function(elem){            
            return (sectorIds.indexOf(elem.value) > -1)
          });

          this.set('sectors', sectors);
          this.set('locations', sectorLocations);
        },
        
        _checkAndShowDate: function(dateString) {
          return this.getDisplayValue(dateString, true);
        },

        _getBackgroundStyleFromColor: function(color) {
          return 'background-color: ' + color;
        },

      });

    })();
  </script>

</dom-module>
