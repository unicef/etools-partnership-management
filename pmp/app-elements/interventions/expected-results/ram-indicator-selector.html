<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">

<link rel="import" href="../../../app-config/etools-app-config.html">
<link rel="import" href="../../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../../app-behaviors/esmm-missing-options/missing-dropdown-options-behavior.html">
<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../intervention-data/cp-output-ram-indicators-data.html">

<dom-module id="ram-indicator-selector">
  <template>
    <style include="grid-layout-styles shared-styles">
      :host {
        width: 100%;
      }
    </style>

    <cp-output-ram-indicators-data ram-indicators="{{cpIndicators}}"
                                   cp-output-id="[[cpOutputId]]">
    </cp-output-ram-indicators-data>

    <div class="row-h flex-c">
      <div class="col col-4">
        <etools-single-selection-menu id="cpOutput"
                                      label="CP Output"
                                      placeholder="&#8212;"
                                      options="{{cpOutputsOptions}}"
                                      option-value="id"
                                      option-label="name"
                                      selected="{{cpOutputId}}"
                                      required$="[[required]]"
                                      auto-validate
                                      error-message="Please select CP Output"
                                      on-iron-activate="_resetSelectedIndicators"
                                      readonly$="[[!editMode]]">
        </etools-single-selection-menu>
      </div>

      <div class="col col-8">
        <etools-searchable-multiselection-menu id="indicators"
                                               label="CP Indicators"
                                               placeholder="&#8212;"
                                               options="[[cpIndicators]]"
                                               custom-object-options
                                               option-value="id"
                                               option-label="name"
                                               selected="{{selectedCpIndicatorsIds}}"
                                               update-selected
                                               required$="[[required]]"
                                               auto-validate
                                               error-message="Please select CP Indicators"
                                               multi
                                               readonly$="[[!editMode]]">
        </etools-searchable-multiselection-menu>

      </div>
    </div>
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'ram-indicator-selector',
        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          etoolsAppConfig.globals,
          pmpBehaviors.MissingDropdownOptionsBehavior
        ],
        properties: {
          cpOutputs: {
            type: Array,
            statePath: 'cpOutputs'
          },
          cpOutputsOptions: {
            type: Array,
            value: []
          },
          selectedCpStructure: {
            type: String,
            observer:'selectedCpStructureChanged'
          },
          cpOutputId: {
            type: Number,
            notify: true
          },
          cpIndicators: {
            type: Array,
            value: [],
            observer: '_cpIndicatorsChanged'
          },
          selectedCpIndicatorsIds: {
            type: Array,
            value: [],
            notify: true,
            observer: '_selectedCpIndicatorsIdsChanged'
          },
          firstLoadCpIndicators: {
            type: Array,
            value: []
          },
          firstLoadCpIndicatorsUse: {
            type: Boolean,
            value: true
          },
          alreadySelectedCpo: {
            type: Array,
            value: []
          },
          editMode: {
            type: Boolean,
            value: false
          },
          oldCpOutputsUrlAjaxParams: {
            type: Object,
            value: {
              dropdown: true
            }
          }
        },

        observers: [
          '_computeCpOutputsOptions(alreadySelectedCpo, cpOutputs.length, selectedCpStructure)'
        ],

        ready: function() {
          this.setDropdownMissingOptionsAjaxDetails(this.$.cpOutput, 'cpOutputsByIdsAsValues', {dropdown: true});
        },
        selectedCpStructureChanged: function() {
          console.log('selectedCpStructureChanged', this.selectedCpStructure);
        },
        _selectedCpIndicatorsIdsChanged: function(ids, oldids) {
            if (ids.length && this.firstLoadCpIndicatorsUse) {
              // prepare cp indicators id to be set as selected, used only once, at element init
              this.set('firstLoadCpIndicators', JSON.parse(JSON.stringify(ids)));
              this.set('firstLoadCpIndicatorsUse', false);
            }
        },

        _resetSelectedIndicators: function() {
           this.set('selectedCpIndicatorsIds', []);
            this.$.indicators.value = [];
            this.$.indicators.selectedValues = null;
        },
        _cpIndicatorsChanged: function(cpIndicators) {
          if (Array.isArray(this.firstLoadCpIndicators) && this.firstLoadCpIndicators.length &&
              Array.isArray(cpIndicators) && cpIndicators.length) {
            var selectedCpIndicators = cpIndicators.filter(function(indicator) {
              return this.firstLoadCpIndicators.indexOf(indicator.id) > -1;
            }.bind(this));
            // set selected cp indicators (searched by ids) on dropdown
            this.$.indicators.value = selectedCpIndicators;
            this.set('firstLoadCpIndicators', []);
          }
        },

         // prevent having cpoutputs already selected in the current cpOutput selector
        _computeCpOutputsOptions: function(alreadySelectedCpo, cpOutputsLength, selectedCpStructure) {
          if (cpOutputsLength === 0) {
            return;
          }
          console.log('cp outputs', this.cpOutputs, this.selectedCpStructure);
          this.debounce('computeCpOutputsOptions', function() {
            var cpOutputsOptions = this._filterByCpStructure(this.cpOutputs)
            cpOutputsOptions = this._excludeAlreadySelectedInOtherDropdowns(cpOutputsOptions, alreadySelectedCpo);


            // keep old cpOutputs requested from server
            var oldCpOutput = this._getExistingOldCpO();
            if (oldCpOutput) {
              cpOutputsOptions.push(oldCpOutput);
            }
            this.set('cpOutputsOptions', cpOutputsOptions);
          }.bind(this), 50);
        },

        // filter cp outputs and exclude the ones already selected in other dropdowns from expected results section
        _excludeAlreadySelectedInOtherDropdowns: function(cpOutputsOptions, alreadySelectedCpo) {
          return cpOutputsOptions.filter(function(cpO) {
              return alreadySelectedCpo.indexOf(cpO.id) === -1 || cpO.id === this.cpOutputId;
            }.bind(this));
        },
        _filterByCpStructure: function(cpOutputsOptions) {
          //TODO
          // return cpOutputsOptions.filter(function(option) {
          //   return option.country_programme === this.selectedCpStructure;
          // }.bind(this));
          return cpOutputsOptions;
        },
        _getExistingOldCpO: function() {
          var cpoDropdown = this.$.cpOutput;
          var oldCpO;
          if (cpoDropdown.ajaxParams && cpoDropdown.ajaxParams.values) {
            // keep ghost data (old cp output previously requested from server)
            oldCpO = cpoDropdown.options.find(function(opt) {
              return opt[cpoDropdown.optionValue] === cpoDropdown.ajaxParams.values;
            });
          }
          return oldCpO;
        },

        validate: function() {
          var valid = true;
          if (!this.$.cpOutput.validate()) {
            valid = false;
          }
          if (!this.$.indicators.validate()) {
            valid = false;
          }
          return valid;
        },

        resetValidations: function() {
          this.$.cpOutput.invalid = false;
          this.$.indicators.invalid = false;
        }

      });
    })();
  </script>
</dom-module>
