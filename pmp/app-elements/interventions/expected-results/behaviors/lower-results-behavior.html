<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};
  /** @polymerBehavior EtoolsPmpApp.Behaviors.LowerResultsImpl */
  EtoolsPmpApp.Behaviors.LowerResultsImpl = {
    properties: {
      lowerResultNameEditElem: Object,
    },

    listeners: {
      'add-new-lower-result': '_handleAddNewLowerResult',
      'edit-lower-result': '_handleEditLowerResult'
    },

    createLowerResultNameDialog: function() {
      this.lowerResultNameEditElem = Polymer.dom(document.querySelector('body'))
          .querySelector('#pdLowerResultName');
      if (!this.lowerResultNameEditElem) {
        this.lowerResultNameEditElem = document.createElement('pd-lower-result-name');
        this.lowerResultNameEditElem.setAttribute('id', 'pdLowerResultName');
        this.lowerResultNameEditElem.set('toastEventSource', this);
        this.lowerResultNameEditElem.addEventListener('lower-result-saved',
            this._lowerResultSaved.bind(this));
        Polymer.dom(document.querySelector('body')).appendChild(this.lowerResultNameEditElem);
      }
    },

    _getDataIndex: function(id, dataSet) {
      let index = null;
      let resultsLength = dataSet.length;
      for (index = 0; index < resultsLength; index++) {
        if (parseInt(dataSet[index].id, 10) === parseInt(id, 10)) {
          break;
        }
      }
      return index;
    },

    _lowerResultSaved: function(e) {
      e.stopImmediatePropagation();
      if (!e.detail.expectedResultId) {
        this.logError('Can not make changes if expected result ID is not specified.', 'lower-results-behavior');
        return;
      }
      let expectedResultIndex = this._getDataIndex(e.detail.expectedResultId, this.dataItems);
      if (!(expectedResultIndex >= 0)) {
        this.logError('Result with ID: ' + e.detail.expectedResultId + ' not found.', 'lower-results-behavior');
        return;
      }
      if (!e.detail.lowerResultId) {
        this.push(['dataItems', expectedResultIndex, 'll_results'], e.detail.lowerResult);
      } else {
        let lrIndex= this._getDataIndex(e.detail.lowerResultId, this.get(['dataItems', expectedResultIndex,
          'll_results']));
        if (!(lrIndex >= 0)) {
          this.logError('Lower result with ID: ' + e.detail.lowerResultId + ' not found.', 'lower-results-behavior');
          return;
        }
        this.set(['dataItems', expectedResultIndex, 'll_results', lrIndex, 'name'], e.detail.lowerResult.name);
      }
    },

    _handleAddNewLowerResult: function(e) {
      e.stopImmediatePropagation();
      this._openLowerResultNameDialog(null, undefined, e.detail.expectedResultId);
    },

    _handleEditLowerResult: function(e) {
      e.stopImmediatePropagation();
      this._openLowerResultNameDialog(e.detail.lowerResultId, e.detail.lowerResultName, e.detail.expectedResultId);
    },

    _openLowerResultNameDialog: function(lowerResultId, lowerResultName, expectedResultId) {
      if (this.lowerResultNameEditElem) {
        this.lowerResultNameEditElem.resetData();
        this.lowerResultNameEditElem.set('expectedResultId', expectedResultId);
        if (lowerResultId) {
          // edit operation
          this.lowerResultNameEditElem.set('lowerResultId', lowerResultId);
          this.lowerResultNameEditElem.set('lowerResultName', lowerResultName);
        }
        this.lowerResultNameEditElem.openDialog();
      }
    },
  };

  /** @polymerBehavior EtoolsPmpApp.Behaviors.LowerResults */
  EtoolsPmpApp.Behaviors.LowerResults = [
    EtoolsLogsBehavior,
    EtoolsPmpApp.Behaviors.LowerResultsImpl
  ]
</script>
