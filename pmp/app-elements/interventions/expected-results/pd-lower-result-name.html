<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-errors-parser-behavior.html">

<dom-module id="pd-lower-result-name">
  <template>
    <style>
      :host {

      }
      .pd-output-name {
        padding: 0 0 30px;
      }

    </style>

    <etools-dialog id="pdLowerResultNameDialog"
                   size="md"
                   dialog-title="Add/Update PD Output or SSFA expected result"
                   ok-btn-text="Add/Update"
                   disable-confirm-btn="[[disableConfirmBtn]]"
                   keep-dialog-open
                   spinner-text="Saving PD Output or SSFA expected result..."
                   on-confirm-btn-clicked="_saveChanges">

      <div class="pd-output-name">
        <paper-input id="pdLowerResultNameField"
                     label="PD Output or SSFA expected result"
                     placeholder="&#8212;"
                     value="{{lowerResultName}}"
                     required
                     auto-validate
                     error-message="PD Output or SSFA expected result must be specified">
        </paper-input>
      </div>

    </etools-dialog>
  </template>

  <script>
    Polymer({
      is: 'pd-lower-result-name',

      behaviors: [
        EtoolsAjaxRequestBehavior,
        EtoolsPmpApp.Behaviors.Endpoints,
        EtoolsPmpApp.Behaviors.AjaxErrorsParser
      ],

      properties: {
        expectedResultId: Number,
        lowerResultId: Number,
        lowerResultName: {
          type: String,
          value: []
        },
        opened: {
          type: Boolean,
          value: false
        },
        disableConfirmBtn: {
          type: Boolean,
          value: false
        },
        toastEventSource: Object
      },

      openDialog: function() {
        this.$.pdLowerResultNameDialog.set('opened', true);
      },

      closeDialog: function() {
        this.$.pdLowerResultNameDialog.set('opened', false);
      },

      resetData: function() {
        this.set('disableConfirmBtn', false);
        this.set('lowerResultId', null);
        this.set('lowerResultName', undefined);
        this.set('expectedResultId', null);
        this.$.pdLowerResultNameField.invalid = false;
      },

      _saveChanges: function() {
        if (!this.$.pdLowerResultNameField.validate()) {
          return false;
        }
        let lowerResult = {
          name: this.lowerResultName,
          result_link: this.expectedResultId
        };
        if (!lowerResult.result_link) {
          this.logError('Expected result ID is missing! Can not save lower result name.', 'lower-result-name-modal');
          return;
        }

        let endpoint;
        let method;
        if (!this.lowerResultId) {
          endpoint = this.getEndpoint('pdLowerResults', {resultId: lowerResult.result_link});
          method = 'POST';
        } else {
          endpoint = this.getEndpoint('pdLowerResultDetails', {llResultId: this.lowerResultId});
          method = 'PATCH';
        }
        this._saveLowerResult(endpoint, method, lowerResult, this._lowerResultSuccessfullySaved);
      },

      _saveLowerResult: function(endpoint, method, lowerResultData, successCallback) {
        let self = this;
        this.set('disableConfirmBtn', true);
        let dialog = this.$.pdLowerResultNameDialog;
        dialog.startSpinner();
        this.sendRequest({
          method: method,
          endpoint: endpoint,
          body: lowerResultData
        }).then(function(response) {
          dialog.stopSpinner();
          self.set('disableConfirmBtn', false);
          if (typeof successCallback === 'function') {
            successCallback.bind(self, response)();
          }
        }).catch(function(error) {
          dialog.stopSpinner();
          self.set('disableConfirmBtn', false);
          self.parseRequestErrorsAndShowAsToastMsgs(error.response, self.toastEventSource);
        });
      },

      _lowerResultSuccessfullySaved: function(response) {
        let data = {
          lowerResultId: this.lowerResultId,
          expectedResultId: this.expectedResultId,
          lowerResult: response
        };

        this.fire('lower-result-saved', data);
        this.closeDialog();
      }

    });
  </script>
</dom-module>
