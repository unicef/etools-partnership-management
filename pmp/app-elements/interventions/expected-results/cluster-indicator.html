<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import"
      href="../../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">
<link rel="import"
      href="../../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-behavior.html">

<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../common-elements/etools-form-element-wrapper.html">

<link rel="import" href="behaviors/indicators-common-behavior.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/required-field-styles.html">

<dom-module id="cluster-indicator">
  <template strip-whitespace>
    <style include="grid-layout-styles shared-styles required-field-starred-styles">
      paper-input,
      paper-textarea,
      paper-material {
        width: 100%;
      }

    </style>
    <template is="dom-if" if="[[!isNewIndicator]]">
      <div class="row-h flex-c">
        <div class="col col-5">
          <div class="layout-vertical">
            <label class="paper-label">Response Plan</label>
            <label class="input-label" empty$="[[!prpClusterIndicator.responsePlan.name]]">[[prpClusterIndicator.responsePlan.name]]</label>
          </div>
        </div>
        <div class="col col-5">
          <div class="layout-vertical">
            <label class="paper-label">Cluster</label>
            <label class="input-label" empty$="[[!prpClusterIndicator.cluster.name]]">[[prpClusterIndicator.cluster.name]]</label>
          </div>
        </div>
      </div>
      <div class="row-h flex-c">
        <etools-form-element-wrapper no-label-float label="Indicator" required>
          [[prpClusterIndicator.title]]
        </etools-form-element-wrapper>
      </div>
    </template>

    <template is="dom-if" if="[[isNewIndicator]]">
      <div class="row-h flex-c">
        <div class="col col-5">
          <etools-single-selection-menu id$="responsePlanDropdw"
                                    label="Response Plan"
                                    placeholder="&#8212;"
                                    selected="{{responsePlanId}}"
                                    options="[[responsePlans]]"
                                    option-label="title"
                                    option-value="id"
                                    error-message="Please select Response Plan">
          </etools-single-selection-menu>
        </div>
        <div class="col col-5">
          <etools-single-selection-menu id$="clusterDropdw"
                                    label="Cluster"
                                    placeholder="&#8212;"
                                    selected="{{clusterId}}"
                                    options="[[clusters]]"
                                    option-label="type"
                                    option-value="id"
                                    error-message="Please select Cluster"
                                    on-iron-activate="_onClusterChange">
          </etools-single-selection-menu>
        </div>
      </div>
      <div class="row-h flex-c">
        <etools-single-selection-menu id="clusterIndicatorEl"
                                    label="Indicator"
                                    placeholder="&#8212;"
                                    selected="{{indicator.cluster_indicator_id}}"
                                    selected-item="{{prpClusterIndicator}}"
                                    options="[[prpClusterIndicators]]"
                                    option-label="blueprint.title"
                                    option-value="id"
                                    required
                                    auto-validate
                                    error-message="Please select Indicator">
        </etools-single-selection-menu>
      </div>
    </template>
    <div class="row-h flex-c">
      <div class="col col-2">
        <div class="layout-vertical">
          <paper-input label="Baseline"
                      value="{{indicator.baseline}}"
                      type="number"
                      placeholder="&#8212;">
          </paper-input>
        </div>
      </div>
      <div class="col col-3">
         <paper-input label="Target"
                      value="{{indicator.target}}"
                      type="number"
                      placeholder="&#8212;">
          </paper-input>
      </div>
    </div>
    <div class="row-h flex-c">
      <div class="layout-vertical">
        <label class="paper-label">Means of Verification</label>
        <label class="input-label" empty$="[[!indicator.means_of_verification]]">[[indicator.means_of_verification]]</label>
      </div>
    </div>
    <div class="row-h flex-c">
      <etools-multi-selection-menu id$="locationsDropdw"
                                   label="Locations"
                                   placeholder="&#8212;"
                                   selected-values="{{indicator.locations}}"
                                   options="[[locations]]"
                                   option-label="name"
                                   option-value="id"
                                   error-message="Please select locations">
      </etools-multi-selection-menu>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'cluster-indicator',

        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
          EtoolsPmpApp.Behaviors.IndicatorsCommonBehavior,
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsLogsBehavior
        ],

        properties: {
          indicator: {
            type: Object,
            observer: 'indicatorChanged'
          },
          isNewIndicator: {
            type: Boolean
          },
          clusters: {
            type: Array
          },
          locations: {
            type: Array,
            statePath: 'locations'
          },
          responsePlanId: {
            type: String,
            observer: '_responsePlanIdChanged'
          },
          clusterId: {
            type: String,
            observer: '_clusterIdChanged'
          },
          prpClusterIndicators: {
            type: Array,
            value: function() {
              return [
                    {
                        "id": 108,
                        "target": "5000",
                        "baseline": "0",
                        "blueprint": {
                            "id": 108,
                            "title": "quantity_indicator_107",
                            "unit": "number",
                            "display_type": "number",
                            "calculation_formula_across_periods": "sum",
                            "calculation_formula_across_locations": "sum"
                        },
                        "pd_id": "",
                        "ref_num": "",
                        "achieved": {
                            "c": 2096,
                            "d": 1,
                            "v": 2096
                        },
                        "progress_percentage": 0.4192,
                        "content_type_name": "cluster activity",
                        "content_object_title": "2 - workspace_0 2017 Humanitarian Response Plan - WASH CO Cluster Activity",
                        "object_id": 108,
                        "disaggregations": [
                            {
                                "id": 4,
                                "name": "gender",
                                "active": true,
                                "response_plan": 1,
                                "choices": [
                                    {
                                        "id": 14,
                                        "value": "male",
                                        "active": true
                                    },
                                    {
                                        "id": 15,
                                        "value": "female",
                                        "active": true
                                    },
                                    {
                                        "id": 16,
                                        "value": "other",
                                        "active": true
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "id": 107,
                        "target": "5000",
                        "baseline": "0",
                        "blueprint": {
                            "id": 107,
                            "title": "quantity_indicator_106",
                            "unit": "number",
                            "display_type": "number",
                            "calculation_formula_across_periods": "max",
                            "calculation_formula_across_locations": "max"
                        },
                        "pd_id": "",
                        "ref_num": "",
                        "achieved": {
                            "c": 2969,
                            "d": 1,
                            "v": 2969
                        },
                        "progress_percentage": 0.5938,
                        "content_type_name": "cluster activity",
                        "content_object_title": "2 - workspace_0 2017 Humanitarian Response Plan - WASH CO Cluster Activity",
                        "object_id": 107,
                        "disaggregations": [
                            {
                                "id": 5,
                                "name": "age",
                                "active": true,
                                "response_plan": 1,
                                "choices": [
                                    {
                                        "id": 17,
                                        "value": "1-2m",
                                        "active": true
                                    },
                                    {
                                        "id": 18,
                                        "value": "3-4m",
                                        "active": true
                                    },
                                    {
                                        "id": 19,
                                        "value": "5-6m",
                                        "active": true
                                    },
                                    {
                                        "id": 20,
                                        "value": "7-10m",
                                        "active": true
                                    },
                                    {
                                        "id": 21,
                                        "value": "11-13m",
                                        "active": true
                                    },
                                    {
                                        "id": 22,
                                        "value": "14-16m",
                                        "active": true
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "id": 106,
                        "target": "5000",
                        "baseline": "0",
                        "blueprint": {
                            "id": 106,
                            "title": "quantity_indicator_105",
                            "unit": "number",
                            "display_type": "number",
                            "calculation_formula_across_periods": "avg",
                            "calculation_formula_across_locations": "avg"
                        },
                        "pd_id": "",
                        "ref_num": "",
                        "achieved": {
                            "c": 1337.5,
                            "d": 1,
                            "v": 1337.5
                        },
                        "progress_percentage": 0.2675,
                        "content_type_name": "cluster activity",
                        "content_object_title": "1 - workspace_0 2017 Humanitarian Response Plan - WASH CO Cluster Activity",
                        "object_id": 106,
                        "disaggregations": [
                            {
                                "id": 6,
                                "name": "height",
                                "active": true,
                                "response_plan": 1,
                                "choices": [
                                    {
                                        "id": 23,
                                        "value": "tall",
                                        "active": true
                                    },
                                    {
                                        "id": 24,
                                        "value": "medium",
                                        "active": true
                                    },
                                    {
                                        "id": 25,
                                        "value": "short",
                                        "active": true
                                    },
                                    {
                                        "id": 26,
                                        "value": "extrashort",
                                        "active": true
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "id": 105,
                        "target": "5000",
                        "baseline": "0",
                        "blueprint": {
                            "id": 105,
                            "title": "quantity_indicator_104",
                            "unit": "number",
                            "display_type": "number",
                            "calculation_formula_across_periods": "max",
                            "calculation_formula_across_locations": "sum"
                        },
                        "pd_id": "",
                        "ref_num": "",
                        "achieved": {
                            "c": 0,
                            "d": 0,
                            "v": 857
                        },
                        "progress_percentage": 0.0,
                        "content_type_name": "cluster activity",
                        "content_object_title": "1 - workspace_0 2017 Humanitarian Response Plan - WASH CO Cluster Activity",
                        "object_id": 105,
                        "disaggregations": []
                    }
              ];
            }
          },
          responsePlans: {
            type: Array,
            value: function() {
              return [
              {
            "id": 3,
            "title": "workspace_0 2015 Humanitarian Response Plan",
            "plan_type": "HRP",
            "start": "2017-01-01",
            "end": "2017-01-31",
            "workspace": 1,
            "documents": [],
            "clusters": [
                {
                    "id": 7,
                    "type": "wash"
                },
                {
                    "id": 8,
                    "type": "nutrition"
                },
                {
                    "id": 9,
                    "type": "education"
                }
            ]
        },
        {
            "id": 2,
            "title": "workspace_0 2016 Humanitarian Response Plan",
            "plan_type": "HRP",
            "start": "2017-01-01",
            "end": "2017-01-31",
            "workspace": 1,
            "documents": [],
            "clusters": [
                {
                    "id": 4,
                    "type": "wash"
                },
                {
                    "id": 5,
                    "type": "nutrition"
                },
                {
                    "id": 6,
                    "type": "education"
                }
            ]
        },
        {
            "id": 1,
            "title": "workspace_0 2017 Humanitarian Response Plan",
            "plan_type": "HRP",
            "start": "2017-01-01",
            "end": "2017-01-31",
            "workspace": 1,
            "documents": [],
            "clusters": [
                {
                    "id": 1,
                    "type": "wash"
                },
                {
                    "id": 2,
                    "type": "nutrition"
                },
                {
                    "id": 3,
                    "type": "education"
                }
            ]
           }
              ];
            }
          },
          prpClusterIndicator: {
            type: Object,
            observer: '_selectedPrpClusterIndicatorChanged'
          },
          prpDisaggregations: {
            type: Array,
            notify: true
          },
          currentUser: {
            type: Object,
            statePath: 'currentUser',
          }
        },

        observers: [
          '_baselineChanged(indicator.baseline)',
          '_targetChanged(indicator.target)',
          '_populatePrpClusterIndicators(responsePlanId, clusterId)'
        ],
        ready: function() {
          if (!this.currentUser.profile.country) {
            this.logWarn('User.profile.country is empty');
            return;
          }
          let self = this;
          this.sendRequest({
            method: 'GET',
            endpoint: this.getEndpoint('getResponsePlans', {id: this.currentUser.profile.country})
          }).then(function(response) {
            self.responsePlans = response;
          }).catch(function(error) {
            console.log(error);
            self.fire('show-toast', {error: error.response});
          });
        },
        indicatorChanged: function(indicator) {
          if (!indicator || !indicator.id) { // on new
            this.set('isNewIndicator', true);
          } else { // on edit
            this.set('isNewIndicator', false);
            this._getPrpClusterIndicator(indicator.cluster_indicator_id);
          }
        },
        _responsePlanIdChanged: function(responsePlanId) {
          console.log('_responsePlanIdChanged', responsePlanId);
          this._populateClusters(responsePlanId);
        },
        _populateClusters: function(selectedRespPlanId) {
          if (!selectedRespPlanId) {
            this.clusters = [];
            return;
          }
          this.clusters = this.responsePlans.filter(function(r){
            return parseInt(r.id) === parseInt(selectedRespPlanId);
          })[0].clusters;
        },
        _onClusterChange: function(event) {
          if (!event.detail.item.item) {
            return;
          }
          this.indicator.cluster_name = event.detail.item.item.name;
        },
        _clusterIdChanged: function(clusterId) {
          this._populatePrpClusterIndicators(clusterId);
        },
        _populatePrpClusterIndicators: function(clusterId) {
          if (!clusterId) {
            return;
          }
          this.fire('start-spinner', {spinnerText: 'Loading PRP cluster indicators..'});
          let self = this;
          this.sendRequest({
            method: 'GET',
            endpoint: this.getEndpoint('getPrpClusterIndicators', {id: clusterId})
          }).then(function(response) {
            self.prpClusterIndicators = response.results;
            self.fire('stop-spinner');
          }).catch(function(error) {
            self.fire('stop-spinner');
            self.fire('show-toast', {error: error.response});
          });
        },
        _getPrpClusterIndicator: function(clusterIndicId) {
          this.fire('start-spinner', {spinnerText: 'Loading PRP cluster indicator..'});
          let self = this;
          this.sendRequest({
            endpoint: this.getEndpoint('getPrpClusterIndicator', {id: clusterIndicId}),
            method: 'GET'
          }).then(function(response) {
            self.prpClusterIndicator = response;
            self.fire('stop-spinner');
          }).catch(function(error) {
            self.fire('stop-spinner');
            self.fire('show-toast', {error: error.response});
          });
        },
        _selectedPrpClusterIndicatorChanged: function(prpClusterIndic) {
          if (!prpClusterIndic) {
            this.set('prpDisaggregations', []);
            return;
          }

          this.set('indicator.cluster_indicator_title', prpClusterIndic.title);
          this.set('prpDisaggregations', prpClusterIndic.disaggregations);
        },

        validate: function() {
          return this.$$('#clusterIndicatorEl').validate();
        },
        resetValidations: function() {
          this.$$('#clusterIndicatorEl').invalid = false;
        }
    });
  })();
  </script>
</dom-module>
