<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">
<link rel="import" href="../../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">

<link rel="import" href="../../../../bower_components/etools-dialog/etools-dialog.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/page-layout-styles.html">
<link rel="import" href="../../../../scripts/lodash/lodash.html">

<link rel="import" href="indicator-dissaggregations.html">
<link rel="import" href="cluster-indicator-disaggregations.html">
<link rel="import" href="cluster-indicator.html">
<link rel="import" href="non-cluster-indicator.html">

<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-errors-parser-behavior.html">


<dom-module id="indicator-dialog">
  <template strip-whitespace>
    <style include="page-layout-styles grid-layout-styles shared-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        --etools-dialog-scrollable: {
          margin-top: 10px !important;
        };
      }
      paper-input,
      paper-textarea,
      paper-material {
        width: 100%;
      }

      .indicator-content {
        margin: 16px 24px;
        margin-bottom: 40px;
        border : solid 1px var(--dark-divider-color);
        overflow-x: hidden; /*To avoid horizontal scroll in IE11 */
      }
      etools-dialog {
        --paper-dialog: {
          overflow-y: auto;
        }
      }

    </style>

    <etools-dialog id="indicatorDialog" size="lg" dialog-title="Indicator"
     on-close="_cleanUp"
     on-confirm-btn-clicked="_validateAndSaveIndicator" no-padding
     ok-btn-text="Save" keep-dialog-open>
     <div>
        <div class="page-top-content in-modal">
          <div class="top-content-row">
            <paper-tabs id="indicatorTabs"
                selected="{{activeTab}}"
                attr-for-selected="name"
                noink bottom-item>
              <paper-tab name="details" link>
                <span class="tab-content">DETAILS</span>
              </paper-tab>

              <paper-tab name="disaggregations" link>
                <span class="tab-content">[[_getDisaggregationsTabTitle(disaggregationsCount) ]]</span>
              </paper-tab>
            </paper-tabs>
          </div>
        </div>

        <iron-pages id="indicatorPages"
                      selected="{{activeTab}}"
                      attr-for-selected="name"
                      fallback-selection="details">
          <div name="details">
            <div class="row-h flex-c" >
              <div class="col col-4">
                <etools-single-selection-menu id$="sectionDropdw"
                                              label="Section"
                                              selected="{{indicator.section}}"
                                              placeholder="&#8212;"
                                              options="[[sections]]"
                                              option-label="name"
                                              option-value="id">
                </etools-single-selection-menu>
              </div>
            </div>
            <div class="row-h" >
              <paper-toggle-button disabled="[[!_indicatorIsNew(indicator)]]" checked="{{isCluster}}"></paper-toggle-button> Cluster Indicator
            </div>
            <div class="indicator-content">
              <div id="newLayout" >
                <template is="dom-if" if="[[!isCluster]]" >
                  <non-cluster-indicator id="nonClusterIndicatorEl" indicator="{{indicator}}"> </non-cluster-indicator>
                </template>
                <template is="dom-if" if="[[isCluster]]" >
                  <cluster-indicator id="clusterIndicatorEl" indicator="{{indicator}}" prp-cluster-indicator="{{prpClusterIndicator}}"></cluster-indicator>
                </template>
              </div>
            </div>
          </div>
          <div class="row-h flex-c" name="disaggregations">
              <div hidden>If disaggregation groups that you need are not pre-defined yet, you can create them here.</div>
              <template is="dom-if" if="[[!isCluster]]" restamp>
                <indicator-dissaggregations data-items="{{disaggregations}}">
                </indicator-dissaggregations>
              </template>
              <template is="dom-if" if="[[isCluster]]" restamp>
                <cluster-indicator-disaggregations disaggregations="[[prpDisaggregations]]">
                </cluster-indicator-disaggregations>
              </template>
          </div>
        </iron-pages>
      </div>

    </etools-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'indicator-dialog',

        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsPmpApp.Behaviors.AjaxErrorsParser,
          EtoolsAjaxRequestBehavior
        ],

        properties: {
          indicator: {
            type: Object,
            observer: 'indiChanged'
          },
          indicatorId: {
            type: String
          },
          activeTab: {
            type: String,
            valus: 'details',
          },
          // indicatorModel: {
          //   type: Object,
          //   value: {
          //     id: null,
          //     isCluster: false,
          //     name: null,
          //     baseline: null,
          //     target: null,
          //     means_of_verification: null,
          //     unit: 'numeric',
          //     displayUnit: 'percentage',
          //     disaggregation_logic: null,
          //     sectionId: null,
          //     baselineIsUnknown: false,
          //     clusterIndicatorId: null,
          //     clusterId: null,
          //     responsePlanId: null,
          //     locationIds: null
          //   }
          // },
          indicatorModel: {
            type: Object,
            value: {
              id: null,
              indicator: {
                id: null,
                title: null,
                unit: 'number',
                display_type: 'percentage'
              },
              section: null,
              baseline: null,
              target: null,
              means_of_verification: null,
              locations: []
            }
          },
          nonClusterIndicatorCreateModel: {
            type: Object,
            value: {
              id: null,
              indicator: {
                id: null,
                title: null,
                unit: 'number',
                display_type: 'percentage'
              },
              section: null,
              baseline: null,
              target: null,
              means_of_verification: null,
              locations: [],
              dsaggregation: []
            }
          },
          nonClusterIndicatorEditModel: {
             type: Object,
             value: {
              id: null,
              section: null,
              baseline: null,
              target: null,
              means_of_verification: null,
              locations: [],
              disaggregation: []
            }
          },
          clusterIndicatorCreateModel: {
            type: Object
          },
          clusterIndicatorEditModel: {
            type: Object
          },
          actionParams: {
            type: Object
          },
          disaggregations: {
            type: Array,
            value: []
          },
          prpDisaggregations: {
            type: Array,
            value: []
          },
          disaggregationsCount: {
            type: Number,
            value: 0
          },
          sections: {
            type: Array,
            statePath: 'sections'
          },
          prpClusterIndicator: {
            type: Object,
            observer: '_prpClusterIndicatorChanged'
          },
          isCluster: {
            type: Boolean,
            value: false
          },
          toastEventSource: Object
        },
        observers: [
          '_setDisaggregationsCount(disaggregations, disaggregations.length, prpDisaggregations, prpDisaggregations.length, isCluster)'
        ],
        indiChanged: function(newi, oldi) {
          if (!newi) {
            console.trace();
            console.log('Indicator is empty');
          }
        },
        _indicatorIsNew: function(indicator) {
          return (!indicator || !indicator.id);
        },
        _prpClusterIndicatorChanged: function(prpClusterIndicator) {
          console.log('cluster ind changed', prpClusterIndicator);
          if (!prpClusterIndicator || !prpClusterIndicator.disaggregations
           || !prpClusterIndicator.disaggregations.length) {
            this.prpDisaggregations = [];
          } else {
            this.prpDisaggregations = prpClusterIndicator.disaggregations;
          }
        },
        _setDisaggregationsCount: function(disaggregs, disaggregsLength, prpDisaggregs, prpDisaggregsLength) {
          if (!this.indicator) {
            return;
          }
          if (this.isCluster) {
            this.disaggregationsCount = prpDisaggregsLength;
          } else {
            this.disaggregationsCount = disaggregsLength;
          }

        },
        _getDisaggregationsTabTitle: function(disaggregationsCount) {
          return 'DISAGGREGATIONS (' + disaggregationsCount + ')';
        },

        // _getActiveUnit: function() {
        //   var unit = 'numeric';
        //   for (var k in this.unit) {
        //     if (this.unit[k] === true) {
        //       unit = k;
        //     }
        //   }
        //   return unit;
        // },

        openIndicatorDialog: function() {
          this.activeTab = 'details';
          this.$.indicatorDialog.opened = true;
        },

        setTitle: function(title) {
          this.$.indicatorDialog.dialogTitle = title;
        },

        setIndicatorData: function(data, actionParams) {
           this.set('actionParams', actionParams); //actionParams wtf?

          if (!data) { //new indicator
            this.set('indicator', JSON.parse(JSON.stringify(this.indicatorModel)));
            this.isCluster = false;
            return;
          }

          this.isCluster = !!data.cluster_id;

          // set unit
          // for (var k in this.unit) {
          //   if (k !== data.unit) {
          //     this.set('unit.' + k, false);
          //   } else {
          //     this.set('unit.' + k, true);
          //   }
          // }
          // set disaggregations !!!! TODO !!!
          // if (data.disaggregation_logic && typeof data.disaggregation_logic === 'object') {
          //   var disaggregationsKeys = Object.keys(data.disaggregation_logic);
          //   this.set('disaggregations', []);
          //   if (disaggregationsKeys.length) {
          //     disaggregationsKeys.forEach(function(key) {
          //       this.push('disaggregations', {
          //         disaggregate_by: key,
          //         disaggregation_groups: data.disaggregation_logic[key].join(';')
          //       });
          //     }.bind(this));
          //   }
          // }
          this.set('indicator', data);
        },
        _cleanUp: function() {
          this._stopSpinner();
          //Anything else?
        },
        _stopSpinner: function() {
          this.$.indicatorDialog.stopSpinner();
        },
        _validateAndSaveIndicator: function(event) {
          if (!this.validate()) {
            return;
          }

          this.$.indicatorDialog.startSpinner();

          let endpoint = this.getEndpoint(this._getEndpointName(), {id: this._getIdForEndpoint()});
          let method = this.indicator.id ? 'PATCH': 'POST';
          let body = this._getIndicatorBody();
          let self = this;

          this.sendRequest({
            endpoint: endpoint,
            method: method,
            body: body
          }).then(function(resp) {
            self._handleSaveIndicatorResponse(resp);
          }).catch(function(error) {
            self._handleSaveIndicatorError(error.response);
          });

          //TODO this.indicator.disaggregation_logic = this._prepareDisaggregations();
        },
        validate: function() {
          var valid = true;
          if (this.isCluster) {
            valid = this.$$('#clusterIndicatorEl').validate();
          } else {
             valid = this.$$('#nonClusterIndicatorEl').validate();
          }
          return valid;
        },
        _getIdForEndpoint: function() {
          return this.indicator.id ? this.indicator.id : this.actionParams.llResultId;
        },
        _getEndpointName: function() {
          return this.indicator.id ? 'getEditDeleteIndicator' : 'createIndicator';
        },
        _handleSaveIndicatorResponse: function(response) {
          console.log('response', response);
          this._stopSpinner();
          this.fire('indicator-dialog-close', {
            indicatorData: response,
            actionParams: this.actionParams
          });
          this.$.indicatorDialog.opened = false;
        },
        _handleSaveIndicatorError: function(error) {
          this._stopSpinner();
          let errorMsg = this.formatServerErrorAsText(error);
          this.parseRequestErrorsAndShowAsToastMsgs(error, this.toastEventSource);
          console.log('error', error);
        },
        _getIndicatorBody: function() {
           let body = this._getIndicatorModelForSave();
           Object.assign(body, _.pick(this.indicator, _.keys(body)));
           return body;
        },
        _getIndicatorModelForSave: function() {
          let modelName = this.isCluster ? 'clusterIndicator' : 'nonClusterIndicator';
          modelName += this.indicator.id ? 'EditModel' : 'CreateModel';
          return JSON.parse(JSON.stringify(this[modelName]));
        },

        _prepareDisaggregations: function() {
          if (Array.isArray(this.disaggregations) && this.disaggregations.length > 0) {
            var disaggregationsObj = {};
            this.disaggregations.forEach(function(d) {
              var groups = d.disaggregation_groups.split(';').map(function(g) {
                return g.trim();
              });
              disaggregationsObj[d.disaggregate_by] = groups;
            });
            return disaggregationsObj;
          }
          return null;
        },

        resetValidations: function() {
           if (this.isCluster) {
            this.$$('#clusterIndicatorEl').resetValidations();
          } else {
            this.$$('#nonClusterIndicatorEl').resetValidations();
          }
        }

      });
    })();
  </script>
</dom-module>

