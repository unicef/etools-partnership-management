<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import"
      href="../../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">
<link rel="import" href="../../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">

<link rel="import" href="../../../../bower_components/etools-dialog/etools-dialog.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/page-layout-styles.html">
<link rel="import" href="../../../../scripts/lodash/lodash.html">

<link rel="import" href="indicator-dissaggregations.html">
<link rel="import" href="cluster-indicator-disaggregations.html">
<link rel="import" href="cluster-indicator.html">
<link rel="import" href="non-cluster-indicator.html">
<link rel="import" href="behaviors/save-indicator-behavior.html">

<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="indicator-dialog">
  <template strip-whitespace>
    <style include="page-layout-styles grid-layout-styles shared-styles">
      [hidden] {
        display: none !important;
      }

      paper-input,
      paper-textarea,
      paper-material {
        width: 100%;
      }

      .indicator-content {
        margin: 16px 24px;
        margin-bottom: 40px;
        border: solid 1px var(--dark-divider-color);
        overflow-x: hidden; /*To avoid horizontal scroll in IE11 */
      }

      .createDisaggreg {
        color: var(--secondary-text-color);
        padding: 8px 0;
        font-weight: 500;
        font-size: 16px !important;
      }

      a {
        color: var(--primary-color);
      }

    </style>

    <etools-dialog id="indicatorDialog" size="lg" dialog-title="Indicator"
                   on-close="_cleanUp" no-padding
                   on-confirm-btn-clicked="_validateAndSaveIndicator"
                   ok-btn-text="Save" keep-dialog-open disable-confirm-btn="[[disableConfirmBtn]]"
                   spinner-text="[[spinnerText]]">
      <div class="page-top-content in-modal">
        <div class="top-content-row">
          <paper-tabs id="indicatorTabs"
                      selected="{{activeTab}}"
                      attr-for-selected="name"
                      on-selected-changed="_centerDialog"
                      noink bottom-item>
            <paper-tab name="details" link>
              <span class="tab-content">DETAILS</span>
            </paper-tab>

            <paper-tab name="disaggregations" link>
              <span class="tab-content">[[_getDisaggregationsTabTitle(disaggregationsCount) ]]</span>
            </paper-tab>
          </paper-tabs>
        </div>
      </div>

      <iron-pages id="indicatorPages"
                  selected="{{activeTab}}"
                  attr-for-selected="name"
                  fallback-selection="details">
        <div name="details">
          <div class="row-h flex-c">
            <div class="col col-4">
              <etools-single-selection-menu id$="sectionDropdw"
                                            label="Section"
                                            selected="{{indicator.section}}"
                                            placeholder="&#8212;"
                                            options="[[sections]]"
                                            option-label="name"
                                            option-value="id">
              </etools-single-selection-menu>
            </div>
          </div>
          <div class="row-h">
            <paper-toggle-button disabled="[[!_indicatorIsNew(indicator)]]"
                                 checked="{{isCluster}}"></paper-toggle-button>
            Cluster Indicator
          </div>
          <div class="indicator-content">
            <template is="dom-if" if="[[!isCluster]]">
              <non-cluster-indicator id="nonClusterIndicatorEl" indicator="{{indicator}}"></non-cluster-indicator>
            </template>
            <template is="dom-if" if="[[isCluster]]">
              <cluster-indicator id="clusterIndicatorEl" indicator="{{indicator}}"
                                 prp-disaggregations="{{prpDisaggregations}}"></cluster-indicator>
            </template>
          </div>
        </div>
        <div class="row-padding" name="disaggregations">
          <div hidden$="[[isCluster]]" class="createDisaggreg">If disaggregation groups that you need are not
            pre-defined yet, you can create them <a href="/pmp/settings" target="_blank">here</a>.
          </div>
          <template is="dom-if" if="[[!isCluster]]" restamp>
            <indicator-dissaggregations data-items="{{disaggregations}}">
            </indicator-dissaggregations>
          </template>
          <template is="dom-if" if="[[isCluster]]" restamp>
            <cluster-indicator-disaggregations disaggregations="[[prpDisaggregations]]">
            </cluster-indicator-disaggregations>
          </template>
        </div>
      </iron-pages>

    </etools-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'indicator-dialog',

        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
          EtoolsPmpApp.Behaviors.SaveIndicator
        ],

        properties: {
          indicator: {
            type: Object
          },
          activeTab: {
            type: String,
            value: 'details',
          },
          indicatorModel: {
            type: Object,
            value: {
              id: null,
              indicator: {
                id: null,
                title: null,
                unit: 'number',
                display_type: 'percentage'
              },
              section: null,
              baseline: null,
              target: null,
              means_of_verification: null,
              locations: [],
              disaggregation: []
            }
          },
          actionParams: {
            type: Object
          },
          disaggregations: {
            type: Array,
            value: []
          },
          prpDisaggregations: {
            type: Array,
            value: []
          },
          disaggregationsCount: {
            type: Number,
            value: 0
          },
          sections: {
            type: Array,
            statePath: 'sections'
          },
          isCluster: {
            type: Boolean,
            value: false
          },
          toastEventSource: Object,
          disableConfirmBtn: {
            type: Boolean,
            value: false
          },
          spinnerText: {
            type: String,
            value: 'Saving indicator..'
          }
        },
        listeners: {
          'start-spinner': '_startSpinner',
          'stop-spinner': '_stopSpinner',
          'show-toast': '_showToast'
        },
        observers: [
          '_setDisaggregationsCount1(disaggregations, prpDisaggregations, isCluster)',
          '_setDisaggregationsCount2(disaggregations.length, prpDisaggregations.length)',
        ],

        _indicatorIsNew: function(indicator) {
          return (!indicator || !indicator.id);
        },

        _setDisaggregationsCount1: function(disaggregs, prpDisaggregs) {
          if (!this.indicator || !disaggregs || !prpDisaggregs) {
            this.disaggregationsCount = 0;
            return;
          }
          this._setDisaggregationsCount2(disaggregs.length, prpDisaggregs.length);

        },
        _setDisaggregationsCount2: function(disaggregsLength, prpDisaggregsLength) {
          if (this.isCluster) {
            this.disaggregationsCount = prpDisaggregsLength;
          } else {
            this.disaggregationsCount = disaggregsLength;
          }
        },

        _getDisaggregationsTabTitle: function(disaggregationsCount) {
          return 'DISAGGREGATIONS (' + disaggregationsCount + ')';
        },

        openIndicatorDialog: function() {
          this.activeTab = 'details';
          this.disableConfirmBtn = false;
          this.$.indicatorDialog.opened = true;
        },

        setTitle: function(title) {
          this.$.indicatorDialog.dialogTitle = title;
        },

        setIndicatorData: function(data, actionParams) {
          this.set('actionParams', actionParams);

          if (!data) { //new indicator
            this.set('indicator', JSON.parse(JSON.stringify(this.indicatorModel)));
            this.isCluster = false;
            return;
          }

          this.isCluster = !!data.cluster_indicator_id;
          this.set('indicator', data);
          if (!this.isCluster) {
            this.set('disaggregations', this._convertToArrayOfObj(this.indicator.disaggregation));
          }
        },
        //* For dom-repeat to work ok
        _convertToArrayOfObj: function(disaggregations) {
          if (!disaggregations) {
            return [];
          }
          return disaggregations.map(function(id) {
            /**
             * disaggregId and not simply id to avoid repeatable-behavior
             * from trying to make an endpoint request on Delete
             */
            return {disaggregId: id};
          });
        },
        _cleanUp: function() {
          this._stopSpinner();
          this.disableConfirmBtn = false;
          this.resetFields();
          //Anything else?
        },
        _stopSpinner: function(e) {
          if (e) {
            e.stopImmediatePropagation();
          }
          this.$.indicatorDialog.stopSpinner();
          this.spinnerText = 'Saving indicator..';
        },
        _startSpinner: function(e) {
          if (e) {
            e.stopImmediatePropagation();
            this.set('spinnerText', e.detail.spinnerText);
          }
          this.$.indicatorDialog.startSpinner();
        },
        _showToast: function(e) {
          this.showErrorAsToastMsg(e.detail.error, this.toastEventSource);
        },

        resetValidations: function() {
          if (this.isCluster) {
            this.$$('#clusterIndicatorEl').resetValidations();
          } else {
            this.$$('#nonClusterIndicatorEl').resetValidations();
          }
        },
        resetFields: function() {
          this.indicator = null;
          this.disaggregations = [];
          this.prpDisaggregations = [];
        },

        _centerDialog: function() {
          this.$.indicatorDialog.notifyResize();
        },

      });
    })();
  </script>
</dom-module>

