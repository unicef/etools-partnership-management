<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../bower_components/etools-checkable-input/etools-checkable-input.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">

<link rel="import" href="indicator-dissaggregations.html">

<dom-module id="indicator-dialog">
  <template>
    <style include="grid-layout-styles shared-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        --etools-checkable-input-label: {
          font-size: 14px;
        };
      }

      etools-checkable-input:not(:last-of-type) {
        margin-right: 30px;
      }
      paper-input,
      paper-textarea,
      paper-material {
        width: 100%;
      }

      paper-material {
        padding: 0;
      }
      paper-material paper-toolbar {
        --paper-toolbar-height: 40px;
        --paper-toolbar-background: var(--medium-theme-background-color);
        --paper-toolbar: {
          -webkit-border-radius: 8px;
          -moz-border-radius: 8px;
          border-radius: 8px;
        };
        --paper-toolbar-title: {
          @apply(--nested-content-panel-title);
          margin-left: 0;
        };
      }

      #indicator-content {
        max-height: 600px;
        overflow-y: auto;
        margin: 0 -20px;
        padding: 0 15px;
      }

      .dissaggregation {
        margin: 25px 0;
      }

    </style>

    <etools-dialog id="indicatorDialog" size="lg" dialog-title="Indicator" on-close="_closeIndicatorDialog">
      <div id="indicator-content">
        <div class="row-h flex-c">
          <etools-checkable-input type="radio" label="#" label-alignment="right"
                                  checked="{{unit.numeric}}"
                                  on-tap="_unitChanged"
                                  data-unit-to-reset="yesno,percentage"></etools-checkable-input>
          <etools-checkable-input type="radio" label="%" label-alignment="right"
                                  checked="{{unit.percentage}}"
                                  on-tap="_unitChanged"
                                  data-unit-to-reset="numeric,yesno"></etools-checkable-input>
          <etools-checkable-input type="radio" label="Yes / No" label-alignment="right"
                                  checked="{{unit.yesno}}"
                                  on-tap="_unitChanged"
                                  data-unit-to-reset="numeric,percentage"></etools-checkable-input>
        </div>

        <div class="row-h flex-c">
          <paper-input label="Indicator" value="{{indicator.name}}" placeholder="&#8212;"></paper-input>
        </div>

        <div class="row-h flex-c">
          <div class="col col-3">
            <template is="dom-if" if="[[unit.numeric]]">
              <paper-input label="Baseline"
                           value="{{indicator.baseline}}"
                           type="number"
                           placeholder="&#8212;">
              </paper-input>
            </template>
            <template is="dom-if" if="[[unit.percentage]]">
              <paper-input label="Baseline"
                           value="{{indicator.baseline}}"
                           type="number"
                           min="0"
                           max="100"
                           allowed-pattern="[0-9\.]"
                           placeholder="&#8212;">
              </paper-input>
            </template>
            <template is="dom-if" if="[[unit.yesno]]">
              <paper-dropdown-menu label="Baseline" noink always-float-label>
                <paper-menu class="dropdown-content"
                            attr-for-selected="name"
                            selected="{{indicator.baseline}}">
                  <paper-item name="yes">Yes</paper-item>
                  <paper-item name="no">No</paper-item>
                </paper-menu>
              </paper-dropdown-menu>
            </template>
          </div>
          <div class="col col-3">
            <template is="dom-if" if="[[unit.numeric]]">
              <paper-input label="Target"
                           value="{{indicator.target}}"
                           type="number"
                           placeholder="&#8212;">
              </paper-input>
            </template>
            <template is="dom-if" if="[[unit.percentage]]">
              <paper-input label="Target"
                           value="{{indicator.target}}"
                           type="number"
                           min="0"
                           max="100"
                           allowed-pattern="[0-9\.]"
                           placeholder="&#8212;">
              </paper-input>
            </template>
            <template is="dom-if" if="[[unit.yesno]]">
              <paper-dropdown-menu label="Target" noink always-float-label>
                <paper-menu class="dropdown-content"
                            attr-for-selected="name"
                            selected="{{indicator.target}}">
                  <paper-item name="yes">Yes</paper-item>
                  <paper-item name="no">No</paper-item>
                </paper-menu>
              </paper-dropdown-menu>
            </template>
          </div>
          <div class="col col-6">
            <paper-textarea label="Means of Verification"
                            value="{{indicator.means_of_verification}}"
                            placeholder="&#8212;">
            </paper-textarea>
          </div>
        </div>

        <div class="row-h flex-c dissaggregation">
          <paper-material elevation="0">
            <paper-toolbar>
              <div class="title">Dissaggregation</div>
            </paper-toolbar>
            <indicator-dissaggregations data-items="{{disaggregations}}"
                                        on-disaggregation-change="_centerDialog">
            </indicator-dissaggregations>
          </paper-material>
        </div>
      </div>
    </etools-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'indicator-dialog',

        properties: {
          indicator: {
            type: Object
          },
          indicatorModel: {
            type: Object,
            value: {
              id: null,
              name: null,
              baseline: null,
              target: null,
              means_of_verification: null,
              unit: 'numeric',
              disaggregation_logic: null
            }
          },
          actionParams: {
            type: Object
          },
          unit: {
            type: Object,
            value: {
              numeric: true,
              percentage: false,
              yesno: false
            }
          },
          disaggregations: {
            type: Array,
            value: []
          }
        },
        observers: [
          '_indicatorDataChange(indicator.*)',
          '_updateIndicatorValsAtUnitChange(unit.*)'
        ],

        _indicatorDataChange: function(data) {
          if (data.path === 'indicator.baseline' || data.path === 'indicator.target') {
            if (this.unit.percentage && data.value !== '') {
              var val = parseInt(data.value, 10);
              if (isNaN(val) || val < 0) {
                val = 0;
              }
              if (val > 100) {
                val = 100;
              }
              this.set(data.path, val);
            }
          }
        },

        _updateIndicatorValsAtUnitChange: function(data) {
          this.debounce('indicatorUnitChanged', function() {
            if (!this.indicator) {
              return;
            }
            var activeUnit = this._getActiveUnit();
            var resetFields = false;
            var baseline = parseFloat(this.indicator.baseline);
            var target = parseFloat(this.indicator.target);

            switch (activeUnit) {
              case 'numeric':
                if (isNaN(baseline)) {
                  this.set('indicator.baseline', '');
                }
                if (isNaN(target)) {
                  this.set('indicator.target', '');
                }
                break;
              case 'percentage':
                if (baseline < 0 || baseline > 100 || isNaN(baseline)) {
                  this.set('indicator.baseline', '');
                }
                if (target < 0 || target > 100 || isNaN(target)) {
                  this.set('indicator.target', '');
                }
                break;
              case 'yesno':
                if (this.indicator.baseline !== 'yes' && this.indicator.baseline !== 'no') {
                  this.set('indicator.baseline', '');
                }
                if (this.indicator.target !== 'yes' && this.indicator.target !== 'no') {
                  this.set('indicator.target', '');
                }

                break;
            }
          }.bind(this), 50);
        },

        _unitChanged: function(event) {
          var unitKeysToReset = Polymer.dom(event).localTarget.getAttribute('data-unit-to-reset');
          if (typeof unitKeysToReset === 'string' && unitKeysToReset !== '') {
            var unitKeys = unitKeysToReset.split(',');
            unitKeys.forEach(function(key) {
              this.set('unit.' + key, false);
            }.bind(this));
          }
        },

        _getActiveUnit: function() {
          var unit = 'numeric';
          for (var k in this.unit) {
            if (this.unit[k] === true) {
              unit = k;
            }
          }
          return unit;
        },

        openIndicatorDialog: function() {
          this.$.indicatorDialog.opened = true;
        },

        // change ok btn label to some edit label or add label texts
        setEditLabel: function() {
          this.$.indicatorDialog.okBtnText = 'Edit Indicator';
        },
        setAddLabel: function() {
          this.$.indicatorDialog.okBtnText = 'Add Indicator';
        },
        setTitle: function(title) {
          this.$.indicatorDialog.dialogTitle = title;
        },

        setIndicatorData: function(data, actionParams) {
          if (!data) {
            data = JSON.parse(JSON.stringify(this.indicatorModel));
          }
          this.set('actionParams', actionParams);

          // set unit
          for (var k in this.unit) {
            if (k !== data.unit) {
              this.set('unit.' + k, false);
            } else {
              this.set('unit.' + k, true);
            }
          }
          // set disaggregations
          if (data.disaggregation_logic) {
            var disaggregationsKeys = Object.keys(data.disaggregation_logic);
            this.set('disaggregations', []);
            if (disaggregationsKeys.length) {
              disaggregationsKeys.forEach(function(key) {
                this.push('disaggregations', {
                  disaggregate_by: key,
                  disaggregation_groups: data.disaggregation_logic[key].join(';')
                });
              }.bind(this));
            }
          }
          this.set('indicator', data);
        },

        _centerDialog: function() {
          var d = Polymer.dom(this.$.indicatorDialog.root).querySelector('paper-dialog');
          if (d) {
            d.center();
          }
        },

        _closeIndicatorDialog: function(event) {
          if (event.detail.confirmed) {
            // get indicator data
            this.indicator.unit = this._getActiveUnit();
            this.indicator.disaggregation_logic = this._prepareDisaggregations();
            // fire it up :)
            this.fire('indicator-dialog-close', {
              indicatorData: this.indicator,
              actionParams: this.actionParams
            });
          } // else, just close
        },

        _prepareDisaggregations: function() {
          if (Array.isArray(this.disaggregations) && this.disaggregations.length > 0) {
            var disaggregationsObj = {};
            this.disaggregations.forEach(function(d) {
              var groups = d.disaggregation_groups.split(';').map(function(g) {
                return g.trim();
              });
              disaggregationsObj[d.disaggregate_by] = groups;
            });
            return disaggregationsObj;
          }
          return null;
        },

        resetData: function() {
          this.set('indicator', JSON.parse(JSON.stringify(this.indicatorModel)));
          this.set('unit.numeric', true);
          this.set('unit.percentage', false);
          this.set('unit.yesno', false);
          this.set('disaggregations', []);
        }

      });
    })();
  </script>
</dom-module>

