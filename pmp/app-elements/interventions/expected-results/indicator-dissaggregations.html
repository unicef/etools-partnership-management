<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import"
      href="../../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../../styles/buttons-styles.html">

<link rel="import" href="../../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="indicator-dissaggregations">
  <template strip-whitespace>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles buttons-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      paper-input {
        width: 100%;
      }

    </style>
    <div hidden$="[[_emptyList(dataItems, dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}" >
        <div class="row-h item-container no-h-margin">
          <div class="item-actions-container">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h">
              <div class="col col-4">
                <etools-single-selection-menu id="disaggregate_by_[[index]]" label="Disaggregate By"
                                              options="{{preDefinedDisaggregtions}}"
                                              selected="{{item.disaggregId}}"
                                              option-value="id"
                                              option-label="name"
                                              on-iron-select="_onDisaggregationSelected">
                </etools-single-selection-menu>
              </div>
              <div class="col col-8">
                <paper-input id="disaggregationGroups_[[index]]" readonly label="Disaggregation Groups" placeholder="&#8212;"></paper-input>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>


    <div class="row-padding-v" hidden$="[[!_emptyList(dataItems, dataItems.length)]]">
      <p>There are no disaggregations added.</p>
    </div>

    <div class="row-padding-v">
      <paper-button class="secondary-btn" on-tap="_addNewDisaggregation"
                 title="Add Disaggregation">ADD DISAGGREGATION</paper-button>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'indicator-dissaggregations',

        behaviors: [
          EtoolsPmpApp.Behaviors.RepeatableDataSets,
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
        ],

        properties: {
          preDefinedDisaggregtions: {
            type: Array,
            statePath: 'disaggregations'
          },
        },

        ready: function() {
          this.dataSetModel = {disaggregId: null};
          this.editMode = true;
        },

        _emptyList: function(disaggregations, disaggregLength) {
          return (!disaggregations || !disaggregLength) ;
        },

        _addNewDisaggregation: function() {
          this._addElement();
        },

        _onDisaggregationSelected: function(event) {
          if (!event.detail.item.item) {
            return;
          }
          let selectedDisagreg = event.detail.item.item;
          let splitElId =  Polymer.dom(event).localTarget.id.split('_');
          let index = splitElId[splitElId.length - 1];

          if (this._isAlreadySelected(selectedDisagreg)) {
            event.model.set('item', null);
            event.model.set('item', {id: null});
            this.fire('show-toast', {error: {response: 'Disaggregation already selected'}});
            return;
          }
          this._displayDisaggregationGroups(selectedDisagreg, index);

        },
        _isAlreadySelected: function(disagreg) {
          let justSelectedOne = this.dataItems.filter(function(d) {
            return !d.disaggregId;
          }).length;
          if (!justSelectedOne) {//we're on page load
            return;
          }
          let duplicateItems = this.dataItems.filter(function(item) {
            return parseInt(item.disaggregId) === parseInt(disagreg.id);
          });
          if (duplicateItems && duplicateItems.length) {
            return true;
          }
          return false;
        },
        _displayDisaggregationGroups: function(selectedDisagreg, index) {
          this.$$('#disaggregationGroups_' + index).value = selectedDisagreg.disaggregation_values.map(function(d) {
            return d.value;
          }).join('; ');
        }

      });
    })();
  </script>
</dom-module>
