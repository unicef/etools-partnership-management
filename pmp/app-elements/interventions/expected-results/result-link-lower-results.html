<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../../styles/buttons-styles.html">

<link rel="import" href="../../../app-elements/common-elements/etools-form-element-wrapper.html">

<link rel="import" href="../../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="pd-lower-result-name.html">

<dom-module id="result-link-lower-results">
  <template strip-whitespace>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles repeatable-data-sets-styles-v3 buttons-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      .indicator-col {
        margin-right: 10px;
        width: 100px;
      }
      .indicator-col .heading {
        display: inline-block;
        width: 100%;
        color: var(--secondary-text-color, rgba(0, 0, 0, 0.54));
        margin-bottom: 10px;
      }
      .indicator-col .indicator-baseline,
      .indicator-col .indicator-target {
        padding: 10px;
        width: 100%;
        display: inline-block;
        box-sizing: border-box;
        min-height: 41px;
      }
      .indicator-col .indicator-baseline {
        background-color: var(--light-info-color);
      }
      .indicator-col .indicator-target {
        background-color: var(--success-color);
      }
      .indicator-col .content {
        padding: 10px 0;
        display: block;
      }
      .indicator-nr {
        @apply --layout-horizontal;
        padding-top: 31px;
      }
      .indicator-nr strong {
        @apply --layout-self-center;
        min-width: 30px;
      }
      .edit-indicator {
        color: var(--secondary-text-color, rgba(0, 0, 0, 0.54));
        width: 36px;
        height: 36px;
        margin-right: 20px;
      }

    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="item-actions-container">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"
                                 disabled$="[[!editMode]]"></paper-icon-button>
              <paper-icon-button class="action edit"
                                 on-tap="_editLowerResult"
                                 data-args$="[[index]]"
                                 icon="create"
                                 disabled$="[[!editMode]]"></paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h">
              <etools-form-element-wrapper label="PD output or SSFA expected result">
                <span>[[item.name]]</span>
              </etools-form-element-wrapper>
            </div>
            <div class="indicators-wrapper" hidden="[[!item.applied_indicators.length]]">
              <template is="dom-repeat"
                        items="[[item.applied_indicators]]"
                        as="indicator" index-as="indicatorIndex">
                <div class="row-h">
                  <div class="indicator-nr">
                    <strong>[[_getIndicatorNr(indicatorIndex)]]</strong>
                    <paper-icon-button class="edit-indicator"
                                       on-tap="_editIndicator"
                                       data-ind-index$="[[indicatorIndex]]"
                                       data-result-index$="[[index]]"
                                       icon="create"
                                       disabled$="[[!editMode]]"
                                       hidden$="[[!editMode]]"></paper-icon-button>
                  </div>
                  <div class="indicator-col">
                    <span class="heading">Baseline</span>
                    <span class="indicator-baseline">
                      [[_displayIndicatorValue(indicator.baseline)]]
                    </span>
                  </div>
                  <div class="indicator-col">
                    <span class="heading">Target</span>
                    <span class="indicator-target">
                      [[_displayIndicatorValue(indicator.target)]]
                    </span>
                  </div>
                  <div class="indicator-col flex-c">
                    <span class="heading">Indicator</span>
                    <span class="content">
                      [[_getIndicatorType(indicator.unit)]][[_getIndicatorTitle(indicator)]]
                    </span>
                  </div>
                </div>
              </template>
            </div>

            <div class="add-btn-wrapper">
              <paper-button class="secondary-btn"
                            on-tap="_addNewIndicator"
                            title="Add Indicator"
                            data-ll-result-id$="[[item.id]]"
                            disabled$="[[!editMode]]"
                            hidden$="[[!editMode]]">
                Add Indicator
              </paper-button>
            </div>

          </div>

        </div>
      </template>
    </div>

    <div class="add-btn-wrapper">
      <paper-button class="secondary-btn"
                    on-tap="_addNewLowerResult"
                    title="Add PD or SSFA OUTPUT"
                    disabled$="[[!editMode]]"
                    hidden$="[[!editMode]]">
        Add PD output or SSFA expected result
      </paper-button>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'result-link-lower-results',

        behaviors: [
          EtoolsPmpApp.Behaviors.RepeatableDataSets
        ],

        properties: {
          _deleteEpName: {
            type: String,
            value: 'lowerResultsDelete',
            readOnly: true,
          },
          cpOutputId: {
            type: Number
          },
          editMode: {
            type: Boolean,
            value: false
          },
          expectedResultId: Number,
        },
        listeners: {
            'delete-confirm' : '_updateInterventionLocAndClusters'
        },
        _updateInterventionLocAndClusters: function() {
          console.log('here1');
          this.fire('indicators-changed');
        },
        _addNewLowerResult: function() {
          this.fire('add-new-lower-result', {expectedResultId: this.expectedResultId});
        },

        _editLowerResult: function(e) {
          let index = parseInt(Polymer.dom(e).localTarget.getAttribute('data-args'), 10);
          if (index < 0) {
            this.logError('Can not edit, invalid index selected', 'lower-results');
            return;
          }

          let lowerResult = this.dataItems[index];
          if (!lowerResult) {
            this.logError('Lower result not found in data items by index: ' + index, 'lower-results');
            return;
          }

          this.fire('edit-lower-result', {
            expectedResultId: this.expectedResultId,
            lowerResultId: lowerResult.id,
            lowerResultName: lowerResult.name
          });
        },

        _displayIndicatorValue: function(value) {
          value = value ? value.toString() : '';
          if (typeof value === 'string' && value !== '') {
            return value;
          } else {
            return '-';
          }
        },
        _getIndicatorTitle: function(indicator) {
          if (!indicator) {
            return '-';
          }
          if (indicator.cluster_indicator_id) {
            return indicator.cluster_indicator_title;
          } else {
            return indicator.indicator ? indicator.indicator.title : '-';
          }
        },

        _getIndicatorType: function(unit) {
          if (!unit) {
            return '';
          }
          switch (unit) {
            case 'numeric':
              return '# - ';
            case 'percentage':
              return '% - ';
            // case 'yesno':
            //   return 'Yes/No - ';
          }
        },

        _getIndicatorNr: function(indicatorIndex) {
          return parseInt(indicatorIndex, 10) + 1;
        },

        _addNewIndicator: function(event) {
          // build a map (actionParams) to know where to put indicator data at add/edit
          var resultMap = {
            cpOutputId: this.cpOutputId,
            llResultIndex: event.model.index,
            llResultId: parseInt(Polymer.dom(event).localTarget.getAttribute('data-ll-result-id'), 10),
            indicatorData: null,
            appliedIndicatorsIndex: null
          };
          this.fire('open-indicator-dialog', resultMap);
        },

        _editIndicator: function(event) {
          var indicatorIndex = parseInt(Polymer.dom(event).localTarget.getAttribute('data-ind-index'), 10);
          var llResultIndex = parseInt(Polymer.dom(event).localTarget.getAttribute('data-result-index'), 10);
          var indicator = this.dataItems[llResultIndex].applied_indicators[indicatorIndex];

          var resultMap = {
            cpOutputId: this.cpOutputId,
            llResultIndex: llResultIndex,
            llResultId: indicator.lower_result,
            indicatorData: indicator,
            appliedIndicatorsIndex: indicatorIndex
          };
          this.fire('open-indicator-dialog', resultMap);
        }

      });
    })();
  </script>
</dom-module>
