<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../../styles/buttons-styles.html">

<link rel="import" href="../../../app-elements/common-elements/etools-form-element-wrapper.html">

<link rel="import" href="../../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="pd-lower-result-name.html">
<link rel="import" href="applied-indicator.html">
<link rel="import" href="../edit-delete-actions.html">

<dom-module id="result-link-lower-results">
  <template strip-whitespace>
    <style
        include="grid-layout-styles shared-styles repeatable-data-sets-styles repeatable-data-sets-styles-v3 buttons-styles data-table-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        --list-bg-color: #eeeeee;
        --list-row-no-collapse: {
          padding: 0px 0px !important;
          background-color: var(--list-second-bg-color);
        };
        --list-row-wrapper: {
          padding 0px 0px;
        };
        --edit-delete-actions: {
          background-color: var(--list-second-bg-color);
        };
      }

      etools-data-table-header {
        --data-table-header: {
          padding: 0px 0px;
        };
      }

      .indicator-col {
        margin-right: 10px;
        width: 100px;
      }

      .indicator-col .heading {
        display: inline-block;
        width: 100%;
        color: var(--secondary-text-color, rgba(0, 0, 0, 0.54));
        margin-bottom: 10px;
      }

      .indicator-col .indicator-baseline,
      .indicator-col .indicator-target {
        padding: 10px;
        width: 100%;
        display: inline-block;
        box-sizing: border-box;
        min-height: 41px;
      }

      .indicator-col .content {
        padding: 10px 0;
        display: block;
      }

      .indicator-nr {
        @apply --layout-horizontal;
        padding-top: 31px;
      }

      .indicator-nr strong {
        @apply --layout-self-center;
        min-width: 30px;
      }

      .edit-indicator {
        color: var(--secondary-text-color, rgba(0, 0, 0, 0.54));
        width: 36px;
        height: 36px;
        margin-right: 20px;
      }

      .add-indicator-btn {
        padding-left: 32px;
      }
      etools-data-table-column[performanceIndicatorCol] {
        padding-left: 24px;
      }
      .rborder {
        border-right: 1px solid var(--list-divider-color);
      }
      .lborder {
        border-left: 1px solid var(--list-divider-color);
      }
      etools-data-table-row {
        border-bottom: 1px solid var(--list-divider-color);
      }
      .padd-top-bott {
        padding-top: 10px;
        padding-bottom: 10px;
      }
      paper-icon-button {
        color: #6f6f70;
      }
      .horizontal-layout {
        @apply --layout-horizontal;
        @apply --layout-center;

        min-height: 56px;
        border-bottom: 1px solid var(--list-divider-color);
      }
      .headerContainer {
        min-height: 56px;
        @apply --layout-horizontal;
        @apply --layout-center;
      }
      .header-text {
        font-size: 12px;
        color: var(--list-secondary-text-color, #757575);
        font-weight: bold;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .flex1 {
        flex:1;
      }
      .border-b {
        border-bottom: 1px solid var(--list-divider-color);
      }
      edit-delete-actions {
        visibility:hidden;
      }
      div#resultStatement:hover edit-delete-actions{
        visibility: visible;
      }
      .padd-right {
        padding-right: 10px;
      }
      div {
        box-sizing: border-box;
      }

    </style>

    <div hidden$="[[!_emptyList(dataItems.length)]]">
      <etools-data-table-header no-title no-collapse>
        <etools-data-table-column class="col-12"> PD Output or SSFA Expected Result</etools-data-table-column>
      </etools-data-table-header>
    </div>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <!-- <etools-data-table-header no-title no-collapse>
        <etools-data-table-column class$="[[getColumnLength('result', thereAreIndicators)]]"> PD/SSFA Result Statement</etools-data-table-column>
        <etools-data-table-column performanceIndicatorCol class$="[[getColumnLength('indicator', thereAreIndicators)]]"> Performance Indicator</etools-data-table-column>
        <etools-data-table-column class="col-1 right-align" hidden$="[[!thereAreIndicators]]"> Baseline</etools-data-table-column>
        <etools-data-table-column class="col-1 right-align" hidden$="[[!thereAreIndicators]]"> Target</etools-data-table-column>
      </etools-data-table-header> -->
      <div class="headerContainer header-text border-b">
          <div class$="[[getColumnLength('result', thereAreIndicators)]]"> PD/SSFA Result Statement</div>
          <div style="min-width:40px"></div>
          <div class="headerContainer flex1">
              <div class="col-8"> Performance Indicator</div>
              <div class="col-2 right-align" hidden$="[[!thereAreIndicators]]"> Baseline</div>
              <div class="col-2 right-align" hidden$="[[!thereAreIndicators]]"> Target</div>
          </div>

        </div>
      <template is="dom-repeat" items="{{dataItems}}">
          <div class="horizontal-layout">
            <div id="resultStatement" class$="[[getColumnLength('result', thereAreIndicators, 's')]] padd-top-bott padd-right" style="position:relative">
              <edit-delete-actions  hidden$="[[!editMode]]" data-args$="[[index]]" on-edit="_editLowerResult" on-delete="_openDeleteConfirmation"></edit-delete-actions>
              <span>[[item.name]]</span>
            </div>
            <div class="flex1 lborder">
              <div hidden="[[!item.applied_indicators.length]]">
                <template is="dom-repeat"
                          items="[[item.applied_indicators]]"
                          as="indicator" index-as="indicatorIndex">
                  <applied-indicator  data-ind-index$="[[indicatorIndex]]"
                    data-result-index$="[[index]]" on-edit-indicator="_editIndicator" on-delete-indicator="_deleteIndicator" indicator="[[indicator]]" editMode="[[editMode]]"></applied-indicator>
                </template>
              </div>
              <div class="add-indicator-btn padd-top-bott">
                  <paper-icon-button icon="add-box"
                    title="Add Indicator"
                    on-tap="_addNewIndicator"
                    data-ll-result-id$="[[item.id]]"
                    disabled$="[[!editMode]]"
                    hidden$="[[!editMode]]">
                  </paper-icon-button>
                </div>
            </div>
          </div>
      </template>
    </div>

    <etools-data-table-row no-collapse>
      <div slot="row-data">
        <div class="[[getColumnLength('result', thereAreIndicators)]]">
          <paper-icon-button icon="add-box"
                        on-tap="_addNewLowerResult"
                        title="Add PD or SSFA OUTPUT"
                        disabled$="[[!editMode]]"
                        hidden$="[[!editMode]]">
            Add PD output or SSFA expected result
          </paper-icon-button>
       </div>
       <div class="flex1" hidden$="[[_emptyList(dataItems.length)]]">

       </div>
      </div>
    </etools-data-table-row>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'result-link-lower-results',

        behaviors: [
          EtoolsPmpApp.Behaviors.RepeatableDataSets
        ],

        properties: {
          _deleteEpName: {
            type: String,
            value: 'lowerResultsDelete',
            readOnly: true,
          },
          cpOutputId: {
            type: Number
          },
          editMode: {
            type: Boolean,
            value: false
          },
          expectedResultId: Number,
          thereAreIndicators: {
            type: Boolean,
            value: false
          }
        },
        listeners: {
          'delete-confirm': '_updateInterventionLocAndClusters',
        },
        observers: [
          'updateStyle(dataItems.*)'
        ],

        updateStyle: function() {
          if (!this.dataItems) {
            this.thereAreIndicators = false;
            return;
          }
          let foundSomeIndicators = false;
          for(let i in this.dataItems) {
            if (this.dataItems[i].applied_indicators && this.dataItems[i].applied_indicators.length) {
              foundSomeIndicators = true;
              break;
            }
          }
          this.thereAreIndicators = foundSomeIndicators;
        },
        getColumnLength: function(column, thereAreIndicators) {
          // if (!thereAreIndicators) {
          //   switch(column) {
          //     case 'result':
          //       return 'col-8';
          //     case 'indicator':
          //       return 'col-4';
          //   }
          // } else {
          //   switch(column) {
          //     case 'result':
          //       return 'col-4';
          //     case 'indicator':
          //       return 'col-6';
          //   }
          // }
          switch(column) {
            case 'result':
              return thereAreIndicators ? 'col-4' : 'col-8';
            case 'indicator':
              return thereAreIndicators ? 'col-8' : 'col-4';
          };

        },
        _updateInterventionLocAndClusters: function() {
          this.fire('indicators-changed');
        },
        _addNewLowerResult: function() {
          this.fire('add-new-lower-result', {expectedResultId: this.expectedResultId});
        },

        _editLowerResult: function(e) {
          e.stopPropagation();
          let index = parseInt(Polymer.dom(e).localTarget.getAttribute('data-args'), 10);
          if (index < 0) {
            this.logError('Can not edit, invalid index selected', 'lower-results');
            return;
          }

          let lowerResult = this.dataItems[index];
          if (!lowerResult) {
            this.logError('Lower result not found in data items by index: ' + index, 'lower-results');
            return;
          }

          this.fire('edit-lower-result', {
            expectedResultId: this.expectedResultId,
            lowerResultId: lowerResult.id,
            lowerResultName: lowerResult.name
          });
        },

        _getIndicatorNr: function(indicatorIndex) {
          return parseInt(indicatorIndex, 10) + 1;
        },

        _addNewIndicator: function(event) {
          // build a map (actionParams) to know where to put indicator data at add/edit
          var resultMap = {
            cpOutputId: this.cpOutputId,
            llResultIndex: event.model.index,
            llResultId: parseInt(Polymer.dom(event).localTarget.getAttribute('data-ll-result-id'), 10),
            indicatorData: null,
            appliedIndicatorsIndex: null
          };
          this.fire('open-indicator-dialog', resultMap);
        },
        _editIndicator: function(event) {
          var indicatorIndex = parseInt(Polymer.dom(event).localTarget.getAttribute('data-ind-index'), 10);
          var llResultIndex = parseInt(Polymer.dom(event).localTarget.getAttribute('data-result-index'), 10);
          var indicator = JSON.parse(JSON.stringify(this.dataItems[llResultIndex].applied_indicators[indicatorIndex]));

          var resultMap = {
            cpOutputId: this.cpOutputId,
            llResultIndex: llResultIndex,
            llResultId: indicator.lower_result,
            indicatorData: indicator,
            appliedIndicatorsIndex: indicatorIndex
          };
          this.fire('open-indicator-dialog', resultMap);
        },
        _deleteIndicator: function() {
          // -no bk
        }

      });
    })();
  </script>
</dom-module>
