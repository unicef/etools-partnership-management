<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../scripts/lodash/lodash.html">
<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../edit-delete-actions.html">


<dom-module id="applied-indicator">
  <template strip-whitespace>
    <style include="grid-layout-styles data-table-styles">
      :host {
         /* '!important' is for IE */
        --list-bg-color: #eeeeee !important;
        --list-second-bg-color: #dfdfdf !important;
        --list-icon-color: white !important;
        --edit-delete-actions: {
          background-color: #dfdfdf !important;
        };
        --list-row-wrapper: {
          padding: 0px 0px !important;
        };

        --list-row-collapse-wrapper: {
          padding: 16px 24px 16px 24px !important;
        };

        --icon-wrapper: {
          padding: 0px 0px !important;
          margin-right: 16px !important;
          background-color: var(--collapse-icon-bg-color, var(--primary-color));
        };
      }

      .header-text {
        font-size: 12px;
        color: var(--list-secondary-text-color, #757575);
        font-weight: bold;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .stretch {
        width: 100%;
      }
      .divider {
        height: 24px;
      }
      .padd-left {
        padding-left: 16px;
      }
      edit-delete-actions {
        visibility:hidden;
      }
      etools-data-table-row div[slot="row-data"]:hover edit-delete-actions{
        visibility: visible;
      }
    </style>


    <etools-data-table-row style="position:relative">
      <div slot="row-data">
        <edit-delete-actions hidden$="[[!editMode]]" show-delete="[[showDelete]]"></edit-delete-actions>

        <div class="col-8">
            [[_getIndicatorType(indicator.indicator.unit)]][[_getIndicatorTitle(indicator)]]
        </div>
        <div class="col-2 right-align">
            [[_displayIndicatorValue(indicator.baseline)]]
        </div>
        <div class="col-2 right-align">
            [[_displayIndicatorValue(indicator.target)]]
        </div>
      </div>

      <div slot="row-data-details">
        <div class="layout-horizontal stretch">
          <div class="col-4">
            <div class="header-text">Section / Cluster</div>
            <div>[[getSectionName(indicator.section, sections)]] / [[getClusterName(indicator.cluster_name)]]</div>
            <div class="divider"></div>
            <div class="header-text">Disaggregation</div>
            <template is="dom-repeat" items="[[disaggregationNames]]">
                <div>[[item]]</div>
            </template>
          </div>
          <div class="col-8 padd-left">
              <div class="header-text">Locations</div>
              <template is="dom-repeat" items="[[locationNames]]">
                  <div>[[item]]</div>
              </template>

          </div>
        </div>
      </div>
      </etools-data-table-row>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'applied-indicator',
        properties: {
          indicator: {
            type: Object,
            observer: '_indicatorChanged'
          },
          locations: {
            type: Array,
            statePath: 'locations',
            observer: '_setLocationNames'
          },
          locationNames: {
            type: Array,
            value: ['-']
          },
          sections: {
            type: Array,
            statePath: 'sections'
          },
          disaggregations: {
            type: Array,
            statePath: 'disaggregations'
          },
          disaggregationNames: {
            type: Array,
            value: ['-']
          },
          showDelete: {
            type: Boolean,
            value: false
          },
          editMode: {
            type: Boolean
          }
        },
        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
        ],
        observers: [
          'setDisaggregationNames(disaggregations, indicator)'
        ],
        listeners: {
          'edit': '_editIndicator',
          'delete': '_deleteIndicator'
        },
        _editIndicator: function(e) {
          e.stopPropagation();
          this.fire('edit-indicator', e.detail);
        },
        _deleteIndicator: function(e) {
          e.stopPropagation();
          this.fire('delete-indicator', e.detail);
        },
        _indicatorChanged: function(indicator) {
          if (indicator.cluster_indicator_id) {
            this.customStyle['--collapse-icon-bg-color'] = 'green';
          } else {
            this.customStyle['--collapse-icon-bg-color'] = 'var(--primary-color)';
          }

          this.updateStyles();
        },
        _setLocationNames: function() {
          if (!this.locations) {
            return;
          }
          let locations = this.locations.filter(function(loc) {
            return this.indicator.locations.indexOf(parseInt(loc.id)) > -1;
          }.bind(this));
          let locNames = locations.map(function(l) {
            return l.name;
          });
          this.locationNames = locNames;
        },
        getSectionName: function(sectionId) {
          if (!sectionId) {
            return '-';
          }
          let section = this.sections.find(function(s) {
            return parseInt(s.id) === parseInt(sectionId);
          });
          if (!section) {
            return '-';
          }
          return section.name;
        },
        getClusterName: function(clusterName) {
          if (!clusterName) {
            return '-';
          }
          return clusterName;
        },
        setDisaggregationNames: function() {
          if (!this.indicator.disaggregation) {
            this.disaggregationNames = ['-'];
            return;
          }
          let disaggregs = this.disaggregations.filter(function(d) {
            return this.indicator.disaggregation.indexOf(parseInt(d.id)) > -1;
          }.bind(this));
          let disaggregNames = disaggregs.map(function(d) {
            return d.name + ': ' + this._getDisaggregGroups(d.disaggregation_values);
          }.bind(this));
          this.disaggregationNames = disaggregNames;
        },
        _getDisaggregGroups: function(disaggregGroups) {
          if (!disaggregGroups || !disaggregGroups.length) {
            return '-';
          }
          let groups = disaggregGroups.reduce(function(flattened, current) {
            return flattened + ', ' + current.value;
          }, '');

          return groups.substring(1, groups.length);
        },

        _getIndicatorType: function(unit) {
          if (!unit) {
            return '';
          }
          switch (unit) {
            case 'number':
              return '# - ';
            case 'percentage':
              return '% - ';
          }
        },
        _getIndicatorTitle: function(indicator) {
          if (!indicator) {
            return '-';
          }
          if (indicator.cluster_indicator_id) {
            return indicator.cluster_indicator_title;
          } else {
            return indicator.indicator ? indicator.indicator.title : '-';
          }

        },
        _displayIndicatorValue: function(value) {
          value = value ? value.toString() : '';
          if (value) {
            return value;
          } else {
            return '-';
          }
        },
      });
    })();
  </script>
</dom-module>
