<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import"
      href="../../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">
<link rel="import"
      href="../../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-errors-parser-behavior.html">
<link rel="import" href="../../../app-behaviors/esmm-missing-options/missing-dropdown-options-behavior.html">

<link rel="import" href="../../../../styles/required-field-styles.html">

<dom-module id="result-cp-output-and-ram-indicators">
  <template>
    <style include="required-field-starred-styles">
      :host {}

      .cp-output-row {
        padding: 0 0 16px;
      }

      .ram-indicators-row {
        padding: 16px 0 30px;
      }
    </style>

    <etools-dialog id="cpOutputRamIndicatorsDialog"
                   size="md"
                   dialog-title="Add/Update CP Output/Ram Indicators"
                   ok-btn-text="Add/Update"
                   disable-confirm-btn="[[disableConfirmBtn]]"
                   on-confirm-btn-clicked="_saveChanges"
                   keep-dialog-open>

      <div class="cp-output-row">
        <etools-single-selection-menu id="cpOutput"
                                      label="CP Output"
                                      placeholder="&#8212;"
                                      options="[[availableCpOutputs]]"
                                      option-value="id"
                                      option-label="name"
                                      selected="{{selectedCpOutputId}}"
                                      required
                                      auto-validate
                                      error-message="Please select CP Output">
        </etools-single-selection-menu>
      </div>

      <div class="ram-indicators-row">
        <etools-multi-selection-menu id="indicators"
                                     label="CP Indicators"
                                     placeholder="&#8212;"
                                     options="[[cpOutputRamIndicators]]"
                                     option-value="id"
                                     option-label="name"
                                     selected-values="{{selectedRamIndicatorsIds}}"
                                     required
                                     auto-validate
                                     error-message="Please select CP Indicators">
        </etools-multi-selection-menu>
      </div>

    </etools-dialog>
  </template>

  <script>
    Polymer({
      is: 'result-cp-output-and-ram-indicators',

      behaviors: [
        EtoolsAjaxRequestBehavior,
        EtoolsPmpApp.Behaviors.Endpoints,
        EtoolsPmpApp.Behaviors.AjaxErrorsParser,
        EtoolsPmpApp.Behaviors.MissingDropdownOptions
      ],

      properties: {
        interventionId: Number,
        expectedResultId: Number,
        availableCpOutputs: {
          type: Array,
          value: []
        },
        selectedCpOutputId: {
          type: Number,
          observer: '_cpOutputSelected'
        },
        cpOutputRamIndicators: {
          type: Array,
          value: []
        },
        selectedRamIndicatorsIds: {
          type: Array
        },
        autovalidateActive: {
          type: Boolean,
          value: false
        },
        ramIndicatorsLoadingMsg: {
          type: String,
          value: 'Loading selected CP Output ram indicators...'
        },
        saveResultLoadingMsg: {
          type: String,
          value: 'Saving result...'
        },
        opened: {
          type: Boolean,
          value: false
        },
        preventRamIndicatorReset: Boolean,
        editIndex: {
          value: null
        },
        disableConfirmBtn: {
          type: Boolean,
          value: false
        },
        toastEventSource: Object
      },

      ready: function() {
         this.setDropdownMissingOptionsAjaxDetails(this.$.cpOutput, 'cpOutputsByIdsAsValues', {dropdown: true});
      },

      _enableAutovalidate: function() {
        this.set('autovalidateActive', true);
      },

      _cpOutputSelected: function(cpOutputId) {
        if (cpOutputId) {
          // request ram indicators list
          this._setRamIndicatorsSpinnerText(this.ramIndicatorsLoadingMsg);
          this._showRamIndicatorsLoadingSpinner(true);

          let ramIndicatorsEndpoint = this.getEndpoint('ramIndicators', {id: cpOutputId});
          let self = this;
          this.sendRequest({
            endpoint: ramIndicatorsEndpoint
          }).then(function(response) {
            self._handleRamIndicatorsReqResponse(response);
          }).catch(function(error) {
            self._showRamIndicatorsLoadingSpinner(false);
            self.parseRequestErrorsAndShowAsToastMsgs(error, self.toastEventSource);
          });
        }
      },

      _handleRamIndicatorsReqResponse: function(response) {
        if (this._thereAreSelectedIndicators() &&  //* to prevent triggering validation
            !this.preventRamIndicatorReset) {
          this.set('selectedRamIndicatorsIds', []);
        }
        this.set('preventRamIndicatorReset', false);
        this.set('cpOutputRamIndicators', response);
        this._showRamIndicatorsLoadingSpinner(false);
      },
      _thereAreSelectedIndicators: function() {
        return this.selectedRamIndicatorsIds && this.selectedRamIndicatorsIds.length;
      },
      _showRamIndicatorsLoadingSpinner: function(show) {
        if (show) {
          this.$.cpOutputRamIndicatorsDialog.startSpinner();
        } else {
          this.$.cpOutputRamIndicatorsDialog.stopSpinner();
        }
      },

      _setRamIndicatorsSpinnerText: function(text) {
        this.$.cpOutputRamIndicatorsDialog.spinnerText = text;
      },

      openDialog: function() {
        this.$.cpOutputRamIndicatorsDialog.set('opened', true);
      },

      closeDialog: function() {
        this.$.cpOutputRamIndicatorsDialog.set('opened', false);
      },

      resetData: function() {
        this.set('disableConfirmBtn', false);
        this.set('editIndex', null);
        this.set('selectedCpOutputId', undefined);
        this.set('availableCpOutputs', []);
        this.set('cpOutputRamIndicators', []);
        this.set('selectedRamIndicatorsIds', []);
        this.set('selectedRamIndicatorsIds', undefined);

        this.$.cpOutput.set('invalid', false);
        this.$.indicators.set('invalid', false);
      },

      _saveChanges: function() {
        this.$.cpOutput.validate();
        this.$.indicators.validate();

        let result = {
          intervention: this.interventionId,
          cp_output: this.selectedCpOutputId,
          ram_indicators: (this.selectedRamIndicatorsIds instanceof Array) ? this.selectedRamIndicatorsIds : []
        };

        if (!this._isValidResult(result)) {
          return;
        }

        let endpoint;
        if (this._isNewResult()) {
          endpoint = this._getResultsEndpoint(result.intervention);
          this._saveExpectedResult(endpoint, 'POST', result, this._newResultSuccessfullyAdded);
        } else {
          endpoint = this._getResultDetailsEndpoint(this.expectedResultId);
          this._saveExpectedResult(endpoint, 'PATCH', result, this._resultSuccessfullyUpdated);
        }
      },

      _isValidResult: function(result) {
        let valid = true;
        if (!result.intervention) {
          this.logError('Intervention ID is missing! Can not save result.', 'expected-results-modal');
          valid = false;
        }
        if (!result.cp_output || result.ram_indicators.length === 0) {
          valid = false;
        }
         return valid;
      },

      _isNewResult: function() {
        return !this.expectedResultId;
      },

      _getResultsEndpoint: function(interventionId) {
        return this.getEndpoint('pdExpectedResults', {pdId: interventionId});
      },

      _getResultDetailsEndpoint: function(resultId) {
        return this.getEndpoint('pdExpectedResultDetails', {resultId: resultId});
      },

      _saveExpectedResult: function(endpoint, method, result, successCallback) {
        let self = this;
        this._setRamIndicatorsSpinnerText(this.saveResultLoadingMsg);
        this._showRamIndicatorsLoadingSpinner(true);
        this.set('disableConfirmBtn', true);
        this.sendRequest({
          method: method,
          endpoint: endpoint,
          body: result
        }).then(function(response) {
          self._showRamIndicatorsLoadingSpinner(false);
          self.set('disableConfirmBtn', false);
          if (typeof successCallback === 'function') {
            successCallback.bind(self, response)();
          }
        }).catch(function(error) {
          self._showRamIndicatorsLoadingSpinner(false);
          self.set('disableConfirmBtn', false);
          self.parseRequestErrorsAndShowAsToastMsgs(error, self.toastEventSource);
        });
      },

      _newResultSuccessfullyAdded: function(response) {
        this.fire('new-expected-result-added', {result: response});
        this.closeDialog();
      },

      _resultSuccessfullyUpdated: function(response) {
        this.fire('expected-result-updated', {index: this.editIndex, result: response});
        this.closeDialog();
      }

    });
  </script>
</dom-module>
