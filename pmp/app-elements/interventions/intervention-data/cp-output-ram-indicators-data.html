<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">

<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">
<link rel="import" href="../../../app-config/app-endpoints-behavior.html">

<dom-module id="cp-output-ram-indicators-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="dexie"
                 on-success="_handleResponse"
                 on-fail="handleErrorResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'cp-output-ram-indicators-data',
        behaviors: [
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsPmpApp.Behaviors.AjaxServerErrors
        ],
        properties: {
          ramIndicators: {
            type: Array,
            notify: true
          },

          cpOutputId: {
            type: Number,
            observer: '_cpOutputIdChanged'
          },

          ajaxEl: {
            type: Object,
          },

          label: {
            type: String,
          },

          endpoint: {
            type: Object,
          },

          globalMessage: {
            type: String,
            value: 'Getting selected CP Output indicators failed!'
          },

          /**
           * ajaxLoadingMsgSource use is required for request errors handling in AjaxServerErrorsBehavior
           */
          ajaxLoadingMsgSource: {
            type: String,
            value: 'cpo-ram-ind'
          }

        },

        attached: function() {
          this.ajaxEl = this.$.ajax;
        },

        _cpOutputIdChanged: function(newId) {
          if (newId) {
            this.fire('global-loading', {
              message: 'Loading ram indicators data...',
              active: true,
              loadingSource: this.ajaxLoadingMsgSource
            });
            this._prepareAndFireRequest();
            this.set('endpoint', this.getEndpoint('ramIndicators', {id: newId}));
          }
        },

        /**
         * Handle received data from request
         */
        _handleResponse: function(response) {
          this.set('ramIndicators', response.detail);
          this.fire('global-loading', {active: false, loadingSource: this.ajaxLoadingMsgSource});
        },

        /**
         * Set the method of the request and the body.
         * Used for unsafe requests (PATCH/POST).
         */
        _prepareAndFireRequest: function() {
          if (!this.ajaxEl) {
            this.ajaxEl = this.$.ajax;
          }
          this.ajaxEl.set('params', null);
          this.ajaxEl.set('body', null);
          this.ajaxEl.set('url', null);
          this.ajaxEl.set('method', 'GET');
        }

      });
    })();
  </script>

</dom-module>
