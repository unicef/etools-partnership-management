<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-behavior.html">

<link rel="import" href="../../../../scripts/lodash/lodash.html">
<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../app-config/app-dexie-db-config.html">
<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">

<dom-module id="reporting-requirements-data">

  <script>
    (function() {
      'use strict';
      Polymer({

        is: 'reporting-requirements-data',
        behaviors: [
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.Endpoints,
          // EtoolsLogsBehavior,
          // EtoolsPmpApp.Behaviors.AjaxServerErrors
        ],
        properties: {
          endpointName: {
            type: String,
            value: 'reportRequirements'
          },
          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          },
          reportingRequirements: {
            type: Array,
            notify: true
          },
          ajaxMethod: String,
          /**
           * ajaxLoadingMsgSource use is required for request errors handling in AjaxServerErrorsBehavior
           */
          ajaxLoadingMsgSource: {
            type: String,
            value: 'reporting-requirements-data'
          }
        },

        _triggerRequest: function(options) {
          let self = this;
          let ajaxMethod = options.method || 'GET';
          this.sendRequest(options).then(function(resp) {
            self._handleResponse(resp, ajaxMethod);
          }).catch(function(error) {
            self._handleErrorResponse(error, ajaxMethod);
          });
        },

        _interventionIdChanged: function(newId) {
          if (newId) {
            // this.fire('global-loading', {
            //   message: 'Loading Reporting Requirements data...',
            //   active: true,
            //   loadingSource: this.ajaxLoadingMsgSource
            // });
            this.ajaxMethod = 'GET';
            this._triggerRequest({endpoint: this.getEndpoint(this.endpointName, {reportId: newId})});
          }
        },

        _handleErrorResponse: function(response) {
          this.handleErrorResponse(response, ajaxMethod);
          this._restoreUnsuccessfullyDeletedFrs();
        },
        /**
         * Handle received data from request
         */
        _handleResponse: function(response) {
          if (this.ajaxMethod === 'GET') {
            this.set('reportingRequirements', response);
          }
          if (this.ajaxMethod === 'POST') {
            this.push('reportingRequirements', response);
          }
        },
        _handleErrorResponse: function() {
          // TO BE CONTINUED
        },

        addRequirement: function(requirement) {
          let endpoint = this.getEndpoint(this.endpointName, {reportId: this.interventionId});
          this.ajaxMethod = 'POST';

          requirement.intervention = this.interventionId;

          this._triggerRequest({method: this.ajaxMethod, endpoint: endpoint, body: requirement});
        },


      });
    })();
  </script>

</dom-module>
