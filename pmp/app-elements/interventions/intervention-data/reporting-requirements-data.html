<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-behavior.html">

<link rel="import" href="../../../../scripts/lodash/lodash.html">
<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../app-config/app-dexie-db-config.html">
<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">

<dom-module id="reporting-requirements-data">

  <script>
    (function() {
      'use strict';
      Polymer({

        is: 'reporting-requirements-data',
        behaviors: [
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.Endpoints,
          // EtoolsLogsBehavior,
          // EtoolsPmpApp.Behaviors.AjaxServerErrors
        ],
        properties: {
          endpointName: {
            type: String,
            value: 'reportRequirements'
          },
          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          },
          reportingRequirements: {
            type: Array,
            notify: true
          },
          /**
           * ajaxLoadingMsgSource use is required for request errors handling in AjaxServerErrorsBehavior
           */
          ajaxLoadingMsgSource: {
            type: String,
            value: 'reporting-requirements-data'
          }
        },

        _triggerRequest: function(options) {
          let self = this;
          let ajaxMethod = options.method || 'GET';
          this.sendRequest(options).then(function(resp) {
            self._handleResponse(resp, ajaxMethod);
          }).catch(function(error) {
            self._handleErrorResponse(error, ajaxMethod);
          });
        },

        _interventionIdChanged: function(newId) {
          if (newId) {
            // this.fire('global-loading', {
            //   message: 'Loading Reporting Requirements data...',
            //   active: true,
            //   loadingSource: this.ajaxLoadingMsgSource
            // });
            this._triggerRequest({endpoint: this.getEndpoint(this.endpointName, {reportId: newId})});
          }
        },

        _handleErrorResponse: function(response, ajaxMethod) {
          this.handleErrorResponse(response, ajaxMethod);
          this._restoreUnsuccessfullyDeletedFrs();
        },
        /**
         * Handle received data from request
         */
        _handleResponse: function(response, ajaxMethod) {
          this.set('reportingRequirements', response);
        },

        /**
         * Save intervention data
         */
        // saveIntervention: function(intervention, callback) {
        //   let endpoint = null;
        //   let isNew = false;
        //   let prepareMultipartData = false;

        //   if (intervention.id) {
        //     // prepare PATCH endpoint
        //     endpoint = this.getEndpoint(this.endpointName, {id: intervention.id});
        //   } else {
        //     // new intervention, use POST method for the same endpoint
        //     endpoint = this.getEndpoint(this.endpointName);
        //     isNew = true;
        //   }
        //   // remove id from data
        //   if (intervention.id) {
        //     delete intervention.id;
        //   }

        //   if (this._hasFiles(intervention.attachments, 'attachment')) {
        //     prepareMultipartData = true;
        //   }
        //   // check prc_review_document doc, if no file delete the property from the object
        //   if (this._fileField(intervention, 'prc_review_document')) {
        //     prepareMultipartData = true;
        //   } else {
        //     delete intervention.prc_review_document;
        //   }
        //   // check signed_pd_document doc, if no file delete the property from the object
        //   if (this._fileField(intervention, 'signed_pd_document')) {
        //     prepareMultipartData = true;
        //   } else {
        //     delete intervention.signed_pd_document;
        //   }

        //   if (this._hasFiles(intervention.amendments, 'signed_amendment')) {
        //     prepareMultipartData = true;
        //   }
        //   if (Array.isArray(intervention.result_links)) {
        //     intervention.result_links = intervention.result_links.filter(function(elem) {
        //       return elem.cp_output || (Array.isArray(elem.ram_indicators) && elem.ram_indicators.length);
        //     });
        //   }
        //   if (Array.isArray(intervention.planned_visits)) {
        //     intervention.planned_visits = intervention.planned_visits.filter(function(elem) {
        //       return elem.year || elem.programmatic;
        //     });
        //   }
        //   this.fire('global-loading', {
        //     message: 'Saving intervention data...',
        //     active: true,
        //     loadingSource: this.ajaxLoadingMsgSource
        //   });

        //   let method = (isNew) ? 'POST' : 'PATCH';
        //   this._triggerRequest({method: method, endpoint: endpoint, body: intervention,
        //     multiPart: prepareMultipartData, prepareMultipartData: prepareMultipartData});
        // },


      });
    })();
  </script>

</dom-module>
