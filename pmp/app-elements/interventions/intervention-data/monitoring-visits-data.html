<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">

<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">

<dom-module id="monitoring-visits-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="dexie"
                 on-success="_handleResponse"
                 on-fail="handleErrorResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'monitoring-visits-data',
        behaviors: [etoolsAppConfig.globals, pmpBehaviors.AjaxServerErrorsBehavior],
        properties: {
          monitoringVisits: {
            type: Array,
            notify: true
          },

          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          },

          ajaxEl: Object,

          globalMessage: {
            type: String,
            value: 'Getting monitoring visits failed!'
          },

        },

        attached: function() {
          this.ajaxEl = this.$.ajax;
        },

        _interventionIdChanged: function(newId) {
          if (newId) {
            this.fire('global-loading', {message: 'Loading monitoring visits data...', active: true});
            this._prepareAndFireRequest();
            this.set('endpoint', this.getEndpoint('monitoringVisits', {id: newId}));
          }
        },

        /**
         * Handle received data from request
         */
        _handleResponse: function(response) {
          this.set('monitoringVisits', response.detail);
          this.fire('global-loading', {active: false});
        },

        /**
         * Set the method of the request and the body.
         * Used for unsafe requests (PATCH/POST).
         */
        _prepareAndFireRequest: function() {
          if (!this.ajaxEl) {
            this.ajaxEl = this.$.ajax;
          }
          this.ajaxEl.set('params', null);
          this.ajaxEl.set('body', null);
          this.ajaxEl.set('url', null);
          this.ajaxEl.set('method', 'GET');
        }

      });
    })();
  </script>

</dom-module>
