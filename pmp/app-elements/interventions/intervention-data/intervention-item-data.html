<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">

<link rel="import" href="../../../app-config/etools-app-config.html">
<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">

<dom-module id="intervention-item-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="dexie"
                 on-success="_handleResponse"
                 on-fail="handleErrorResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({

        is: 'intervention-item-data',
        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.AjaxServerErrorsBehavior
        ],
        properties: {

          intervention: {
            type: Object,
            readOnly: true,
            notify: true
          },

          endpoint: {
            type: Object
          },

          interventionId: {
            type: Number,
            notify: true,
            observer: '_interventionIdChanged'
          },

          handleResponseAdditionalCallback: Object,
          ajaxEl: Object
        },

        attached: function() {
          this.ajaxEl = this.$.ajax;
        },

        _interventionIdChanged: function(newId) {
          if (newId) {
            this.fire('global-loading', {message: 'Loading intervention data...', active: true});
            this._prepareAndFireRequest();
            this.set('endpoint', this.getEndpoint('interventionDetails', {id: newId}));
          }
        },

        /**
         * Handle received data from request
         */
        _handleResponse: function(response) {

          this._setIntervention(response.detail);

          if (this.intervention && this.intervention.planned_budget) {
            this.set('intervention.planned_budget.interventionWasSaved', true);
          }
          // call additional callback, if any
          if (typeof this.handleResponseAdditionalCallback === 'function') {
            this.handleResponseAdditionalCallback.bind(this, response.detail)();
            // reset callback
            this.set('handleResponseAdditionalCallback', null);
          }

          if (this.$.ajax.get('method') !== 'GET') {
            var self = this;
            // update the interventions list in dexieDB
            var mappedResponse = this._formatResponseDataForDexie(response.detail);
            etoolsAppConfig.db.table('interventions').put(mappedResponse).then(function() {
              self.fire('reload-list');
            });
          }
        },

        /**
         * Set the method of the request and the body.
         * Used for unsafe requests (PATCH/POST).
         */
        _prepareAndFireRequest: function(method, data, url, multipart, prepareMultipartData) {
          if (!multipart) {
            multipart = false;
          }
          if (!prepareMultipartData) {
            prepareMultipartData = false;
          }
          if (!this.ajaxEl) {
            this.ajaxEl = this.$.ajax;
          }
          this.ajaxEl.setContentType(null);
          if (!method) {
            method = 'GET';
            // reset ajax for GET request
            this.ajaxEl.set('params', null);
            this.ajaxEl.set('body', null);
            this.ajaxEl.set('url', null);
            this.ajaxEl.set('multiPart', false);
            this.ajaxEl.set('prepareMultipartData', false);
          }
          this.ajaxEl.set('method', method);
          if (typeof data === 'object' && ['PATCH', 'POST'].indexOf(method) > -1) {

            if (multipart) {
              this.ajaxEl.set('multiPart', true);
            } else {
              this.ajaxEl.set('multiPart', false);
            }
            if (prepareMultipartData) {
              this.ajaxEl.set('prepareMultipartData', true);
            } else {
              this.ajaxEl.set('prepareMultipartData', false);
            }

            this.ajaxEl.set('body', data);
            this.ajaxEl.set('url', url);
          }
          // after body is set the request is automatically triggered
        },

        _prepareEndpoint: function(interventionId) {
          if (interventionId > 0) {
            // check and prepare request URL
            if (!this.endpoint || (this.endpoint && !this.endpoint.url)) {
              this.set('endpoint', this.getEndpoint('interventionDetails', {id: interventionId}));
            }
          }
        },

        _hasFiles: function(list, property) {
          if (!Array.isArray(list) || (Array.isArray(list) && list.length === 0)) {
            return false;
          }
          var hasF = false;
          for (var i = 0; i < list.length; i++) {
            if (list[i][property] instanceof File) {
              hasF = true;
            } else {
              delete list[i][property];
            }
          }
          return hasF;
        },
        _fileField: function(intervention, property) {
          return intervention[property] instanceof File;
        },

        /**
         * Update intervention status. In addition set a callback to be called after request is complete.
         */
        updateInterventionStatus: function(data, callback) {
          if (!data.interventionId) {
            this.fire('toast', {text: 'Invalid intervention ID', showCloseBtn: true});
          } else {
            if (['draft', 'cancelled', 'active', 'suspended', 'terminated'].indexOf(data.status) > -1) {
              // status change is allowed
              // set additional callback if any
              if (callback) {
                this.set('handleResponseAdditionalCallback', callback);
              }
              this._prepareEndpoint(data.interventionId);
              this.fire('global-loading', {message: 'Changing intervention status...', active: true});
              // fire in the hole
              this._prepareAndFireRequest('PATCH', {status: data.status}, this.endpoint.url);
            } else {
              this.fire('toast', {
                text: 'Changing status to \'' + data.status + '\' is not allowed!',
                showCloseBtn: true
              });
            }
          }
        },

        /**
         * Save intervention data
         */
        saveIntervention: function(intervention, callback) {
          if (intervention && typeof intervention === 'object' && Object.keys(intervention).length === 0) {
            this.fire('toast', {text: 'Invalid intervention data!', showCloseBtn: true});
          } else {
            var url = null;
            var isNew = false;

            if (intervention.id) {
              // prepare PATCH endpoint
              this._prepareEndpoint(intervention.id);
              url = this.endpoint.url;
            } else {
              // new intervention, use POST method for the same endpoint
              var interventionsEndpoint = this.getEndpoint('interventions');
              url = interventionsEndpoint.url;
              isNew = true;
            }
            // remove id from data
            if (intervention.id) {
              delete intervention.id;
            }
            // set additional callback if any and only if is new intervention
            if (callback && isNew) {
              this.set('handleResponseAdditionalCallback', callback);
            }

            var withUpload = false; // used to set multipart prop on etools-ajax
            var prepareMultipartData = false;
            if (this._hasFiles(intervention.attachments, 'attachment')) {
              withUpload = true;
              prepareMultipartData = true;
            }
            // check prc_review_document doc, if no file delete the property from the object
            if (this._fileField(intervention, 'prc_review_document')) {
              withUpload = true;
              prepareMultipartData = true;
            } else {
              delete intervention.prc_review_document;
            }
            // check signed_pd_document doc, if no file delete the property from the object
            if (this._fileField(intervention, 'signed_pd_document')) {
              withUpload = true;
              prepareMultipartData = true;
            } else {
              delete intervention.signed_pd_document;
            }

            if (this._hasFiles(intervention.amendments, 'signed_amendment')) {
              withUpload = true;
              prepareMultipartData = true;
            }

            this.fire('global-loading', {message: 'Saving intervention data...', active: true});
            // fire in the hole
            this._prepareAndFireRequest((isNew) ? 'POST' : 'PATCH',
                intervention, url, withUpload, prepareMultipartData);
          }
        },

        _formatResponseDataForDexie: function(responseDetail) {
          var dexieObject = {};
          dexieObject.sectors = [];
          dexieObject.cp_outputs = [];
          dexieObject.unicef_budget = 0;
          dexieObject.cso_contribution = 0;

          dexieObject.id = responseDetail.id;
          dexieObject.hrp = responseDetail.hrp;
          dexieObject.end = responseDetail.end;
          dexieObject.title = responseDetail.title;
          dexieObject.start = responseDetail.start;
          dexieObject.status = responseDetail.status;
          dexieObject.number = responseDetail.number;
          dexieObject.offices = responseDetail.offices;
          dexieObject.partner_name = responseDetail.partner;
          dexieObject.document_type = responseDetail.document_type;
          dexieObject.unicef_focal_points = responseDetail.unicef_focal_points;

          dexieObject.unicef_budget = parseInt(responseDetail.planned_budget.unicef_cash);
          dexieObject.cso_contribution = parseInt(responseDetail.planned_budget.partner_contribution);

          responseDetail.sector_locations.forEach(function(elem) {
            dexieObject.sectors.push(elem.sector.name);
          });

          responseDetail.result_links.forEach(function(elem) {
            dexieObject.cp_outputs.push(elem.cp_output);
          });

          return dexieObject;
        },

      });
    })();
  </script>

</dom-module>
