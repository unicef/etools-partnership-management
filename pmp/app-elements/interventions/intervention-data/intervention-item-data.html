<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">

<dom-module id="intervention-item-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="dexie"
                 on-success="_handleResponse"
                 on-fail="_handleErrorResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'intervention-item-data',
        behaviors: [etoolsAppConfig.globals],
        properties: {

          intervention: {
            type: Object,
            readOnly: true,
            notify: true
          },

          interventionId: {
            type: Number,
            notify: true,
            observer: '_interventionIdChanged'
          },

          handleResponseAdditionalCallback: Object,
          ajaxEl: Object

        },

        attached: function() {
          this.ajaxEl = this.$.ajax;
        },

        _interventionIdChanged: function(newId) {
          if (newId) {
            this.fire('global-loading', {message: 'Loading intervention data...', active: true});
            this._prepareAndFireRequest();
            this.set('endpoint', this.getEndpoint('interventionDetails', {id: newId}));
          }
        },

        /**
         * Handle received data from request
         */
        _handleResponse: function(response) {
          this._setIntervention(response.detail);
          // call additional callback, if any
          if (typeof this.handleResponseAdditionalCallback === 'function') {
            this.handleResponseAdditionalCallback.bind(this, response.detail)();
            // reset callback
            this.set('handleResponseAdditionalCallback', null);
          }
        },

        /**
         * Set the method of the request and the body.
         * Used for unsafe requests (PATCH/POST).
         */
        _prepareAndFireRequest: function(method, data, url) {
          if (!method) {
            method = 'GET';
            // reset ajax for GET request
            this.ajaxEl.set('params', null);
            this.ajaxEl.set('body', null);
            this.ajaxEl.set('url', null);
          }
          this.ajaxEl.set('method', method);
          if (typeof data === 'object' && Object.keys(data).length > 0
              && ['PATCH', 'POST'].indexOf(method) > -1) {
            this.ajaxEl.set('body', data);
            this.ajaxEl.set('url', url);
          }
          // after body is set the request is automatically triggered
        },

        _handleErrorResponse: function(response) {
          this.fire('global-loading', {active: false});
          var errors = response.detail.request.detail.request.response;
          if (this.ajaxEl.method === 'POST' || this.ajaxEl.method === 'PATCH') {
            // TODO: improve etools-ajax on-fail event data model (received errors)
            var errorMessage = 'An error occurred during agreement save!';
            if (errors) {
              var errorMessages = ["Errors occurred:\n"];
              if (Array.isArray(errors) && errors.length > 0) {
                errors.forEach(function(err) {
                  errorMessages.push(err + "\n");
                });
              } else if (typeof errors === 'object' && Object.keys(errors).length > 0) {
                for (var errField in errors) {
                  if (typeof errField)
                    errorMessages.push('Field ' + errField + ' - ' + errors[errField] + "\n");
                }
              }
              if (errorMessages.length > 1) {
                errorMessage = errorMessages.join('');
              }
            }
            this.fire('toast', {text: errorMessage, showCloseBtn: true});
          }
        }

      });
    })();
  </script>

</dom-module>
