<script>
  window.pmpBehaviors = window.pmpBehaviors || {};
  /** @polymerBehavior pmpBehaviors.FrNumbersConsistencyBehavior */
  pmpBehaviors.FrNumbersConsistencyBehavior = {
    properties: {
      _frsConsistencyWarnings: {
        type: Object,
        value: {
          amount: 'Total FR amount is not the same as planned UNICEF $ contribution.',
          dateTmpl: 'FR <<field_name>> is not the same as PD/SSFA <<field_name>>.'
        }
      }
    },
    /**
     * Check FR numbers total amount against planned budget unicef total contribution and start/end dates
     */
    checkFrsConsistency: function(frsDetails, intervention) {
      let warnFrsFields = []; // FR fields
      let warnIntervFields = []; // PD/SSFA fields
      if (this.checkFrsAndIntervDateConsistency(intervention.start, frsDetails.earliest_start_date)) {
        warnFrsFields.push('FR start date');
        warnIntervFields.push('start date');
      }
      if (this.checkFrsAndIntervDateConsistency(intervention.end, frsDetails.latest_end_date)) {
        warnFrsFields.push('FR end date');
        warnIntervFields.push('end date');
      }
      if (this.checkFrsAndUnicefCashAmountsConsistency(intervention.planned_budget.unicef_cash,
              frsDetails.total_frs_amt, intervention, 'interventionDetails')) {
        warnFrsFields.push('Total FR amount');
        warnIntervFields.push('UNICEF $ contribution');
      }
      if (warnFrsFields.length > 0) {
        return warnFrsFields.join(', ') + ' ' + (warnFrsFields.length > 1 ? 'are' : 'is') +
            ' not the same as PD/SSFA ' + warnIntervFields.join(', ') + '.';
      }
      return false;
    },

    checkFrsAndUnicefCashAmountsConsistency: function(unicefCash, frsTotalAmt, intervention, interventionIsFromWhere,  returnMsg) {
      if (!this.validateFrsVsUnicefCashAmounts(unicefCash, frsTotalAmt, intervention, interventionIsFromWhere)) {
        return returnMsg ? this.getFrsTotalAmountInconsistencyMsg() : true;
      }
      return false;
    },
    validateFrsVsUnicefCashAmounts: function(unicefCash, frsTotalAmt, intervention, interventionIsFromWhere) {
      if (this.emptyFrsList(intervention, interventionIsFromWhere)) {
        return true;
      }
      let totalUnicefContribution = parseFloat(unicefCash);
      let totalFrsAmount = parseFloat(frsTotalAmt);
      let unicefContibutionDiff = Math.abs(totalUnicefContribution - totalFrsAmount);

      return unicefContibutionDiff < 10;
    },

    checkFrsAndIntervDateConsistency: function(intervDateStr, frsDateStr, fieldName, returnMsg) {
      if (!this.validateFrsVsInterventionDates(intervDateStr, frsDateStr)) {
        return returnMsg
            ? this._buildFrsWarningMsg(this._frsConsistencyWarnings.dateTmpl, '<<field_name>>', fieldName)
            : true;
      }
      return false;
    },
    validateFrsVsInterventionDates: function(intervDateStr, frsDateStr) {
      if (!frsDateStr) {// *No Fr added
        return true;
      }
      if (intervDateStr !== frsDateStr) {
        return false;
      }
      return true;
    },
    _buildFrsWarningMsg: function(msgTemplate, searchStr, replacementStr) {
      return msgTemplate.replace(new RegExp(searchStr, 'g'), replacementStr);
    },
    getFrsTotalAmountInconsistencyMsg: function() {
      return this._frsConsistencyWarnings.amount;
    },
    getFrsStartDateValidationMsg: function() {
      return this._buildFrsWarningMsg(this._frsConsistencyWarnings.dateTmpl,
       '<<field_name>>', 'start date');
    },
    getFrsEndDateValidationMsg: function() {
      return this._buildFrsWarningMsg(this._frsConsistencyWarnings.dateTmpl,
       '<<field_name>>', 'end date');
    },
    frsConsistencyWarningIsActive: function(warnMsg) {
      return !!warnMsg;
    },

    getFrsInconsistentFieldClass: function(warn) {
      return !!warn ? 'frs-inconsistent' : '';
    },

    emptyFrsList: function(intervention, interventionIsFromWhere) {
      // * The intervention object from interventions-list
      // has different properties than the one on intervention-details
      if (interventionIsFromWhere === 'interventionDetails') {
        return !intervention || !intervention.frs_details || intervention.frs_details.frs.length === 0;
      } else if (interventionIsFromWhere === 'interventionsList') {
         return !intervention.frs_earliest_start_date || ! intervention.frs_latest_end_date;
      }
    }

  };
</script>
