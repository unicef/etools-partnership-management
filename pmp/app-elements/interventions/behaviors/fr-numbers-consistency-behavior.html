<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<script>
  'use strict';
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};

  /** @polymerBehavior EtoolsPmpApp.Behaviors.FrNumbersConsistency */
  EtoolsPmpApp.Behaviors.FrNumbersConsistencyImpl = {
    properties: {
      currencies: {
        type: Array,
        statePath: 'currencies'
      },
      _frsConsistencyWarnings: {
        type: Object,
        value: {
          currenciesDoNotMatch: 'The currency of the PD/SSFA and the FR are not the same and cannot be compared. ' +
            'To be able to compare the amounts, you can cancel and enter the budget in the same currency as the FR. ',
          amount: 'Total FR amount is not the same as planned UNICEF $ contribution.',
          dateTmpl: 'FR <<field_name>> is not the same as PD/SSFA <<field_name>>.'
        }
      }
    },

    /*
     * frs currencies and planned budget currency check
     */
    _frsAndPlannedBudgetCurrenciesMatch: function(frs, plannedBudgetCurrency) {
      let differentFrCurrencies = frs.filter((fr) => fr.currency !== plannedBudgetCurrency);
      return differentFrCurrencies.length === 0;
    },

    /**
     * Check FR numbers total amount against planned budget unicef total contribution and start/end dates
     */
    checkFrsConsistency: function(frsDetails, intervention, skipEmptyListCheck) {
      if (intervention.status === 'closed') {
        return false;
      }

      let warnFrsFields = []; // FR fields
      let warnIntervFields = []; // PD/SSFA fields
      if (this.checkFrsAndIntervDateConsistency(intervention.start, frsDetails.earliest_start_date)) {
        warnFrsFields.push('FR Start Date');
        warnIntervFields.push('Start Date');
      }
      if (this.checkFrsAndIntervDateConsistency(intervention.end, frsDetails.latest_end_date)) {
        warnFrsFields.push('FR End Date');
        warnIntervFields.push('End Date');
      }

      let computedWarning = '';
      // check frs currencies and planned budget currency match
      if (this._frsAndPlannedBudgetCurrenciesMatch(frsDetails.frs, intervention.planned_budget.currency)) {
        // currencies are the same => check amounts consistency
        if (this.checkFrsAndUnicefCashAmountsConsistency(intervention.planned_budget.unicef_cash_local,
                frsDetails.total_frs_amt, intervention, 'interventionDetails', false, skipEmptyListCheck)) {
          warnFrsFields.push('Total FR amount');
          warnIntervFields.push('UNICEF contribution');
        }
      } else {
        // currencies of the frs and planned budget do NOT match
        computedWarning = this._frsConsistencyWarnings.currenciesDoNotMatch;
      }

      if (warnFrsFields.length > 0) {
        computedWarning += warnFrsFields.join(', ') + ' ' + (warnFrsFields.length > 1 ? 'are' : 'is') +
            ' not the same as PD/SSFA ' + warnIntervFields.join(', ') + '.';
      }
      return computedWarning !== '' ? computedWarning : false;
    },

    checkFrsAndUnicefCashAmountsConsistency: function(unicefCash, frsTotalAmt, intervention,
                                                      interventionIsFromWhere, returnMsg, skipEmptyListCheck) {
      if (!this.validateFrsVsUnicefCashAmounts(unicefCash, frsTotalAmt, intervention, interventionIsFromWhere,
              skipEmptyListCheck)) {
        return returnMsg ? this.getFrsTotalAmountInconsistencyMsg() : true;
      }
      return false;
    },
    /**
     * skipEmptyListCheck - skip required when in the process of adding a new FR number
     */
    validateFrsVsUnicefCashAmounts: function(unicefCash, frsTotalAmt, intervention,
                                             interventionIsFromWhere, skipEmptyListCheck) {
      if (intervention.status === 'closed'
        || (!skipEmptyListCheck && this.emptyFrsList(intervention, interventionIsFromWhere))) {
        return true;
      }
      let totalUnicefContribution = parseFloat(unicefCash);
      let totalFrsAmount = parseFloat(frsTotalAmt);
      let unicefContibutionDiff = Math.abs(totalUnicefContribution - totalFrsAmount);

      return unicefContibutionDiff < 10;
    },

    checkFrsAndIntervDateConsistency: function(intervDateStr, frsDateStr, fieldName, returnMsg) {
      if (!this.validateFrsVsInterventionDates(intervDateStr, frsDateStr)) {
        return returnMsg
            ? this._buildFrsWarningMsg(this._frsConsistencyWarnings.dateTmpl, '<<field_name>>', fieldName)
            : true;
      }
      return false;
    },
    validateFrsVsInterventionDates: function(intervDateStr, frsDateStr) {
      if (!frsDateStr || !intervDateStr) {
        // No Fr added or interv dates not set yet
        return true;
      }
      return intervDateStr === frsDateStr;
    },
    _buildFrsWarningMsg: function(msgTemplate, searchStr, replacementStr) {
      return msgTemplate.replace(new RegExp(searchStr, 'g'), replacementStr);
    },
    getFrsTotalAmountInconsistencyMsg: function() {
      return this._frsConsistencyWarnings.amount;
    },
    getFrsStartDateValidationMsg: function() {
      return this._buildFrsWarningMsg(this._frsConsistencyWarnings.dateTmpl,
          '<<field_name>>', 'start date');
    },
    getFrsEndDateValidationMsg: function() {
      return this._buildFrsWarningMsg(this._frsConsistencyWarnings.dateTmpl,
          '<<field_name>>', 'end date');
    },
    frsConsistencyWarningIsActive: function(warnMsg) {
      return !!warnMsg;
    },

    getFrsInconsistentFieldClass: function(warn) {
      return !!warn ? 'frs-inconsistent' : '';
    },

    emptyFrsList: function(intervention, interventionIsFromWhere) {
      // * The intervention object from interventions-list
      // has different properties than the one on intervention-details
      if (interventionIsFromWhere === 'interventionDetails') {
        return !intervention || !intervention.frs_details || intervention.frs_details.frs.length === 0;
      } else if (interventionIsFromWhere === 'interventionsList') {
        return !intervention.frs_earliest_start_date || !intervention.frs_latest_end_date;
      }
    }

  };

  /** @polymerBehavior */
  EtoolsPmpApp.Behaviors.FrNumbersConsistency = [
    EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
    EtoolsPmpApp.Behaviors.FrNumbersConsistencyImpl
  ];
</script>
