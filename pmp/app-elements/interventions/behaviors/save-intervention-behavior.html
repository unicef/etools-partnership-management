<link rel="import" href="modified-intervention-fields-behavior.html">
<link rel="import" href="../../../app-behaviors/array-helper-behavior.html">

<script>
  window.pmpBehaviors = window.pmpBehaviors || {};
  /** @polymerBehavior pmpBehaviors.SaveInterventionBehaviorImpl */
  pmpBehaviors.SaveInterventionBehaviorImpl = {

     _validateAndSaveIntervention: function(event) {
        if (event) {
          event.stopImmediatePropagation();
        }
        this.saved.justSaved = true;
        this.set('serverErrors', []);
        this.set('errorMsgBox_Title', 'Errors Saving PD/SSFA');
        if (!this._hasEditPermissions(this.permissions, this.intervention)) {
          return;
        }

       var interventionDetailsEl = this.$$('#interventionDetails');
       var interventionDetailsAreValid = false;
       if (interventionDetailsEl && typeof interventionDetailsEl.validate === 'function') {
         interventionDetailsAreValid = interventionDetailsEl.validate();
       } else {
         // details element not stamped...
         // validate current data that belongs to details tab against permissions
         interventionDetailsAreValid = this._validateDetailsData();
         this.set('_forceDetUiValidationOnAttach', true);
       }

       var reviewAndSignEl = this.$$('#interventionReviewAndSign');
       var reviewAndSignIsValid = false;
       if (reviewAndSignEl && typeof reviewAndSignEl.validate === 'function') {
         reviewAndSignIsValid = reviewAndSignEl.validate();
       } else {
         // review and signed element not stamped...
         // validate current data that belongs to this tab tab against permissions
         reviewAndSignIsValid = this._validateReviewAndSignedData();
         this.set('_forceReviewUiValidationOnAttach', true);
       }

        if (!interventionDetailsAreValid || !reviewAndSignIsValid) {
          this._showErrorsWarning(interventionDetailsAreValid, reviewAndSignIsValid);
          return;
        }

        var interventionData;
        if (this._isNewIntervention()) {
          interventionData = Object.assign({}, this.intervention);
          interventionData.status = 'draft';
        } else {
          var modifiedDetails = this._getModifiedInterventionDetails();
          var modifiedReviewAndSign = this._getModifiedReviewAndSign();
          interventionData = Object.assign({id: this.intervention.id}, modifiedDetails, modifiedReviewAndSign);
        }

        if (event && !_.isEmpty(interventionData.amendments)) {
          //* An Amendment was just added and the method _validateAndSaveIntervention was NOT called manually
          this._showFinalizeAmendmentDialog();
          return;
        }

        this._prepareDataForSave(interventionData, interventionDetailsEl);

        this.$.interventionData.saveIntervention(interventionData, this._newInterventionSaved);
      },

      _validateDetailsData: function() {
        let valid = true;
        let interventionFields = ['agreement', 'document_type', 'title', 'offices', 'unicef_focal_points',
          'partner_focal_points', 'country_programme', 'start', 'end', 'sector_locations'];
        let i;
        let fieldRequired;
        let fieldVal;
        for (i = 0; i < interventionFields.length; i++) {
          fieldRequired = this.intervention.permissions.required[interventionFields[i]];
          fieldVal = this.intervention[interventionFields[i]];
          if (fieldRequired && _.isEmpty(fieldVal)) {
            valid = false;
            break;
          }
        }
        return valid;
      },

      _validateReviewAndSignedData: function() {
        let valid = true;
        // TODO: ...
        return valid;
      },

      _prepareDataForSave: function(interventionData, interventionDetailsEl) {
        // prepare fr numbers
        if (Array.isArray(this.intervention.frs) && this._needFrsUpdate(this.intervention.frs)) {
          interventionData.frs = this.intervention.frs;
        }
        // frs_details are readonly, we do not have to send them to backend
        delete interventionData.frs_details;

        //no need to send planned_budget.total to backend
        if (interventionData.planned_budget) {
          delete interventionData.planned_budget.total;
        }

        // prepare attachments
        interventionData.attachments = this._prepareAttachments();
        if (_.isEmpty(interventionData.attachments)) {
          delete interventionData.attachments;
        }

        // if prc_review_document is null we need to delete the property otherwise the
        // file gets deleted from the backend
        if (this.intervention.hasOwnProperty('prc_review_document') &&
         _.isEmpty(this.intervention.prc_review_document)) {
          delete interventionData.prc_review_document;
        }

      },

      _showErrorsWarning: function(validDetails, validReviewAndSign) {
        let msg = '';
        if (this.intervention.status === 'draft' && this.intervention.signed_pd_document instanceof File) {
          msg = 'Status of the PD will change to signed once all required fields are completed.';
        } else {
          msg = 'Please review invalid fields data';
          let tabs = [];
          if (validDetails === false) {
            tabs.push('DETAILS');
          }
          if (validReviewAndSign === false) {
            tabs.push('REVIEW & SIGN');
          }
          msg += ' from ' + ((tabs.length > 1) ? (tabs.join(', ') + ' tabs') : (tabs[0] + ' tab')) + '.';
        }

        this.fire('toast', {text: msg, showCloseBtn: true});
      },

      _needFrsUpdate: function(frs) {
        let diff = this.getArraysDiff(this.originalIntervention.frs, frs);
        return diff.length > 0;
      },
  };

  /** @polymerBehavior pmpBehaviors.SaveInterventionBehavior */
  pmpBehaviors.SaveInterventionBehavior = [
    pmpBehaviors.SaveInterventionBehaviorImpl,
    pmpBehaviors.ArrayHelperBehavior,
    pmpBehaviors.ModifiedInterventionFieldsBehavior
  ];
</script>
