<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">

<link rel="import" href="../../app-config/etools-app-config.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">

<link rel="import" href="../../app-behaviors/array-helper-behavior.html">

<link rel="import" href="fr-numbers/update-fr-numbers.html">
<link rel="import" href="behaviors/fr-numbers-validations-behavior.html">

<dom-module id="intervention-fund-reservations">
  <template strip-whitespace>
    <style include="grid-layout-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      #frs-container {
        padding: 16px 0;
      }
      .fr-number {
        padding: 8px 24px;
        font-size: 16px;
        line-height: 24px;
        box-sizing: border-box;
      }
    </style>

    <etools-ajax url="[[_frsDetailsRequestUrl]]"
                 on-success="_frsDetailsSuccessHandler"
                 on-fail="_frsDetailsErrorHandler">
    </etools-ajax>

    <etools-content-panel panel-title="Fund Reservations">
      <paper-icon-button slot="panel-btns"
                         icon="add"
                         on-tap="_openFrsUpdateDialog"
                         disabled$="[[!editMode]]"
                         readonly$="[[!editMode]]"></paper-icon-button>
      <div id="frs-container" hidden$="[[!noFrsWarning(frsDetails)]]">
        <template is="dom-repeat" items="[[frsDetails.frs]]">
          <span class="fr-number">[[item.fr_number]]</span>
        </template>
      </div>
      <div class="row-h" hidden$="[[noFrsWarning(frsDetails)]]">
        <p>There are no fund reservations numbers added.</p>
      </div>
    </etools-content-panel>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-fund-reservations',

        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.ArrayHelperBehavior,
          etoolsBehaviors.DynamicDialogBehavior,
          pmpBehaviors.FrNumbersValidationsBehavior
        ],

        properties: {
          interventionId: Number,
          plannedBudget: Object,
          editMode: {
            type: Boolean,
          },
          updateFrNumbersEl: {
            type: Object
          },
          frsConfirmationsDialog: {
            type: Object
          },
          frsDetails: Object,
          _frsDetailsRequestUrl: String,
          _frsDetailsRequestEndpoint: Object,
          _lastFrsDetailsRequested: {
            type: Array,
            value: []
          },
          _lastFrsDetailsReceived: Object
        },

        ready: function() {
          this.set('_frsDetailsRequestEndpoint', this.getEndpoint('frNumbersDetails'))
        },

        attached: function() {
          this._createUpdateFrNumbersEl();
          this._createFrsConfirmationsDialog();
        },

        detached: function() {
          // remove update frs el on fr el detached
          if (this.updateFrNumbersEl) {
            Polymer.dom(document.querySelector('body')).removeChild(this.updateFrNumbersEl);
          }
          // remove confirmations frs dialog on fr element detached
          if (this.frsConfirmationsDialog) {
            this.removeDialog(this.frsConfirmationsDialog);
          }
        },

        _createUpdateFrNumbersEl: function() {
          // init frs update element
          this.updateFrNumbersEl = document.createElement('update-fr-numbers');
          this.updateFrNumbersEl.setAttribute('id', 'frNumbersUpdateEl');

          // attach frs update handler (on modal/dialog close)
          this.updateFrNumbersEl.addEventListener('update-frs-dialog-close', this.frNumbersUpdateHandler.bind(this));

          Polymer.dom(document.querySelector('body')).appendChild(this.updateFrNumbersEl);
        },

        _createFrsConfirmationsDialog: function() {
          // init frs confirmations dialog element
          var frsConfirmationsDialogMessage = document.createElement('span');
          frsConfirmationsDialogMessage.setAttribute('id', 'frsConfirmationsDialogMessage');
          frsConfirmationsDialogMessage.innerHTML = 'Total FR Numbers Amount is outside (Total Unicef Contribution ' +
              '- 10, Total Unicef Contribution + 10) interval.<br>Do you want to continue?';

          this.frsConfirmationsDialog = this.createDialog('Fund Reservation Warning', 'md', 'Yes', 'No',
              this._frsUpdatesWarningConfirmationHandler.bind(this), frsConfirmationsDialogMessage);
        },

        _openFrsUpdateDialog: function(frNumbersList) {
          if (!this.editMode) {
            return;
          }
          if (this.updateFrNumbersEl) {
            // populate dialog with current frs numbers deep copy
            let frs = frNumbersList instanceof Array
                ? frNumbersList
                : JSON.parse(JSON.stringify(this._getCurrentFrs()));
            this.updateFrNumbersEl.set('dataItems', frs);
            // deactivate save button until any valid change is made
            this.updateFrNumbersEl.set('disableConfirmBtn', true);
            // open dialog
            this.updateFrNumbersEl.openDialog();
            // reset frs details request URL
            this.set('_frsDetailsRequestUrl', null);
          }
        },

        // get current intervention frs numbers
        _getCurrentFrs: function() {
          return (this.frsDetails && this.frsDetails.frs instanceof Array) ? this.frsDetails.frs : [];
        },

        frNumbersUpdateHandler: function(e) {
          e.stopImmediatePropagation();
          let frNumbers = e.detail.frs;
          this.fire('global-loading', {message: 'Checking FR Numbers updates...', active: true});
          if (frNumbers.length === 0) {
            this._handleEmptyFrsAfterUpdate();
            return;
          }
          // FR Numbers not empty
          this._handleNotEmptyFrsAfterUpdate(frNumbers);
        },

        /**
         * After FR Numbers update the numbers list might be empty.
         * This can happen is the user removed all the existing numbers or if there is no change made
         */
        _handleEmptyFrsAfterUpdate: function() {
          let currentInterventionFrs = this._getCurrentFrs();
          if (currentInterventionFrs.length === 0) {
            // there is no change on FR Numbers
            this.fire('global-loading', {active: false});
            return;
          }
          // all FR Numbers have been deleted
          this._triggerPdFrsUpdate({frs: []});
          this.fire('global-loading', {active: false});
        },

        /**
         * Updates made and FR Numbers list is not empty
         */
        _handleNotEmptyFrsAfterUpdate: function(frNumbers) {
          let diff = this.getArraysDiff(this._getCurrentFrs(), frNumbers, 'fr_number');
          if (diff.length) {
            // request FR Numbers details from server
            this._triggerFrsDetailsRequest(frNumbers);
            return;
          } // else no changes have been made to FR Numbers
          this.fire('global-loading', {active: false});
        },

        // handle frs validations warning confirmation
        _frsUpdatesWarningConfirmationHandler: function(e) {
          e.stopImmediatePropagation();
          if (e.detail.confirmed) {
            // confirmed, add numbers to intervention
            this._triggerPdFrsUpdate(Object.assign({}, this._lastFrsDetailsReceived));
            this.set('_lastFrsDetailsReceived', null);
          }
          // frs warning not confirmed/cancelled, frs update is canceled
        },

        /**
         * Get FR Numbers details from server
         */
        _triggerFrsDetailsRequest: function(frNumbers) {
          let url = this._frsDetailsRequestEndpoint.url + '?values=' + frNumbers.join(',');
          if (this.interventionId) {
            url += '&intervention=' + this.interventionId;
          }
          this.set('_lastFrsDetailsRequested', frNumbers);
          this.set('_frsDetailsRequestUrl', url);
        },

        _frsDetailsSuccessHandler: function(e) {
          e.stopImmediatePropagation();
          let frsDetails = e.detail;
          if (!this.validateAgainstPlannedBudget(frsDetails.total_frs_amt, this.plannedBudget)) {
            this.fire('global-loading', {active: false});
            // show warning
            this.set('_lastFrsDetailsReceived', frsDetails);
            this._openFrNumbersAmountsValidationWarning();
            return;
          }
          // append FR numbers to intervention
          this._triggerPdFrsUpdate(frsDetails);
        },

        /**
         * frs details request failed
         */
        _frsDetailsErrorHandler: function(e) {
          e.stopImmediatePropagation();
          this.fire('global-loading', {active: false});
          let frs = this._lastFrsDetailsRequested.map(function(fr) {
            return {fr_number: fr};
          });
          // open FR Numbers modal with the same state as before details request
          this._openFrsUpdateDialog(frs);
          this.set('_lastFrsDetailsRequested', []);
          // show the invalid frs warning
          this.fire('toast', {
            text: e.detail.request.detail.request.response.error,
            showCloseBtn: true
          });

        },

        // trigger new FR Numbers update on main intervention
        _triggerPdFrsUpdate: function(newFrsDetails) {
          this.fire('frs-update', {frsDetails: newFrsDetails});
        },

        noFrsWarning: function(frsDetails) {
          let frs = this._getCurrentFrs();
          return !!frs.length;
        },

        _openFrNumbersAmountsValidationWarning: function() {
          if (this.frsConfirmationsDialog) {
//            let msgEl = Polymer.dom(this.frsConfirmationsDialog.root).querySelector('frsConfirmationsDialogMessage');
//            if (msgEl) {
//              msgEl.innerHTML = '';
//              this.frsConfirmationsDialog.opened = true;
//            } else {
//
//            }
            this.frsConfirmationsDialog.opened = true;
          }
        }

      });
    })();
  </script>
</dom-module>
