<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/etools-currency-amount-input/etools-currency-behavior.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">

<dom-module id="intervention-fund-reservations">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;

        --paper-fab-keyboard-focus-background: #8dc63f; /* TODO: replace with app-theme var */
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }
      paper-input {
        width: 200px;
      }

      .left-col {
        padding-top: 15px;
        padding-bottom: 15px;
      }

      .darkbg {
        padding: 15px;
        background-color: #EDEDED; /* TODO: replace with app-theme var */
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
      }

      .action.delete[disabled] {
        visibility: hidden;
      }

      .fr-nrs-detalis + .fr-nrs-detalis {
        margin-top: 20px;
      }

    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="row-h item-actions-container">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"
                                 disabled$="[[!editMode]]">
              </paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">
            <div class="row-h">
              <!-- FR Number -->
              <paper-input id$="frNumber_[[index]]"
                           label="FR Number"
                           value="{{item.value}}"
                           placeholder="&#8212;" readonly$="[[!editMode]]"></paper-input>
            </div>
            <template is="dom-if" if="[[_showFrNrDetails(item.value)]]">
              <template is="dom-repeat" items="[[_getFrNrDetails(item.value)]]" as="itemDetail">
                <div class="row-h fr-nrs-detalis">
                  <div class="col col-4 left-col">
                    <!-- Grant -->
                    <paper-input-container class="form-field-wrapper" always-float-label>
                      <label aria-hidden="true">Grant</label>
                      <span class="paper-input-input">[[itemDetail.grant_number]]</span>
                    </paper-input-container>
                  </div>
                  <div class="col col-8 darkbg">
                    <div class="flex-c">
                    <div class="row-h flex-c">
                      <div class="col col-4">
                        <!-- WBS -->
                        <paper-input-container class="form-field-wrapper" always-float-label>
                          <label aria-hidden="true">WBS</label>
                          <span class="paper-input-input">[[itemDetail.wbs]]</span>
                        </paper-input-container>
                      </div>
                      <div class="col col-4">
                        <!-- FC Type -->
                        <paper-input-container class="form-field-wrapper" always-float-label>
                          <label aria-hidden="true">FC Type</label>
                          <span class="paper-input-input">[[itemDetail.fc_type]]</span>
                        </paper-input-container>
                      </div>
                      <div class="col col-4">
                        <!-- FC Reference -->
                        <paper-input-container class="form-field-wrapper" always-float-label>
                          <label aria-hidden="true">FC Reference</label>
                          <span class="paper-input-input">[[itemDetail.fc_ref_number]]</span>
                        </paper-input-container>
                      </div>
                    </div>
                    <div class="row-h flex-c">
                      <div class="col col-4">
                        <!-- Agreement Amount -->
                        <paper-input-container class="form-field-wrapper" always-float-label>
                          <label aria-hidden="true">Agreement Amount</label>
                          <span class="paper-input-input">$ [[_getFormattedAmount(itemDetail.agreement_amount)]]</span>
                        </paper-input-container>
                      </div>
                      <div class="col col-4">
                        <!-- Commitment Amount -->
                        <paper-input-container class="form-field-wrapper" always-float-label>
                          <label aria-hidden="true">Commitment Amount</label>
                          <span class="paper-input-input">$ [[_getFormattedAmount(itemDetail.commitment_amount)]]</span>
                        </paper-input-container>
                      </div>
                      <div class="col col-4">
                        <!-- Expenditure Amount -->
                        <paper-input-container class="form-field-wrapper" always-float-label>
                          <label aria-hidden="true">Expenditure Amount</label>
                          <span class="paper-input-input">$ [[_getFormattedAmount(itemDetail.expenditure_amount)]]</span>
                        </paper-input-container>
                      </div>
                    </div>
                    </div>
                  </div>
                </div>
              </template>
            </template>

          </div>

        </div>
      </template>

    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no fund reservations added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewFundReservationt"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-fund-reservations',

        behaviors: [
          etoolsBehaviors.EtoolsCurrencyBehavior,
          pmpBehaviors.RepeatableDataSetsBehavior
        ],

        properties: {
          frNumbersDetails: {
            type: Object,
            value: null,
            observer: '_detailsChanged'
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          }
        },
        observers: [
          '_dataItemsChanged(dataItems)'
        ],

        ready: function() {
          this.dataSetModel = {value: null};
        },

        _editModeChanged: function(newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        },

        _detailsChanged: function(details) {
          if (!details) {
            this.set('frNumbersDetails', []);
          }
        },

        _dataItemsChanged: function(dataItems) {
          if (!Array.isArray(dataItems)) {
            this.set('dataItems', []);
          } else {
            if (dataItems.length) {
              if (dataItems[0].value) {
                return;
              }
              this.set('dataItems', dataItems.map(function(frNr) {
                return {value: frNr};
              }));
            }
          }
        },

        /**
         * Add new fund reservation
         */
        _addNewFundReservationt: function() {
          this._addElement();
        },

        _showFrNrDetails: function(frNumber) {
          return typeof this.frNumbersDetails === 'object' && this.frNumbersDetails[frNumber];
        },

        _getFrNumberDetails: function(frNumber, detailProperty) {
          if (this._showFrNrDetails(frNumber)) {
            var value = this.frNumbersDetails[frNumber][detailProperty];
            if (!value || (typeof value === 'string' && value === '')) {
              return '-';
            }
            return value;
          }
        },
        _getFrNrDetails: function(frNumber) {
          if (this._showFrNrDetails(frNumber)) {
            return this.frNumbersDetails[frNumber];
          }
          return [];
        },

        _getFormattedAmount: function(amount) {
          return this.displayCurrencyAmount(amount, '0');
        }
      });
    })();
  </script>
</dom-module>
