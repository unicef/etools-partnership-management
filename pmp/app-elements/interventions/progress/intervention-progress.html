<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../../bower_components/etools-currency-amount-input/etools-currency-behavior.html">

<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../common-elements/etools-form-element-wrapper.html">
<link rel="import" href="../../common-elements/etools-progress-bar.html">
<link rel="import" href="../../../app-behaviors/common-behavior.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/list-filter-styles.html">
<link rel="import" href="../../../../styles/page-common-styles.html">

<!-- TODO: remove this mockup data behavior after API is ready to be used  -->
<link rel="import" href="progress-tab-data-mockup.html">

<dom-module id="intervention-progress">

  <template strip-whitespace>

    <style include="page-common-styles shared-styles data-table-styles grid-layout-styles list-filter-styles">
      :host {

      }

      #progress-summary etools-progress-bar {
        margin-top: 16px;
      }

      #cash-progress etools-form-element-wrapper {
        width: 140px;
      }

      #cash-progress etools-form-element-wrapper:first-child {
        margin-right: 24px;
      }

      .ram-indicators-names {
        font-weight: bold;
      }
    </style>

    <paper-material id="progress-summary" class="content-section" elevation="1">
      <div class="row-h">
        <div class="layout-vertical col-4">
          <etools-form-element-wrapper label="PD Duration">
            [[progress.reporting_period]]
          </etools-form-element-wrapper>
          <!-- TODO: progress.pd_progress is unknown, missing -->
          <etools-progress-bar value="[[progress.pd_progress]]"></etools-progress-bar>
        </div>
        <div class="layout-vertical col-4">
          <div class="layout-horizontal" id="cash-progress">
            <etools-form-element-wrapper label="Cash Transfered">
              <!-- TODO: progress.amount_transfered is unknown, missing -->
              $ [[displayCurrencyAmount(progress.amount_transfered, '0.00')]]
            </etools-form-element-wrapper>
            <etools-form-element-wrapper label="Planned">
              <!-- TODO: progress.amount_planned is unknown, missing -->
              $ [[displayCurrencyAmount(progress.amount_planned, '0.00')]]
            </etools-form-element-wrapper>
          </div>
          <!-- TODO: progress.amount_progress is unknown, missing -->
          <etools-progress-bar value="[[progress.amount_progress]]"></etools-progress-bar>
        </div>
        <div class="col col-4">
          <etools-form-element-wrapper label="Overall PD/SSFA Rating by UNICEF">
            On track (21 Aug 2017)
          </etools-form-element-wrapper>
        </div>
      </div>
    </paper-material>

    <template is="dom-repeat" items="[[intervention.result_links]]">

      <etools-content-panel class="content-section" panel-title="[[item.cp_output_name]]">

        <div class="row-v row-second-bg ram-indicators-names">
          <template is="dom-repeat" items="[[item.ram_indicator_names]]" as="ramIndicatorName">
            <span>[[ramIndicatorName]]</span>
          </template>
        </div>

        <div class="row-h" hidden$="[[!_emptyLowerResults(item)]]">
          <p>There are no PD Output or SSFA Expected Results.</p>
        </div>

        <div class="lower-results-table" hidden$="[[_emptyLowerResults(item)]]">

          <etools-data-table-header id="listHeader">
            <etools-data-table-column class="col-9">
              PD Outputs or SSFA Expected Results
            </etools-data-table-column>
            <etools-data-table-column class="col-3">
              Current progress
            </etools-data-table-column>
          </etools-data-table-header>

          <template is="dom-repeat" items="[[item.ll_results]]" as="lowerResult">
            <etools-data-table-row>
              <div slot="row-data">
                <span class="col-9">
                  [[lowerResult.name]]
                </span>
                <span class="col-3">
                  On track (21 Aug 2017)
                </span>
              </div>
              <div slot="row-data-details">
                indicators will go here...
              </div>
            </etools-data-table-row>
          </template>

        </div>

      </etools-content-panel>

    </template>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-progress',

        behaviors: [
          etoolsBehaviors.EtoolsCurrencyBehavior,
          EtoolsLogsBehavior,
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsPmpApp.Behaviors.Common,
          EtoolsPmpApp.Behaviors.ProgressTabDataMockup
        ],

        properties: {
          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          },
          progress: {
            type: Object
          },

          pdDurationProgress: {
            type: Number,
            readOnly: true,
            computed: '_getTimeProgress(intervention.start, intervention.end)'
          },
          cashProgress: {
            type: Number,
            readOnly: true,
            computed: ''
          }
        },

        attached: function() {
          /**
           * Disable loading message for progress tab elements load,
           * triggered by parent element on stamp or by tap event on tabs
           */
          this.fire('global-loading', {active: false, loadingSource: 'interv-page'});
          this.fire('intervention-page-attached');
        },

        _interventionIdChanged: function(id) {
          if (id) {
            let self = this;
            // TODO: endpoint parameter reportId id unknown
            let endpoint = this.getEndpoint('interventionProgress', {pdId: id, reportId: 109});
            this.sendRequest({endpoint: endpoint}).then(function(response) {
              self.set('progress', response);
            }).catch(function(error) {
              let errMsg = 'PD/SSFA progress request failed!';
              self.logError(errMsg, 'intervention-progress', error);
              self.fire('toast', {text: errMsg, showCloseBtn: true});

              // TODO: remove mockup data use
              self.set('progress', self.progressTabDataMokup);
            });
          }
        },

        _getPdDuration: function(start, end) {
          let startDate = this.getDateDisplayValue(start) || 'N/A';
          let endDate = this.getDateDisplayValue(end) || 'N/A';
          return startDate + ' - ' + endDate;
        },

        _getTimeProgress: function(start, end) {
          let todayDateStr = this.getTodayDateStr();
          try {
            if (this.dateIsBetween(start, end, todayDateStr)) {
              let intervalTotalDays = this.dateDiff(start, end);
              let intervalDaysCompleted = this.dateDiff(start, todayDateStr);
              return intervalDaysCompleted * 100 / intervalTotalDays;
            }
          } catch (err) {
            this.logWarn('Time progress compute error', 'intervention-progress', err);
          }
          // if end date is valid and is past date or today's date, progress should be 100%
          if (!this.isValidDate(new Date(start)) && this.isValidDate(new Date(end)) &&
              (this.dateIsBefore(todayDateStr, end) || todayDateStr === end)) {
            return 100;
          }
          return 0;
        },

        _emptyLowerResults: function(result) {
          return result.ll_results.length === 0;
        }
      });

    })();
  </script>

</dom-module>
