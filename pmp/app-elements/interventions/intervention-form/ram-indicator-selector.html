<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">

<link rel="import" href="../../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../intervention-data/cp-output-ram-indicators-data.html">

<dom-module id="ram-indicator-selector">
  <template>
    <style include="grid-layout-styles shared-styles">
      :host {
        width: 100%;
      }
    </style>

    <cp-output-ram-indicators-data ram-indicators="{{cpIndicators}}"
                                   cp-output-id="[[cpOutputId]]">
    </cp-output-ram-indicators-data>

    <div class="row-h flex-c">
      <div class="col col-4">
        <etools-searchable-multiselection-menu id="cpOutput"
                                               label="CP Output"
                                               placeholder="&#8212;"
                                               options="[[cpOutputsOptions]]"
                                               custom-object-options
                                               option-value="id"
                                               option-label="name"
                                               selected="{{cpOutputId}}"
                                               update-selected no-change-event
                                               required auto-validate
                                               error-message="Please select CP Output">
        </etools-searchable-multiselection-menu>
      </div>

      <div class="col col-8">
        <etools-searchable-multiselection-menu id="indicators"
                                               label="CP Indicators(s)"
                                               placeholder="&#8212;"
                                               options="[[cpIndicators]]"
                                               custom-object-options
                                               option-value="id"
                                               option-label="name"
                                               selected="{{selectedCpIndicatorsIds}}"
                                               update-selected no-change-event
                                               required auto-validate
                                               error-message="Please select CP Indicators"
                                               multi>
        </etools-searchable-multiselection-menu>

      </div>
    </div>
  </template>

	<script>
		(function() {
			'use strict';  
			Polymer({
				is: 'ram-indicator-selector',
				behaviors: [
					pmpBehaviors.EtoolsStaticCommonDataReduxBehavior
				],
				properties: {
          cpOutputs: {
            type: Array,
            statePath: 'unmodifiedCpOutputs'
          },
          cpOutputsOptions: {
            type: Array,
            value: []
          },
          cpOutputId: {
            type: Number,
            notify: true,
            observer: '_cpOutputSelected'
          },
          cpIndicators: {
            type: Array,
            value: [],
            observer: '_cpIndicatorsChanged'
          },
          selectedCpIndicatorsIds: {
            type: Array,
            value: [],
            notify: true
          },
          alreadySelectedCpo: {
            type: Array,
            value: []
          }
				},

        observers: [
            '_removeAlreadySelectedCpOs(alreadySelectedCpo, cpOutputs.length)'
        ],

        ready: function() {
          if (this.cpOutputs.length > 0 && this.cpOutputId) {
            this._cpOutputSelected(this.cpOutputId);
          }
        },

        _cpOutputSelected: function(cpOutputId) {
          if (!Array.isArray(this.cpOutputs)) {
            return;
          }
          console.log(cpOutputId);
				  var cpOutputSelector = this.$.cpOutput;
          if (cpOutputId > 0) {
            var currentCpValue = cpOutputSelector.value;
            if (!currentCpValue || (currentCpValue && currentCpValue.id && currentCpValue.id !== cpOutputId)) {
              // if no cpOut selected or selected cpOut id is different than cpOutputId, update selection
              this._setSelectedCpOutput(cpOutputId);
            }
          } else {
            cpOutputSelector.value = null;
          }
        },

        // set selected cp output
        _setSelectedCpOutput: function(id) {
          if (!Array.isArray(this.cpOutputs)) {
            return;
          }
				  var selectedCpOutput = this.cpOutputs.filter(function(cpOut) {
				    return cpOut.id === id;
          })[0];
				  if (selectedCpOutput) {
            this.$.cpOutput.value = selectedCpOutput;
          }
        },

        _cpIndicatorsChanged: function(cpIndicators) {
				  // indicators list changed, reset selection
				  this.set('selectedCpIndicatorsIds', []);
          this.$.indicators.value = [];
          this.$.indicators.selectedValues = null;
        },

        _removeAlreadySelectedCpOs: function(alreadySelectedCpo, cpOutputsLength) {
				  if (cpOutputsLength === 0) {
				    return;
          }
				  this.debounce('removeAlreadySelected', function() {
				    var cpOutputsSelectorOptions = this.cpOutputs.filter(function(cpO) {
				      return alreadySelectedCpo.indexOf(cpO.id) === -1 || cpO.id === this.cpOutputId;
            }.bind(this));
				    this.set('cpOutputsOptions', cpOutputsSelectorOptions);
          }.bind(this), 50);
        }

			});
		})();
	</script>
</dom-module>
