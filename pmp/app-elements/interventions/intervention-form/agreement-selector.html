<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">

<link rel="import" href="../../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="agreement-selector">
  <template>
    <style include="grid-layout-styles shared-styles"></style>
    <div class="row-h flex-c">
      <div class="col col-6">
        <etools-searchable-multiselection-menu id="partner"
                                               label="Partner Organization"
                                               placeholder="&#8212;"
                                               options="[[partnersDropdownData]]"
                                               custom-object-options
                                               option-value="id"
                                               option-label="name"
                                               selected="{{partnerId}}"
                                               update-selected
                                               selected-requires-valid-options
                                               dynamic-align
                                               required auto-validate
                                               error-message="Partner is required"
                                               readonly$="[[!editMode]]">
        </etools-searchable-multiselection-menu>
      </div>

      <div class="col col-6">
        <etools-searchable-multiselection-menu id="agreements"
                                               label="Agreement"
                                               placeholder="&#8212;"
                                               options="[[filteredAgreements]]"
                                               custom-object-options
                                               option-value="id"
                                               option-label="agreement_number"
                                               selected="{{agreementId}}"
                                               update-selected
                                               selected-requires-valid-options
                                               dynamic-align
                                               required auto-validate
                                               error-message="Agreement required"
                                               readonly$="[[!editMode]]">
        </etools-searchable-multiselection-menu>

      </div>
    </div>
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'agreement-selector',
        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior
        ],
        properties: {
          agreementId: {
            type: Number,
            observer: '_agreementIdChanged',
            notify: true
          },
          filteredAgreements: {
            type: Array,
            value: []
          },
          partnersDropdownData: {
            type: Array,
            statePath: 'csoPartners', // 'setPartnersDropdown' Do we need to use only CSO type partners?
            observer: '_partnersDropdownDataChanged'
          },
          agreements: {
            type: Array,
            statePath: 'agreementsList',
            observer: '_agreementsChanged'// Covers issues on refresh when agreements is populated after the rest of the observers run
          },
          partnerId: {
            type: Number,
            notify: true,
            observer: '_partnerSelected'
          },
          selectedAgreement: {
            type: Object,
            value: null,
            notify: true
          },
          editMode: {
            type: Boolean,
            value: false
          },
          interventionId: Number
        },
        resetDropdowns: function() { //TODO - this has to de handled inside the new version of dropdown component
          var agrDropDown = this.$.agreements;
          if (agrDropDown && (!agrDropDown.options || !agrDropDown.options.length)) {
            agrDropDown.value = null;
            agrDropDown.selected = null;
          }
        },
        _partnersDropdownDataChanged: function() {
          this._setSelectedPartnerId();
        },
        _agreementsChanged: function() {
          if (this.selectedAgreement) {
            return;
          }
          this._agreementIdChanged(this.agreementId);
        },
        _agreementIdChanged: function(agreementId) {
          var partnerSelector = this.$.partner;
          var agreementSelector = this.$.agreements;

          if (!this.agreements) {
            return;
          }
          var agreement = _.find(this.agreements, function(agreement) {
            return agreement.id === agreementId;
          });
          this.set('selectedAgreement', agreement);

          if (this.partnersDropdownData && this.partnersDropdownData.length) {
            this._setSelectedPartnerId();
          }
        },
        _setSelectedPartnerId: function() {
          var agreement = this.selectedAgreement;
          if (!agreement || !agreement.partner || this.partnerId === agreement.partner) {
            return;
          }
          var partner = _.find(this.partnersDropdownData, function(partner) {
            return partner.id === agreement.partner;
          });
          if (!partner) {
            this.fire('toast', {text: 'Selected agreement partner partner_type is not CSO!',  showCloseBtn: true});
            return;
          }
          this.set('partnerId', partner.id);
        },
        _filterAgreements: function(partnerId) {
          // this.$.agreements.set('value', null);
          if (!partnerId) {
            this.set('filteredAgreements', []);
            return;
          }

          if (this.selectedAgreement && this.selectedAgreement.partner !== partnerId)  {
            this.set('selectedAgreement', null);
            this.set('agreementId', null);
          }

          // set filtered agreements based on this
          var agreements = _.filter(this.agreements, function(agreement) {
            if (this.interventionId > 0) {
              // existing intervention
              return agreement.partner === partnerId;
            } else {
              // new intervention
              return agreement.partner === partnerId &&
                  ['suspended', 'terminated'].indexOf(agreement.status) === -1;
            }

          }.bind(this));
          this.set('filteredAgreements', agreements);
        },
        _partnerSelected: function(partnerId) {
          // clear agreementSelection
          this._filterAgreements(partnerId);
        },

//        _resetSelectorData: function(partnerDropdown, agreementDropdown) {
//          this.set('agreementId', null);
//          this.set('partnerId', null);
//          partnerDropdown.set('value', []);
//          agreementDropdown.set('value', []);
//        },

        resetValidations: function() {
          this.$.agreements.resetInvalidState();
          this.$.partner.resetInvalidState();
        },

        validate: function() {
          var valid = true;
          if (!this.agreementId) {
            valid = false;
            this.$.agreements.invalid = true;
          }
          if (!this.partnerId) {
            valid = false;
            this.$.partner.invalid = true;
          }
          return valid;
        }

      });
    })();
  </script>
</dom-module>
