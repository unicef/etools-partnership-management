<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../intervention-data/reporting-requirements-data.html">
<link rel="import" href="reporting-requirements-dialog.html">
<link rel="import" href="reporting-requirements-actions.html">

<dom-module id="intervention-reporting-requirements">

  <template strip-whitespace>

    <style include="shared-styles data-table-styles grid-layout-styles">
      :host {
        @apply --layout-flex;
      }
      etools-data-table-header {
        --header-title: {
          display: none;
        };
        --data-table-header: {
          height: 56px;
        };
      }
      .list-container {
        position: relative;
      }
      .actions-button-container {
        color: var(--medium-icon-color);
        flex-direction: row-reverse;
      }

    </style>

    <reporting-requirements-data id="reportingData"
                                 intervention-id="[[interventionId]]"
                                 reporting-requirements="{{reportingRequirements}}">
    </reporting-requirements-data>

    <etools-content-panel panel-title="Partner Reporting Requirements">
      <div slot="panel-btns" id="edit-btns">
        <paper-icon-button icon="add-box"
                           title="Add Reporting Requirement"
                           on-tap="openNewRequirementDialog">
        </paper-icon-button>
      </div>

      <div class="list-container">
        <etools-data-table-header id="listHeader" no-collapse>
          <etools-data-table-column class="col-3">
            Reporting Period Start Date
          </etools-data-table-column>
          <etools-data-table-column class="col-3">
            Reporting Period End Date
          </etools-data-table-column>
          <etools-data-table-column class="col-5">
            Report Due Date
          </etools-data-table-column>
          <etools-data-table-column class="col-1">
            <!-- Actions -->
          </etools-data-table-column>
        </etools-data-table-header>
        <template is="dom-repeat" items="[[reportingRequirements]]">
          <etools-data-table-row no-collapse>
            <div slot="row-data">
              <span class="col-data col-3">
                [[item.start_date]]
              </span>
              <span class="col-data col-3">
                [[item.end_date]]
              </span>
              <span class="col-data col-5">
                [[item.due_date]]
              </span>
              <span class="col-data col-1 actions-button-container">
                <reporting-requirements-actions requirement="[[item]]"></reporting-requirements-actions>
              </span>
            </div>
          </etools-data-table-row>
        </template>
      </div>
    </etools-content-panel>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-reporting-requirements',
        properties: {
          interventionId: Number,
          reportingRequirements: Array,
          requirementsDialog: Object
        },

        listeners: {
          'requiremenet-edit': '_handleRequirementEdit',
          'requiremenet-delete': '_handleRequirementDelete'
        },

        handleRequirementSave: function(event) {
          let newRequirement = event.detail;
          if (newRequirement.start_date && newRequirement.end_date && newRequirement.due_date) {
            this.$.reportingData.addRequirement(newRequirement);
          }
        },

        openNewRequirementDialog: function() {
          this.requirementsDialog.requirement = {};
          this.requirementsDialog.open();
        },

        _handleRequirementEdit: function(event) {
          console.log('requirement edit triggered', event.detail);
        },

        _handleRequirementDelete: function(event) {
          console.log('requirement delete triggered', event.detail);
        },

        ready: function() {
          this.requirementsDialog = document.createElement('reporting-requirements-dialog');
          this.requirementsDialog.setAttribute('id', 'requirementsDialog');
          this.requirementsDialog.addEventListener('save-requirement', this.handleRequirementSave.bind(this));
          Polymer.dom(document.querySelector('body')).appendChild(this.requirementsDialog);
        },

        detached: function() {
          if (this.requirementsDialog) {
            Polymer.dom(document.querySelector('body')).removeChild(this.requirementsDialog);
          }
        },
      });

    })();
  </script>

</dom-module>
