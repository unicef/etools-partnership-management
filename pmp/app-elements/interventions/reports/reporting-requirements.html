<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">

<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-errors-parser-behavior.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="reporting-requirements-dialog.html">
<link rel="import" href="reporting-requirements-actions.html">

<dom-module id="reporting-requirements">

  <template strip-whitespace>

    <style include="shared-styles data-table-styles grid-layout-styles">
      :host {
        @apply --layout-flex;
        --list-row-no-collapse: {
          padding-right: 16px;
        };
      }
      .list-container {
        position: relative;
      }
      .actions-button-container {
        color: var(--medium-icon-color);
        flex-direction: row-reverse;
      }
    </style>

    <etools-content-panel panel-title="Partner Reporting Requirements">
      <div slot="panel-btns" id="edit-btns">
        <paper-icon-button icon="add-box"
                           title="Add Reporting Requirement"
                           on-tap="openNewRequirementDialog">
        </paper-icon-button>
      </div>

      <div class="list-container">
        <etools-data-table-header id="listHeader" no-collapse no-title>
          <etools-data-table-column class="col-4">
            Reporting Period Start Date
          </etools-data-table-column>
          <etools-data-table-column class="col-4">
            Reporting Period End Date
          </etools-data-table-column>
          <etools-data-table-column class="col-3">
            Report Due Date
          </etools-data-table-column>
          <etools-data-table-column class="col-1">
            <!-- Actions -->
          </etools-data-table-column>
        </etools-data-table-header>
        <template is="dom-repeat" items="[[reportingRequirements]]">
          <etools-data-table-row no-collapse>
            <div slot="row-data">
              <span class="col-data col-4">
                [[item.start_date]]
              </span>
              <span class="col-data col-4">
                [[item.end_date]]
              </span>
              <span class="col-data col-3">
                [[item.due_date]]
              </span>
              <span class="col-data col-1 actions-button-container">
                <reporting-requirements-actions requirement="[[item]]"></reporting-requirements-actions>
              </span>
            </div>
          </etools-data-table-row>
        </template>
      </div>
    </etools-content-panel>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'reporting-requirements',
        behaviors: [
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.Endpoints,
          etoolsBehaviors.DynamicDialogBehavior,
          EtoolsPmpApp.Behaviors.AjaxErrorsParser
        ],
        properties: {
          reportingRequirements: Array,
          requirementsDialog: Object,
          deletedItem: Object,
          deleteDialog: Object,
          endpoints: {
            type: Object,
            value: {
              LIST: 'reportRequirementsList',
              ITEM: 'reportRequirementsItem'
            }
          },
          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          },
          deleteConfirmationMessage: {
            type: String,
            value: 'Are you sure you want to remove this reporting requirement?'
          },
          ajaxLoadingMsgSource: {
            type: String,
            value: 'reporting-requirements'
          },
          // remove this and errors show up as toast messages
          errorEventName: {
            type: String,
            value: 'intervention-save-error'
          }
        },

        listeners: {
          'requiremenet-edit': '_handleRequirementEdit',
          'requiremenet-delete': '_handleRequirementDelete'
        },

        ready: function() {
          this._createRequirementsDialog();
          this._createDeleteConfirmationDialog();
        },

        detached: function() {
          this.removeDialog(this.deleteDialog);
          this.removeDialog(this.requirementsDialog);
        },

        _createRequirementsDialog: function() {
          this.requirementsDialog = document.createElement('reporting-requirements-dialog');
          this.requirementsDialog.setAttribute('id', 'requirementsDialog');
          this.requirementsDialog.addEventListener('save-requirement', this.handleDialogConfirm.bind(this));
          Polymer.dom(document.querySelector('body')).appendChild(this.requirementsDialog);
        },

        _createDeleteConfirmationDialog: function() {
          let deleteConfirmationContent = document.createElement('div');
          deleteConfirmationContent.innerHTML = this.deleteConfirmationMessage;
          this.deleteDialog = this.createDialog(this.deleteConfirmationTitle, 'md', 'Yes',
              'No', this._onDeleteConfirmation.bind(this), deleteConfirmationContent);
        },

        openNewRequirementDialog: function() {
          this.requirementsDialog.requirement = {};
          this.requirementsDialog.open();
        },

        handleDialogConfirm: function(event) {
          let newReq = event.detail;
          let self = this;
          if (!newReq.start_date || !newReq.end_date || !newReq.due_date) {

            this.fire('toast', {
              text: 'Can\'t save reporting requirement, please fill in all the dates and try again',
              showCloseBtn: true
            });
          }

          self.fire('global-loading', {
            message: 'Adding reporting requirement',
            active: true,
            loadingSource: self.ajaxLoadingMsgSource
          });

          if (!newReq.id) {
            this.addRequirement(newReq)
              .then(function() {
                self.fire('global-loading', {
                  active: false,
                  loadingSource: self.ajaxLoadingMsgSource
                });
                self.fire('toast', {text: 'Reporting requirement successfully added', showCloseBtn: true});
              }).catch(function(error) {
                self._handleErrorResponse(error);
              });
          } else {
            this.updateRequirement(newReq)
              .then(function() {
                self.reportingRequirements.forEach(function(elem, index) {
                  if (elem.id === newReq.id) {
                    self.set(['reportingRequirements', index], newReq);
                  }
                });

                self.fire('global-loading', {
                  active: false,
                  loadingSource: self.ajaxLoadingMsgSource
                });
                self.fire('toast', {text: 'Reporting requirement successfully updated', showCloseBtn: true});
              }).catch(function(error) {
                self._handleErrorResponse(error);
              });

          }
        },

        _handleRequirementEdit: function(event) {
          this.requirementsDialog.requirement = event.detail;
          this.requirementsDialog.open();
        },

        _handleRequirementDelete: function(event) {
          this.deletedItem = event.detail;
          this.deleteDialog.set('opened', true);
        },

        _onDeleteConfirmation: function(event) {
          let self = this;

          if (!event.detail.confirmed) {
            return;
          }

          self.fire('global-loading', {
            message: 'Removing reporting requirement',
            active: true,
            loadingSource: self.ajaxLoadingMsgSource
          });

          this.deleteRequirement(this.deletedItem)
            .then(function() {
              self.reportingRequirements.forEach(function(elem, index) {
                if (elem.id === self.deletedItem.id) {
                  self.splice('reportingRequirements', index, 1);
                }
              });

              self.fire('global-loading', {
                active: false,
                loadingSource: self.ajaxLoadingMsgSource
              });

              self.fire('toast', {text: 'Reporting requirement successfully removed', showCloseBtn: true});
            }).catch(function(error) {
              self._handleErrorResponse(error);
            });
        },

        _handleErrorResponse: function(error) {
          this.fire('global-loading', {
            active: false,
            loadingSource: this.ajaxLoadingMsgSource
          });
          this.parseRequestErrorsAndShowAsToastMsgs(error);
        },

        deleteRequirement: function(requirement) {
          let endpoint = this.getEndpoint(this.endpoints.ITEM, {reportId: requirement.id});

          return this.sendRequest({method: 'DELETE', endpoint: endpoint});
        },

        updateRequirement: function(requirement) {
          let endpoint = this.getEndpoint(this.endpoints.ITEM, {reportId: requirement.id});

          return this.sendRequest({method: 'PATCH', endpoint: endpoint, body: requirement});
        },

        addRequirement: function(requirement) {
          let endpoint = this.getEndpoint(this.endpoints.LIST, {intervId: this.interventionId});
          let self = this;

          requirement.intervention = this.interventionId;

          return this.sendRequest({method: 'POST', endpoint: endpoint, body: requirement})
            .then(function(response) {
              self.push('reportingRequirements', response);
            });
        },

        _interventionIdChanged: function(newId) {
          let self = this;

          if (newId) {
            let endpoint = this.getEndpoint(this.endpoints.LIST, {intervId: newId});
            this.sendRequest({method:'GET', endpoint: endpoint})
              .then(function(response) {
                self.set('reportingRequirements', response);
              });
          }
        },
      });

    })();
  </script>

</dom-module>
