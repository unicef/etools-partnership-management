<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../scripts/lodash/lodash.html">

<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../../app-behaviors/app-navigation-helper-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/list-filters-behavior.html">
<link rel="import" href="../../app-behaviors/lists-common-behavior.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/list-filter-styles.html">

<link rel="import" href="intervention-data/interventions-list-data.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="interventions-list">

  <template strip-whitespace>

    <style include="shared-styles data-table-styles grid-layout-styles list-filter-styles">
      :host {
        @apply(--layout-flex);
        width: 100%;
      }
    </style>

    <template is="dom-if" if="[[stampListData]]">
      <interventions-list-data id="interventions"
                           filtered-interventions="{{filteredInterventions}}"
                           total-results="{{totalResults}}"
                           on-interventions-loaded="_requiredDataHasBeenLoaded"
                           list-data-path="filteredInterventions"
                           fire-data-loaded>
      </interventions-list-data>
    </template>

    <paper-material id="listControls" elevation="1">

      <div class="wrap-controls">

        <paper-input id="query"
                     type="search"
                     placeholder="Search"
                     autocomplete="off"
                     value="{{q}}">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>

        <template is="dom-repeat" items="[[selectedFilters]]" as="filter">

          <template is="dom-if" if="[[filterTypeIs('esmm', filter.type)]]">
            <div class="filter esmm">
              <etools-multi-selection-menu
                  label="[[filter.filterName]]"
                  placeholder="&#8212;"
                  disabled$="[[!filter.selectionOptions.length]"
                  options="[[filter.selectionOptions]]"
                  option-value="[[filter.optionValue]]"
                  option-label="[[filter.optionLabel]]"
                  selected-values="[[filter.alreadySelected]]"
                  trigger-value-change-event
                  on-etools-selected-items-changed="esmmValueChanged"
                  data-filter-path$="[[filter.path]]">
              </etools-multi-selection-menu>
              <paper-icon-button suffix class="remove-field remove" icon="cancel"
                                 on-tap="removeFilter"
                                 data-filter-name$="[[filter.filterName]]"
                                 data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>

          <template is="dom-if" if="[[filterTypeIs('datepicker', filter.type)]]">
            <div class="filter">
              <paper-input id$="datepicker_parent_[[filter.path]]"
                           label="[[filter.filterName]]"
                           value="[[prettyDate(filter.dateSelected)]]"
                           on-down="openDatePicker"
                           data-selector$="datepicker_[[filter.path]]">
                <etools-datepicker-button prefix
                                          id$="datepicker_[[filter.path]]"
                                          date="[[prepareDate(filter.dateSelected)]]"
                                          format="D MMM YYYY"
                                          parent-id$="datepicker_parent_[[filter.path]]"
                                          data-filter-path$="[[filter.path]]"
                                          on-date-has-changed="_filterDateHasChanged"
                                          no-init show-clear-btn fire-date-has-changed>
                </etools-datepicker-button>
              </paper-input>
              <paper-icon-button suffix class="remove-field remove" icon="cancel"
                                 on-tap="removeFilter"
                                 data-filter-name$="[[filter.filterName]]"
                                 data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>

        </template>
      </div>

      <div class="fixed-controls">

        <div class="filters-divider"></div>

        <paper-menu-button id="filterMenu" dynamic-align>
          <paper-button class="button dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>add filter</paper-button>
          <paper-menu class="dropdown-content">
            <template is="dom-repeat" items="[[availableListFilterOptions]]">
              <paper-item on-tap="selectFilter">[[item.filterName]]</paper-item>
            </template>
          </paper-menu>
        </paper-menu-button>

      </div>
    </paper-material>

    <paper-material id="list" elevation="1">

      <etools-data-table-header id="listHeader" label="[[visibleRange.0]]-[[visibleRange.1]] of [[totalResults]] results to show">
        <etools-data-table-column class="col-2" field="number" sortable>
          Reference #
        </etools-data-table-column>
        <etools-data-table-column class="col-3" field="partner_name" sortable>
          Partner Name
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="document_type">
          Document Type
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="status">
          Status
        </etools-data-table-column>
        <etools-data-table-column class="col-2" field="title">
          Title
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="start" sortable>
          Start Date
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="end" sortable>
          End Date
        </etools-data-table-column>
      </etools-data-table-header>

      <template id="rows" is="dom-repeat" notify-dom-change items="[[filteredInterventions]]"
                as="intervention" initial-count="10" on-dom-change="_listDataChanged">
        <etools-data-table-row details-opened="[[detailsOpened]]">
          <div slot="row-data">
            <span class="col-data col-2">
              <a class="truncate"
                href="interventions/[[intervention.id]]/details"
                title="[[getDisplayValue(intervention.number)]]">
                [[getDisplayValue(intervention.number)]]
              </a>
            </span>
            <span class="col-data col-3" title="[[getDisplayValue(intervention.partner_name)]]">
                <span class="truncate">[[getDisplayValue(intervention.partner_name)]]</span>
            </span>
            <span class="col-data flex-c">
                [[getDisplayValue(intervention.document_type)]]
            </span>
            <span class="col-data flex-c capitalize">
                [[getDisplayValue(intervention.status)]]
            </span>
            <span class="col-data col-2" title="[[getDisplayValue(intervention.title)]]">
                [[getDisplayValue(intervention.title)]]
            </span>
            <span class="col-data flex-c">
                [[_checkAndShowInterventionDate(intervention.start)]]
            </span>
            <span class="col-data flex-c">
                [[_checkAndShowInterventionDate(intervention.end)]]
            </span>
          </div>
          <div slot="row-data-details">

            <div class="row-details-content col-2">
              <span class="rdc-title">Offices</span>
              <span><!-- TODO --></span>
            </div>
            <div class="row-details-content col-2">
              <span class="rdc-title">Sectors</span>
              <span>[[getDisplayValue(intervention.sectors)]]</span>
            </div>
            <div class="row-details-content col-2">
              <span class="rdc-title">Total CSO Contribution</span>
              <span>$ [[getDisplayValue(intervention.cso_contribution)]]</span>
            </div>
            <div class="row-details-content col-2">
              <span class="rdc-title">Total UNICEF Budget</span>
              <span>$ [[getDisplayValue(intervention.unicef_budget)]]</span>
            </div>

          </div>
        </etools-data-table-row>
      </template>

      <etools-data-table-footer
          page-size="[[pageSize]]"
          page-number="[[pageNumber]]"
          total-results="[[totalResults]]"
          visible-range="{{visibleRange}}"
          on-page-size-changed="_pageSizeChanged"
          on-page-number-changed="_pageNumberChanged">
      </etools-data-table-footer>

    </paper-material>

  </template>

  <script>
    (function() {
      'use strict';

      var _interventionsLastNavigated = null;

      Polymer({
        is: 'interventions-list',

        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.AppNavigationHelperBehavior,
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior,
          pmpBehaviors.DropdownBehavior,
          pmpBehaviors.ListFiltersBehavior,
          pmpBehaviors.ListsCommonBehavior
        ],

        properties: {
          filteredInterventions: {
            type: Array,
            notify: true,
            observer: '_listChanged'
          },

          documentTypes: {
            type: Array,
            statePath: 'interventionDocTypes'
          },

          selectedDocumentTypes: {
            type: Array,
            observer: '_filtersChanged'
          },

          interventionStatuses: {
            type: Array,
            statePath: 'interventionStatuses'
          },

          selectedStatuses: {
            type: Array,
            observer: '_filtersChanged'
          },

          startDate: {
            type: String,
            observer: '_dateChanged'
          },

          endDate: {
            type: String,
            observer: '_dateChanged'
          },

          totalPages: {
            type: Number
          },

          visibleRange: {
            type: Array
          },

          urlParams: {
            type: Object
          },

          initComplete: {
            type: Boolean,
            value: false
          },
          cpOutputs: {
            type: Array,
            statePath: 'cpOutputs'
          },
          selectedCpOutputs: {
            type: Array,
            observer: '_filtersChanged'
          },

          sectors: {
            type: Array,
            statePath: 'sectors'
          },

          selectedSectors: {
            type: Array,
            observer: '_filtersChanged'
          },

          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },

          selectedUnicefFocalPoints: {
            type: Array,
            observer: '_filtersChanged'
          },

          offices: {
            type: Array,
            statePath: 'offices'
          },

          selectedOffices: {
            type: Array,
            observer: '_filtersChanged'
          },
          csvDownloadUrl: {
            type: String,
            notify: true
          },
        },

        listeners: {
          'sort-changed': '_sortOrderChanged',
        },

        observers: [
          '_initListFilters(documentTypes, sectors, interventionStatuses, offices, cpOutputs, unicefUsersData)',
          '_updateURL(q, selectedDocumentTypes, selectedCpOutputs, selectedStatuses, selectedSectors, ' +
            'selectedUnicefFocalPoints, selectedOffices, startDate, endDate, pageNumber, pageSize, sortOrder, ' +
            'requiredDataLoaded, initComplete)',
          '_init(active)'
        ],

        ready: function() {
          this.$.list.classList.add('hidden');
        },

        attached: function() {
          this.listAttachedCallback(this.active, 'Loading PD/SSFA list data...');
        },

        _initListFilters: function(documentTypes, sectors, interventionStatuses, offices, cpOutputs, unicefUsersData) {
          this.debounce('init-intervention-filters', function() {
            // init list filter options
            // IMPORTANT!!!
            // If you change filterName make sure you update it as well in _updateSelectedFiltersValues method
            // IMPORTANT!!!
            this.initListFiltersData([
              {
                filterName: 'PD/SSFA Type',
                type: 'esmm', // etools-multi-selection-menu
                optionValue: 'value',
                optionLabel: 'label',
                selectionOptions: this.documentTypes,
                alreadySelected: _.map(this.selectedDocumentTypes, 'value'),
                path: 'selectedDocumentTypes'
              },
              {
                filterName: 'Country Programme Output',
                type: 'esmm', // etools-multi-selection-menu
                optionValue: 'id',
                optionLabel: 'name',
                selectionOptions: this.cpOutputs,
                alreadySelected: _.map(this.selectedCpOutputs, 'id'),
                path: 'selectedCpOutputs'
              },
              {
                filterName: 'Sectors',
                type: 'esmm', // etools-multi-selection-menu
                optionValue: 'id',
                optionLabel: 'name',
                selectionOptions: this.sectors,
                alreadySelected: _.map(this.selectedSectors, 'id'),
                path: 'selectedSectors'
              },
              {
                filterName: 'Status',
                type: 'esmm', // etools-multi-selection-menu
                optionValue: 'value',
                optionLabel: 'label',
                selectionOptions: this.interventionStatuses,
                alreadySelected: _.map(this.selectedStatuses, 'value'),
                path: 'selectedStatuses'
              },
              {
                filterName: 'UNICEF focal point',
                type: 'esmm', // etools-multi-selection-menu
                optionValue: 'user_id',
                optionLabel: 'full_name',
                selectionOptions: this.unicefUsersData,
                alreadySelected: _.map(this.selectedUnicefFocalPoints, 'user_id'),
                path: 'selectedUnicefFocalPoints'
              },
              {
                filterName: 'Offices',
                type: 'esmm', // etools-multi-selection-menu
                optionValue: 'id',
                optionLabel: 'name',
                selectionOptions: this.offices,
                alreadySelected: _.map(this.selectedOffices, 'id'),
                path: 'selectedOffices'
              },
              {
                filterName: 'Starts After',
                type: 'datepicker', // etools-datepicker
                path: 'startDate',
                dateSelected: ''
              },
              {
                filterName: 'Ends Before',
                type: 'datepicker', // etools-datepicker
                path: 'endDate',
                dateSelected: ''
              }
            ]);
          }.bind(this));
        },

        // Input: URL query params
        // Initializes the properties of the list at page load
        // to the params interpretted from the URL string.
        _init: function(active) {
          var parms = this.urlParams;
          if (!active || !parms) {
            return;
          }
          this.set('initComplete', false);
          this.set('q', parms.q ? parms.q : '');
          this.set('selectedDocumentTypes', parms.type ? this._setSelectedDocTypes(parms.type) : []);
          this.set('selectedStatuses', parms.status ? this._setSelectedStatuses(parms.status) : []);
          this.set('selectedCpOutputs', parms.cp_outputs ? this._setSelectedCpOutputs(parms.cp_outputs) : []);
          this.set('selectedSectors', parms.sector ? this._setSelectedSectors(parms.sector) : []);
          this.set('selectedUnicefFocalPoints',
              parms.unicef_focal_points ? this._setSelectedUnicefFocalPoints(parms.unicef_focal_points) : []);
          this.set('selectedOffices', parms.offices ? this._setSelectedOffices(parms.offices) : []);
          this.set('startDate', parms.start ? parms.start : '');
          this.set('endDate', parms.end ? parms.end : '');
          this.set('pageNumber', parms.page ? parseInt(parms.page) : 1);
          this.set('pageSize', parms.size ? parseInt(parms.size) : this.defaultListsSize);
          // format of sort param is sort=field.order ex: sort=name.asc
          var result = {field: 'partner_name', direction: 'asc'};
          if (parms.sort) {
            var p = parms.sort.split('.');
            result = {field: p[0], direction: p[1]};
          }
          this.set('sortOrder', result);
          this.set('initComplete', true);

          this._updateSelectedFiltersValues();
        },

        // update selected filters(przent in URL) at page refresh
        _updateSelectedFiltersValues: function() {
          this.debounce('updateShownFilters', function() {
            var filtersValues = [
              {
                filterName: 'PD/SSFA Type',
                selectedValue: _.map(this.selectedDocumentTypes, 'value')
              },
              {
                filterName: 'Status',
                selectedValue: _.map(this.selectedStatuses, 'value')
              },
              {
                filterName: 'Country Programme Output',
                selectedValue: _.map(this.selectedCpOutputs, 'id')
              },
              {
                filterName: 'Sectors',
                selectedValue: _.map(this.selectedSectors, 'id')
              },
              {
                filterName: 'UNICEF focal point',
                selectedValue: _.map(this.selectedUnicefFocalPoints, 'user_id')
              },
              {
                filterName: 'Offices',
                selectedValue: _.map(this.selectedOffices, 'id')
              },
              {
                filterName: 'Starts After',
                selectedValue: this.startDate
              },
              {
                filterName: 'Ends Before',
                selectedValue: this.endDate
              }
            ];
            this.updateShownFilters(filtersValues);
          }.bind(this), 100);
        },

        // Updates URL state with new query string, and launches query
        _updateURL: function() {
          if (!this.requiredDataLoaded || !this.initComplete) {
            return;
          }

          this.set('csvDownloadUrl', this._buildCsvDownloadUrl());
          var qs = this._buildQueryString();

          if (qs !== _interventionsLastNavigated) {
            _interventionsLastNavigated = qs;
            // update URL
            this.updateAppState('interventions/list', qs, true);
            // filter interventions
            if (this.requiredDataLoaded) {
              this._filterInterventionsData();
            }
          } else {
            if (location.search === '') {
              // only update URL query string, without location change event being fired(no page refresh)
              this.updateAppState('interventions/list', qs, false);
            }
            if (this.forceDataRefresh && this.requiredDataLoaded) {
              // refilter agreements data
              // this will only execute when agreements-loaded event is received
              this._filterInterventionsData();
              this.set('forceDataRefresh', false);
            }
          }
        },

        _prepareQueryStrVal: function(arr, prop) {
          return _.map(arr, function(obj) {
            return obj[prop] + '';
          });
        },
        _filterInterventionsData: function(forceNoLoading) {
          // Query is debounced with a debounce time
          // set depending on what action the user takes
          this.debounce('query', function() {
            var interventions = this.$$('#interventions');
            if (!interventions) {
              return;
            }
            interventions.query(
              this.sortOrder.field,
              this.sortOrder.direction,
              this.q.toLowerCase(),
              _.map(this.selectedDocumentTypes, 'value'),
              this._prepareQueryStrVal(this.selectedCpOutputs, 'id'),
              _.map(this.selectedStatuses, 'value'),
              _.map(this.selectedSectors, 'name'),
              this._prepareQueryStrVal(this.selectedUnicefFocalPoints, 'user_id'),
              this._prepareQueryStrVal(this.selectedOffices, 'id'),
              this.startDate,
              this.endDate,
              this.pageNumber,
              this.pageSize,
              forceNoLoading ? false : this.showQueryLoading
            );
          }, this.debounceTime);
        },

        // Outputs the query string for the list
        _buildQueryString: function() {
          var out = [];
          if (this.pageNumber && this.pageNumber > 1) {
            out.push('page=' + this.pageNumber);
          }
          if (this.pageSize) {
            out.push('size=' + this.pageSize);
          }
          if (this.q && this.q.length) {
            out.push('q=' + this.q);
          }

          if (this.selectedDocumentTypes && this.selectedDocumentTypes.length) {
            out.push('type=' + _.map(this.selectedDocumentTypes, 'value').join('|'));
          }

          if (this.selectedCpOutputs && this.selectedCpOutputs.length) {
            out.push('cp_outputs=' + _.map(this.selectedCpOutputs, 'id').join('|'));
          }

          if (this.selectedStatuses && this.selectedStatuses.length) {
            out.push('status=' + _.map(this.selectedStatuses, 'value').join('|'));
          }

          if (this.selectedSectors && this.selectedSectors.length) {
            out.push('sector=' + _.map(this.selectedSectors, 'id').join('|'));
          }

          if (this.selectedUnicefFocalPoints && this.selectedUnicefFocalPoints.length) {
            out.push('unicef_focal_points=' + _.map(this.selectedUnicefFocalPoints, 'user_id').join('|'));
          }

          if (this.selectedOffices && this.selectedOffices.length) {
            out.push('offices=' + _.map(this.selectedOffices, 'id').join('|'));
          }

          if (this.startDate && this.startDate.length) {
            out.push('start=' + this.prettyDate(this.startDate, 'YYYY-MM-DD'));
          }
          if (this.endDate && this.endDate.length) {
            out.push('end=' + this.prettyDate(this.endDate, 'YYYY-MM-DD'));
          }
          if (this.sortOrder && this.sortOrder.field && this.sortOrder.direction) {
            out.push('sort=' + this.sortOrder.field + '.' + this.sortOrder.direction);
          }

          return out.join('&');
        },

        _buildCsvDownloadUrl: function() {
          var queryString = '';
          var endpointUrl = '';
          var params = [];

          if (this.selectedDocumentTypes && this.selectedDocumentTypes.length) {
            params.push('document_type=' + this.selectedDocumentTypes[0].value);
          }
          // if (this.selectedCpOutputs && this.selectedCpOutputs.length) {
          //   params.push('country_programme=' + this.selectedCpOutputs[0].id);
          // }
          if (this.selectedSectors && this.selectedSectors.length) {
            params.push('sector=' + this.selectedSectors[0].id);
          }
          if (this.selectedStatuses && this.selectedStatuses.length) {
            params.push('status=' + this.selectedStatuses[0].value);
          }
          if (this.selectedUnicefFocalPoints && this.selectedUnicefFocalPoints.length) {
            var serializedFocalPoints = _.map(this.selectedUnicefFocalPoints, 'user_id');
            serializedFocalPoints = encodeURIComponent(serializedFocalPoints);
            params.push('unicef_focal_points=' + serializedFocalPoints);
          }
          if (this.selectedOffices && this.selectedOffices.length) {
            params.push('office=' + this.selectedOffices[0].id);
          }
          if (this.startDate && this.startDate.length) {
            params.push('start=' + this.prettyDate(this.startDate, 'YYYY-MM-DD'));
          }
          if (this.endDate && this.endDate.length) {
            params.push('end=' + this.prettyDate(this.endDate, 'YYYY-MM-DD'));
          }
          if (this.q && this.q.length) {
            params.push('search=' + this.q);
          }

          params.push('format=csv');
          queryString = params.join('&');
          endpointUrl = this.getEndpoint('interventions').url;

          return endpointUrl + '?' + queryString;
        },

        _setSelectedOffices: function(officesStr) {
          var officesIdsArr = officesStr.split('|');
          if (officesIdsArr && officesIdsArr.length) {
            officesIdsArr = officesIdsArr.map(function(officeIdStr) {
              return parseInt(officeIdStr, 10);
            });
            return this.offices.filter(function(o) {
              return officesIdsArr.indexOf(parseInt(o.id, 10)) > -1;
            });
          }
          return [];
        },

        _setSelectedUnicefFocalPoints: function(focalPtsStr) {
          var focalPtsStrArr = focalPtsStr.split('|');
          if (focalPtsStrArr && focalPtsStrArr.length) {
            focalPtsStrArr = focalPtsStrArr.map(function(fPtsIdStr) {
              return parseInt(fPtsIdStr, 10);
            });
            return this.unicefUsersData.filter(function(u) {
              return focalPtsStrArr.indexOf(parseInt(u.user_id, 10)) > -1;
            });
          }
          return [];
        },
        _setSelectedSectors: function(sectors) {
          var sectorsArr = sectors.split('|');
          if (sectorsArr && sectorsArr.length) {
            var selectedSectors = this.sectors.filter(function(s) {
              return sectorsArr.indexOf(s.id) > -1;
            });
            return selectedSectors;
          }
          return [];
        },

        _setSelectedStatuses: function(statuses) {
          var statusesStrArr = statuses.split('|');
          return this.interventionStatuses.filter(function(status) {
            return statusesStrArr.indexOf(status.value) > -1;
          });
        },

        _setSelectedCpOutputs: function(cpOutputsString) {
          var cpOut = cpOutputsString.split('|');
          if (cpOut && cpOut.length) {
            cpOut = cpOut.map(function(cpOutStrValue) {
              return parseInt(cpOutStrValue, 10);
            });
            return this.cpOutputs.filter(function(cpo) {
              return cpOut.indexOf(parseInt(cpo.id, 10)) > -1;
            });
          }
          return [];
        },
        _setSelectedDocTypes: function(types) {
          var typesStrArr = types.split('|');
          if (typesStrArr && typesStrArr.length) {
            return this.documentTypes.filter(function(t) {
              return typesStrArr.indexOf(t.value) > -1;
            });

          }
          return [];
        },

        _dateChanged: function(date) {
          this.set('pageNumber', 1);
        },

        // verify date and prettify or not
        _checkAndShowInterventionDate: function(dateString) {
          return this.getDisplayValue(dateString, true);
        },

        _filtersChanged: function() {
          this.set('debounceTime', 200);
          this.set('pageNumber', 1);
        }

      });

    })();
  </script>

</dom-module>
