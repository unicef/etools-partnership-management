<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">

<link rel="import" href="../../app-elements/common-elements/etools-form-element-wrapper.html">

<link rel="import" href="expected-results/behaviors/results-behavior.html">
<link rel="import" href="expected-results/behaviors/lower-results-behavior.html">
<link rel="import" href="expected-results/result-cp-output-and-ram-indicators.html">
<link rel="import" href="expected-results/result-link-lower-results.html">
<link rel="import" href="expected-results/indicator-dialog.html">
<link rel="import" href="edit-delete-actions.html">

<dom-module id="intervention-expected-results">
  <template strip-whitespace>
    <style include="grid-layout-styles repeatable-data-sets-styles buttons-styles data-table-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        --list-row-collapse-wrapper: {
          padding: 0;
        };
      }

      .ram-indicators-col {
        @apply --layout-vertical;
        position: relative;
      }

      .ram-indicator-name {
        display: inline-block;
        width: 100%;
      }

      edit-delete-actions {
        visibility: hidden;
      }

      etools-data-table-row div[slot="row-data"]:hover edit-delete-actions {
        visibility: visible;
      }

    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <etools-data-table-header no-title>
        <etools-data-table-column class="col-4">Corresponding CP Output</etools-data-table-column>
        <etools-data-table-column class="col-8">Corresponding CP Indicator(s)</etools-data-table-column>
      </etools-data-table-header>
      <template is="dom-repeat" items="{{dataItems}}">
        <etools-data-table-row details-opened="[[detailsOpened]]">
          <div slot="row-data">
            <div class="col-data col-4">
              <span>[[item.cp_output_name]]</span>
            </div>
            <div class="col-data col-8 ram-indicators-col">
              <template is="dom-repeat" items="[[item.ram_indicator_names]]" as="ramIndicatorName">
                <span class="ram-indicator-name">[[ramIndicatorName]]</span>
              </template>
              <edit-delete-actions hidden$="[[!editMode]]"
                                   data-args$="[[index]]"
                                   on-edit="_editCpOutputAndRamIndicators"
                                   on-delete="_openDeleteConfirmation">
              </edit-delete-actions>
            </div>
          </div>
          <div slot="row-data-details">
            <result-link-lower-results data-items="{{item.ll_results}}"
                                       edit-mode$="[[editMode]]"
                                       expected-result-id="[[item.id]]"
                                       cp-output-id="[[item.cp_output]]"
                                       intervention="[[intervention]]"
                                       on-open-indicator-dialog="_openIndicatorDialog">
            </result-link-lower-results>
          </div>
        </etools-data-table-row>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no results added.</p>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-expected-results',

        behaviors: [
          EtoolsPmpApp.Behaviors.RepeatableDataSets,
          EtoolsPmpApp.Behaviors.ExpectedResults,
          EtoolsPmpApp.Behaviors.LowerResults
        ],

        properties: {
          _deleteEpName: {
            type: String,
            value: 'interventionResultLinkDelete',
            readOnly: true,
          },
          editMode: {
            type: Boolean
          },
          indicatorDialog: {
            type: Object
          },
          indicatorLocationOptions: {
            type: Array
          },
          indicatorSectionOptions: {
            type: Array
          },
          detailsOpened: {
            type: Boolean,
            value: true
          },
          intervention: Object,
          deactivateConfirmDialog: Object
        },

        observers: [
          '_dataItemsChanged(dataItems.length)',
          '_indicatorLocationOptionsUpdate(indicatorLocationOptions, indicatorDialog)',
          '_indicatorSectionOptionsUpdate(indicatorSectionOptions, indicatorDialog)'
        ],

        ready: function() {
          // init cp outputs and ram indicator add/edit element
          this.createAddEditCpOutputRamIndicatorsElement();
          // init PD output or SSFA expected result add/edit element
          this.createLowerResultNameDialog();

          // init indicator dialog data
          this.indicatorDialog = document.createElement('indicator-dialog');
          this.indicatorDialog.setAttribute('id', 'indicatorDialog');

          // attach close handler
          this.indicatorDialog.addEventListener('indicator-dialog-close', function(event) {
            this.indicatorDialogDataReceived(event.detail);
          }.bind(this));

          document.querySelector('body').appendChild(this.indicatorDialog);
        },

        detached: function() {
          if (this.indicatorDialog) {
            document.querySelector('body').removeChild(this.indicatorDialog);
          }
          this.removeCpOutputRamIndicatorsDialog();
          this.removeLowerResultNameDialog();
          this.removeDeactivateIndicatorDialog();
        },

        removeDeactivateIndicatorDialog: function() {
          let body = document.querySelector('body');
          let dialogs = body.querySelectorAll('etools-dialog#deactivateIndicatorDialog');
          console.log('dialogs', dialogs);
          dialogs.forEach(d => body.removeChild(d));
        },

        _dataItemsChanged: function(dataItemsLength) {
          this.setAlreadySelectedCpOutputs(dataItemsLength, this.dataItems);
        },

        _addNewCpOutputAndRamIndicators: function() {
          this.openCpOutputAndRamIndicatorsDialog();
        },

        _editCpOutputAndRamIndicators: function(e) {
          e.stopPropagation();
          let index = parseInt(Polymer.dom(e).localTarget.getAttribute('data-args'), 10);
          if (index < 0) {
            this.logError('Can not edit, invalid index selected', 'expected-results');
            return;
          }

          let result = this.dataItems[index];
          if (!result) {
            this.logError('Result not found in data items by index: ' + index, 'expected-results');
            return;
          }

          this.openCpOutputAndRamIndicatorsDialog(result.id, result.cp_output, result.ram_indicators, index);
        },

        /**
         * Add/update indicators data
         */
        indicatorDialogDataReceived: function(data) {
          try {
            let actionParams = data.actionParams;
            let indicator = data.indicatorData;
            let i;
            for (i = 0; i < this.dataItems.length; i++) {
              //search expected result item by output id
              if (this.dataItems[i].cp_output === actionParams.cpOutputId) {

                if (actionParams.appliedIndicatorsIndex !== null) {
                  // we just edited an indicator, replace data in indicators list
                  this.set(['dataItems', i, 'll_results', actionParams.llResultIndex,
                    'applied_indicators', actionParams.appliedIndicatorsIndex], JSON.parse(JSON.stringify(indicator)));
                } else {
                  // new indicator added
                  this.push(['dataItems', i, 'll_results', actionParams.llResultIndex, 'applied_indicators'],
                      indicator);
                }
                break;
              }
            }
            this._updateInterventionLocAndClusters();
          } catch (err) {
            this.logError('Updating/adding new indicator data in displayed list has failed!',
                'lower-results-behavior', err);
          }
        },

        // open indicator dialog to add or edit indicator
        _openIndicatorDialog: function(event) {
          event.stopImmediatePropagation();
          let actionParams = event.detail;

          if (actionParams.appliedIndicatorsIndex === null) {
            this.indicatorDialog.setTitle('Add Indicator');
          } else {
            this.indicatorDialog.setTitle('Edit Indicator');
          }
          this.indicatorDialog.toastEventSource = this;
          this.indicatorDialog.resetFieldValues();
          this.indicatorDialog.setIndicatorData(actionParams.indicatorData, actionParams);
          this.indicatorDialog.openIndicatorDialog();
          this.indicatorDialog.resetValidationsAndStyle();
        },

        _updateInterventionLocAndClusters: function() {
          this.fire('indicators-changed');
        },

        _indicatorSectionOptionsUpdate: function(sectionOptions) {
          this._updateIndicatorData('sectionOptionsIds', sectionOptions);
        },

        _indicatorLocationOptionsUpdate: function(locationOptions) {
          this._updateIndicatorData('locationOptionsIds', locationOptions);
        },

        _updateIndicatorData: function(property, data) {
          if (this.indicatorDialog && typeof data !== 'undefined') {
            this.indicatorDialog.set(property, data);
          }
        }

      });
    })();
  </script>
</dom-module>
