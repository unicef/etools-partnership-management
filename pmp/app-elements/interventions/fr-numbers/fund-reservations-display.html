<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-currency-amount-input/etools-currency-behavior.html">
<link rel="import" href="../../../../bower_components/etools-info-tooltip/etools-info-tooltip.html">
<link rel="import" href="../../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../app-behaviors/date-behavior.html">
<link rel="import" href="../behaviors/fr-numbers-consistency-behavior.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">

<dom-module id="fund-reservations-display">
  <template strip-whitespace>

    <style include="data-table-styles grid-layout-styles">
      :host {
        --list-column-label: {
          margin-right: 0;
        };
      }
      [hidden] {
        display: none !important;
      }
      #totalsRow {
        --list-row-no-collapse: {
          background-color: var(--light-theme-background-color);
        }
      }
    </style>

    <template is="dom-if" if="[[!frsDetails.frs.length]]">
        <div class="row-h">
          <p>There are no fund reservations added for this intervention.</p>
        </div>
    </template>

    <div class="list-container" hidden$="[[_noFrs(frsDetails)]]">
      <etools-data-table-header id="listHeader"
              no-collapse
              no-title
              hidden$="[[!reportingRequirements.length]]">
        <etools-data-table-column class="col-3">
          FR#
        </etools-data-table-column>
        <etools-data-table-column class="col-3 right-align">
          FR Posting Date
        </etools-data-table-column>
        <etools-data-table-column class="col-2 right-align">
          FR Amount $
        </etools-data-table-column>
        <etools-data-table-column class="col-2 right-align">
          Actual $
        </etools-data-table-column>
        <etools-data-table-column class="col-2 right-align">
          Outstanding DCT $
        </etools-data-table-column>
      </etools-data-table-header>

      <template is="dom-repeat" items="[[frsDetails.frs]]" as="fr">
        <etools-data-table-row no-collapse>
          <div slot="row-data">
            <span class="col-data col-3">[[fr.fr_number]]</span>
            <span class="col-data col-3 right-align">[[prettyDate(fr.start_date)]]</span>
            <span class="col-data col-2 right-align">[[displayCurrencyAmount(fr.intervention_amt, '0.00')]] </span>
            <span class="col-data col-2 right-align">[[displayCurrencyAmount(fr.actual_amt, '0.00')]]</span>
            <span class="col-data col-2 right-align">[[displayCurrencyAmount(fr.outstanding_amt, '0.00')]]</span>
          </div>
        </etools-data-table-row>
      </template>

      <etools-data-table-row no-collapse id="totalsRow">
        <div slot="row-data">
          <span class="col-data col-3"></span>
          <span class="col-data col-3 right-align"><strong>TOTAL</strong></span>
          <span class="col-data col-2 right-align">
            <!-- TODO: this will be needed in the future, after frs validation will be re-designed
              hide-tooltip$="[[!frsConsistencyWarningIsActive(_frsTotalAmountWarning)]]" -->
            <etools-info-tooltip icon="report"
                              hide-tooltip
                              important-warning
                              icon-first right-aligned>
              <span slot="field">[[displayCurrencyAmount(frsDetails.total_intervention_amt, '0.00')]]</span>
              <!--<span slot="message">[[_frsTotalAmountWarning]]</span>-->
            </etools-info-tooltip>
          </span>
          <span class="col-data col-2 right-align"> [[displayCurrencyAmount(frsDetails.total_actual_amt, '0.00')]]</span>
          <span class="col-data col-2 right-align"> [[displayCurrencyAmount(frsDetails.total_outstanding_amt, '0.00')]]</span>
        </div>
      </etools-data-table-row>
    </div>
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'fund-reservations-display',

        behaviors: [
          etoolsBehaviors.EtoolsCurrencyBehavior,
          EtoolsPmpApp.Behaviors.Date,
          EtoolsPmpApp.Behaviors.FrNumbersConsistency
        ],
        properties: {
          intervention: {
            type: Object,
            value: null
          },
          frsDetails: {
            type: Object,
            value: null
          },
          _frsTotalAmountWarning: String
        },
        observers: [
          '_checkFrsAmountConsistency(intervention, frsDetails, intervention.status)'
        ],
        _noFrs: function(frsDetails) {
          return (!frsDetails || !frsDetails.frs || !frsDetails.frs.length);
        },
        _checkFrsAmountConsistency: function(intervention, frsDetails) {
          if (this._noFrs(frsDetails) || !intervention || intervention.status === 'closed') {
            this.set('_frsTotalAmountWarning', '');
            return;
          }
          let warn = this.checkFrsAndUnicefCashAmountsConsistency(intervention.planned_budget.unicef_cash,
              frsDetails.total_frs_amt, intervention, 'interventionDetails', true);
          this.set('_frsTotalAmountWarning', warn);
        }
      });

    })();
  </script>
</dom-module>
