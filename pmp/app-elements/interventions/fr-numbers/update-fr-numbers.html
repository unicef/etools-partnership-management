<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../../../bower_components/etools-dialog/etools-dialog.html">

<link rel="import" href="../../../app-behaviors/repeatable-data-sets-behavior.html">

<link rel="import" href="../../../../styles/app-mixins.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../../styles/buttons-styles.html">

<dom-module id="update-fr-numbers">
  <template strip-whitespace>
    <style include="grid-layout-styles repeatable-data-sets-styles buttons-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        --paper-dialog-scrollable: {
          width: 100%;
          overflow-x: hidden;
          overflow-y: auto;
          max-height: 400px;
          padding: 0;
          margin-top: -20px;
          box-sizing: border-box;
        };
        --etools-dialog-title: {
          margin-bottom: 0 !important;
        }
      }
      paper-input {
        width: 250px;
      }

    </style>

    <etools-dialog id="frsDialog"
                   size="md"
                   dialog-title="Add/Update FR Numbers"
                   ok-btn-text="Add to PD/SSFA"
                   on-close="_checkFrNumbers"
                   disable-confirm-btn="[[disableConfirmBtn]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="item-actions-container">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel">
              </paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h">
              <!-- FR Number -->
              <paper-input id$="fr-nr-[[index]]"
                           label="FR Number"
                           value="{{item.fr_number}}"
                           placeholder="&#8212;"
                           allowed-pattern="[0-9\-]"
                           required
                           auto-validate
                           error-message="Please fill FR Number or remove the field"
                           on-value-changed="_rfNrValueChanged">
              </paper-input>
            </div>
          </div>
        </div>
      </template>

      <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
        There are no fund reservations numbers added.
      </div>

      <div class="row-h">
        <paper-button class="secondary-btn" on-tap="_addNewFundReservation">
          <iron-icon icon="add"></iron-icon>
          Add FR Number
        </paper-button>
      </div>


    </etools-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'update-fr-numbers',
        behaviors: [
          pmpBehaviors.RepeatableDataSetsBehavior
        ],
        properties: {
          editMode: {
            type: Boolean,
            value: true
          },
          deleteDialog: {
            type: Object,
            observer: '_delConfirmationDialogChange'
          },
          deleteConfirmationMessage: {
            type: String,
            value: 'Are you sure you want to delete this FR Number?'
          },
          disableConfirmBtn: {
            type: Boolean,
            value: true
          }
        },
        observers: ['_itemsLengthChanged(dataItems.length)'],

        ready: function() {
          this.dataSetModel = {fr_number: null};
        },
        _delConfirmationDialogChange: function() {
          // update delete confirmation dialog size
          this.deleteDialog.set('size', 'sm');
        },

        openDialog: function() {
          this.$.frsDialog.opened = true;
        },

        validate: function() {
          let valid  = true;
          if (this.dataItems instanceof Array && this.dataItems.length > 0) {
            this.dataItems.forEach(function(item, index) {
              let lastItem = this.$$('#fr-nr-' + index);
              if (lastItem && !lastItem.validate()) {
                valid = false;
              }
            }.bind(this));
          }
          return valid;
        },

        /**
         * Add new fund reservation
         */
        _addNewFundReservation: function() {
          if (!this.validate()) {
            this.set('disableConfirmBtn', true);
            return;
          }
          this._addElement();
          this.set('disableConfirmBtn', true);
          this.async(function() {
            this._centerDialog();
          }.bind(this));
          this.async(function() {
            this._updateScroll();
          }.bind(this), 100);
        },

        _centerDialog: function() {
          let d = this._getPaperDialog();
          if (d) {
            d.center();
          }
        },

        _updateScroll: function() {
          let d = this._getPaperDialog();
          if (d) {
            let dialogScrollable = Polymer.dom(d).querySelector('paper-dialog-scrollable');
            if (dialogScrollable) {
              let scrollTarget = dialogScrollable.scrollTarget;
              scrollTarget.scrollTop = scrollTarget.scrollHeight;
            }
          }
        },

        _getPaperDialog: function() {
          return Polymer.dom(this.$.frsDialog.root).querySelector('paper-dialog');
        },

        _emptyList: function(length) {
          return length === 0;
        },

        _rfNrValueChanged: function() {
          if (!this.validate()) {
            this.set('disableConfirmBtn', true);
            return;
          }
          this.set('disableConfirmBtn', false);
        },

        _itemsLengthChanged: function() {
          this._rfNrValueChanged();
        },

        _checkFrNumbers: function(e) {
          if (e.detail.confirmed) {
            // resend rf number changes back to main fund reservations element
            this.fire('update-frs-dialog-close', {frs: this._getUpdatedFrsNumbers()});
          }
        },

        // prepare the rf numbers list, used to verify them using API endpoint (/api/v2/funds/frs)
        _getUpdatedFrsNumbers: function() {
          if (this.dataItems instanceof Array && this.dataItems.length > 0) {
            return this.dataItems.map(function(item) {
              return item.fr_number;
            });
          }
          return [];
        }

      });
    })();
  </script>
</dom-module>

