<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/etools-info-tooltip/etools-info-tooltip.html">
<link rel="import" href="../../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">

<link rel="import" href="../../../styles/page-common-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/required-field-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<link rel="import" href="../../app-config/environment-flags-behavior.html">
<link rel="import" href="../../app-elements/partners/behaviors/partner-staff-members-data-behavior.html">
<link rel="import" href="../../app-behaviors/common-behavior.html">
<link rel="import" href="../../app-behaviors/esmm-missing-options/missing-dropdown-options-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../common-elements/etools-form-element-wrapper.html">
<link rel="import" href="behaviors/fr-numbers-consistency-behavior.html">

<link rel="import" href="intervention-form/agreement-selector.html">

<link rel="import" href="intervention-planned-budget.html">
<link rel="import" href="intervention-expected-results.html">
<link rel="import" href="intervention-planned-visits.html">
<link rel="import" href="reports/reporting-requirements.html">
<link rel="import" href="grouped-locations-dialog.html">

<dom-module id="intervention-details">

  <template strip-whitespace>

    <style include="page-common-styles grid-layout-styles shared-styles required-field-starred-styles buttons-styles">
      :host {
        @apply --layout-vertical;
        width: 100%;
      }

      paper-input,
      agreement-selector {
        width: 100%;
      }

      .expiry-warning {
        @apply --layout-vertical;
        @apply --layout-flex;
        @apply --layout-end-justified;
        padding-bottom: 12px;
        color: var(--error-color);
      }

      paper-toggle-button {
        font-size: 16px;
      }

      etools-info-tooltip {
        --etools-tooltip-trigger-icon: {
          @apply --pmp-form-field-frs-inconsistency-icon;
        };
      }

      etools-date-input.frs-inconsistent {
        --paper-input-container-input: {
          color: var(--error-color);
        }
      }

      div[no-left-padding] {
        padding-left: 0px !important;
      }

      .names-padding {
        padding-right: 15px;
      }

      .see-locations iron-icon {
        margin-right: 0;
        --iron-icon-height: 18px;
        --iron-icon-width: 18px;
      }
    </style>

    <etools-content-panel class="content-section" panel-title="Partnership Information">
      <div class="row-h flex-c">
        <div class="col col-6">
          <agreement-selector id="agreementSelector"
                              agreement-id="{{intervention.agreement}}"
                              partner-id="{{selectedPartnerId}}"
                              selected-agreement="{{agreement}}"
                              intervention="[[intervention]]"></agreement-selector>
        </div>
        <div class="col col-3">
          <etools-single-selection-menu id="documentType"
                                        label="Document Type"
                                        placeholder="&#8212;"
                                        options="[[_getCurrentDocTypes(agreement, documentTypes)]]"
                                        selected="{{intervention.document_type}}"
                                        hide-search
                                        dynamic-align
                                        readonly$="[[!intervention.permissions.edit.document_type]]"
                                        required$="[[intervention.permissions.required.document_type]]"
                                        auto-validate
                                        error-message="Document type is required">
          </etools-single-selection-menu>

        </div>
        <div class="col col-3" title$="[[intervention.number]]">
          <!-- Reference Number -->
          <paper-input label="Reference Number"
                       value="[[intervention.number]]"
                       placeholder="&#8212;"
                       disabled></paper-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <!-- Title -->
        <paper-input id="title"
                     label="Title"
                     value="{{intervention.title}}"
                     placeholder="&#8212;"
                     char-counter
                     maxlength="256"
                     readonly$="[[!intervention.permissions.edit.title]]"
                     required$="[[intervention.permissions.required.title]]"
                     auto-validate
                     error-message="Please add a title"></paper-input>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <etools-multi-selection-menu id="unicefOffices"
                                       label="UNICEF Office(s)"
                                       placeholder="&#8212;"
                                       options="[[offices]]"
                                       option-label="name"
                                       option-value="id"
                                       selected-values="{{intervention.offices}}"
                                       dynamic-align
                                       readonly$="[[!intervention.permissions.edit.offices]]"
                                       required$="[[intervention.permissions.required.offices]]"
                                       auto-validate
                                       error-message="Please select intervention's office(s)"
                                       avoid-header-overlapping-dropdown>
          </etools-multi-selection-menu>
        </div>
        <div class="col col-6">
          <etools-multi-selection-menu id="unicefFocalPts"
                                       label="UNICEF Focal Point(s)"
                                       placeholder="&#8212;"
                                       options="[[getCleanEsmmOptions(unicefUsersData, intervention)]]"
                                       option-label="name"
                                       option-value="id"
                                       selected-values="{{intervention.unicef_focal_points}}"
                                       dynamic-align
                                       readonly$="[[!intervention.permissions.edit.unicef_focal_points]]"
                                       required$="[[intervention.permissions.required.unicef_focal_points]]"
                                       auto-validate
                                       error-message="Please select UNICEF focal points"
                                       avoid-header-overlapping-dropdown>
          </etools-multi-selection-menu>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <etools-multi-selection-menu id="partnerFocalPts"
                                       label="Partner Focal Point(s)"
                                       placeholder="&#8212;"
                                       options="[[staffMembers]]"
                                       option-value="id"
                                       option-label="name"
                                       selected-values="{{intervention.partner_focal_points}}"
                                       dynamic-align
                                       readonly$="[[!intervention.permissions.edit.partner_focal_points]]"
                                       required$="[[intervention.permissions.required.partner_focal_points]]"
                                       auto-validate
                                       error-message="Please select partner focal points"
                                       avoid-header-overlapping-dropdown>
          </etools-multi-selection-menu>
        </div>
      </div>
    </etools-content-panel>

    <etools-content-panel class="content-section" panel-title="PD or SSFA Details">
      <div class="row-h flex-c row-second-bg">
        <div hidden$="[[!_showContingencyPd(agreement)]]" class="col col-3">
          <paper-toggle-button checked="{{intervention.contingency_pd}}"
                               disabled="[[!intervention.permissions.edit.contingency_pd]]">Contingency PD
          </paper-toggle-button>
        </div>
        <div hidden$="[[!_showStartEndDateFields(agreement, intervention, intervention.contingency_pd)]]"
             class="col col-3" no-left-padding$="[[!_showContingencyPd(agreement)]]">
          <!-- Start date -->
          <!-- TODO: this will be needed in the future, after frs validation will be re-designed
              hide-tooltip$="[[!frsConsistencyWarningIsActive(_frsStartConsistencyWarning)]]" -->
          <etools-info-tooltip icon="report" icon-first
                               hide-tooltip
                               important-warning>
            <!-- TODO: this will be needed in the future, after frs validation will be re-designed
              class$="[[getFrsInconsistentFieldClass(_frsStartConsistencyWarning)]]" -->
            <etools-date-input slot="field"
                               id="intStart"
                               label="Start date"
                               value="{{intervention.start}}"
                               readonly$="[[!intervention.permissions.edit.start]]"
                               required$="[[intervention.permissions.required.start]]"
                               error-message="Please select start date"
                               auto-validate
                               no-init show-clear-btn>
            </etools-date-input>
            <!--<span slot="message">[[_frsStartConsistencyWarning]]</span>-->
          </etools-info-tooltip>

        </div>
        <div hidden$="[[!_showStartEndDateFields(agreement, intervention, intervention.contingency_pd)]]" class="col col-3">
          <!-- TODO: this will be needed in the future, after frs validation will be re-designed
              hide-tooltip$="[[!frsConsistencyWarningIsActive(_frsEndConsistencyWarning)]]" -->
          <etools-info-tooltip icon="report" icon-first
                               hide-tooltip
                               important-warning>
            <!-- TODO: this will be needed in the future, after frs validation will be re-designed
              class$="[[getFrsInconsistentFieldClass(_frsEndConsistencyWarning)]]" -->
            <etools-date-input slot="field"
                               id="intEnd"
                               label="End date"
                               value="{{intervention.end}}"
                               readonly$="[[!intervention.permissions.edit.end]]"
                               required$="[[intervention.permissions.required.end]]"
                               error-message="Please select end date"
                               auto-validate
                               no-init show-clear-btn>
            </etools-date-input>
            <!--<span slot="message">[[_frsEndConsistencyWarning]]</span>-->
          </etools-info-tooltip>
        </div>
        <div class="col col-3"
             hidden$="[[!_showStartEndDateFields(agreement, intervention, intervention.contingency_pd)]]">
          <div class="expiry-warning">
            <span>[[_daysUntilExpiry(intervention.end)]]</span>
          </div>
        </div>
      </div>
      <div class="row-h flex-c">
        <etools-single-selection-menu id="cpStructure"
                                      label="CP Structure"
                                      placeholder="&#8212;"
                                      options="[[cpStructureOptions]]"
                                      option-value="id"
                                      option-label="name"
                                      selected="{{intervention.country_programme}}"
                                      dynamic-align
                                      hide-search
                                      readonly$="[[!intervention.permissions.edit.country_programme]]"
                                      required$="[[intervention.permissions.required.country_programme]]"
                                      auto-validate
                                      error-message="Please select CP Structure">
        </etools-single-selection-menu>
      </div>

      <template is="dom-if" if="[[!environmentFlags.prp_mode_off]]" restamp>
        <div class="row-h flex-c">
          <etools-form-element-wrapper label="Sections PD/SSFA Covers">
            <span class="placeholder" hidden$="[[!_isEmpty(intervention.section_names.length)]]">&#8212;</span>
            <div class="layout-horizontal" hidden$="[[_isEmpty(intervention.section_names.length)]]">
              <template is="dom-repeat" items="[[getFirst3NamesFromArray(intervention.section_names)]]">
                <span class="names-padding">[[item]]</span>
              </template>
            </div>
          </etools-form-element-wrapper>
        </div>
        <div class="row-h flex-c">
          <etools-form-element-wrapper label="Clusters PD/SSFA Contributes To">
            <span class="placeholder" hidden$="[[!_isEmpty(intervention.cluster_names.length)]]">&#8212;</span>
            <template is="dom-repeat" items="[[intervention.cluster_names]]">
              <span class="names-padding">[[item]]</span>
            </template>
          </etools-form-element-wrapper>
        </div>
        <div class="row-h flex-c">
          <etools-form-element-wrapper label="Locations PD/SSFA Covers">
            <span class="placeholder" hidden$="[[!_isEmpty(intervention.location_names.length)]]">&#8212;</span>
            <div class="layout-horizontal" hidden$="[[_isEmpty(intervention.location_names.length)]]">
              <template is="dom-repeat" items="[[getFirst3NamesFromArray(intervention.location_names)]]">
                <span class="names-padding">[[item]]</span>
              </template>
              <paper-button class="secondary-btn see-locations"
                            on-tap="_openLocationsDialog"
                            title="See all locations">
                <iron-icon icon="add"></iron-icon>
                See all
              </paper-button>
            </div>
          </etools-form-element-wrapper>
        </div>
      </template>
      <template is="dom-if" if="[[environmentFlags.prp_mode_off]]" restamp>
        <div class="row-h flex-c">
          <etools-multi-selection-menu id="sections"
                                       label="Section(s)"
                                       placeholder="&#8212;"
                                       selected-values="{{intervention.sections}}"
                                       options="[[sections]]"
                                       option-label="name"
                                       option-value="id"
                                       readonly$="[[!intervention.permissions.edit.sections]]"
                                       required$="[[intervention.permissions.required.sections]]"
                                       auto-validate
                                       error-message="Please select a section">
          </etools-multi-selection-menu>
        </div>
        <div class="row-h flex-c">
          <etools-multi-selection-menu id="locationsDropdw"
                    label="Locations"
                    placeholder="&#8212;"
                    selected-values="{{intervention.flat_locations}}"
                    options="[[locations]]"
                    option-label="name"
                    option-value="id"
                    readonly$="[[!intervention.permissions.edit.flat_locations]]"
                    required$="[[intervention.permissions.required.flat_locations]]"
                    error-message="Please select locations"
                    disable-on-focus-handling>
          </etools-multi-selection-menu>
        </div>
      </template>
    </etools-content-panel>

    <template is="dom-if" if="[[!environmentFlags.prp_mode_off]]" restamp>
      <etools-content-panel class="content-section" panel-title="PD output or SSFA expected result">
        <template is="dom-if" if="[[!newIntervention]]">
          <intervention-expected-results id="expectedResults"
                                        data-items="{{intervention.result_links}}"
                                        selected-cp-structure="[[intervention.country_programme]]"
                                        intervention-id="[[intervention.id]]"
                                        edit-mode$="[[intervention.permissions.edit.result_links]]"
                                        on-indicators-changed="_updateInteventionLocAndClusters">
          </intervention-expected-results>
        </template>
        <template is="dom-if" if="[[newIntervention]]">
          <div class="row-h">
            <p> You must save this PD/SSFA before you can add expected results. </p>
          </div>
        </template>
      </etools-content-panel>
    </template>
    <intervention-planned-budget id="plannedBudget"
                                 class="content-section"
                                 planned-budget="{{intervention.planned_budget}}"
                                 intervention-id="[[intervention.id]]"
                                 intervention="[[intervention]]"
                                 edit-mode="[[intervention.permissions.edit.planned_budget]]"
                                 unicef-cash-edit-mode="[[intervention.permissions.edit.planned_budget_unicef_cash]]"
                                 required="[[intervention.permissions.required.planned_budget]]">
    </intervention-planned-budget>

    <etools-content-panel class="content-section" panel-title="Planned Visits">
      <intervention-planned-visits id="plannedVisits"
                                   data-items="{{intervention.planned_visits}}"
                                   edit-mode$="[[intervention.permissions.edit.planned_visits]]"
                                   years="[[years]]">
      </intervention-planned-visits>
    </etools-content-panel>

    <template is="dom-if" if="[[conditionsAreTrue(!environmentFlags.prp_mode_off, intervention.permissions.view.reporting_periods)]]" restamp>
      <reporting-requirements class="content-section"
                              is-new-intervention="[[newIntervention]]"
                              edit-mode="[[intervention.permissions.edit.reporting_periods]]"
                              intervention-id="[[intervention.id]]">
      </reporting-requirements>
    </template>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-details',

        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
          EtoolsPmpApp.Behaviors.PartnerStaffMembersData,
          EtoolsPmpApp.Behaviors.Common,
          EtoolsPmpApp.Behaviors.EnvironmentFlags,
          EtoolsPmpApp.Behaviors.MissingDropdownOptions,
          EtoolsPmpApp.Behaviors.FrNumbersConsistency
        ],

        properties: {
          intervention: {
            type: Object,
            observer: '_interventionChanged',
            notify: true
          },
          permissions: {
            type: Object
          },
          selectedPartnerId: {
            type: Number,
            notify: true,
            observer: '_selectedPartnerIdChanged'
          },
          documentTypes: {
            type: Array,
            statePath: 'interventionDocTypes'
          },
          pcaDocTypes: {
            type: Array,
            value: []
          },
          ssfaDocTypes: {
            type: Array,
            value: []
          },
          sections: {
            type: Array,
            statePath: 'sections'
          },
          offices: {
            type: Array,
            statePath: 'offices'
          },
          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          countryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          cpStructureOptions: {
            type: Object,
            value: []
          },
          years: {
            type: Array,
            value: []
          },
          agreement: {
            type: Object
          },
          originalIntervention: {
            type: Object
          },
          interventionRequiredField: {
            type: Boolean,
            value: false
          },
          newIntervention: {
            type: Boolean
          },
          fieldsResetted: {
            type: Boolean
          },
          _frsStartConsistencyWarning: {
            type: String,
            value: ''
          },
          _frsEndConsistencyWarning: {
            type: String,
            value: ''
          },
          locations: {
            type: Array,
            statePath: 'locations'
          }
        },

        observers: [
          '_newInterventionFlagChanged(newIntervention)',
          '_setYears(intervention.start, intervention.end)',
          '_checkFrsStartConsistency(intervention.frs_details.earliest_start_date, ' +
            'intervention.start, intervention.status)',
          '_checkFrsEndConsistency(intervention.frs_details.latest_end_date, intervention.end, intervention.status)',
          /*Making sure country_programme is set to default after originalIntervention is set,
           otherwise on save, country_programme is not seen as modified*/
          '_countryProgrammesChanged(countryProgrammes, intervention, originalIntervention)',
          '_contingencyPDChanged(intervention.contingency_pd)'
        ],
        ready: function() {
          this.locationsDialog = document.createElement('grouped-locations-dialog');
          Polymer.dom(document.querySelector('body')).appendChild(this.locationsDialog);
        },
        detached: function() {
          if (this.locationsDialog) {
            Polymer.dom(document.querySelector('body')).removeChild(this.locationsDialog);
          }
        },
        attached: function() {
          /**
           * Disable loading message for details tab elements load,
           * triggered by parent element on stamp or by tap event on tabs
           */
          this.fire('global-loading', {active: false, loadingSource: 'interv-page'});
          this.fire('intervention-page-attached');
          this.setDropdownMissingOptionsAjaxDetails(this.$.unicefFocalPts, 'unicefUsers', {dropdown: true});
        },
        getFirst3NamesFromArray: function(names) {
          if (!names || !names.length) {
            return '';
          }
          return names.slice(0, Math.min(names.length, 3));
        },
        _showStartEndDateFields: function(agreement, intervention, contingencyPd) {
          if (!this._showContingencyPd(agreement)) {
            return true;
          }
          if (contingencyPd && intervention.status !== 'active') {
            return false;
          }
          return true;
        },
        _openLocationsDialog: function() {
          this.locationsDialog.adminLevel = null;
          this.locationsDialog.iterventionLocationIds = this.intervention.locations;
          this.locationsDialog.open();
        },
        _filterCountryProgrammes: function(countryProgrammes) {
          return countryProgrammes.filter(function(cp) {
            return cp.active || cp.future;
          });
        },
        _getCurrentCountryProgramme: function(countryProgrammes) {
          if (countryProgrammes && countryProgrammes.length > 1) {
            return countryProgrammes.find(function(cp) {
              return !cp.future && !cp.special;
            });
          }
          return (countryProgrammes && countryProgrammes.length) ? countryProgrammes[0] : null;
        },
        _countryProgrammesChanged: function(cp) {
          let cpStructures = this._filterCountryProgrammes(cp);
          this.set('cpStructureOptions', cpStructures);
          this._setDefaultSelectedCpStructure(cpStructures);
        },
        _hasExpiredCpAssigned: function(cpId) {
          if (cpId > 0 && this.cpStructureOptions instanceof Array && this.cpStructureOptions.length) {
            let cp = this.cpStructureOptions.find(function(cp) {
              return parseInt(cp.id, 10) === parseInt(cpId, 10);
            });
            if (!cp) {
              return true;
            }
          }
          return false;
        },
        _setDefaultSelectedCpStructure: function(cpStructures) {
          if (this.intervention && this.intervention.country_programme) {
            let cpStructureIsOld = this._hasExpiredCpAssigned(this.intervention.country_programme);
            if (cpStructureIsOld) {
              this.fire('toast', {text: 'This intervention has an old/expired CP Structure!', showCloseBtn: true});
            }
            return;
          }
          let currentCP;
          if (cpStructures && cpStructures.length) {
            if (cpStructures.length === 1) {
              currentCP = cpStructures[0].id;
            } else {
              currentCP = this._getCurrentCountryProgramme(cpStructures);
            }
            this.set('intervention.country_programme', currentCP ? currentCP.id : null);
          }
        },
        _contingencyPDChanged: function(newValue) {
          if (newValue && this.intervention.status === 'signed') {
            this._updateDatesRequiredState(false);
          } else {
            if (['signed', 'active'].indexOf(this.intervention.status) > -1) {
              this._updateDatesRequiredState(true);
            }
          }
          this.$.intStart.updateStyles();
          this.$.intEnd.updateStyles();
        },
        _updateDatesRequiredState: function(isRequired) {
          this.set('intervention.permissions.required.start', isRequired);
          this.set('intervention.permissions.required.end', isRequired);
        },
        _showContingencyPd: function(agreement) {
          if (!agreement) {
            return false;
          }
          if ('PCA' === agreement.agreement_type) {
            return true;
          }
          return false;
        },
        _initDocTypes: function(documentTypes) {
          if (!(documentTypes instanceof Array && documentTypes.length)) {
            return;
          }
          var pcaTypes = [];
          var ssfaTypes = [];
          documentTypes.forEach(function(type) {
            if (type.value !== 'SSFA') {
              pcaTypes.push(type);
            }
            if (type.value === 'SSFA') {
              ssfaTypes.push(type);
            }
          });
          this.set('pcaDocTypes', pcaTypes);
          this.set('ssfaDocTypes', ssfaTypes);
        },

        _interventionChanged: function(intervention) {
          if (intervention && typeof intervention === 'object' && Object.keys(intervention).length > 0) {
            if (!intervention.id) {
              this.set('selectedPartnerId', null);
            }

            this.set('fieldsResetted', false);
            this._newInterventionFlagChanged();
          }
        },

        _newInterventionFlagChanged: function() {
          if (this.intervention && !this.fieldsResetted) {
            this._resetValidations();
          }
        },

        _resetValidations: function() {
          this.$.agreementSelector.resetValidations();
          this.$.documentType.resetInvalidState();
          this.$.plannedBudget.resetValidations();

          var fields = ['documentType', 'title', 'unicefOffices', 'unicefFocalPts',
            'partnerFocalPts', 'cpStructure', 'intStart', 'intEnd'];
          fields.forEach(function(field) {
            this.fieldValidationReset('#' + field);
          }.bind(this));

          let plannedVisitsEl = this.$$('#plannedVisits');
          if (plannedVisitsEl && typeof plannedVisitsEl.resetValidations === 'function') {
            plannedVisitsEl.resetValidations();
          }
          this.set('fieldsResetted', true);
        },

        _setYears: function(interventionStart, interventionEnd) {
          if (typeof interventionStart === 'string' && interventionStart !== ''
              && typeof interventionEnd === 'string' && interventionEnd !== '') {
            var start = parseInt(interventionStart.substr(0, 4), 10);
            var end = parseInt(interventionEnd.substr(0, 4), 10);
            var years = [];
            while (start <= end) {
              years.push({
                value: start,
                label: start
              });
              start++;
            }
            this.set('years', years);
          }
        },

        _selectedPartnerIdChanged: function(id, oldId) {
          if (typeof oldId === 'number'
              && id !== oldId
              && !this.agreement) {
            //Prevent reset on changes caused by initialization of the fields
            this._resetDropdowns();
          }
          this.getPartnerStaffMembers(id);
        },
        _resetDropdowns: function() {
          //Test case - go to existing intervention , then go to New intervention

          // reset partner focal points options and value
          this.set('intervention.partner_focal_points', []);
          this.set('staffMembers', []);
          let partnerFpDropDown = this.$.partnerFocalPts;
          if (partnerFpDropDown && (!partnerFpDropDown.options || !partnerFpDropDown.options.length)) {
            partnerFpDropDown.value = null;
            partnerFpDropDown.selected = null;
          }
        },
        /**
         * When an agreement is selected then check it's type and update document types dropdown
         */
        _getCurrentDocTypes: function(agreement, documentTypes) {
          this._initDocTypes(documentTypes);
          let options = documentTypes;
          if (agreement && agreement.agreement_type) {
            switch (agreement.agreement_type) {
              case 'PCA':
                options = this.pcaDocTypes;
                break;
              case 'SSFA':
                options = this.ssfaDocTypes;
                break;
              default:
                options = this.documentTypes;
                break;
            }
          }
          return options;
        },

        validate: function() {
          let valid = true;
          let fieldSelectors = ['#agreementSelector', '#documentType', '#title', '#unicefOffices', '#unicefFocalPts',
            '#partnerFocalPts', '#cpStructure', '#sections',
            '#plannedBudget', '#plannedVisits'];
          if (!this.intervention.contingency_pd || this.intervention.status === 'active') {
            fieldSelectors.push('#intStart', '#intEnd');
          }
          fieldSelectors.forEach(function(selector) {
            let field = this.$$(selector);
            if (field && !field.validate()) {
              valid = false;
            }
          }.bind(this));
          return valid;
        },

        _daysUntilExpiry: function(end) {
          if (this.isFutureDate(end)) {
            var today = new Date().toString();
            var diff = this.dateDiff(today, end);
            if (diff) {
              return diff + ' days until expiry';
            }
          }
        },

        _checkFrsStartConsistency: function(frsEarliestStartDate, interventionStart, interventionStatus) {
          if (this.newIntervention || this.emptyFrsList(this.intervention)
              || interventionStatus === 'closed') {
            this.set('_frsStartConsistencyWarning', null);
            this.$.intStart.updateStyles();
            return;
          }
          this.set('_frsStartConsistencyWarning', this.checkFrsAndIntervDateConsistency(interventionStart,
              frsEarliestStartDate, 'start date', true));
          this.$.intStart.updateStyles();
        },

        _checkFrsEndConsistency: function(frsLatestEndDate, interventionEnd, interventionStatus) {
          if (this.newIntervention || this.emptyFrsList(this.intervention)
              || interventionStatus === 'closed') {
            this.set('_frsEndConsistencyWarning', '');
            this.$.intEnd.updateStyles();
            return;
          }
          this.set('_frsEndConsistencyWarning', this.checkFrsAndIntervDateConsistency(interventionEnd,
              frsLatestEndDate, 'end date', true));
          this.$.intEnd.updateStyles();
        },
        _updateInteventionLocAndClusters: function() {
          if (!this.intervention) {
            return;
          }
          let locAndClusters = this._extractLocAndClustersFromIndicators();
          this.set('intervention.locations', locAndClusters.locationIds);
          this.set('intervention.location_names', locAndClusters.locationNames);
          this.set('intervention.cluster_names', locAndClusters.clusterNames);
        },
        _extractLocAndClustersFromIndicators: function() {
          let locAndClusters = {
            locationIds: [],
            clusterNames: [],
            locationNames: [],
          };

          this.intervention.result_links.forEach(function(rl) {
            if (_.isEmpty(rl.ll_results)) {
              return;
            }
            rl.ll_results.forEach(function(llResult) {
              if (_.isEmpty(llResult.applied_indicators)) {
                return;
              }
              llResult.applied_indicators.forEach(function(indicator) {
                if (!_.isEmpty(indicator.locations)) {
                  [].push.apply(locAndClusters.locationIds,
                      this._getUniqueLocIds(indicator.locations, locAndClusters.locationIds));
                }

                if (indicator.cluster_name) {
                  [].push.apply(locAndClusters.clusterNames,
                      this._getUniqueClusterNames(indicator.cluster_name, locAndClusters.clusterNames));
                }
              }, this);

            }, this);
          }, this);

          if (!_.isEmpty(locAndClusters.locationIds)) {
            [].push.apply(locAndClusters.locationNames,
                this._extractLocationNames(locAndClusters.locationIds));
          }
          return locAndClusters;
        },
        _extractLocationNames: function(locationIds) {
          let selectedLocations = this.locations.filter(function(loc) {
            return locationIds.indexOf(parseInt(loc.id)) > -1;
          });
          let locNames = selectedLocations.map(function(l) {
            return l.name;
          });
          return locNames;
        },
        _getUniqueLocIds: function(indicatorLocIds, interventionLocIds) {
          let uniqueLocIds = indicatorLocIds.filter(function(indicLoc) {
            return interventionLocIds.indexOf(indicLoc) < 0;
          });
          return uniqueLocIds;
        },
        _getUniqueClusterNames: function(indicatorClusterName, intervetionClusterNames) {
          if (intervetionClusterNames.indexOf(indicatorClusterName) > -1) {
            return [];
          }
          return [indicatorClusterName];
        },
        _isEmpty: function(length) {
          return !!!length;
        }
      });
    })();

  </script>
</dom-module>
