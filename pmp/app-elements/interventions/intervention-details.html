<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="intervention-form/agreement-selector.html">

<link rel="import" href="intervention-planned-budget.html">
<link rel="import" href="intervention-expected-results.html">
<link rel="import" href="intervention-planned-visits.html">
<link rel="import" href="intervention-sector-locations.html">
<link rel="import" href="intervention-status.html">

<dom-module id="intervention-details">

  <template>

    <style include="page-layout-styles grid-layout-styles shared-styles">
      :host {
        @apply(--layout-vertical);
        width: 100%;
      }
      paper-input,
      paper-textarea,
      agreement-selector,
      paper-material {
        width: 100%;
      }

      paper-material {
        padding: 0;
      }
      paper-material paper-toolbar {
        --paper-toolbar-height: 40px;
        --paper-toolbar-background: #F2F2F2; /* TODO: replace with app-theme var */
        --paper-toolbar: {
          -webkit-border-radius: 8px;
          -moz-border-radius: 8px;
          border-radius: 8px;
        };
        --paper-toolbar-title: {
          @apply(--nested-content-panel-title);
          margin-left: 0;
        };
      }
      .expiry-warning {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        @apply(--layout-end-justified);
        padding-bottom: 12px;
        color: #ea4022; /* TODO: replace with app-theme var */
      }
    </style>

    <etools-content-panel class="content-section" title="Partnership Information">
      <div class="row-h flex-c">
        <div class="col col-6">
          <agreement-selector id="agreementSelector"
            agreement-id="{{intervention.agreement}}"
            partner-id="{{selectedPartnerId}}"
            selected-agreement="{{agreement}}"></agreement-selector>
        </div>
        <div class="col col-3">
          <etools-searchable-multiselection-menu id="documentType"
                                                 label="Document Type"
                                                 placeholder="&#8212;"
                                                 value="[[_getEsmmValue('document_type', intervention.document_type)]]"
                                                 options="[[currentDocTypes]]"
                                                 custom-object-options
                                                 on-value-change="_esmmValueChanged"
                                                 data-path="document_type"
                                                 hide-search
                                                 required auto-validate
                                                 error-message="Document type is required">
          </etools-searchable-multiselection-menu>
        </div>
        <div class="col col-3">
          <!-- Reference Number -->
          <paper-input label="Reference Number"
                       value="[[intervention.number]]"
                       placeholder="&#8212;"
                       disabled></paper-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <!-- Title -->
        <paper-input id="title"
                     label="Title"
                     value="{{intervention.title}}"
                     placeholder="&#8212;"
                     char-counter
                     maxlength="256"
                     required auto-validate
                     error-message="Please add a title"></paper-input>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <etools-searchable-multiselection-menu id="unicefOffices"
                                                 label="UNICEF Office(s)"
                                                 placeholder="&#8212;"
                                                 value="[[_getEsmmValue('offices', intervention.offices)]]"
                                                 options="[[offices]]"
                                                 on-value-change="_esmmValueChanged"
                                                 data-path="offices"
                                                 multi required auto-validate
                                                 error-message="Please select intervention's office(s)">
          </etools-searchable-multiselection-menu>
        </div>
        <div class="col col-6">
          <etools-searchable-multiselection-menu id="unicefFocalPts"
                                                 label="UNICEF Focal Points(s)"
                                                 placeholder="&#8212;"
                                                 value="[[_getEsmmValue('unicef_focal_points', intervention.unicef_focal_points)]]"
                                                 options="[[unicefUsersData]]"
                                                 on-value-change="_esmmValueChanged"
                                                 data-path="unicef_focal_points"
                                                 multi
                                                 required$="[[interventionRequiredField]]"
                                                 auto-validate
                                                 error-message="Please select UNICEF focal points">
          </etools-searchable-multiselection-menu>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <etools-searchable-multiselection-menu id="partnerFocalPts"
             label="Partner Focal Points(s)"
             placeholder="&#8212;"
             value="[[_getEsmmValue('partner_focal_points', intervention.partner_focal_points, partnerStaffMembersDropdownData.length)]]"
             options="[[partnerStaffMembersDropdownData]]"
             on-value-change="_esmmValueChanged"
             data-path="partner_focal_points"
             multi
             required$="[[interventionRequiredField]]"
             auto-validate
             error-message="Please select partner focal points">
          </etools-searchable-multiselection-menu>
        </div>
      </div>

    </etools-content-panel>
    <etools-content-panel class="content-section" title="PD or SSFA Details">
      <div class="row-h flex-c">
        <div class="col col-3">
          <etools-searchable-multiselection-menu id="hrps"
                                                 label="In response to an HRP, Select"
                                                 placeholder="&#8212;"
                                                 value="[[_getEsmmValue('hrp', intervention.hrp)]]"
                                                 options="[[hrps]]"
                                                 on-value-change="_esmmValueChanged"
                                                 data-path="hrp">
          </etools-searchable-multiselection-menu>
        </div>
        <div class="col col-3">
          <!-- Start date -->
          <paper-input id="intStart"
                       label="Start date"
                       value="[[prettyDate(intervention.start)]]"
                       on-down="openDatePicker"
                       data-selector="intStartDate"
                       placeholder="&#8212;"
                       required$="[[interventionRequiredField]]"
                       auto-validate
                       error-message="Please select start date">
            <etools-datepicker-button prefix
                                      id="intStartDate"
                                      date="[[prepareDate(intervention.start)]]"
                                      format="YYYY-MM-DD"
                                      pretty-date="{{intervention.start}}"
                                      no-init show-clear-btn></etools-datepicker-button>
          </paper-input>
        </div>
        <div class="col col-3">
          <!-- End date -->
          <paper-input id="intEnd"
                       label="End date"
                       value="[[prettyDate(intervention.end)]]"
                       on-down="openDatePicker"
                       data-selector="intEndDate"
                       placeholder="&#8212;"
                       required$="[[interventionRequiredField]]"
                       auto-validate
                       error-message="Please select end date">
            <etools-datepicker-button prefix
                                      id="intEndDate"
                                      date="[[prepareDate(intervention.end)]]"
                                      format="YYYY-MM-DD"
                                      pretty-date="{{intervention.end}}"
                                      no-init show-clear-btn></etools-datepicker-button>
          </paper-input>
        </div>
        <div class="col col-3">
          <div class="expiry-warning">
            <span>[[_daysUntilExpiry(intervention.start, intervention.end)]]</span>
          </div>
        </div>
      </div>
      <div class="row-h flex-c">
        <!-- Population Focus -->
        <paper-textarea id="populationFocus"
                        label="Population Focus"
                        value="{{intervention.population_focus}}"
                        placeholder="&#8212;"
                        char-counter
                        maxlength="256"
                        required$="[[interventionRequiredField]]"
                        auto-validate
                        error-message="Please enter population focus content"></paper-textarea>
      </div>
      <div class="row-h flex-c">
        <paper-material elevation="0">
          <paper-toolbar>
            <div class="title">Sector Locations</div>
          </paper-toolbar>
          <intervention-sector-locations id="sectorLocations"
                                         data-items="{{intervention.sector_locations}}"
                                         edit-mode$="[[editMode]]"
                                         required$="[[interventionRequiredField]]">
          </intervention-sector-locations>
        </paper-material>
      </div>
      <div class="row-h flex-c">

      </div>
    </etools-content-panel>

    <etools-content-panel class="content-section" title="Expected results">
      <intervention-expected-results id="expectedResults"
          data-items="{{resultLinks}}"
          edit-mode$="[[editMode]]"
          intervention-id="[[intervention.id]]">
      </intervention-expected-results>
    </etools-content-panel>

    <etools-content-panel class="content-section" title="Planned Budget">
      <intervention-planned-budget id="plannedBudget"
                                   data-items="{{intervention.planned_budget}}"
                                   edit-mode$="[[editMode]]"
                                   years="[[years]]"
                                   required$="[[interventionRequiredField]]"></intervention-planned-budget>
    </etools-content-panel>
    <etools-content-panel class="content-section" title="Planned Visits">
      <intervention-planned-visits data-items="{{intervention.planned_visits}}"
                                   edit-mode$="[[editMode]]"
                                   years="[[years]]"></intervention-planned-visits>
    </etools-content-panel>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-details',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior
        ],

        properties: {
          intervention: {
            type: Object,
            observer: '_interventionChanged'
          },
          selectedPartnerId: {
            type: Number,
            notify: true
          },
          partner: {
            type: Object,
            observer: '_partnerSelected'
          },
          partnerStaffMembersDropdownData: {
            type: Array,
            value: []
          },
          documentTypes: {
            type: Array,
            statePath: 'interventionDocTypes'
          },
          pcaDocTypes: {
            type: Array,
            value: []
          },
          ssfaDocTypes: {
            type: Array,
            value: []
          }, 
          currentDocTypes: {
            type: Array,
            value: []
          },
          offices: {
            type: Array,
            statePath: 'offices'
          },
          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          hrps: {
            type: Array,
            statePath: 'hrps'
          },
          years: {
            type: Array,
            value: []
          },
          agreement: {
            type: Object,
            value: null
          },
          interventionRequiredField: {
            type: Boolean,
            value: false
          },
          editMode: {
            type: Boolean,
            value: false
          }
        },

        observers: [
          '_agreementSelected(agreement)',
          '_setYears(intervention.start, intervention.end)'
        ],

        ready: function() {
          var pcaTypes = [];
          var ssfaTypes = [];
          this.documentTypes.forEach(function(type) {
            if (type.value !== 'SSFA') {
              pcaTypes.push(type);
            }
            if (type.value === 'SSFA') {
              ssfaTypes.push(type);
            }
          });
          this.set('pcaDocTypes', pcaTypes);
          this.set('ssfaDocTypes', ssfaTypes);
        },

        _interventionChanged: function(intervention) {
          console.log('intervention', intervention);
          if (intervention && typeof intervention === 'object' && Object.keys(intervention).length > 0) {
            // this._setYears(intervention.start, intervention.end);
            this.set('interventionRequiredField', true); // TODO: remove this
            //this.set('interventionRequiredField', this._requiredInterventionField(intervention.status));

            // TODO: remove this test data
            if (intervention.result_links.length > 0) {
              for (var i = 0; i < intervention.result_links.length; i++) {
                intervention.result_links[i].cp_output = (i === 0) ? 125 : intervention.result_links[i].cp_output.id;
                intervention.result_links[i].ram_indicators = (i === 0) ? [74, 76] : [];
                if (i === 0) {
                  intervention.result_links[i].ll_results = [
                    {
                      id: 1,
                      name: 'My indicator name',
                      applied_indicators: [
                        {
                          id: 1,
                          baseline: "123312",
                          target: "2000",
                          name: 'some text here',
                          unit: 'numeric'
                        }
                      ]
                    }
                  ]
                }
              }
              this.set('resultLinks', intervention.result_links)
            }

          } else {
            this.set('interventionRequiredField', false);
          }

          // ensure loading msg close
          this.fire('global-loading', {active: false});
        },

        _setYears: function(interventionStart, interventionEnd) {
          if (typeof interventionStart === 'string' && interventionStart !== ''
              && typeof interventionEnd === 'string' && interventionEnd !== '') {
            this.debounce('setInterventionYears', function() {
              var start = parseInt(interventionStart.substr(0, 4), 10);
              var end = parseInt(interventionEnd.substr(0, 4), 10);
              var years = [];
              while (start <= end) {
                years.push({
                  value: start,
                  label: start
                });
                start++;
              }
              this.set('years', years);
            }.bind(this), 50)
          }
        },

        _esmmValueChanged: function(event) {
          var esmmField = Polymer.dom(event).localTarget;
          var dataPath = esmmField.getAttribute('data-path');
          var dataToUse = esmmField.getAttribute('data-to-use');
          if (esmmField.multi) {
            // multiselection
            var selectedValues = [];
            var optionsSelected = event.detail.selectedValues;
            if (Array.isArray(optionsSelected)) {
              selectedValues = optionsSelected.map(function(option) {
                if (dataToUse && dataToUse === 'label') {
                  return option.label;
                } else {
                  return option.value;
                }
              });
            }
            this.set('intervention.' + dataPath, selectedValues);
          } else {
            // single selection
            var optionSelected = event.detail.selectedValues;
            var selectedOpt = null;
            if (optionSelected !== null && typeof optionSelected === 'object' && 
              optionSelected.hasOwnProperty('value')) {
              if (dataToUse && dataToUse === 'label') {
                selectedOpt = optionSelected.label;
              } else {
                selectedOpt = optionSelected.value;
              }
            }
            this.set('intervention.' + dataPath, selectedOpt);
          }
        },

        _getEsmmValue: function(dataPath, selectedValues, other) {
          switch (dataPath) {
            case 'document_type':
              if (typeof selectedValues === 'string' && selectedValues !== '') {
                return this.currentDocTypes.filter(function(type) {
                  return type.value === selectedValues;
                });
              }
              break;
            case 'offices':
              if (Array.isArray(selectedValues) && selectedValues.length > 0) {
                return this.offices.filter(function(office) {
                  return selectedValues.indexOf(office.value) > -1;
                });
              }
              break;
            case 'unicef_focal_points':
              if (Array.isArray(selectedValues) && selectedValues.length > 0) {
                return this.unicefUsersData.filter(function(user) {
                  return selectedValues.indexOf(user.value) > -1;
                });
              }
              break;
            case 'partner_focal_points':
              if (Array.isArray(selectedValues) && selectedValues.length > 0 && other) {
                var selected = this.partnerStaffMembersDropdownData.filter(function(staffMember) {
                  return selectedValues.indexOf(staffMember.value) > -1;
                });
                return selected;
              }
              break;
            case 'hrp':
              var hrpId = parseInt(selectedValues, 10);
              if (!isNaN(hrpId)) {
                return this.hrps.filter(function(hrp) {
                  return hrp.value === hrpId;
                });
              }
              break;
          }
        },

        _partnerSelected: function(partner) {
          console.log('intervention partner', partner);
          if (partner && partner.staff_members) {
            // prepare selected partner staff members data
            this.set('partnerStaffMembersDropdownData', partner.staff_members.map(function(staffMember) {
              return {
                value: parseInt(staffMember.id),
                label: staffMember.first_name + ' ' + staffMember.last_name
              };
            }));
          }
        },

        /**
         * When an agreement is selected then check it's type and update document types dropdown
         */
        _agreementSelected: function(agreement) {
          var options = this.documentTypes;
          if (agreement && agreement.agreement_type) {
            switch (agreement.agreement_type) {
              case 'PCA':
                options = this.pcaDocTypes;
                break;
              case 'SSFA':
                options = this.ssfaDocTypes;
                break;
              default:
               options = this.documentTypes;
               break;
            } 
          }
          this.set('currentDocTypes', options);
        },

        /**
         * Some interventions fields are required only if status is active or implemented
         */
        _requiredInterventionField: function(status) {
          return status === 'active' || status === 'implemented';
        },

        prepareSectorLocations: function() {
          if (this.intervention.sector_locations.length > 0) {
            return this.intervention.sector_locations.map(function(sectorLocation) {
              return {
                id: sectorLocation.id,
                sector: (sectorLocation.sector && sectorLocation.sector.id) ? sectorLocation.sector.id : null,
                locations: this._prepareLocationsForSave(sectorLocation.locations)
              }
            }.bind(this));
          }
          return [];
        },

        _prepareLocationsForSave: function(locations) {
          if (!Array.isArray(locations) || (Array.isArray(locations) && locations.length == 0)) {
            return [];
          }
          return locations.map(function(location) {
            return location.id;
          });
        },

        validate: function() {
          var valid = true;
          var fields = ['agreementSelector', 'documentType', 'title', 'unicefOffices', 'unicefFocalPts',
            'partnerFocalPts', 'intStart', 'intEnd', 'populationFocus', 'sectorLocations',
            'plannedBudget', 'expectedResults'];
          fields.forEach(function(field) {
            if (!this.$$('#' + field).validate()) {
              valid = false;
            }
          }.bind(this));
          return valid;
        },

        _daysUntilExpiry: function(start, end) {
          var diff = this.dateDiff(start, end);
          if (diff) {
            return diff + ' days until expiry';
          }
        }

      });

    })();
  </script>

</dom-module>
