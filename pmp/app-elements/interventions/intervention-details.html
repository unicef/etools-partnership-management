<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/required-field-styles.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/esmm-missing-options/missing-dropdown-options-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<link rel="import" href="../common-elements/etools-date-input.html">

<link rel="import" href="intervention-form/agreement-selector.html">

<link rel="import" href="intervention-planned-budget.html">
<link rel="import" href="intervention-expected-results.html">
<link rel="import" href="intervention-planned-visits.html">
<link rel="import" href="intervention-sector-locations.html">
<link rel="import" href="intervention-status.html">

<dom-module id="intervention-details">

  <template strip-whitespace>

    <style include="page-layout-styles grid-layout-styles shared-styles required-field-starred-styles">
      :host {
        @apply(--layout-vertical);
        width: 100%;
      }

      paper-input,
      paper-textarea,
      agreement-selector,
      paper-material {
        width: 100%;
      }

      paper-material {
        padding: 0;
        background-color: var(--ecp-content-bg-color, #FFFFFF);
      }

      paper-material paper-toolbar {
        --paper-toolbar-height: 40px;
        --paper-toolbar-background: var(--medium-theme-background-color);
        --paper-toolbar: {
          -webkit-border-radius: 8px;
          -moz-border-radius: 8px;
          border-radius: 8px;
        };
        --paper-toolbar-title: {
          @apply(--nested-content-panel-title);
          margin-left: 0;
        };
      }

      .expiry-warning {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        @apply(--layout-end-justified);
        padding-bottom: 12px;
        color: var(--error-color);
      }
    </style>

    <etools-content-panel class="content-section" panel-title="Partnership Information">
      <div class="row-h flex-c">
        <div class="col col-6">
          <agreement-selector id="agreementSelector"
                              agreement-id="{{intervention.agreement}}"
                              partner-id="{{selectedPartnerId}}"
                              selected-agreement="{{agreement}}"
                              intervention-id="[[intervention.id]]"
                              edit-mode$="[[editMode]]"></agreement-selector>
        </div>
        <div class="col col-3">
          <etools-single-selection-menu id="documentType"
                                        label="Document Type"
                                        placeholder="&#8212;"
                                        options="[[_getCurrentDocTypes(agreement, documentTypes)]]"
                                        selected="{{intervention.document_type}}"
                                        hide-search
                                        dynamic-align
                                        required auto-validate
                                        error-message="Document type is required"
                                        readonly$="[[!editMode]]"
                                        starred>
          </etools-single-selection-menu>

        </div>
        <div class="col col-3" title$="[[intervention.number]]">
          <!-- Reference Number -->
          <paper-input label="Reference Number"
                       value="[[intervention.number]]"
                       placeholder="&#8212;"
                       disabled></paper-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <!-- Title -->
        <paper-input id="title"
                     label="Title"
                     value="{{intervention.title}}"
                     placeholder="&#8212;"
                     char-counter
                     maxlength="256"
                     required auto-validate
                     error-message="Please add a title"
                     readonly$="[[!editMode]]" starred></paper-input>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <etools-multi-selection-menu id="unicefOffices"
                                       label="UNICEF Office(s)"
                                       placeholder="&#8212;"
                                       options="[[offices]]"
                                       option-label="name"
                                       option-value="id"
                                       selected-values="{{intervention.offices}}"
                                       dynamic-align
                                       required auto-validate
                                       error-message="Please select intervention's office(s)"
                                       readonly$="[[!editMode]]"
                                       starred>
          </etools-multi-selection-menu>
        </div>
        <div class="col col-6">
          <etools-multi-selection-menu id="unicefFocalPts"
                                       label="UNICEF Focal Point(s)"
                                       placeholder="&#8212;"
                                       options="[[getCleanEsmmOptions(unicefUsersData, intervention)]]"
                                       option-label="full_name"
                                       option-value="user_id"
                                       selected-values="{{intervention.unicef_focal_points}}"
                                       required$="[[interventionRequiredField]]"
                                       auto-validate dynamic-align
                                       error-message="Please select UNICEF focal points"
                                       readonly$="[[!editMode]]">
          </etools-multi-selection-menu>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <etools-multi-selection-menu id="partnerFocalPts"
                                       label="Partner Focal Point(s)"
                                       placeholder="&#8212;"
                                       options="[[partnerStaffMembers]]"
                                       option-value="id"
                                       option-label="name"
                                       selected-values="{{intervention.partner_focal_points}}"
                                       required$="[[interventionRequiredField]]"
                                       auto-validate dynamic-align
                                       error-message="Please select partner focal points"
                                       readonly$="[[!editMode]]">
          </etools-multi-selection-menu>
        </div>
      </div>
    </etools-content-panel>

    <etools-content-panel class="content-section" panel-title="PD or SSFA Details">
      <div class="row-h flex-c">
        <div class="col col-3">
          <etools-single-selection-menu id="cpStructure"
                                        label="CP Structure"
                                        placeholder="&#8212;"
                                        options="[[cpStructureOptions]]"
                                        option-value="id"
                                        option-label="name"
                                        selected="{{intervention.country_programme}}"
                                        dynamic-align
                                        hide-search
                                        readonly$="[[!isCpStructureEditable(editMode, intervention.status)]]">
          </etools-single-selection-menu>
        </div>
        <div class="col col-3">
          <!-- Start date -->
          <etools-date-input id="intStart"
                             label="Start date"
                             value="{{intervention.start}}"
                             readonly$="[[!editMode]]"
                             error-message="Please select start date"
                             required$="[[nterventionRequiredField]]"
                             auto-validate
                             no-init show-clear-btn>
          </etools-date-input>
        </div>
        <div class="col col-3">
          <!-- End date -->
          <etools-date-input id="intEnd"
                             label="End date"
                             value="{{intervention.end}}"
                             readonly$="[[!editMode]]"
                             error-message="Please select end date"
                             required$="[[nterventionRequiredField]]"
                             auto-validate
                             no-init show-clear-btn>
          </etools-date-input>
        </div>
        <div class="col col-3">
          <div class="expiry-warning">
            <span>[[_daysUntilExpiry(intervention.end)]]</span>
          </div>
        </div>
      </div>
      <div class="row-h flex-c">
        <paper-material elevation="0">
          <paper-toolbar>
            <div class="title">Section/Cluster, Locations</div>
          </paper-toolbar>
          <intervention-sector-locations id="sectorLocations"
                                         data-items="{{intervention.sector_locations}}"
                                         edit-mode$="[[editMode]]"
                                         required$="[[interventionRequiredField]]">
          </intervention-sector-locations>
        </paper-material>
      </div>
    </etools-content-panel>

    <etools-content-panel class="content-section" panel-title="PD Output or SSFA Expected results">
      <intervention-expected-results id="expectedResults"
                                     data-items="{{intervention.result_links}}"
                                     selected-cp-structure="[[intervention.country_programme]]"
                                     edit-mode$="[[editMode]]"
                                     intervention-id="[[intervention.id]]"
                                     required$="[[interventionRequiredField]]">
      </intervention-expected-results>
    </etools-content-panel>

    <intervention-planned-budget id="plannedBudget"
                                 class="content-section"
                                 planned-budget="{{intervention.planned_budget}}"
                                 intervention-id="[[intervention.id]]"
                                 intervention="[[intervention]]"
                                 edit-mode="[[_getPlannedBudgetEditMode(editMode, intervention.status)]]"
                                 unicef-cash-edit-mode="[[_getUnicefCashEditMode(editMode, intervention.status)]]">
    </intervention-planned-budget>

    <etools-content-panel class="content-section" panel-title="Planned Visits">
      <intervention-planned-visits id="plannedVisits"
                                   data-items="{{intervention.planned_visits}}"
                                   edit-mode$="[[editMode]]"
                                   years="[[years]]">
      </intervention-planned-visits>
    </etools-content-panel>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-details',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior,
          pmpBehaviors.MissingDropdownOptionsBehavior
        ],

        properties: {
          intervention: {
            type: Object,
            observer: '_interventionChanged',
            notify: true
          },
          permissions: {
            type: Object
          },
          selectedPartnerId: {
            type: Number,
            notify: true,
            observer: '_selectedPartnerIdChanged'
          },
          partnerStaffMembers: {
            type: Array,
            value: []
          },
          documentTypes: {
            type: Array,
            statePath: 'interventionDocTypes',
            observer: '_initDocTypes'
          },
          pcaDocTypes: {
            type: Array,
            value: []
          },
          ssfaDocTypes: {
            type: Array,
            value: []
          },
          offices: {
            type: Array,
            statePath: 'offices'
          },
          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          countryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes',
            observer: '_countryProgrammesChanged'
          },
          cpStructureOptions: {
            type: Object,
            value: []
          },
          years: {
            type: Array,
            value: []
          },
          agreement: {
            type: Object,
            value: null
          },
          interventionRequiredField: {
            type: Boolean,
            value: false
          },
          newIntervention: {
            type: Boolean,
            observer: 'newInterventionFlagChanged'
          },
          fieldsResetted: {
            type: Boolean
          },
          editMode: {
            type: Boolean,
//            value: false,
            observer: '_editModeChanged'
          },
        },

        observers: [
          '_setYears(intervention.start, intervention.end)'
        ],

        ready: function() {
          this.setDropdownMissingOptionsAjaxDetails(this.$.unicefFocalPts, 'unicefUsers', {dropdown: true});
        },
        isCpStructureEditable: function(editMode, status) {
          if (!editMode) {
            return false;
          }
          if (status && status !== 'draft') {
            return false;
          }
          return true;
        },
        _filterCountryProgrammes: function(countryProgrammes) {
          return countryProgrammes.filter(function(cp) {
            return cp.active || cp.future;
          });
        },
        _getCurrentCountryProgramme: function(countryProgrammes) {
          if (countryProgrammes && countryProgrammes.length > 1) {
            return countryProgrammes.find(function(cp) {
              return !cp.future && !cp.special;
            });
          }
          return (countryProgrammes && countryProgrammes.length) ? countryProgrammes[0] : null;
        },
        _countryProgrammesChanged: function(cp) {
          let cpStructures = this._filterCountryProgrammes(cp);
          this.set('cpStructureOptions', cpStructures);
          this._setDefaultSelectedCpStructure(cpStructures);
        },
        _hasExpiredCpAssigned: function(cpId) {
          if (cpId > 0 && this.cpStructureOptions instanceof Array) {
            let cp = this.cpStructureOptions.find(function(cp) {
              return parseInt(cp.id, 10) === parseInt(cpId, 10);
            });
            if (!cp) {
              return true;
            }
          }
          return false;
        },
        _setDefaultSelectedCpStructure: function(cpStructures) {
          if (this.intervention && this.intervention.country_programme) {
            let cpStructureIsOld = this._hasExpiredCpAssigned(this.agreement.country_programme);
            if (cpStructureIsOld) {
              this.fire('toast', {text: 'This agreement has an old/expired CP Structure!', showCloseBtn: true});
            }
            return;
          }
          let currentCP;
          if (cpStructures && cpStructures.length) {
            if (cpStructures.length === 1) {
              currentCP = cpStructures[0].id;
            } else {
              currentCP = this._getCurrentCountryProgramme(cpStructures);
            }
            this.set('intervention.country_programme', currentCP ? currentCP.id : null);
          }
        },
        _initDocTypes: function(documentTypes) {
          if (!(documentTypes instanceof Array && documentTypes.length)) {
            return;
          }
          var pcaTypes = [];
          var ssfaTypes = [];
          documentTypes.forEach(function(type) {
            if (type.value !== 'SSFA') {
              pcaTypes.push(type);
            }
            if (type.value === 'SSFA') {
              ssfaTypes.push(type);
            }
          });
          this.set('pcaDocTypes', pcaTypes);
          this.set('ssfaDocTypes', ssfaTypes);
        },

        _editModeChanged: function() {
          this.updateStyles();
        },

        _interventionChanged: function(intervention) {
          if (intervention && typeof intervention === 'object' && Object.keys(intervention).length > 0) {
            if (intervention.id > 0) {
              this.set('interventionRequiredField', this._requiredInterventionField(intervention.status));
            } else {
              this.set('selectedPartnerId', null);
            }

            this.set('fieldsResetted', false);
            this.newInterventionFlagChanged();
          }
          this._setDefaultSelectedCpStructure(this.cpStructureOptions);
        },

        newInterventionFlagChanged: function(newValue) {
          if (this.intervention && !this.fieldsResetted) {
            this._resetValidations();
          }
          if (newValue) {
            this.set('interventionRequiredField', false);
          }

        },

        _resetValidations: function() {
          this.$.agreementSelector.resetValidations();
          this.$.documentType.resetInvalidState();
          this.$.plannedBudget.resetValidations();

          var fields = ['documentType', 'title', 'unicefOffices', 'unicefFocalPts',
            'partnerFocalPts', 'cpStructure', 'intStart', 'intEnd'];
          fields.forEach(function(field) {
            this.fieldValidationReset('#' + field);
          }.bind(this));

          var elements = ['sectorLocations', 'expectedResults', 'plannedVisits'];
          elements.forEach(function(el) {
            this.elementValidationReset('#' + el);
          }.bind(this));
          this.set('fieldsResetted', true);
        },

        _setYears: function(interventionStart, interventionEnd) {
          if (typeof interventionStart === 'string' && interventionStart !== ''
              && typeof interventionEnd === 'string' && interventionEnd !== '') {
            var start = parseInt(interventionStart.substr(0, 4), 10);
            var end = parseInt(interventionEnd.substr(0, 4), 10);
            var years = [];
            while (start <= end) {
              years.push({
                value: start,
                label: start
              });
              start++;
            }
            this.set('years', years);
          }
        },

        _selectedPartnerIdChanged: function(id, oldId) {
          if (typeof oldId === 'number'
              && id !== oldId
              && !this.agreement) {
            //Prevent reset on changes caused by initialization of the fields
            this._resetDropdowns();
          }
        },
        _resetDropdowns: function() {
          //Test case - go to existing intervention , then go to New intervention

          // reset partner focal points options and value
          this.set('intervention.partner_focal_points', []);
          this.set('partnerStaffMembers', []);
          var partnerFpDropDown = this.$.partnerFocalPts;
          if (partnerFpDropDown && (!partnerFpDropDown.options || !partnerFpDropDown.options.length)) {
            partnerFpDropDown.value = null;
            partnerFpDropDown.selected = null;
          }
        },
        /**
         * When an agreement is selected then check it's type and update document types dropdown
         */
        _getCurrentDocTypes: function(agreement, documentTypes) {
          var options = documentTypes;
          if (agreement && agreement.agreement_type) {
            switch (agreement.agreement_type) {
              case 'PCA':
                options = this.pcaDocTypes;
                break;
              case 'SSFA':
                options = this.ssfaDocTypes;
                break;
              default:
                options = this.documentTypes;
                break;
            }
          }
          return options;
        },

        /**
         * Some interventions fields are required only if status is active or implemented
         */
        _requiredInterventionField: function(status) {
          return status === 'active' || status === 'implemented';
        },

        prepareSectorLocations: function() {
          if (this.intervention.sector_locations.length > 0) {
            return this.intervention.sector_locations.map(function(sectorLocation) {
              return {
                id: sectorLocation.id,
                sector: (sectorLocation.sector && sectorLocation.sector.id) ? sectorLocation.sector.id : null,
                locations: this._prepareLocationsForSave(sectorLocation.locations)
              };
            }.bind(this));
          }
          return [];
        },

        _prepareLocationsForSave: function(locations) {
          if (!Array.isArray(locations) || (Array.isArray(locations) && locations.length === 0)) {
            return [];
          }
          return locations.map(function(location) {
            return location.id;
          });
        },

        validate: function() {
          var valid = true;
          var fields = ['agreementSelector', 'documentType', 'title', 'unicefOffices', 'unicefFocalPts',
            'partnerFocalPts', 'intStart', 'intEnd', 'sectorLocations',
            'plannedBudget', 'expectedResults'];
          fields.forEach(function(field) {
            if (!this.$$('#' + field).validate()) {
              valid = false;
            }
          }.bind(this));
          return valid;
        },

        _daysUntilExpiry: function(end) {
          if (this.isFutureDate(end)) {
            var today = new Date().toString();
            var diff = this.dateDiff(today, end);
            if (diff) {
              return diff + ' days until expiry';
            }
          }
        },

        // General edit mode for planned budget. it should be editable for new and draft
        _getPlannedBudgetEditMode: function(editMode, interventionStatus) {
          return editMode && ['', 'draft'].indexOf(interventionStatus) > -1;
        },

        // Planned budget unicef cash should be editable in signed status
        _getUnicefCashEditMode: function(editMode, interventionStatus) {
          return editMode && ['', 'draft', 'signed'].indexOf(interventionStatus) > -1;
        }

      });

    })();
  </script>

</dom-module>
