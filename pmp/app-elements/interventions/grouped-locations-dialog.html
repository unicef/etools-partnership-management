<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">

<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">

<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<dom-module id="grouped-locations-dialog">
  <template>
    <style include="grid-layout-styles">
      [hidden] {
        display: none !important;
      }

      etools-dialog {
        --etools-dialog-scrollable: {
          min-height: 300px;
          font-size: 16px;
        };
      }

      .adminLevelLoc {
        color: var(--primary-color);
        font-weight: bold;
      }

      .left-padding {
        padding-left: 16px;
      }

      .top-padding {
        padding-top: 16px;
      }

      .child-bottom-padding {
        padding-bottom: 8px;
      }

      .parent-padding {
        padding-bottom: 8px;
        padding-top: 8px;
      }

      .bordered-div {
        border: solid 1px var(--error-box-border-color);
        background-color: var(--error-box-bg-color);
        padding: 10px;
        margin: 16px 0px;
      }

      div.child-bottom-padding:last-of-type {
        padding-bottom: 0px;
      }
    </style>
    <etools-dialog id="groupedLocDialog" size="md" dialog-title="Locations PD/SSFA Covers" hide-confirm-btn>
      <etools-single-selection-menu id="adminLevelsDropdw" label="Group Locations By"
                                    selected="{{adminLevel}}"
                                    placeholder="&#8212;"
                                    options="[[adminLevels]]"
                                    option-label="name"
                                    option-value="name">
      </etools-single-selection-menu>

      <div class="bordered-div" hidden$="[[!message]]">
        [[message]]
      </div>

      <div class="row-padding-v" hidden$="[[adminLevel]]">
        <template is="dom-repeat" items="[[interventionLocations]]">
          <div class="top-padding">- [[item.name]]</d>
        </template>
      </div>
      <div class="row-padding-v" hidden$="[[!adminLevel]]">
        <template is="dom-repeat" items="[[groupedLocations]]">
          <div class="parent-padding">
            <div class="adminLevelLoc">[[item.adminLevelLocation.name]]</div>
            <div class="left-padding">
              <template is="dom-repeat" items="[[item.subordinateLocations]]" as="subordinateLoc">
                <div class="child-bottom-padding"> - [[subordinateLoc.name]]</div>
              </template>
            </div>
          </div>
        </template>
      </div>
    </etools-dialog>
  </template>
</dom-module>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'grouped-locations-dialog',
        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
        ],
        properties: {
          adminLevels: {//location types
            type: Array,
            statePath: 'locationTypes',
            observer: 'adminLevelsChanged',
          },
          adminLevel: {
            type: String,
            adminLevel: null,
            observer: 'adminLevelChanged'
          },
          locations: {
            type: Array,
            statePath: 'locations'
          },
          interventionLocations: {
            type: Array,
          },
          iterventionLocationIds: {
            type: Array,
            observer: 'iterventionLocationIdsChanged',
            notify: true
          },
          groupedLocations: {
            type: Array
          },
          message: {
            type: String,
            value: null
          }
        },
        adminLevelsChanged: function(adminLevels) {
          if (!adminLevels || !adminLevels.length) {
            return;
          }
          this._removeCountry(adminLevels);
        },
        _removeCountry: function(adminLevels) {
          let index = adminLevels.findIndex(function(al) {
            return al.name === 'Country';
          });
          if (index > -1) {
            adminLevels.splice(index, 1);
            let aux = JSON.parse(JSON.stringify(adminLevels));
            this.adminLevels = [];
            this.adminLevels = aux;
          }
        },
        iterventionLocationIdsChanged: function(locationIds) {
          if (!locationIds || !locationIds.length || !this.locations) {
            this.interventionLocations = [];
            return;
          }
          this._setInterventionLocationsDetails(locationIds);
        },
        _setInterventionLocationsDetails: function(locationIds) {
          locationIds = locationIds.map(function(loc) {
            return parseInt(loc);
          });
          let interventionLocations = this.locations.filter(function(loc) {
            return locationIds.indexOf(parseInt(loc.id)) > -1;
          });

        this.interventionLocations = [];
        this.interventionLocations = interventionLocations;
      },
      adminLevelChanged: function(adminLevel) {
        this.message = '';
        let groupedLocations = [];
        let locationsUnableToGroup = [];
        if (!adminLevel) {
          this.groupedLocations = null;
          return;
        }
        let i;
        // Build grouped locations structure
        for (i = 0; i < this.interventionLocations.length; i++) {
          let grouping = {
            adminLevelLocation: null,
            subordinateLocations: []
          };
          if (this.interventionLocations[i].location_type === adminLevel) {
            grouping.adminLevelLocation = this.interventionLocations[i];
            groupedLocations.push(grouping);
            continue;
          }

          // Find admin level parent location
          let adminLevelLocation = this._findAdminLevelParent(this.interventionLocations[i], adminLevel);
          if (!adminLevelLocation) {
            locationsUnableToGroup.push(this.interventionLocations[i].name);
            continue;
          }
          // Check if admin level parent Location is already a parent to another intervention location
          let existingGroup = this._findInGroupedLocations(adminLevelLocation);
          if (!existingGroup) {
            groupedLocations.push({
              adminLevelLocation: adminLevelLocation,
              subordinateLocations: [this.interventionLocations[i]]
            });
          } else {
            existingGroup.subordinateLocations.push(this.interventionLocations[i]);
          }
        }

        if (locationsUnableToGroup && locationsUnableToGroup.length) {
          this.message = 'Locations unable to group: ' + locationsUnableToGroup.join(', ');
        }

        this.groupedLocations = [];
        this.groupedLocations = groupedLocations;
        this.$.groupedLocDialog.notifyResize();
      },
      _findInGroupedLocations: function(groupedLocations, adminLevelLocation) {
        if (!groupedLocations || !groupedLocations.length) {
          return null;
        }
        let existingGroups = groupedLocations.filter(function(g) {
          return parseInt(g.adminLevelLocation.id) === parseInt(adminLevelLocation.id);
        });

        if (!existingGroups || !existingGroups.length) {
          return null;
        }
        return existingGroups[0];
      },
      _findAdminLevelParent: function(location, adminLevel) {
        if (!location.parent) {
          return null;
        }
        let parentArr = this.locations.filter(function(loc) {
          return parseInt(loc.id) === parseInt(location.parent);
        });
        if (!parentArr || !parentArr.length) {
          return null;
        }
        if (parentArr[0].location_type === adminLevel) {
          return parentArr[0];
        }
        return this._findAdminLevelParent(parentArr[0], adminLevel);
      },

      open: function() {
        this.$.groupedLocDialog.opened = true;
      },
    });
  })();
</script>
