<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">

<link rel="import"
href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">

<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<dom-module id="grouped-locations-dialog">
    <template>
      <style include="grid-layout-styles">
        [hidden] {
          display: none !important;
        }
        etools-dialog {
        --etools-dialog-scrollable: {
            min-height: 300px;
            font-size: 16px;
          };
        }
        .adminLevelLoc {
          color: var(--primary-color);
          font-weight: bold;
        }
        .left-padding {
          padding-left: 16px;
        }
        .top-padding {
          padding-top: 16px;
        }
        .child-bottom-padding {
          padding-bottom: 8px;
        }
        .parent-padding {
          padding-bottom: 8px;
          padding-top: 8px;
        }
        .bordered-div {
          border: solid 1px var(--error-box-border-color);
          background-color: var(--error-box-bg-color);
          padding: 10px;
          margin: 16px 0px;
        }
        div.child-bottom-padding:last-of-type {
          padding-bottom: 0px;
        }
      </style>
      <etools-dialog id="groupedLocDialog" size="md" dialog-title="Locations PD/SSFA Covers">
        <etools-single-selection-menu id="adminLevelsDropdw" label="Group Locations By"
          selected="{{adminLevel}}"
          placeholder="&#8212;"
          options="[[adminLevels]]"
          option-label="name"
          option-value="name">
        </etools-single-selection-menu>

        <div class="bordered-div" hidden$="[[!messages]]">
          [[messages]]
        </div>

        <div class="row-padding-v" hidden$="[[adminLevel]]">
          <template is="dom-repeat" items="[[interventionLocations]]">
              <div class="top-padding">- [[item.name]]</d>
          </template>
        </div>
        <div class="row-padding-v" hidden$="[[!adminLevel]]">
          <template is="dom-repeat" items="[[groupedLocations]]">
            <div class="parent-padding">
              <div class="adminLevelLoc" >[[item.adminLevelLocation.name]]</div>
              <div class="left-padding">
                  <template is="dom-repeat" items="[[item.subordinateLocations]]" as="subordinateLoc">
                    <div class="child-bottom-padding"> - [[subordinateLoc.name]]</div>
                  </template>
              </div>
          </div>
          </template>
        </div>

      </etools-dialog>
    </template>
  </dom-module>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'grouped-locations-dialog',
        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
        ],
        properties: {
          adminLevels: {//location types
            type: Array,
            //statePath: 'adminLevels'
            value: [{name:'Country'},{name:'District'}, {name:'Governorate'}, {name:'Localities'},{name:'Sub-districts'}]
          },
          adminLevel: {
            type: String,
            adminLevel: null,
            observer: 'adminLevelChanged'
          },
          locations: {
            type: Array,
            statePath: 'locations'
          },
          interventionLocations: {
            type: Array,
            value: [
            {id:"2027", name:"Abu Alandah [Localities - JOR005004001002]", parent: '1468', location_type: 'Localities'},
            {id:"2270", name: "3nbah [Localities - JOR007003001012]", parent: '1464', location_type: 'Localities'},
            {id:"2646", name: "Ad Dabbusah [Localities - JOR010002001035]", parent: '1471', location_type: 'Localities'},
            {id:"1296", name: "Aghwar Janoobiyah [District - JOR004001]", parent: '1281', location_type: 'District'},
            {id:"2243", name: "Abu Al Qayn [Localities - JOR007002001030]", parent: '1508', location_type: 'Localities'},
            {id:"1907", name: "Abu Ash Shahm [Localities - JOR004007001010]", parent: '1448', location_type: 'Localities'}]
          },

          groupedLocations: {
            type: Array
           // value: [ {adminLevelLocation: '', subordinateLocations: [{id:'', name:''}] }]
          },
          messages: {
            type: String,
            value: null
          }

        },

        adminLevelChanged: function(adminLevel) {
          this.messages = '';
          let groupedLocations = [];
          let locationsUnableToGroup = [];
          let i;

          for (i = 0; i < this.interventionLocations.length; i++) {

            let grouping = {
              adminLevelLocation: null,
              subordinateLocations: []
            };
            if (this.interventionLocations[i].location_type === adminLevel) {
              grouping.adminLevelLocation = this.interventionLocations[i];
              groupedLocations.push(grouping);
              continue;
            }

            // find admin level parent
            let adminLevelLocation = this._findAdminLevelParent(this.interventionLocations[i], adminLevel);
            if (!adminLevelLocation) {
              locationsUnableToGroup.push(this.interventionLocations[i].name);
              continue;
            }
            // check if parentLocation is already a parent to another intervention location
            let existingGroup = this._findInGroupedLocations(adminLevelLocation)
            if (!existingGroup) {
              groupedLocations.push({
                adminLevelLocation: adminLevelLocation,
                subordinateLocations: [this.interventionLocations[i]]
              });
            } else {
              existingGroup.subordinateLocations.push(this.interventionLocations[i]);
            }
          }
          if (locationsUnableToGroup && locationsUnableToGroup.length) {
            this.messages = 'Locations unable to group: ' + locationsUnableToGroup.join(', ');
          }

          this.groupedLocations = [];
          this.groupedLocations = groupedLocations;
        },
        _findInGroupedLocations: function(groupedLocations, adminLevelLocation) {
          if (!groupedLocations || !groupedLocations.length) {
            return null;
          }
          let existingGroups = groupedLocations.filter(function(g) {
            return parseInt(g.adminLevelLocation.id) === parseInt(adminLevelLocation.id);
          });

          if (!existingGroups || !existingGroups.length) {
            return null;
          }
          return existingGroups[0];
        },
        _findAdminLevelParent: function(location, adminLevel) {
          if (!location.parent) {
            return null;
          }
          let parentArr = this.locations.filter(function(loc) {
            return parseInt(loc.id) === parseInt(location.parent);
          });
          if (!parentArr || !parentArr.length) {
            return null;
          }
          if (parentArr[0].location_type === adminLevel) {
            return parentArr[0];
          }
          return this._findAdminLevelParent(parentArr[0], adminLevel);
        },

        open: function() {
          this.$.groupedLocDialog.opened = true;
        },
      });
  })();
</script>
