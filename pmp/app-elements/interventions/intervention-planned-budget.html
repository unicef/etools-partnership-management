<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">

<link rel="import" href="../../../bower_components/etools-currency-amount-input/etools-currency-behavior.html">
<link rel="import" href="../../../bower_components/etools-currency-amount-input/etools-currency-amount-input.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../common-elements/etools-form-element-wrapper.html">

<dom-module id="intervention-planned-budget">
  <template strip-whitespace>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles">
      [hidden] {
        display: none !important;
      }

       :host {
        display: block;
        width: 100%;
        padding: 7px 0;

        --paper-fab-keyboard-focus-background: var(--success-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        }
        ;
      }

      etools-currency-amount-input {
        width: 100%;
      }

      etools-currency-amount-input.total-input {
        --etools-currency-container-input: {
          font-weight: bold;
        }
        ;
      }

      .left-col {
        padding-top: 15px;
        padding-bottom: 15px;
      }
      .usd-label {
        display: flex;
        align-self: center;
      }
      #currency {
        width: auto;
      }

      .action.delete[disabled] {
        visibility: hidden;
      }
    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="row-v flex-c">
            <div class="row-h">
              <div class="col col-3">
                <div class="row-h flex-c left-col">
                    <div class="col col-3">
                      Currency
                    </div>

                    <div class="col col-9">
                      CSO Contribution
                    </div>
                 </div>
              </div>
              <div class="col col-9">
                <div class="row-h flex-c left-col">
                    <div class="col col-4">
                      UNICEF Cash
                    </div>
                    <div class="col col-4">
                      UNICEF Supply
                    </div>
                    <div class="col col-4">
                      TOTAL
                    </div>
                  </div>
              </div>
            </div>

              <div class="row-h">
                <div class="col col-3">
                  <div class="row-h flex-c left-col">
                    <div class="col col-3">
                      <etools-single-selection-menu id="currency_[[index]]" placeholder="&#8212;" options="[[currencies]]" on-iron-select="_currencyChanged"
                        required$="[[required]]" auto-validate error-message="Please select the currency" readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]">
                      </etools-single-selection-menu>
                    </div>
                    <div class="col col-9">
                      <etools-currency-amount-input id$="csoContLocal_[[index]]" value="{{item.partner_contribution_local}}"
                        type="number" placeholder="&#8212;" readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]" required$="[[required]]" auto-validate
                        error-message="CSO Cont. (Local) required">
                      </etools-currency-amount-input>
                    </div>
                  </div>
                </div>
                <div class="col col-9">
                  <div class="row-h flex-c left-col">
                    <div class="col col-4">
                      <etools-currency-amount-input id$="unicefCashLocal_[[index]]" value="{{item.unicef_cash_local}}"
                        type="number" placeholder="&#8212;" readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]" required$="[[required]]" auto-validate
                        error-message="UNICEF Cash (Local) required">
                      </etools-currency-amount-input>
                    </div>
                    <div class="col col-4">
                      <etools-currency-amount-input id$="inKindAmountLocal_[[index]]" value="{{item.in_kind_amount_local}}"
                        type="number" placeholder="&#8212;" readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]" required$="[[required]]" auto-validate
                        error-message="UNICEF Supply (Local) required">
                      </etools-currency-amount-input>
                    </div>
                    <div class="col col-4">
                      <etools-form-element-wrapper>
                        [[_getPlannedBudgetTotalFormatted(item.partner_contribution_local, item.unicef_cash_local, item.in_kind_amount_local)]]
                      </etools-form-element-wrapper>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row-h">
                <div class="col col-3">
                  <div class="row-h flex-c left-col">
                    <div class="col col-3 usd-label">
                      <span>USD</span>
                    </div>
                    <div class="col col-9">
                      <etools-currency-amount-input id$="csoContUsd_[[index]]" value="{{item.partner_contribution}}" type="number"
                        placeholder="&#8212;" readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]" required$="[[required]]" auto-validate error-message="CSO Cont. (USD) required">
                      </etools-currency-amount-input>
                    </div>
                  </div>
                </div>
                <div class="col col-9">
                  <div class="row-h flex-c left-col">
                    <div class="col col-4">
                      <etools-currency-amount-input id$="unicefCashUsd_[[index]]" value="{{item.unicef_cash}}" type="number"
                        placeholder="&#8212;" readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]" required$="[[required]]" auto-validate error-message="UNICEF Cash (USD) required">
                      </etools-currency-amount-input>
                    </div>
                    <div class="col col-4">
                      <etools-currency-amount-input id$="inKindAmountUsd_[[index]]" value="{{item.in_kind_amount}}"
                        type="number" placeholder="&#8212;" readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]" required$="[[required]]" auto-validate
                        error-message="UNICEF Supply (USD) required">
                      </etools-currency-amount-input>
                    </div>
                    <div class="col col-4">
                      <etools-form-element-wrapper>
                        [[_getPlannedBudgetTotalFormatted(item.partner_contribution, item.unicef_cash, item.in_kind_amount)]]
                      </etools-form-element-wrapper>
                    </div>
                  </div>
                </div>
              </div>

            </div>

          </div>
      </template>
      </div>

      <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
        <p>There are no planned budgets added.</p>
      </div>

      <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
        <paper-fab icon="create" hidden="[[!_showEditBtn(editMode, editablePlannedBudget)]]" title="Edit" on-tap="_editPlannedBudget"></paper-fab> <paper-fab icon="add" on-tap="_addNewPlannedBudget" title="Add"></paper-fab>
      </div>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'intervention-planned-budget',

        behaviors: [
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          etoolsBehaviors.EtoolsCurrencyBehavior
        ],

        properties: {
          currencies: {
            type: Array,
            statePath: 'currencies'
          },
          localCurrency: {
            type: String,
            value: ''
          },
          localCurrencyId: {
            type: Number,
            observer: '_localCurrencyIdChanged'
          },
          required: {
            type: Boolean,
            value: true
          },
          editMode: {
            type: Boolean,
            observer: '_editModeChanged'
          },
          editablePlannedBudget: {
            type: Boolean,
            value: false
          },
          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          }
        },
        observers: [
          '_dataItemsChanged(dataItems)',
          '_initSelectedCurrency(dataItems, currencies)'
        ],

        ready: function () {
          this.dataSetModel = {
            id: null,
            partner_contribution: 0,
            unicef_cash: 0,
            in_kind_amount: 0,
            partner_contribution_local: 0,
            unicef_cash_local: 0,
            in_kind_amount_local: 0,
            total: 0,
            currency: null
          };
        },
        _showEditBtn: function() {
          if (!this.editMode) {
            return false;
          }
          if (this.editablePlannedBudget) {
            return false;
          }
          return true;
        },
        _isReadonly: function() {
          if (!this.editMode) {
            return true;
          }
          if (!this.interventionId) {
            return false;
          }
          return !this.editablePlannedBudget;
        },
        _editPlannedBudget: function() {
          // TODO show cancel btn
          this.editablePlannedBudget = true;
        },

        _dataItemsChanged: function (dataItems) {
          if (!Array.isArray(dataItems)) {
            this.set('dataItems', []);
          }
        },

        // make sure we have the right currency selected when intervention is changed
        _interventionIdChanged: function () {
          if (this.interventionId) {
            this.editablePlannedBudget = false;
          }
          this._initSelectedCurrency(this.dataItems, this.currencies);
        },

        _initSelectedCurrency: function (dataItems, currencies) {
          this.debounce('initSelectedCurrency', function () {
            if (Array.isArray(dataItems) && dataItems.length > 0 &&
              Array.isArray(currencies) && currencies.length > 0) {
              // check and set the currency
              if (dataItems[0].currency) {
                // dataItems[0].currency should be the currency ID
                var currency = currencies.filter(function (c) {
                  return parseInt(c.value, 10) === parseInt(dataItems[0].currency, 10);
                })[0];
                if (currency) {
                  this.set('localCurrencyId', currency.value);
                  this.set('localCurrency', currency.label);
                  this._setCurrencyDropdownValue(currency);
                  return;
                }
              }
            }
            // reset local currency
            this.set('localCurrencyId', null);
            this.set('localCurrency', null);
            this._setCurrencyDropdownValue(null);
          }.bind(this), 50);
        },

        _setCurrencyDropdownValue: function (currency) {
          var currencyValue = currency ? currency.value : null;
          this.dataItems.forEach(function (item, index) {
            var dropdown = this.$$('#currency_' + index);
            if (dropdown) {
              dropdown.set('selected', currencyValue);
            }
          }.bind(this));
        },

        _localCurrencyIdChanged: function (currencyId) {
          if (!currencyId) {
            currencyId = null;
          }
          if (this.dataItems instanceof Array && this.dataItems.length > 0) {
            this.dataItems.forEach(function (item) {
              item.currency = currencyId;
            });
          }
          this.set('dataSetModel.currency', currencyId);
        },

        _currencyChanged: function (event) {
          var selCurrencyName = null;
          var selCurrencyId = null;

          var selectedItem = event.detail.item.item;
          if (selectedItem && selectedItem.label) {
            selCurrencyName = selectedItem.label;
            selCurrencyId = selectedItem.value;
          }
          this.set('localCurrency', selCurrencyName);
          this.set('localCurrencyId', selCurrencyId);
        },

        _getPlannedBudgetTotal: function (val1, val2, val3, currency) {
          var t = 0;
          val1 = parseFloat(val1);
          if (!isNaN(val1)) {
            t += val1;
          }
          val2 = parseFloat(val2);
          if (!isNaN(val2)) {
            t += val2;
          }
          val3 = parseFloat(val3);
          if (!isNaN(val3)) {
            t += val3;
          }
          if (typeof currency === 'string' && currency !== '') {
            return t + ' ' + currency;
          }
          return t;
        },

        _getPlannedBudgetTotalFormatted: function (val1, val2, val3) {
          return this.displayCurrencyAmount(this._getPlannedBudgetTotal(val1, val2, val3), '0', 0);
        },

        /**
         * Validate last added planned budget and if is not empty add a new one
         */
        _addNewPlannedBudget: function () {
          this._addElement();
        },

        // validate fields
        validate: function () {
          var valid = true;
          if (this.dataItems.length > 0) {
            this.dataItems.forEach(function (item, index) {
              var elementsSelectorsToValidate = [
                // '#year_' + index,
                '#currency_' + index,
                '#csoContLocal_' + index,
                '#unicefCashLocal_' + index,
                '#inKindAmountLocal_' + index,
                '#csoContUsd_' + index,
                '#unicefCashUsd_' + index,
                '#inKindAmountUsd_' + index
              ];
              elementsSelectorsToValidate.forEach(function (selector) {
                var el = this.$$(selector);
                if (el && !el.validate()) {
                  valid = false;
                }
              }.bind(this));
            }.bind(this));
          }
          return valid;
        },

        // reset validation errors
        resetValidations: function () {

          if (this.dataItems.length > 0) {
            this.dataItems.forEach(function (item, index) {
              var elementsSelectorsToValidate = [
                '#currency_' + index,
                '#csoContLocal_' + index,
                '#unicefCashLocal_' + index,
                '#inKindAmountLocal_' + index,
                '#csoContUsd_' + index,
                '#unicefCashUsd_' + index,
                '#inKindAmountUsd_' + index
              ];
              elementsSelectorsToValidate.forEach(function (selector) {
                var el = this.$$(selector);
                if (el) {
                  el.set('invalid', false);
                }
              }.bind(this));
            }.bind(this));
          }
        },

        _editModeChanged: function (newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        }

      });
    })();
  </script>
</dom-module>
