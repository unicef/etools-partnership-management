<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">
<link rel="import" href="../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../bower_components/etools-currency-amount-input/etools-currency-behavior.html">
<link rel="import" href="../../../bower_components/etools-currency-amount-input/etools-currency-amount-input.html">
<link rel="import" href="../../../bower_components/etools-info-tooltip/etools-info-tooltip.html">

<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/shared-styles.html">

<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../common-elements/etools-form-element-wrapper.html">

<link rel="import" href="behaviors/fr-numbers-consistency-behavior.html">

<dom-module id="intervention-planned-budget">
  <template strip-whitespace>
    <style include="shared-styles data-table-styles grid-layout-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        --list-column-label: {
          margin-right: 0;
        };
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      #edit-btns paper-icon-button {
        color: var(--light-icon-color);
      }

      .currency {
        width: 200px;
      }

      etools-currency-amount-input {
        max-width: 175px;
      }

      .total {
        width: 200px;
      }

      #currency {
        width: auto;
      }

      #unicef-cash.frs-inconsistent {
        --paper-input-container-input: {
          color: var(--error-color);
        }
      }

      etools-currency-amount-input.frs-inconsistent {
        --etools-currency-container-input: {
          color: var(--error-color);
        }
      }

      etools-info-tooltip {
        --etools-tooltip-trigger-icon: {
          @apply(--pmp-form-field-frs-inconsistency-icon);
        };
      }
    </style>

    <etools-content-panel panel-title="Planned Budget">

      <div slot="panel-btns" id="edit-btns">
        <paper-icon-button icon="cancel"
                           hidden$="[[!_showCancelBtn(_showCancelButton)]]"
                           disabled$="[[!_showCancelBtn(_showCancelButton)]]"
                           title="Cancel"
                           on-tap="_cancelEdit">
        </paper-icon-button>
        <paper-icon-button icon="create"
                           hidden$="[[!_showEditBtn(editMode, unicefCashEditMode, _showCancelButton)]]"
                           disabled$="[[!_showEditBtn(editMode, unicefCashEditMode, _showCancelButton)]]"
                           title="Edit"
                           on-tap="_editPlannedBudget">
        </paper-icon-button>
      </div>

      <div class="list-container form-fields">
        <etools-data-table-header id="listHeader"
                                  no-collapse
                                  no-title>
          <etools-data-table-column class="col-3 currency"> Currency</etools-data-table-column>
          <etools-data-table-column class="col-3 right-align"> CSO Contribution</etools-data-table-column>
          <etools-data-table-column class="col-2 right-align"> UNICEF Cash</etools-data-table-column>
          <etools-data-table-column class="col-2 right-align"> UNICEF Supply</etools-data-table-column>
          <etools-data-table-column class="col-2 right-align"> TOTAL</etools-data-table-column>
        </etools-data-table-header>

        <etools-data-table-row no-collapse>
          <div slot="row-data">
            <span class="col-data col-3 currency">
              <etools-form-element-wrapper no-label-float>
                <span>USD</span>
              </etools-form-element-wrapper>
            </span>

            <span class="col-data col-3 right-align">
              <etools-currency-amount-input id="csoContUsd"
                                            value="{{plannedBudget.partner_contribution}}"
                                            type="number"
                                            placeholder="&#8212;"
                                            readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]"
                                            required$="[[required]]" auto-validate
                                            error-message="CSO Cont. (USD) required"
                                            no-label-float>
              </etools-currency-amount-input>
            </span>

            <span class="col-data col-2 right-align">
              <etools-info-tooltip icon="report" icon-first
                                  hide-tooltip$="[[!frsConsistencyWarningIsActive(_frsConsistencyWarning)]]"
                                  important-warning>
                <div slot="field">
                  <template is="dom-if" if="[[_isReadonly(unicefCashEditMode, editablePlannedBudget, interventionId)]]">
                    <!-- readonly unicef cash -->
                    <etools-form-element-wrapper no-label-float
                                                id="unicef-cash"
                                                class$="[[getFrsInconsistentFieldClass(_frsConsistencyWarning)]]">
                      [[displayCurrencyAmount(plannedBudget.unicef_cash, '0.00')]]
                    </etools-form-element-wrapper>
                  </template>
                  <template is="dom-if"
                            if="[[!_isReadonly(unicefCashEditMode, editablePlannedBudget, interventionId)]]">
                    <!-- editable unicef cash -->
                    <etools-currency-amount-input id="unicefCashUsd"
                                                  class$="[[getFrsInconsistentFieldClass(_frsConsistencyWarning)]]"
                                                  value="{{plannedBudget.unicef_cash}}" type="number"
                                                  placeholder="&#8212;"
                                                  required$="[[required]]" auto-validate
                                                  error-message="UNICEF Cash (USD) required"
                                                  no-label-float>
                    </etools-currency-amount-input>
                  </template>
                </div>
                <span slot="message">[[_frsConsistencyWarning]]</span>
              </etools-info-tooltip>
            </span>

            <span class="col-data col-2 right-align">
              <etools-currency-amount-input id="inKindAmountUsd"
                                            value="{{plannedBudget.in_kind_amount}}"
                                            type="number" placeholder="&#8212;"
                                            readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]"
                                            required$="[[required]]" auto-validate
                                            error-message="UNICEF Supply (USD) required"
                                            no-label-float>
              </etools-currency-amount-input>
            </span>

            <span class="col-data col-2 right-align">
              <etools-form-element-wrapper no-label-float>
                [[_getPlannedBudgetTotalFormatted(plannedBudget.partner_contribution, plannedBudget.unicef_cash,
                plannedBudget.in_kind_amount)]]
              </etools-form-element-wrapper>
            </span>
          </div>
        </etools-data-table-row>
        <etools-data-table-row no-collapse>
          <div slot="row-data">
            <span class="col-data col-3 currency">
              <etools-single-selection-menu id="currency" placeholder="&#8212;"
                                            options="[[currencies]]"
                                            selected="{{plannedBudget.currency}}"
                                            readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]"
                                            no-label-float>
              </etools-single-selection-menu>
            </span>

            <span class="col-data col-3 right-align">
              <etools-currency-amount-input id="csoContLocal"
                                            value="{{plannedBudget.partner_contribution_local}}"
                                            type="number" placeholder="&#8212;"
                                            readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]"
                                            no-label-float>
              </etools-currency-amount-input>
            </span>

            <span class="col-data col-2 right-align">
              <etools-currency-amount-input id="unicefCashLocal"
                                            value="{{plannedBudget.unicef_cash_local}}"
                                            type="number" placeholder="&#8212;"
                                            readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]"
                                            no-label-float>
              </etools-currency-amount-input>
            </span>

            <span class="col-data col-2 right-align">
              <etools-currency-amount-input id="inKindAmountLocal"
                                            value="{{plannedBudget.in_kind_amount_local}}"
                                            type="number" placeholder="&#8212;"
                                            readonly$="[[_isReadonly(editMode, editablePlannedBudget, interventionId)]]"
                                            no-label-float>
              </etools-currency-amount-input>
            </span>

            <span class="col-data col-2 right-align">
              <etools-form-element-wrapper no-label-float>
                [[_getPlannedBudgetTotalFormatted(plannedBudget.partner_contribution_local,
                plannedBudget.unicef_cash_local, plannedBudget.in_kind_amount_local)]]
              </etools-form-element-wrapper>
            </span>
          </div>
        </etools-data-table-row>
      </div>
    </etools-content-panel>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-planned-budget',

        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
          etoolsBehaviors.EtoolsCurrencyBehavior,
          EtoolsPmpApp.Behaviors.FrNumbersConsistency
        ],

        properties: {
          intervention: Object,
          plannedBudget: {
            type: Object,
            notify: true,
            observer: '_plannedBudgetChanged'
          },
          currencies: {
            type: Array,
            statePath: 'currencies'
          },
          required: {
            type: Boolean,
            value: true
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          },
          unicefCashEditMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          },
          editablePlannedBudget: {
            type: Boolean,
            value: false
          },
          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          },
          initialPlannedBudget: Object,
          _frsConsistencyWarning: {
            type: String,
            value: ''
          },
          _showCancelButton: Boolean,
          countryData: {
            type: Object,
            statePath: 'countryData'
          }
        },

        observers: [
          '_checkFrsAmountConsistency(intervention.frs_details.total_frs_amt, plannedBudget.unicef_cash)',
          '_initLocalCurrency(plannedBudget, countryData)'
        ],

        _initLocalCurrency: function(plannedBudget, countryData) {
          if (!plannedBudget.currency && countryData && countryData.local_currency_id) {
            this.set('plannedBudget.currency', countryData.local_currency_id);
          }
        },

        _plannedBudgetChanged: function() {
          if (this.interventionId) {
            //* reset flags after Save
            this.set('editablePlannedBudget', false);
            this.set('_showCancelButton', false);
          }
        },
        _cancelEdit: function() {
          this.plannedBudget = JSON.parse(JSON.stringify(this.initialPlannedBudget));
          this.set('editablePlannedBudget', false);
          this.set('_showCancelButton', false);
        },
        _showCancelBtn: function(showCancelButton) {
          return showCancelButton && this.interventionId;
        },
        _showEditBtn: function(editMode, unicefCashEditMode, showCancelButton) {
          return (editMode || unicefCashEditMode) && !showCancelButton && this.interventionId;
        },
        _isReadonly: function(editMode, editablePlannedBudget, interventionId) {
          if (!editMode) {
            return true;
          }
          if (!interventionId) {
            return false;
          }
          return !editablePlannedBudget;
        },
        _editPlannedBudget: function() {
          this.set('editablePlannedBudget', true);
          this.set('_showCancelButton', true);
          this.initialPlannedBudget = Object.assign({}, this.plannedBudget);
        },
        // make sure we have the right currency selected when intervention is changed
        _interventionIdChanged: function() {
          this.initialPlannedBudget = Object.assign({}, this.plannedBudget);
          this.editablePlannedBudget = !this.interventionId;
          this.set('_showCancelButton', false);
        },
        _getPlannedBudgetTotal: function(val1, val2, val3, currency) {
          var t = 0;
          val1 = parseFloat(val1);
          if (!isNaN(val1)) {
            t += val1;
          }
          val2 = parseFloat(val2);
          if (!isNaN(val2)) {
            t += val2;
          }
          val3 = parseFloat(val3);
          if (!isNaN(val3)) {
            t += val3;
          }
          if (typeof currency === 'string' && currency !== '') {
            return t + ' ' + currency;
          }
          return t;
        },
        _getPlannedBudgetTotalFormatted: function(val1, val2, val3) {
          return this.displayCurrencyAmount(this._getPlannedBudgetTotal(val1, val2, val3), '0', 0);
        },

        // validate fields
        validate: function() {
          var valid = true;
          var elementsSelectorsToValidate = [
            '#csoContUsd',
            '#unicefCashUsd',
            '#inKindAmountUsd'
          ];
          elementsSelectorsToValidate.forEach(function(selector) {
            var el = this.$$(selector);
            if (el && !el.validate()) {
              valid = false;
            }
          }.bind(this));
          return valid;
        },

        // reset validation errors
        resetValidations: function() {
          var elementsSelectorsToValidate = [
            '#csoContUsd',
            '#unicefCashUsd',
            '#inKindAmountUsd'
          ];
          elementsSelectorsToValidate.forEach(function(selector) {
            var el = this.$$(selector);
            if (el) {
              el.set('invalid', false);
            }
          }.bind(this));
        },

        _editModeChanged: function(newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        },

        _checkFrsAmountConsistency: function(frsTotalAmt, unicefCash) {
          let unicefCashField = this.$$('#unicefCashUsd');
          if (this.emptyFrsList(this.intervention, 'interventionDetails')) {
            this.set('_frsConsistencyWarning', '');
            if (unicefCashField) {
              unicefCashField.updateStyles();
            }
            return;
          }
          this.set('_frsConsistencyWarning',
              this.checkFrsAndUnicefCashAmountsConsistency(unicefCash, frsTotalAmt, this.intervention,
              'interventionDetails', true));
          if (unicefCashField) {
            unicefCashField.updateStyles();
          }
        }

      });
    })();
  </script>
</dom-module>
