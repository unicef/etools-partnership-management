<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">

<dom-module id="intervention-planned-budget">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;

        --paper-fab-keyboard-focus-background: #8dc63f; /* TODO: replace with app-theme var */
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }
      paper-input {
        width: 100%;
      }

      .darkbg {
        padding: 0 15px;
        background-color: #EDEDED; /* TODO: replace with app-theme var */
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
      }

    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="row-h item-actions-container" data-item-nr$="[[_getItemNr(index)]]">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled="[[!_canBeRemoved(index)]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">
            <div class="row-h">
              <div class="col col-4">
                <div class="row-h flex-c">
                  <div class="col col-4">
                    <etools-searchable-multiselection-menu id$="year_[[index]]"
                       label="Year"
                       placeholder="&#8212;"
                       value="[[_getSelectedYear(item.year)]]"
                       options="[[years]]"
                       on-value-change="_yearChanged"
                       data-path="locations">
                  </div>
                  <div class="col col-8">
                    <paper-input label="CSO Cont. (Local)"
                      value="{{item.partner_contribution_local}}"
                      type="number"
                      placeholder="&#8212;">
                    </paper-input>
                  </div>
                </div>
              </div>
              <div class="col col-8">
                <div class="row-h flex-c darkbg">
                  <div class="col col-4">
                    <paper-input label="UNICEF Cash (Local)"
                      value="{{item.unicef_cash_local}}"
                      type="number"
                      placeholder="&#8212;">
                    </paper-input>
                  </div>
                  <div class="col col-4">
                    <paper-input label="UNICEF Supply (Local)"
                      value="{{item.in_kind_amount_local}}"
                      type="number"
                      placeholder="&#8212;">
                    </paper-input>
                  </div>
                  <div class="col col-4">
                    <paper-input label="UNICEF Total (Local)"
                      value$="[[_getTotal(item.partner_contribution_local, item.unicef_cash_local, item.in_kind_amount_local)]]"
                      type="number"
                      placeholder="&#8212;"
                      readonly>
                    </paper-input>
                  </div>
                </div>
              </div>
            </div>

            <div class="row-h">
              <div class="col col-4">
                <div class="row-h flex-c">
                  <div class="col col-4"></div>
                  <div class="col col-8">
                    <paper-input label="CSO Cont. (USD)"
                      value="{{item.partner_contribution}}"
                      type="number"
                      placeholder="&#8212;">
                    </paper-input>
                  </div>
                </div>
              </div>
              <div class="col col-8">
                <div class="row-h flex-c darkbg">
                  <div class="col col-4">
                    <paper-input label="UNICEF Cash (USD)"
                      value="{{item.unicef_cash}}"
                      type="number"
                      placeholder="&#8212;">
                    </paper-input>
                  </div>
                  <div class="col col-4">
                    <paper-input label="UNICEF Supply (USD)"
                      value="{{item.in_kind_amount}}"
                      type="number"
                      placeholder="&#8212;">
                    </paper-input>
                  </div>
                  <div class="col col-4">
                    <paper-input label="UNICEF Total (USD)"
                      value$="[[_getTotal(item.partner_contribution, item.unicef_cash, item.in_kind_amount)]]"
                      type="number"
                      placeholder="&#8212;"
                      readonly>
                    </paper-input>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>
      </template>
      <div class="row-h">
        <div class="col col-8" style="margin-left: auto;">
          <div class="row-h flex-c darkbg">
            <p>Total UNICEF Budget...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no planned budgets added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewPlannedBudget"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-planned-budget',

        behaviors: [
          pmpBehaviors.RepeatableDataSetsBehavior
        ],

        properties: {
          years: {
            type: Array,
            value: []
          },
          interventionStart: {
            type: String,
            value: '2016-12-25'
          },
          interventionEnd: {
            type: String,
            value: '2016-12-25'
          }
        },
        observers: [
            '_setYears(interventionStart, interventionEnd)',
            '_dataItemsChanged(dataItems)'
        ],

        ready: function() {
          this.dataSetModel = {
            id: null,
            partner_contribution: null,
            unicef_cash: null,
            in_kind_amount: null,
            partner_contribution_local: null,
            unicef_cash_local: null,
            in_kind_amount_local: null,
            year: null,
            total: 0
          };

        },

        _dataItemsChanged: function(dataItems) {
          if (!Array.isArray(dataItems)) {
            this.set('dataItems', []);
          }

        },

        _setYears: function(interventionStart, interventionEnd) {
          if (typeof interventionStart === 'string' && interventionStart !== ''
              && typeof interventionEnd === 'string' && interventionEnd !== '') {
            this.debounce('setInterventionsPlannedBudgetYears', function() {
              var start = parseInt(interventionStart.substr(0, 4), 10);
              var end = parseInt(interventionEnd.substr(0, 4), 10);
              var years = [];
              while (start <= end) {
                years.push({
                  value: start,
                  label: start
                });
                start++;
              }
              this.set('years', years);

            }.bind(this), 50)
          }
        },

        /**
         * The planned budget row data can be removed only if it doesn't have and id assigned(only if is not saved)
         */
        _canBeRemoved: function(index) {
          var plannedBudget = this.dataItems[index];
          var plannedBudget = parseInt(plannedBudget.id, 10);
          if (plannedBudget && isNaN(plannedBudget) === false && plannedBudget > 0) {
            // planned budget already saved (has an id assigned)
            return false;
          }
          return true;
        },

        _getItemNr: function(index) {
          return parseInt(index, 10) + 1;
        },

        _getSelectedYear: function(year) {
          if (year) {
            return this.years.filter(function(y) {
              return y === parseInt(year, 10);
            });
          }
          return [];
        },

        _yearChanged: function(event) {
          console.log(event.model.index);
        },

        _getTotal: function(val1, val2, val3) {
          return parseFloat(val1) + parseFloat(val2) + parseFloat(val3);
        },

        /**
         * Check if amendment fields are empty
         */
        //        _plannedBudgetFieldsAreNotEmpty: function(plannedBudgetItem) {
        //          return parseFloat(plannedBudgetItem.partner_contribution) > 0
        //              || parseFloat(plannedBudgetItem.unicef_cash) > 0
        //              || parseFloat(plannedBudgetItem.in_kind_amount) > 0
        //              || parseFloat(plannedBudgetItem.partner_contribution_local) > 0
        //              || parseFloat(plannedBudgetItem.in_kind_amount_local) > 0
        //              || parseInt(plannedBudgetItem.year, 10) > 0
        //              || parseFloat(plannedBudgetItem.total) > 0
        //        },

        /**
         * Validate last added planned budget and if is not empty add a new one
         */
        _addNewPlannedBudget: function() {
          var lastPlannedBudgetItemIndex = this.dataItems.length - 1;
          if (lastPlannedBudgetItemIndex >= 0 && this._canBeRemoved(lastPlannedBudgetItemIndex)) {
            //            var lastPlannedBudgetItem = this.dataItems[lastPlannedBudgetItemIndex];
            //            if (!this._plannedBudgetFieldsAreNotEmpty(lastPlannedBudgetItem)) {
            //              this.fire('toast', {text: 'Last planned budget fields are empty!', showCloseBtn: true});
            //            } else {
            this._addElement();
            //            }
          } else {
            this._addElement();
          }
        }

      });
    })();
  </script>
</dom-module>
