<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/etools-currency-amount-input/etools-currency-behavior.html">
<link rel="import" href="../../../bower_components/etools-currency-amount-input/etools-currency-amount-input.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../common-elements/etools-form-element-wrapper.html">

<dom-module id="intervention-planned-budget">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;

        --paper-fab-keyboard-focus-background: var(--success-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }
      etools-currency-amount-input {
        width: 100%;
      }

      etools-currency-amount-input.total-input {
        --etools-currency-container-input: {
          font-weight: bold;
        };
      }

      .left-col {
        padding-top: 15px;
        padding-bottom: 15px;
      }

      .darkbg {
        padding: 15px;
        background-color: var(--medium-theme-background-color);
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
      }

      #totals {
        padding: 15px 15px 15px 86px;
        font-weight: bold;
      }
      #totals-content-wrapper .darkbg {
        padding: 15px;
        @apply(--layout-horizontal);
      }
       .darkbg + .darkbg {
        margin-top: 15px;
      }

      #totals-content-wrapper {
        margin-left: auto;
        padding-left: 25px;
        @apply(--layout-vertical);
      }

      .total-unicef-label {
        @apply(--layout-end-justified);
      }
      .total-unicef-label span {
        display: flex;
        align-self: center;
      }

      .total-unicef {
        @apply(--layout-vertical);
        max-width: 100%;
        word-wrap: break-word;
      }
      .total-unicef span {
        display: inline-block;
        width: 100%;
        background-color: var(--ternary-color);
        padding: 15px;
        box-sizing: border-box;
        border-bottom: 1px solid var(--dark-divider-color, rgba(0, 0, 0, 0.12));
        text-align: center;
      }

      #currency {
        width: auto;
      }

      .action.delete[disabled] {
        visibility: hidden;
      }
    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <div class="row-h flex-c">
        <etools-searchable-multiselection-menu id="currency"
                                               label="Local Currency"
                                               placeholder="&#8212;"
                                               options="[[currencies]]"
                                               on-value-change="_currencyChanged"
                                               required$="[[required]]"
                                               auto-validate
                                               error-message="Please select the currency"
                                               readonly$="[[!editMode]]">
        </etools-searchable-multiselection-menu>
      </div>
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="row-h item-actions-container">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled="[[!_canBeRemoved(index, editMode)]]"
                                 icon="cancel">
              </paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">
            <div class="row-h">
              <div class="col col-4">
                <div class="row-h flex-c left-col">
                  <div class="col col-4">
                    <etools-searchable-multiselection-menu id$="year_[[index]]"
                       class="year"
                       label="Year"
                       placeholder="&#8212;"
                       value="[[_getSelectedYear(item.year, years.length)]]"
                       options="[[years]]"
                       on-value-change="_yearChanged"
                       required$="[[required]]"
                       auto-validate
                       dynamic-align
                       error-message="Year required"
                       readonly$="[[!editMode]]">
                    </etools-searchable-multiselection-menu>
                  </div>
                  <div class="col col-8">
                    <etools-currency-amount-input label="CSO Cont. (Local)"
                      value="{{item.partner_contribution_local}}"
                      type="number"
                      placeholder="&#8212;"
                      readonly$="[[!editMode]]">
                    </etools-currency-amount-input>
                  </div>
                </div>
              </div>
              <div class="col col-8">
                <div class="row-h flex-c darkbg">
                  <div class="col col-4">
                    <etools-currency-amount-input label="UNICEF Cash (Local)"
                      value="{{item.unicef_cash_local}}"
                      type="number"
                      placeholder="&#8212;"
                      readonly$="[[!editMode]]">
                    </etools-currency-amount-input>
                  </div>
                  <div class="col col-4">
                    <etools-currency-amount-input label="UNICEF Supply (Local)"
                      value="{{item.in_kind_amount_local}}"
                      type="number"
                      placeholder="&#8212;"
                      readonly$="[[!editMode]]">
                    </etools-currency-amount-input>
                  </div>
                  <div class="col col-4">
                    <etools-form-element-wrapper label="UNICEF Total (Local)">
                      [[_getPlannedBudgetTotalFormatted(item.unicef_cash_local, item.in_kind_amount_local)]] [[localCurrency]]
                    </etools-form-element-wrapper>
                  </div>
                </div>
              </div>
            </div>

            <div class="row-h">
              <div class="col col-4">
                <div class="row-h flex-c left-col">
                  <div class="col col-4"></div>
                  <div class="col col-8">
                    <etools-currency-amount-input id$="partnerContribUsd_[[index]]"
                      label="CSO Cont. (USD)"
                      value="{{item.partner_contribution}}"
                      type="number"
                      placeholder="&#8212;"
                      readonly$="[[!editMode]]">
                    </etools-currency-amount-input>
                  </div>
                </div>
              </div>
              <div class="col col-8">
                <div class="row-h flex-c darkbg">
                  <div class="col col-4">
                    <etools-currency-amount-input id$="unicefCashUsd_[[index]]"
                      label="UNICEF Cash (USD)"
                      value="{{item.unicef_cash}}"
                      type="number"
                      placeholder="&#8212;"
                      readonly$="[[!editMode]]">
                    </etools-currency-amount-input>
                  </div>
                  <div class="col col-4">
                    <etools-currency-amount-input label="UNICEF Supply (USD)"
                      value="{{item.in_kind_amount}}"
                      type="number"
                      placeholder="&#8212;"
                      readonly$="[[!editMode]]">
                    </etools-currency-amount-input>
                  </div>
                  <div class="col col-4">
                    <etools-form-element-wrapper label="UNICEF Total (USD)">
                      [[_getPlannedBudgetTotalFormatted(item.unicef_cash, item.in_kind_amount)]] [[localCurrency]]
                    </etools-form-element-wrapper>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>
      </template>
      <div id="totals" class="row-h">
        <div id="totals-content-wrapper" class="col col-8">
          <div class="darkbg">
            <div class="col flex-c total-unicef-label">
              <span>Total UNICEF Budget</span>
            </div>
            <div class="col col-4">
              <div class="flex-c total-unicef">
                <span>[[displayCurrencyAmount(_localUnicefTotal, '0')]] [[localCurrency]]</span>
                <span>[[displayCurrencyAmount(_usdUnicefTotal, '0')]] USD</span>
              </div>
            </div>
          </div>

          <div class="darkbg">
            <div class="col flex-c total-unicef-label">
              <span>Total CSO Budget</span>
            </div>
            <div class="col col-4">
              <div class="flex-c total-unicef">
                <span>[[displayCurrencyAmount(_localCsoTotal, '0')]] [[localCurrency]]</span>
                <span>[[displayCurrencyAmount(_usdCsoTotal, '0')]] USD</span>
              </div>
            </div>
          </div>

          <div class="darkbg">
            <div class="col flex-c total-unicef-label">
              <span>Total Budget (CSO + UNICEF)</span>
            </div>
            <div class="col col-4">
              <div class="flex-c total-unicef">
                <span>[[_getPlannedBudgetTotalFormatted(_localCsoTotal, _localUnicefTotal)]] [[localCurrency]]</span>
                <span>[[_getPlannedBudgetTotalFormatted(_usdCsoTotal, _usdUnicefTotal)]] USD</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no planned budgets added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewPlannedBudget"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-planned-budget',

        behaviors: [
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          etoolsBehaviors.EtoolsCurrencyBehavior
        ],

        properties: {
          years: {
            type: Array,
            value: []
          },
          _localUnicefTotal: {
            type: Number,
            value: 0
          },
          _usdUnicefTotal: {
            type: Number,
            value: 0
          },
          _localCsoTotal: {
            type: Number,
            value: 0
          },
          _usdCsoTotal: {
            type: Number,
            value: 0
          },
          currencies: {
            type: Array,
            statePath: 'currencies'
          },
          localCurrency: {
            type: String,
            value: ''
          },
          localCurrencyId: {
            type: Number,
            observer: '_localCurrencyIdChanged'
          },
          required: {
            type: Boolean,
            value: false
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          },
          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          }
        },
        observers: [
            '_dataItemsChanged(dataItems)',
            '_dataItemChange(dataItems.*)',
            '_initSelectedCurrency(dataItems, currencies)'
        ],

        ready: function() {
          this.dataSetModel = {
            id: null,
            partner_contribution: 0,
            unicef_cash: 0,
            in_kind_amount: 0,
            partner_contribution_local: 0,
            unicef_cash_local: 0,
            in_kind_amount_local: 0,
            year: null,
            total: 0,
            currency: null
          };
        },

        _dataItemsChanged: function(dataItems) {
          if (!Array.isArray(dataItems)) {
            this.set('dataItems', []);
          }
        },

        _interventionIdChanged: function(intervId) {
          this.set('localCurrencyId', null);
          this.set('localCurrency', null);
          this.set('dataSetModel.currency', null);
          this._setCurrencyDropdownValue(null);
          this._initSelectedCurrency(this.dataItems, this.currencies);
        },

        _initSelectedCurrency: function(dataItems, currencies) {
          this.debounce('initSelectedCurrency', function() {
            if (Array.isArray(dataItems) && dataItems.length > 0 &&
                Array.isArray(currencies) && currencies.length > 0) {
              // check and set the currency
              if (dataItems[0].currency) {
                // dataItems[0].currency should be the currency ID
                var currency = currencies.filter(function(c) {
                  return parseInt(c.value, 10) === parseInt(dataItems[0].currency, 10);
                })[0];
                if (currency) {
                  this.set('localCurrencyId', currency.value);
                  this.set('localCurrency', currency.label);
                  this.set('dataSetModel.currency', currency.value);
                  this._setCurrencyDropdownValue(currency);
                }
              }
            }
          }.bind(this), 50);
        },

        _setCurrencyDropdownValue: function(currency) {
          // set selected currency dropdown value
          var currencyDropdown = this.$.currency;
          if (currencyDropdown) {
            currencyDropdown.set('value', currency);
          }
        },

        _dataItemChange: function(dataItem) {
          if (dataItem.path !== 'dataItems.splices') {

            this._computeTotals(this.dataItems);
          }
        },

        _computeTotals: function(data) {
          var localUnicefTotal = 0;
          var usdUnicefTotal = 0;
          var localCsoTotal = 0;
          var usdCsoTotal = 0;
          data.forEach(function(plannedBudget) {
            usdUnicefTotal += this._getPlannedBudgetTotal(plannedBudget.unicef_cash, plannedBudget.in_kind_amount);
            localUnicefTotal += this._getPlannedBudgetTotal(plannedBudget.unicef_cash_local,
                plannedBudget.in_kind_amount_local);

            var contLocal = parseFloat(plannedBudget.partner_contribution_local);
            if (!isNaN(contLocal)) {
              localCsoTotal += contLocal;
            }

            var contUsd = parseFloat(plannedBudget.partner_contribution);
            if (!isNaN(contUsd)) {
              usdCsoTotal += contUsd;
            }
          }.bind(this));
          this.set('_localUnicefTotal', localUnicefTotal);
          this.set('_usdUnicefTotal', usdUnicefTotal);
          this.set('_localCsoTotal', localCsoTotal);
          this.set('_usdCsoTotal', usdCsoTotal);
        },

        /**
         * The planned budget row data can be removed only if it doesn't have and id assigned(only if is not saved)
         */
        _canBeRemoved: function(index, editMode) {
          if (!editMode) {
            return false;
          }
          var plannedBudget = this.dataItems[index];
          plannedBudget = parseInt(plannedBudget.id, 10);

          if (plannedBudget && isNaN(plannedBudget) === false && plannedBudget > 0) {
            // planned budget already saved (has an id assigned)
            return false;
          }
          return true;
        },

        _getSelectedYear: function(year) {
          if (year && this.years.length) {
            return this.years.filter(function(y) {
              return y.value === parseInt(year, 10);
            });
          }
          return [];
        },

        _yearChanged: function(event) {
          var yearSelected = (event.detail.selectedValues && event.detail.selectedValues.value)
              ? event.detail.selectedValues.value : null;

          if (this._yearAlreadySelected(yearSelected, event.model.index)) {
            this.fire('toast', {text: 'Year already selected on other planned budget item.', showCloseBtn: true});
            var yearDropdown = this.$$('#year_' + event.model.index);
            if (yearDropdown) {
              yearDropdown.value = [];
              yearDropdown.selectedValues = null;
            }
            return;
          }

          this.set('dataItems.' + event.model.index + '.year', yearSelected);
        },

        _localCurrencyIdChanged: function(currencyId) {
          if (!currencyId) {
            currencyId = null;
          }
          if (this.dataItems instanceof Array && this.dataItems.length > 0) {
            this.dataItems.forEach(function(item) {
              item.currency = currencyId;
            });
          }
          this.set('dataSetModel.currency', currencyId);
        },

        _currencyChanged: function(event) {
          var currencyNameSelected = null;
          var currencyIdSelected = null;
          if (event.detail.selectedValues && event.detail.selectedValues.label) {
            currencyNameSelected = event.detail.selectedValues.label;
            currencyIdSelected = event.detail.selectedValues.value;
          }
          this.set('localCurrency', currencyNameSelected);
          this.set('localCurrencyId', currencyIdSelected);
        },

        _getPlannedBudgetTotal: function(val1, val2, currency) {
          var t = 0;
          val1 = parseFloat(val1);
          if (!isNaN(val1)) {
            t += val1;
          }
          val2 = parseFloat(val2);
          if (!isNaN(val2)) {
            t += val2;
          }
          if (typeof currency === 'string' && currency !== '') {
            return t + ' ' + currency;
          }
          return t;
        },

        _getPlannedBudgetTotalFormatted: function(val1, val2) {
          return this.displayCurrencyAmount(this._getPlannedBudgetTotal(val1, val2), '0');
        },

        _yearAlreadySelected: function(year, dropdownIdx) {
          var dropdowns = Polymer.dom(this.root).querySelectorAll('.year');
          var selected = false;
          if (dropdowns && dropdowns.length) {
            for (var i = 0; i < dropdowns.length; i++) {
              if (dropdownIdx !== i && dropdowns[i].value && dropdowns[i].value.value) {
                if (dropdowns[i].value.value === year) {
                  // already selected sector
                  selected = true;
                  break;
                }
              }
            }
          }
          return selected;
        },

        /**
         * Validate last added planned budget and if is not empty add a new one
         */
        _addNewPlannedBudget: function() {
          this._addElement();
        },

        // validate fields
        validate: function() {
          var valid = true;
          if (this.dataItems.length > 0) {
            var currency = this.$.currency;
            if (!currency.validate()) {
              valid = false;
            }
            this.dataItems.forEach(function(item, index) {
              var yearEl = this.$$('#year_' + index);
              if (!yearEl.validate()) {
                  valid = false;
              }
            }.bind(this));
          }
          return valid;
        },

        // reset validation errors
        resetValidations: function() {
          this.$.currency.invalid = false;
          if (this.dataItems.length > 0) {
            this.dataItems.forEach(function(item, index) {
              var yearEl = this.$$('#year_' + index);
              if (yearEl) {
                  yearEl.set('invalid', false);
              }
            }.bind(this));
          }
        },

        _editModeChanged: function(newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        }

      });
    })();
  </script>
</dom-module>
