<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../common-elements/etools-single-file.html">
<link rel="import" href="../common-elements/etools-date-input.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="intervention-amendments.html">
<link rel="import" href="intervention-fund-reservations.html">

<dom-module id="intervention-review-and-sign">

  <template>

    <style include="page-layout-styles grid-layout-styles shared-styles file-styles">
      :host {
        @apply(--layout-vertical);
        width: 100%;
      }
      paper-input {
        width: 100%;
      }
    </style>

    <etools-content-panel class="content-section" title="Signatures & Dates">
      <div class="row-h flex-c">
        <div class="col col-3">
          <!-- Document Start Date -->
          <etools-date-input id="submissionDateField"
                             label="Document Submission Date"
                             value="{{intervention.submission_date}}"
                             readonly$="[[!signEditMode]]"
                             no-init show-clear-btn>
          </etools-date-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-3">
          <!-- Submission Date to PRC -->
          <etools-date-input id="submissionDatePrcField"
                             label="Submission Date to PRC"
                             value="{{intervention.submission_date_prc}}"
                             readonly$="[[!signEditMode]]"
                             no-init show-clear-btn>
          </etools-date-input>
        </div>
        <div class="col col-3">
          <!-- Review Date by PRC -->
          <etools-date-input id="reviewDatePrcField"
                             label="Review Date by PRC"
                             value="{{intervention.review_date_prc}}"
                             readonly$="[[!signEditMode]]"
                             no-init show-clear-btn>
          </etools-date-input>
        </div>
        <div class="col col-6 file-container space-left">
          <!-- PRC Review Document -->
          <etools-single-file label="PRC Review Document"
                              internal-file=[[intervention.prc_review_document_file]]
                              file={{intervention.prc_review_document}}
                              accept=".doc,.docx,.pdf,.jpg,.png"
                              readonly$="[[!signEditMode]]"></etools-single-file>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <!-- Signed By Partner Authorized Officer -->
          <etools-searchable-multiselection-menu id="signedByAuthorizedOfficer"
             label="Signed By Partner Authorized Officer"
             placeholder="&#8212;"
             options="[[agreementAuthorizedOfficers]]"
             selected="{{intervention.partner_authorized_officer_signatory}}"
             update-selected
             dynamic-align
             readonly$="[[!signEditMode]]">
          </etools-searchable-multiselection-menu>
        </div>
        <div class="col col-3">
          <!-- Signed by Partner Date -->
          <etools-date-input id="signedByPartnerDateField"
                             label="Signed by Partner Date"
                             value="{{intervention.signed_by_partner_date}}"
                             readonly$="[[!signEditMode]]"
                             no-init show-clear-btn>
          </etools-date-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <!-- Signed by UNICEF -->
          <etools-searchable-multiselection-menu id="signedByUnicef"
             label="Signed by UNICEF"
             placeholder="&#8212;"
             options="[[signedByUnicefUsers]]"
             selected="{{intervention.unicef_signatory}}"
             update-selected
             dynamic-align
             readonly$="[[!signEditMode]]">
          </etools-searchable-multiselection-menu>
        </div>
        <div class="col col-3">
          <!-- Signed by UNICEF Date -->
          <etools-date-input id="signedByUnicefDateField"
                             label="Signed by UNICEF Date"
                             value="{{intervention.signed_by_unicef_date}}"
                             readonly$="[[!signEditMode]]"
                             no-init show-clear-btn>
          </etools-date-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-3">
          <paper-input label="Days from Submission to Signed"
                       value="[[getDaysFromSubmissionToSign(intervention.submission_date, intervention.signed_by_partner_date, intervention.signed_by_unicef_date)]]"
                       placeholder="&#8212;" readonly></paper-input>
        </div>
        <div class="col col-3">
          <paper-input label="Days from Review to Signed"
                       value="[[getDaysFromSubmissionToSign(intervention.review_date_prc, intervention.signed_by_partner_date, intervention.signed_by_unicef_date)]]"
                       placeholder="&#8212;" readonly></paper-input>
        </div>
      </div>
    </etools-content-panel>

    <template is="dom-if" if="[[_isNotDraft(intervention.status)]]">
      <etools-content-panel class="content-section" title="Amendments">
        <intervention-amendments id="intervAmendments"
                                 data-items="{{intervention.amendments}}"
                                 edit-mode$="[[signEditMode]]"></intervention-amendments>
      </etools-content-panel>
    </template>

    <etools-content-panel class="content-section" title="Fund Reservations">
      <intervention-fund-reservations data-items="{{intervention.fr_numbers}}"
                                      fr-numbers-details="[[intervention.fr_numbers_details]]"
                                      edit-mode$="[[signEditMode]]"></intervention-fund-reservations>
    </etools-content-panel>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-review-and-sign',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior
        ],

        properties: {
          intervention: {
            type: Object,
            observer: '_interventionChanged'
          },
          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          signedByUnicefUsers: {
            type: Array,
            statePath: 'signedByUnicefUsers'
          },
          agreement: {
            type: Object,
            value: null,
            observer: '_agreementChanged'
          },
          agreementAuthorizedOfficers: {
            type: Array,
            value: []
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          },
          allowEditRegardlessStatus: {
            type: Boolean,
            value: false
          },
          signEditMode: {
            type: Boolean,
            value: false
          },
          newIntervention: {
            type: Boolean
          }
        },

        _editModeChanged: function(newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        },

        _interventionChanged: function(intervention) {
          // ensure loading msg close
          this._setNewEditMode();
          this.fire('global-loading', {active: false});
        },
        _setNewEditMode: function() {
          if (!this.editMode) {
            this.set('signEditMode', this.editMode);
            return;
          }

          if (this.permissions.partnershipManager) {
            // TODO: revise this temporary permission
            // temporary edit permission for PM regardless status
            this.set('signEditMode', true);
            return;
          }

          if (!(this.permissions.partnershipManager || this.permissions.PME) &&
                (!this.intervention.status || this.intervention.status !== 'draft')) {
            this.set('signEditMode', false);
          } else {
            this.set('signEditMode', true);
          }
          this.updateStyles();
        },

        _agreementChanged: function(agreement) {
          if (agreement && typeof agreement === 'object' && Object.keys(agreement).length > 0) {
            var authorizedOfficerData = agreement.authorized_officers.map(function(officer) {
              return {
                value: parseInt(officer.id, 10),
                label: officer.first_name + ' ' + officer.last_name
              };
            });
            this.set('agreementAuthorizedOfficers', authorizedOfficerData);
          }
          this.fire('global-loading', {active: false});
        },

        getDaysFromSubmissionToSign: function(dateStr, signedByPartnerDateStr, signedByUnicefDateStr) {
          if (typeof dateStr === 'string' && dateStr !== '' &&
              (typeof signedByPartnerDateStr === 'string' && signedByPartnerDateStr !== '' ||
              typeof signedByUnicefDateStr === 'string' && signedByUnicefDateStr !== '')) {

            var maxSignedDateStr = this.getMaxDateStr(signedByPartnerDateStr, signedByUnicefDateStr);
            if (maxSignedDateStr !== null && new Date(dateStr).toString() !== 'Invalid Date') {
              return this.dateDiff(dateStr, maxSignedDateStr);
            }
          }
          return null;
        },

        _setSignedByUnicef: function(unicefUserId, unicefUsersLength) {
          if (unicefUserId && unicefUsersLength) {
            return this.unicefUsersData.filter(function(user) {
              return user.value === parseInt(unicefUserId, 10);
            });
          }
          return [];
        },

        _isNotDraft: function(status) {
          return status !== 'draft';
        },

        validate: function() {
          var amendments = this.$$('#intervAmendments');
          if (amendments) {
            return amendments.validate();
          }
          return true;
        }

      });

    })();
  </script>

</dom-module>
