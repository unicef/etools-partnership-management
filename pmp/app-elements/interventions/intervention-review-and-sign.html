<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="intervention-amendments.html">
<link rel="import" href="intervention-fund-reservations.html">

<dom-module id="intervention-review-and-sign">

  <template>

    <style include="page-layout-styles grid-layout-styles shared-styles file-styles">
      :host {
        @apply(--layout-vertical);
        width: 100%;
      }
      paper-input {
        width: 100%;
      }
    </style>

    <etools-content-panel class="content-section" title="Signatures & Dates">
      <div class="row-h flex-c">
        <div class="col col-3">
          <!-- Document Start Date -->
          <paper-input id="submissionDateField"
                       label="Document Submission Date"
                       value="[[prettyDate(intervention.submission_date)]]"
                       on-down="openDatePicker"
                       data-selector="submissionDate"
                       placeholder="&#8212;">
            <etools-datepicker-button prefix
                                      id="submissionDate"
                                      date="[[prepareDate(intervention.submission_date)]]"
                                      format="YYYY-MM-DD"
                                      pretty-date="{{intervention.submission_date}}"
                                      no-init show-clear-btn></etools-datepicker-button>
          </paper-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-3">
          <!-- Submission Date to PRC -->
          <paper-input id="submissionDatePrcField"
                       label="Submission Date to PRC"
                       value="[[prettyDate(intervention.submission_date_prc)]]"
                       on-down="openDatePicker"
                       data-selector="submissionDatePrc"
                       placeholder="&#8212;">
            <etools-datepicker-button prefix
                                      id="submissionDatePrc"
                                      date="[[prepareDate(intervention.submission_date_prc)]]"
                                      format="YYYY-MM-DD"
                                      pretty-date="{{intervention.submission_date_prc}}"
                                      no-init show-clear-btn></etools-datepicker-button>
          </paper-input>
        </div>
        <div class="col col-3">
          <!-- Review Date by PRC -->
          <paper-input id="reviewDatePrcField"
                       label="Review Date by PRC"
                       value="[[prettyDate(intervention.review_date_prc)]]"
                       on-down="openDatePicker"
                       data-selector="reviewDatePrc"
                       placeholder="&#8212;">
            <etools-datepicker-button prefix
                                      id="reviewDatePrc"
                                      date="[[prepareDate(intervention.review_date_prc)]]"
                                      format="YYYY-MM-DD"
                                      pretty-date="{{intervention.review_date_prc}}"
                                      no-init show-clear-btn></etools-datepicker-button>
          </paper-input>
        </div>
        <div class="col col-6 file-container space-left">
          <!-- PRC Review Document -->
          <etools-file label="PRC Review Document"
                       accept=".doc,.docx,.pdf,.jpg,.png"></etools-file>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <!-- Signed By Partner Authorized Officer -->
          <etools-searchable-multiselection-menu id="signedByAuthorizedOfficer"
             label="Signed By Partner Authorized Officer"
             placeholder="&#8212;"
             value="[[_setSignedByAuthOfficer(intervention.partner_authorized_officer_signatory, agreementAuthorizedOfficers.length)]]"
             options="[[agreementAuthorizedOfficers]]"
             on-value-change="_signedByAuthOfficerSelected">
          </etools-searchable-multiselection-menu>
        </div>
        <div class="col col-3">
          <!-- Signed by Partner Date -->
          <paper-input id="signedByPartnerDateField"
                       label="Signed by Partner Date"
                       value="[[prettyDate(intervention.signed_by_partner_date)]]"
                       on-down="openDatePicker"
                       data-selector="signedByPartnerDate"
                       placeholder="&#8212;">
            <etools-datepicker-button prefix
                                      id="signedByPartnerDate"
                                      date="[[prepareDate(intervention.signed_by_partner_date)]]"
                                      format="YYYY-MM-DD"
                                      pretty-date="{{intervention.signed_by_partner_date}}"
                                      no-init show-clear-btn></etools-datepicker-button>
          </paper-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <!-- Signed by UNICEF -->
          <etools-searchable-multiselection-menu id="signedByUnicef"
             label="Signed by UNICEF"
             placeholder="&#8212;"
             value="[[_setSignedByUnicef(intervention.unicef_signatory, unicefUsersData.length)]]"
             options="[[unicefUsersData]]"
             on-value-change="_signedByUnicefSelected">
          </etools-searchable-multiselection-menu>
        </div>
        <div class="col col-3">
          <!-- Signed by UNICEF Date -->
          <paper-input id="signedByUnicefDateField"
                       label="Signed by UNICEF Date"
                       value="[[prettyDate(intervention.signed_by_unicef_date)]]"
                       on-down="openDatePicker"
                       data-selector="signedByUnicefDate"
                       placeholder="&#8212;">
            <etools-datepicker-button prefix
                                      id="signedByUnicefDate"
                                      date="[[prepareDate(intervention.signed_by_unicef_date)]]"
                                      format="YYYY-MM-DD"
                                      pretty-date="{{intervention.signed_by_unicef_date}}"
                                      no-init show-clear-btn></etools-datepicker-button>
          </paper-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-3">
          <paper-input label="Days from Submission to Signed"
                       value="[[getDaysFromSubmissionToSign(intervention.submission_date, intervention.signed_by_partner_date, intervention.signed_by_unicef_date)]]"
                       placeholder="&#8212;" readonly></paper-input>
        </div>
        <div class="col col-3">
          <paper-input label="Days from Review to Signed"
                       value="[[getDaysFromSubmissionToSign(intervention.review_date_prc, intervention.signed_by_partner_date, intervention.signed_by_unicef_date)]]"
                       placeholder="&#8212;" readonly></paper-input>
        </div>
      </div>
    </etools-content-panel>

    <template is="dom-if" if="[[_isNotDraft(intervention.status)]]">
      <etools-content-panel class="content-section" title="Amendments">
        <intervention-amendments data-items="{{intervention.amendments}}"
                                 edit-mode$="[[editMode]]"></intervention-amendments>
      </etools-content-panel>
    </template>

    <etools-content-panel class="content-section" title="Fund Reservetions">
      <intervention-fund-reservations data-items="{{intervention.fr_numbers}}"
                                      fr-numbers-details="[[intervention.fr_numbers_details]]"
                                      edit-mode$="[[editMode]]"></intervention-fund-reservations>
    </etools-content-panel>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-review-and-sign',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior
        ],

        properties: {
          intervention: {
            type: Object,
            observer: '_interventionChanged'
          },
          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          agreement: {
            type: Object,
            value: null,
            observer: '_agreementChanged'
          },
          agreementAuthorizedOfficers: {
            type: Array,
            value: []
          },
          editMode: {
            type: Boolean,
            value: false
          }
        },

        _interventionChanged: function(intervention) {
          // ensure loading msg close
          this.fire('global-loading', {active: false});
        },

        _agreementChanged: function(agreement) {
          if (agreement && typeof agreement === 'object' && Object.keys(agreement).length > 0) {
            var authorizedOfficerData = agreement.authorized_officers.map(function(officer) {
              return {
                value: parseInt(officer.id, 10),
                label: officer.first_name + ' ' + officer.last_name
              };
            });
            this.set('agreementAuthorizedOfficers', authorizedOfficerData);
          }
          this.fire('global-loading', {active: false});
        },

        getDaysFromSubmissionToSign: function(dateStr, signedByPartnerDateStr, signedByUnicefDateStr) {
          if (typeof dateStr === 'string' && dateStr !== '' &&
              (typeof signedByPartnerDateStr === 'string' && signedByPartnerDateStr !== '' ||
              typeof signedByUnicefDateStr === 'string' && signedByUnicefDateStr !== '')) {

            var maxSignedDateStr = this.getMaxDateStr(signedByPartnerDateStr, signedByUnicefDateStr);
            if (maxSignedDateStr !== null && new Date(dateStr).toString() !== 'Invalid Date') {
              return this.dateDiff(dateStr, maxSignedDateStr);
            }
          }
          return null;
        },

        _signedByUnicefSelected: function(event) {
          var optionSelected = event.detail.selectedValues;
          if (optionSelected.value) {
            this.set('intervention.unicef_signatory', parseInt(optionSelected.value, 10));
          }
        },

        _setSignedByUnicef: function(unicefUserId, unicefUsersLength) {
          if (unicefUserId && unicefUsersLength) {
            return this.unicefUsersData.filter(function(user) {
              return user.value === parseInt(unicefUserId, 10);
            });
          }
          return [];
        },

        _signedByAuthOfficerSelected: function(event) {
          var optionSelected = event.detail.selectedValues;
          if (optionSelected.value) {
            this.set('intervention.partner_authorized_officer_signatory', parseInt(optionSelected.value, 10));
          }
        },

        _setSignedByAuthOfficer: function(officerId, officersLength) {
          if (officerId && officersLength) {
            return this.agreementAuthorizedOfficers.filter(function(o) {
              return o.value === parseInt(officerId, 10);
            });
          }
          return [];
        },

        _isNotDraft: function(status) {
          return status !== 'draft';
        }

      });

    })();
  </script>

</dom-module>
