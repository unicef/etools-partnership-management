<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<link rel="import" href="../agreements/agreement-data/agreement-item-data.html">
<link rel="import" href="intervention-status.html">

<dom-module id="intervention-review-and-sign">

  <template>

    <style include="page-layout-styles grid-layout-styles shared-styles file-styles">
      :host {
        @apply(--layout-horizontal);
        width: 100%;
      }
      paper-input {
        width: 100%;
      }
    </style>

    <agreement-item-data id="agreement"
                         agreement-id="[[intervention.agreement]]"
                         agreement="{{interventionAgreement}}"></agreement-item-data>

    <!-- main page content start -->
    <div id="pageContent">
      <etools-content-panel class="content-section" title="Signatures & Dates">
        <div class="row-h flex-c">
          <div class="col col-3">
            <!-- Document Start Date -->
            <paper-input id="submissionDateField"
                         label="Document Submission Date"
                         value="[[prettyDate(intervention.submission_date)]]"
                         on-down="openDatePicker"
                         data-selector="submissionDate"
                         placeholder="&#8212;">
              <etools-datepicker-button prefix
                                        id="submissionDate"
                                        date="[[prepareDate(intervention.submission_date)]]"
                                        format="YYYY-MM-DD"
                                        pretty-date="{{intervention.submission_date}}"
                                        no-init show-clear-btn></etools-datepicker-button>
            </paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-3">
            <!-- Submission Date to PRC -->
            <paper-input id="submissionDatePrcField"
                         label="Submission Date to PRC"
                         value="[[prettyDate(intervention.submission_date_prc)]]"
                         on-down="openDatePicker"
                         data-selector="submissionDatePrc"
                         placeholder="&#8212;">
              <etools-datepicker-button prefix
                                        id="submissionDatePrc"
                                        date="[[prepareDate(intervention.submission_date_prc)]]"
                                        format="YYYY-MM-DD"
                                        pretty-date="{{intervention.submission_date_prc}}"
                                        no-init show-clear-btn></etools-datepicker-button>
            </paper-input>
          </div>
          <div class="col col-3">
            <!-- Review Date by PRC -->
            <paper-input id="reviewDatePrcField"
                         label="Review Date by PRC"
                         value="[[prettyDate(intervention.review_date_prc)]]"
                         on-down="openDatePicker"
                         data-selector="reviewDatePrc"
                         placeholder="&#8212;">
              <etools-datepicker-button prefix
                                        id="reviewDatePrc"
                                        date="[[prepareDate(intervention.review_date_prc)]]"
                                        format="YYYY-MM-DD"
                                        pretty-date="{{intervention.review_date_prc}}"
                                        no-init show-clear-btn></etools-datepicker-button>
            </paper-input>
          </div>
          <div class="col col-6 file-container space-left">
            <!-- PRC Review Document -->
            <etools-file label="PRC Review Document"
                         accept=".doc,.docx,.pdf,.jpg,.png"></etools-file>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed By Partner Authorized Officer -->
            <etools-searchable-multiselection-menu id="signedByAuthorizedOfficer"
               label="Signed By Partner Authorized Officer"
               placeholder="&#8212;"
               value="[[_setSignedByAuthOfficer(intervention.partner_authorized_officer_signatory, agreementAuthorizedOfficers.length)]]"
               options="[[agreementAuthorizedOfficers]]"
               on-value-change="_signedByAuthOfficerSelected">
            </etools-searchable-multiselection-menu>
          </div>
          <div class="col col-3">
            <!-- Signed by Partner Date -->
            <paper-input id="signedByPartnerDateField"
                         label="Signed by Partner Date"
                         value="[[prettyDate(intervention.signed_by_partner_date)]]"
                         on-down="openDatePicker"
                         data-selector="signedByPartnerDate"
                         placeholder="&#8212;">
              <etools-datepicker-button prefix
                                        id="signedByPartnerDate"
                                        date="[[prepareDate(intervention.signed_by_partner_date)]]"
                                        format="YYYY-MM-DD"
                                        pretty-date="{{intervention.signed_by_partner_date}}"
                                        no-init show-clear-btn></etools-datepicker-button>
            </paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed by UNICEF -->
            <etools-searchable-multiselection-menu id="signedByUnicef"
               label="Signed by UNICEF"
               placeholder="&#8212;"
               value="[[_setSignedByUnicef(intervention.unicef_signatory, unicefUsersData.length)]]"
               options="[[unicefUsersData]]"
               on-value-change="_signedByUnicefSelected">
            </etools-searchable-multiselection-menu>
          </div>
          <div class="col col-3">
            <!-- Signed by UNICEF Date -->
            <paper-input id="signedByUnicefDateField"
                         label="Signed by UNICEF Date"
                         value="[[prettyDate(intervention.signed_by_unicef_date)]]"
                         on-down="openDatePicker"
                         data-selector="signedByUnicefDate"
                         placeholder="&#8212;">
              <etools-datepicker-button prefix
                                        id="signedByUnicefDate"
                                        date="[[prepareDate(intervention.signed_by_unicef_date)]]"
                                        format="YYYY-MM-DD"
                                        pretty-date="{{intervention.signed_by_unicef_date}}"
                                        no-init show-clear-btn></etools-datepicker-button>
            </paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-3">
            <paper-input label="Days From Submission to Signed"
                         value="[[getDatesDiff(intervention.submission_date, intervention.signed_by_partner_date)]]"
                         placeholder="&#8212;" readonly></paper-input>
          </div>
          <div class="col col-3">
            <paper-input label="Days From Submission to Signed"
                         value="[[getDatesDiff(intervention.review_date_prc, intervention.signed_by_partner_date)]]"
                         placeholder="&#8212;" readonly></paper-input>
          </div>
        </div>
      </etools-content-panel>

      <etools-content-panel class="content-section" title="Amendments">
        Amendments will go here...
      </etools-content-panel>

      <etools-content-panel class="content-section" title="Found Reservetions">
        Fround reservation will go here...
      </etools-content-panel>

    </div> <!-- main page content end -->

    <!-- sidebar content start -->
    <div id="sidebar">
      <intervention-status status="[[intervention.status]]"
                           on-save-intervention="_validateAndSaveSignedData"
                           show-save-btn$="[[editMode]]"></intervention-status>
    </div>
    <!-- sidebar content end -->


  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-review-and-sign',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior
        ],

        properties: {
          intervention: {
            type: Object,
            observer: '_interventionChanged'
          },
          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          interventionAgreement: {
            type: Object,
            value: null,
            observer: '_interventionAgreementChanged'
          },
          agreementAuthorizedOfficers: {
            type: Array,
            value: []
          }

        },

        _interventionChanged: function(intervention) {
          // console.log('intervention, review&sign', intervention);

          // ensure loading msg close
          this.fire('global-loading', {active: false});
        },

        _interventionAgreementChanged: function(agreement) {
          if (agreement && typeof agreement === 'object' && Object.keys(agreement).length > 0) {
            var authorizedOfficerData = agreement.authorized_officers.map(function(officer) {
              return {
                value: parseInt(officer.id, 10),
                label: officer.first_name + ' ' + officer.last_name
              };
            });
            this.set('agreementAuthorizedOfficers', authorizedOfficerData);
          }
        },

        _validateAndSaveSignedData: function(event) {
          event.stopImmediatePropagation();
          if (!this.editMode) {
            return;
          }

          var signedAndReviewData = {
            id: this.intervention.id,
            submission_date: this.intervention.submission_date,
            submission_date_prc: this.intervention.submission_date_prc,
            review_date_prc: this.intervention.review_date_prc,
            prc_review_document: this.intervention.prc_review_document,
            signed_by_partner_date: this.intervention.signed_by_partner_date,
            signed_by_unicef_date: this.intervention.signed_by_unicef_date,
            partner_authorized_officer_signatory: this.intervention.partner_authorized_officer_signatory,
            unicef_signatory: this.intervention.unicef_signatory
          };

          this.fire('save-intervention', signedAndReviewData);
        },

        getDatesDiff: function(date1, date2) {
          // TODO: this should calculate diff drom date2 and date1, move it in date-behavior
        },

        _signedByUnicefSelected: function(event) {
          var optionSelected = event.detail.selectedValues;
          if (optionSelected.value) {
            this.set('intervention.unicef_signatory', parseInt(optionSelected.value, 10));
          }
        },

        _setSignedByUnicef: function(unicefUserId, unicefUsersLength) {
          if (unicefUserId && unicefUsersLength) {
            return this.unicefUsersData.filter(function(user) {
              return user.value === parseInt(unicefUserId, 10);
            });
          }
          return [];
        },

        _signedByAuthOfficerSelected: function(event) {
          var optionSelected = event.detail.selectedValues;
          if (optionSelected.value) {
            this.set('intervention.partner_authorized_officer_signatory', parseInt(optionSelected.value, 10));
          }
        },

        _setSignedByAuthOfficer: function(officerId, officersLength) {
          if (officerId && officersLength) {
            return this.agreementAuthorizedOfficers.filter(function(o) {
              return o.value === parseInt(officerId, 10);
            });
          }
          return [];
        }

      });

    })();
  </script>

</dom-module>
