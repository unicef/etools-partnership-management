<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="intervention-amendments">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles repeatable-data-sets-styles-v2 file-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        padding: 7px 0;

        --paper-fab-keyboard-focus-background: #8dc63f; /* TODO: replace with app-theme var */
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .action.delete[disabled] {
        visibility: hidden;
      }

    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class$="row-h item-actions-container [[_getLockedClass(index)]]" data-item-nr$="[[_getItemNr(index)]]">
            <div class="row-v actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled="[[!_canBeRemoved(index, editMode)]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="row-v flex-c item-content">
              <div class="row-h flex-c">
                <div class="col col-3">
                  <!-- Amendment Type -->
                  <etools-searchable-multiselection-menu id$="amendmentType_[[index]]"
                                                         label="Amendment Type"
                                                         placeholder="&#8212;"
                                                         options="[[amendmentTypes]]"
                                                         custom-object-options
                                                         value="[[_getAmendmentType(item.type, amendmentTypes.length)]]"
                                                         on-value-change="_esmmValueChanged"
                                                         data-path$="[[index]].type"
                                                         required="[[_amendmentTypeRequired(item.signed_date, item.signed_amendment_file.length)]]"
                                                         auto-validate
                                                         error-message="Type is required"
                                                         readonly="[[!_canBeRemoved(index, editMode)]]">
                  </etools-searchable-multiselection-menu>
                </div>
                <div class="col col-3">
                  <!-- Signed Date -->
                  <paper-input id$="signedDate_[[index]]"
                               label="Signed Date"
                               value="[[prettyDate(item.signed_date)]]"
                               placeholder="&#8212;"
                               on-down="openDatePicker"
                               data-selector$="datePicker[[index]]"
                               required="[[_requireSignedDate(item.signed_amendment_file.length, item.type)]]"
                               auto-validate
                               error-message="Please select signed date"
                               readonly$="[[!_canBeRemoved(index, editMode)]]">
                    <template is="dom-if" if="[[!_canBeRemoved(index, editMode)]]">
                      <iron-icon prefix icon="date-range"></iron-icon>
                    </template>
                    <template is="dom-if" if="[[_canBeRemoved(index, editMode)]]">
                      <etools-datepicker-button prefix
                                                id$="datePicker[[index]]"
                                                json-date="{{item.signed_date}}"
                                                no-init show-clear-btn>
                      </etools-datepicker-button>
                    </template>
                  </paper-input>
                </div>
                <div class="col col-6 file-container space-left">
                  <!-- Signed Agreement -->
                  <etools-file id$="signedAgreement_[[index]]"
                               label="Signed Agreement"
                               files="{{item.signed_amendment_file}}"
                               accept=".doc,.docx,.pdf,.jpg,.png"
                               error-message="Attachment required"
                               readonly="[[!_canBeRemoved(index, editMode)]]"></etools-file>
                </div>
              </div>

          </div>

        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no amendments added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewAmendment"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-amendments',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.DateBehavior
        ],

        properties: {
          amendmentTypes: {
            type: Array,
            statePath: 'interventionAmendmentTypes'
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          }
        },

        observers: ['_dataHasChanged(dataItems)', '_dataItemsPropertyChange(dataItems.*)'],

        ready: function() {
          this.dataSetModel = {
            id: null,
            type: null,
            signed_date: null,
            signed_amendment: null,
            signed_amendment_file: [],
            amendment_number: null
          };
        },

        _editModeChanged: function(newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        },

        _dataHasChanged: function(dataItems) {
          // prepare data attachments
          if (Array.isArray(dataItems) && dataItems.length > 0) {
            dataItems.forEach(function(item, index) {
              if ((typeof item.signed_amendment === 'string' && item.signed_amendment !== '')
                  && (!Array.isArray(item.signed_amendment_file) || (Array.isArray(item.signed_amendment_file)
                  && item.signed_amendment_file.length === 0))) {
                this.set('dataItems.' + index + '.signed_amendment_file', [{
                  id: 'signed_amendment_file' + index,
                  file_name: item.signed_amendment.substr(item.signed_amendment.lastIndexOf('/') + 1),
                  path: item.signed_amendment
                }]);
              }
            }.bind(this));
          }
        },

        // observe amendments property changes and validate
        _dataItemsPropertyChange: function(data) {
          if (data.path.indexOf('dataItems.#') > -1) {
            var path = data.path.replace('dataItems.#', '');
            var index = parseInt(path.substring(0, path.indexOf('.')), 10);
            if (!isNaN(index)) {
              if (!this._canBeRemoved(index)) {
                return;
              }
              this._validateAmendment(index);
            }
          }
        },

        _validateAmendment: function(index) {
          var valid = true;
          var amendment = this.dataItems[index];
          if (amendment) {
            var typeEl = this.$$('#amendmentType_' + index);
            if (typeEl && !typeEl.validate()) {
              valid = false;
            }
            var signedDateEl = this.$$('#signedDate_' + index);
            if (signedDateEl && !signedDateEl.validate()) {
              valid = false;
            }
            var attachmentEl = this.$$('#signedAgreement_' + index);
            if (attachmentEl) {
              if (this._requireAttachment(attachmentEl.files.length, amendment.signed_date, amendment.type)) {
                valid = false;
                attachmentEl.invalid = true;
              } else {
                attachmentEl.invalid = false;
              }
            }
          }
          return valid;
        },

        /**
         * The amendment can be removed only if it doesn't have and id assigned(only if is not saved)
         */
        _canBeRemoved: function(index, editMode) {
          if (!editMode) {
            return false;
          }
          var amendment = this.dataItems[index];
          var amendmentId = parseInt(amendment.id, 10);
          if (amendment && isNaN(amendmentId) === false && amendmentId > 0) {
            // amendment already saved (has an id assigned)
            return false;
          }
          return true;
        },

        // get amendment type object
        _getAmendmentType: function(type, amendmentTypesLength) {
          if (amendmentTypesLength) {
            return this.amendmentTypes.filter(function(t) {
              return t.value === type;
            });
          }
          return null;
        },

        // get amendment type selected and update dateItems
        _esmmValueChanged: function(event) {
          event.stopImmediatePropagation();
          var esmmField = Polymer.dom(event).localTarget;
          var dataPath = esmmField.getAttribute('data-path');
          var optionSelected = event.detail.selectedValues;
          var pathValue = null;
          if (optionSelected !== null && typeof optionSelected === 'object' &&
              optionSelected.hasOwnProperty('value')) {
            pathValue = optionSelected.value;
          }
          this.set('dataItems.' + dataPath, pathValue);
        },

        _amendmentTypeRequired: function(signedDate, signedAmendmentLength) {
          if (signedDate || signedAmendmentLength) {
            return true;
          }
          return false;
        },

        _requireAttachment: function(fileLength, date, type) {
          if (fileLength === 0 && (date || type)) {
            return true;
          }
          return false;
        },

        /**
         * If the amendment can be removed, the left border and top badge needs to have a different style.
         * This class will help with that.
         */
        _getLockedClass: function(index) {
          if (!this._canBeRemoved(index)) {
            return 'locked';
          }
          return '';
        },

        _getItemNr: function(index) {
          return parseInt(index, 10) + 1;
        },

        /**
         * Check if amendment fields are empty
         */
        _amendmentFieldsAreEmpty: function(amendmentItem, index) {
          return (amendmentItem.signed_date === null || amendmentItem.signed_date === '')
              && amendmentItem.signed_amendment_file.length === 0
              && !amendmentItem.type;
        },

        /**
         * Validate last added amendment and if is not empty add a new one
         */
        _addNewAmendment: function() {
          var lastAmendmentItemIndex = this.dataItems.length - 1;
          if (lastAmendmentItemIndex > 0 && this._canBeRemoved(lastAmendmentItemIndex)) {
            var lastAmendmentItem = this.dataItems[lastAmendmentItemIndex];
            if (this._amendmentFieldsAreEmpty(lastAmendmentItem, lastAmendmentItemIndex)) {
              this.fire('toast', {text: 'Last amendment fields are empty!', showCloseBtn: true});
            } else {
              this._addElement();
            }
          } else {
            this._addElement();
          }
        },

        /**
         * Check if amendment signed date is required
         */
        _requireSignedDate: function(signedAgreementFilesLength, type) {
          if (signedAgreementFilesLength > 0 || type) {
            return true;
          }
          return false;
        },

        // validate fields
        validate: function() {
          var valid = true;
          if (this.dataItems.length > 0) {
            this.dataItems.forEach(function(amendment, index) {
              if (!this._validateAmendment(index)) {
                valid = false;
              }
            }.bind(this));
          }
          return valid;
        },

        resetValidations: function() {
          if (this.dataItems.length > 0) {
            this.dataItems.forEach(function(amendment, index) {
              var typeEl = this.$$('#amendmentType_' + index);
              if (typeEl) {
                typeEl.invalid = false;
              }
              var signedDateEl = this.$$('#signedDate_' + index);
              if (signedDateEl) {
                signedDateEl.invalid = false;
              }
              var attachmentEl = this.$$('#signedAgreement_' + index);
              if (attachmentEl) {
                attachmentEl.invalid = false;
              }
            }.bind(this));
          }
        }

      });
    })();
  </script>
</dom-module>
