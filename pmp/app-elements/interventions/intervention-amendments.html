<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../common-elements/etools-single-file.html">

<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">
<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../validators/required-and-not-future-date-validator.html">

<dom-module id="intervention-amendments">
  <template strip-whitespace>
    <style
        include="grid-layout-styles repeatable-data-sets-styles repeatable-data-sets-styles-v2 file-styles shared-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;

        --paper-fab-keyboard-focus-background: var(--success-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .type-warning {
        color: var(--warning-color);
      }

      #amendments-wrapper {
        margin-top: 16px;
      }

      :host(:not([edit-mode])) #amendments-wrapper {
        margin-bottom: 24px;
      }

      paper-input#other {
        width: 100%;
      }

      #no-amend-warning {
        padding: 24px;
      }
    </style>
    <required-and-not-future-date-validator></required-and-not-future-date-validator>
    <div hidden$="[[_emptyList(dataItems.length)]]" id="amendments-wrapper">
      <template is="dom-repeat" id="amendmentsRepeater" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class$="item-actions-container [[_getLockedClass(item.id)]]"
               data-item-nr$="[[_getItemNr(index)]]">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"
                                 disabled$="[[_isReadonlyAmendment(item.id)]]"></paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h flex-c">
              <div class="col col-4">
                <!-- Amendment Type -->
                <template is="dom-if" if="[[_isReadonlyAmendment(item.id)]]">
                  <paper-input label="Amendment Types" value="[[_getReadonlyAmendmentTypes(item.types)]]"
                               readonly></paper-input>
                </template>
                <template is="dom-if" if="[[!_isReadonlyAmendment(item.id)]]">
                  <etools-multi-selection-menu id$="amendmentTypes_[[index]]"
                                               label="Amendment Types"
                                               placeholder="&#8212;"
                                               options="[[filteredAmendmentTypes]]"
                                               selected-values="{{item.types}}"
                                               dynamic-align
                                               required
                                               hide-search
                                               error-message="Type is required"
                                               readonly="[[_isReadonlyAmendment(item.id)]]"
                                               on-focused-changed="_onFocusChangedUpdateAutovalidate">
                  </etools-multi-selection-menu>
                </template>
              </div>
              <div class="col col-3">
                <!-- Signed Date -->
                <etools-date-input id$="signedDate_[[index]]"
                                   label="Signed date"
                                   value="{{item.signed_date}}"
                                   readonly$="[[_isReadonlyAmendment(item.id)]]"
                                   required
                                   validator="required-and-not-future-date-validator"
                                   error-message="Please select signed date"
                                   auto-validate="[[!_isReadonlyAmendment(item.id)]]"
                                   error-message$="[[_getSignedDateErrorMessage(item.signed_date)]]"
                                   no-init show-clear-btn>
                </etools-date-input>
              </div>
              <div class="col col-5 file-container">
                <!-- Signed Agreement -->
                <etools-single-file id="fileUpload_[[index]]"
                                    label="Signed Agreement"
                                    internal-file=[[item.signed_amendment_file]]
                                    file={{item.signed_amendment}}
                                    accept=".doc,.docx,.pdf,.jpg,.png"
                                    error-message="Attachment required"
                                    readonly="[[_isReadonlyAmendment(item.id)]]"
                                    required
                                    auto-validate></etools-single-file>
              </div>
            </div>
            <template is="dom-if" if="[[!_isReadonlyAmendment(item.id)]]">
              <div class="row-h flex-c" hidden$="[[!item.types]]">
                <span class="type-warning">
                  [[_getSelectedAmendmentTypeWarning(item.types, item.types.length)]]
                </span>
              </div>
            </template>
            <div class="row-h" hidden$="[[!_showOtherInput(item.types, item.types.length, index)]]">
              <paper-input id="other"
                           placeholder="&#8212;"
                           label="Other"
                           value="{{item.other_description}}"
                           readonly$="[[_isReadonlyAmendment(item.id)]]">
              </paper-input>
            </div>
          </div>

        </div>
      </template>
    </div>

    <div id="no-amend-warning" class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      There are no amendments added.
    </div>
    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewAmendment"
                 title="Add"></paper-fab>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-amendments',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.RepeatableDataSetsBehavior,
          etoolsBehaviors.DynamicDialogBehavior,
          pmpBehaviors.DateBehavior,
          pmpBehaviors.DropdownBehavior
        ],

        properties: {
          amendmentTypes: {
            type: Object,
            statePath: 'interventionAmendmentTypes'
          },
          filteredAmendmentTypes: Object,
          interventionDocumentType: {
            type: String
          },
          _amendActionInProgress: Boolean
        },

        observers: [
          '_dataHasChanged(dataItems)',
          '_dataItemsLengthChanged(dataItems.length)',
          '_filterAmendmentTypes(amendmentTypes, interventionDocumentType)'
        ],
        ready: function() {
          this.dataSetModel = {
            id: null,
            types: [],
            other_description: null,
            signed_date: null,
            signed_amendment: null,
            signed_amendment_file: '',
            amendment_number: null
          };
          this._createAmendmentConfirmationDialog();
        },
        _createAmendmentConfirmationDialog: function() {
          var dialog = document.createElement('p');
          dialog.setAttribute('id', 'addAmendmendConfirmation');
          dialog.innerHTML = 'All fields in the details tab will now be open for editing. ' +
              'Please change all necessary fields before hitting save.';
          this.addAmendmentConfirmationDialog = this.createDialog('Add Amendment Confirmation', 'md', 'OK', 'Cancel',
              this._addAmendmentConfirmationCallback.bind(this), dialog);
          // jscs:disable maximumLineLength
          this.addAmendmentConfirmationDialog.customStyle['--paper-dialog-scrollable'] = 'var(--pmp-paper-dialog-content)';
          // jscs:enable maximumLineLength
          this.addAmendmentConfirmationDialog.updateStyles();
        },
        _getSignedDateErrorMessage: function(signedDate) {
          return this.isFutureDate(signedDate)
              ? 'Signed Date can not be in the future'
              : 'Please select Signed Date';
        },
        _getReadonlyAmendmentTypes: function(types) {
          if (!types || !types.length) {
            return null;
          }
          let amdTypes = this.amendmentTypes.filter(function(t) {
            return types.indexOf(t.value) > -1;
          });
          if (amdTypes.length) {
            let amdTypesLabels = amdTypes.map(function(t) {
              return t.label;
            });
            return amdTypesLabels.join(' | ');
          }
          return null;
        },

        detached: function() {
          if (this.addAmendmentConfirmationDialog) {
            this.removeDialog(this.addAmendmentConfirmationDialog);
          }
        },
        _filterAmendmentTypes: function(amendmentTypes, interventionDocumentType) {
          if (interventionDocumentType === 'SSFA') {
            this.filteredAmendmentTypes = this.amendmentTypes.filter(function(item) {
              return ['Dates', 'Other'].indexOf(item.label) > -1;
            });
          } else {
            this.filteredAmendmentTypes = JSON.parse(JSON.stringify(this.amendmentTypes));
          }
        },
        _showOtherInput: function(selectedAmdTypes, selectedAmdTypesLength, index) {
          if (!selectedAmdTypes || !selectedAmdTypes.length) {
            return false;
          }
          if (selectedAmdTypes.indexOf('other') > -1) {
            return true;
          }
          this._clearOtherInput(index);
          return false;
        },
        _clearOtherInput: function(index) {
          var otherInput = this.$$('#other_' + index);
          if (otherInput) {
            otherInput.value = null;
          }
        },
        _showAddAmendmentConfirmationDialog: function() {
          if (this.addAmendmentConfirmationDialog) {
            this.addAmendmentConfirmationDialog.opened = true;
          }
        },
        _addAmendmentConfirmationCallback: function(event) {
          if (event.detail.confirmed) {
            this.set('_amendActionInProgress', true);
            this._addElement();
            this._unlockInterventionDetailsFields();
          }
        },
        _dataHasChanged: function(dataItems) {
          if (dataItems instanceof Array === false) {
            this.set('dataItems', []);
          }
          this.set('_amendActionInProgress', this._thereAreUnsavedAmendments());
        },
        _dataItemsLengthChanged: function() {
          if (this._amendActionInProgress && !this._thereAreUnsavedAmendments()) {
            // cancel adding amendment
            this._restoreInterventionOriginalDataAndPermissions();
          }
        },
        _unlockInterventionDetailsFields: function() {
          this.fire('unlock-details-fields');
        },
        _restoreInterventionOriginalDataAndPermissions: function() {
          this.set('_amendActionInProgress', false);
          this.fire('restore-original-permissions');
        },
        _validateAmendment: function(index) {
          var amendment = this.dataItems[index];
          if (!amendment || this._isReadonlyAmendment(amendment.id)) {
            //Avoid validation for existing readonly amendments
            return true;
          }
          var isValid1 = this._validateAmendmentTypes(index);
          var isValid2 = this._validateSignedDate(amendment, index);
          var isValid3 = this._validateFileUpload(amendment, index);

          return (isValid1 && isValid2 && isValid3);
        },
        _validateAmendmentTypes: function(index) {
          var valid = true;
          var typeEl = this.$$('#amendmentTypes_' + index);
          if (typeEl && !typeEl.validate()) {
            valid = false;
          }
          return valid;
        },
        _validateFileUpload: function(amendment, index) {
          var valid = true;
          var fileUplodEl = this.$$('#fileUpload_' + index);
          if (fileUplodEl) {
            valid = !!amendment.signed_amendment;
            fileUplodEl.invalid = !valid;
          }
          return valid;
        },
        _validateSignedDate: function(amendment, index) {
          var isValid = true;

          let signedDateEl = this.$$('#signedDate_' + index);
          if (signedDateEl) {
            signedDateEl.errorMessage = this._getSignedDateErrorMessage(amendment.signed_date);
            if (!signedDateEl.validate()) {
              isValid = false;
            }
          }
          return isValid;
        },

        /**
         * If the amendment readonly, the left border and top badge needs to have a different style.
         * This class will help with that.
         */
        _getLockedClass: function(id) {
          if (this._isReadonlyAmendment(id)) {
            return 'locked';
          }
          return '';
        },

        _getItemNr: function(index) {
          return parseInt(index, 10) + 1;
        },

        /**
         * Check if amendment fields are empty
         */
        _amendmentFieldsAreEmpty: function(amendment) {
          if (amendment.id) {
            return false;
          }
          return (this._amendmentTypeIsEmpty(amendment) ||
          this._signedDateIsEmpty(amendment) || this._newAttachmentIsEmpty(amendment));
        },
        _signedDateIsEmpty: function(amendment) {
          return amendment.signed_date === null || amendment.signed_date === '';
        },
        _newAttachmentIsEmpty: function(amendment) {
          return amendment.signed_amendment instanceof File === false;
        },
        _amendmentTypeIsEmpty: function(amendment) {
          return !amendment.types;
        },

        /**
         * Validate last added amendment and if is not empty add a new one
         */
        _addNewAmendment: function() {
          var lastAmendmIndex = this.dataItems.length - 1;

          if (lastAmendmIndex > -1) {
            let lastAmendm = this.dataItems[lastAmendmIndex];
            if (!lastAmendm.id && this._amendmentFieldsAreEmpty(lastAmendm)) {
              this.fire('toast', {text: 'Last amendment fields are empty!', showCloseBtn: true});
              return;
            }
          }
          if (this._thereAreUnsavedAmendments()) {
            // Avoid showing the dialog when adding amendments consecutively
            this._addElement();
          } else {
            this._showAddAmendmentConfirmationDialog();
          }

        },
        _thereAreUnsavedAmendments: function() {
          if (!this.dataItems && !this.dataItems.length) {
            return false;
          }
          if (this.dataItems.find(this._unsavedAmendment)) {
            return true;
          }
          return false;
        },
        _unsavedAmendment: function(amd) {
          return !!!amd.id;
        },
        // validate fields
        validate: function() {
          var valid = true;
          if (!this.dataItems.length) {
            return valid;
          }
          this.dataItems.forEach(function(amendment, index) {
            // validate only new(not saved yet) amendments
            if (!this._isReadonlyAmendment(amendment.id) && !this._validateAmendment(index)) {
              valid = false;
            }
          }.bind(this));
          return valid;
        },

        resetValidations: function() {
          if (!this.dataItems.length) {
            return;
          }
          this.dataItems.forEach(function(amendment, index) {
            if (!this._isReadonlyAmendment(amendment.id)) {
              this._resetAmendmentValidations(index);
            }
          }.bind(this));
        },

        _resetAmendmentValidations: function(index) {
          var typeEl = this.$$('#amendmentTypes_' + index);
          if (typeEl) {
            typeEl.invalid = false;
          }
          var signedDateEl = this.$$('#signedDate_' + index);
          if (signedDateEl) {
            signedDateEl.invalid = false;
          }
          var fileUpload = this.$$('#fileUpload_' + index);
          if (fileUpload) {
            fileUpload.invalid = false;
          }
        },

        _isReadonlyAmendment: function(amendmentId) {
          return !!amendmentId;
        },

        _getSelectedAmendmentTypeWarning: function(types) {//TODO
          if (!types || !types.length) {
            return;
          }
          var message = 'Please make sure you update ';
          types.forEach(function(amdType) {
            switch (amdType) {
              case 'dates':
                message += 'Dates, ';
                break;
              case 'results':
                message += 'Programme Results, ';
                break;
              case 'budget':
                message += 'Planned Budget, ';
                break;
              case 'other':
                message += 'Other, ';
                break;
            }
          });
          message = message.substring(0, message.length - 2);
          message += ' section' + (message.indexOf(',') > -1 ? 's' : '') + ' of this PD/SSFA';
          return message;
        }

      });
    })();
  </script>
</dom-module>
