<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../common-elements/etools-single-file.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="intervention-amendments">
  <template strip-whitespace>
    <style
        include="grid-layout-styles shared-styles repeatable-data-sets-styles repeatable-data-sets-styles-v2 file-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;

        --paper-fab-keyboard-focus-background: var(--success-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .type-warning {
        color: var(--warning-color);
      }

      #amendments-wrapper {
        margin-top: 15px;
      }
    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]" id="amendments-wrapper">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class$="item-actions-container [[_getLockedClass(item.id, editMode)]]"
               data-item-nr$="[[_getItemNr(index)]]">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h flex-c">
              <div class="col col-5">
                <!-- Amendment Type -->
                <etools-multi-selection-menu id$="amendmentTypes_[[index]]"
                                                       label="Amendment Types"
                                                       placeholder="&#8212;"
                                                       options="[[amendmentTypes]]"
                                                       selected-values="{{item.types}}"
                                                       dynamic-align
                                                       required
                                                       auto-validate
                                                       error-message="Type is required"
                                                       readonly="[[_isReadonlyAmendment(item.id, editMode)]]">
                </etools-multi-selection-menu>
              </div>
              <div class="col col-2">
                <!-- Signed Date -->
                <etools-date-input id$="signedDate_[[index]]"
                                   label="Signed date"
                                   value="{{item.signed_date}}"
                                   readonly$="[[_isReadonlyAmendment(item.id, editMode)]]"
                                   required
                                   error-message="Please select signed date"
                                   auto-validate
                                   no-init show-clear-btn>
                </etools-date-input>
              </div>
              <div class="col col-5 file-container">
                <!-- Signed Agreement -->
                <etools-single-file id="fileUpload_[[index]]"
                                    label="Signed Agreement"
                                    internal-file=[[item.signed_amendment_file]]
                                    file={{item.signed_amendment}}
                                    accept=".doc,.docx,.pdf,.jpg,.png"
                                    error-message="Attachment required"
                                    required
                                    readonly="[[_isReadonlyAmendment(item.id, editMode)]]"></etools-single-file>
              </div>
            </div>
            <template is="dom-if" if="[[!_isReadonlyAmendment(item.id, editMode)]]">
              <div class="row-h flex-c" hidden$="[[!item.type]]">
                <span class="type-warning">
                  [[_getSelectedAmendmentTypeWarning(item.type)]]
                </span>
              </div>
            </template>

          </div>

        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no amendments added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!_allowToAddAmendment(interventionStatus, editMode)]]">
      <paper-fab icon="add"
                 on-tap="_addNewAmendment"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-amendments',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.DateBehavior
        ],

        properties: {
          amendmentTypes: {
            type: Object,
            // value: function() {
            //   return [{label:'Dates', value:'1'},
            //     {label:'Results', value:'2'},
            //     {label:'Budget', value:'3'},
            //     {label:'Other', value:'4'}]
            // }
            statePath: 'interventionAmendmentTypes'
          },
          editMode: {
            type: Boolean,
            observer: '_editModeChanged'
          },
          interventionStatus: String
        },

        observers: ['_dataHasChanged(dataItems)', '_dataItemsPropertyChange(dataItems.*)'],

        ready: function() {
          this.dataSetModel = {
            id: null,
            types: undefined,
            signed_date: null,
            signed_amendment: null,
            signed_amendment_file: '',
            amendment_number: null
          };
        },
        //intervention-amendments is displayed only if intervention status is != than draft
        //so that check is not neccesary
      //  _isUploadFileReadonly: function(item) {
      //     if (!this.editMode) {
      //       return true;
      //     }
      //     if (!item || !item.id) {
      //       return false;
      //     }
      //     if (!item.signed_amendment_file) {
      //       return false;
      //     }
      //     return true;
      //   },
       _allowToAddAmendment: function(interventionStatus, editMode) {
         if (!editMode) {
           return false;
         }
         if (['active', 'signed'].indexOf(interventionStatus) === -1) {
           return false;
         }
         return true;
       },
       _editModeChanged: function(newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        },

        _dataHasChanged: function(dataItems) {
          if (dataItems instanceof Array === false) {
            this.set('dataItems', []);
          }
        },

        // observe amendments property changes and validate
        _dataItemsPropertyChange: function(data) {
          console.log('_dataItemsPropertyChange');

          if (data.path.indexOf('dataItems.#') === -1) {
            return;
          }
          var index = this._getIndex(data);
          if (isNaN(index)) {
            return;
          }

          var amendment = this.dataItems[index];
          if (this._isReadonlyAmendment(amendment.id, this.editMode)) {
            this._resetAmendmentValidations(index);
            return;
          }

          this._validateAmendment(index);
        },
        _getIndex: function(data) {
          var path = data.path.replace('dataItems.#', '');
          var index = parseInt(path.substring(0, path.indexOf('.')), 10);
          return index;
        },
        _validateAmendment: function(index) {
          var valid = true;
          var amendment = this.dataItems[index];
          if (!amendment) {
            return valid;
          }
          valid = this._validateAmendmentTypes(index);
          valid = this._validateSignedDate(amendment, index);
          valid = this._validateFileUpload(amendment, index);

          return valid;
        },
        _validateAmendmentTypes: function(index) {
          var valid = true;
          var typeEl = this.$$('#amendmentTypes_' + index);
          if (typeEl && !typeEl.validate()) {
            valid = false;
          }
          return valid;
        },
        _validateFileUpload: function(amendment, index) {
          var valid = !!amendment.signed_amendment;
          var fileUplodEl = this.$$('#fileUpload_' + index);
          fileUplodEl.invalid = !valid;
          return valid;
        },
        _validateSignedDate: function(amendment, index) {
          var valid = true;

          var signedDateEl = this.$$('#signedDate_' + index);
          if (!signedDateEl) {
            return valid;
          }
          if (!signedDateEl.validate()) {
            signedDateEl.errorMessage = "Please select signed date";
            valid = false;
          } else if (this.isFutureDate(amendment.signed_date)){
            console.log('is in the future');
            signedDateEl.errorMessage = "Signed date can not be in the future";
            valid = false;
          }
          signedDateEl.invalid = null;// *This is neccessary because sometimes it doesn't work without it
          signedDateEl.invalid = !valid;

          return valid;
        },

        /**
         * The amendment can be removed only if it doesn't have and id assigned(only if is not saved)
         */
        _canBeRemoved: function(index, editMode) {
          if (!editMode) {
            return false;
          }
          var amendment = this.dataItems[index];
          var amendmentId = parseInt(amendment.id, 10);
          if (amendment && isNaN(amendmentId) === false && amendmentId > 0) {
            // amendment already saved (has an id assigned)
            return false;
          }
          return true;
        },

        // _amendmentTypeRequired: function(signedDate, signedAmendment, signedAmendmentFilePath) {
        //   if (signedDate || signedAmendment instanceof File ||
        //       (typeof signedAmendmentFilePath === 'string' && signedAmendmentFilePath !== '')) {
        //     return true;
        //   }
        //   return false;
        // },

        /**
         * If the amendment readonly, the left border and top badge needs to have a different style.
         * This class will help with that.
         */
        _getLockedClass: function(id, editMode) {
          if (this._isReadonlyAmendment(id, editMode)) {
            return 'locked';
          }
          return '';
        },

        _getItemNr: function(index) {
          return parseInt(index, 10) + 1;
        },

        /**
         * Check if amendment fields are empty
         */
        _amendmentFieldsAreEmpty: function(amendment) {
          return (amendment.signed_date === null || amendment.signed_date === '') &&
              (amendment.signed_amendment_file === null ||
              (typeof amendment.signed_amendment_file === 'string' &&
              amendment.signed_amendment_file === '')) &&
              amendment.signed_amendment instanceof File === false && !amendment.type;
        },

        /**
         * Validate last added amendment and if is not empty add a new one
         */
        _addNewAmendment: function() {
          var lastAmendmIndex = this.dataItems.length - 1;

          if (lastAmendmIndex > -1) {
            var lastAmendmIndex = this.dataItems[lastAmendmIndex];
            if (!lastAmendmIndex.id && this._amendmentFieldsAreEmpty(lastAmendmIndex)) {
              this.fire('toast', {text: 'Last amendment fields are empty!', showCloseBtn: true});
              return;
            }
          }

          this._addElement();
        },

        // /**
        //  * Check if amendment signed date is required
        //  */
        // _requireSignedDate: function(signedAgreement, signedAgreementFilePath, type) {
        //   if ((typeof signedAgreementFilePath === 'string' && signedAgreementFilePath !== '') ||
        //       type || signedAgreement instanceof File) {
        //     return true;
        //   }
        //   return false;
        // },

        // validate fields
        validate: function() {
          var valid = true;
          if (!this.dataItems.length) {
            return valid;
          }
          this.dataItems.forEach(function(amendment, index) {
            if (!this._validateAmendment(index)) {
              valid = false;
            }
            if (this.dataItems.length - 1 === index) {
              // last amendment
              if (this._amendmentFieldsAreEmpty(amendment)) {
                valid = false;
              }
            }
          }.bind(this));
          return valid;
        },

        resetValidations: function() {
          if (!this.dataItems.length) {
            return;
          }
          this.dataItems.forEach(function(amendment, index) {
            this._resetAmendmentValidations(index);
          }.bind(this));

        },

        _resetAmendmentValidations: function(index) {
          var typeEl = this.$$('#amendmentTypes_' + index);
          if (typeEl) {
            typeEl.invalid = false;
          }
          var signedDateEl = this.$$('#signedDate_' + index);
          if (signedDateEl) {
            signedDateEl.invalid = false;
          }
          var fileUpload = this.$$('#fileUpload_' + index);
          if (fileUpload) {
            fileUpload.invalid = false;
          }
        },

        _isReadonlyAmendment: function(amendmentId, editMode) {
          if (!editMode) {
            return true;
          }
          if (parseInt(amendmentId, 10) > 0) {
            return true;
          }
          return false;
        },

        _getSelectedAmendmentTypeWarning: function(types) {
          if (!types || !types.length) {
            return;
          }
         var message = "Please ensure that you update ";
         types.forEach(function(amdType) {
           switch(amdType) {
             case '1':
               messages += "Dates, ";
               break;
             case '2':
               messages += "Programme Results, ";
               break;
             case '3':
               messages += "Planned Budget, ";
               break;
             case '4':
               messages += "Other, ";
               break;
           }
         });
          message = message.substring(0, message.length - 3);
          message += "section" + message.indexOf(',') > -1 ? "s" : "" + " of this PD/SSFA";

          // switch (type) {
          //   case 'cpr':
          //     return 'Please ensure that you update Programme Results section of this PD/SSFA.';
          //   case 'cpf':
          //     return 'Please ensure that you update the Population Focus field on this PD/SSFA.';
          //   case 'cgc':
          //     return 'Please ensure that you update the Locations field on this PD/SSFA.';
          //   case 'ctbgt20':
          //     return 'Please ensure that you update the Planned Budget section of this PD/SSFA; ' +
          //         'also ensure this PD/SSFA goes for PRC review and is approved by your Representative.';
          //   case 'ctblt20':
          //     return 'Please ensure that you update the Planned Budget section of this PD/SSFA; ' +
          //         'also ensure the amended PD/SSFA is signed.';
          //   case 'cablt20':
          //     return 'Please ensure that you update the Planned Budget section of this PD/SSFA.';
          //   case 'cabgt20':
          //     return 'Please ensure that you update the Planned Budget section of this PD/SSFA; ' +
          //         'also ensure to manage changes through the FACE form and document reasoning for change.';
          //   case 'cabgt20face':
          //     return 'Please ensure that you update the Planned Budget section of this PD/SSFA; also ensure ' +
          //         'to manage changes through the FACE form and document reasoning for change A Note for ' +
          //         'the Record is required for approval.';
          // }
        }

      });
    })();
  </script>
</dom-module>
