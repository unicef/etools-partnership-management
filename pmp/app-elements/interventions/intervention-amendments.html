<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">

<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../common-elements/etools-single-file.html">

<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="intervention-amendments">
  <template strip-whitespace>
    <style
        include="grid-layout-styles shared-styles repeatable-data-sets-styles repeatable-data-sets-styles-v2 file-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;

        --paper-fab-keyboard-focus-background: var(--success-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .type-warning {
        color: var(--warning-color);
      }

      #amendments-wrapper {
        margin-top: 15px;
      }
      paper-input#other {
        width: 100%;
      }
    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]" id="amendments-wrapper">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class$="item-actions-container [[_getLockedClass(item.id)]]"
               data-item-nr$="[[_getItemNr(index)]]">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"
                                 disabled$="[[_isReadonlyAmendment(item.id)]]"></paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h flex-c">
              <div class="col col-4">
                <!-- Amendment Type -->
                <template is="dom-if" if="[[_isReadonlyAmendment(item.id)]]">
                  [[_getReadonlyAmendmentTypes(item.types)]]
                </template>
                <template is="dom-if" if="[[!_isReadonlyAmendment(item.id)]]">
                  <etools-multi-selection-menu id$="amendmentTypes_[[index]]"
                                                       label="Amendment Types"
                                                       placeholder="&#8212;"
                                                       options="[[filteredAmendmentTypes]]"
                                                       selected-values="{{item.types}}"
                                                       dynamic-align
                                                       required
                                                       hide-search
                                                       auto-validate$="[[_autoValidateIsOn(item.types)]]"
                                                       error-message="Type is required"
                                                       readonly="[[_isReadonlyAmendment(item.id)]]">
                  </etools-multi-selection-menu>
                </template>
              </div>
              <div class="col col-3">
                <!-- Signed Date -->
                <etools-date-input id$="signedDate_[[index]]"
                                   label="Signed date"
                                   value="{{item.signed_date}}"
                                   readonly$="[[_isReadonlyAmendment(item.id)]]"
                                   required
                                   error-message="Please select signed date"
                                   auto-validate$="[[_autoValidateIsOn(item.types)]]"
                                   no-init show-clear-btn>
                </etools-date-input>
              </div>
              <div class="col col-5 file-container">
                <!-- Signed Agreement -->
                <etools-single-file id="fileUpload_[[index]]"
                                    label="Signed Agreement"
                                    internal-file=[[item.signed_amendment_file]]
                                    file={{item.signed_amendment}}
                                    accept=".doc,.docx,.pdf,.jpg,.png"
                                    error-message="Attachment required"
                                    readonly="[[_isReadonlyAmendment(item.id)]]"></etools-single-file>
              </div>
            </div>
            <template is="dom-if" if="[[!_isReadonlyAmendment(item.id)]]">
              <div class="row-h flex-c" hidden$="[[!item.types]]">
                <span class="type-warning">
                  [[_getSelectedAmendmentTypeWarning(item.types, item.types.length)]]
                </span>
              </div>
            </template>
              <div class="row-h">
                <paper-input id="other" hidden$="[[!_showOtherInput(item.types, item.types.length)]]"
                                placeholder="&#8212;"
                                label="Other"
                                value="{{item.other_description}}"
                                readonly="[[_isReadonlyAmendment(item.id)]]">
                  </paper-input>
              </div>
          </div>

        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no amendments added.</p>
    </div>
    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                  on-tap="_addNewAmendment"
                  title="Add"></paper-fab>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-amendments',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.RepeatableDataSetsBehavior,
          etoolsBehaviors.DynamicDialogBehavior,
          pmpBehaviors.DateBehavior
        ],

        properties: {
          amendmentTypes: {
            type: Object,
            value: function() {
              return [{label: 'Dates', value: 'dates'},
                {label: 'Results', value: 'results'},
                {label: 'Budget', value: 'budget'},
                {label: 'Other', value: 'other'}];
            }
           // statePath: 'interventionAmendmentTypes'
          },
          filteredAmendmentTypes: Object,
          interventionDocumentType: {
            type: String
          },
          permissions: Object
        },

        observers: [
          '_dataHasChanged(dataItems)',
          '_dataItemsLengthChanged(dataItems.length)',
          '_dataItemsPropertyChange(dataItems.*)',
          '_filterAmendmentTypes(amendmentTypes, interventionDocumentType)'
         ],

        ready: function() {
          this.dataSetModel = {
            id: null,
            types: [],
            other: null,
            signed_date: null,
            signed_amendment: null,
            signed_amendment_file: '',
            amendment_number: null
          };

          var dialog = document.createElement('p');
          dialog.setAttribute('id', 'addAmendmendConfirmation');
          dialog.innerHTML = 'All fields in the details tab will now be open for editing. ' +
            'Please change all necessary fields before hitting save.';
          this.addAmendmentConfirmationDialog = this.createDialog('Add Amendment Confirmation', 'md', 'OK', 'Cancel',
              this._addAmendmentConfirmationCallback.bind(this), dialog);
          this.addAmendmentConfirmationDialog.customStyle['--paper-dialog-scrollable'] = 'var(--pmp-paper-dialog-content)';
          this.addAmendmentConfirmationDialog.updateStyles();
        },
       _getReadonlyAmendmentTypes: function(types) {
          if (!types || !types.length) {
            return null;
          }
          let amdTypes = this.amendmentTypes.filter(function(t) {
            return types.indexOf(t.value) > -1;
          });
          if (amdTypes.length) {
            let amdTypesLabels = amTypes.map(function(t) {
              return t.label;
            });
            return amdTypesLabels.join(' | ');
          }
          return null;
        },
        detached: function() {
          if (this.addAmendmentConfirmationDialog) {
            this.removeDialog(this.addAmendmentConfirmationDialog);
          }
        },
        _filterAmendmentTypes: function(amendmentTypes, interventionDocumentType) {
          if (interventionDocumentType === 'SSFA') {
            this.filteredAmendmentTypes = this.amendmentTypes.filter(function(item) {
              return ['Dates','Other'].indexOf(item.label) > -1;
            });
          } else {
            this.filteredAmendmentTypes = JSON.parse(JSON.stringify(this.amendmentTypes))
          }
        },
        _showOtherInput: function(selectedAmdTypes) {
          if (!selectedAmdTypes || !selectedAmdTypes.length) {
            return false;
          }
          if (selectedAmdTypes.indexOf('other') > -1) { //TODO
            return true;
          }
          this._clearOtherInput();
          return false;
        },
        _clearOtherInput: function() {
          var otherInput = this.$$('#other');
          if (otherInput) {
            otherInput.value = null;
          }
        },
        _autoValidateIsOn: function(selectedAmdTypes) {
          if (selectedAmdTypes && selectedAmdTypes.length) {
            return true;
          }
          return false;
        },
        _showAddAmendmentConfirmationDialog: function() {
          if (this.addAmendmentConfirmationDialog) {
            this.addAmendmentConfirmationDialog.opened = true;
          }
        },
        _addAmendmentConfirmationCallback: function(event) {
          if (event.detail.confirmed) {
            this._addElement();
            this.fire('adding-amendment');
          }
        },
        _dataHasChanged: function(dataItems) {
          if (dataItems instanceof Array === false) {
            this.set('dataItems', []);
          }
        },
        _dataItemsLengthChanged: function() {
          if (!this.dataItems.length) {
            this.fire('cancel-adding-amendment');
          }
        },

        // observe amendments property changes and validate
        _dataItemsPropertyChange: function(data) {
          if (data.path.indexOf('dataItems.#') === -1) {
            return;
          }
          var index = this._getIndex(data);
          if (isNaN(index)) {
            return;
          }

          var amendment = this.dataItems[index];
          if (this._isReadonlyAmendment(amendment.id)) {
            this._resetAmendmentValidations(index);
            return;
          }

          this._validateAmendment(index);
        },
        _getIndex: function(data) {
          var path = data.path.replace('dataItems.#', '');
          var index = parseInt(path.substring(0, path.indexOf('.')), 10);
          return index;
        },
        _validateAmendment: function(index) {
          var valid = true;
          var amendment = this.dataItems[index];
          if (!amendment) {
            return valid;
          }
          valid = this._validateAmendmentTypes(index);
          valid = this._validateSignedDate(amendment, index);
          valid = this._validateFileUpload(amendment, index);

          return valid;
        },
        _validateAmendmentTypes: function(index) {
          var valid = true;
          var typeEl = this.$$('#amendmentTypes_' + index);
          if (typeEl && !typeEl.validate()) {
            valid = false;
          }
          return valid;
        },
        _validateFileUpload: function(amendment, index) {
          var valid = !!amendment.signed_amendment;
          var fileUplodEl = this.$$('#fileUpload_' + index);
          fileUplodEl.invalid = !valid;
          return valid;
        },
        _validateSignedDate: function(amendment, index) {
          var valid = true;

          var signedDateEl = this.$$('#signedDate_' + index);
          if (!signedDateEl) {
            return valid;
          }
          if (!signedDateEl.validate()) {
            signedDateEl.errorMessage = 'Please select signed date';
            valid = false;
          } else if (this.isFutureDate(amendment.signed_date)) {
            signedDateEl.errorMessage = 'Signed date can not be in the future';
            valid = false;
          }
          signedDateEl.invalid = null;// *This is neccessary because sometimes it doesn't work without it
          signedDateEl.invalid = !valid;

          return valid;
        },

        /**
         * The amendment can be removed only if it doesn't have and id assigned(only if is not saved)
         */
        _canBeRemoved: function(index) {
          var amendment = this.dataItems[index];
          var amendmentId = parseInt(amendment.id, 10);
          if (amendment && isNaN(amendmentId) === false && amendmentId > 0) {
            // amendment already saved (has an id assigned)
            return false;
          }
          return true;
        },

        /**
         * If the amendment readonly, the left border and top badge needs to have a different style.
         * This class will help with that.
         */
        _getLockedClass: function(id) {
          if (this._isReadonlyAmendment(id)) {
            return 'locked';
          }
          return '';
        },

        _getItemNr: function(index) {
          return parseInt(index, 10) + 1;
        },

        /**
         * Check if amendment fields are empty
         */
        _amendmentFieldsAreEmpty: function(amendment) {
          return (amendment.signed_date === null || amendment.signed_date === '') &&
              (amendment.signed_amendment_file === null ||
              (typeof amendment.signed_amendment_file === 'string' &&
              amendment.signed_amendment_file === '')) &&
              amendment.signed_amendment instanceof File === false && !amendment.type;
        },

        /**
         * Validate last added amendment and if is not empty add a new one
         */
        _addNewAmendment: function() {
          var lastAmendmIndex = this.dataItems.length - 1;

          if (lastAmendmIndex > -1) {
            lastAmendmIndex = this.dataItems[lastAmendmIndex];
            if (!lastAmendmIndex.id && this._amendmentFieldsAreEmpty(lastAmendmIndex)) {
              this.fire('toast', {text: 'Last amendment fields are empty!', showCloseBtn: true});
              return;
            }
          }
          this._showAddAmendmentConfirmationDialog();
        },

        // validate fields
        validate: function() {
          var valid = true;
          if (!this.dataItems.length) {
            return valid;
          }
          this.dataItems.forEach(function(amendment, index) {
            if (!this._validateAmendment(index)) {
              valid = false;
            }
            if (this.dataItems.length - 1 === index) {
              // last amendment
              if (this._amendmentFieldsAreEmpty(amendment)) {
                valid = false;
              }
            }
          }.bind(this));
          return valid;
        },

        resetValidations: function() {
          if (!this.dataItems.length) {
            return;
          }
          this.dataItems.forEach(function(amendment, index) {
            this._resetAmendmentValidations(index);
          }.bind(this));

        },

        _resetAmendmentValidations: function(index) {
          var typeEl = this.$$('#amendmentTypes_' + index);
          if (typeEl) {
            typeEl.invalid = false;
          }
          var signedDateEl = this.$$('#signedDate_' + index);
          if (signedDateEl) {
            signedDateEl.invalid = false;
          }
          var fileUpload = this.$$('#fileUpload_' + index);
          if (fileUpload) {
            fileUpload.invalid = false;
          }
        },

        _isReadonlyAmendment: function(amendmentId) {
          return !!amendmentId;
        },

        _getSelectedAmendmentTypeWarning: function(types) {//TODO
          if (!types || !types.length) {
            return;
          }
         var message = 'Please make sure you update ';
         types.forEach(function(amdType) {
           switch (amdType) {
             case 'dates':
               message += 'Dates, ';
               break;
             case 'results':
               message += 'Programme Results, ';
               break;
             case 'budget':
               message += 'Planned Budget, ';
               break;
             case 'other':
               message += 'Other, ';
               break;
           }
         });
          message = message.substring(0, message.length - 2);
          message += ' section' + (message.indexOf(',') > -1 ? 's' : '') + ' of this PD/SSFA';
          return message;
        }

      });
    })();
  </script>
</dom-module>
