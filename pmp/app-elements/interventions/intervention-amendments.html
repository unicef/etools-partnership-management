<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">

<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/file-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">

<link rel="import" href="../common-elements/etools-date-input.html">
<link rel="import" href="../common-elements/etools-single-file.html">

<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../validators/required-and-not-future-date-validator.html">
<link rel="import" href="add-amendment-dialog.html">

<dom-module id="intervention-amendments">
  <template strip-whitespace>
    <style
        include="grid-layout-styles repeatable-data-sets-styles repeatable-data-sets-styles-v2 file-styles shared-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;

        --paper-fab-keyboard-focus-background: var(--success-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      .type-warning {
        color: var(--warning-color);
      }

      #amendments-wrapper {
        margin-top: 16px;
      }

      :host(:not([edit-mode])) #amendments-wrapper {
        margin-bottom: 24px;
      }

      paper-input#other {
        width: 100%;
      }

      #no-amend-warning {
        padding: 24px;
      }
      .item-actions-container {
        min-width: 36px;
      }
    </style>
    <div hidden$="[[_emptyList(dataItems.length)]]" id="amendments-wrapper">
      <template is="dom-repeat" id="amendmentsRepeater" items="[[dataItems]]">
        <div class="row-h item-container">
          <div class="item-actions-container locked"
               data-item-nr$="[[_getItemNr(index)]]">
          </div>
          <div class="item-content">
            <div class="row-h flex-c">
              <div class="col col-4">
                <!-- Amendment Type -->
                <paper-input label="Amendment Types" value$="[[_getReadonlyAmendmentTypes(item.types)]]"
                               readonly></paper-input>
              </div>
              <div class="col col-3">
                <!-- Signed Date -->
                <etools-date-input id$="signedDate_[[index]]"
                                   label="Signed date"
                                   value="[[item.signed_date]]"
                                   readonly>
                </etools-date-input>
              </div>
              <div class="col col-5 file-container">
                <!-- Signed Agreement -->
                <etools-single-file id$="fileUpload_[[index]]"
                                    label="Signed Agreement"
                                    internal-file$=[[item.signed_amendment_file]]
                                    file$="[[item.signed_amendment]]"
                                    readonly></etools-single-file>
              </div>
            </div>
            <div class="row-h" hidden$="[[!_showOtherInput(item.types, item.types.length, index)]]">
              <paper-input id="other"
                           placeholder="&#8212;"
                           label="Other"
                           value="[[item.other_description]]"
                           readonly>
              </paper-input>
            </div>
          </div>

        </div>
      </template>
    </div>

    <div id="no-amend-warning" class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      There are no amendments added.
    </div>
    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_showAddAmendmentDialog"
                 title="Add"></paper-fab>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'intervention-amendments',

        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
          etoolsBehaviors.DynamicDialogBehavior,
          EtoolsPmpApp.Behaviors.Dropdown
        ],

        properties: {
          filteredAmendmentTypes: Object,
          amendmentTypes: {
            type: Object,
            statePath: 'interventionAmendmentTypes'
          },
          interventionDocumentType: {
            type: String
          },
          amendActionInProgress: {
            type: Boolean,
            notify: true
          },
          addAmendmentDialog: {
            type: Object
          },
          editMode: {
            type: Boolean,
            value: false
          },
        },

        observers: [
          '_dataHasChanged(dataItems)'
        ],

        ready: function() {
          this.dataSetModel = {
            id: null,
            types: [],
            other_description: null,
            signed_date: null,
            signed_amendment: null,
            signed_amendment_file: '',
            amendment_number: null
          };
          this._createAddAmendmentDialog();
        },

        _createAddAmendmentDialog: function() {
          this.addAmendmentDialog = document.createElement('add-amendment-dialog');
          this.addAmendmentDialog.setAttribute('id', 'addAmendmentDialog');
          this.addAmendmentDialog.interventionDocumentType = this.interventionDocumentType;
          this.addAmendmentDialog.interventionId = this.interventionId;
          this.addAmendmentDialog.addEventListener('amendment-added', this.newAmendmentAdded.bind(this));
          document.querySelector('body').appendChild(this.addAmendmentDialog);

        },

        _getReadonlyAmendmentTypes: function(types) {
          if (!types || !types.length) {
            return null;
          }
          let amdTypes = this.amendmentTypes.filter(function(t) {
            return types.indexOf(t.value) > -1;
          });
          if (amdTypes.length) {
            let amdTypesLabels = amdTypes.map(function(t) {
              return t.label;
            });
            return amdTypesLabels.join(' | ');
          }
          return null;
        },

        detached: function() {
          if (this.addAmendmentDialog) {
            this.removeDialog(this.addAmendmentDialog);
          }
        },

        _showAddAmendmentDialog: function() {
          if (this.addAmendmentDialog) {
            this.addAmendmentDialog.opened = true;
          }
        },

        newAmendmentAdded: function(event) {
          event.stopImmediatePropagation();
          let data = event.detail;
          this.set('amendActionInProgress', true);
          this.push('dataItems', data);
          this._unlockInterventionDetailsFields();
        },

        _dataHasChanged: function(dataItems) {
          if (dataItems instanceof Array === false) {
            this.set('dataItems', []);
          }

          this.async(function() {
            // renders appropriate mixins to amendments that get added
            this.updateStyles();
          }.bind(this), 0);
        },

        _unlockInterventionDetailsFields: function() {
          this.fire('unlock-details-fields');
        },

        _getItemNr: function(index) {
          return parseInt(index, 10) + 1;
        },

        _showOtherInput: function(selectedAmdTypes, selectedAmdTypesLength) {
          if (!selectedAmdTypes || !selectedAmdTypes.length) {
            return false;
          }
          if (selectedAmdTypes.indexOf('other') > -1) {
            return true;
          }
          return false;
        },

        _emptyList: function(listLength) {
          return listLength === 0;
        },

      });
    })();
  </script>
</dom-module>
