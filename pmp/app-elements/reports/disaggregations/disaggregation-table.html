<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/promise-polyfill/promise-polyfill-lite.html">

<link rel="import" href="table-content/three-disaggregations.html">
<link rel="import" href="table-content/two-disaggregations.html">
<link rel="import" href="table-content/one-disaggregation.html">
<link rel="import" href="table-content/zero-disaggregations.html">
<link rel="import" href="disaggregation-switches.html">

<dom-module id="disaggregation-table">
  <template>
    <style include="disaggregation-table-styles">
      .location-progress {
        text-align: right;
      }

      .location-progress dt,
      .location-progress dd {
        display: inline;
        margin: 0;
      }

      .location-progress dt {
        font-weight: bold;
      }
      :host {
          display: block;
        }

        .container {
          width: 100%;
          display: flex;
          flex-wrap: wrap;
        }
        .item {
          padding: 10px;
        }

        table {
          text-align: center;
          font-size: 13px;
        }

        /*  Text above the table  */
        h4 {
          font-weight: 400;
          color: var(--paper-grey-600);
          margin: 0 0 15px 0;
        }
        h4 strong {
          color: var(--paper-grey-800);
        }
        span.total {
          float: right;
          padding-left: 15px;
        }

        /*   Table header    */
        .headerRow, th {
          font-weight: 400;
          padding: 5px 0;
          background-color: #f0f0f0;
        }

        /*   Rows   */
        tr {
          @apply(--layout-horizontal);
          @apply(--layout-center);
          border-bottom: 1px solid white;
        }

        .totalsRow, .totalsRow td {
          background-color: #f0f0f0;
        }

        .outerRow, .outerRow td {
          background-color: var(--theme-table-bg-secondary, #c4e3f7);
        }

        .middleRow {
          background-color: var(--theme-table-bg-primary, #edf8ff);
        }
        /*   Totals table (three disaggregations only)   */
        .bottomRow td:not(:first-child){
          background-color: #f0f0f0;
        }

        /*   Cells   */
        td, th {
          min-width: 40px;
          min-height: 25px;
          word-wrap: break-word;
          hyphens: auto;
          @apply(--layout-flex);
          @apply(--layout-self-stretch);
          @apply(--layout-center);
        }

        .cellValue {
          display: inline-block;
          line-height: 25px;
        }

        td:first-child {
          border-left: 1px solid white;
        }

        td:not(:last-child)  {
          border-right: 1px solid white;
        }

        .cellTitle,
        .cellTotal {
          background-color: var(--paper-grey-100);
        }
    </style>
    <div>
      <disaggregation-switches
          data="[[data]]"
          mapping="[[mapping]]"
          editable="[[editable]]"
          formatted-data="{{formattedData}}"
          on-formatted-data-changed="_triggerModalRefit">
      </disaggregation-switches>

      <template
          is="dom-if"
          if="[[editableBool]]">
        <dl class="location-progress">
          <dt>Location progress:</dt>
          <template
              is="dom-if"
              if="[[_equals(indicatorType, 'number')]]"
              restamp="true">
            <dd>[[formattedData.location_progress.v]]</dd>
          </template>
          <template
              is="dom-if"
              if="[[_equals(indicatorType, 'percentage')]]"
              restamp="true">
            <dd>[[_toPercentage(formattedData.location_progress.c)]]</dd>
          </template>
        </dl>
      </template>

      <table class="vertical layout">
        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 0)]]"
            restamp="true">
          <zero-disaggregations
              data="[[formattedData]]"
              mapping="[[formattedMapping]]"
              editable="[[editable]]">
          </zero-disaggregations>
        </template>

        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 1)]]"
            restamp="true">
          <one-disaggregation
              data="[[formattedData]]"
              mapping="[[formattedMapping]]"
              editable="[[editable]]">
          </one-disaggregation>
        </template>

        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 2)]]"
            restamp="true">
          <two-disaggregations
              data="[[formattedData]]"
              mapping="[[formattedMapping]]"
              editable="[[editable]]">
          </two-disaggregations>
        </template>

        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 3)]]"
            restamp="true">
          <three-disaggregations
              data="[[formattedData]]"
              mapping="[[formattedMapping]]"
              editable="[[editable]]">
          </three-disaggregations>
        </template>
      </table>
    </div>

  </template>

  <script>

    Polymer({
      is: 'disaggregation-table',

      behaviors: [
        App.Behaviors.UtilsBehavior,
        App.Behaviors.ReduxBehavior,
      ],

      properties: {
        editable: {
          type: Number,
          value: 0,
        },

        data: Object,

        formattedData: {
          type: Object,
          observer: '_cloneData',
        },

        formattedMapping: {
          type: Array,
          computed: '_computeMapping(editableBool, formattedData, mapping)',
        },

        updateUrl: {
          type: String,
          value: App.Endpoints.indicatorLocationDataEntries(),
        },

        editableBool: {
          type: Boolean,
          computed: '_computeEditableBool(editable)',
        },

        indicatorType: {
          type: String,
          computed: '_computeIndicatorType(data)',
        },

        fields: Array,

        localData: Object,

        mapping: Array,
      },

      listeners: {
        'register-field': '_registerField',
        'field-value-changed': '_fieldValueChanged',
      },

      observers: [
        '_resetFields(formattedData.disaggregation_reported_on)',
      ],

      _registerField: function (e, field) {
        e.stopPropagation();

        if (!this.fields) {
          this.set('fields', []);
        }

        this.push('fields', field);
      },

      _fieldValueChanged: function (e, change) {
        var updatePath = ['localData.disaggregation', change.key];

        e.stopPropagation();

        this.set(
          updatePath,
          Object.assign(
            {
              c: null,
              d: null,
              v: null,
            },
            this.get(updatePath),
            change.value
          )
        );
      },

    });
  </script>
</dom-module>
