<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">

<link rel="import" href="../../../scripts/lodash/lodash.html">

<link rel="import" href="../common-elements/etools-form-element-wrapper.html">
<link rel="import" href="elems/behaviors/indicator-reports-common.html">
<link rel="import" href="elems/report-overall.html">
<link rel="import" href="elems/report-status.html">
<link rel="import" href="elems/indicator-report-target.html">
<link rel="import" href="elems/indicator-details.html">

<link rel="import" href="../../../styles/page-common-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<!-- TODO: remove reports mockup data -->
<link rel="import" href="elems/reports-list-data-mockup.html">

<dom-module id="report-progress">

  <template strip-whitespace>

    <style include="page-common-styles grid-layout-styles">
      *[hidden] {
        display: none !important;
      }

      .indicator + .indicator {
        border-top: 1px solid var(--primary-background-color);
      }

      .indicator-toggle,
      .indicator-header-title,
      .indicator-header-target {
        @apply --layout-vertical;
        @apply --layout-center-justified;
      }

      .indicator-toggle {
        position: relative;
        z-index: 1;
        color: white;
        padding: 0 4px;
        border-right: 1px solid var(--primary-background-color);
      }

      .indicator-toggle paper-icon-button {
        width: 24px;
        height: 24px;
        padding: 0;
      }

      .indicator-toggle {
        background-color: var(--primary-color);
      }

      .indicator-toggle.cluster-indicator {
        background-color: var(--ternary-color);
      }

      .indicator-header {
        padding: 8px 24px 8px 16px;
        background: var(--medium-theme-background-color);
      }

      .indicator-header-title h3 {
        margin: 0;
      }

      #no-report-data {
        background-color: var(--primary-background-color);
      }
    </style>

    <paper-material id="no-report-data" elevation="1"
                    hidden$="[[!_noReportDataToShow(report.programme_document.cp_outputs)]]">
      <div class="row-h">
        <p>There is no report data to display.</p>
      </div>
    </paper-material>

    <template is="dom-repeat"
              items="[[report.programme_document.cp_outputs]]"
              as="result"
              index-as="resultIndex">
      <etools-content-panel class="content-section" panel-title="[[result.title]]">

        <template is="dom-repeat"
                  items="[[result.ll_outputs]]"
                  as="lowerResult"
                  index-as="lowerResultIndex">

          <report-overall lower-result-title="[[lowerResult.title]]"
                          latest-indicator="[[_getLowerResultLatestIndicator(lowerResult.id)]]"></report-overall>

          <template is="dom-repeat"
                    items="[[_getLowerResultIndicatorReports(lowerResult.id)]]"
                    as="indicatorReport"
                    index-as="indicatorReportIndex">

            <div class="indicator">
              <div class="layout-horizontal">
                <div class$="indicator-toggle [[_getClusterIndicatorClass(indicatorReport)]]">
                  <paper-icon-button on-tap="_toggle"
                                     toggles$="[[resultIndex]]-[[lowerResultIndex]]-[[indicatorReportIndex]]"
                                     icon$="[[_computeIcon(indicatorReport.expanded)]]">
                  </paper-icon-button>
                </div>

                <div class="indicator-header layout-horizontal flex-c">
                  <div class="col col-8 indicator-header-title">
                    <h3>[[getUnitValue(indicatorReport.reportable.blueprint.unit)]] [[indicatorReport.reportable.blueprint.title]]</h3>
                  </div>
                  <div class="col col-4 indicator-header-target">
                    <indicator-report-target target="[[indicatorReport.reportable.target]]"
                                             cumulative-progress="[[indicatorReport.reportable.achieved.c]]"
                                             achivement="[[indicatorReport.total.c]]"
                                             bold></indicator-report-target>
                  </div>
                </div>
              </div>

              <iron-collapse id="collapse-[[resultIndex]]-[[lowerResultIndex]]-[[indicatorReportIndex]]"
                  opened="{{indicatorReport.expanded}}">
                <!--on-opened-changed="_handleOpenedChanged"-->
                <indicator-details
                    id="indicatorDetails"
                    reportable-id="[[index]]"
                    indicator-name="Indicator-name"
                    indicator-id="1"
                    reporting-period="yesterday - the day after tomorrow"
                    override-mode="view"
                    disaggregations="[[disaggregations]]">
                </indicator-details>
              </iron-collapse>
            </div>
          </template>

        </template>
      </etools-content-panel>
    </template>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'report-progress',
        behaviors: [
          EtoolsPmpApp.Behaviors.IndicatorReportsCommon
        ],
        properties: {
          report: Object,

          expanded: {
            type: Boolean,
            value: false
          },
          dummyArr: {
            type: Array,
            value: [
              {expanded: false},
              {expanded: false},
              {expanded: false},
              {expanded: false},
            ]
          },
          data: {
            type: Object,
          },
          disaggregations: {
            type: Object,
          },
        },
        ready: function() {
          this._setMockData();
        },

        attached: function() {
          /**
           * Disable loading message for report progress tab elements load,
           * triggered by parent element on stamp or by tap event on tabs
           */
          this.fire('global-loading', {active: false, loadingSource: 'reports-page'});
          // this.fire('reports-page-attached');
        },

        _computeIcon: function(opened) {
          return opened ? 'icons:expand-less' : 'icons:expand-more';
        },
        _toggle: function(e) {
          let toggles = Polymer.dom(e).localTarget.getAttribute('toggles');
          console.log(toggles);
          this.$$('#collapse-' + toggles).toggle();
        },
        _getClusterIndicatorClass: function(indicatorReport) {
          return (indicatorReport && indicatorReport.isClusterIndicator) ? 'cluster-indicator' : '';
        },

        _noReportDataToShow: function(cpOutputs) {
          return _.isEmpty(cpOutputs);
        },

        _getLowerResultLatestIndicator(lowerResultId) {
          if (!lowerResultId || _.isEmpty(this.report.indicator_reports)) {
            return {};
          }
          let latestIndicatorReport = this.report.indicator_reports.find(function(rep) {
            return rep.reportable_object_id === lowerResultId;
          });
          return latestIndicatorReport ? latestIndicatorReport : {};
        },

        _getLowerResultIndicatorReports: function(lowerResultId) {
          if (!lowerResultId || _.isEmpty(this.report.indicator_reports)) {
            return [];
          }
          return this.report.indicator_reports.filter(function(rep) {
            return rep.reportable_object_id === lowerResultId;
          });
        },

        // TODO: to be removed
        _setMockData: function() {
          this.disaggregations = {
            "id": 2560,
            "title": "ratio_indicator_report_19",
            "indicator_location_data": [{
              "id": 16844,
              "indicator_report": 2560,
              "location": {
                "id": 1,
                "title": "location_0",
                "latitude": null,
                "longitude": null,
                "p_code": null
              },
              "display_type": "percentage",
              "disaggregation": {
                "()": {
                  "c": 0.11339062933185473,
                  "d": 3607,
                  "v": 409
                }
              },
              "num_disaggregation": 1,
              "level_reported": 0,
              "disaggregation_reported_on": [],
              "location_progress": {
                "c": 0.11339062933185473,
                "d": 3607,
                "v": 409
              },
              "previous_location_progress": {
                "c": 0,
                "d": 0,
                "v": 0
              },
              "is_complete": true
            }, {
              "id": 16845,
              "indicator_report": 2560,
              "location": {
                "id": 2,
                "title": "location_1",
                "latitude": null,
                "longitude": null,
                "p_code": null
              },
              "display_type": "percentage",
              "disaggregation": {
                "(16614,)": {
                  "c": 0.21887461231723526,
                  "d": 2257,
                  "v": 494
                },
                "(16613,)": {
                  "c": 0.03417343015805212,
                  "d": 2341,
                  "v": 80
                },
                "(16612,)": {
                  "c": 0.021045485403937542,
                  "d": 2946,
                  "v": 62
                },
                "()": {
                  "c": 0.08430540827147402,
                  "d": 7544,
                  "v": 636
                }
              },
              "num_disaggregation": 1,
              "level_reported": 1,
              "disaggregation_reported_on": [3834],
              "location_progress": {
                "c": 0.08430540827147402,
                "d": 7544,
                "v": 636
              },
              "previous_location_progress": {
                "c": 0,
                "d": 0,
                "v": 0
              },
              "is_complete": true
            }],
            "time_period_start": "2017-01-31",
            "time_period_end": "2017-01-31",
            "display_type": "percentage",
            "total": {
              "c": 0.09371356828983948,
              "d": 11151,
              "v": 1045
            },
            "remarks": null,
            "report_status": "Sub",
            "disagg_lookup_map": [{
              "id": 3834,
              "name": "gender",
              "active": true,
              "choices": [{
                "id": 16614,
                "value": "other",
                "active": true
              }, {
                "id": 16613,
                "value": "female",
                "active": true
              }, {
                "id": 16612,
                "value": "male",
                "active": true
              }]
            }],
            "disagg_choice_lookup_map": [
              [
                [16612, "male"],
                [16613, "female"],
                [16614, "other"]
              ]
            ]
          };


          this.data = {
            "id": 2560,
            "name": "ratio_indicator_19",
            "llo_id": 40,
            "status": {
              "remarks": null,
              "report_status": "Sub"
            },
            "overall_status": "Con",
            "narrative_assessment": "",
            "indicator_reports": [{
              "id": 2560,
              "indicator_name": "ratio_indicator_19",
              "target": "5000",
              "achieved": {
                "c": 0.09371356828983948,
                "d": 11151,
                "v": 1045
              },
              "total": {
                "c": 0.09371356828983948,
                "d": 11151,
                "v": 1045
              },
              "report_status": "Sub"
            }],
            "display_type": "percentage",
            "total": {
              "c": 0.09371356828983948,
              "d": 11151,
              "v": 1045
            }
          };
        }

      });

    })();
  </script>

</dom-module>
