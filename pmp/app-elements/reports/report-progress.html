<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">

<link rel="import" href="../../../scripts/lodash/lodash.html">

<link rel="import" href="../../app-behaviors/common-behavior.html">
<link rel="import" href="../../app-behaviors/utils-behavior.html">

<link rel="import" href="../common-elements/etools-form-element-wrapper.html">
<link rel="import" href="elems/report-overall.html">
<link rel="import" href="elems/report-status.html">
<link rel="import" href="elems/indicator-report-target.html">
<link rel="import" href="elems/indicator-details.html">

<link rel="import" href="../../../styles/page-common-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<dom-module id="report-progress">

  <template strip-whitespace>

    <style include="page-common-styles grid-layout-styles paper-material-styles">
      div[elevation="1"] {
        @apply --paper-material-elevation-1;
      }

      *[hidden] {
        display: none !important;
      }

      .indicator + .indicator {
        border-top: 1px solid var(--primary-background-color);
      }

      .indicator-toggle,
      .indicator-header-title,
      .indicator-header-target {
        @apply --layout-vertical;
        @apply --layout-center-justified;
      }

      .indicator-toggle {
        position: relative;
        z-index: 1;
        color: white;
        padding: 0 4px;
        border-right: 1px solid var(--primary-background-color);
      }

      .indicator-toggle paper-icon-button {
        width: 24px;
        height: 24px;
        padding: 0;
      }

      .indicator-toggle {
        background-color: var(--primary-color);
      }

      .indicator-toggle.cluster-indicator {
        background-color: var(--ternary-color);
      }

      .indicator-header {
        padding: 8px 24px 8px 16px;
        background: var(--medium-theme-background-color);
      }

      .indicator-header-title h3 {
        margin: 0;
      }

      #no-report-data {
        background-color: var(--primary-background-color);
      }

      .calculation-formula {
        color: var(--secondary-text-color);
      }
      .calculation-formula-delimiter {
        margin: 0 16px;
      }
    </style>

    <div id="no-report-data" elevation="1"
                    hidden$="[[!_noReportDataToShow(report.programme_document.cp_outputs)]]">
      <div class="row-h">
        <p>There is no report data to display.</p>
      </div>
    </div>

    <template is="dom-repeat"
              items="[[report.programme_document.cp_outputs]]"
              as="result"
              index-as="resultIndex">
      <etools-content-panel class="content-section" panel-title="[[result.title]]">

        <template is="dom-repeat"
                  items="[[result.ll_outputs]]"
                  as="lowerResult"
                  index-as="lowerResultIndex">

          <report-overall lower-result-title="[[lowerResult.title]]"
                          latest-indicator="[[_getLowerResultLatestIndicator(lowerResult.id)]]"></report-overall>

          <template is="dom-repeat"
                    items="[[_getLowerResultIndicatorReports(lowerResult.id)]]"
                    as="indicatorReport"
                    index-as="indicatorReportIndex">

            <div class="indicator">
              <div class="layout-horizontal">
                <div class$="indicator-toggle [[_getClusterIndicatorClass(indicatorReport)]]">
                  <paper-icon-button on-tap="_toggle"
                                     toggles$="[[resultIndex]]-[[lowerResultIndex]]-[[indicatorReportIndex]]"
                                     icon$="[[_computeIcon(indicatorReport.expanded)]]">
                  </paper-icon-button>
                </div>

                <div class="indicator-header layout-horizontal flex-c">
                  <div class="col col-8 indicator-header-title">
                    <h3>
                      [[_ternary(indicatorReport.reportable.blueprint.unit, 'number', '#', '%')]]
                      [[indicatorReport.reportable.blueprint.title]]
                    </h3>
                    <div class="layout-horizontal calculation-formula">
                      <span>
                        calculation method accross locations:
                        [[getDisplayValue(indicatorReport.reportable.blueprint.calculation_formula_across_locations)]]
                      </span>
                      <span class="calculation-formula-delimiter">|</span>
                      <span>
                        calculation across reporting periods:
                        [[getDisplayValue(indicatorReport.reportable.blueprint.calculation_formula_across_periods)]]
                      </span>
                    </div>
                  </div>
                  <div class="col col-4 indicator-header-target">
                    <indicator-report-target
                        values-type="[[indicatorReport.reportable.blueprint.display_type]]"
                         target="[[indicatorReport.reportable.target]]"
                         cumulative-progress="[[_ternary(indicatorReport.reportable.blueprint.display_type, 'number',
                              indicatorReport.reportable.achieved.v, indicator.reportable.achieved.c)]]"
                         achivement="[[_ternary(indicatorReport.reportable.blueprint.display_type, 'number',
                              indicatorReport.total.v, indicatorReport.total.c)]]"
                         bold></indicator-report-target>
                  </div>
                </div>
              </div>

              <iron-collapse id="collapse-[[resultIndex]]-[[lowerResultIndex]]-[[indicatorReportIndex]]"
                  opened="{{indicatorReport.expanded}}" on-transitioning-changed="_indicatorDetailsTransitioningComplete">
                <indicator-details
                    id$="indicator-details-[[resultIndex]]-[[lowerResultIndex]]-[[indicatorReportIndex]]"
                    indicator-report-id="[[indicatorReport.id]]" is-cluster-indicator$="[[indicatorReport.is_cluster_indicator]]">
                </indicator-details>
              </iron-collapse>
            </div>
          </template>

        </template>
      </etools-content-panel>
    </template>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'report-progress',
        behaviors: [
          EtoolsPmpApp.Behaviors.Common,
          EtoolsPmpApp.Behaviors.Utils
        ],
        properties: {
          report: Object
        },

        attached: function() {
          /**
           * Disable loading message for report progress tab elements load,
           * triggered by parent element on stamp or by tap event on tabs
           */
          this.fire('global-loading', {active: false, loadingSource: 'reports-page'});
        },

        _computeIcon: function(opened) {
          return opened ? 'icons:expand-less' : 'icons:expand-more';
        },

        _toggle: function(e) {
          let toggles = Polymer.dom(e).localTarget.getAttribute('toggles');
          let indicatorCollapsibleContent = this.$$('#collapse-' + toggles);
          if (indicatorCollapsibleContent) {
            indicatorCollapsibleContent.toggle();
          }
        },

        _indicatorDetailsTransitioningComplete: function(e) {
          let indicatorCollapsibleContent = Polymer.dom(e).localTarget;
          let indicatorDetails = indicatorCollapsibleContent.querySelector('indicator-details');
          if (indicatorDetails && !e.detail.value && indicatorCollapsibleContent.opened) {
            // trigger indicator details request
            indicatorDetails.getIndicatorDetails();
          }
        },

        _getClusterIndicatorClass: function(indicatorReport) {
          return (indicatorReport && indicatorReport.is_cluster_indicator) ? 'cluster-indicator' : '';
        },

        _noReportDataToShow: function(cpOutputs) {
          return _.isEmpty(cpOutputs);
        },

        _getLowerResultLatestIndicator: function(lowerResultId) {
          if (!lowerResultId || _.isEmpty(this.report.indicator_reports)) {
            return {};
          }
          let latestIndicatorReport = this.report.indicator_reports.find(function(rep) {
            return rep.reportable_object_id === lowerResultId;
          });
          return latestIndicatorReport ? latestIndicatorReport : {};
        },

        _getLowerResultIndicatorReports: function(lowerResultId) {
          if (!lowerResultId || _.isEmpty(this.report.indicator_reports)) {
            return [];
          }
          return this.report.indicator_reports.filter(function(rep) {
            return rep.reportable_object_id === lowerResultId;
          });
        }

      });

    })();
  </script>

</dom-module>
