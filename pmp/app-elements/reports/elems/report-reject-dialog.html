<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-errors-parser-behavior.html">

<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/required-field-styles.html">

<dom-module id="report-reject-dialog">
  <template>
    <style include="shared-styles required-field-starred-styles">
      [hidden] {
        display: none !important;
      }

      #content-box {
        margin-bottom: 20px;
      }
    </style>
    <etools-dialog
        id="reportRejectDialog"
        size="md"
        keep-dialog-open
        spinner-text="Sending rating..."
        disable-confirm-btn="[[!comment.length]]"        
        ok-btn-text="Send Back to Partner"
        cancel-btn-text="Cancel"
        dialog-title="Report for [[pdRefNumber]]: [[reportingPeriod]]"
        on-confirm-btn-clicked="saveStatus">
      <div id="content-box">
        <paper-input required label="Feedback/Comments" placeholder="&#8212;" value="{{comment}}"></paper-input>        
      </div>
    </etools-dialog>
  </template>

  <script>
    (function() {
      'use strict';
      /*
        status: 'accepted'/'sent back'
        overall_status: if accepting, the status of things
        comment: required when sending a report back
      */
      Polymer({
        is: 'report-reject-dialog',
        behaviors: [
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.AjaxErrorsParser
        ],        
        properties: {
          endpoint: {
            type: Object,
          },
          toastEventSource: {
            type: Object,
          },
          pdRefNumber: {
            type: String
          },
          reportingPeriod: {
            type: String
          },
          comment: {
            type: String,
            value: ''
          }
        },

        open: function() { 
          this.set('comment', '');
          this.$.reportRejectDialog.set('opened', true);
        },

        close: function() {
          this.$.reportRejectDialog.set('opened', false);   
        },

        startSpinner: function() {
          this.$.reportRejectDialog.startSpinner();
        },

        stopSpinner: function() {
          this.$.reportRejectDialog.stopSpinner();
        },

        saveStatus: function() {
          let self = this;
          let requestBody = {
            status: 'sent back',
            comment: this.comment
          };

          this.startSpinner();

          this.fireRequest('reportReview',
              {countryId: this.currentUser.profile.country, reportId: this.report.id},
              {method: 'POST', body: requestBody})
            .then(function() {
              self.close();
            }).catch(function(error) {
              self._handleErrorResponse(error);
            });
        },

        _handleErrorResponse: function(error) {
          this.stopSpinner();
          this.parseRequestErrorsAndShowAsToastMsgs(error, this.toastEventSource);
        },
      });
    })();
  </script>
</dom-module>

