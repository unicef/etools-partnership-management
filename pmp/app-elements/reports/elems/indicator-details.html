<link rel="import" href="../../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/app-layout/app-grid/app-grid-style.html">

<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../../bower_components/etools-loading/etools-loading.html">

<link rel="import" href="../../../../scripts/lodash/lodash.html">
<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-errors-parser-behavior.html">

<link rel="import" href="disaggregations/disaggregation-table.html">
<link rel="import" href="../../../app-behaviors/utils-behavior.html">

<dom-module id="indicator-details">
  <template>
    <style include="app-grid-style">
      :host {
        display: block;
        min-height: 150px;
        position: relative;

        --app-grid-columns: 2;
        --app-grid-gutter: 24px;
        --app-grid-item-height: auto;
        --paper-tab-ink: var(--primary-color);
        --paper-tabs-selection-bar-color: var(--primary-color);

        --paper-tabs: {
          padding-left: 13px;
          border-bottom: 1px solid var(--dark-divider-color);
        };
      }

      :host([is-cluster-indicator]) {
        --paper-tab-ink: var(--ternary-color);
        --paper-tabs-selection-bar-color: var(--ternary-color);
      }

      .tab-header {
        @apply --layout-horizontal;
        @apply --layout-justified;
        padding: 10px 24px;
        border-bottom: 1px solid var(--dark-divider-color);
        background-color: var(--light-theme-background-color);
      }

      .tab-header dl {
        margin: 0;
        font-size: 12px;
        color: var(--primary-text-color);
      }

      .tab-header dt,
      .tab-header dd {
        display: inline;
        margin: 0;
      }

      .tab-header dt:first-of-type,
      .tab-header dd:first-of-type {
        font-weight: bold;
        font-size: 13px;
      }

      .tab-header dt:last-of-type,
      .tab-header dd:last-of-type {
        color: var(--secondary-text-color);
      }

      .tab-header dd::after {
        content: '\A';
        white-space: pre;
      }

      .table-container {
        max-height: 500px;
        overflow: auto;
      }

    </style>

    <etools-loading active="[[loading]]">Loading indicator details...</etools-loading>

    <template is="dom-if" if="[[!loading]]">
      <paper-tabs
          selected="{{selected}}"
          fallback-selection="location-[[indicatorReport.indicator_location_data.0.location.id]]"
          attr-for-selected="name"
          scrollable
          hide-scroll-buttons>
        <template is="dom-repeat" items="[[indicatorReport.indicator_location_data]]" as="location">
          <paper-tab name="location-[[location.location.id]]">
            [[location.location.title]]
          </paper-tab>
        </template>
      </paper-tabs>

      <iron-pages attr-for-selected="name" selected="{{selected}}">
        <template is="dom-repeat" items="[[indicatorReport.indicator_location_data]]" as="location">
          <div name="location-[[location.location.id]]">
            <div class="tab-header">
              <dl>
                <template is="dom-if" if="[[_equals(location.display_type, 'number')]]" restamp="true">
                  <dt>Location progress:</dt>
                  <dd>[[location.location_progress.v]]</dd>
                  <dt>Previous location progress:</dt>
                  <dd>[[location.previous_location_progress.v]]</dd>
                </template>
                <template is="dom-if" if="[[_equals(location.display_type, 'percentage')]]" restamp="true">
                  <dt>Location progress:</dt>
                  <dd>[[_toPercentage(location.location_progress.c)]]</dd>
                  <dt>Previous location progress:</dt>
                  <dd>[[_toPercentage(location.previous_location_progress.c)]]</dd>
                </template>
              </dl>
            </div>

            <div class="table-container app-grid">
              <div class="item">
                <disaggregation-table data="[[location]]" mapping="[[indicatorReport.disagg_lookup_map]]">
                </disaggregation-table>
              </div>
            </div>
          </div>
        </template>
      </iron-pages>
    </template>

  </template>

  <script>
    Polymer({
      id: 'indicator-details',

      behaviors: [
        EtoolsLogsBehavior,
        EtoolsAjaxRequestBehavior,
        EtoolsPmpApp.Behaviors.AjaxErrorsParser,
        EtoolsPmpApp.Behaviors.Endpoints,
        EtoolsPmpApp.Behaviors.Utils
      ],

      properties: {
        indicatorReportId: Number,
        indicatorReport: {
          type: Object,
          value: {}
        },
        loading: {
          type: Boolean,
          value: false
        },
        selected: {
          type: String,
          value: ''
        },
        isClusterIndicator: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        }
      },

      getIndicatorDetails: function() {
        if (!_.isEmpty(this.indicatorReport)) {
          // indicator details already loaded
          return;
        }
        if (this.indicatorReportId && this.indicatorReportId !== this.indicatorReport.id) {
          let params = this._computeParams(this.indicatorReportId);
          this._showLoading();
          let self = this;
          this.fireRequest('reportIndicatorsDetails', {}, {params: params}).then(function(response) {
            self.set('indicatorReport', (response && response[0]) ? response[0] : {});
            self._hideLoading();
          }).catch(function(error) {
            let errMsg = 'Indicator details data request failed!';
            self.logError(errMsg, 'reports-indicator-details', error);
            self.parseRequestErrorsAndShowAsToastMsgs(error, self);
            self._hideLoading();
          });
        } // else, no need for getting indicator details
      },

      _showLoading: function() {
        this.set('loading', true);
      },

      _hideLoading: function() {
        this.set('loading', false);
      },

      _computeParams: function(indicatorReportId) {
        return {
          pks: indicatorReportId,
          limit: 1,
        };
      }

    });
  </script>
</dom-module>
