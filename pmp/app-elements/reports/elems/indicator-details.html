<link rel="import" href="../../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="status-badge.html">
<link rel="import" href="disaggregations/disaggregation-table.html">
<link rel="import" href="../styles/buttons.html">
<link rel="import" href="behaviors/utils.html">

<dom-module id="indicator-details">
  <template>
    <style include="button-styles iron-flex iron-flex-alignment app-grid-style">
      :host {
        display: block;
        min-height: 150px;
        position: relative;

        --app-grid-columns: 2;
        --app-grid-gutter: 25px;
        --app-grid-item-height: auto;
        --paper-tab-ink: var(--primary-color);
        --paper-tabs-selection-bar-color: var(--primary-color);

        --paper-tabs: {
          padding-left: 13px;
          border-bottom: 1px solid var(--paper-grey-300);
        };
      }

      .tab-header {
        padding: 10px 25px;
        border-bottom: 1px solid var(--paper-grey-300);
        background: var(--paper-grey-100);
      }

      .tab-header paper-button {
        margin: 0;
      }

      .tab-header dl {
        margin: 0;
        font-size: 12px;
        color: var(--theme-primary-text-color-medium);
      }

      .tab-header dt,
      .tab-header dd {
        display: inline;
        margin: 0;
      }

      .tab-header dt:first-of-type,
      .tab-header dd:first-of-type {
        font-size: 13px;
        color: var(--theme-primary-text-color-dark);
      }

      .tab-header dd::after {
        content: '\A';
        white-space: pre;
      }

      .table-container {
        max-height: 500px;
        overflow: auto;
      }

      .location {
        margin: 0;
        font-weight: bold;
      }

      .location iron-icon {
        margin-left: -3px;
        color: var(--theme-primary-color);
      }

      .current-pd {
        margin: 0;
        font-size: 12px;
        color: var(--theme-primary-text-color-medium);
      }
      disaggregation-table {
        margin-top: 1em;
      }
    </style>

    <template is="dom-if" if="[[!loading]]">
      <paper-tabs
          selected="{{selected}}"
          fallback-selection="location-[[disaggregations.indicator_location_data.0.location.id]]"
          attr-for-selected="name"
          scrollable
          hide-scroll-buttons>
        <template
            is="dom-repeat"
            items="[[disaggregations.indicator_location_data]]"
            as="location">
          <paper-tab name="location-[[location.location.id]]">
            <status-badge type="[[_computeLocationStatus(location)]]"></status-badge>
            [[location.location.title]]
          </paper-tab>
        </template>
      </paper-tabs>

      <iron-pages
          attr-for-selected="name"
          selected="{{selected}}">
        <template
            is="dom-repeat"
            items="[[disaggregations.indicator_location_data]]"
            as="location">
          <div name="location-[[location.location.id]]">
            <div class="tab-header layout horizontal justified">
              <dl>
                <template
                    is="dom-if"
                    if="[[_equals(location.display_type, 'number')]]"
                    restamp="true">
                  <dt>Location progress:</dt>
                  <dd>[[location.location_progress.v]]</dd>
                  <dt>Previous location progress:</dt>
                  <dd>[[location.previous_location_progress.v]]</dd>
                </template>
                <template
                    is="dom-if"
                    if="[[_equals(location.display_type, 'percentage')]]"
                    restamp="true">
                  <dt>Location progress:</dt>
                  <dd>[[_toPercentage(location.location_progress.c)]]</dd>
                  <dt>Previous location progress:</dt>
                  <dd>[[_toPercentage(location.previous_location_progress.c)]]</dd>
                </template>
              </dl>
              <div>
                <template
                    is="dom-if"
                    if="[[!_equals(computedMode, 'view')]]">
                  <paper-button
                      class="btn-primary"
                      modal-index="[[index]]"
                      on-tap="_openModal"
                      raised>
                    Enter data
                  </paper-button>
                </template>
              </div>
            </div>

            <div class="table-container app-grid">
              <div class="item">
                <disaggregation-table
                    data="[[location]]"
                    mapping="[[disaggregations.disagg_lookup_map]]">
                </disaggregation-table>

              </div>
            </div>
          </div>
        </template>
      </iron-pages>
    </template>

  </template>

  <script>
    Polymer({
      id: 'indicator-details',

      behaviors: [
        window.App.Behaviors.UtilsBehavior
      ],

      properties: {
        indicatorId: Number,

        indicatorName: String,

        reportableId: Number,

        reportingPeriod: String,

        opened: Object,

        selected: {
          type: Number,
          value: 0,
        },

        initialized: {
          type: Boolean,
          value: true,
        },

        loading: {
          type: Boolean,
          value: false,
        },

        hasPD: {
          type: Boolean,
          computed: '_computeHasPD(currentPD)',
        },

        params: {
          type: Object,
          computed: '_computeParams(indicatorId)',
        },

        data: {
          type: Object,
          statePath: 'disaggregations.byIndicator',
        },

        disaggregations: {
          type: Object,
        },

        mode: {
          type: String,
          value: '',
          statePath: 'programmeDocumentReports.current.mode',
        },

        overrideMode: {
          type: String,
          value: '',
        },

        computedMode: {
          type: String,
          computed: '_computeMode(mode, overrideMode)',
        },
      },

      listeners: {
        'location-updated': '_onLocationUpdated',
      },
      ready: function() {
//        console.log(
//          'indicator-details',
//          this.reportableId,
//          this.indicatorName,
//          this.indicatorId,
//          this.reportingPeriod,
//          this.overrideMode,
//          this.disaggregations
//        );
      },

      _computeParams: function (indicatorId) {
        return {
          pks: indicatorId,
          limit: 1,
        };
      },

      _computeMode: function (mode, overrideMode) {
        return overrideMode || mode;
      },

      _openModal: function (e) {
        this.$$('#modal-' + e.target.modalIndex).open();
      },

      _updateModals: function (e, data) {
        var id = e.target.id;
        var change;

        if (!id) {
          return;
        }

        change = {};

        change[id] = data.value;

        this.set('opened', Object.assign({}, this.opened, change));
      },

      _computeTableVisibility: function (opened, index) {
        return !!opened['modal-' + index];
      },

      _computeLocationStatus: function (location) {
        return location.is_complete ? 'success' : 'error';
      },

      _computeHasPD: function (currentPD) {
        return !!Object.keys(currentPD).length;
      },

      _onLocationUpdated: function (e) {
        e.stopPropagation();

        var allComplete = this.disaggregations.indicator_location_data
            .every(function (location) {
              return location.is_complete;
            });

        if (!allComplete) {
          return;
        }

        this.fire('report-complete', {
          indicatorId: this.indicatorId,
          reportableId: this.reportableId,
        });
      },

      attached: function () {
        this.set('opened', {});
      },
    });
  </script>
</dom-module>
