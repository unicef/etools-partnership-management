<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../../../app-behaviors/ajax-errors-parser-behavior.html">
<link rel="import" href="../../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<!-- TODO: remove reports mockup data -->
<link rel="import" href="../reports-list-data-mockup.html">

<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};
  /** @polymerBehavior EtoolsPmpApp.Behaviors.ReportDetailsImpl */
  EtoolsPmpApp.Behaviors.ReportDetailsImpl = {

    properties: {
      report: Object,
      lastReportPdRef: String,
      currentUser: {
        type: Object,
        statePath: 'currentUser'
      },
      reportActions: {
        type: Array,
        value: [
          {
            label: 'Accept',
            primary: true,
            event: 'accept-report'
          },
          {
            label: 'Send back to partner',
            event: 'send-back-to-partner'
          },
          {
            label: 'Download',
            event: 'download-report'
          }
        ]
      }
    },

    listeners: {
      'update-last-selected-report-pd-ref': '_updateLastReportPdRef'
    },

    _updateLastReportPdRef: function(e) {
      e.stopImmediatePropagation();
      this.set('lastReportPdRef', e.detail.pdRef);
    },

    requestReportDetails: function(id) {
      let loadingSource = 'report-details';
      let logMsgPrefix = 'report-details-behavior';
      if (!this.currentUser) {
        this.logWarn('Logged user data not init in Redux store.', logMsgPrefix);
        return;
      }

      this.fire('global-loading', {
        message: 'Loading report details...',
        active: true,
        loadingSource: loadingSource
      });

      let endpoint = this.getEndpoint('reportDetails', {
        countryId: this.currentUser.profile.country,
        reportId: id
      });

      let self = this;

      this.sendRequest({endpoint: endpoint}).then(function(response) {
        self.set('report', response);
        self.fire('global-loading', {active: false, loadingSource: loadingSource});
      }).catch(function(error) {
        let errMsg = 'Reports details data request failed!';
        self.logError(errMsg, logMsgPrefix, error);

        // TODO: remove this toast, after API request can be made
        self.fire('toast', {text: errMsg, showCloseBtn: true});

        self.parseRequestErrorsAndShowAsToastMsgs(error, self);
        // self.set('report', null);

        // TODO: remove mockup data use, make sure API request is correct
        self.set('report', self.reportDetailsMockup);

        self.fire('global-loading', {active: false, loadingSource: loadingSource});
      });
    }
  };

  /** @polymerBehavior EtoolsPmpApp.Behaviors.ReportDetails */
  EtoolsPmpApp.Behaviors.ReportDetails = [
    EtoolsLogsBehavior,
    EtoolsAjaxRequestBehavior,
    EtoolsPmpApp.Behaviors.Endpoints,
    EtoolsPmpApp.Behaviors.AjaxErrorsParser,
    EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
    EtoolsPmpApp.Behaviors.ReportsListDataMockup, // TODO: remove this mockup data use
    EtoolsPmpApp.Behaviors.ReportDetailsImpl
  ];
</script>
