<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">


<link rel="import" href="../../../../scripts/lodash/lodash.html">

<link rel="import"
      href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-errors-parser-behavior.html">
<link rel="import" href="../../../app-behaviors/common-behavior.html">
<link rel="import" href="../../../app-behaviors/pagination-behavior.html">
<link rel="import" href="../../../app-elements/environment-flags/environment-flags-behavior.html">

<link rel="import" href="../../../app-config/app-endpoints-behavior.html">
<link rel="import" href="report-status.html">

<link rel="import" href="../../../../styles/app-mixins.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">

<dom-module id="reports-display-list">

  <template strip-whitespace>

    <style include="data-table-styles grid-layout-styles paper-material-styles">
      :host {
        @apply --layout-flex;
        width: 100%;
      }

      div[elevation="1"] {
        @apply --paper-material-elevation-1;
      }

      .pd-ref,
      .view-report {
        @apply --text-btn-style;
      }

      .pd-ref {
        text-transform: none;
      }
    </style>

    <div id="list" elevation="1">

      <template is="dom-if" if="[[!reports.length]]">
        <div class="row-h">
          <p>There are no reports yet.</p>
        </div>
      </template>

      <template is="dom-if" if="[[reports.length]]">
        <etools-data-table-header id="listHeader"
                                  label="[[paginator.visible_range.0]]-[[paginator.visible_range.1]]
                                    of [[paginator.count]] results to show"
                                  no-collapse>

          <template is="dom-if" if="[[!noPdSsfaRef]]" restamp>
            <etools-data-table-column class="col-2">
              PD/SSFA ref.#
            </etools-data-table-column>
          </template>
          <etools-data-table-column class="flex-c">
            Report Status
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            Due Date
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            Date of Submission
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            Date of Acceptance
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            Reporting Period
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
          </etools-data-table-column>
        </etools-data-table-header>

        <template is="dom-repeat" items="[[reports]]" as="report">
          <etools-data-table-row no-collapse>

            <div slot="row-data">
              <template is="dom-if" if="[[!noPdSsfaRef]]" restamp>
                <span class="col-data col-2">
                  <a class="pd-ref truncate"
                     href$="interventions/[[report.programme_document.external_id]]/details"
                     title$="[[getDisplayValue(report.programme_document.reference_number)]]">
                    [[getDisplayValue(report.programme_document.reference_number)]]
                  </a>
                </span>
              </template>
              <span class="col-data flex-c">
                <report-status status="[[report.status]]"></report-status>
              </span>
              <span class="col-data flex-c">
                [[getDateDisplayValue(report.due_date)]]
              </span>
              <span class="col-data flex-c">
               [[getDateDisplayValue(report.submission_date)]]
              </span>
              <span class="col-data flex-c">
                [[getDateDisplayValue(report.review_date)]]
              </span>
              <span class="col-data flex-c">
                [[getDisplayValue(report.reporting_period)]]
              </span>
              <span class="col-data flex-c">
                <a class="view-report"
                   href$="reports/[[report.id]]/progress"
                   hidden$="[[!_canViewReport(report.status)]]">
                  View Report
                </a>
              </span>
            </div>

          </etools-data-table-row>
        </template>

        <etools-data-table-footer
            page-size="[[paginator.page_size]]"
            page-number="[[paginator.page]]"
            total-results="[[paginator.count]]"
            visible-range="{{paginator.visible_range}}"
            on-page-size-changed="pageSizeChanged"
            on-page-number-changed="pageNumberChanged">
        </etools-data-table-footer>

      </template>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'reports-display-list',

        behaviors: [
          EtoolsLogsBehavior,
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.AjaxErrorsParser,
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsPmpApp.Behaviors.Common,
          EtoolsPmpApp.Behaviors.Pagination,
          EtoolsPmpApp.Behaviors.EnvironmentFlags
        ],

        properties: {
          currentUser: {
            type: Object,
            statePath: 'currentUser',
          },
          interventionId: {
            type: Number,
            value: 0
          },
          reports: {
            type: Array,
            value: []
          },
          noPdSsfaRef: {
            type: Boolean,
            value: false
          },
          queryParams: {
            type: Object,
            value: null,
            notify: true
          },
          debounceInterval: {
            type: Number,
            value: 100
          },
          waitQueryParamsInit: Boolean,
          _endpointName: {
            type: String,
            value: 'reports'
          }
        },

        observers: [
          '_loadReportsData(interventionId, currentUser, paginator.page_size, paginator.page, queryParams.*)'
        ],

        _loadReportsData: function(interventionId, currentUser, pageSize, page, qParamsData) {
          if (_.isEmpty(currentUser) || this._queryParamsNotInitialized(qParamsData) || !this.prpServerIsOn()) {
            return;
          }
          let self = this;
          this.debounce('load-reports-data', function() {
            let params = self._prepareReqParamsObj(interventionId);

            self.fire('global-loading', {
              message: 'Loading reports data...',
              active: true,
              loadingSource: 'reports-list'
            });

            let activeReportsReq = self.getActiveRequestByKey(this._endpointName);
            if (activeReportsReq) {
              // abort previous req and then fire a new one with updated params
              self.abortActiveRequest(activeReportsReq);
            }

            self.fireRequest('reports', {}, {params: params}, this._endpointName)
                .then(function(response) {
                  if (response) {
                    self.set('reports', response.results);
                    self.updatePaginatorTotalResults(response);
                  }
                  self.fire('global-loading', {active: false, loadingSource: 'reports-list'});
                })
                .catch(function(error) {
                  if (error.status === 0) {
                    // req aborted
                    return;
                  }
                  let errMsg = 'Reports list data request failed!';
                  self.logError(errMsg, 'reports-list', error);

                  self.parseRequestErrorsAndShowAsToastMsgs(error, self);
                  self.fire('global-loading', {active: false, loadingSource: 'reports-list'});
                });
          }, this.debounceInterval);
        },

        _prepareReqParamsObj: function(interventionId) {
          let params = {};
          if (interventionId > 0) {
            params.programme_document_ext = interventionId;
          }
          params = Object.assign({}, params, this._preserveExistingQueryParams(), this.getRequestPaginationParams());
          return params;
        },

        _canViewReport: function(status) {
          return ['Acc', 'Sen', 'Sub'].indexOf(status) > -1;
        },

        _preserveExistingQueryParams: function() {
          let params = {};
          if (!_.isEmpty(this.queryParams)) {
            Object.keys(this.queryParams).forEach(function(k) {
              if (this.queryParams[k]) {
                params[k] = this.queryParams[k];
              }
            }.bind(this));
          }
          return params;
        },

        _queryParamsNotInitialized: function(qParamsData) {
          return this.waitQueryParamsInit && !qParamsData.value && qParamsData.path === 'queryParams';
        }

      });

    })();
  </script>

</dom-module>
