<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-errors-parser-behavior.html">

<link rel="import" href="../../../../styles/shared-styles.html">

<dom-module id="report-rating-dialog">
  <template>
    <style include="shared-styles">
      [hidden] {
        display: none !important;
      }

      #content-box {
        margin-bottom: 20px;
      }
    </style>
    <etools-dialog
        id="reportRatingDialog"
        size="md"
        keep-dialog-open
        spinner-text="Sending rating..."
        disable-confirm-btn="[[!selectedOverallStatus.length]]"        
        ok-btn-text="Rate & Accept Report"
        cancel-btn-text="Cancel"
        dialog-title="Report for [[pdRefNumber]]: [[reportingPeriod]]"
        on-confirm-btn-clicked="saveStatus">
      <div id="content-box">
          <p> Rate the overall progress of this PD/SSFA in light of this report and monitoring visits. </p>
          <paper-radio-group id="overallStatus" selected="{{selectedOverallStatus}}">
            <paper-radio-button name="Met"> Met </paper-radio-button>
            <paper-radio-button name="OnT"> On track </paper-radio-button>
            <paper-radio-button name="NoP"> No progress </paper-radio-button>
            <paper-radio-button name="Con"> Constrained </paper-radio-button>
          </paper-radio-group>            
      </div>
    </etools-dialog>
  </template>

  <script>
    (function() {
      'use strict';
      /*
        status: 'accepted'/'sent back'
        overall_status: if accepting, the status of things
        comment: required when sending a report back
      */
      Polymer({
        is: 'report-rating-dialog',
        behaviors: [
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.AjaxErrorsParser
        ],        
        properties: {
          endpoint: {
            type: Object,
          },
          toastEventSource: {
            type: Object,
          },
          pdRefNumber: {
            type: String
          },
          reportingPeriod: {
            type: String
          },
          selectedOverallStatus: {
            type: String,
            value: ''
          }
        },

        open: function() { 
          this.set('selectedOverallStatus', '');
          this.$.reportRatingDialog.set('opened', true);
        },

        close: function() {
          this.$.reportRatingDialog.set('opened', false);   
        },

        startSpinner: function() {
          this.$.reportRatingDialog.startSpinner();
        },

        stopSpinner: function() {
          this.$.reportRatingDialog.stopSpinner();
        },

        saveStatus: function() {
          let self = this;
          let requestBody = {
            status: 'accepted',
            overall_status: this.selectedOverallStatus
          };

          this.startSpinner();
          this.sendRequest({method: 'POST', endpoint: this.endpoint, body: requestBody})
            .then(function() {
              self.close();               
            }).catch(function(error) {
              self._handleErrorResponse(error);
            });
        },

        _handleErrorResponse: function(error) {
          this.stopSpinner();
          this.parseRequestErrorsAndShowAsToastMsgs(error, this.toastEventSource);
        },
      });
    })();
  </script>
</dom-module>

