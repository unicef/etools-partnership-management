<link rel="import" href="../../../../../bower_components/promise-polyfill/promise-polyfill-lite.html">

<link rel="import" href="table-content/three-disaggregations.html">
<link rel="import" href="table-content/two-disaggregations.html">
<link rel="import" href="table-content/one-disaggregation.html">
<link rel="import" href="table-content/zero-disaggregations.html">

<link rel="import" href="../../../../app-behaviors/utils-behavior.html">

<link rel="import" href="../../styles/disaggregation-table-styles.html">

<dom-module id="disaggregation-table">
  <template>
    <style include="disaggregation-table-styles">
      .location-progress {
        text-align: right;
      }

      .location-progress dt,
      .location-progress dd {
        display: inline;
        margin: 0;
      }

      .location-progress dt {
        font-weight: bold;
      }
    </style>

    <div>
      <table class="vertical layout">
        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 0)]]"
            restamp="true">
          <zero-disaggregations
              data="[[formattedData]]"
              mapping="[[formattedMapping]]"
              editable="[[editable]]">
          </zero-disaggregations>
        </template>

        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 1)]]"
            restamp="true">
          <one-disaggregation
              data="[[formattedData]]"
              mapping="[[formattedMapping]]"
              editable="[[editable]]">
          </one-disaggregation>
        </template>

        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 2)]]"
            restamp="true">
          <two-disaggregations
              data="[[formattedData]]"
              mapping="[[formattedMapping]]"
              editable="[[editable]]">
          </two-disaggregations>
        </template>

        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 3)]]"
            restamp="true">
          <three-disaggregations
              data="[[formattedData]]"
              mapping="[[formattedMapping]]"
              editable="[[editable]]">
          </three-disaggregations>
        </template>
      </table>
    </div>

  </template>

  <script>
    /**
     * This element is a modified PRP element to fit PMP functionality regarding disaggregation data display.
     * We do not need `disaggregation-switches` element here (for now) and there is no editable data.
     * Minimal changes were made here so we minimize the issues if we update from PRP.
     */
    Polymer({
      is: 'disaggregation-table',

      behaviors: [
        EtoolsPmpApp.Behaviors.Utils
      ],

      properties: {
        /**
         * `editable` and `editableBool` is only kept here because disaggregation elements are common with PRP app,
         * it will always be `0` and `false` in PMP.
         */
        editable: {
          type: Number,
          value: 0,
        },

        data: {
          type: Object,
          observer: '_cloneData'
        },

        formattedData: {
          type: Object
        },

        formattedMapping: {
          type: Array,
          computed: '_computeMapping(editableBool, formattedData, mapping)',
        },

        editableBool: {
          type: Boolean,
          computed: '_computeEditableBool(editable)',
        },

        indicatorType: {
          type: String,
          computed: '_computeIndicatorType(data)',
        },

        fields: Array,
        mapping: Array
      },

      listeners: {
        // no listeners here, in PMP this data is readonly(unlike PRP), no need for handling data/fields change events
      },

      observers: [
        '_resetFields(formattedData.disaggregation_reported_on)',
      ],

      _resetFields: function() {
        this.set('fields', []);
      },

      _computeEditableBool: function(editable) {
        return editable === 1;
      },

      _computeMapping: function(editableBool, formattedData, mapping) {
        let reportedOn = formattedData.disaggregation_reported_on;

        return editableBool ? mapping.filter(function(disagg) {
          return reportedOn.indexOf(disagg.id) !== -1;
        }) : mapping;
      },

      _computeIndicatorType: function(data) {
        return data.display_type;
      },

      _cloneData: function(data) {
        this.set('formattedData', JSON.parse(JSON.stringify(data)));
      }

    });
  </script>
</dom-module>
