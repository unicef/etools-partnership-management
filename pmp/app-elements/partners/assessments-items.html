<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../common-elements/etools-single-file.html">
<link rel="import" href="../common-elements/etools-form-element-wrapper.html">

<link rel="import" href="../common-elements/etools-date-input.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-config/app-constants.html">

<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/file-styles.html">
<link rel="import" href="../validators/required-and-not-future-date-validator.html">

<dom-module id="assessments-items">
  <template strip-whitespace>
    <style
        include="grid-layout-styles shared-styles repeatable-data-sets-styles file-styles buttons-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      .assessments {
        padding-bottom: 24px;
        @apply --layout-vertical-reverse;
      }

      .add-btn-wrapper {
        padding-top: 24px;
      }

      .add-btn-lm {
        margin-left: 46px;
      }

      etools-single-file {
        width: 100%;
      }

      .row-h.file-container {
        padding-bottom: 15px;
      }

      .no-assessments-warning {
        padding-top: 0;
      }

    </style>

    <div class="row-h add-btn-wrapper">
      <paper-button hidden$="[[!editMode]]"
                    on-tap="_addNewAssessment"
                    class$="secondary-btn [[_getAddBtnAdditionalClass(dataItems.length)]]">
        ADD OTHER ASSESSMENT
      </paper-button>
    </div>

    <div class="assessments"
         hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="item-actions-container">

            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled$="[[!editMode]]"
                                 icon="cancel">
              </paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h">
              <div class="col col-4">
                <!-- Assessment type -->
                <etools-form-element-wrapper label="Assessment Type">
                  [[item.type]]
                </etools-form-element-wrapper>
              </div>
              <div class="col col-4">
                <required-and-not-future-date-validator validator-name="dateSubmitted_[[index]]_validator"
                                                        required
                                                        error-message="{{item.dateErrorMessage}}">
                </required-and-not-future-date-validator>
                <!-- Date submitted -->
                <etools-date-input id$="dateSubmitted_[[index]]"
                                   label="Date of Assessment"
                                   value="{{item.completed_date}}"
                                   readonly$="[[!editMode]]"
                                   auto-validate
                                   validator="dateSubmitted_[[index]]_validator"
                                   error-message="[[item.dateErrorMessage]]"
                                   no-init show-clear-btn>
                </etools-date-input>
              </div>
            </div>
            <div class="row-h file-container">
              <!-- Report file -->
              <etools-single-file
                  id$="report_[[index]]"
                  file="{{item.report}}"
                  internal-file="{{item.report_file}}"
                  label="Report"
                  hide-delete-btn="[[_hideDeleteBtn(item.report_file, item.report)]]"
                  readonly="[[!editMode]]"
                  accept=".doc,.docx,.pdf,.jpg,.png"
                  error-message="Please select the report file"></etools-single-file>
            </div>
          </div>
        </div>
      </template>
    </div>

    <div class="row-h no-assessments-warning" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no assessments added.</p>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'assessments-items',

        behaviors: [
          EtoolsPmpApp.Behaviors.RepeatableDataSets,
          EtoolsPmpApp.Behaviors.Constants,
        ],

        properties: {
          _deleteEpName: {
            type: String,
            value: 'partnerAssessmentDelete',
            readOnly: true,
          },
          open: {
            type: Boolean,
            value: true,
            reflectToAttribute: true
          },
          editMode: {
            type: Boolean,
            reflectToAttribute: true,
            observer: '_editModeChanged'
          }
        },

        observers: [
          '_makeSureDataItemsAreValid(dataItems)',
          '_assessmentPropertyChanged(dataItems.*)'
        ],

        ready: function() {
          this.dataSetModel = {
            type: this.AssessmentDefaultType,
            completed_date: null,
            current: false,
            report: null,
            report_file: ''
          };
        },

        _editModeChanged: function() {
          this.updateStyles();
        },

        _hideDeleteBtn: function(itemReportFile) {
          return !!itemReportFile;
        },

        _assessmentPropertyChanged: function(dataPath) {
          if (dataPath.path !== 'dataItems' && dataPath.path !== 'dataItems.splices' &&
              dataPath.path !== 'dataItems.length' && dataPath.path.indexOf('current') === -1) {
            let dataPathPieces = dataPath.path.split('.');
            let path = dataPathPieces[0] + '.' + dataPathPieces[1];
            if (path.indexOf('#') > -1) {
              let item = this.get(path);
              let index = this.dataItems.indexOf(item);
              this._validateAssessment(index);
            }
          }
        },

        _isValid: function(field, completedDate, reportFile, reportFileLength) {
          let valid = true;
          switch (field) {
            case 'dateSubmitted':
              if (_.isEmpty(completedDate) && this._hasReport(reportFile, reportFileLength)) {
                valid = false;
              }
              break;
            case 'report':
              if (!this._hasReport(reportFile, reportFileLength) && !_.isEmpty(completedDate)) {
                valid = false;
              }
              break;
          }
          return valid;
        },

        _hasReport: function(report, reportFileLength) {
          return report instanceof File || reportFileLength > 0;
        },

        _addNewAssessment: function() {
          if (this.editMode) {
            let lastAssessmentAdded = this._getLastDataItem();
            if (this._emptyAssessment(lastAssessmentAdded)) {
              this.fire('toast', {text: 'Last assessment fields are empty!', showCloseBtn: true});
            } else {
              this._addElement();
            }
          }
        },

        validate: function() {
          let valid = true;
          if (this.dataItems instanceof Array && this.dataItems.length > 0) {
            this.dataItems.forEach((item, index) => {
              if (this._emptyAssessment(item) ||
                  (!this._emptyAssessment(item) && !this._validateAssessment(index))) {
                valid = false;
              }
            });
          }
          return valid;
        },

        _validateAssessment: function(index) {
          let valid = true;
          let fields = ['#dateSubmitted_' + index, '#report_' + index];
          fields.forEach((fieldSelector) => {
            let fieldEl = this.$$(fieldSelector);
            let reportFileLength = 0;

            if (typeof this.dataItems[index].report_file === 'string') {
              reportFileLength = this.dataItems[index].report_file.length;
            }
            if (fieldEl) {
              let fieldName = this._getFieldNameFromSelector(fieldSelector);
              let validField = this._isValid(fieldName, this.dataItems[index].completed_date,
                this.dataItems[index].report,
                  reportFileLength, fieldEl);
              fieldEl.invalid = !validField;
              if (!validField) {
                valid = false;
              }
            }
          });

          return valid;
        },

        _emptyAssessment: function(assessment) {
          return assessment &&
              assessment.completed_date === null &&
              assessment.report_file.length === 0 &&
              assessment.report instanceof File === false;
        },

        _getFieldNameFromSelector: function(fieldSelector) {
          if (typeof fieldSelector === 'string' && fieldSelector !== '') {
            return fieldSelector.slice(1).slice(0, fieldSelector.indexOf('_') - 1);
          }
          return '';
        },

        _getAddBtnAdditionalClass: function(shownAssessmentsNumber) {
          return shownAssessmentsNumber ? 'add-btn-lm' : '';
        }

      });
    })();

  </script>
</dom-module>
