<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../../bower_components/etools-checkable-input/etools-checkable-input.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../common-elements/etools-single-file.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">

<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/file-styles.html">

<dom-module id="assessments-items">
  <template>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles file-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;

        --paper-toolbar-height: 40px;
        --paper-toolbar-background: #F2F2F2; /* TODO: replace with app-theme var */
        --paper-toolbar: {
          -webkit-border-radius: 8px;
          -moz-border-radius: 8px;
          border-radius: 8px;
        };
        --paper-toolbar-title: {
          @apply(--nested-content-panel-title);
        };

        --paper-fab-keyboard-focus-background: #8dc63f; /* TODO: replace with app-theme var */
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };

      }

      paper-material {
        padding: 0;
      }

      paper-toolbar paper-icon-button {
        @apply(--nested-content-panel-collapse-btn);
      }

      #assessments-wrapper {
        padding: 15px 0 0;
      }

      #collapse {
        position: relative;
      }

      .action.delete[disabled] {
        visibility: hidden;
      }

      etools-single-file {
        width: 100%;
      }

      .row-h.file-container {
        padding-bottom: 15px;
      }

    </style>
     <etools-ajax id="deleteAjax"
                 on-success="_handleDeleteResponse"
                 on-fail="_handleDeleteError"></etools-ajax>

    <paper-material elevation="[[elevation]]">

      <paper-toolbar>
        <paper-icon-button on-click="_toggle" icon$="[[_getExpandBtnIcon(open)]]"></paper-icon-button>
        <div class="title">Assessments</div>
      </paper-toolbar>

      <iron-collapse id="collapse" opened="{{open}}">
        <div id="assessments-wrapper">
          <div hidden$="[[_emptyList(dataItems.length)]]">
            <template is="dom-repeat" items="{{dataItems}}">
              <div class="row-h item-container">
                <div class="row-h item-actions-container">

                  <div class="row-v actions">
                    <paper-icon-button class="action delete"
                                       on-tap="_openDeleteConfirmation"
                                       data-args$="[[index]]"
                                       disabled$="[[!editMode]]"
                                       icon="cancel"></paper-icon-button>
                  </div>

                </div>
                <div class="row-v flex-c item-content">
                  <div class="row-h">
                    <div class="col col-4">
                      <!-- Assessment type -->
                      <template is="dom-if" if="[[!editMode]]">
                        <paper-input label="Assessment Type"
                                     value="[[item.type]]"
                                     placeholder="&#8212;"
                                     readonly></paper-input>
                      </template>
                      <template is="dom-if" if="[[editMode]]">
                        <etools-searchable-multiselection-menu id$="assessmentType_[[index]]"
                                                               label="Assessment Type"
                                                               options="[[assessmentTypesOptions]]"
                                                               value="[[_getAssessmentType(item)]]"
                                                               on-value-change="_assessmentTypeSelected"
                                                               error-message="Assessment type is required"
                                                               custom-object-options>                                                               
                        </etools-searchable-multiselection-menu>
                      </template>
                    </div>
                    <div class="col col-4">
                      <!-- Date submitted -->
                      <paper-input id$="dateSubmited_[[index]]"
                                   label="Date of Report"
                                   value="[[prettyDate(item.completed_date)]]"
                                   placeholder="&#8212;"
                                   on-down="openDatePicker"
                                   data-selector$="completedDate_[[index]]"
                                   readonly$="[[!editMode]]"
                                   error-message="Date of report is required">
                        <iron-icon prefix icon="date-range" hidden$="[[editMode]]"></iron-icon>
                        <etools-datepicker-button id$="completedDate_[[index]]"
                                                  suffix
                                                  format="YYYY-MM-DD"
                                                  pretty-date="{{item.completed_date}}"
                                                  is-disabled="[[!editMode]]"
                                                  hidden$="[[!editMode]]"
                                                  no-init show-clear-btn>
                        </etools-datepicker-button>
                      </paper-input>
                    </div>
                    <div class="col col-4">
                      <!-- Basis for risk rating checkbox -->
                      <div class="custom-field-wrapper">
                        <etools-checkable-input checked="{{item.current}}"
                                                label="Basis for Risk Rating"
                                                type="radio"
                                                label-alignment="top"
                                                readonly$="[[!editMode]]"
                                                on-value-changed="_basisForRiskRatingChanged"
                                                data-args$="[[index]]"></etools-checkable-input>
                      </div>
                    </div>
                  </div>
                  <div class="row-h file-container">
                    <!-- Report file -->
                    <etools-single-file 
                                  id$="report_[[index]]"
                                  file="{{item.report}}"
                                  internal-file="{{item.report_file}}"
                                  label="Report"
                                  readonly="[[!editMode]]"
                                  accept=".doc,.docx,.pdf,.jpg,.png"
                                  error-message="Please select the report file"></etools-single-file>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
            <p>There are no assessments added.</p>
          </div>

          <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
            <paper-fab icon="add"
                       on-tap="_addNewAssessment"
                       title="Add"></paper-fab>
          </div>
        </div>
      </iron-collapse>

    </paper-material>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'assessments-items',

        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.DateBehavior
        ],

        properties: {
          elevation: {
            type: Number,
            value: 0
          },
          _deleteEpName: {
            type: String,
            value: 'partnerAssessmentDelete',
            readOnly: true,
          },
          assessmentTypesOptions: {
            type: Array,
            value: [],
            statePath: 'assessmentTypes'
          },
        },

        observers: [
          '_dataHasChanged(dataItems)',
          '_assessmentPropertyChanged(dataItems.*)'
        ],

        ready: function() {
          this.dataSetModel = {
            type: null,
            completed_date: null,
            current: false,
            report_file: []
          };      
        },
        _getAssessmentType: function(item) {
          var type = item.type;
          var selectedType = null;
          if (typeof type === 'string' && type !== '') {
            // capitalize value
            //type = type.replace(/\b\w/g, function(l) { return l.toUpperCase() });
            selectedType = this.assessmentTypesOptions.filter(function(option) {
              return option.label === type;
            });
          }
          return selectedType;
        },

        _assessmentTypeSelected: function(event) {
          if (event.model && event.model.index >= 0) {
            var selectedAssessmentType = null;
            if (event.detail.selectedValues !== null) {
              selectedAssessmentType = event.detail.selectedValues.label;
            }
            this.set('dataItems.' + event.model.index + '.type', selectedAssessmentType);
          }
        },

        _dataHasChanged: function(dataItems) {
          // prepare data for assessment reports
          // if (Array.isArray(dataItems) && dataItems.length > 0) {
          //   dataItems.forEach(function(item, index) {
          //     if ((typeof item.report === 'string' && item.report !== '')
          //         && (!Array.isArray(item.report_file) || (Array.isArray(item.report_file)
          //         && item.report_file.length === 0))) {
          //       this.set('dataItems.' + index + '.report_file', [{
          //         id: 'report_file_' + index,
          //         file_name: item.report.substr(item.report.lastIndexOf('/') + 1),
          //         path: item.report
          //       }]);
          //     }
          //   }.bind(this));
          // }
        },

        _assessmentPropertyChanged: function(dataPath) {
          if (dataPath.path !== 'dataItems' && dataPath.path !== 'dataItems.splices' && dataPath.path !== 'dataItems.length') {
            var path = dataPath.path.split('.');
            var index = path[path.length - 2].replace('#', '');
            var fields = ['#assessmentType_' + index, '#dateSubmited_' + index, '#report_' + index];
            fields.forEach(function(fieldSelector) {
              var fieldEl = this.$$(fieldSelector);
              if (fieldEl) {
                var fieldName = fieldSelector.slice(1).slice(0, fieldSelector.indexOf('_') - 1);
                fieldEl.invalid = !this._isValid(fieldName, this.dataItems[index].type, 
                  this.dataItems[index].completed_date, this.dataItems[index].report, this.dataItems[index].report_file.length);
              }
            }.bind(this));
          }
        },

        _basisForRiskRatingChanged: function(event) {
          if (!this.editMode) {
            return;
          }
          if (event.detail.checked === true) {
            var index = parseInt(Polymer.dom(event).localTarget.getAttribute('data-args'));
            for (var i = 0; i < this.dataItems.length; i++) {
              if (i !== index) {
                this.set('dataItems.' + i + '.current', false);
              }
            }
          }
        },

        _notEmpty: function(value) {
          return typeof value !== 'undefined' && value !== null && value !== '';
        },

        _isValid: function(field, assessmentType, completedDate, reportFile, reportFileLength) {
          var valid = true;
          switch (field) {
            case 'assessmentType':
              if (!this._notEmpty(assessmentType) && (this._notEmpty(completedDate) || reportFileLength > 0 || reportFile instanceof File)) {
                valid = false;
              }
              break;
            case 'dateSubmited':
              if (!this._notEmpty(completedDate) && (this._notEmpty(assessmentType) || reportFileLength > 0 || reportFile instanceof File)) {
                valid = false;
              }
              break;
            case 'report':
              if (reportFile instanceof File === false && (this._notEmpty(assessmentType) || this._notEmpty(completedDate))) {
                valid = false;
              }
              break;
          }
          return valid;
        },

        _addNewAssessment: function() {
          if (this.editMode) {
            var lastAssessmentAdded = this._getLastDataItem();
            if (lastAssessmentAdded && lastAssessmentAdded.type === null
                && lastAssessmentAdded.completed_date === null
                && lastAssessmentAdded.report_file.length === 0) {
              this.fire('toast', {text: 'Last assessment fields are empty!', showCloseBtn: true});
            } else {
              this._addElement();
            }
          }
        }

      });
    })();

  </script>
</dom-module>
