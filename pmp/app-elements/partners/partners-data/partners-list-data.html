<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../app-behaviors/list-data-behavior.html">
<link rel="import" href="../../../app-config/app-dexie-db-config.html">
<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="partners-list-data">

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'partners-list-data',

        behaviors: [
          EtoolsPmpApp.Behaviors.ListData,
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore
        ],

        properties: {

          endpointName: {
            type: String,
            value: 'partners'
          },

          dataLoadedEventName: {
            type: String,
            value: 'partners-loaded'
          },

          filteredPartners: {
            type: Array,
            readOnly: true,
            notify: true
          },

          totalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },

          currentQuery: {
            type: Object,
            value: null
          },

          partnersDropdownData: {
            type: Array,
            notify: true
          },

          partnersFilteredDropdownData: {
            type: Array,
            notify: true
          },

          prepareDropdownData: {
            type: Boolean,
            value: false
          }
        },
        actions: {
          setPartnersDropdown: function(partnersDropdownData) {
            return {
              type: 'SET_PARTNERS_DROPDOWN',
              partnersDropdownData: partnersDropdownData
            };
          },
          setPartners: function(partnersData) {
            return {
              type: 'SET_PARTNERS',
              partnersData: partnersData
            };
          },
          setCivilSocietyOrganizationPartners: function(csoPartners) {
            return {
              type: 'SET_CSO_PARTNERS',
              csoPartners: csoPartners
            };
          }
        },

        _handleMyResponse: function(res) {
          this._handleResponse(res);
          if (res && res.length) {
            this.dispatch('setPartners', res);
            let preparedData = [];
            let civilSocietyOrganizationPartners = [];
            res.forEach(function(p) {
              if (!p.hidden && p.partner_type === 'Civil Society Organization') {
                civilSocietyOrganizationPartners.push(p);
              }
              if (!p.hidden) {
                preparedData.push({
                  value: p.id,
                  label: p.name
                });
              }
            });
            this.dispatch('setPartnersDropdown', preparedData);
            this.dispatch('setCivilSocietyOrganizationPartners', civilSocietyOrganizationPartners);
          }
        },

        query: function(field, order, searchString, partnerType, csoType,
                        pageNumber, pageSize, showHidden, showQueryLoading) {

          // If an active query transaction exists, abort it and start
          // a new one
          if (this.currentQuery) {
            this.currentQuery.abort();
          }

          let self = this;

          if (showQueryLoading) {
            this.fire('global-loading', {
              message: 'Loading partners list data...',
              active: true,
              loadingSource: 'partners-list'
            });
          }

          let partnersDexieTable = EtoolsPmpApp.DexieDb.partners;
          EtoolsPmpApp.DexieDb.transaction('r', partnersDexieTable, function() {
            self.currentQuery = Dexie.currentTransaction;

            let queryResult = partnersDexieTable;
            if (field) {
              // note: null values don't appear in result set of sort
              queryResult = queryResult.orderBy(field);
            }
            if (order === 'desc') {
              queryResult = queryResult.reverse();
            }

            queryResult = queryResult.filter(function(partner) {
             return self.filterData(partner, searchString, partnerType, csoType, showHidden);
            });

            // This special Dexie function allows the work of counting
            // the number of query results to be done in a parallel process,
            // instead of blocking the main query
            Dexie.ignoreTransaction(function() {
              queryResult.count(function(count) {
                self._setTotalResults(count);
              });
            });

            return queryResult
                .offset((pageNumber - 1) * pageSize)
                .limit(pageSize)
                .toArray();

          }).then(function(result) {
            self._setFilteredPartners(result);
            self.fire('global-loading', {active: false, loadingSource: 'partners-list'});
          }).catch(function(error) {
            console.error('Error querying partners: ' + error);
            self.fire('global-loading', {active: false, loadingSource: 'partners-list'});
          });
        },

        filterData: function(partner, searchString, partnerType, csoType, showHidden) {
          if (partnerType && partner.partner_type !== partnerType) {
            return false;
          }

          if (csoType && partner.cso_type !== csoType) {
            return false;
          }

          if (searchString && searchString.length) {
            let vnMatch = true;
            if (partner.vendor_number) {
              vnMatch = partner.vendor_number.toString().toLowerCase().indexOf(searchString) < 0;
            }
            if (partner.name.toLowerCase().indexOf(searchString) < 0 &&
                partner.short_name.toLowerCase().indexOf(searchString) < 0 &&
                vnMatch) {
              return false;
            }
          }

          if (!showHidden && partner.hidden) {
            return false;
          }

          return true;
        }

      });
    })();
  </script>

</dom-module>
