<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../../scripts/lodash/lodash.html">

<link rel="import" href="../../../app-behaviors/data-element-behavior.html">

<dom-module id="partners-list-data">

  <template>

    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="partners"
                 on-success="_handleResponse"></etools-ajax>

  </template>

  <script>

    // Load the data we recieve into each active instance
    // of partners-data
    var _setPartnersData = function(data) {
      if (data) {
        _data.partnersIdMap = _.indexBy(data, 'id');
        _data.partnersMultiMap = _.map(data, function(partner) {
          return {value: partner.id, label: partner.name};
        });
      }

      _setData.bind(this)(data);
    };

    Polymer({

      is: 'partners-list-data',

      behaviors: [pmpBehaviors.DataElementBehavior],

      properties: {

        endpointName: {
          type: String,
          value: 'partners'
        },

        idMap: {
          type: Object,
          readOnly: true,
          notify: true
        },

        multiMap: {
          type: Array,
          readOnly: true,
          notify: true
        },

        filteredPartners: {
          type: Array,
          readOnly: true,
          notify: true
        },

        totalResults: {
          type: Number,
          readOnly: true,
          notify: true
        },

        currentQuery: {
          type: Object,
          value: null
        },

        partnersDropdownData: {
          type: Array,
          notify: true
        },

        prepareDropdownData: {
          type: Boolean,
          value: false
        }

      },

      load: function(data) {
        if (data.partners) {
          this._setData(data.partners);
          this._setIdMap(data.partnersIdMap);
          this._setMultiMap(data.partnersMultiMap);

          if (this.prepareDropdownData) {
            this._setPartnersDropdownData(data.partners);
          }
        }
      },

      _handleResponse: function(res) {
        _setPartnersData.bind(this)(res.detail);
      },

      // Get a partner by id
      // Same functionality as partner-data element but
      // without binding
      getPartner: function(id) {
        if (this.idMap) {
          return this.idMap[id];
        }
      },

      query: function(field, order, searchString, partnerType, csoType,
                      pageNumber, pageSize, showHidden) {

        // If an active query transaction exists, abort it and start
        // a new one
        if (this.currentQuery) {
          this.currentQuery.abort();
        }

        var _this = this;

        this.db.transaction('r', this.db.partners, function() {
          this.currentQuery = Dexie.currentTransaction;

          var queryResult = _this.db.partners;
          if (field) {
            // note: null values don't appear in result set of sort
            queryResult = queryResult.orderBy(field);
          }
          if (order === 'desc') {
            queryResult = queryResult.reverse();
          }

          queryResult = queryResult.filter(function(partner) {
            if (partnerType && partner.partner_type !== partnerType) {
              return false;
            }

            if (csoType && partner.cso_type !== csoType) {
              return false;
            }

            if (searchString && searchString.length) {
              var vnMatch = true;
              if (partner.vendor_number) {
                vnMatch = partner.vendor_number.indexOf(searchString) < 0;
              }
              if (partner.name.toLowerCase().indexOf(searchString) < 0 &&
                  partner.short_name.toLowerCase().indexOf(searchString) < 0 &&
                  vnMatch) {
                return false;
              }
            }

            if (!showHidden && partner.hidden) {
              return false;
            }

            return true;
          });

          // This special Dexie function allows the work of counting
          // the number of query results to be done in a parallel process,
          // instead of blocking the main query
          Dexie.ignoreTransaction(function() {
            queryResult.count(function(count) {
              _this._setTotalResults(count);
            });
          });

          return queryResult
            .offset((pageNumber - 1) * pageSize)
            .limit(pageSize)
            .toArray();

        }).then(function(result) {
          _this._setFilteredPartners(result);
        }).catch(function(error) {
          console.error('Error querying partners: ' + error);
        });
      },

      _setPartnersDropdownData: function(partners) {
        var preparedData = [];
        if (partners.length > 0) {
          // TODO: decide how are we gonna get this data ... if it remains like this cache it using dexiejs db
          partners.forEach(function(partner) {
            if (!partner.hidden) {
              preparedData.push({
                value: partner.id,
                label: partner.name
              });
            }
          });
        }
        this.set('partnersDropdownData', preparedData);
      }

    });

  </script>

</dom-module>
