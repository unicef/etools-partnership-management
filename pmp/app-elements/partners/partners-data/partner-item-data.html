<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-behavior.html">

<link rel="import" href="../../../app-config/app-dexie-db-config.html">
<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">
<link rel="import" href="../../../app-elements/static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="partner-item-data">

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'partner-item-data',
        behaviors: [
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsLogsBehavior,
          EtoolsPmpApp.Behaviors.AjaxServerErrors,
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore
        ],
        properties: {
          partner: {
            type: Object,
            readOnly: true,
            notify: true
          },
          partnerId: {
            type: Number,
            notify: true,
            observer: '_partnerIdChanged'
          },
          deletedPartnerId: {
            type: Number,
          },
          handleSuccResponseAdditionalCallback: Object,
          handleErrResponseAdditionalCallback: Object,
          /**
           * ajaxLoadingMsgSource use is required for request errors handling in AjaxServerErrorsBehavior
           */
          ajaxLoadingMsgSource: {
            type: String,
            value: 'partner-data'
          }
        },
        actions: {
          deletePartner: function(partnerId) {
            return {
              type: 'DELETE_PARTNER',
              partnerId: partnerId
            };
          }
        },

        _partnerIdChanged: function(newId) {
          if (newId) {
            // set an empty partner
            this._setPartner({});
            // set the new endpoint
            this.fire('global-loading', {
              message: 'Loading partner data...',
              active: true,
              loadingSource: this.ajaxLoadingMsgSource
            });
            this._triggerPartnerRequest({endpoint: this.getEndpoint('partnerDetails', {id: newId})});
          }
        },

        _triggerPartnerRequest: function(options) {
          let self = this;
          let ajaxMethod = options.method || 'GET';
          this.sendRequest(options).then(function(resp) {
            self._handleSuccResponse(resp, ajaxMethod);
          }).catch(function(error) {
            self._handleErrorResponse(error, ajaxMethod);
          });
        },

        _handleSuccResponse: function(response, ajaxMethod) {
          this._setPartner(response);

          if (typeof this.handleSuccResponseAdditionalCallback === 'function') {
            this.handleSuccResponseAdditionalCallback.bind(this, response)();
            // reset callback
            this.set('handleSuccResponseAdditionalCallback', null);
            this.set('handleErrResponseAdditionalCallback', null);
          }
          let self = this;
          if (['GET', 'DELETE'].indexOf(ajaxMethod) === -1) {
            // update the partners list in dexieDB
            EtoolsPmpApp.DexieDb.table('partners').put(response).then(function() {
              self.fire('reload-list');
            });
          }
          if (ajaxMethod === 'DELETE') {
            this.dispatch('deletePartner', this.deletedPartnerId);
            EtoolsPmpApp.DexieDb.table('partners').delete(this.deletedPartnerId).then(function() {
              self.fire('reload-list');
            });
          }
        },

        _handleErrorResponse: function(response) {
          this.handleErrorResponse(response);

          if (typeof this.handleErrResponseAdditionalCallback === 'function') {
            this.handleErrResponseAdditionalCallback.bind(this,
                this.formatServerErrorAsText(this.tryGetResponseError(response)))();
          }
          this.handleErrResponseAdditionalCallback = null;
          this.handleSuccResponseAdditionalCallback = null;
        },

        createPartner: function(vendorNoObj, successCallback, errorCallback) {
          if (!vendorNoObj && !vendorNoObj.vendor) {
            this.fire('toast', {text: 'Invalid Vendor Number for new partner!', showCloseBtn: true});
            return;
          }

          this.fire('global-loading', {
            message: 'Creating new partner...',
            active: true,
            loadingSource: this.ajaxLoadingMsgSource
          });

          this.handleSuccResponseAdditionalCallback = successCallback;
          this.handleErrResponseAdditionalCallback = errorCallback;

          let endpoint = this.getEndpoint('createPartner', vendorNoObj);
          this._triggerPartnerRequest({method: 'POST', endpoint: endpoint, body: {}});
        },

        deletePartner: function(partner, succCallback, errCallback) {
          if (!partner.id) {
            return;
          }

          this.deletedPartnerId = partner.id;
          this.handleSuccResponseAdditionalCallback = succCallback;
          this.handleErrResponseAdditionalCallback = errCallback;

          let endpoint = this.getEndpoint('deletePartner', {id: partner.id});
          this._triggerPartnerRequest({method: 'POST', endpoint: endpoint, body: {}});
        },

        savePartner: function(partner, callback) {
          if (typeof partner === 'object' && Object.keys(partner).length === 0) {
            this.fire('toast', {text: 'Invalid partner data!', showCloseBtn: true});
          } else {
            let endpoint = null;
            let isNew = false;
            let partnerId = partner.id;
            // remove id from data
            if (partner.id) {
              delete partner.id;
            }
            if (Object.keys(partner).length > 0) {
              if (partnerId) {
                // prepare PATCH endpoint
                endpoint = this.getEndpoint('partnerDetails', {id: partnerId});
              } else {
                // new partner, use POST method for the same endpoint
                endpoint = this.getEndpoint('partners');
                isNew = true;
              }
              // set additional callback if any
              if (callback) {
                this.set('handleSuccResponseAdditionalCallback', callback);
              }
              let withUpload = false; // used to set multipart prop on etools-ajax
              if (partner.hasOwnProperty('core_values_assessment')) {
                if (partner.core_values_assessment instanceof File) {
                  withUpload = true;
                } else {
                  delete partner.core_values_assessment;
                }
              }
              if (partner.hasOwnProperty('assessments')) {

                if ((Array.isArray(partner.assessments)) && (partner.assessments.length > 0)) {

                  partner.assessments = partner.assessments.map(function(assessment) {
                    if (assessment.report instanceof File) {
                      withUpload = true;
                    } else {
                      delete assessment.report;
                    }
                    return assessment;
                  }, this);
                }
              }
              this.fire('global-loading', {
                message: 'Saving partner data...',
                active: true,
                loadingSource: this.ajaxLoadingMsgSource
              });
              // fire in the hole
              let method = (isNew) ? 'POST' : 'PATCH';
              this._triggerPartnerRequest({method: method, endpoint: endpoint, body: partner,
                multiPart: withUpload, prepareMultipartData: withUpload});
            } else {
              this.fire('toast', {
                text: 'There is nothing to save. No change detected on this partner.',
                showCloseBtn: true
              });
            }
          }
        }

      });
    })();
  </script>

</dom-module>
