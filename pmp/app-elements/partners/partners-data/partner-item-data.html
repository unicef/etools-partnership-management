<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<!--<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">-->
<link rel="import" href="../../../app-elements/etools-ajax-v2/etools-ajax.html">

<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">
<link rel="import" href="../../../app-config/etools-app-config.html">

<dom-module id="partner-item-data">

  <template>
    <etools-ajax-2 id="ajax"
                 options="[[options]]"
                 on-success="_handleSuccResponse"
                 on-fail="_handleErrorResponse"></etools-ajax-2>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'partner-item-data',
        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.AjaxServerErrorsBehavior
        ],
        properties: {

          partner: {
            type: Object,
            readOnly: true,
            notify: true
          },

          partnerId: {
            type: Number,
            notify: true,
            observer: '_partnerIdChanged'
          },

          options: {
            type: Object,
            value: {
              endpoint: null
            }
          },

          withUpload: Boolean,
          prepareMultipartData: Boolean,

          handleSuccResponseAdditionalCallback: Object,
          handleErrResponseAdditionalCallback: Object,
          ajaxEl: Object
        },
        attached: function() {
          this.ajaxEl = this.$.ajax;
        },
        _prepareEndpoint: function(partnerId) {
          console.log('prepare endpoint fired');
          if (partnerId > 0) {
            // prepare request endpoint
            this.set('options.endpoint', this.getEndpoint('partnerDetails', {id: partnerId}));
          }
        },
        _partnerIdChanged: function(newId) {
          if (newId) {
            // set an empty partner
            this._setPartner({});
            // set the new endpoint
            this.set('options.endpoint', this.getEndpoint('partnerDetails', {id: newId}));
            this.fire('global-loading', {message: 'Loading partner data...', active: true});
            this._prepareAndFireRequest();
          }
        },
        _prepareAndFireRequest: function(method, data, url, multipart, prepareMultipartData) {
          console.log(this.endpoint);
          if (!multipart) {
            multipart = false;
          }
          if (!prepareMultipartData) {
            prepareMultipartData = false;
          }
          if (!this.ajaxEl) {
            this.ajaxEl = this.$.ajax;
          }

          if (!method) {
            method = 'GET';
            // reset ajax for GET request
            this.set('options.method', null);
            this.set('options.body', null);
            this.set('options.multiPart', null);
            this.set('options.prepareMultipartData', null);
          }

          this.set('options.method', method);
          if (typeof data === 'object' && Object.keys(data).length > 0
              && ['PATCH', 'POST'].indexOf(method) > -1) {

            this.set('options.body', data);
          }
          this.ajaxEl.send().then(function(data) {
            console.log('and the data is', data);
            this._handleSuccResponse(data);
          }.bind(this));
        },

        _handleSuccResponse: function(response) {
          this._setPartner(response);

          if (typeof this.handleSuccResponseAdditionalCallback === 'function') {
            this.handleSuccResponseAdditionalCallback.bind(this, response)();
            // reset callback
            this.set('handleSuccResponseAdditionalCallback', null);
            this.set('handleErrResponseAdditionalCallback', null);
          }

          if (!this.get('options.method') || this.get('options.method') !== 'GET') {
            var self = this;
            // update the partners list in dexieDB
            etoolsAppConfig.db.table('partners').put(response).then(function() {
              self.fire('reload-list');
            });
          }
        },

        _handleErrorResponse: function(response) {
          this.handleErrorResponse(response);

          if (typeof this.handleErrResponseAdditionalCallback === 'function') {
            this.handleErrResponseAdditionalCallback.bind(this, this.tryGetResponseErrorMsg(response))();
          }
          this.handleErrResponseAdditionalCallback = null;
        },

        hidePartner: function(partner) {
          if (typeof partner === 'object' && Object.keys(partner).length === 0) {
            this.fire('toast', {text: 'Invalid partner data!', showCloseBtn: true});
            return;
          }

          this._prepareEndpoint(partner.id);
          delete partner.id;
          this.set('options.method', 'PATCH');
          this.set('options.body', partner);
          this.ajaxEl.send();
        },

        createPartner: function(vendorNoObj, successCallback, errorCallback) {
          if (!vendorNoObj && !vendorNoObj.vendor) {
            this.fire('toast', {text: 'Invalid Vendor Number for new partner!', showCloseBtn: true});
            return;
          }

          this.fire('global-loading', {message: 'Creating new partner...', active: true});

          this.handleSuccResponseAdditionalCallback = successCallback;
          this.handleErrResponseAdditionalCallback = errorCallback;

          this.set('options.endpoint', this.getEndpoint('createPartner', vendorNoObj));
          this.set('options.method', 'POST');
          this.set('options.body', {});
          this.ajaxEl.send();
        },

        savePartner: function(partner, callback) {
          if (typeof partner === 'object' && Object.keys(partner).length === 0) {
            this.fire('toast', {text: 'Invalid partner data!', showCloseBtn: true});
          } else {
            var isNew = false;
            var url = null;
            if (partner.id) {
              // prepare PATCH endpoint
              this._prepareEndpoint(partner.id);
            } else {
              // new partner, use POST method for the same endpoint
              var partnersEndpoint = this.getEndpoint('partners');
              isNew = true;
            }
            // remove id from data
            if (partner.id) {
              delete partner.id;
            }
            if (Object.keys(partner).length > 0) {
              // set additional callback if any
              if (callback) {
                this.set('handleSuccResponseAdditionalCallback', callback);
              }
              // this.withUpload = false; // used to set multipart prop on etools-ajax
              // this.prepareMultipartData = false;
              // if (partner.hasOwnProperty('core_values_assessment')) {
              //   if (partner.core_values_assessment instanceof File) {
              //     this.withUpload = true;
              //     this.prepareMultipartData = true;
              //   } else {
              //      delete partner.core_values_assessment;
              //   }
              // }
              // if (partner.hasOwnProperty('assessments')) {

              //   if ((Array.isArray(partner.assessments)) && (partner.assessments.length > 0)) {

              //     partner.assessments = partner.assessments.map(function(assessment) {
              //         if (assessment.report instanceof File) {
              //           this.withUpload = true;
              //           this.prepareMultipartData = true;
              //         } else {
              //           delete assessment.report;
              //         }
              //         return assessment;
              //     }, this);
              //   }
              // }
              this.fire('global-loading', {message: 'Saving partner data...', active: true});
              // fire in the hole
              var action = (isNew) ? 'POST' : 'PATCH';
              this._prepareAndFireRequest(action, partner, url, this.withUpload, this.prepareMultipartData);
            } else {
              this.fire('toast', {
                text: 'There is nothing to save. No change detected on this partner.',
                showCloseBtn: true
              });
            }
          }
        }

      });
    })();
  </script>

</dom-module>
