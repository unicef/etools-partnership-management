<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">

<dom-module id="partner-item-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="dexie"
                 on-success="_handleResponse"
                 on-fail="_handleErrorResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'partner-item-data',
        behaviors: [etoolsAppConfig.globals],
        properties: {

          partner: {
            type: Object,
            readOnly: true,
            notify: true
          },
          endpoint: {
            type: Object,
            reflectToAttribute: true
          },

          partnerId: {
            type: Number,
            notify: true,
            observer: '_partnerIdChanged'
          },

          handleResponseAdditionalCallback: Object,
          ajaxEl: Object

        },
        attached: function() {
          this.ajaxEl = this.$.ajax;
        },
        _prepareEndpoint: function(partnerId) {
          if (partnerId > 0) {
            // check and prepare request URL
            if (!this.endpoint || (this.endpoint && !this.endpoint.url)) {
              this.set('endpoint', this.getEndpoint('partnerDetails', {id: partnerId}));
            }
          }
        },
        _partnerIdChanged: function(newId) {
          if (newId) {
            // set an empty partner
            this._setPartner({});
            // set the new endpoint
            //TODO: fire a loading event from here or etools ajax for side page load
            //this.$.fire('partial-loading', {element:'Partner Details'})
            this.$.ajax.set('endpoint', this.getEndpoint('partnerDetails', {id: newId}));
          } else {
            this._prepareAndFireRequest(null);
          }
        },
        _prepareAndFireRequest: function(method, data, url, multipart, customMultipartData) {
          if (!multipart){
            multipart = false;
          }
          if (!customMultipartData){
            customMultipartData = false;
          }
          this.ajaxEl.setContentType(null);
          if (!method) {
            method = 'GET';
            // reset ajax for GET request
            this.ajaxEl.set('params', null);
            this.ajaxEl.set('body', null);
            this.ajaxEl.set('url', null);
            this.ajaxEl.set('multiPart', false);
            this.ajaxEl.set('customMultipartData', false);
          }
          this.ajaxEl.set('method', method);
          if (((typeof data === 'object' && Object.keys(data).length > 0) || (data instanceof FormData))
              && ['PATCH', 'POST'].indexOf(method) > -1) {
            if (multipart) {
              this.ajaxEl.set('multiPart', true);
            } else {
              this.ajaxEl.set('multiPart', false);
            }
            if (customMultipartData) {
              this.ajaxEl.set('customMultipartData', true);
            } else {
              this.ajaxEl.set('customMultipartData', false);
            }
            this.ajaxEl.set('body', data);
            this.ajaxEl.set('url', url);
          }
          // after body is set the request is automatically triggered
        },

        _handleResponse: function(response) {
          this._setPartner(response.detail);
          this.fire('global-loading', {active: false});
          if (typeof this.handleResponseAdditionalCallback === 'function') {
            this.handleResponseAdditionalCallback.bind(this, response.detail)();
            // reset callback
            this.set('handleResponseAdditionalCallback', null);
          }
        },

        _preparePartnerMultipartFormData: function(partnerData, exceptionsList) {
          var body = new FormData();
          Object.keys(partnerData).forEach(function(key) {
            var data = partnerData[key];
            if (exceptionsList.indexOf(key) === -1) {
              body.append(key, JSON.stringify(data));
            } else {
              // setup form data array, that can be
              if (Array.isArray(data) && data.length > 0) {
                // array of objects (assessments)
                data.forEach(function(d, index) {
                  Object.keys(d).forEach(function(dKey) {
                    body.append(key + '[' + index + '][' + dKey + ']', d[dKey]);
                  });
                });
              } else {
                // empty assessments array, core values assessment File
                body.append(key, data);
              }
            }
          });
          return body;
        },

        _checkForAssessmentsFiles: function(assessments) {
          var hasF = false;
          for(var i = 0; i < assessments.length; i++) {
            if (assessments[i].report_file instanceof File || assessments[i].report_file instanceof Blob) {
              hasF = true;
              break;
            }
          }
          return hasF;
        },

        savePartner: function(partner, callback) {
          if (typeof partner === 'object' && Object.keys(partner).length === 0) {
            this.fire('toast', {text: 'Invalid partner data!', showCloseBtn: true});
          } else {
            var url = null;
            var isNew = false;

            if (partner.id) {
              // prepare PATCH endpoint
              this._prepareEndpoint(partner.id);
              url = this.endpoint.url;
            } else {
              // new partner, use POST method for the same endpoint
              var partnersEndpoint = this.getEndpoint('partners');
              url = partnersEndpoint.url;
              isNew = true;
            }
            // remove id from data
            if (partner.id) {
              delete partner.id;
            }
            if (Object.keys(partner).length > 0) {
              // set additional callback if any
              if (callback) {
                this.set('handleResponseAdditionalCallback', callback);
              }
              var withUpload = false; // used to set multipart prop on etools-ajax
              var customMultipartData = false;
              var partnerFormDataData = null;
              if ((partner.hasOwnProperty('core_values_assessment_file')
                  && partner.core_values_assessment_file instanceof File)
                  || this._checkForAssessmentsFiles(partner.assessments)) {

                withUpload = true;
                customMultipartData = true;

                // prepare partner multipart data using FormData
                partnerFormDataData = this._preparePartnerMultipartFormData(partner,
                    ['core_values_assessment_file', 'assessments']);
              }
              console.log('data to update', (withUpload ? partnerFormDataData : partner));

              this.fire('global-loading', {message: 'Saving partner data...', active: true});
              // fire in the hole
              this._prepareAndFireRequest(((isNew) ? 'POST' : 'PATCH'),
                  (withUpload ? partnerFormDataData : partner), url, withUpload, customMultipartData);
            } else {
              this.fire('toast', {
                text: 'There is nothing to save. No change detected on this partner.',
                showCloseBtn: true
              });
            }
          }
        },
        // TODO:  refactor this, add it in a behavior
        _handleErrorResponse: function(response) {
          this.fire('global-loading', {active: false});
          var errors = response.detail.request.detail.request.response;
          if (this.ajaxEl.method === 'POST' || this.ajaxEl.method === 'PATCH') {
            // TODO: improve etools-ajax on-fail event data model (received errors)
            var errorMessage = 'An error occurred during partner save!';
            if (errors) {
              var errorMessages = ['Errors occurred:\n'];
              if (Array.isArray(errors) && errors.length > 0) {
                errors.forEach(function(err) {
                  errorMessages.push(err + '\n');
                });
              } else if (typeof errors === 'object' && Object.keys(errors).length > 0) {
                for (var errField in errors) {
                  if (typeof errors[errField] === 'string') {
                    errorMessages.push('Field ' + errField + ' - ' + errors[errField] + "\n");
                  } else if (typeof errors[errField] === 'object' && Object.keys(errors[errField]).length > 0) {
                    for (var errF in errors[errField]) {
                      errorMessages.push('Field ' + errField + '(' + errF + ') - ' + errors[errField][errF] + "\n");
                    }
                  } else if (Array.isArray(errors[errField]) && errors[errField].length > 0) {
                    errors[errField].forEach(function(err) {
                      errorMessages.push(err + "\n");
                    });
                  }
                }
              }
              if (errorMessages.length > 1) {
                errorMessage = errorMessages.join('');
              }
            }
            this.fire('toast', {text: errorMessage, showCloseBtn: true});
          }
        }

      });
    })();
  </script>

</dom-module>
