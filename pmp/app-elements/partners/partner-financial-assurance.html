<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-data-table/etools-data-table-column.html">
<link rel="import" href="../../../bower_components/etools-data-table/etools-data-table-footer.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">


<link rel="import" href="../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../common-elements/etools-single-file.html">
<link rel="import" href="../common-elements/etools-error-messages-box.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-single-selection-menu.html">

<link rel="import" href="../../app-behaviors/common-behavior.html">
<link rel="import" href="../../app-config/app-endpoints-behavior.html"/>
<link rel="import" href="../../app-config/app-config.html"/>
<link rel="import" href="../../app-behaviors/ajax-server-errors-behavior.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">
<link rel="import" href="../../app-behaviors/lists-common-behavior.html">
<link rel="import" href="../../../bower_components/etools-currency-amount-input/etools-currency-behavior.html">


<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/page-common-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/risk-rating-styles.html">

<link rel="import" href="../../../bower_components/moment-element/moment-import.html">
<link rel="import" href="assessments-items.html">


<dom-module id="partner-financial-assurance">
  <template>
    <style include="page-common-styles grid-layout-styles shared-styles">

      :host {
        --paper-radio-button-label-spacing: 0px;
        --paper-input-container-input-webkit-spinner: {
          -webkit-appearance: none;
          margin: 0;
        };
      }

      etools-content-panel.engagements > div {
        padding: 0 24px;
        background-color: var(--light-theme-background-color);
      }

      .panel-table-row {
        border-bottom: 1px solid var(--list-divider-color, #9D9D9D);
        @apply --layout-center;
      }

      .view-only {
        background-color: #FAFAFA;
      }

      etools-data-table-column, .table-title {
        font-weight: 500;
      }

      .panel-row-tall {
        height: 56px;
        box-sizing: border-box;
      }

      .panel-row-extra-tall {
        height: 72px;
        box-sizing: border-box;
      }

      .overview-header {
        background-color: var(--medium-theme-background-color, #eeeeee);
        @apply --layout-center;
      }

      .risk-rating {
        @apply(--risk-rating-color);
        width: 4px;
        margin-right: 8px;
      }

      .overview-row {
        padding-left: 48px;
        @apply --layout-center;
      }

      .assessment-row {
        height: 48px;
        font-size: 13px;
        color: var(--list-text-color, #2b2b2b);
      }

      .assessments {
        margin-top: 24px;
      }

      .report {
        color: var(--primary-color, #0099ff);
        cursor: pointer;
        margin-left: -8px;
        padding-left: 24px;
        @apply --layout-center;
      }

      .vision {
        position: relative;
        width: 66.66667%;
        font-size: 16px;
        border: 2px solid rgba(0, 97, 233, 0.38);
        height: 56px;
        margin-left: -24px;
        padding-left: 24px;
        line-height: normal;
        @apply --layout-center;
        box-sizing: content-box;
      }

      .audits {
        margin-left: 56px;
      }

      .from-vision {
        position: absolute;
        color: var(--secondary-color);
        font-size: 12px;
        font-weight: 500;
        padding: 0 8px;
        top: -9px;
        left: 12px;
        background: var(--primary-background-color);
      }

      .green {
        color: var(--paper-green-500);
      }

      .hact-values {
        font-size: 19px;
      }

      .planning-wrapper {
        padding: 24px;
        font-size: 12px;
      }

      .spot-checks .row-h {
        padding-right: 0;
      }

      .table-main div:not(:first-child) {
        color: var(--secondary-text-color);
        font-weight: 500;
      }

      .table-main div.totals {
        font-size: 16px;
        color: var(--primary-text-color);
        height: 71px;
        @apply --layout-center-center;
      }

      .quarter {
        display: flex;
        flex: 1;
        @apply --layout-center-justified;
      }

      paper-input {
        text-align: center;
        width: 35px;
        font-size: 16px;
        color: var(--primary-text-color);
      }

      .self-end {
        @apply --layout-self-end;
      }

    </style>

    <etools-content-panel
        panel-title="Overview"
        class="content-section"
    >
      <div class="panel-row-tall overview-header overview-row row-h layout-horizontal">
        <etools-data-table-column class="col-2">
          Risk Rating
        </etools-data-table-column>
        <etools-data-table-column class="col-4">
          Basis For Risk Rating - Date of Assessment
        </etools-data-table-column>
        <etools-data-table-column class="col-2 col">
          Cash Transfers (USD)<br> (Jan-Dec)
        </etools-data-table-column>
        <etools-data-table-column class="col-2 col">
          SPOT CHECKS <br> Done / MR
        </etools-data-table-column>
        <etools-data-table-column class="col-2 col">
          AUDIT <br> Done / MR
        </etools-data-table-column>
      </div>
      <div class="row-h overview-row">
        <div class="layout-horizontal vision">
          <div class="from-vision">from VISION</div>
          <div class="layout-horizontal col-3">
            <div class="risk-rating"></div>
            [[partner.rating]]
          </div>
          <div class="col-6">[[partner.basis_for_risk_rating]]</div>
          <div class="col-3 col">
            $[[displayCurrencyAmount(partner.total_ct_cy, '0', 0)]]
          </div>
        </div>
        <div class="col-2 col  hact-values">
          <strong>
            <span class="green">[[partner.hact_values.spot_checks.completed.total]] </span>
            / [[partner.hact_min_requirements.spot_checks]]
          </strong>
        </div>
        <div class="col-2 col  hact-values">
          <strong>
            <span class="green">[[partner.hact_values.audits.completed]] </span>
            / [[partner.hact_values.audits.minimum_requirements]]
          </strong>
        </div>
      </div>
      <div class="row-h center overview-row">
        <div class="col-2"></div>
        <div class="col-4">
          <etools-single-selection-menu label="Basis For Risk Rating"
                                        options="[[basisOptions]]"
                                        selected="{{partner.basis_for_risk_rating}}"
                                        disabled="[[!editMode]]"
                                        avoid-header-overlapping-dropdown
          ></etools-single-selection-menu>
        </div>
      </div>


    </etools-content-panel>

    <etools-content-panel
        panel-title="[[_getYear()]] Financial Assurance Planning"
        class="content-section"
    >
      <div class="planning-wrapper">
        <div class="layout-horizontal">
          <div class="table-main col-6 layout-vertical spot-checks">
            <div class="table-main panel-row-tall row-h panel-table-row  view-only">
              <div class="col-4 table-title">SPOT CHECKS</div>
              <div class="quarter">Q1</div>
              <div class="quarter">Q2</div>
              <div class="quarter">Q3</div>
              <div class="quarter">Q4</div>
              <div class="col-2 center-align">TOTAL</div>
            </div>
            <div class="panel-row-extra-tall row-h panel-table-row  center">
              <div class="col-4">Minimum Required(1)</div>
              <div class="quarter">
                <paper-radio-button
                    data-idx="q1"
                    on-tap="_toggleRadio"
                    toggles=false
                    disabled="[[!!partner.planned_engagement.spot_check_required]]"
                    checked="[[!!partner.planned_engagement.spot_check_mr.q1]]">
                </paper-radio-button>
              </div>
              <div class="quarter">
                <paper-radio-button
                    data-idx="q2"
                    on-tap="_toggleRadio"
                    toggles=false
                    disabled="[[!!partner.planned_engagement.spot_check_required]]"
                    checked="[[!!partner.planned_engagement.spot_check_mr.q2]]">
                </paper-radio-button>
              </div>
              <div class="quarter">
                <paper-radio-button
                    data-idx="q3"
                    on-tap="_toggleRadio"
                    toggles=false
                    disabled="[[!!partner.planned_engagement.spot_check_required]]"
                    checked="[[!!partner.planned_engagement.spot_check_mr.q3]]">
                </paper-radio-button>
              </div>
              <div class="quarter">
                <paper-radio-button
                    data-idx="q4"
                    on-tap="_toggleRadio"
                    toggles=false
                    disabled="[[!!partner.planned_engagement.spot_check_required]]"
                    checked="[[!!partner.planned_engagement.spot_check_mr.q4]]">
                </paper-radio-button>
              </div>
              <div class="col-2 view-only totals layout-horizontal">
                <strong>[[partner.planned_engagement.spot_check_required]]</strong>
              </div>
            </div>

            <div class="panel-row-extra-tall row-h panel-table-row ">
              <div class="col-4">Follow-up Required(1)</div>
              <div class="quarter">
                <paper-input
                    no-label-float=""
                    type="number"
                    value="{{partner.planned_engagement.spot_check_follow_up_q1}}"
                    on-value-changed="_calculateFollowUpTotal"
                    disabled="[[!editMode]]"
                    max="2"
                >
                </paper-input>
              </div>
              <div class="quarter">
                <paper-input
                    no-label-float=""
                    type="number"
                    value="{{partner.planned_engagement.spot_check_follow_up_q2}}"
                    on-value-changed="_calculateFollowUpTotal"
                    disabled="[[!editMode]]"
                    max="2">
                </paper-input>
              </div>
              <div class="quarter">
                <paper-input
                    no-label-float=""
                    type="number"
                    value="{{partner.planned_engagement.spot_check_follow_up_q3}}"
                    on-value-changed="_calculateFollowUpTotal"
                    disabled="[[!editMode]]"
                    max="2">
                </paper-input>
              </div>
              <div class="quarter">
                <paper-input
                    no-label-float=""
                    type="number"
                    value="{{partner.planned_engagement.spot_check_follow_up_q4}}"
                    on-value-changed="_calculateFollowUpTotal"
                    disabled="[[!editMode]]"
                    max="2">
                </paper-input>
              </div>
              <div class="col-2 view-only totals layout-horizontal center-align">
                <strong>[[partner.planned_engagement.total_spot_check_follow_up_required]]</strong>
              </div>
            </div>
          </div>

          <div class="table-main col-3 layout-vertical audits">
            <div class="table-main panel-row-tall row-h panel-table-row view-only">
              <div class="flex-c table-title">AUDITS</div>
              <div class="col-5">Required?</div>
            </div>
            <div class="panel-row-extra-tall row-h panel-table-row ">
              <div class="flex-c">Scheduled Audit</div>
              <div class="col-5 self-end">
                <etools-single-selection-menu
                    options="[[auditOptions]]"
                    selected="{{scheduledAuditRequired}}"
                    hide-search
                    disabled="[[!editMode]]"
                >
                </etools-single-selection-menu>
              </div>
            </div>
            <div class="panel-row-extra-tall row-h panel-table-row ">
              <div class="flex-c">Special Audit</div>
              <div class="col-5 self-end">
                <etools-single-selection-menu
                    options="[[auditOptions]]"
                    selected="{{specialAuditRequired}}"
                    hide-search
                    disabled="[[!editMode]]"
                >
                </etools-single-selection-menu>
              </div>
            </div>
          </div>
        </div>
      </div>
    </etools-content-panel>

    <etools-content-panel
        show-expand-btn
        class="content-section engagements"
        panel-title="Assessments ([[allEngagements.length]])">
      <div class="panel-row-tall panel-table-row layout-horizontal">
        <etools-data-table-column class="col-3">
          Engagement Type
        </etools-data-table-column>
        <etools-data-table-column class="col-2">
          Date
        </etools-data-table-column>
        <etools-data-table-column class="col-2">
          Amount Tested <br>(USD)
        </etools-data-table-column>
        <etools-data-table-column class="col-3 col">
          Outstanding Findings <br>(USD)
        </etools-data-table-column>
        <etools-data-table-column class="col">
          Report
        </etools-data-table-column>
      </div>
      <template is="dom-repeat" items="[[engagements]]">
        <div class="assessment-row panel-table-row layout-horizontal">
          <div class="col-3">[[_displayType(item.engagement_type)]]</div>
          <div class="col-2">[[prettyDate(item.status_date)]]</div>
          <div class="col-2">[[displayCurrencyAmount(item.amount_tested, 0, 0)]]</div>
          <div class="col-3 col">[[displayCurrencyAmount(item.outstanding_findings,0,0)]]</div>
          <a class="report col"
             href="[[baseSite]]/ap/audits/[[item.id]]/overview"
             on-tap="_goToReport">
            <paper-icon-button icon="icons:open-in-new">
            </paper-icon-button>
            View Report
          </a>
        </div>
      </template>
      <etools-data-table-footer
          page-size="[[pageSize]]"
          page-number="[[pageNumber]]"
          total-results="[[totalResults]]"
          visible-range="{{visibleRange}}"
          on-page-size-changed="_pageSizeChanged"
          on-page-number-changed="_pageNumberChanged">
      </etools-data-table-footer>
    </etools-content-panel>

    <etools-content-panel
        panel-title="Other Assessments([[partner.assessments.length]])"
        class="content-section"
    >
      <div class="assessments">
        <assessments-items id="assessmentsList" data-items="{{partner.assessments}}"
                           edit-mode="[[editMode]]"></assessments-items>
      </div>
    </etools-content-panel>

  </template>


  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'partner-financial-assurance',

        behaviors: [
          EtoolsPmpApp.Behaviors.Common,
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Config,
          EtoolsPmpApp.Behaviors.AjaxServerErrors,
          EtoolsPmpApp.Behaviors.ListsCommon,
          etoolsBehaviors.EtoolsCurrencyBehavior,
        ],
        observers: [
          '_paginate(pageNumber,pageSize)'
        ],
        properties: {
          engagements: {
            type: Array,
            value: []
          },
          allEngagements: {
            type: Array,
          },
          ajaxOptions: {
            type: Object,
            value: {
              endpoint: null,
              params: {},
              csrf: true,
            }
          },
          visibleRange: {
            type: Array,
          },
          partner: {
            type: Object,
            observer: '_partnerReceived'
          },
          TYPES: {
            type: Object,
            value: {
              'audit': 'Audit',
              'ma': 'Micro Assessment',
              'sc': 'Spot Check',
              'sa': 'Special Audit'
            }
          },
          RISKRATINGCOLORS: {
            type: Object,
            value: {
              'Not Required': '#D8D8D8',
              'Low': '#2FB0F2',
              'Medium': '#FFCC00',
              'Significant': '#F05454',
              'High': '#740E0E'
            }
          },
          basisOptions: {
            type: Array,
            value: []
          },
          scheduledAuditRequired: {
            type: String,
            observer: '_scheduledAuditChanged'
          },
          specialAuditRequired: {
            type: String,
            observer: '_specialAuditChanged'
          },
          auditOptions: {
            type: Array,
            value: [
              {
                label: 'NO',
                value: 'NO'
              },
              {
                label: 'YES',
                value: 'YES'
              }
            ]
          }
        },

        attached () {
          /**
           * Disable loading message for details tab elements load,
           * triggered by parent element on stamp or by tap event on tabs
           */
          this.fire('global-loading', {active: false, loadingSource: 'partners-page'});
          this.fire('tab-content-attached');
        },

        _init (engagements) {
          this.set('allEngagements', engagements);
          this.set('totalResults', engagements.length);
          if (!this.pageSize) {
            this.set('pageSize', 5);
            this.set('pageNumber', 1);
          } else {
            this._paginate();
          }
          this._addBasisFromEngagements(engagements);
        },

        _displayType (type) {
          return this.TYPES[type];
        },

        _partnerReceived (partner) {
          if (_.keys(partner).length < 2) {
            return;
          }
          this.set('ajaxOptions', _.assign({}, this.ajaxOptions, {
            endpoint: this.getEndpoint('engagements'),
            params: {
              ordering: 'unique_id',
              status: 'final',
              partner: partner.id
            }
          }));
          this.sendRequest(this.ajaxOptions).then((results) => this._init(results)).catch(err => this.handleErrorResponse(err));
          this.set('basisOptions', []);
          this.set('specialAuditRequired', !partner.planned_engagement.special_audit ? 'NO' : 'YES');
          this.set('scheduledAuditRequired', !partner.planned_engagement.scheduled_audit ? 'NO' : 'YES');
          this._addBasisFromPartner();
          this._applyRiskRatingColor();
        },

        _addBasisFromPartner () {
          this.set('basisOptions', [
            ...this.basisOptions,
            ...this.partner.assessments.map(a => ({
              label: `${a.type} - ${this.prettyDate(a.completed_date)}`,
              value: `${a.type} - ${this.prettyDate(a.completed_date)}`
            }))
          ]);
        },

        _addBasisFromEngagements (engagements) {
          this.set('basisOptions', [
            ...this.basisOptions,
            ...engagements.map(e => ({
              label: `${this.TYPES[e.engagement_type]} - ${this.prettyDate(e.status_date)}`,
              value: `${this.TYPES[e.engagement_type]} - ${this.prettyDate(e.status_date)}`
            }))
          ]);
        },

        _paginate () {
          const engagements = this.allEngagements.slice((this.pageNumber - 1) * this.pageSize, this.pageNumber * this.pageSize);
          this.set('engagements', engagements);
        },

        _goToReport: ({model: {item: {id}}, detail: {sourceEvent}}) => {
          const path = `${window.location.origin}/ap/audits/${id}/overview`;
          if (!sourceEvent.ctrlKey && !sourceEvent.metaKey) {
            window.location.href = path;
          }
        },

        _validatePageData () {
          return this.$.assessmentsList.validate();
        },

        _applyRiskRatingColor () {
          this.customStyle['--risk-rating-color'] = `background: ${this.RISKRATINGCOLORS[this.partner.rating]}`;
          this.updateStyles();
        },

        _getYear () {
          return moment().year();
        },

        _toggleRadio ({target}) {
          const checked = target.checked;
          const quarter = target.getAttribute('data-idx');
          let spotChecksMr = _.assign({
            q1: 0,
            q2: 0,
            q3: 0,
            q4: 0
          }, {
            [quarter]: checked ? 1 : 0
          });
          this.set('partner.planned_engagement.spot_check_mr', spotChecksMr);
        },

        _calculateFollowUpTotal () {
          this.set('partner.planned_engagement.total_spot_check_follow_up_required',
            _.sum([
              Number(this.partner.planned_engagement.spot_check_follow_up_q1),
              Number(this.partner.planned_engagement.spot_check_follow_up_q2),
              Number(this.partner.planned_engagement.spot_check_follow_up_q3),
              Number(this.partner.planned_engagement.spot_check_follow_up_q4),
            ]));
        },

        _specialAuditChanged (value) {
          this.set("partner.planned_engagement.special_audit", value !== 'NO');
        },

        _scheduledAuditChanged (value) {
          this.set("partner.planned_engagement.special_audit", value !== 'NO');
        }

      });
    })();
  </script>
</dom-module>
