<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/etools-checkable-input/etools-checkable-input.html">

<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-elements/common-elements/etools-form-element-wrapper.html">

<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<dom-module id="staff-members">
  <template strip-whitespace>
    <style include="grid-layout-styles shared-styles repeatable-data-sets-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;

        --paper-fab-keyboard-focus-background: var(--success-color);
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        };
      }

      paper-icon-button[disabled] {
        visibility: hidden;
      }

    </style>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="item-actions-container">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 disabled="[[!_canBeRemoved(item.id)]]"
                                 icon="cancel"></paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h">
              <div class="col col-4">
                <!-- Title -->
                <paper-input id$="title_[[index]]"
                             label="Position"
                             value="{{item.title}}"
                             placeholder="&#8212;"
                             readonly$="[[!editMode]]"
                             invalid$="[[!_isValid('title', item.title, item.first_name, item.last_name, item.email, item.phone, index)]]"
                             error-message="Position is required">
                </paper-input>
              </div>
              <div class="col col-4">
                <!-- First Name -->
                <paper-input id$="firstName_[[index]]"
                             label="First Name"
                             value="{{item.first_name}}"
                             placeholder="&#8212;"
                             readonly$="[[!editMode]]"
                             invalid$="[[!_isValid('firstName', item.title, item.first_name, item.last_name, item.email, item.phone, index)]]"
                             error-message="First name is required">
                </paper-input>
              </div>
              <div class="col col-4">
                <!-- Last Name -->
                <paper-input id$="lastName_[[index]]"
                             label="Last Name"
                             value="{{item.last_name}}"
                             placeholder="&#8212;"
                             readonly$="[[!editMode]]"
                             invalid$="[[!_isValid('lastName', item.title, item.first_name, item.last_name, item.email, item.phone, index)]]"
                             error-message="Last name is required">
                </paper-input>
              </div>
            </div>
            <div class="row-h">
              <div class="col col-4">
                <!-- Phone number -->
                <paper-input id$="phone_[[index]]"
                             label="Phone number"
                             value="{{item.phone}}"
                             placeholder="&#8212;"
                             readonly$="[[!editMode]]"
                             invalid$="[[!_isValid('phone', item.title, item.first_name, item.last_name, item.email, item.phone, index)]]"
                             error-message="Phone number is required">
                  <iron-icon prefix icon="communication:phone"></iron-icon>
                </paper-input>
              </div>
              <div class="col col-4">
                <!-- Email address -->
                <paper-input id$="email_[[index]]"
                             label="E-mail address"
                             value="{{item.email}}"
                             placeholder="&#8212;"
                             readonly$="[[!_canBeRemoved(item.id)]]"
                             invalid$="[[!_isValid('emailAddress', item.title, item.first_name, item.last_name, item.email, item.phone, index)]]"
                             error-message="A valid & unused email address is required">
                  <iron-icon prefix icon="communication:email"></iron-icon>
                </paper-input>
              </div>
              <div class="col col-4">
                <!-- Active? -->
                <etools-form-element-wrapper>
                  <etools-checkable-input checked="{{item.active}}"
                                          label="Active?"
                                          type="checkbox"
                                          label-alignment="right"
                                          readonly$="[[!editMode]]">
                  </etools-checkable-input>
                </etools-form-element-wrapper>
              </div>
            </div>

          </div>
        </div>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
      <p>There are no staff members added.</p>
    </div>

    <div id="bottom-actions" class="row-h" hidden$="[[!editMode]]">
      <paper-fab icon="add"
                 on-tap="_addNewStaffMember"
                 title="Add"></paper-fab>
    </div>

  </template>

  <script>
    // jscs:disable maximumLineLength
    Polymer({
      is: 'staff-members',

      behaviors: [
        EtoolsPmpApp.Behaviors.RepeatableDataSets
      ],
      properties: {},

      ready: function() {
        this.dataSetModel = {
          id: null,
          title: null,
          first_name: null,
          last_name: null,
          phone: null,
          email: null,
          active: true
        };
      },

      _canBeRemoved: function(id) {
        if (!this.editMode || id) {
          return false;
        }
        return true;
      },

      _validStaffMemberEmailAddress: function(emailAddress, staffMemberIndex) {
        var emailAddressValid = true;
        var alreadyUsedFilterResult = this.dataItems.filter(function(staffMember, index) {
          return staffMember.email === emailAddress && index !== staffMemberIndex;
        });
        if (alreadyUsedFilterResult.length > 0) {
          // address already used
          emailAddressValid = false;
        } else {
          var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
          emailAddressValid = re.test(emailAddress);
        }
        return emailAddressValid;
      },

      _notEmpty: function(value) {
        return typeof value !== 'undefined' && value !== null && value !== '';
      },

      _isValid: function(field, title, firstName, lastName, emailAddress, phone, index) {
        var valid = true;
        switch (field) {
          case 'title':
            if (!this._notEmpty(title) && (this._notEmpty(firstName) || this._notEmpty(lastName) ||
                 this._notEmpty(emailAddress) || this._notEmpty(phone))) {
              valid = false;
            }
            break;
          case 'firstName':
            if (!this._notEmpty(firstName) && (this._notEmpty(title) || this._notEmpty(lastName) ||
                this._notEmpty(emailAddress) || this._notEmpty(phone))) {
              valid = false;
            }
            break;
          case 'lastName':
            if (!this._notEmpty(lastName) && (this._notEmpty(title) || this._notEmpty(firstName) ||
                 this._notEmpty(emailAddress) || this._notEmpty(phone))) {
              valid = false;
            }
            break;
          case 'phone':
            if (!this._notEmpty(phone) && !this._notEmpty(emailAddress) &&
                (this._notEmpty(title) || this._notEmpty(firstName) || this._notEmpty(lastName))) {
              valid = false;
            }
            break;
          case 'emailAddress':
            if (this._notEmpty(emailAddress)) {
              valid = this._validStaffMemberEmailAddress(emailAddress, index);
            } else {
              if (!this._notEmpty(phone) && (this._notEmpty(title) || this._notEmpty(firstName) ||
                  this._notEmpty(lastName))) {
                valid = false;
              } else {
                valid = true; // empty staff member data, hide error msgs
              }
            }
            break;
        }
        return valid;
      },

      _addNewStaffMember: function() {
        if (this.editMode) {
          var lastStaffMemberAdded = this.dataItems[this.dataItems.length - 1];
          if (this._emptyStaffMemberData(lastStaffMemberAdded)) {
            this.fire('toast', {text: 'Last staff member fields are empty!', showCloseBtn: true});
          } else {
            this._addElement();
          }
        }
      },

      _emptyStaffMemberData: function(member) {
        return member
            && !this._notEmpty(member.first_name)
            && !this._notEmpty(member.last_name)
            && !this._notEmpty(member.phone)
            && !this._notEmpty(member.email);
      },

      validate: function() {
        var valid = true;
        if (this.dataItems instanceof Array && this.dataItems.length > 0) {
          for (var j = 0; j < this.dataItems.length; j++) {
            if (this._emptyStaffMemberData(this.dataItems[j])) {
              valid = false;
              break;
            }
            var fields = ['#firstName_' + j, '#lastName_' + j,
              '#phone_' + j, '#email_' + j];
            for (var i = 0; i < fields.length; i++) {
              var fieldEl = this.$$(fields[i]);
              if (fieldEl && fieldEl.invalid) {
                valid = false;
                break;
              }
            }
            if (!valid) {
              break;
            }
          }
        }
        return valid;
      }

    });
  </script>
</dom-module>
