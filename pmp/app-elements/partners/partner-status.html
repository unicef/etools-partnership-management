<link rel="import" href="../../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../app-elements/etools-status/etools-status.html">

<dom-module id="partner-status">
  <template strip-whitespace>
    <style>
      :host {
        width: 100%;
        --etools-status-label-style: {
          font-weight: normal;
        };
        --etools-status-container: {
          height: auto;
          min-height: 40px;
        };
      }
    </style>
    <etools-status statuses="[[possibleStatuses]]"
                   actions="[[possibleActions]]"
                   on-partner-delete="_showDeleteConfirmationDialog">
    </etools-status>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'partner-status',
        behaviors: [
          etoolsBehaviors.DynamicDialogBehavior,
          EtoolsLogsBehavior,
        ],

        properties: {
          partner: {
            type: Object,
            notify: true
          },
          editMode: {
            type: Boolean,
            value: false
          },
          deleteWarningDialogContent: {
            type: Object
          },
          possibleStatuses: {
            type: Array,
            value: function() {
              return [
                {
                  label: 'Not Synced',
                  icon: 'info',
                  iconStyles: 'width: 19px; height: 19px; color: ' +
                  this.getComputedStyleValue('--primary-background-color'),
                  iconContainerStyles: 'background-color: ' +
                  this.getComputedStyleValue('--status-not-synced-color'),
                  hidden: true,
                  completed: false
                },
                {
                  label: 'Synced from VISION',
                  icon: 'autorenew',
                  iconStyles: 'width: 19px; height: 19px; color: ' +
                  this.getComputedStyleValue('--primary-background-color'),
                  iconContainerStyles: 'background-color: ' + this.getComputedStyleValue('--status-synced-color'),
                  hidden: true,
                  completed: false
                },
                {
                  label: 'Blocked in VISION',
                  icon: 'block',
                  iconStyles: 'width: 19px; height: 19px; color: ' +
                  this.getComputedStyleValue('--primary-background-color'),
                  iconContainerStyles: 'background-color: ' + this.getComputedStyleValue('--status-blocked-color'),
                  hidden: true,
                  completed: false
                },
                {
                  label: 'Marked For Deletion in VISION',
                  icon: 'delete-forever',
                  iconStyles: 'color: ' + this.getComputedStyleValue('--error-color'),
                  iconContainerStyles: 'background-color: ' +
                  this.getComputedStyleValue('--primary-background-color'),
                  hidden: true,
                  completed: false
                },
              ];
            }
          },
          possibleActions: {
            type: Array,
            value: [
              {
                label: 'Save',
                hidden: true,
                primary: true,
                //save action is hadled inside the parent
                event: 'save-partner'
              },
              {
                label: 'Delete',
                hidden: true,
                event: 'partner-delete'
              },
            ]
          },

        },

        observers: [
          '_computeAvailableStatuses(partner.vision_synced, partner.deleted_flag, partner.blocked)',
          '_computeAvailableActions(partner.hidden, editMode)'
        ],
        ready: function() {
          this.deleteWarningDialogContent = document.createElement('div');
          this.deleteWarningDialogContent.setAttribute('id', 'deleteWarningContent');
          this.warningDialog = this.createDialog('Delete Confirmation', 'md', 'Yes', 'No',
            this._dialogConfirmationCallback.bind(this), this.deleteWarningDialogContent);
        },
        detached: function() {
          if (this.warningDialog) {
            this.removeDialog(this.warningDialog);
          }
        },
        _isHidden: function(hidden) {
          if (typeof hidden === 'undefined' || hidden === null) {
            return true;
          }
          return hidden;
        },
        _showDeleteConfirmationDialog: function() {
          if (!this.warningDialog) {
            this.logWarn('warningDialog not created!', 'pmp partner status change');
            return;
          }

          if (!this.deleteWarningDialogContent) {
            this.logWarn('#deleteWarningContent element not found!', 'pmp partner status change');
            return;
          }
          var warningMessage = 'Are you sure you want to delete partner ' + this.partner.name + '?';
          this.deleteWarningDialogContent.innerHTML = warningMessage;
          this.warningDialog.opened = true;
        },

        _dialogConfirmationCallback: function(event) {
          if (event.detail.confirmed) {
            if (!this.editMode) {
              return;
            }
            this.fire('delete-partner', {
              id: this.partner.id,
            });
          }
        },

        _setAllActionsToHidden: function() {
          var possibleActions = this.possibleActions;
          possibleActions.forEach(function(elem) {
            elem.hidden = true;
          });

          this.set('possibleActions', possibleActions);
        },
        _setAllStatusesToHidden: function() {
          var possibleStatuses = this.possibleStatuses;
          possibleStatuses.forEach(function(elem) {
            elem.hidden = true;
            elem.completed = false;
          });

          this.set('possibleStatuses', possibleStatuses);
        },

        _computeAvailableActions: function(hidden, editMode) {
          this._setAllActionsToHidden();
          let availableOptions = ['Save', 'Delete'];
          if (!editMode) {
            return;
          }

          for (let key in this.possibleActions) {
            let actionName = this.possibleActions[key].label;
            let config = this.possibleActions[key];

            if (availableOptions.indexOf(actionName) > -1) {
              config.hidden = false;
            }

            this.set(['possibleActions', key], null);
            this.set(['possibleActions', key], config);
          }
        },
        _computeAvailableStatuses: function() {
          var activeStatus;
          this._setAllStatusesToHidden();
          switch (true) {
            case this._showNotSyncedStatus():
              activeStatus = 'Not Synced';
              break;
            case this._showSyncedStatus():
              activeStatus = 'Synced from VISION';
              break;
            case this._showBlockedStatus():
              activeStatus = 'Blocked in VISION';
              break;
            case this._showMakedForDeletionStatus():
              activeStatus = 'Marked For Deletion in VISION';
              break;
          }

          for (let key = this.possibleStatuses.length - 1; key >= 0; key--) {
            let workingStatus = this.possibleStatuses[key];
            if (workingStatus.label === activeStatus) {
              workingStatus.completed = true;
              workingStatus.hidden = false;
            }
            this.set(['possibleStatuses', key], null);
            this.set(['possibleStatuses', key], workingStatus);
          }
        },
        _showSyncedStatus: function() {
          if (this.partner.vision_synced === true && this.partner.deleted_flag === false &&
              (typeof this.partner.blocked === 'undefined' || this.partner.blocked === false)) {
            return true;
          }
          return false;
        },

        _showBlockedStatus: function() {
          if (this.partner.deleted_flag === false &&
              (typeof this.partner.blocked !== 'undefined' && this.partner.blocked === true)) {
            return true;
          }
          return false;
        },

        _showMakedForDeletionStatus: function() {
          if (this.partner.deleted_flag === true) {
            return true;
          }
          return false;
        },

        _showNotSyncedStatus: function() {
          return this.partner.vision_synced === false;
        },

      });
    })();

  </script>
</dom-module>
