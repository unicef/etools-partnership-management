<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/etools-currency-amount-input/etools-currency-behavior.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-info-tooltip/etools-info-tooltip.html">
<link rel="import" href="../../../bower_components/etools-data-table/data-table-styles.html">

<link rel="import" href="../../app-behaviors/common-behavior.html">
<link rel="import" href="../../app-behaviors/risk-rating-behavior.html">

<link rel="import" href="../interventions/behaviors/fr-numbers-consistency-behavior.html">

<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/page-common-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/risk-rating-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">

<dom-module id="partner-overview">

  <template strip-whitespace>

    <style include="page-common-styles grid-layout-styles shared-styles risk-rating-styles data-table-styles">
      :host {
        @apply --layout-vertical;
        width: 100%;

      }

      paper-input,
      paper-dropdown-menu {
        width: 100%;
      }

      paper-toolbar {
        --paper-toolbar-height: 40px;
        --paper-toolbar-background: var(--medium-theme-background-color);
        --paper-toolbar: {
          -webkit-border-radius: 8px;
          -moz-border-radius: 8px;
          border-radius: 8px;
        };
        --paper-toolbar-title: {
          @apply --nested-content-panel-title;
          margin-left: 0;
        };
      }

      .assessments {
        margin-top: 20px;
      }

      #core-values-assessment {
        width: 100%;
      }

      .hact-heading {
        @apply --layout-vertical;
        background-color: var(--medium-theme-background-color);
      }

      .hact-heading .row-h .col {
        justify-content: center;
        align-items: center;
      }

      .hact-heading .row-h .right-align {
        justify-content: flex-end;
        align-items: center;
      }

      .hact-heading .row-h .left-align {
        justify-content: flex-start;
        align-items: center;
      }

      .hact-body {
        @apply --layout-vertical;
      }

      .row-h + .row-h {
        margin-top: 0;
        border-top: 1px solid var(--dark-divider-color);
      }

      .full-width {
        width: 100%
      }

      .green {
        color: var(--paper-green-500);
      }

      .signed {
        text-transform: uppercase;
        /* color: var(--paper-red-500); TBD*/
      }

      .suspended {
        text-transform: uppercase;
        color: var(--paper-orange-500);
      }

      .draft {
        text-transform: uppercase;
        color: var(--paper-yellow-700);
      }

      .active {
        text-transform: uppercase;
        color: var(--paper-green-500);
      }

      .closed {
        text-transform: uppercase;
        color: var(--paper-blue-500);
      }

      .terminated {
        text-transform: uppercase;
        color: var(--paper-purple-500);
      }

      .block {
        display: block;
      }

      small {
        color: var(--dark-secondary-text-color);
      }

      .word-break {
        word-break: break-all;
      }

      .overflow-hidden {
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .timeline-col {
        @apply --layout-start-justified;
      }

      .timeline-col .date-delimiter {
        margin: 0 8px;
      }
    </style>
    <etools-content-panel class="content-section" panel-title="HACT Assurance & Partnerships">
      <div class="hact-heading">
        <div class="row-h">
          <div class="col col-6"><strong> TOTAL CASH TRANSFERS </strong></div>
          <div class="col col-2"><strong> PROG.VISIT </strong></div>
          <div class="col col-2"><strong> SPOT CHECK </strong></div>
          <div class="col col-2"><strong> AUDIT </strong></div>
        </div>
        <div class="row-h">
          <div class="col col-2"> Risk Rating</div>
          <div class="col col-2"> Current CP Cycle</div>
          <div class="col col-2"> Cash Transfers (1 Oct - 30 Sep)</div>
          <div class="col col-2"> Planned / M.R. / Done</div>
          <div class="col col-2"> Done / M.R.</div>
          <div class="col col-2"> Done / M.R.</div>
        </div>
      </div>
      <div class="hact-body">
        <div class="row-h">
          <div class="col col-2 center-align">
            <span class$="risk-rating-field [[getRiskRatingClass(partner.rating)]]"> [[getRiskRatingValue(partner.rating)]] </span>
          </div>
          <div class="col col-2 center-align"> $[[displayCurrencyAmount(partner.total_ct_cp, '0', 0)]]</div>
          <div class="col col-2 center-align block"> $[[displayCurrencyAmount(partner.total_ct_cy, '0', 0)]]
          </div>
          <div class="col col-2 center-align">
            <strong>
              [[partner.hact_values.planned_visits]] / [[partner.hact_min_requirements.programme_visits]] /
              <span class="green"> [[partner.hact_values.programmatic_visits]]</span>
            </strong>
          </div>
          <div class="col col-2 center-align">
            <strong>
              <span class="green">[[partner.hact_values.spot_checks]] </span>
              / [[partner.hact_min_requirements.spot_checks]]
            </strong>
          </div>
          <div class="col col-2 center-align">
            <strong>
              <span class="green">[[partner.hact_values.audits_done]] </span>
              / [[partner.hact_values.audits_mr]]
            </strong>
          </div>
        </div>
      </div>
      <template is="dom-if" if="[[partner.interventions.length]]">
        <div class="hact-heading">
          <div class="row-h">
            <div class="col col-3 word-break left-align"> Partnership</div>
            <div class="col col-2 right-align"> Total Planned Budget</div>
            <div class="col col-2 right-align"> Actual</div>
            <div class="col col-2"> Status</div>
            <div class="col col-3 left-align"> Timeline</div>
          </div>
        </div>
        <div class="hact-body">
          <template is="dom-repeat" items="[[partner.interventions]]" as="partnership">
            <div class="row-h">
              <div class="col col-3 block word-break">
                <a href="interventions/[[partnership.id]]/details"><strong>[[partnership.number]]</strong></a><br>
                <span>
                [[partnership.title]]
              </span>
              </div>
              <div class="col col-2 right-align"> $[[displayCurrencyAmount(partnership.total_budget, '0', 0)]]
              </div>
              <div class="col col-2 right-align"> $[[displayCurrencyAmount(partnership.actual_amount, '0', 0)]]</div>
              <div class="col col-2 center-align overflow-hidden"><strong class$="[[partnership.status]]">[[partnership.status]]</strong>
              </div>
              <div class="col col-3 center-align timeline-col">
                <!-- TODO: this will be needed in the future, after frs validation will be re-designed
                  hide-tooltip$="[[validateFrsVsInterventionDates(partnership.start, partnership.frs_earliest_start_date)]]" -->
                <etools-info-tooltip icon="report" icon-first
                                     hide-tooltip
                                     important-warning>
                  <span slot="field">[[getDateDisplayValue(partnership.start)]]</span>
                  <!--<span slot="message">[[getFrsStartDateValidationMsg()]]</span>-->
                </etools-info-tooltip>
                <span class="date-delimiter"> - </span>
                <!-- TODO: this will be needed in the future, after frs validation will be re-designed
                  hide-tooltip$="[[validateFrsVsInterventionDates(partnership.end, partnership.frs_latest_end_date)]]" -->
                <etools-info-tooltip icon="report" icon-first
                                     hide-tooltip
                                     important-warning>
                  <span slot="field">[[getDateDisplayValue(partnership.end)]]</span>
                  <!--<span slot="message">[[getFrsEndDateValidationMsg()]]</span>-->
                </etools-info-tooltip>
              </div>
            </div>
          </template>
        </div>
      </template>
    </etools-content-panel>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'partner-overview',

        behaviors: [
          EtoolsPmpApp.Behaviors.Common,
          EtoolsPmpApp.Behaviors.RiskRating,
          etoolsBehaviors.EtoolsCurrencyBehavior,
          EtoolsPmpApp.Behaviors.FrNumbersConsistency
        ],
        properties: {
          user: Object,
          permissions: Object,

          partner: {
            type: Object,
            value: {},
            notify: true,
            observer: '_partnerChanged'
          },
          contentVisible: {
            type: Boolean,
            value: false
          },
          coreValuesAssessmentFiles: {
            type: Array,
            value: [],
            notify: true
          },
        },

        attached: function() {
          /**
           * Disable loading message for overview tab elements load,
           * triggered by parent element on stamp or by tap event on tabs
           */
          this.fire('global-loading', {active: false, loadingSource: 'partners-page'});
          this.fire('partners-page-attached');
        },

        _partnerChanged: function(partner) {
          if (typeof partner === 'object' && Object.keys(partner).length > 0) {
            this.contentVisible = true;
          } else {
            this.contentVisible = false;
          }
        }
      });

    })();
  </script>

</dom-module>
