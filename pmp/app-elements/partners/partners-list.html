<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">
<link rel="import" href="../../../scripts/lodash/lodash.html">

<link rel="import" href="../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../app-behaviors/common-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../app-behaviors/lists-common-behavior.html">
<link rel="import" href="../../app-behaviors/pagination-behavior.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-filter-styles.html">
<link rel="import" href="../../../styles/partner-status-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">

<link rel="import" href="partners-data/partners-list-data.html">
<link rel="import" href="partner-item.html">

<dom-module id="partners-list">
  <template strip-whitespace>
    <style
        include="shared-styles data-table-styles iron-flex iron-flex-factors partner-status-styles list-filter-styles paper-material-styles">
      .sm-status-wrapper {
        padding-left: 10px;
      }
      .vendor-nr {
        @apply --text-btn-style;
        text-transform: none;
      }
    </style>

    <template is="dom-if" if="[[stampListData]]">
      <partners-list-data id="partners"
                          filtered-partners="{{filteredPartners}}"
                          total-results="{{paginator.count}}"
                          on-partners-loaded="_requiredDataHasBeenLoaded"
                          list-data-path="filteredPartners"
                          fire-data-loaded>
      </partners-list-data>
    </template>

    <div id="listControls" class="paper-material" elevation="1">
      <div class="wrap-controls">

        <paper-input id="query"
                     type="search"
                     autocomplete="off"
                     value="{{q}}"
                     placeholder="Search">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>

        <div class="filter esmm">
          <etools-multi-selection-menu
              label="Partner Type"
              disabled$="[[showOnlyGovernmentType]]"
              options="[[partnerTypes]]"
              selected-values="{{selectedPartnerTypes}}"
              hide-search></etools-multi-selection-menu>
        </div>

        <div class="filter esmm">
          <etools-multi-selection-menu
              label="CSO Type"
              options="[[csoTypes]]"
              selected-values="{{selectedCsoTypes}}"
              hide-search></etools-multi-selection-menu>
        </div>

      </div>
      <div class="fixed-controls">
        <div class="filter-bar-action-wrapper">
          <div id="hiddenToggle">
            Show hidden
            <paper-toggle-button checked="{{showHidden}}"></paper-toggle-button>
          </div>
        </div>
      </div>

    </div>

    <div id="list" class="paper-material hidden" elevation="1">

      <etools-data-table-header id="listHeader"
                                label="[[paginator.visible_range.0]]-[[paginator.visible_range.1]] of [[paginator.count]] results to show">
        <etools-data-table-column class="flex" field="vendor_number" sortable>
          Vendor #
        </etools-data-table-column>
        <etools-data-table-column class="flex-3" field="name" sortable>
          Name(short - full)
        </etools-data-table-column>
        <etools-data-table-column class="flex-2" field="partner_type">
          Type
        </etools-data-table-column>
        <etools-data-table-column class="flex" field="rating">
          Risk
        </etools-data-table-column>
      </etools-data-table-header>

      <template id="rows" is="dom-repeat" notify-dom-change
                items="[[filteredPartners]]" as="partner"
                initial-count="10" on-dom-change="_listDataChanged">
        <etools-data-table-row details-opened="[[detailsOpened]]">
          <div slot="row-data">
              <span class="col-data flex">
                <a class="vendor-nr truncate"
                   href$="[[currentPage]]/[[partner.id]]/details"
                   title$="[[getDisplayValue(partner.vendor_number)]]"
                   on-tap="_triggerPartnerLoadingMsg">
                  [[getDisplayValue(partner.vendor_number)]]
                </a>
              </span>
            <span class="col-data flex-3">
                <span>[[_computeName(partner.name, partner.short_name)]]</span>

                <span class="sm-status-wrapper" hidden$="[[!partner.deleted_flag]]">
                  <span class="marked-for-deletion">
                    <iron-icon icon="delete"></iron-icon>
                  </span>
                </span>

                <span class="sm-status-wrapper" hidden$="[[!partner.blocked]]">
                  <span class="blocked">
                    <iron-icon icon="block"></iron-icon>
                  </span>
                </span>

              </span>
            <span class="col-data flex-2">
                [[_computeType(partner.cso_type, partner.partner_type)]]
              </span>
            <span class="col-data flex" style="text-transform: capitalize">
                [[getDisplayValue(partner.rating)]]
              </span>
          </div>
          <div slot="row-data-details">
            <div class="row-details-content flex">
              <span class="rdc-title">Shared Partner</span>
              <span>[[getDisplayValue(partner.shared_with)]]</span>
            </div>
            <div class="row-details-content flex">
              <span class="rdc-title">Email</span>
              <span>[[getDisplayValue(partner.email)]]</span>
            </div>
            <div class="row-details-content flex">
              <span class="rdc-title">Phone Number</span>
              <span>[[getDisplayValue(partner.phone_number)]]</span>
            </div>
            <div class="row-details-content flex">
              <span class="rdc-title">Actual Cash Transfer for CP</span>
              <span>$ [[getDisplayValue(partner.total_ct_cp)]]</span>
            </div>
            <div class="row-details-content flex">
              <span class="rdc-title">Actual Cash Transfer for Current Year</span>
              <span>$ [[getDisplayValue(partner.total_ct_cy)]]</span>
            </div>
          </div>
        </etools-data-table-row>
      </template>

      <etools-data-table-footer
          page-size="{{paginator.page_size}}"
          page-number="{{paginator.page}}"
          total-results="[[paginator.count]]"
          visible-range="{{paginator.visible_range}}">
      </etools-data-table-footer>

    </div>

  </template>

  <script>
    (function() {
      'use strict';

      var _partnersLastNavigated = null;

      Polymer({

        is: 'partners-list',

        behaviors: [
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore,
          EtoolsPmpApp.Behaviors.Common,
          EtoolsPmpApp.Behaviors.ListsCommon,
          EtoolsPmpApp.Behaviors.Pagination
        ],

        properties: {

          filteredPartners: {
            type: Array,
            notify: true,
            observer: '_listChanged'
          },

          csoTypes: {
            type: Array,
            statePath: 'csoTypes'
          },

          partnerTypes: {
            type: Array,
            statePath: 'partnerTypes'
          },

          selectedPartnerTypes: {
            type: Array,
            value: []
          },

          selectedCsoTypes: {
            type: String,
            value: []
          },

          showHidden: {
            type: Boolean,
            value: false
          },

          showOnlyGovernmentType: {
            type: Boolean,
            value: false,
            observer: '_showOnlyGovernmentTypeFlagChanged'
          },
          currentPage: String,
          _sortableFieldNames: {
            type: Array,
            value: ['vendor_number', 'name']
          },
          _governmentLockedPartnerTypes: {
            type: Array,
            value: ['Government']
          }
        },

        observers: [
          'resetPageNumber(selectedPartnerTypes.length, selectedCsoTypes.length, showHidden)',
          '_updateUrlAndData(q, selectedPartnerTypes.length, selectedCsoTypes.length, paginator.page, ' +
            'paginator.page_size, sortOrder, showHidden, requiredDataLoaded, initComplete)',
          '_init(active)'
        ],

        listeners: {
          'sort-changed': '_sortOrderChanged',
        },

        attached: function() {
          /**
           * Disable loading message for main list elements load,
           * triggered by parent element on stamp
           */
          this.fire('global-loading', {active: false, loadingSource: 'partners-page'});
          this.listAttachedCallback(this.active, 'Loading partners list data...', 'partners-list');
        },

        _getSelectedPartnerTypes: function(selectedPartnerTypes) {
          return this.showOnlyGovernmentType
              ? this._governmentLockedPartnerTypes
              : this._getFilterUrlValuesAsArray(selectedPartnerTypes);
        },

        // Input: URL query params
        // Initializes the properties of the list at page load
        // to the params interpretted from the URL string.
        _init: function(active) {
          let urlQueryParams = this.urlParams;
          if (!active || !urlQueryParams) {
            return;
          }
          this.set('initComplete', false);
          this.set('q', urlQueryParams.q ? urlQueryParams.q : '');
          this.set('selectedPartnerTypes', this._getSelectedPartnerTypes(urlQueryParams.partner_types));
          this.set('selectedCsoTypes', this._getFilterUrlValuesAsArray(urlQueryParams.cso_types));
          this.set('showHidden', urlQueryParams.hidden ? true : false);

          this.setPaginationDataFromUrlParams(urlQueryParams);

          // format of sort param is sort=field.order ex: sort=name.asc
          let result = this.initSortFieldsValues({field: 'name', direction: 'asc'}, urlQueryParams.sort);
          this.set('sortOrder', result);
          this.set('initComplete', true);
        },

        // Updates URL state with new query string, and launches query
        _updateUrlAndData: function() {
          let newQueryStr = this._updateUrlAndDislayedData(this.currentPage + '/list', _partnersLastNavigated,
              this._buildCsvDownloadUrl.bind(this), this._buildQueryString.bind(this),
              this._filterPartnersData.bind(this));
          _partnersLastNavigated = newQueryStr || _partnersLastNavigated;
        },

        _filterPartnersData: function(forceNoLoading) {
          // Query is debounced with a debounce time
          // set depending on what action the user takes
          this.debounce('query', function() {
            let partners = this.$$('#partners');
            if (!partners) {
              return;
            }

            partners.query(
                this.sortOrder.field,
                this.sortOrder.direction,
                this.q.toLowerCase(),
                this.selectedPartnerTypes,
                this.selectedCsoTypes,
                this.paginator.page,
                this.paginator.page_size,
                this.showHidden,
                forceNoLoading ? false : this.showQueryLoading
            );
          }, this.debounceTime);
        },

        // Outputs the query string for the list
        _buildQueryString: function() {
          return this._buildUrlQueryString({
            page: this.paginator.page,
            size: this.paginator.page_size,
            q: this.q,
            partner_types: this.selectedPartnerTypes,
            cso_types: this.selectedCsoTypes,
            hidden: this.showHidden ? 'true' : '',
            sort: this.sortOrder
          });
        },

        _buildCsvDownloadUrl: function() {
          let endpointUrl = this.getEndpoint('partners').url;
          let params = {
            search: this.q,
            partner_type: this.selectedPartnerTypes,
            cso_type: this.selectedCsoTypes,
            hidden: this.showHidden ? 'true' : 'false'
          };
          return this._buildCsvExportUrl(params, endpointUrl);
        },

        _computeName: function(name, shortName) {
          return this.getDisplayValue([shortName, name], false, ' / ', true);
        },

        _computeType: function(csoType, partnerType) {
          if (!csoType) {
            return partnerType;
          } else if (csoType === 'Community Based Organization') {
            return 'CSO / Community Based';
          } else {
            return 'CSO / ' + csoType;
          }
        },

        _showOnlyGovernmentTypeFlagChanged: function(showOnlyGovernmentType) {
          if (showOnlyGovernmentType) {
            // lock list to government partners only
            this.set('selectedPartnerTypes', this._governmentLockedPartnerTypes);
          } else {
            // unlock list from government partners only
            this.set('selectedPartnerTypes', []);
          }
          this.set('selectedCsoTypes', []);
          this.resetPageNumber();
          this.set('showHidden', false);
        },

        _triggerPartnerLoadingMsg: function() {
          this.fire('trigger-partner-loading-msg');
        }

      });
    })();

  </script>

</dom-module>
