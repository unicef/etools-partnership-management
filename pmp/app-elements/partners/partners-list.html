<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/list-filters-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/partner-status-styles.html">

<link rel="import" href="partners-data/partners-list-data.html">
<link rel="import" href="partner-item.html">

<link rel="import" href="../data-table/data-table-footer.html">
<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">

<dom-module id="partners-list">

  <template>

    <style include="shared-styles list-styles iron-flex iron-flex-factors partner-status-styles">
      :host {
        /* TODO: paper-toggle-button style could be global, recheck this when app-theme colors are defined */
        --paper-toggle-button-checked-bar-color: #88D4F7; /* TODO: replace with app-theme var */
        --paper-toggle-button-checked-button-color: #3baaee; /* TODO: replace with app-theme var */
      }

      .sm-status-wrapper {
        padding-left: 10px;
      }
    </style>

    <partners-list-data id="partners"
                        filtered-partners="{{filteredPartners}}"
                        total-results="{{totalResults}}"
                        on-partners-loaded="_requiredDataHasBeenLoaded"
                        fire-data-loaded>
    </partners-list-data>

    <paper-material id="listControls" elevation="1">

      <div class="wrap-controls">

        <paper-input id="query"
            type="search"
            autocomplete="off"
            value="[[q]]"
            on-keyup="_setQ"
            placeholder="Search"
            on-search="_setQ">
            <iron-icon icon="search" prefix></iron-icon>
        </paper-input>

        <template is="dom-repeat" items="[[selectedFilters]]" as="filter">
          <div class="dropdown-with-clear-btn">
            <paper-icon-button class="clear dark" icon="close" on-tap="clearDropdown"></paper-icon-button>
            <paper-dropdown-menu label$="[[filter.filterName]]" noink>
              <paper-menu class="dropdown-content"
                          attr-for-selected="text-content"
                          on-iron-select="filterValueChanged"
                          on-iron-deselect="filterValueChanged"
                          data-filter-path$="[[filter.path]]"
                          on-iron-activate="_dropdownSelected">
                <template is="dom-repeat" items="[[filter.selectionOptions]]" as="filterOption">
                  <paper-item>[[filterOption]]</paper-item>
                </template>
              </paper-menu>
            </paper-dropdown-menu>
            <paper-icon-button class="remove" icon="cancel"
                               on-tap="removeFilter"
                               data-filter-name$="[[filter.filterName]]"
                               data-reset-path$="[[filter.path]]">
            </paper-icon-button>
          </div>
        </template>

      </div>

      <div class="fixed-controls">

      <div class="filters-divider"></div>

      <paper-menu-button id="filterMenu">
        <paper-button class="button dropdown-trigger">
          <iron-icon icon="filter-list"></iron-icon>add filter</paper-button>
        <paper-menu class="dropdown-content">
          <template is="dom-repeat" items="[[availableListFilterOptions]]">
            <paper-item on-tap="selectFilter">[[item.filterName]]</paper-item>
          </template>
        </paper-menu>
      </paper-menu-button>

      <div class="filters-divider"></div>

      <div id="hiddenToggle" on-tap="_toggleHidden">
        Show hidden
        <paper-toggle-button checked="[[showHidden]]"></paper-toggle-button>
      </div>

    </div>

    </paper-material>

    <paper-material id="list" elevation="1">

        <data-table-header id="listHeader" label="[[visibleRange.0]]-[[visibleRange.1]] of [[totalResults]] results to show">
          <data-table-column class="flex" field="vendor_number" sortable>
            Vendor #
          </data-table-column>
          <data-table-column class="flex-3" field="name" sortable>
            Name(short - full)
          </data-table-column>
          <data-table-column class="flex-2" field="partner_type">
            Type
          </data-table-column>
          <data-table-column class="flex" field="rating">
            Risk
          </data-table-column>
        </data-table-header>

        <template id="rows" is="dom-repeat" items="[[filteredPartners]]" as="partner" initial-count="10" on-dom-change="_listDataChanged">
          <data-table-row details-opened="[[detailsOpened]]">
            <div slot="row-data">
              <a class="col-data flex truncate"
                 href="partners/[[partner.id]]/details"
                 title="[[getDisplayValue(partner.vendor_number)]]">
                [[getDisplayValue(partner.vendor_number)]]
              </a>
              <span class="col-data flex-3">
                <span class="truncate">[[_computeName(partner.name, partner.short_name)]]</span>

                <span class="sm-status-wrapper" hidden$="[[!partner.deleted_flag]]">
                  <span class="marked-for-deletion">
                    <iron-icon icon="delete"></iron-icon>
                  </span>
                </span>

                <span class="sm-status-wrapper" hidden$="[[!partner.blocked]]">
                  <span class="blocked">
                    <iron-icon icon="block"></iron-icon>
                  </span>
                </span>

              </span>
              <span class="col-data flex-2">
                [[_computeType(partner.cso_type, partner.partner_type)]]
              </span>
              <span class="col-data flex" style="text-transform: capitalize">
                [[getDisplayValue(partner.rating)]]
              </span>
            </div>
            <div slot="row-data-details">
              <div class="row-details-content flex">
                <span class="rdc-title">Shared Partner</span>
                <span>[[getDisplayValue(partner.shared_with)]]</span>
              </div>
              <div class="row-details-content flex">
                <span class="rdc-title">Email</span>
                <span>[[getDisplayValue(partner.email)]]</span>
              </div>
              <div class="row-details-content flex">
                <span class="rdc-title">Phone Number</span>
                <span>[[getDisplayValue(partner.phone_number)]]</span>
              </div>
              <div class="row-details-content flex">
                <span class="rdc-title">Actual Cash Transfer for CP</span>
                <span>$ [[getDisplayValue(partner.total_ct_cp)]]</span>
              </div>
              <div class="row-details-content flex">
                <span class="rdc-title">Actual Cash Transfer for Current Year</span>
                <span>$ [[getDisplayValue(partner.total_ct_cy)]]</span>
              </div>
            </div>
          </data-table-row>
        </template>

        <data-table-footer
          page-size="[[pageSize]]"
          page-number="[[pageNumber]]"
          total-results="[[totalResults]]"
          visible-range="{{visibleRange}}"
          on-page-size-changed="_pageSizeChanged"
          on-page-number-changed="_pageNumberChanged">
        </data-table-footer>

    </paper-material>

  </template>

  <script>
    (function() {
      'use strict';

      var _partnersLastNavigated = null;

      Polymer({

        is: 'partners-list',

        behaviors: [
          pmpBehaviors.DropdownBehavior,
          pmpBehaviors.ListFiltersBehavior,
          pmpBehaviors.CommonGeneralBehavior
        ],

        properties: {

          filteredPartners: {
            type: Array,
            notify: true,
            observer: '_partnersChanged'
          },

          q: {
            type: String,
            notify: true,
            observer: '_qChanged'
          },

          partnerType: {
            type: String
          },

          csoType: {
            type: String
          },

          sortOrder: {
            type: Object,
          },

          pageNumber: {
            type: Number
          },

          pageSize: {
            type: Number
          },

          showHidden: {
            type: Boolean
          },

          debounceTime: {
            type: Number,
            value: 50
          },

          urlParams: {
            type: Object,
          },

          detailsOpened: Boolean,
          active: Boolean,

          forceDataRefresh: {
            type: Boolean,
            value: false
          }
        },

        observers: [
          '_updateURL(q, partnerType, csoType, pageNumber, pageSize, sortOrder, showHidden)',
          '_init(active)'
        ],

        listeners: {
          'sort-changed': '_sortOrderChanged',
        },

        ready: function() {
          this.$.list.classList.add('hidden');

          // init list filter options
          this.initListFiltersData([
            {
              filterName: 'Partner Type',
              selectionOptions: ['Bilateral / Multilateral', 'Civil Society Organization', 'Government', 'UN Agency'],
              path: 'partnerType'
            },
            {
              filterName: 'CSO Type',
              selectionOptions: ['Academic Institution', 'Community Based Organization', 'International', 'National'],
              path: 'csoType'
            }
          ]);
        },

        // Input: URL query params
        // Initializes the properties of the list at page load
        // to the params interpretted from the URL string.
        _init: function(active) {
          var parms = this.urlParams;
          if (!active || !parms) {
            return;
          }
          this.set('q', parms.q ? parms.q : '');
          this.set('partnerType', parms.partner_type ? parms.partner_type : '');
          this.set('csoType', parms.cso_type ? parms.cso_type : '');
          this.set('pageNumber', parms.page ? parseInt(parms.page) : 1);
          this.set('pageSize', parms.size ? parseInt(parms.size) : 5);
          this.set('showHidden', parms.hidden ? true : false);
          // format of sort param is sort=field.order ex: sort=name.asc
          var result = {field: 'name', direction: 'asc'};
          if (parms.sort) {
            var p = parms.sort.split('.');
            result = {field: p[0], direction: p[1]};
          }
          this.set('sortOrder', result);
          //this.$.listHeader.sortOrder = result;
        },

        // Updates URL state with new query string, and launches query
        _updateURL: function() {
          var qs = this._buildQueryString();
          if (qs !== _partnersLastNavigated) {
            _partnersLastNavigated = qs;
            // update URL
            this.updateAppState('partners/list', qs, true);
            // filter partners
            this._filterPartnersData();
          } else {
            if (location.search === '') {
              // only update URL query string, without location change event being fired(no page refresh)
              this.updateAppState('partners/list', qs, false);
            }
            if (this.forceDataRefresh) {
              // refilter partners data
              // this will only execute when partners-loaded event is received
              this._filterPartnersData();
              this.set('forceDataRefresh', false);
            }
          }
        },

        _filterPartnersData: function() {
          // Query is debounced with a debounce time
          // set depending on what action the user takes
          this.debounce('query', function() {
            this.$.partners.query(
                this.sortOrder.field,
                this.sortOrder.direction,
                this.q.toLowerCase(),
                this.partnerType,
                this.csoType,
                this.pageNumber,
                this.pageSize,
                this.showHidden);
          }, this.debounceTime);
        },

        // Outputs the query string for the list
        _buildQueryString: function() {
          var out = [];
          if (this.pageNumber && this.pageNumber > 1) {
            out.push('page=' + this.pageNumber);
          }
          if (this.pageSize) {
            out.push('size=' + this.pageSize);
          }
          if (this.q && this.q.length) {
            out.push('q=' + this.q);
          }
          if (this.partnerType && this.partnerType.length) {
            out.push('partner_type=' + this.partnerType);
          }
          if (this.csoType && this.csoType.length) {
            out.push('cso_type=' + this.csoType);
          }
          if (this.sortOrder && this.sortOrder.field && this.sortOrder.direction) {
            out.push('sort=' + this.sortOrder.field + '.' + this.sortOrder.direction);
          }
          if (this.showHidden) {
            out.push('hidden=true');
          }
          return out.join('&');
        },

        _sortOrderChanged: function(e) {
          this.set('debounceTime', 150);
          this.set('sortOrder', e.detail);
        },

        _pageSizeChanged: function(e) {
          this.set('debounceTime', 200);
          this.set('pageNumber', 1);
          this.set('pageSize', parseInt(e.detail.value));
        },

        _pageNumberChanged: function(e) {
          this.set('debounceTime', 50);
          this.set('pageNumber', e.detail.value);
        },

        _setQ: function() {
          this.set('q', this.$.query.value);
        },

        _qChanged: function(q) {
          this.set('debounceTime', 300);
          this.set('pageNumber', 1);
        },

        _dropdownSelected: function() {
          this.set('debounceTime', 200);
          this.set('pageNumber', 1);
        },

        _toggleHidden: function() {
          this.set('debounceTime', 50);
          this.set('showHidden', this.showHidden ? false : true);
          this.set('pageNumber', 1);
        },

        // List fade in fade out effect
        _partnersChanged: function(filteredPartners) {
          this.$.list.classList.add('hidden');
          this.async(function() {
            var partnersList = this.$$('#partners');
            if (partnersList && Array.isArray(partnersList.data) && partnersList.data.length > 0) {
              this.$$('#list').classList.remove('hidden');
            }
          }, 50);
        },

        _computeName: function(name, shortName) {
          return this.getDisplayValue([shortName, name], false, ' / ');
        },

        _computeType: function(csoType, partnerType) {
          if (!csoType) {
            return partnerType;
          } else if (csoType === 'Community Based Organization') {
            return 'CSO / Community Based';
          } else {
            return 'CSO / ' + csoType;
          }
        },

        // When the list data rows are changing check and close any details opened
        _listDataChanged: function() {
          var rows = this.$.list.querySelectorAll('data-table-row');
          if (rows && rows.length) {
            for (var i = 0; i < rows.length; i++) {
              if (rows[i].detailsOpened) {
                rows[i].set('detailsOpened', false);
              }
            }
          }
        },

        /**
         * At page refresh Dexie DBs might be wiped out and filteredPartners will be empty.
         * Because of this we need to refilter after partners data is saved locally.
         */
        _requiredDataHasBeenLoaded: function(event) {
          event.stopImmediatePropagation();
          if (Array.isArray(this.filteredPartners) && this.filteredPartners.length === 0) {
            this.set('forceDataRefresh',  true);
          }
          // recheck params to trigger partners filtering
          this._init(this.active);
        },

      });
    })();

  </script>

</dom-module>
