<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">

<link rel="import" href="../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../app-config/app-dexie-db-config.html">

<link rel="import" href="behaviors/country-programmes-data.html">
<link rel="import" href="behaviors/dropdowns-pmp-data.html">
<link rel="import" href="behaviors/dropdowns-static-data.html">
<link rel="import" href="behaviors/locations-data.html">
<link rel="import" href="behaviors/offices-data.html">
<link rel="import" href="behaviors/sections-data.html">
<link rel="import" href="behaviors/sectors-data.html">
<link rel="import" href="behaviors/unicef-users-data.html">
<link rel="import" href="behaviors/user-country-data.html">
<link rel="import" href="behaviors/disaggregations-data.html">
<link rel="import" href="behaviors/prp-countries.html">
<link rel="import" href="behaviors/environment-flags.html">

<dom-module id="static-common-data">
  <script>
    Polymer({
      is: 'static-common-data',
      behaviors: [
        EtoolsLogsBehavior,
        EtoolsAjaxRequestBehavior,
        EtoolsPmpApp.Behaviors.Endpoints,
        EtoolsPmpApp.Behaviors.CountryProgrammesData,
        EtoolsPmpApp.Behaviors.DropdownsPmpData,
        EtoolsPmpApp.Behaviors.DropdownsStaticData,
        EtoolsPmpApp.Behaviors.LocationsData,
        EtoolsPmpApp.Behaviors.OfficesData,
        EtoolsPmpApp.Behaviors.SectionsData,
        EtoolsPmpApp.Behaviors.SectorsData,
        EtoolsPmpApp.Behaviors.UnicefUsersData,
        EtoolsPmpApp.Behaviors.UserCountryData,
        EtoolsPmpApp.Behaviors.DisaggregationsData,
        EtoolsPmpApp.Behaviors.PRPCountries,
        EtoolsPmpApp.Behaviors.EnvFlagsData
      ],
      properties: {
        environmentFlagsEndpointName: {
          type: String,
          value: 'environmentFlags'
        },
        pmpStaticDataEndpointsNames: {
          type: Array,
          value: ['countryProgrammes', 'dropdownsPmp', 'dropdownsStatic', 'locations', 'offices',
            'sections', 'sectors', 'unicefUsers', 'userCountryDetails']
        },
        prpStaticDataEndpointsNames: {
          type: Array,
          value: ['addGetDisaggregations', 'getPRPCountries']
        }
      },

      ready: function() {
        // request environment flags
        this._makeRequest(this.environmentFlagsEndpointName,
            this._environmentFlagsSuccessHandler.bind(this), this._errorHandler);

        // get PMP static data
        this._getStaticData(this.pmpStaticDataEndpointsNames);
      },

      _getStaticData: function(endpointsNames) {
        let self = this;
        endpointsNames.forEach(function(endpointName) {
          self._makeRequest(endpointName, self._getEndpointSuccessHandler(endpointName), self._errorHandler);
        });
      },

      _makeRequest: function(endpointName, successHandler, errorHandler) {
        let self = this;
        this.fireRequest(endpointName, {}).then(function(resp) {
          successHandler.bind(self, resp)();
        }).catch(function(error) {
          errorHandler.bind(self, error)();
        });
      },

      _needToFirePrpReq: function(resp) {
        return resp && resp.active_flags instanceof Array && resp.active_flags.indexOf('prp_mode_off') === -1;
      },

      /**
       * Environment flags will tell us if we have to get static prp data too
       */
      _environmentFlagsSuccessHandler: function(resp) {
        this._getEndpointSuccessHandler(this.environmentFlagsEndpointName).bind(this, resp)();
        if (this._needToFirePrpReq(resp)) {
          // get PRP static data
          this._getStaticData(this.prpStaticDataEndpointsNames);
        }
      },

      _errorHandler: function(err) {
        this.logError('Error getting static data', 'static-common-data', err);
      },

      _getEndpointSuccessHandler: function(endpointName) {
        switch (endpointName) {
          case 'countryProgrammes':
            return this._handleCountryProgrammesResponse;
          case 'dropdownsPmp':
            return this._handleDropdownsPmpResponse;
          case 'dropdownsStatic':
            return this._handleDropdownsStaticResponse;
          case 'locations':
            return this._handleLocationsResponse;
          case 'offices':
            return this._handleOfficesResponse;
          case 'sections':
            return this._handleSectionsResponse;
          case 'sectors':
            return this._handleSectorsResponse;
          case 'unicefUsers':
            return this._handleUnicefUsersResponse;
          case 'userCountryDetails':
            return this._handleUserCountryDataResponse;
          case 'addGetDisaggregations':
            return this._handleDisaggregationsResponse;
          case 'getPRPCountries':
            return this._handlePRPCountryDataResponse;
          case 'environmentFlags':
            return this._handleEnvironmentFlagsResponse;
        }
      }

    });
  </script>
</dom-module>
