<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">

<link rel="import" href="redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="dropdowns-pmp-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="dexie"
                 on-success="_handleResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'dropdowns-pmp-data',
        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          etoolsAppConfig.globals
        ],
        properties: {

          endpoint: {
            type: Object,
            reflectToAttribute: true
          }

        },
        actions: {
          setHrps: function(hrpsData) {
            return {
              type: 'SET_HRPS',
              hrps: hrpsData
            };
          },
          setFileTypes: function(fileTypesData) {
            return {
              type: 'SET_FILE_TYPES',
              fileTypes: fileTypesData
            };
          },
          setCpOutputs: function(cpOutputsData) {
            return {
              type: 'SET_CP_OUTPUTS',
              cpOutputs: cpOutputsData
            };
          },
          setSignedByUnicefUsers: function(signedByUnicefUsersData) {
            return {
              type: 'SET_SIGNED_BY_UNICEF_USERS',
              signedByUnicefUsers: signedByUnicefUsersData
            };
          },
          setSupplyItems: function(supplyItemsData) {
            return {
              type: 'SET_SUPPLY_ITEMS',
              supplyItems: supplyItemsData
            };
          }
        },

        ready: function() {
          this.set('endpoint', this.getEndpoint('dropdownsPmp'));
        },

        _handleResponse: function(response) {
          if (response.detail) {
            // set HRPs value
            if (Array.isArray(response.detail.hrps) && response.detail.hrps.length > 0) {
              var preparedHrps = this._prepareDropdownData(response.detail.hrps);
              this.dispatch('setHrps', preparedHrps);
            }

            // set file types value
            if (Array.isArray(response.detail.file_types) && response.detail.file_types.length > 0) {
              this.dispatch('setFileTypes', response.detail.file_types);
            }

            // set CP Outputs values
            if (Array.isArray(response.detail.cp_outputs) && response.detail.cp_outputs.length > 0) {
              this.dispatch('setCpOutputs', response.detail.cp_outputs);
            }
            // set Signed By UNICEF Users
            if (Array.isArray(response.detail.signed_by_unicef_users)
                && response.detail.signed_by_unicef_users.length > 0) {
              var signedByUnicefUsers = this._prepareDropdownData(response.detail.signed_by_unicef_users, true);
              this.dispatch('setSignedByUnicefUsers', signedByUnicefUsers);
            }
            // set supply items
            if (Array.isArray(response.detail.supply_items)
                && response.detail.supply_items.length > 0) {
              var supplyItems = this._prepareDropdownData(response.detail.supply_items);
              this.dispatch('setSupplyItems', supplyItems);
            }
          }
        },

        /**
         * Prepare values for dropdowns
         */
        _prepareDropdownData: function(data, usersData) {
          return data.map(function(d) {
            if (usersData) {
              var userName = d.first_name + ' ' + d.last_name;
              userName = userName.trim();
              if (userName === '') {
                // no first and last name => use email
                userName = d.email;
              }
              return {
                value: d.id,
                label: userName
              };
            } else {
              return {
                value: d.id,
                label: d.name
              };
            }
          });
        }

      });
    })();
  </script>

</dom-module>
