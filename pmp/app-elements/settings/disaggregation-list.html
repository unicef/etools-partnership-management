<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../../app-config/app-endpoints-behavior.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">

<link rel="import" href="add-edit-disaggregation-dialog.html">

<dom-module id="disaggregation-list">
  <template strip-whitespace>
    <style include="page-layout-styles grid-layout-styles repeatable-data-sets-styles">
      div.col {
        align-items: center;
      }
    </style>

     <div class="page-top-content">
      <div class="top-content">
        <div class="top-content-row title-row">
          <h1 main-title> Settings </h1>
        </div>
      </div>
    </div>
    <div id="main">
      <div id="pageContent">
        <etools-content-panel panel-title="Disaggregations">
          <paper-icon-button slot="panel-btns"
                          icon="add"
                          on-tap="_addDisaggregation">
          </paper-icon-button>
          <div class="table">
            <div class="row-h header-row">
              <div class="col col-4"> Name</div>
              <div class="col col-8"> Disaggregation Groups</div>
              <!-- <div class="col col-2"> Actions</div> -->
            </div>
            <template is="dom-repeat" items="[[dataItems]]">
              <div class="row-h">
                <div class="col col-4">
                  [[item.name]]
                </div>
                <div class="col col-8">
                  [[_displayGroups(item.disaggregation_values)]]
                </div>
                <!-- <div class="col col-2" id="action-btns">
                  <paper-icon-button class="action edit" icon="create"
                              title="Edit" on-tap="_editDisaggregation">
                  </paper-icon-button>
                  <paper-icon-button class="action delete" icon="cancel"
                              data-args$="[[index]]"
                              title="Delete" on-tap="_openDeleteConfirmation">
                  </paper-icon-button>
                </div> -->
              </div>
            </template>
          </div>
        </etools-content-panel>
      </div>
    </div>

 </template>
</dom-module>

<script>
  (function() {
    'use strict';
    Polymer({
      is: 'disaggregation-list',

      behaviors: [
        EtoolsPmpApp.Behaviors.RepeatableDataSets,
        EtoolsPmpApp.Behaviors.Endpoints,
        EtoolsAjaxRequestBehavior
      ],

      properties: {
        dataItems: {
          type: Array,
          // value: 'disaggregations'
          // value: [{id: 1, name: 'Age', groups: ['1-10', '11-20', '21-40']},
          // {id: 2, name: 'Gender', groups: ['M', 'F', 'O']},
          // {id: 3, name: 'Testing something', groups: ['some text that its longer 65656 565656 77777', 'some text that its even longer 12345 12345 56656', 'some other long text 89898 676767']}]
        },
        disaggregationModal: {
          type: Object
        },
        _deleteEpName: {
          type: String,
          value: '',
          readOnly: true,
        },
      },
      ready: function() {
        this._loadDisaggregations();
        this.editMode = true;
        this.disaggregationModal = document.createElement('add-edit-disaggregation-dialog');
        this.disaggregationModal.setAttribute('id', 'disaggregationModal');
        this.disaggregationModal.addEventListener('disaggregation-saved', function(event) {
          this._onDisaggregationSaved(event.detail);
        }.bind(this));
        Polymer.dom(document.querySelector('body')).appendChild(this.disaggregationModal);
      },
      _loadDisaggregations: function() {
        let self = this;
        this.sendRequest({
          method: 'GET',
          endpoint: this.getEndpoint('addGetDisaggregations')
        }).then(function(response) {
          self.set('dataItems', response);
        }).catch(function(error) {
          //TODO
        });
      },
      detached: function() {
        if (this.disaggregationModal) {
          Polymer.dom(document.querySelector('body')).removeChild(this.disaggregationModal);
        }
      },
      _openModal: function() {
        this.disaggregationModal.toastEventSource = this;
        this.disaggregationModal.resetValidations();
        this.disaggregationModal.open();
      },
      _displayGroups: function(groups) {
        if (!groups || !groups.length) {
          return '-';
        }
        return groups.map(function(g){
          return g.value;
        }).join('; ');
      },
      _addDisaggregation: function() {
        this.disaggregationModal.initializeDisaggregation();
        this._openModal();
      },
      _editDisaggregation: function(event) {
        console.log(event.model.item, event.model.index);
        this.disaggregationModal.indexInParent = event.model.index;
        this.disaggregationModal.disaggregation = event.model.item;
        this._openModal();
      },
      _onDisaggregationSaved: function(eventData) {
        console.log('_onDisaggregationSaved',eventData);
        if (eventData.indexInParent === -1) {
          this.push('dataItems', eventData.disaggregation);
        } else {
          let pathToDisaggregation = 'dataItems' + eventdata.indexInParent;
          this.set(pathToDisaggregation, JSON.parse(JSON.stringify(eventData.disaggregation)));
        }
      }

    });
  })();
</script>

