<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">

<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="government-plan-result">
    <template>
        <style include="grid-layout-styles shared-styles repeatable-data-sets-styles buttons-styles iron-flex iron-flex-alignment iron-flex-factors">
            :host {
                padding-bottom: 24px;
                padding-top: 24px;
                display: block;
            }
            paper-input {
                width: 100%;
            }
            .input-wrapper {
                position: relative;
                z-index: 10;
                background: #fff;
                width: 100%;
            }
            .data >*:not(:first-child){
                margin-top: 8px;
            }
            .fixed-width {
                width: 120px;
            }
            .divider {
                padding-right: 16px;
                border-right: 1px solid var(--dark-ink-color);
                margin-right: 12px;
                margin-top: 10px;
            }
            .activity-divider {
                padding-right: 24px;
                border-right:  1px solid var(--dark-ink-color);
            }
            .result-number {
                background: var(--number-icon-fill-color);
                color: var(--light-primary-text-color);
                width: 24px;
                height: 24px;
                border-radius: 50%;
                text-align: center;
                line-height: 24px;
                vertical-align: middle;
            }
            .activities {
                margin: 24px 0;
            }
            .activity {
                background: var(--activity-panel-background-color);
                border-radius: 8px;
                padding: 12px 24px;
                margin-top: 12px;
            }
            .activity paper-input {
                --paper-input-container-label-floating: {
                    padding-bottom: 10px;
                };
                margin: 14px 0 8px 32px;
            }
            #activityId {
                flex: 0 0 55px;
                text-align: center;
            }
            #activityDesc {
                width: auto;
            }
        </style>
        <div class="layout horizontal">
            <!--Remove button and divider-->
            <div class="layout vertical">
                <div class="layout horizontal end-justified">
                    <div class="result-number">
                        [[_incrIndex(index)]]
                    </div>
                </div>
                <div class="layout vertical center-justified flex divider">
                        <paper-icon-button class="action delete"
                                           on-tap="_openDeleteConfirmation"
                                           data-args$="[[index]]"
                                           hidden$="[[!allowEdit]]"
                                           icon="cancel">
                        </paper-icon-button>
                </div>
            </div>
            <!--Data Rows-->
            <div class="layout vertical flex col data">
                <div class="layout horizontal">
                    <!--CP Output-->
                    <div class="col col-6">
                        <template is="dom-if" if="[[allowEdit]]">
                            <etools-searchable-multiselection-menu id="cpOutput"
                                                                   label="CP Output"
                                                                   placeholder="&#8212;"
                                                                   options="[[cpOutputDropdownData]]"
                                                                   on-value-change=""
                                                                   value="{{_mapItemFromId(result.result,cpOutputDropdownData)}}"
                                                                   error-message="Please select a CP Output"
                                                                   required>
                            </etools-searchable-multiselection-menu>
                        </template>
                        <template is="dom-if" if="[[!allowEdit]]">
                            <paper-input
                                    label="CP Output"
                                    value="[[_mapItemFromId(result.result,cpOutputDropdownData,'true')]]"
                                    placeholder="&#8212;"
                                    readonly></paper-input>
                        </template>
                    </div>
                    <!--Year-->
                    <div class="col">
                        <template is="dom-if" if="[[allowEdit]]">
                            <etools-searchable-multiselection-menu id="year"
                                                                   class="fixed-width"
                                                                   label="Year"
                                                                   placeholder="&#8212;"
                                                                   options="[[yearOptions]]"
                                                                   value="{{_mapItemFromId(result.year,yearOptions)}}"
                                                                   on-value-change="_partnerSelected"
                                                                   error-message="Please select a partner"
                                                                   required>
                            </etools-searchable-multiselection-menu>
                        </template>
                        <template is="dom-if" if="[[!allowEdit]]">
                            <paper-input
                                    label="Year"
                                    value="[[_mapItemFromId(result.year,yearOptions,'true')]]"
                                    placeholder="&#8212;"
                                    readonly></paper-input>
                        </template>
                    </div>
                    <!--PLanned Cash-->
                    <div class="col flex">
                        <template is="dom-if" if="[[allowEdit]]">
                            <paper-input
                                    class="input-wrapper"
                                    id="plannedAmount"
                                    label="Planned Cash Transfers in USD"
                                    value="{{result.planned_amount}}"
                                    placeholder="&#8212;"
                                    required>
                            </paper-input>
                        </template>
                        <template is="dom-if" if="[[!allowEdit]]">
                            <paper-input
                                    id="plannedAmount"
                                    label="Planned Cash Transfers in USD"
                                    value="[[result.planned_amount]]"
                                    placeholder="&#8212;"
                                    readonly>
                            </paper-input>
                        </template>
                    </div>
                    <!--Planned Visits-->
                    <div class="col flex">
                        <template is="dom-if" if="[[allowEdit]]">
                            <paper-input
                                    class="input-wrapper"
                                    id="plannedVisits"
                                    label="# of Planned Visits"
                                    value="{{result.planned_visits}}"
                                    placeholder="&#8212;">
                            </paper-input>
                        </template>
                        <template is="dom-if" if="[[!allowEdit]]">
                            <paper-input
                                    id="plannedVisits"
                                    label="# of Planned Visits"
                                    value="{{result.planned_visits}}"
                                    placeholder="&#8212;"
                                    readonly>
                            </paper-input>
                        </template>
                    </div>
                </div>
                <div class="layout horizontal">
                    <!--Programmes-->
                    <div class="col col-6">
                        <template is="dom-if" if="[[allowEdit]]">
                            <etools-searchable-multiselection-menu id="sector"
                                                                   label="Programme(s)/Sector(s)"
                                                                   placeholder="&#8212;"
                                                                   options="[[sectorsDropdownData]]"
                                                                   on-value-change=""
                                                                   error-message="Please select a programme(s)/sector(s)"
                                                                   value="{{_mapItemFromId(result.sectors,sectorsDropdownData)}}"
                                                                   multi>
                            </etools-searchable-multiselection-menu>
                        </template>
                        <template is="dom-if" if="[[!allowEdit]]">
                            <paper-input
                                    id="sector"
                                    label="Programme(s)/Sector(s)"
                                    value="[[_displayMultiple(result.sectors,sectorsDropdownData)]]"
                                    placeholder="&#8212;"
                                    readonly>
                            </paper-input>
                        </template>
                    </div>
                    <div class="col col-6">
                        <template is="dom-if" if="[[allowEdit]]">
                            <etools-searchable-multiselection-menu id="section"
                                                                   label="Section(s)"
                                                                   placeholder="&#8212;"
                                                                   options="[[sectionsDropdownData]]"
                                                                   on-value-change="_sectionsSelected"
                                                                   value="[[_mapItemFromId(result.sections,sectionsDropdownData)]]"
                                                                   error-message="Please select a section(s)"
                                                                   multi>
                            </etools-searchable-multiselection-menu>
                        </template>
                        <template is="dom-if" if="[[!allowEdit]]">
                            <paper-input
                                    id="section"
                                    label="Section(s)"
                                    value="[[_displayMultiple(result.sections,sectionsDropdownData)]]"
                                    placeholder="&#8212;"
                                    readonly>
                            </paper-input>
                        </template>
                    </div>
                </div>
                <div class="layout horizontal">
                    <div class="flex-1">
                        <template is="dom-if" if="[[allowEdit]]">
                            <etools-searchable-multiselection-menu id="focalPoints"
                                                                   label="UNICEF Focal Points"
                                                                   placeholder="&#8212;"
                                                                   options="[[unicefUsersDropdownData]]"
                                                                   on-value-change="_unicefUserSelected"
                                                                   value="{{_mapItemFromId(result.unicef_managers,unicefUsersDropdownData)}}"
                                                                   error-message="Please select a CP Output"
                                                                   multi
                                                                   required>
                            </etools-searchable-multiselection-menu>
                        </template>
                        <template is="dom-if" if="[[!allowEdit]]">
                            <paper-input
                                    id="focalPoints"
                                    label="UNICEF Focal Points"
                                    value="[[_displayMultiple(result.unicef_managers,unicefUsersDropdownData)]]"
                                    placeholder="&#8212;"
                                    readonly>
                            </paper-input>
                        </template>
                    </div>
                </div>
                <div class="activities">
                    <template is="dom-repeat" items="[[activities]]" as="activity">
                        <div class="layout horizontal activity">
                            <!--Activity delete divider-->
                                <div class="layout vertical center-justified activity-divider">
                                        <paper-icon-button class="action delete-activity"
                                                           on-tap="_openDeleteConfirmation"
                                                           data-args$="[[index]]"
                                                           hidden$="[[!allowEdit]]"
                                                           icon="cancel">
                                        </paper-icon-button>
                                </div>

                            <!--Activity data-->
                            <div class="layout horizontal flex">
                                <template is="dom-if" if="[[allowEdit]]">
                                    <paper-input
                                            id="activityId"
                                            label="Activity ID"
                                            value="{{activity.id}}"
                                            placeholder=" ">
                                    </paper-input>
                                    <div class="flex">
                                        <paper-input
                                                id="activityDesc"
                                                label="Activity Description"
                                                value="{{activity.description}}"
                                                placeholder=" ">
                                        </paper-input>
                                    </div>
                                </template>
                                <template is="dom-if" if="[[!allowEdit]]">
                                    <paper-input
                                            id="activityId"
                                            label="Activity ID"
                                            value="{{activity.id}}"
                                            readonly
                                            placeholder=" ">
                                    </paper-input>
                                    <div class="flex">
                                        <paper-input
                                                id="activityDesc"
                                                label="Activity Description"
                                                value="{{activity.description}}"
                                                readonly
                                                placeholder=" ">
                                        </paper-input>
                                    </div>
                                </template>

                            </div>
                        </div>
                    </template>
                </div>
                <a on-tap="_addActivity" class="text-button" hidden$="[[!allowEdit]]">Add Work Plan Activity</a>
            </div>
        </div>
    </template>

    <script>
        (function(){
            Polymer({
                is : "government-plan-result",
                behaviors: [
                    pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
                    pmpBehaviors.CommonGeneralBehavior
                ],
                properties: {
                    result: {
                        type: Object,
                        notify: true,
                        observer: '_objToArray'
                    },
                    cpOutputDropdownData :{
                        type: Array,
                        statePath: 'cpOutputs'
                    },
                    yearOptions: {
                        type: Array,
                        notify: true,
                    },
                    sectorsDropdownData: {
                        type: Array,
                        statePath: 'sectors'
                    },
                    sectionsDropdownData: {
                        type: Array,
                        statePath: 'sections'
                    },
                    unicefUsersDropdownData: {
                        type: Array,
                        statePath: 'unicefUsersData'
                    },
                    activities: {
                        type: Array,
                        notify: true,
                        value: []
                    },
                    allowEdit: {
                        type: Boolean,
                        notify: true,
                    }
                },
                _mapItemFromId : function(id,collection, getLabelOnly){
                    if(_.isEmpty(collection)){
                        return
                    }
                    return getLabelOnly ? _.find(collection, {value:id}).label :
                           Array.isArray(id) ? _.map(id, function(item){
                                                    return  _.find(collection, {value:item})})  :
                           _.find(collection, {value:id})
                },
                _objToArray: function () {
                    this.activities = _.map(this.result.activities, function(value,key){
                        return {
                            id: key,
                            description: value
                        }
                    })
                },
                _displayMultiple: function(id, collection){
                    var entries = this._mapItemFromId(id, collection)
                    if (Array.isArray(entries)){
                        return _.map(entries, function(e){
                            return e.label
                        }).join(', ')
                    }
                    return entries.label;
                },
                _incrIndex: function(index){
                    return index+1;
                },
                attached: function () {
                }
            })
        }
        )();
    </script>
</dom-module>