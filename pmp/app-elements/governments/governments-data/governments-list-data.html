<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">

<link rel="import" href="../../../app-behaviors/data-element-behavior.html">

<dom-module id="governments-list-data">

  <template>

    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="governments"
                 on-success="_handleResponse"></etools-ajax>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'governments-list-data',

        behaviors: [pmpBehaviors.DataElementBehavior],

        properties: {

          endpointName: {
            type: String,
            value: 'governments'
          },

          dataLoadedEventName: {
            type: String,
            value: 'governments-loaded'
          },

          filteredInterventions: {
            type: Array,
            readOnly: true,
            notify: true
          },

          totalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },

          currentQuery: {
            type: Object,
            value: null
          }
        },

        query: function(field, order, searchString, documentTypes, cpOutputs,
                        interventionStatuses, sectors, unicefFocalPoints, offices, startDate,
                        endDate, pageNumber, pageSize) {

          // If an active query transaction exists, abort it and start
          // a new one
          if (this.currentQuery) {
            this.currentQuery.abort();
          }

          var _this = this;

          this.db.transaction('r', this.db.governments, function() {
            this.currentQuery = Dexie.currentTransaction;

            var queryResult = _this.db.governments;
            if (field) {
              // note: null values don't appear in result set of sort
              queryResult = queryResult.orderBy(field);
            }
            if (order === 'desc') {
              queryResult = queryResult.reverse();
            }

            queryResult = queryResult.filter(function(governments) {

              // if (documentTypes.length) {
              //   var matchType = documentTypes.filter(function(selectedType) {
              //     return selectedType === governments.document_type;
              //   })[0];

              //   if (!matchType) {
              //     return false;
              //   }
              // }

              // if (cpOutputs.length) {
              //   var matchCpOut = governments.cp_outputs.filter(function(cpOut) {
              //     return cpOutputs.indexOf(cpOut) > -1;
              //   });
              //   if (matchCpOut && matchCpOut.length === 0) {
              //     return false;
              //   }
              // }

              // if (governmentsStatuses.length) {
              //   var matchStatus = governmentsStatuses.filter(function(selectedStatus) {
              //     return selectedStatus === governments.status;
              //   })[0];

              //   if (!matchStatus) {
              //     return false;
              //   }
              // }

              // if (sectors.length) {
              //   var matchSectors = governments.sectors.filter(function(sector) {
              //     return sectors.indexOf(sector) > -1;
              //   });
              //   if (matchSectors && matchSectors.length === 0) {
              //     return false;
              //   }
              // }

              // if (unicefFocalPoints.length) {
              //   var matchUnicefFocalPoints = governments.unicef_focal_points.filter(function(fPt) {
              //     return unicefFocalPoints.indexOf(fPt) > -1;
              //   });
              //   if (matchUnicefFocalPoints && matchUnicefFocalPoints.length === 0) {
              //     return false;
              //   }
              // }

              // if (offices.length) {
              //   var matchOffices = governments.offices.filter(function(officeId) {
              //     return offices.indexOf(officeId) > -1;
              //   });
              //   if (matchOffices && matchOffices.length === 0) {
              //     return false;
              //   }
              // }

              // if (startDate && startDate.length &&
              //     (!governments.start || governments.start < startDate)) {
              //   return false;
              // }

              // if (endDate && endDate.length &&
              //     (!governments.end || governments.end > endDate)) {
              //   return false;
              // }

              // if (searchString && searchString.length &&
              //     governments.title.toLowerCase().indexOf(searchString) < 0 &&
              //     governments.partner_name.toLowerCase().indexOf(searchString) < 0) {
              //   return false;
              // }

              return true;
            });

            // This special Dexie function allows the work of counting
            // the number of query results to be done in a parallel process,
            // instead of blocking the main query
            Dexie.ignoreTransaction(function() {
              queryResult.count(function(count) {
                _this._setTotalResults(count);
              });
            });

            return queryResult
                .offset((pageNumber - 1) * pageSize)
                .limit(pageSize)
                .toArray();

          }).then(function(result) {
            _this._setFilteredInterventions(result);
          }).catch(function(error) {
            console.error('Error querying interventions: ' + error);
          });
        }

      });
    })();
  </script>

</dom-module>
