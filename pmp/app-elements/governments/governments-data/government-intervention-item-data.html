<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../app-config/etools-app-config.html">
<link rel="import" href="../../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../../app-behaviors/ajax-server-errors-behavior.html">

<dom-module id="government-intervention-item-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="dexie"
                 on-success="_handleResponse"
                 on-fail="handleErrorResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'government-intervention-item-data',
        behaviors: [
          etoolsAppConfig.globals,
          pmpBehaviors.AjaxServerErrorsBehavior,
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior
        ],
        properties: {
          intervention: {
            type: Object,
            readOnly: true,
            notify: true
          },
          endpoint: {
            type: Object,
          },
          interventionId: {
            type: Number,
            notify: true,
            observer: '_interventionIdChanged'
          },
          allSectors: {
            type: Array,
            statePath: 'sectors'
          },
          allCountryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          allPartners: {
            type: Array,
            statePath: 'partners'
          },

          handleResponseAdditionalCallback: Object,
          ajaxEl: Object
        },
        ready: function() {
          this.ajaxEl = this.$.ajax;
        },
        saveIntervention: function(intervention, cb) {
          if (_.isEmpty(intervention)) {
            this.fire('toast', {text: 'Invalid intervention data!', showCloseBtn: true});
          } else {
            var url = null;
            var isNew = false;
            if (_.has(intervention, 'id')) {
              //PATCH endpoint
              this._prepareEndpoint(intervention.id);
              url = this.endpoint.url;
            } else {
              url = this.getEndpoint('governments').url;
              isNew = true;
            }
            if (!_.isEmpty(intervention)) {
              if (cb) {
                this.set('handleResponseAdditionalCallback', cb);
              }
              this.fire('global-loading', {message: 'Saving government intervention data...', active: true});
              this._prepareAndFireRequest((isNew) ? 'POST' : 'PATCH', intervention, url);
            } else {
              this.fire('toast', {
                text: 'There is nothing to save. No change detected on this intervention.',
                showCloseBtn: true
              });
            }
          }
        },
        _prepareAndFireRequest: function(method, data, url) {
          // reset ajax
          this._resetAjax();
          if (!method) {
            method = 'GET';
          }
          this.ajaxEl.set('method', method);
          if (typeof data === 'object' && Object.keys(data).length > 0
            && ['PATCH', 'POST'].indexOf(method) > -1) {
            this.ajaxEl.set('body', data);
            this.ajaxEl.set('url', url);
          }

          // after body is set the request is automatically triggered
        },
        _resetAjax: function() {
          this.ajaxEl.set('params', null);
          this.ajaxEl.set('body', null);
          this.ajaxEl.set('url', null);
        },
        _handleResponse: function(response) {
          if (!(typeof response.detail === 'object' && Object.keys(response.detail).length)) {
            // TODO: there are cases when this response is an empty object,
            // gov interv doesn't exists, but the servers returns empty object with 200 HTTP status
            console.warn('[Gov-intervention-item-data] Empty response!');
            return;
          }
          this._setIntervention(response.detail);

          // update the government interventions list in dexieDB
          var mappedResponse = this._formatResponseDataForDexie(response.detail);
          if (mappedResponse && Object.keys(mappedResponse).length) {
            etoolsAppConfig.db.table('governments').put(mappedResponse);
          }

          if (typeof this.handleResponseAdditionalCallback === 'function') {
            this.handleResponseAdditionalCallback.bind(this, response.detail)();
            this.set('handleResponseAdditionalCallback', null);
          }
        },

        _interventionIdChanged: function(newId) {
          if (newId) {
            this.fire('global-loading', {message: 'Loading government intervention data...', active: true});
            this._prepareAndFireRequest();
            this.set('endpoint', this.getEndpoint('governmentsDetails', {id: newId}));
          }
        },

        _prepareEndpoint: function(id) {
          if (id > 0) {
            // check and prepare request URL
            if (!this.endpoint || (this.endpoint && !this.endpoint.url)) {
              this.set('endpoint', this.getEndpoint('governmentsDetails', {id: id}));
            }
          }
        },

        _formatResponseDataForDexie: function(responseDetail) {
          var dexieObject = {};
          var sectorIds = [];
          var key;

          dexieObject.id = responseDetail.id;
          dexieObject.number = responseDetail.number;
          dexieObject.partner = responseDetail.partner;
          dexieObject.created_at = responseDetail.created_at;
          dexieObject.country_programme = responseDetail.country_programme;
          dexieObject.years = [];
          dexieObject.sectors = [];
          dexieObject.cp_outputs = [];
          dexieObject.unicef_focal_points = [];

          responseDetail.results.forEach(function(responseElement) {
            dexieObject.years = this._pushIfNew(dexieObject.years, responseElement.year);
            dexieObject.cp_outputs = this._pushIfNew(dexieObject.cp_outputs, responseElement.result);

            for (key in responseElement.unicef_managers) {
              var workingElem = responseElement.unicef_managers[key];
              dexieObject.unicef_focal_points = this._pushIfNew(dexieObject.unicef_focal_points, workingElem);
            }

            for (key in responseElement.sectors) {
              sectorIds = this._pushIfNew(sectorIds, responseElement.sectors[key]);
            }
          }.bind(this));

          sectorIds.forEach(function(sectorId) {
            for (key in this.allSectors) {
              var workingSector = this.allSectors[key];

              if (workingSector.id === sectorId) {
                dexieObject.sectors.push(workingSector.name);
              }
            }
          }.bind(this));

          this.allPartners.forEach(function(partner) {
            if (partner.id === dexieObject.partner) {
              dexieObject.partner_name = partner.name;
            }
          });

          this.allCountryProgrammes.forEach(function(elem) {
            if (elem.value === dexieObject.country_programme) {
              dexieObject.country_programme_name = elem.name;
            }
          });

          return dexieObject;
        },

        _pushIfNew: function(array, value) {
          if (array.indexOf(value) < 0) {
            array.push(value);
          }
          return array;
        }
      });
    })();
  </script>
</dom-module>
