<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../app-behaviors/repeatable-data-sets-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../app-behaviors/object-databind-behavior.html">
<link rel="import" href="../../app-behaviors/esmm-missing-options/missing-dropdown-options-behavior.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="government-result-activities.html">

<dom-module id="government-plan-results">
  <template strip-whitespace>
    <style
        include="grid-layout-styles shared-styles repeatable-data-sets-styles buttons-styles iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        padding-bottom: 24px;
        padding-top: 24px;
        display: block;
      }

      paper-input {
        width: 100%;
      }

      .input-wrapper {
        position: relative;
        z-index: 10;
        background: var(--primary-background-color, #FFFFFF);
        width: 100%;
      }

      .data > *:not(:first-child) {
        margin-top: 8px;
      }

      .fixed-width {
        width: 120px;
      }

      .divider {
        padding-right: 16px;
        border-right: 1px solid var(--dark-ink-color);
        margin-right: 12px;
        margin-top: 10px;
      }

      .activity-divider {
        padding-right: 24px;
        border-right: 1px solid var(--dark-ink-color);
      }

      .result-number {
        background: var(--medium-icon-color);
        color: var(--light-primary-text-color);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        text-align: center;
        line-height: 24px;
        vertical-align: middle;
      }

      .activities, .resultItem {
        margin: 24px 0;
      }

    </style>
    <etools-ajax id="deleteAjax"
                 on-success="_handleDeleteResponse"
                 on-fail="_handleDeleteError"></etools-ajax>
    <template is="dom-repeat" items="{{dataItems}}" as="result">
      <div class="layout horizontal resultItem">
        <!--Remove button and divider-->
        <div class="layout vertical">
          <div class="layout horizontal end-justified">
            <div class="result-number">
              [[_incrIndex(index)]]
            </div>
          </div>
          <div class="layout vertical center-justified flex divider">
            <paper-icon-button class="action delete"
                               on-tap="_openDeleteConfirmation"
                               data-args$="[[index]]"
                               hidden$="[[!editMode]]"
                               icon="cancel">
            </paper-icon-button>
          </div>
        </div>
        <!--Data Rows-->
        <div class="layout vertical flex col data">
          <div class="layout horizontal">
            <!--CP Output-->
            <div class="col col-6">
              <template is="dom-if" if="[[editMode]]">
                <etools-searchable-multiselection-menu id$="result_[[index]]"
                                                       label="CP Output"
                                                       index="[[index]]"
                                                       placeholder="&#8212;"
                                                       options="[[getCleanEsmmOptions(filteredCpOutputDropdownData, dataItems)]]"
                                                       option-value="id"
                                                       option-label="name"
                                                       custom-object-options
                                                       selected="{{result.result}}"
                                                       update-selected
                                                       error-message="Please select a CP Output. If there aren't any to choose from, check the Country Programme."
                                                       required
                                                       url="[[missingCpOutputsUrl]]"
                                                       ajax-params="[[_getMissingEsmmOptAjaxParams()]]">
                </etools-searchable-multiselection-menu>
              </template>
              <template is="dom-if" if="[[!editMode]]">
                <paper-input
                    label="CP Output"
                    value="[[_mapItemFromId(result.result,filteredCpOutputDropdownData,'true')]]"
                    placeholder="&#8212;"
                    readonly></paper-input>
              </template>
            </div>
            <!--Year-->
            <div class="col">
              <template is="dom-if" if="[[editMode]]">
                <etools-searchable-multiselection-menu id$="year_[[index]]"
                                                       label="Year"
                                                       index="[[index]]"
                                                       class="fixed-width"
                                                       placeholder="&#8212;"
                                                       options="[[yearOptions]]"
                                                       selected="{{result.year}}"
                                                       update-selected
                                                       error-message="Please select a year"
                                                       disabled="[[_yearsEmpty(yearOptions)]]"
                                                       required>
                </etools-searchable-multiselection-menu>
              </template>
              <template is="dom-if" if="[[!editMode]]">
                <paper-input
                    label="Year"
                    value="[[_mapItemFromValue(result.year, yearOptions, 'true')]]"
                    placeholder="&#8212;"
                    readonly></paper-input>
              </template>
            </div>
            <!--PLanned Cash-->
            <div class="col flex">
              <template is="dom-if" if="[[editMode]]">
                <paper-input
                    class="input-wrapper"
                    id$="planned_amount_[[index]]"
                    label="Planned Cash Transfers in USD"
                    index="[[index]]"
                    value="{{result.planned_amount}}"
                    on-change="_handleInputChange"
                    placeholder="&#8212;"
                    error-message="Please enter Planned Cash"
                    required>
                </paper-input>
              </template>
              <template is="dom-if" if="[[!editMode]]">
                <paper-input
                    id="plannedAmount"
                    label="Planned Cash Transfers in USD"
                    value="[[result.planned_amount]]"
                    placeholder="&#8212;"
                    readonly>
                </paper-input>
              </template>
            </div>
            <!--Planned Visits-->
            <div class="col flex">
              <template is="dom-if" if="[[editMode]]">
                <paper-input
                    class="input-wrapper"
                    id$="planned_visits_[[index]]"
                    label="# of Planned Visits"
                    index="[[index]]"
                    value="{{result.planned_visits}}"
                    on-change="_handleInputChange"
                    placeholder="&#8212;"
                    error-message="Please enter # of Planned Visits"
                    required>
                </paper-input>
              </template>
              <template is="dom-if" if="[[!editMode]]">
                <paper-input
                    id="plannedVisits"
                    label="# of Planned Visits"
                    value="[[result.planned_visits]]"
                    placeholder="&#8212;"
                    readonly>
                </paper-input>
              </template>
            </div>
          </div>
          <div class="layout horizontal">
            <!--Programmes-->
            <div class="col col-6">
              <template is="dom-if" if="[[editMode]]">
                <etools-searchable-multiselection-menu id="sectors"
                                                       label="Programme(s)/Sector(s)"
                                                       index="[[index]]"
                                                       placeholder="&#8212;"
                                                       options="[[sectorsDropdownData]]"
                                                       custom-object-options
                                                       option-label="name"
                                                       option-value="id"
                                                       error-message="Please select a programme(s)/sector(s)"
                                                       update-selected
                                                       selected="{{result.sectors}}"
                                                       multi>
                </etools-searchable-multiselection-menu>
              </template>
              <template is="dom-if" if="[[!editMode]]">
                <paper-input
                    id="sector"
                    label="Programme(s)/Sector(s)"
                    value="[[_displayMultiple(result.sectors,sectorsDropdownData)]]"
                    placeholder="&#8212;"
                    readonly>
                </paper-input>
              </template>
            </div>
            <div class="col col-6">
              <template is="dom-if" if="[[editMode]]">
                <etools-searchable-multiselection-menu id="sections"
                                                       label="Section(s)"
                                                       index="[[index]]"
                                                       placeholder="&#8212;"
                                                       options="[[sectionsDropdownData]]"
                                                       custom-object-options
                                                       option-label="name"
                                                       option-value="id"
                                                       update-selected
                                                       selected="{{result.sections}}"
                                                       error-message="Please select a section(s)"
                                                       multi>
                </etools-searchable-multiselection-menu>
              </template>
              <template is="dom-if" if="[[!editMode]]">
                <paper-input
                    id="section"
                    label="Section(s)"
                    value="[[_displayMultiple(result.sections,sectionsDropdownData)]]"
                    placeholder="&#8212;"
                    readonly>
                </paper-input>
              </template>
            </div>
          </div>
          <div class="layout horizontal">
            <div class="flex-1">
              <template is="dom-if" if="[[editMode]]">
                <etools-searchable-multiselection-menu id="unicef_managers"
                                                       label="UNICEF Focal Points"
                                                       index="[[index]]"
                                                       placeholder="&#8212;"
                                                       options="[[getCleanEsmmOptions(unicefUsersDropdownData, dataItems)]]"
                                                       custom-object-options
                                                       option-label="full_name"
                                                       option-value="user_id"
                                                       update-selected
                                                       selected="{{result.unicef_managers}}"
                                                       error-message="Please select a UNICEF manager"
                                                       multi
                                                       required
                                                       url="[[missingUnicefUsersUrl]]"
                                                       ajax-params="[[_getMissingEsmmOptAjaxParams()]]">
                </etools-searchable-multiselection-menu>
              </template>
              <template is="dom-if" if="[[!editMode]]">
                <paper-input
                    id="focalPoints"
                    label="UNICEF Focal Points"
                    value="[[_displayMultiple(result.unicef_managers,unicefUsersDropdownData)]]"
                    placeholder="&#8212;"
                    readonly>
                </paper-input>
              </template>
            </div>
          </div>
          <div class="activities">
            <government-result-activities data-items="{{result.result_activities}}"></government-result-activities>
          </div>
          <a on-tap="_addActivity" index="[[index]]" class="text-button" hidden$="[[!editMode]]">Add Work Plan
            Activity</a>
        </div>
      </div>
    </template>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'government-plan-results',
        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.RepeatableDataSetsBehavior,
          pmpBehaviors.ObjectDatabindBehavior,
          etoolsAppConfig.globals,
          pmpBehaviors.MissingDropdownOptionsBehavior
        ],

        properties: {
          dataItems: {
            type: Array,
            notify: true,
            observer: '_dataItemsChanged'
          },
          cpWbs: {
            type: String,
            value: ''
          },
          cpOutputDropdownData: {
            type: Array,
            statePath: 'cpOutputs'
          },
          filteredCpOutputDropdownData: {
            type: Array
          },
          yearOptions: {
            type: Array,
            notify: true,
            value: []
          },
          sectorsDropdownData: {
            type: Array,
            statePath: 'sectors'
          },
          sectionsDropdownData: {
            type: Array,
            statePath: 'sections'
          },
          unicefUsersDropdownData: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          activities: {
            type: Array,
            notify: true,
          },
          editMode: {
            type: Boolean,
            notify: true,
          },
          _deleteEpName: {
            type: String,
            value: 'governmentIntResultDelete',
            readOnly: true
          },
          missingCpOutputsUrl: String,
          missingUnicefUsersUrl: String
        },
        observers: [
          '_cpWbsChanged(cpWbs)'
        ],
        ready: function() {
          this.set('missingCpOutputsUrl', this.getMissingOptionsEndpointUrl('cpOutputsByIdsAsValues'));
          this.set('missingUnicefUsersUrl', this.getMissingOptionsEndpointUrl('unicefUsers'));
        },
        _dataItemsChanged: function() {
          this._resetErrors();
        },
        _cpWbsChanged: function() {
          if (!this.cpOutputDropdownData) {
            return;
          }

          var cpWbs = this.cpWbs;
          var filteredCpOutputDropdownData = this.cpOutputDropdownData.filter(function(cpo) {
            return (cpo.wbs.indexOf(cpWbs) !== -1);
          });

          this.set('filteredCpOutputDropdownData', filteredCpOutputDropdownData);
        },
        _handleValueChange: function(e) {
          var id = e.target.id;
          var index = e.target.index;
          var dataItemsPath = 'dataItems.' + index;
          // ensure this.result observes subproperty change
          var updatedResult = _.has(e, 'detail.selectedValues') ?
              this._getUpdatedObject(id, e.detail.selectedValues, this.dataItems[index]) :
              this._getUpdatedObject(id, this.dataItems[index].id, this.dataItems[index]);
          this.set(dataItemsPath, updatedResult);
          e.target.invalid = false;
        },
        _handleInputChange: function(e) {
          if (e.target.value) {
            e.target.invalid = false;
          }
        },
        _addActivity: function(e) {
          var activitiesPath = 'dataItems.' + e.target.index + '.result_activities';
          this.push(activitiesPath, {
            'code': '',
            'description': ''
          });
        },
        _fieldsAreValid: function(fields) {
          var self = this;
          var valid = true;
          // looping through result elements and  setting to invalid any with no value assigned
          if (this.dataItems instanceof Array && this.dataItems.length) {
            this.dataItems.forEach(function(item, index) {
              fields.forEach(function(field, fieldIndex) {
                var el = self.$$('#' + field + '_' + index);
                if (el && !el.validate()) {
                  valid = false;
                }
              });
            });
          }
          return valid;
        },
        _resetErrors: function() {
          var self = this;
          var indexedFields = [
            'result',
            'year',
            'planned_amount',
            'planned_visits'
          ];

          if (this.dataItems instanceof Array && this.dataItems.length) {
            this.dataItems.forEach(function(item, index) {
              indexedFields.forEach(function(field, fieldIndex) {
                var el = self.$$('#' + field + '_' + index);
                if (el) {
                  el.invalid = false;
                }
              });
            });
          }
        },
        _yearsEmpty: function(years) {
          return _.isEmpty(years);
        },
        _isCpoIdInDropdown: function(cpoId) {
          var matchedElems = this.filteredCpOutputDropdownData.filter(function(elem) {
            return elem.value === cpoId;
          });
          return !!matchedElems.length;
        },

        _getMissingEsmmOptAjaxParams: function() {
          return {dropdown: true};
        }

      });
    })();
  </script>
</dom-module>
