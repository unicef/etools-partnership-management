<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../app-config/etools-app-config.html">

<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../scripts/lodash/lodash.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/list-filters-behavior.html">
<link rel="import" href="../../app-behaviors/lists-common-behavior.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-filter-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/partner-status-styles.html">

<link rel="import" href="governments-data/governments-list-data.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">

<dom-module id="governments-list">

  <template strip-whitespace>

    <style include="shared-styles data-table-styles grid-layout-styles list-filter-styles">
      :host {
        @apply(--layout-flex);
        width: 100%;
      }
    </style>
    <template is="dom-if" if="[[stampListData]]">
      <governments-list-data id="governments"
                           filtered-governments="{{filteredGovernments}}"
                           total-results="{{totalResults}}"
                           on-governments-loaded="_requiredDataHasBeenLoaded"
                           list-data-path="filteredGovernments"
                           unicef-users-data="[[unicefUsersData]]"
                           fire-data-loaded>
      </governments-list-data>
    </template>

    <paper-material id="listControls" elevation="1">

      <div class="wrap-controls">

        <paper-input id="query"
                     type="search"
                     placeholder="Search"
                     autocomplete="off"
                     value="{{q}}">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
        <!--  -->
        <template is="dom-repeat" items="[[selectedFilters]]" as="filter">

          <template is="dom-if" if="[[filterTypeIs('esmm', filter.type)]]">
            <div class="filter esmm">
              <etools-searchable-multiselection-menu
                  label="[[filter.filterName]]"
                  placeholder="&#8212;"
                  disabled$="[[!filter.selectionOptions.length]"
                  options="[[filter.selectionOptions]]"
                  value="[[filter.alreadySelected]]"
                  multi="[[filter.multiple]]"
                  custom-object-options="[[filter.customObjectOptions]]"
                  option-value="[[filter.optionValue]]"
                  option-label="[[filter.optionLabel]]"
                  on-value-change="esmmValueChanged"
                  data-filter-path$="[[filter.path]]"></etools-searchable-multiselection-menu>
              <paper-icon-button suffix class="remove-field remove" icon="cancel"
                                 on-tap="removeFilter"
                                 data-filter-name$="[[filter.filterName]]"
                                 data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>

          <template is="dom-if" if="[[filterTypeIs('datepicker', filter.type)]]">
            <div class="filter">
              <paper-input label="[[filter.filterName]]"
                           on-down="openDatePicker"
                           data-selector$="datepicker_[[filter.path]]">
                <etools-datepicker-button prefix
                                          id$="datepicker_[[filter.path]]"
                                          format="D MMM YYYY"
                                          data-filter-path$="[[filter.path]]"
                                          on-date-has-changed="_filterDateHasChanged"
                                          no-init show-clear-btn fire-date-has-changed>
                </etools-datepicker-button>
                </paper-icon-button>
              </paper-input>
              <paper-icon-button suffix class="remove-field remove" icon="cancel"
                                 on-tap="removeFilter"
                                 data-filter-name$="[[filter.filterName]]"
                                 data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>

        </template>
      </div>

      <div class="fixed-controls">

        <div class="filters-divider"></div>

        <paper-menu-button id="filterMenu" dynamic-align>
          <paper-button class="button dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>add filter</paper-button>
          <paper-menu class="dropdown-content">
            <template is="dom-repeat" items="[[availableListFilterOptions]]">
              <paper-item on-tap="selectFilter">[[item.filterName]]</paper-item>
            </template>
          </paper-menu>
        </paper-menu-button>

      </div>
    </paper-material>

    <paper-material id="list" elevation="1">

      <etools-data-table-header id="listHeader" label="[[visibleRange.0]]-[[visibleRange.1]] of [[totalResults]] results to show">
        <etools-data-table-column class="col-2" field="number" sortable>
          Reference #
        </etools-data-table-column>
        <etools-data-table-column class="col-4" field="partner_name"  sortable>
          Government Partner
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="country_programme_name"  sortable>
          Country Programme
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="created_at">
          Years
        </etools-data-table-column>

      </etools-data-table-header>

       <template id="rows" is="dom-repeat" notify-dom-change items="[[filteredGovernments]]"
                as="entry" initial-count="10" on-dom-change="_listDataChanged">
        <etools-data-table-row details-opened="[[detailsOpened]]">
          <div slot="row-data">
            <a class="col-data col-2 truncate"
               href="governments/[[entry.id]]/details"
               title="[[getDisplayValue(entry.number)]]">
              [[getDisplayValue(entry.number)]]
            </a>
            <span class="col-data col-4 truncate" title="[[getDisplayValue(entry.partner_name)]]">
                [[getDisplayValue(entry.partner_name)]]
            </span>
            <span class="col-data flex-c">
                [[getDisplayValue(entry.country_programme_name)]]
            </span>
            <span class="col-data flex-c">
                [[getDisplayValue(entry.years)]]
            </span>
          </div>
          <div slot="row-data-details">

            <div class="row-details-content col-2">
              <span class="rdc-title">Unicef Focal Point</span>
              <span>[[getDisplayValue(entry.unicef_focal_point_names)]]</span>
            </div>

            <div class="row-details-content col-2">
              <span class="rdc-title">Sectors</span>
              <span>[[getDisplayValue(entry.sectors)]]</span>
            </div>

          </div>
        </etools-data-table-row>
      </template>

      <etools-data-table-footer
          page-size="[[pageSize]]"
          page-number="[[pageNumber]]"
          total-results="[[totalResults]]"
          visible-range="{{visibleRange}}"
          on-page-size-changed="_pageSizeChanged"
          on-page-number-changed="_pageNumberChanged">
      </etools-data-table-footer>

    </paper-material>

  </template>

  <script>
    (function() {
      'use strict';
      var _governmentsLastNavigated = null;

      Polymer({
        is: 'governments-list',

        behaviors: [
          pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
          pmpBehaviors.CommonGeneralBehavior,
          pmpBehaviors.DropdownBehavior,
          pmpBehaviors.ListFiltersBehavior,
          etoolsAppConfig.globals,
          pmpBehaviors.ListsCommonBehavior,
        ],

        properties: {
          filteredGovernments: {
            type: Array,
            notify: true,
            observer: '_listChanged'
          },

          sortOrder: {
            type: Object,
            value: {
              field: 'partner_name',
              direction: 'asc'
            }
          },

          totalPages: {
            type: Number
          },

          visibleRange: {
            type: Array
          },

          urlParams: {
            type: Object
          },

          // hrps will be populated with global data from EtoolsDropdownPmpDataReduxBehavior store
          hrps: {
            type: Array,
            statePath:  'hrps'
          },
          cpOutputs: {
            type: Array,
            statePath:  'cpOutputs'
          },
          selectedCpOutputs: {
            type: Array,
            observer: '_filtersChanged'
          },

          sectors: {
            type: Array,
            statePath: 'sectors'
          },
          years: {
            type: Array,
            value: []
          },

          selectedSectors: {
            type: Array,
            observer: '_filtersChanged'
          },

          selectedYears: {
            type: Array,
            observer: '_filtersChanged'
          },

          selectedPartner: {
            type: String,
            value: '',
            observer: '_filtersChanged'
          },

          selectedUnicefFocalPoints: {
            type: Array,
            observer: '_filtersChanged'
          },

          selectedPartners: {
            type: Array,
            observer: '_filtersChanged'
          },

          partnerIds: {
            type: Array
          },

          partnersDropdownData: {
            type: Array,
            statePath: 'partnersFilteredDropdownData'
          },

          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          countryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          csvDownloadUrl: {
            type: String,
            notify: true
          },

        },

        listeners: {
          'sort-changed': '_sortOrderChanged',
        },

        observers: [
          '_updateURL(q, partnerIds, selectedCpOutputs, selectedPartners, selectedSectors,' +
            'selectedYears, selectedUnicefFocalPoints, pageNumber, pageSize, sortOrder)',
          '_mapIdsToMultiselect(partnersDropdownData)',
          '_init(active)'
        ],

        ready: function() {
          this.$.list.classList.add('hidden');
          this._getYears();

          // init list filter options
          this.initListFiltersData([
            {
              filterName: 'Partner',
              type: 'esmm', // etools-searchable-multiselection-menu
              multiple: true,
              selectionOptions: [], // will be populated when the partners data is received
              alreadySelected: [],
              customObjectOptions: false,
              optionValue: 'value',
              optionLabel: 'label',
              path: 'selectedPartners'
            },
            {
              filterName: 'UNICEF focal point',
              type: 'esmm', // etools-searchable-multiselection-menu
              multiple: true,
              customObjectOptions: true,
              optionValue: 'user_id',
              optionLabel: 'full_name',
              selectionOptions: this.unicefUsersData,
              alreadySelected: [],
              path: 'selectedUnicefFocalPoints'
            },
            {
              filterName: 'Country Programme Output',
              type: 'esmm', // etools-searchable-multiselection-menu
              multiple: true,
              customObjectOptions: true,
              optionValue: 'id',
              optionLabel: 'name',
              selectionOptions: this.cpOutputs,
              alreadySelected: [],
              path: 'selectedCpOutputs'
            },
            {
              filterName: 'Sectors',
              type: 'esmm', // etools-searchable-multiselection-menu
              multiple: true,
              customObjectOptions: true,
              optionValue: 'id',
              optionLabel: 'name',
              selectionOptions: this.sectors,
              alreadySelected: [],
              path: 'selectedSectors'
            },
            {
              filterName: 'Years',
              type: 'esmm', // etools-searchable-multiselection-menu
              multiple: true,
              customObjectOptions: false,
              optionValue: 'value',
              optionLabel: 'label',
              selectionOptions: this.years,
              alreadySelected: [],
              path: 'selectedYears'
            },
          ]);
        },

        attached: function() {
          this.listAttachedCallback(this.active, 'Loading government interventions list data...');
        },

        // Input: URL query params
        // Initializes the properties of the list at page load
        // to the params interpretted from the URL string.
        _init: function(active) {
          var parms = this.urlParams;
          if (!active || !parms) {
            return;
          }

          this.set('q', parms.q ? parms.q : '');
          this.set('selectedCpOutputs', parms.cp_outputs ? this._setSelectedCpOutputs(parms.cp_outputs) : []);
          this.set('partnerIds', parms.partners ? this._parsePartnerIds(parms.partners) : []);
          this.set('selectedUnicefFocalPoints',
              parms.unicef_focal_points ? this._setSelectedUnicefFocalPoints(parms.unicef_focal_points) : []);
          this.set('selectedSectors', parms.sector ? this._setSelectedSectors(parms.sector) : []);
          this.set('pageNumber', parms.page ? parseInt(parms.page) : 1);
          this.set('pageSize', parms.size ? parseInt(parms.size) : this.defaultListsSize);
          this.set('selectedYears', parms.year ? this._setSelectedYears(parms.year) : []);

          // format of sort param is sort=field.order ex: sort=name.asc
          var result = {field: 'partner_name', direction: 'asc'};
          if (parms.sort) {
            var p = parms.sort.split('.');
            result = {field: p[0], direction: p[1]};
          }
          this.set('sortOrder', result);
          this._updateSelectedFiltersValues();
        },

        // update selected filters (set in the url) at page refresh
        _updateSelectedFiltersValues: function() {
          this.debounce('updaetShownFilters', function() {
            var filtersValues = [
              {
                filterName: 'Partner',
                selectedValue: this.selectedPartners
              },
              {
                filterName: 'UNICEF focal point',
                selectedValue: this.selectedUnicefFocalPoints
              },
              {
                filterName: 'Country Programme Output',
                selectedValue: this.selectedCpOutputs
              },
              {
                filterName: 'Sectors',
                selectedValue: this.selectedSectors
              },
              {
                filterName: 'Years',
                selectedValue: this.selectedYears
              }
            ];
            this.updateShownFilters(filtersValues);
          }.bind(this), 100);
        },

        // Updates URL state with new query string, and launches query
        _updateURL: function() {
          this.set('csvDownloadUrl', this._buildCsvDownloadUrl());
          var qs = this._buildQueryString();

          if (qs !== _governmentsLastNavigated) {
            _governmentsLastNavigated = qs;
            // update URL
            this.updateAppState('governments/list', qs, true);
            // filter governments
            this._filterGovernmentsData();
          } else {
            if (location.search === '') {
              // only update URL query string, without location change event being fired(no page refresh)
              this.updateAppState('governments/list', qs, false);
            }
            if (this.forceDataRefresh) {
              // refilter agreements data
              // this will only execute when agreements-loaded event is received
              this._filterGovernmentsData();
              this.set('forceDataRefresh', false);
            }
          }

        },

        // Convert ids from URL into array of ids
        _parsePartnerIds: function(urlIds) {
          return _.map(urlIds.split('|'), function(item) {
            return parseInt(item);
          });
        },

        _filterGovernmentsData: function(forceNoLoading) {
          // Query is debounced with a debounce time
          // set depending on what action the user takes
          this.debounce('query', function() {
            var governments = this.$$('#governments');
            if (!governments) {
              return;
            }
            governments.query(
              this.sortOrder.field,
              this.sortOrder.direction,
              this.q.toLowerCase(),
              _.map(this.selectedPartners, 'label'),
              (this.selectedUnicefFocalPoints && this.selectedUnicefFocalPoints.length)
                  ? this.selectedUnicefFocalPoints.map(function(fPt) {
                return parseInt(fPt.user_id);
              }) : [],

              (this.selectedCpOutputs && this.selectedCpOutputs.length)
                  ? this.selectedCpOutputs.map(function(cpOutput) {
                return cpOutput.id;
              }) : [],

              (this.selectedSectors && this.selectedSectors.length)
                  ? this.selectedSectors.map(function(sector) {
                return sector.name;
              }) : [],
              (this.selectedYears && this.selectedYears.length)
                  ? this.selectedYears.map(function(year) {
                return year.label;
              }) : [],

              this.pageNumber,
              this.pageSize,
              forceNoLoading ? false : this.showQueryLoading
            );

          }, this.debounceTime);
        },

        // Outputs the query string for the list
        _buildQueryString: function() {
          var out = [];
          if (this.pageNumber && this.pageNumber > 1) {
            out.push('page=' + this.pageNumber);
          }
          if (this.pageSize) {
            out.push('size=' + this.pageSize);
          }
          if (this.q && this.q.length) {
            out.push('q=' + this.q);
          }

          if (this.selectedCpOutputs && this.selectedCpOutputs.length) {
            out.push('cp_outputs=' + this.selectedCpOutputs.map(function(cpOutput) {
              return cpOutput.id;
            }).join('|'));
          }

          if (this.selectedUnicefFocalPoints && this.selectedUnicefFocalPoints.length) {
            out.push('unicef_focal_points=' + this.selectedUnicefFocalPoints.map(function(focalPt) {
              return focalPt.user_id;
            }).join('|'));
          }

          if (this.sortOrder && this.sortOrder.field && this.sortOrder.direction) {
            out.push('sort=' + this.sortOrder.field + '.' + this.sortOrder.direction);
          }

          if (this.selectedPartners && this.selectedPartners.length) {
            out.push('partners=' + _.map(this.selectedPartners, 'value').join('|'));
          }

          if (this.selectedSectors && this.selectedSectors.length) {
            out.push('sector=' + this.selectedSectors.map(function(sector) {
              return sector.name;
            }).join('|'));
          }

          if (this.selectedYears && this.selectedYears.length) {
            out.push('year=' + this.selectedYears.map(function(year) {
              return year.label;
            }).join('|'));
          }

          return out.join('&');
        },

        _buildCsvDownloadUrl: function() {
          var queryString = '';
          var endpointUrl = '';
          var params = [];

          // if (this.selectedCpOutputs && this.selectedCpOutputs.length) {
          //   params.push('country_programme=' + this.selectedCpOutputs[0]);
          // }

          if (this.selectedPartners && this.selectedPartners.length) {
            params.push('partner=' + this.selectedPartners[0].value);
          }
          if (this.selectedSectors && this.selectedSectors.length) {
            params.push('sector=' + this.selectedSectors[0].id);
          }
          if (this.selectedYears && this.selectedYears.length) {
            params.push('year=' + this.selectedYears[0].value);
          }
          if (this.selectedUnicefFocalPoints && this.selectedUnicefFocalPoints.length) {
            params.push('unicef_focal_point=' + this.selectedUnicefFocalPoints[0].user_id);
          }

          params.push('format=csv');
          queryString = params.join('&');
          endpointUrl = this.getEndpoint('governments').url;

          return endpointUrl + '?' + queryString;
        },

        // Run when partners-data is fully loaded
        // Maps array of partner ids to multiselect compatible {value, label} format
        // using partners-data to fetch names for labels
        _mapIdsToMultiselect: function(partnersDropdownData) {
          // update partner filter
          this.updateFilters('Partner', 'selectionOptions', partnersDropdownData);

          // update selected partners if any
          this.set('selectedPartners', _.compact(_.map(this.partnerIds, function(id) {
            var partner = partnersDropdownData.filter(function(p) {
              return p.value === id;
            })[0];
            if (partner) {
              return {
                value: id,
                label: partner.label
              };
            }
          }.bind(this))));

          this.updateFilters('Partner', 'alreadySelected', this.selectedPartners);

        },

        _setSelectedCpOutputs: function(cpOutputsString) {
          var cpOut = cpOutputsString.split('|');
          if (cpOut && cpOut.length) {
            cpOut = cpOut.map(function(cpOutStrValue) {
              return parseInt(cpOutStrValue, 10);
            });
            return this.cpOutputs.filter(function(cpo) {
              return cpOut.indexOf(parseInt(cpo.id, 10)) > -1;
            });
          }
          return [];
        },

        _setSelectedUnicefFocalPoints: function(focalPtsStr) {
          var focalPtsStrArr = focalPtsStr.split('|');
          if (focalPtsStrArr && focalPtsStrArr.length) {
            focalPtsStrArr = focalPtsStrArr.map(function(fPtsIdStr) {
              return parseInt(fPtsIdStr, 10);
            });
            return this.unicefUsersData.filter(function(u) {
              return focalPtsStrArr.indexOf(parseInt(u.user_id, 10)) > -1;
            });
          }
          return [];
        },

        _setSelectedSectors: function(sectors) {
          var sectorsArr = sectors.split('|');
          if (sectorsArr && sectorsArr.length) {
            return this.sectors.filter(function(s) {
              return sectorsArr.indexOf(s.name) > -1;
            });
          }
          return [];
        },

        _setSelectedYears: function(years) {
          var yearsArr = years.split('|');

          if (yearsArr && yearsArr.length) {
            return this.years.filter(function(y) {
              return yearsArr.indexOf(y.label) > -1;
            });
          }
          return [];
        },

        _dateChanged: function(date) {
          this.set('pageNumber', 1);
        },

        // verify date and prettify or not
        _checkAndShowInterventionDate: function(dateString) {
          return this.getDisplayValue(dateString, true);
        },

        /**
         * Get HRP name to be shown in the intervention details(collapsible content) row
         */
        _getHrpValue: function(hrpId) {
          var hrpData = this.hrps.filter(function(hrp) {
            return parseInt(hrp.id, 10) === parseInt(hrpId, 10);
          })[0];
          if (hrpData) {
            return this.getDisplayValue(hrpData.name);
          } else {
            return '-';
          }
        },

        _getYears: function() {
          var maxYear = 0;
          var minYear = 3000;

          this.countryProgrammes.forEach(function(cpObject) {
            maxYear = Math.max(maxYear, moment(cpObject.to_date).year());
            minYear = Math.min(minYear, moment(cpObject.from_date).year());
          });

          var years = _.range(minYear, maxYear + 1);
          years = years.map(function(year) {
            return _.assign({}, {label: year.toString(), value: year});
          });

          this.set('years', years);
        },

        _filtersChanged: function() {
          this.set('debounceTime', 200);
          this.set('pageNumber', 1);
        }

      });

    })();
  </script>

</dom-module>
