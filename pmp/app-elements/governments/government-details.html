<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../app-behaviors/object-databind-behavior.html">

<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/buttons-styles.html">
<!-- TODO: Why is shadow.html used here? Since it contains only mixins and is a custom style
it doesn't need to be included in element's style -->
<!--<link rel="import" href="../../../bower_components/paper-styles/shadow.html">-->

<link rel="import" href="government-plan-results.html">

<dom-module id="government-details">
  <template>
    <style
        include="page-layout-styles repeatable-data-sets-styles grid-layout-styles shared-styles buttons-styles iron-flex-factors">
      :host {
        @apply(--layout-horizontal);
        width: 100%;
        --paper-fab-keyboard-focus-background: var(--add-button-color);
      }

      paper-fab {
        --paper-fab: {
          @apply(--paper-fab-btn-green);
        }
      }
      #detailsContent {
        width: 100%;
      }
      paper-input {
        width: 100%;
      }

    </style>
    <div id="detailsContent">
      <!--Partnership Details-->
      <etools-content-panel class="content-section" title="Partnership Details">
        <div class="row-h flex-c">
          <div class="col flex-2">
            <template is="dom-if" if="[[!governmentEditMode]]">
              <paper-input
                  label="Government Partner"
                  value="[[_mapItemFromValue(intervention.partner, partnersDropdownData,'true')]]"
                  placeholder="&#8212;"
                  readonly></paper-input>
            </template>
            <template is="dom-if" if="[[governmentEditMode]]">
              <etools-searchable-multiselection-menu id="partner"
                                                     starred
                                                     label="Government Partner"
                                                     placeholder="&#8212;"
                                                     options="[[partnersDropdownData]]"
                                                     selected="{{intervention.partner}}"
                                                     update-selected
                                                     error-message="Please select a partner"
                                                     required>
              </etools-searchable-multiselection-menu>
            </template>
          </div>
          <div class="col flex">
            <template is="dom-if" if="[[!governmentEditMode]]">
              <paper-input
                  label="Country Programme"
                  value="[[_mapItemFromValue(intervention.country_programme, countryProgrammeDropdownData,'true')]]"
                  placeholder="&#8212;"
                  readonly></paper-input>
            </template>
            <template is="dom-if" if="[[governmentEditMode]]">
              <etools-searchable-multiselection-menu id="country_programme"
                                                     label="Country Programme"
                                                     placeholder="&#8212;"
                                                     options="[[countryProgrammeDropdownData]]"
                                                     selected="{{intervention.country_programme}}"
                                                     update-selected
                                                     error-message="Please select a country programme"
                                                     required>
              </etools-searchable-multiselection-menu>
            </template>
          </div>
          <div class="col">
            <paper-input
                id="number"
                label="Reference Number"
                value="{{intervention.number}}"
                placeholder="&#8212;"></paper-input>
          </div>
        </div>
      </etools-content-panel>
      <!--Work Plan Results-->
      <etools-content-panel class="content-section" title="Work Plan Results" id="results">
        <government-plan-results id="governmentResults"
                                 data-items="{{intervention.results}}"
                                 allow-edit="[[governmentEditMode]]"
                                 year-options="[[yearOptions]]"
                                 cp-wbs="[[selectedCpWbs]]">
        </government-plan-results>
        <div id="bottom-actions" class="row-h" hidden$="[[!governmentEditMode]]">
          <paper-fab icon="add"
                     on-tap="_addNewResult"
                     elevation="5"
                     title="Add"></paper-fab>
        </div>
      </etools-content-panel>
    </div>

  </template>

  <script>
    Polymer({
      is: 'government-details',
      behaviors: [
        pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
        pmpBehaviors.CommonGeneralBehavior,
        pmpBehaviors.ObjectDatabindBehavior
      ],
      observers: [
        '_countriesDropdownChanged(countryProgrammeDropdownData, intervention.country_programme)',
        '_init(active)'
      ],
      properties: {
        intervention: {
          type: Object,
          notify: true,
          observer: '_interventionChanged'
        },
        originalIntervention: {
          type: Object,
        },
        editMode: {
          type: Boolean,
          value: true,
        },
        governmentEditMode: {
          type: Boolean,
          value: true,
        },
        active: {
          type: Boolean,
        },
        partnersDropdownData: {
          type: Array,
          statePath: 'partnersFilteredDropdownData'
        },
        countryProgrammeDropdownData: {
          type: Array,
          statePath: 'countryProgrammes',
        },
        yearOptions: {
          type: Array,
          notify: true
        },
        selectedCpWbs: {
          type: String
        }
      },
      _init: function(active) {
        if (active) {
          if (_.isEmpty(this.intervention)) {
            this.fire('details-refresh');
          }
        }
      },
      _countriesDropdownChanged: function() {
        var cpObject = _.find(this.countryProgrammeDropdownData, {value: this.intervention.country_programme});
        if (!_.isEmpty(cpObject)) {
          var years = _.range(moment(cpObject.from_date).year(), moment(cpObject.to_date).year() + 1);
          years = years.map(function(year) {
            return _.assign({}, {label: year.toString(), value: year});
          });

          this.set('yearOptions', years);
          this.set('selectedCpWbs', cpObject.wbs);
        }
      },
      _handleValueChange: function(e) {
        if (_.has(e, 'detail.selectedValues')) {
          var path = 'intervention.' + e.target.id;
          this.set(path, e.detail.selectedValues.value);
          e.target.invalid = false;
        }else if (e.target.value) {
          e.target.invalid = false;
        }
      },
      _addNewResult: function() {
        var intervention = _.get(this.intervention, 'id') || '';
        var newResult = {
          'intervention': intervention,
          'result': '',
          'year': '',
          'planned_amount': '',
          'planned_visits': '',
          'result_activities': [],
          'unicef_managers': [],
          'sectors': [],
          'sections': [],
        };
        this.push('intervention.results', newResult);
      },
      _setNewEditMode: function() {
          this.set('governmentEditMode', this.editMode);
          this.updateStyles();
      },
      _validateSave: function() {
        if (_.isEqual(this.intervention, this.originalIntervention)) {
          // TODO : disable save button when no change detected
          this.fire('toast', {text: 'Nothing to save, no changes made.', showCloseBtn: true});
        } else if (this._interventionIsValid()) {
          this.fire('save-intervention', {intervention: this.intervention});
        } else {
          // TODO : scroll missed fields into view
          this.fire('toast', {text: 'Please fill in required fields.', showCloseBtn: true});
        }
      },
      _interventionIsValid: function() {
        var valid = true;
        // validate Partnership Details
        if (!this.intervention.partner) {
          this.$$('#partner').invalid = true;
          valid = false;
        }
        if (!this.intervention.country_programme) {
          this.$$('#country_programme').invalid = true;
          valid = false;
        }
        var govtResults = this.$.governmentResults;
        var resultsValid = govtResults._fieldsAreValid(['result', 'year', 'planned_amount', 'planned_visits']);
        if (!resultsValid) {
          valid = false;
        }
        return valid;
      },

      _initSidebar: function() {
        // TODO create sticky save button

      },
      _interventionChanged: function(intervention) {
        this._setNewEditMode();
        if (!_.has(this.originalIntervention, 'id') ||
            (_.has(this.originalIntervention, 'id') && this.intervention.id !== this.originalIntervention.id)) {
          this.set('originalIntervention', JSON.parse(JSON.stringify(intervention)));
        }
        this.fire('global-loading', {active: false});
      },
    });
  </script>
</dom-module>
