<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../bower_components/iron-label/iron-label.html">

<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/list-styles.html">

<link rel="import" href="../data-table/data-table-footer.html">
<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../app-behaviors/object-databind-behavior.html">

<dom-module id="government-overview">
  <template>  
    <style include="page-layout-styles grid-layout-styles shared-styles list-styles ">
      :host {
        @apply(--layout-horizontal);
        width: 100%;
      }
      .block {
        display: block;
      }
      .content {
        margin-top: 4px;
      }
      iron-label {
        color: var(--dark-secondary-text-color);
        font-size: 90%;
      }
      .secondary {
        color: var(--dark-secondary-text-color);
      }
      #top-container {
         margin-bottom: 20px;
      }
      .text-right {
        margin-left: auto;
      }
      .padded-top {
        padding: 10px 0;
      }
      .padded-right {
        padding-right: 15px;
      }
      .grey-box {
        background-color: #dadada;
        font-size: 120%;
      }
      .yellow-box {
        background-color: var(--paper-yellow-400);
        width: 100%;
        padding: 10px 15px;
      }
      .yellow-box + .yellow-box > span {
        padding-left: 15px;
      }
      #implementation-status-panel {
        --ecp-content: {
          padding: 10px 0 25px;
        }
      }
    </style>
    <div id="pageContent">
      <paper-material elevation="1" id="top-container">
        <div class="row-h flex-c">
          <div class="col col-12 block">
              <iron-label for="cp_outputs_list"> 
                Cp Output(s)                                
              </iron-label>
              <br/>
              <div class="content" id="cp_outputs_list">
                <template is="dom-repeat" items="[[cpOutputNames]]" as="cpOut">
                    <strong> [[ cpOut ]] </strong> <br/>
                </template>
              </div>              
          </div>
        </div>       
        
        <div class="row-h flex-c">
          <div class="col col-6 block">
              <iron-label for="govt_partner"> 
                Government Partner
              </iron-label>
              <br />
              <div class="content" id="govt_partner">
                [[partner.label]]
              </div>
          </div>
          <div class="col col-6 block">
              <iron-label for="country_programme"> 
                Country Programme
              </iron-label>
              <br />
              <div class="content" id="country_programme">
                [[countryProgramme.label]]
              </div>                            
          </div>
        </div>        
      </paper-material>
      <etools-content-panel id="implementation-status-panel" class="content-section" title="Implementation Status">

  <!-- Start -->
        <template is="dom-repeat" items="[[intervention.implementation_status]]" as="status">

          <data-table-header id="listHeader" label="[[status.cp_name]]" no-collapse>
            <data-table-column class="col-2" field="fc_number">
                FC#
            </data-table-column>
            <data-table-column class="col-2" field="fc_date" >
                FC Date
            </data-table-column>
            <data-table-column class="col-4" field="fc_title">
                FC Title
            </data-table-column>
            <data-table-column class="col-2" field="actual_ammount">
                Actual $
            </data-table-column>
            <data-table-column class="col-2" field="outstanding_ammount">
                Outstanding $
            </data-table-column>
          </data-table-header>

          <template is="dom-repeat" items="[[status.fc_records]]" as="record">
            <data-table-row no-collapse>
              <div slot="row-data">
                <a class="col-data col-2 truncate" href="#" title="[[record.fc_number]]">
                    [[record.fc_number]]
                </a>
                <span class="col-data col-2 truncate" title="[[_checkAndShowDate(record.fc_date)]]">
                    [[_checkAndShowDate(record.fc_date)]]
                </span>
                <span class="col-data col-4" title="[[record.fc_title]]">
                    [[record.fc_title]]
                </span>
                <span class="col-data col-2" title="[[record.actual]]">
                    [[record.actual]]
                </span>
                <span class="col-data col-2" title="[[record.outstanding]]">
                    [[record.outstanding]]
                </span>
              </div>
            </data-table-row>
          </template>
          <div class="row-h flex-c padded-top">
            <div class="col col-6">
            </div>
            <div class="col col-2">
              <strong class="text-right padded-top"> Output Total </strong>
            </div>
            <div class="col col-4 padded-right">
              <paper-material elevation="1" class="yellow-box"> 
                <span><strong>[[ status.actual_sum ]]</strong></span>
              </paper-material>
            
              <paper-material elevation="1" class="yellow-box"> 
                <span><strong>[[ status.outstanding_sum ]]</strong></span>
              </paper-material>
            </div>
          </div>
        </template>
  <!-- End -->

          <div class="row-h flex-c padded-top grey-box">
            <div class="col col-6">
            </div>
            <div class="col col-2">
              <strong class="text-right padded-top"> OverallTotal for IP </strong>
            </div>
            <div class="col col-4 padded-right">
              <paper-material elevation="1" class="yellow-box"> 
                <span><strong>[[ intervention.actual_total_sum ]]</strong></span>
              </paper-material>
            
              <paper-material elevation="1" class="yellow-box"> 
                <span><strong>[[ intervention.outstanding_total_sum ]]</strong></span>
              </paper-material>
            </div>
          </div>
            
        <!--</template>   -->
      </etools-content-panel>
      
    </div>
    <div id="sidebar" hidden$="[[!editMode]]">
        <government-status on-save-partnership="_validateSave"></government-status>
    </div>

  </template>

  <script>
    Polymer({
      is : "government-overview",
      behaviors: [
        pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
        pmpBehaviors.CommonGeneralBehavior,
        pmpBehaviors.ObjectDatabindBehavior
      ],
      observers: [
        
      ],
      properties: {
        intervention: {
          type: Object,
          observer: '_interventionChanged'
        },
        allCpOutputs: {
          type: Array,
          statePath: 'cpOutputs'
        },
        cpOutputNames: {
          type: Array,
        },
        cpOutputsHelper: {
          type: Object,
        },
        allPartners: {
          type: Array,
          statePath: 'partnersDropdownData'
        },
        partner: {
          type: Object,
        },
        allCountryProgrammes: {
          type: Array,
          statePath: 'countryProgrammes',
        },
        countryProgramme: {
          type: Object
        }
     },

     _interventionChanged : function(intervention){
       if (intervention && typeof intervention === 'object' && Object.keys(intervention).length > 0) {            
         this._prepareCpOutputs(); 
         this._prepareInterventionStatusData();
         this._findProgramme();
         this._findPartner(); 
       }
       this.fire('global-loading', {active:false});        
     },

      _prepareCpOutputs: function() {       
        var cpOutputNames   = [];
        var cpOutputsHelper = {};      
        
        this.allCpOutputs.forEach(function(elem){          
          cpOutputsHelper[elem.value] = elem.label;                      
        });
        if(_.has(this.intervention,'implementation_status')){
          this.intervention.implementation_status.forEach(function(elem){
            cpOutputNames.push(cpOutputsHelper[elem.cp_output]);
          });
        }

        
        this.set('cpOutputNames', cpOutputNames);
        this.set('cpOutputsHelper', cpOutputsHelper);
      },

      _findProgramme: function() {
        var countryProgrammes = [];
        var currentCpId = this.intervention.country_programme;

        countryProgrammes = this.allCountryProgrammes.filter(function(elem){
          return (elem.value == currentCpId);
        }); 

        this.set('countryProgramme', countryProgrammes.pop());
      },
      
      _findPartner: function() {
        var partners = [];
        var currentPartnerId = this.intervention.partner;

        partners = this.allPartners.filter(function(elem){
          return (elem.value == currentPartnerId);
        });

        this.set('partner', partners.pop());
      },

      _prepareInterventionStatusData: function() {
        var cpOutputsHelper = this.cpOutputsHelper;
        var actualIndividualSum = 0;
        var outstandingIndividualSum = 0;
        var actualTotalSum = 0;
        var outstandingTotalSum = 0;

        if(_.has(this.intervention,'implementation_status')){
          this.intervention.implementation_status.forEach(function(elem){
            actualIndividualSum = 0;
            outstandingIndividualSum = 0;

            elem.fc_records.forEach(function(record){
              actualIndividualSum += record.actual;
              outstandingIndividualSum += record.outstanding;

              actualTotalSum += record.actual;
              outstandingTotalSum += record.outstanding;
            });

            elem.actual_sum = actualIndividualSum;
            elem.outstanding_sum = outstandingIndividualSum;

            elem.cp_name = cpOutputsHelper[parseInt(elem.cp_output)];
          });
        }



        this.set('intervention.actual_total_sum', actualTotalSum);
        this.set('intervention.outstanding_total_sum', outstandingTotalSum);          
      },

      _checkAndShowDate: function(dateString) {
        return this.getDisplayValue(dateString, true);
      },

  })
  </script>
</dom-module>