<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../../../bower_components/etools-content-panel/etools-content-panel.html">

<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/list-styles.html">

<link rel="import" href="../data-table/data-table-footer.html">
<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">

<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../app-behaviors/object-databind-behavior.html">

<dom-module id="government-overview">
  <template>
    <style include="page-layout-styles grid-layout-styles shared-styles list-styles ">
      :host {
        @apply(--layout-horizontal);
        width: 100%;
      }
      .block {
        display: block;
      }
      .content {
        margin-top: 4px;
      }
      iron-label {
        color: var(--dark-secondary-text-color);
        font-size: 90%;
      }
      .secondary {
        color: var(--dark-secondary-text-color);
      }
      #top-container {
         margin-bottom: 20px;
      }
      .text-right {
        margin-left: auto;
      }
      .padded-top {
        padding: 10px 0;
      }
      .padded-right {
        padding-right: 15px;
      }
      .padded-left {
        padding-left: 15px
      }
      .grey-box {
        background-color: #dadada;
        font-size: 120%;
      }
      .yellow-box {
        background-color: var(--paper-yellow-400);
        width: 100%;
        padding: 10px 15px;
      }
      .yellow-box + .yellow-box > span {
        padding-left: 15px;
      }
      #implementation-status-panel {
        --ecp-content: {
          padding: 10px 0 25px;
        }
      }

      .implementation-status-no-fc {
        padding: 0 24px;
      }
      .no-fc-output-name {
        width: 100%;
        height: 64px;
        line-height: 64px;
        font-size: 20px;
        color: var(--primary-text-color, rgba(0, 0, 0, 0.87));
        @apply(--header-title);
      }
    </style>
    <div id="pageContent">
      <paper-material elevation="1" id="top-container">
        <div class="row-h flex-c">
          <div class="col col-12 block">
              <iron-label for="cp_outputs_list">
                Cp Output(s)
              </iron-label>
              <br/>
              <div class="content" id="cp_outputs_list">
                <template is="dom-if" if="[[!cpOutputNames.length]]">
                 <strong>-</strong>
                </template>
                <template is="dom-repeat" items="[[cpOutputNames]]" as="cpOut">
                    <strong> [[ cpOut ]] </strong> <br/>
                </template>
              </div>
          </div>
        </div>

        <div class="row-h flex-c">
          <div class="col col-6 block">
              <iron-label for="govt_partner">
                Government Partner
              </iron-label>
              <br />
              <div class="content" id="govt_partner">
                [[partner.label]]
              </div>
          </div>
          <div class="col col-6 block">
              <iron-label for="country_programme">
                Country Programme
              </iron-label>
              <br />
              <div class="content" id="country_programme">
                [[countryProgramme.label]]
              </div>
          </div>
        </div>
      </paper-material>
      <etools-content-panel id="implementation-status-panel" class="content-section" title="Implementation Status">

        <template is="dom-if" if="[[!intervention.implementation_status.length]]">
          <div class="row-h">
            <div class="col col-12 padded-left">
              <p>No records to display</p>
            </div>
          </div>
        </template>
  <!-- Start -->
        <template is="dom-repeat" items="[[intervention.implementation_status]]" as="status">
         <template is="dom-if" if="[[_fcs_exist(status.fc_records)]]">
          <data-table-header id="listHeader" label="[[status.cp_name]]" no-collapse>
            <data-table-column class="col-2" field="fc_number">
                FC#
            </data-table-column>
            <data-table-column class="col-2" field="fc_date" >
                FC Date
            </data-table-column>
            <data-table-column class="col-4" field="fc_title">
                FC Title
            </data-table-column>
            <data-table-column class="col-2" field="actual_ammount">
                Commitment Amount $
            </data-table-column>
            <data-table-column class="col-2" field="outstanding_ammount">
                Outstanding $
            </data-table-column>
          </data-table-header>

          <template is="dom-if" if="[[!status.fc_records.length]]">
            <data-table-row no-collapse>
              <div slot="row-data">
                <span class="col-data col-12">
                    No records to display
                </span>
              </div>
            </data-table-row>
          </template>
          <template is="dom-repeat" items="[[status.fc_records]]" as="record">

            <data-table-row no-collapse>
              <div slot="row-data">
                <a class="col-data col-2 truncate" href="#" title="[[record.fc_number]]">
                    [[record.fc_ref_number]]
                </a>
                <span class="col-data col-2 truncate" title="[[_checkAndShowDate(record.fc_date)]]">
                    [[_checkAndShowDate(record.due_date)]]
                </span>
                <span class="col-data col-4" title="[[record.fc_title]]">
                    [[record.line_item_text]]
                </span>
                <span class="col-data col-2" title="[[record.actual]]">
                    [[record.commitment_amount]]
                </span>
                <span class="col-data col-2" title="[[record.outstanding]]">
                    <!-- [[record.outstanding]] -->
                    Missing
                </span>
              </div>
            </data-table-row>
          </template>
          <div class="row-h flex-c padded-top" hidden$="[[!status.fc_records.length]]">
            <div class="col col-6">
            </div>
            <div class="col col-2">
              <strong class="text-right padded-top"> Output Total </strong>
            </div>
            <div class="col col-4 padded-right">
              <paper-material elevation="1" class="yellow-box">
                <span><strong>[[ status.actual_sum ]]</strong></span>
              </paper-material>

              <paper-material elevation="1" class="yellow-box">
                <span><strong>[[ status.outstanding_sum ]]</strong></span>

<!--
              <paper-material elevation="1" class="yellow-box">
                <span><strong>Missing</strong></span>
-->
              </paper-material>
            </div>
          </div>
          </template>
          <template is="dom-if" if="[[!_fcs_exist(status.fc_records)]]">
            <div class="implementation-status-no-fc"
                  hidden$="[[_fcs_exist(status.fc_records]]">
                    <span class="no-fc-output-name">{{status.cp_name}}:</span>
                    <br>
                    <span class="no-fc-message">No FCs Available</span>
            </div>
          </template>
        </template>

  <!-- End -->

          <div class="row-h flex-c padded-top grey-box" hidden$="[[!intervention.implementation_status.length]]">
            <div class="col col-4">
            </div>
            <div class="col col-4">
              <strong class="text-right padded-top">Overall Total for Government Partner </strong>
            </div>
            <div class="col col-4 padded-right">
              <paper-material elevation="1" class="yellow-box">
                <span><strong>[[ intervention.actual_total_sum ]]</strong></span>
              </paper-material>
<!--
              <paper-material elevation="1" class="yellow-box">
                <span><strong>[[ intervention.outstanding_total_sum ]]</strong></span>
-->
              <paper-material elevation="1" class="yellow-box">
                <!-- <span><strong>[[ intervention.outstanding_total_sum ]]</strong></span> -->
                <span><strong>Missing</strong></span>
              </paper-material>
            </div>
          </div>

        <!--</template>   -->
      </etools-content-panel>

    </div>
    <div id="sidebar" hidden$="[[!editMode]]">
        <government-status on-save-partnership="_validateSave"></government-status>
    </div>

  </template>

  <script>
    Polymer({
      is : "government-overview",
      behaviors: [
        pmpBehaviors.EtoolsStaticCommonDataReduxBehavior,
        pmpBehaviors.CommonGeneralBehavior,
        pmpBehaviors.ObjectDatabindBehavior
      ],
      observers: [

      ],
      properties: {
        intervention: {
          type: Object,
          observer: '_interventionChanged'
        },
        allCpOutputs: {
          type: Array,
          statePath: 'cpOutputs'
        },
        cpOutputNames: {
          type: Array,
        },
        allPartners: {
          type: Array,
          statePath: 'partnersDropdownData'
        },
        partner: {
          type: Object,
        },
        allCountryProgrammes: {
          type: Array,
          statePath: 'countryProgrammes',
        },
        countryProgramme: {
          type: Object
        }
     },
     observes: [
       '_interventionChanged(intervention.*)'
     ],

     _interventionChanged : function() {
       if (this.intervention && typeof this.intervention === 'object' && Object.keys(this.intervention).length > 0) {
         if(!this.intervention.implementation_status){
           this.set('intervention.implementation_status', []);
         }

         this._prepareCpOutputs();
         this._prepareInterventionStatusData();
         this._findProgramme();
         this._findPartner();
       }
       this.fire('global-loading', {active:false});
     },

      _prepareCpOutputs: function() {
        var cpOutputNames   = [];

        if(_.has(this.intervention,'implementation_status')){
          this.intervention.implementation_status.forEach(function(elem){
            cpOutputNames.push(this._getCpOutputName(elem.cp_output));
          }.bind(this));
        }
        this.set('cpOutputNames', cpOutputNames);
      },
      _fcs_exist: function(fc_records) {
        if ((!Array.isArray(fc_records)) || (fc_records.length === 0)) {
          return false;
        }
        return true;
      },

      _findProgramme: function() {
        var countryProgrammes = [];
        var currentCpId = this.intervention.country_programme;

        countryProgrammes = this.allCountryProgrammes.filter(function(elem){
          return (elem.value == currentCpId);
        });

        this.set('countryProgramme', countryProgrammes.pop());
      },

      _findPartner: function() {
        var partners = [];
        var currentPartnerId = this.intervention.partner;

        partners = this.allPartners.filter(function(elem){
          return (elem.value == currentPartnerId);
        });

        this.set('partner', partners.pop());
      },

      _prepareInterventionStatusData: function() {
        var actualIndividualSum = 0;
        var outstandingIndividualSum = 0;
        var actualTotalSum = 0;
        var outstandingTotalSum = 0;

        if (_.has(this.intervention,'implementation_status')) {
          this.intervention.implementation_status.forEach(function(elem) {
            actualIndividualSum = 0;
            outstandingIndividualSum = 0;

            elem.fc_records.forEach(function(record) {
              actualIndividualSum += parseFloat(record.commitment_amount);
              outstandingIndividualSum += parseFloat(record.outstanding);

              actualTotalSum += parseFloat(record.commitment_amount);
              outstandingTotalSum += parseFloat(record.outstanding);
            });

            elem.actual_sum = actualIndividualSum;
            elem.outstanding_sum = outstandingIndividualSum;

            elem.cp_name = this._getCpOutputName(parseInt(elem.cp_output));
          }.bind(this));
        }

        this.set('intervention.actual_total_sum', actualTotalSum);
        this.set('intervention.outstanding_total_sum', outstandingTotalSum);
      },
      _getCpOutputName: function(cpoId) {
        for(var key in this.allCpOutputs) {
          if(this.allCpOutputs[key].value === cpoId) {
            return this.allCpOutputs[key].label;
          }
        }
        return null;
      },
      _checkAndShowDate: function(dateString) {
        return this.getDisplayValue(dateString, true);
      },

  })
  </script>
</dom-module>