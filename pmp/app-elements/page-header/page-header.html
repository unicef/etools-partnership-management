<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/etools-page-refresh/etools-page-refresh.html">
<link rel="import" href="../countries-dropdown/countries-dropdown.html">
<link rel="import" href="../user-profile-dialog/user-profile-dialog.html">

<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../bower_components/etools-app-selector/etools-app-selector.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">


<link rel="import" href="../../../styles/shared-styles.html">

<dom-module id="page-header">

  <template>
    <style include="shared-styles">

      app-toolbar {
        padding: 0 16px 0 0;
        background-color: var(--header-bg-color, #233944);
      }

      div[main-title] {
        position: relative;
        bottom: 1px;
        margin-left: 24px;
        min-height: 30px;
        background: url('../../../images/etools_logo_icon.png') no-repeat center left;
        background-size: auto 48px;
        padding-left: 48px;
        font-size: 30px;
        color: var(--light-primary-text-color);
      }

      etools-page-refresh, #profile {
        color: var(--title-toolbar-secondary-text-color);
      }

      #profile.open, #accountProfile, #powerSettings {
        color: var(--dark-secondary-text-color);
      }

      paper-icon-button#profile {
        width: 60px;
        height: 60px;
        padding: 12px 16px;
      }

      #menuButton {
        display: block;
      }

      .right-side {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      etools-page-refresh {
        margin-left: 25px;
      }

      .titlebar {
        flex: 1;
        font-size: 28px;
        font-weight: 300;
        color: var(--light-primary-text-color);
      }

      .titlebar img {
        width: 34px;
        margin: 0 8px 0 24px;
      }

      .content-align {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        height: 60px;
      }

      #second-logo {
        height: 32px;
        width: auto;
      }

      a.logout {
        font-size: 16px;
        color: var(--light-primary-text-color);
        font-weight: 400;
        margin-left: 24px;
        cursor: pointer;
        -webkit-font-smoothing: antialiased;
      }

      @media (min-width: 850px) {
        #menuButton {
          display: none;
        }

        div[main-title] {
          margin-left: 32px;
        }

        .profile-container {
          @apply(--layout-vertical);
          justify-content: center;
          height: 100%;
        }

        .dropdown-content {
          position: absolute;
          top: 60px;
          z-index: 100;
          background: var(--primary-background-color);
          padding: 8px 0;
          right: 81px;
        }

        .open {
          background: var(--primary-background-color);
        }

        .dropdown-content .item {
          height: 48px;
          font-size: 16px;
          color: var(--primary-text-color);
          @apply(--layout-horizontal);
          @apply(--layout-center);
          padding: 0 16px 0 8px;
          cursor: pointer;
        }

        .dropdown-content .item:hover {
          background: var(--medium-theme-background-color);
        }
      }
    </style>
    <app-toolbar sticky class="content-align">
      <paper-icon-button id="menuButton" class="light" icon="menu" on-tap="openDrawer"></paper-icon-button>
      <div class="titlebar content-align">
        <etools-app-selector id="selector"></etools-app-selector>
        <img id="second-logo" src="../../../images/etools-logo-color-white.svg">
      </div>
      <div class="content-align">
        <countries-dropdown id="countries" countries="[[countries]]"
                            current="[[user.profile.country]]"></countries-dropdown>
        <div class="profile-container">
          <paper-icon-button id="profile" icon="social:person" role="button" on-tap="_handleTap"
                             aria-disabled="false" class$="[[opened]]"></paper-icon-button>
          <iron-collapse id="userDropdown">
            <paper-material elevation="5" class="dropdown-content" id="user-dropdown">
              <div class="item" on-tap="_openUserProfileDialog">
                <paper-icon-button id="accountProfile" icon="account-circle"></paper-icon-button>
                Profile
              </div>
              <div class="item" on-tap="_logout">
                <paper-icon-button id="powerSettings" icon="power-settings-new"></paper-icon-button>
                Sign out
              </div>
            </paper-material>
          </iron-collapse>
        </div>
        <etools-page-refresh id="refresh"></etools-page-refresh>
      </div>
    </app-toolbar>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'page-header',
        properties: {
          countries: {
            type: Array
          },
          user: {
            type: Object,
          },
          userProfileDialog: Object,
          opened: {
            type: String,
            value: ''
          }
        },
        observers: [
          '_updateCountriesList(user.profile.countries_available)'
        ],
        listeners: {
          'main_refresh': '_refresh_page'
        },
        attached: function() {
          document.addEventListener('click', this._onCaptureClick.bind(this), true);
        },
        openDrawer: function() {
          this.fire('drawer');
        },
        _refresh_page: function(event) {
          event.stopImmediatePropagation();
          this.$.refresh._refresh();
        },
        _getFlagIconClass: function(id) {
          var flagIdMap = {
            '0': 'us',
            '234R': 'syxb',
            '2490': 'lb',
            '4020': 'su',
            '4140': 'sy',
            '2070': 'in'
          };
          return 'flag-icon ' + 'flag-icon-' + flagIdMap[id];
        },
        _updateCountriesList: function(countries) {
          if (!countries) {
            return;
          }
          var arrayObj = countries.map(function(arrayItem) {
            return {
              id: arrayItem.id,
              name: arrayItem.name,
              imgClass: this._getFlagIconClass(arrayItem.business_area_code)
            };
          }.bind(this));
          arrayObj = _.sortBy(arrayObj, function(c) {
            return c.name;
          });
          this.set('countries', arrayObj);
        },
        ready: function() {
          // init indicator dialog data
          this.userProfileDialog = document.createElement('user-profile-dialog');
          this.userProfileDialog.setAttribute('id', 'userProfileDialog');

          // this will handle the outside app-shell toast event that comes from profile dialog
          this.userProfileDialog.addEventListener('user-profile-toast', function(e) {
            e.stopImmediatePropagation();
            this.fire('toast', e.detail);
          }.bind(this), false);

          Polymer.dom(document.querySelector('body')).appendChild(this.userProfileDialog);

          var location = window.location.href;
          var production = 'etools.unicef.org';

          // If not production environment, changing header color to red
          if (location.indexOf(production) === -1) {
            this.customStyle['--header-bg-color'] = 'var(--nonprod-header-color)'; // TODO:
            this.updateStyles();
          }
        },
        _logout: function() {
          window.location.href = window.location.origin + '/saml2/logout';
        },

        detached: function() {
          if (this.userProfileDialog) {
            Polymer.dom(document.querySelector('body')).removeChild(this.userProfileDialog);
          }
        },
        // open indicator dialog to add or edit indicator
        _openUserProfileDialog: function(event) {
          this.userProfileDialog.openUserProfileDialog();
        },
        _handleTap: function(e) {
          this.$.userDropdown.toggle();
          if (this.opened) {
            this.set('opened', '');
          } else {
            this.set('opened', 'open');
          }
        },
        _onCaptureClick: function(e) {
          if (this._isInPath(Polymer.dom(e).path, 'id', 'profile')) {
            return;
          }
          if (!this._isInPath(Polymer.dom(e).path, 'id', 'user-dropdown')) {
            if (this.$.userDropdown.opened) {
              this._handleTap();
            }
          }

        },
        _isInPath: function(path, prop, value) {
          path = path || [];
          for (var i = 0; i < path.length; i++) {
            if (path[i][prop] === value) {
              return true;
            }
          }
          return false;
        }

      });
    })();
  </script>

</dom-module>
