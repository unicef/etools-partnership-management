<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../countries-dropdown/countries-dropdown.html">
<link rel="import" href="../../../bower_components/etools-app-selector/etools-app-selector.html">
<link rel="import" href="../user-profile-dialog/user-profile-data/user-profile-data.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../bower_components/etools-profile-dropdown/etools-profile-dropdown.html">

<link rel="import" href="../static-common-data/redux-behaviors/common-static-data-redux-behavior.html">
<link rel="import" href="../../app-config/app-dexie-db-config.html">

<dom-module id="page-header">

  <template>
    <style include="shared-styles">
      app-toolbar {
        padding: 0 16px 0 0;
        background-color: var(--header-bg-color, #233944);
      }

      div[main-title] {
        position: relative;
        bottom: 1px;
        margin-left: 24px;
        min-height: 30px;
        background: url('../../../images/etools_logo_icon.png') no-repeat center left;
        background-size: auto 48px;
        padding-left: 48px;
        font-size: 30px;
      }

      div[main-title],
      .titlebar {
        color: var(--header-primary-text-color);
      }
      countries-dropdown {
        --countries-dropdown-color: var(--header-secondary-text-color);
      }
      etools-profile-dropdown,
      #refresh {
        color: var(--header-secondary-text-color);
      }
      etools-profile-dropdown {
        margin-left: 24px;
      }

      #refresh {
        margin-left: 16px;
      }

      #menuButton {
        display: block;
      }

      .right-side {
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      .titlebar {
        flex: 1;
        font-size: 28px;
        font-weight: 300;
      }

      .titlebar img {
        width: 34px;
        margin: 0 8px 0 24px;
      }

      .content-align {
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      #second-logo {
        height: 32px;
        width: auto;
      }

      @media (min-width: 850px) {
        #menuButton {
          display: none;
        }

        div[main-title] {
          margin-left: 32px;
        }
      }
    </style>
    <user-profile-data id="userProfileData" user-profile="{{originalProfile}}"></user-profile-data>
    <app-toolbar sticky class="content-align">
      <paper-icon-button id="menuButton" class="light" icon="menu" on-tap="openDrawer"></paper-icon-button>
      <div class="titlebar content-align">
        <etools-app-selector id="selector"></etools-app-selector>
        <img id="second-logo" src="../../../images/etools-logo-color-white.svg">
      </div>
      <div class="content-align">
        <countries-dropdown id="countries" countries="[[countries]]"
                            current-country="[[user.country]]"></countries-dropdown>
        <etools-profile-dropdown
            sections="[[allSections]]"
            offices="[[allOffices]]"
            users="[[allUsers]]"
            profile="{{profile}}"
            on-save-profile="_saveProfile"
            on-sign-out="_signOut"></etools-profile-dropdown>
        <paper-icon-button id="refresh" icon="refresh" on-tap="_openDataRefreshDialog"></paper-icon-button>
      </div>
    </app-toolbar>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'page-header',
        behaviors: [
          EtoolsPmpApp.Behaviors.EtoolsDataReduxStore
        ],
        properties: {
          countries: {
            type: Array
          },
          user: {
            type: Object,
          },
          allOffices: {
            type: Object,
            notify: true,
            computed: '_convertCollection(offices)'
          },
          offices: {
            type: Array,
            statePath: 'offices',
          },
          sections: {
            type: Array,
            statePath: 'sections',
          },
          users: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          allSections: {
            type: Object,
            notify: true,
            computed: '_convertCollection(sections)'
          },
          allUsers: {
            type: Object,
            notify: true,
            computed: '_convertUsers(users)'
          },
          originalProfile: {
            type: Object,
            observer: '_handleProfileLoaded'
          },
          editableFields: {
            type: Array,
            value: [
              'office',
              'section',
              'job_title',
              'phone_number',
              'oic',
              'supervisor'
            ]
          },

          userProfileDialog: Object
        },
        observers: [
          '_updateCountriesList(user.countries_available)'
        ],

        openDrawer: function() {
          this.fire('drawer');
        },

        _handleProfileLoaded: function(profileData) {
          this.set('profile', JSON.parse(JSON.stringify(profileData)));
        },

        _getFlagIconClass: function(id) {
          var flagIdMap = {
            '0': 'us',
            '234R': 'syxb',
            '2490': 'lb',
            '4020': 'su',
            '4140': 'sy',
            '2070': 'in'
          };
          return 'flag-icon ' + 'flag-icon-' + flagIdMap[id];
        },
        _updateCountriesList: function(countries) {
          if (!countries) {
            return;
          }
          var arrayObj = countries.map(function(arrayItem) {
            return {
              id: arrayItem.id,
              name: arrayItem.name,
              imgClass: this._getFlagIconClass(arrayItem.business_area_code)
            };
          }.bind(this));
          arrayObj = _.sortBy(arrayObj, function(c) {
            return c.name;
          });
          this.set('countries', arrayObj);
        },
        ready: function() {
          var location = window.location.href;
          var production = 'etools.unicef.org';

          // If not production environment, changing header color to red
          if (location.indexOf(production) === -1) {
            this.customStyle['--header-bg-color'] = 'var(--nonprod-header-color)'; // TODO:
            this.updateStyles();
          }
        },

        _openDataRefreshDialog: function() {
          this.fire('open-data-refresh-dialog');
        },
        _convertCollection: function(data) {
          return data.map(function(item) {
            return {label: item.name, value: item.id};
          });
        },
        _convertUsers: function(data) {
          return data.map(function(d) {
            return {
              value: parseInt(d.id, 10),
              label: d.name
            };
          });
        },
        _saveProfile: function(e) {
          //this seems redundant, the profile is passed by reference so it's updated anyway
          this.set('profile', e.detail.profile);
          let modifiedFields = this._getModifiedFields(this.originalProfile, this.profile);
          this.$.userProfileData.saveProfile(modifiedFields);
        },
        _signOut: function() {
          this._clearDexieDbs();
          this._clearLocalStorage();
          window.location.href = window.location.origin + '/saml2/logout';
        },
        _clearDexieDbs: function() {
          EtoolsPmpApp.DexieDb.delete();
        },
        _clearLocalStorage: function() {
          localStorage.clear();
        },
        _getModifiedFields: function(originalData, newData) {
          let modifiedFields = {};
          this.editableFields.forEach(function(field) {
            if (originalData[field] !== newData[field]) {
              modifiedFields[field] = newData[field];
            }
          });

          return modifiedFields;
        }
      });
    })();
  </script>

</dom-module>
