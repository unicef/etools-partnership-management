<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../../../scripts/lodash/lodash.html">
<link rel="import" href="../../app-config/app-dexie-db-config.html">
<link rel="import" href="../../app-config/app-endpoints-behavior.html">
<link rel="import" href="../../app-config/app-user-permissions-behavior.html">

<link rel="import" href="../../app-behaviors/list-data-behavior.html">

<dom-module id="user-data">
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'user-data',

        behaviors: [
          EtoolsAjaxRequestBehavior,
          EtoolsPmpApp.Behaviors.Endpoints,
          EtoolsPmpApp.Behaviors.AppUserPermissionsBehavior
        ],

        properties: {
          endpointName: {
            type: String,
            value: 'user'
          },
          user: {
            type: Object,
            readOnly: true,
            notify: true
          },
          userGroups: {
            type: Array,
            readOnly: true
          },
          permissions: {
            type: Object,
            readOnly: true,
            notify: true,
          }
        },

        ready: function() {
          let self = this;
          self.sendRequest({
            endpoint: self.getEndpoint(self.endpointName)
          }).then(function(res) {
            // TODO: check response to make sure it contains a valid user
            self._setUserData(res);
          }).catch(function(error) {
            self._resetUserAndPermissions();
            self.logError('Error occurred on logged user data request', 'user request', error);
            if (error.status === 403) {
              this.fire('forbidden');
            }
          });
        },

        _findGroup: function(groupName) {
          return _.find(this.userGroups, function(grp) {
             return grp.name === groupName;
          });
        },
        _resetUserAndPermissions: function() {
          this._setUser(null);
          this._setPermissions(null);
        },

        _setUserData: function(data) {
          let _user = data;
          let _permissions = {};

          this._setUser(_user);
          let permissionsList = this.getAllPermissions();

          if (!_.isEmpty(data)) {
            this._setUserGroups(_user.groups);

            permissionsList.defaultPermissions.forEach(function(perm) {
              _permissions[perm] = true;
            });
            if (this._findGroup('UNICEF User')) {
              permissionsList.unicefUserPermissions.forEach(function(perm) {
                _permissions[perm] = true;
              });
            }
            if (this._findGroup('Partnership Manager')) {
              permissionsList.partnershipManagerPermissions.forEach(function(perm) {
                _permissions[perm] = true;
              });
            }
            if (this._findGroup('PME')) {
              permissionsList.PMEPermissions.forEach(function(perm) {
                _permissions[perm] = true;
              });
            }
            if (this._findGroup('ICT')) {
              permissionsList.ICTPermissions.forEach(function(perm) {
                _permissions[perm] = true;
              });
            }
          } else {
            // TODO: we need to redirect to login page if no user data received
            // permissionsList.superPermissions.forEach(function(perm) {
            //  _permissions[perm] = true;
            // });
          }
          this._setPermissions(_permissions);
        }

      });

    })();

  </script>

</dom-module>
