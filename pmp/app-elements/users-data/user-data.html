<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../scripts/lodash/lodash.html">

<link rel="import" href="../../app-behaviors/data-element-behavior.html">

<dom-module id="user-data">

  <template>

    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="user"
                 on-success="_handleResponse"
                 on-fail="_handleError"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'user-data',

        behaviors: [pmpBehaviors.DataElementBehavior],

        properties: {

          endpointName: {
            type: String,
            value: 'user'
          },

          user: {
            type: Object,
            readOnly: true,
            notify: true
          },

          permissions: {
            type: Object,
            readOnly: true,
            notify: true,
          }

        },

        _handleResponse: function(res) {
          // TODO: check response to make sure it contains a valid user
          this._setUserData(res.detail);
        },

        _handleError: function(rsp, err) {
          console.log(rsp);
          console.log(err);
          this._setUser(null);
          this._setPermissions(null);
        },

        _setUserData: function(data) {
          var _user = data;
          var _permissions = {};

          var permissionsList = this.getAllPermissions();

          if (!_.isEmpty(data)) {
            permissionsList.defaultPermissions.forEach(function(perm) {
              _permissions[perm] = true;
            });
            if (!_user.is_staff) {
              permissionsList.partnerOnlyPermissions.forEach(function(perm) {
                _permissions[perm] = true;
              });
            } else {
              // user is not partner but staff:
              permissionsList.managementPermissions.forEach(function(perm) {
                _permissions[perm] = true;
              });

              if (_user.profile.partner_staff_member) {
                // staff that has faked partnership by setting partner_staff_member on their profile
                permissionsList.partnerPermissions.forEach(function(perm) {
                  _permissions[perm] = true;
                });
              }
            }
          } else {
            //for testing
            permissionsList.superPermissions.forEach(function(perm) {
              _permissions[perm] = true;
            });
          }
          this._setUser(_user);
          this._setPermissions(_permissions);
        }

      });

    })();

  </script>

</dom-module>
