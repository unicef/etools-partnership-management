<link rel="import" href="../../bower_components/polymer/polymer.html">
<script>
  window.pmpBehaviors = window.pmpBehaviors || {};
  pmpBehaviors.AjaxServerErrorsBehavior = {

    properties: {
      serverErrors: {
        type: Array,
        notify: true
      },
      ajaxEl: Object,
      useToastEvent: {
        type: Boolean,
        value: true
      },
      globalMessage: {
        type: String,
        value: 'An error occurred on data save!'
      },
      errorEventName: {
        value: null,
        observer: '_errorEventNameChange'
      }
    },

    handleErrorResponse: function(response) {
      this.fire('global-loading', {active: false});
      var errors = response.detail.request.detail.request.response;
      if (this.ajaxEl.method === 'POST' || this.ajaxEl.method === 'PATCH') {
        // TODO: improve etools-ajax on-fail event data model (received errors)
        var errorMessage = this.globalMessage;
        this.set('serverErrors', []);
        if (errors) {
          if (this.useToastEvent) {
            this.push('serverErrors', 'Errors occurred:');
          }
          if (Array.isArray(errors) && errors.length > 0) {
            for (var err in errors) {
              this.push('serverErrors', errors[err]);
            }
          } else if (typeof errors === 'object' && Object.keys(errors).length > 0) {
            for (var errField in errors) {
              if (typeof errors[errField] === 'string') {
                this.push('serverErrors', 'Field ' + errField + ' - ' + errors[errField]);
              } else if (typeof errors[errField] === 'object' && Object.keys(errors[errField]).length > 0) {
                for (var errF in errors[errField]) {
                  this.push('serverErrors', 'Field ' + errField + '(' + errF + ') - ' + errors[errField][errF]);
                }
              } else if (Array.isArray(errors[errField]) && errors[errField].length > 0) {
                for(var key in errors[errField]) {
                  this.push('serverErrors', errors[errField][key]);
                }
              }
            }
          }
        }

        if (this.useToastEvent) {
          if (this.serverErrors.length > 1) {
            errorMessage = this.serverErrors.join('\n');
          }
          this.fire('toast', {text: errorMessage, showCloseBtn: true});
        } else {
          if (this.serverErrors.length === 0) {
            this._fireAjaxErrorEvent(errorMessage);
          } else {
            this._fireAjaxErrorEvent(this.serverErrors);
          }
        }
      }
    },

    _fireAjaxErrorEvent: function(errors) {
      if (typeof this.errorEventName === 'string' && this.errorEventName !== '') {
        if (typeof errors === 'string') {
          errors = [errors];
        }
        this.fire(this.errorEventName, errors);
      }
    },

    _errorEventNameChange: function(eventName) {
      if (typeof eventName === 'string' && eventName !== '') {
        // disable toasts error notifications if eventName is given
        this.set('useToastEvent', false);
      }
    }

  };

</script>
