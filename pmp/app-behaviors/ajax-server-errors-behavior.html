<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};
  /** @polymerBehavior EtoolsPmpApp.Behaviors.AjaxServerErrors */
  EtoolsPmpApp.Behaviors.AjaxServerErrors = {

    properties: {
      serverErrors: {
        type: Array,
        notify: true
      },
      ajaxEl: Object,
      useToastEvent: {
        type: Boolean,
        value: true
      },
      globalMessage: {
        type: String,
        value: 'An error occurred on data save!'
      },
      errorEventName: {
        value: null,
        observer: '_errorEventNameChange'
      },
      ajaxLoadingMsgSource: {
        type: String,
        value: ''
      }
    },

    tryGetResponseError: function(response) {
      try {
        var req = response.detail.request.detail.request;
        var error = req.response || req.xhr.response;

        // response.detail.request.detail.request.response could be null for 500 server errors,
        // we need to avoid returning null here
        return error || this.globalMessage;

      } catch (ex) {
        console.warn(ex);
      }
      return this.globalMessage;
    },

    handleErrorResponse: function(response) {
      this.fire('global-loading', {
        active: false,
        loadingSource: !!this.ajaxLoadingMsgSource ? this.ajaxLoadingMsgSource : null
      });
      var errors = this.tryGetResponseError(response);

      var errorMessage = this.globalMessage;

      if (['POST', 'PATCH', 'DELETE'].indexOf(this.ajaxEl.method) > -1) {
        this.set('serverErrors', this._getErrorsArray(errors, this.useToastEvent));
      }
      this.serverErrors = this.serverErrors ? this.serverErrors : [];
      if (this.useToastEvent) {
        if (this.serverErrors.length > 1) {
          errorMessage = this.serverErrors.join('\n');
        }
        this.fire('toast', {text: errorMessage, showCloseBtn: true});
      } else {
        if (this.serverErrors.length === 0) {
          this._fireAjaxErrorEvent(errorMessage);
        } else {
          this._fireAjaxErrorEvent(this.serverErrors);
        }
      }
    },

    _getErrorsArray: function(errors, useToastEvent) {
      var errorsArray = [];
      if (!errors) {
        return errorsArray;
      }

      if (useToastEvent) {
        errorsArray.push('Errors occurred:');
      }

      if (typeof errors === 'string') {
         errorsArray.push(errors);
         return errorsArray;
      }
      if (typeof errors === 'object' && typeof errors.error === 'string' && errors.error) {
        errorsArray.push(errors.error);
        return errorsArray;
      }

      if (Array.isArray(errors) && errors.length > 0) {
        for (var err in errors) {
          errorsArray.push(errors[err]);
        }
        return errorsArray;
      }

      if (typeof errors === 'object' && Object.keys(errors).length > 0) {
        for (var errField in errors) {
          if (typeof errors[errField] === 'string') {
            errorsArray.push('Field ' + errField + ' - ' + errors[errField]);
            continue;
          }
          if (typeof errors[errField] === 'object' && Object.keys(errors[errField]).length > 0) {
            for (var errF in errors[errField]) {
              errorsArray.push('Field ' + errField + '(' + errF + ') - ' + errors[errField][errF]);
            }
            continue;
          }
          if (Array.isArray(errors[errField]) && errors[errField].length > 0) {
            for (var key in errors[errField]) {
              errorsArray.push(errors[errField][key]);
            }
          }
        }
      }

      return errorsArray;
    },

    formatServerErrorAsText: function(errors) {
      var errorsArray = this._getErrorsArray(errors, false);

      if (errorsArray && errorsArray.length) {
        return errorsArray.join('\n');
      }

      return errors;
    },

    _fireAjaxErrorEvent: function(errors) {
      if (typeof this.errorEventName === 'string' && this.errorEventName !== '') {
        if (typeof errors === 'string') {
          errors = [errors];
        }
        this.fire(this.errorEventName, errors);
      }
    },

    _errorEventNameChange: function(eventName) {
      if (typeof eventName === 'string' && eventName !== '') {
        // disable toasts error notifications if eventName is given
        this.set('useToastEvent', false);
      }
    }

  };

</script>
