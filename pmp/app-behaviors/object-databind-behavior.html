<link rel="import" href="../../scripts/lodash/lodash.html">
<script>
  window.pmpBehaviors = window.pmpBehaviors || {};
  /** @polymerBehavior pmpBehaviors.ObjectDatabindBehaviorImpl */
  pmpBehaviors.ObjectDatabindBehaviorImpl = {
    // Behavior for managing object structure for objects or arrays of objects being
    // passed from and to etools-searchable-multiselect-menu .
    // These functions are based on the { value : xxx , label : yyyy } structure
    _mapItemFromValue: function(id, collection, getLabelOnly) {
      if (_.isEmpty(collection)) {
        return;
      }
      if (typeof id === 'string') {
        id = parseInt(id);
      }
      //TODO: refactor this, it's too complex to be an in-line statement
      return getLabelOnly ? _.find(collection, {value: id}).label :
        Array.isArray(id) ? _.map(id, function(item) {
          return _.find(collection, {value: item});
        }) : _.find(collection, {value: id});
    },

    _mapItemFromId: function(id, collection, getLabelOnly) {
      if (_.isEmpty(collection)) {
        return;
      }
      if (typeof id === 'string') {
        id = parseInt(id);
      }
      //TODO: refactor this, it's too complex to be an in-line statement
      return getLabelOnly ? _.find(collection, {id: id}).name :
        Array.isArray(id) ? _.map(id, function(item) {
          return _.find(collection, {id: item});
        }) : _.find(collection, {id: id});
    },

    _displayMultiple: function(id, collection) {
      var entries = this._mapItemFromId(id, collection);
      if (Array.isArray(entries)) {
        return _.map(entries, function(e) {
          if (!e) {
            return null;
          }
          return e.name || e.full_name;
        }).join(', ');
      }
      return entries.name || entries.full_name;
    },
    _getUpdatedObject: function(prop, value, oldObj) {
      //for multiselect
      var newObj = {};
      if (Array.isArray(value) && _.has(_.head(value), 'value')) {
        var pluckedVals = _.map(value, 'value');
        newObj[prop] = pluckedVals;
        return _.assign({}, oldObj, newObj);
      }
      newObj[prop] = _.has(value, 'value') ? value.value : value;
      return _.assign({}, oldObj, newObj);
    },
    _incrIndex: function(index) {
      return index + 1;
    },

  };

  /** @polymerBehavior pmpBehaviors.ObjectDatabindBehavior */
  pmpBehaviors.ObjectDatabindBehavior = [pmpBehaviors.ObjectDatabindBehaviorImpl];
</script>
