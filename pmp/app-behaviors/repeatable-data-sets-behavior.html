<link rel="import" href="../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import" href="../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../../bower_components/etools-ajax/etools-ajax-request-behavior.html">
<link rel="import" href="../app-config/app-endpoints-behavior.html">

<link rel="import" href="../../styles/app-mixins.html">

<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};
  /** @polymerBehavior EtoolsPmpApp.Behaviors.RepeatableDataSetsImpl */
  EtoolsPmpApp.Behaviors.RepeatableDataSetsImpl = {
    // make sure you add DynamicDialogBehavior too in your element
    properties: {
      dataItems: {
        type: Array,
        value: [],
        notify: true
      },
      dataSetModel: {
        type: Object,
        value: null
      },
      editMode: {
        type: Boolean,
        reflectToAttribute: true,
        value: false
      },
      deleteConfirmationTitle: {
        type: String,
        value: 'Delete confirmation'
      },
      deleteConfirmationMessage: {
        type: String,
        value: 'Are you sure you want to delete this item?'
      },
      deleteLoadingSource: {
        type: String,
        value: 'delete-data-set'
      },
      deleteActionLoadingMsg: {
        type: String,
        value: 'Deleting items from server...'
      },
      deleteActionDefaultErrMsg: {
        type: String,
        value: 'Deleting items from server action has failed!'
      }
    },

    attached: function() {
      // create delete confirmation dialog
      this._createDeleteConfirmationDialog();
    },

    detached: function() {
      // remove delete confirmation dialog when the element is detached
      this.removeDialog(this.deleteDialog);
    },

    _emptyList: function(listLength) {
      return listLength === 0;
    },

    _getItemModelObject: function(addNull) {
      if (addNull) {
        return null;
      }
      if (this.dataSetModel === null) {
        let newObj = {};
        if (this.dataItems.length > 0 && typeof this.dataItems[0] === 'object') {
          Object.keys(this.dataItems[0]).forEach(function(property) {
            newObj[property] = ''; //(this.model[0][property]) ? this.model[0][property] :
          }.bind(this));
        }

        return newObj;
      } else {
        return JSON.parse(JSON.stringify(this.dataSetModel));
      }
    },

    _addElement: function(addNull) {
      if (!this.editMode) {
        return;
      }
      this._makeSureDataItemsAreValid();

      let newObj = this._getItemModelObject(addNull);
      this.push('dataItems', newObj);
    },

    _openDeleteConfirmation: function(event) {
      if (!this.editMode) {
        return;
      }
      this.elToDeleteIndex = parseInt(Polymer.dom(event).localTarget.getAttribute('data-args'), 10);
      this.deleteDialog.opened = true;
    },
    _handleDeleteResponse: function() {
      this._deleteElement();
      this.elToDeleteIndex = -1;
      this.fire('global-loading', {active: false, loadingSource: this.deleteLoadingSource});
    },
    _handleDeleteError: function(responseErr) {
      this.fire('global-loading', {active: false, loadingSource: this.deleteLoadingSource});
      let msg = this.deleteActionDefaultErrMsg;
      if (responseErr instanceof Array && responseErr.length > 0) {
        msg = responseErr.join('\n');
      } else if (typeof responseErr === 'string') {
        msg = responseErr;
      }

      this.fire('toast', {text: msg, showCloseBtn: true});
    },
    _onDeleteConfirmation: function(event) {
      this.deleteDialog.opened = false;
      if (event.detail.confirmed === true) {

        let id = this.dataItems[this.elToDeleteIndex] ? this.dataItems[this.elToDeleteIndex].id : null;

        if (id) {

          if (!this._deleteEpName) {
            this.logError('You must define _deleteEpName property to be able to remove existing records');
            return;
          }
          this.fire('global-loading', {
            message: this.deleteActionLoadingMsg,
            active: true,
            loadingSource: this.deleteLoadingSource
          });

          let self = this;
          let deleteEndpoint = this.getEndpoint(this._deleteEpName, {id: id});
          this.sendRequest({
            method: 'DELETE',
            endpoint: deleteEndpoint,
            body: {}
          }).then(function(resp) {
            self._handleDeleteResponse(resp);
          }).catch(function(error) {
            self._handleDeleteError(error.response);
          });

        } else {
          this._deleteElement();
          this.elToDeleteIndex = -1;
        }

      } else {
        this.elToDeleteIndex = -1;
      }

    },

    _deleteElement: function() {
      if (!this.editMode) {
        return;
      }
      let index = this.elToDeleteIndex;
      if (index !== null && typeof index !== 'undefined' && index !== -1) {
        this.splice('dataItems', index, 1);
        this.fire('delete-confirm', {index: this.elToDeleteIndex});
      }
    },

    _createDeleteConfirmationDialog: function() {
      let deleteConfirmationContent = document.createElement('div');
      deleteConfirmationContent.innerHTML = this.deleteConfirmationMessage;
      this.deleteDialog = this.createDialog(this.deleteConfirmationTitle, 'md', 'Yes',
          'No', this._onDeleteConfirmation.bind(this), deleteConfirmationContent);
    },

    /**
     * Get last data item
     */
    _getLastDataItem: function() {
      if (Array.isArray(this.dataItems) && this.dataItems.length > 0) {
        return this.dataItems[this.dataItems.length - 1];
      } else {
        this._makeSureDataItemsAreValid();
        return null;
      }

    },

    /**
     * Check is dataItems is Array, if not init with empty Array
     */
    _makeSureDataItemsAreValid: function() {
      if (!Array.isArray(this.dataItems)) {
        this.set('dataItems', []);
      }
    }
  };

  /** @polymerBehavior EtoolsPmpApp.Behaviors.RepeatableDataSets */
  EtoolsPmpApp.Behaviors.RepeatableDataSets = [
    EtoolsLogsBehavior,
    etoolsBehaviors.DynamicDialogBehavior,
    EtoolsPmpApp.Behaviors.Endpoints,
    EtoolsAjaxRequestBehavior,
    EtoolsPmpApp.Behaviors.RepeatableDataSetsImpl
  ];

</script>
