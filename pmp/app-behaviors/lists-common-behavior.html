<link rel="import" href="../../scripts/lodash/lodash.html">
<link rel="import" href="app-navigation-helper-behavior.html">
<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};
  /** @polymerBehavior EtoolsPmpApp.Behaviors.ListsCommon */
  EtoolsPmpApp.Behaviors.ListsCommonImpl = {
    properties: {
      urlParams: {
        type: Object
      },

      q: {
        type: String,
        notify: true,
        observer: '_qChanged'
      },

      sortOrder: Object,

      debounceTime: {
        type: Number,
        value: 50
      },

      /**
       * TODO: `defaultListsSize`, `pageSize`, `totalResults` and `pageNumber` should be replaced
       * by Pagination behavior; to be removed after replacement
       */
      pageSize: {
        type: Number
      },

      pageNumber: {
        type: Number
      },

      active: Boolean,

      detailsOpened: Boolean,

      forceDataRefresh: {
        type: Boolean,
        value: false
      },

      requiredDataLoaded: {
        type: Boolean,
        value: false
      },

      initComplete: {
        type: Boolean,
        value: false
      },

      // TODO: move it to Pagination behavior
      defaultListsSize: {
        type: Number,
        value: 10
      },

      showQueryLoading: {
        type: Boolean,
        value: false
      },

      csvDownloadUrl: {
        type: String,
        notify: true
      },

      stampListData: Boolean,
      totalResults: Number
    },

    // When the list data rows are changing check and close any details opened
    _listDataChanged: function(event) {
      let rows = this.$.list.querySelectorAll('etools-data-table-row');
      if (rows && rows.length) {
        for (let i = 0; i < rows.length; i++) {
          if (rows[i].detailsOpened) {
            rows[i].set('detailsOpened', false);
          }
        }
      }
    },

    _sortOrderChanged: function(e) {
      this.set('debounceTime', 150);
      this.set('sortOrder', e.detail);
    },

    // TODO: to be deleted after filters refactor
    _pageSizeChanged: function(e) {
      this.set('debounceTime', 200);
      this.set('pageNumber', 1);
      this.set('pageSize', parseInt(e.detail.value));
    },

    // TODO: to be deleted after filters refactor
    _pageNumberChanged: function(e) {
      this.set('debounceTime', 50);
      this.set('pageNumber', e.detail.value);
    },

    _qChanged: function(q) {
      this.set('debounceTime', 300);
      this.set('pageNumber', 1);
    },

    // List fade in fade out effect
    _listChanged: function(filteredList, oldFilteredList) {
      let classList = this.$.list.classList;
      if (filteredList instanceof Array && classList.contains('hidden')) {
        classList.remove('hidden');
      }
      if (typeof oldFilteredList === 'undefined') {
        this.set('showQueryLoading', true);
      }
    },

    /**
     * At page refresh Dexie DBs might be wiped out and the list
     *(filteredPartners,filteredAgreements etc) will be empty.
     * Because of this we need to refilter after list data is saved locally.
     * list-data-path holds the name of the list : filteredAgreements,filteredPartners, etc
     */
    _requiredDataHasBeenLoaded: function(event) {
      event.stopImmediatePropagation();

      let listDataPath = Polymer.dom(event).localTarget.getAttribute('list-data-path');
      let list = this.get(listDataPath);

      if (typeof list === 'undefined' ||
          (Array.isArray(list) && list.length === 0)) {
        this.set('forceDataRefresh', true);
      }
      // recheck params to trigger agreements filtering
      this.set('initComplete', false);
      this.set('requiredDataLoaded', true);
      this._init(this.active);
    },

    listAttachedCallback: function(active, loadingMsg, loadingSource) {
      this.set('stampListData', true);
      if (active) {
        this.fire('global-loading', {message: loadingMsg, active: true, loadingSource: loadingSource});
      } else {
        this.set('showQueryLoading', true);
      }
    },

    /**
     * Make sure you define _sortableFieldNames on *-list element properties level.
     * Ex for partners:
     * _sortableFieldNames: {
     *    type: Array,
     *    value: ['vendor_number', 'name']
     *  }
     */
    _isValidSortField: function(fieldName) {
      return this._sortableFieldNames instanceof Array && this._sortableFieldNames.indexOf(fieldName) > -1;
    },

    initSortFieldsValues: function(defaultSortData, urlQueryParamsSortData) {
      if (urlQueryParamsSortData) {
        let p = urlQueryParamsSortData.split('.');
        if (this._isValidSortField(p[0])) {
          return {field: p[0], direction: p[1]};
        }
      }
      return defaultSortData;
    },

    _getFilterUrlValuesAsArray: function(types) {
      return types ? types.split('|') : [];
    },

    // Outputs the query string for the list
    _buildUrlQueryString: function(filters) {
      let queryParams = [];

      for (let field in filters) {
        if (filters[field]) {
          let filterValue = filters[field];
          let filterUrlValue;

          if (filterValue instanceof Array && !_.isEmpty(filterValue)) {
            filterUrlValue = filterValue.join('|');
          } else if (field === 'sort' && filterValue.field && filterValue.direction) {
            filterUrlValue = filterValue.field + '.' + filterValue.direction;
          } else {
            if (!(field === 'page' && filterValue === 1)) {
              filterUrlValue = String(filterValue).trim();
            }
          }

          if (filterUrlValue) {
            queryParams.push(field + '=' + filterUrlValue);
          }
        }
      }

      return queryParams.join('&');
    },

    _buildCsvExportUrl: function(filters, endpointUrl) {
      let params = [];

      for (let field in filters) {
        if (filters[field]) {
          if (filters[field] instanceof Array && !_.isEmpty(filters[field])) {
            params.push(field + '=' + filters[field].join(','));
          } else {
            let filterStrVal = String(filters[field]).trim();
            params.push(field + '=' + filterStrVal);
          }
        }
      }
      params.push('format=csv');
      let queryString = params.join('&');
      return endpointUrl + '?' + queryString;
    },

    // Updates URL state with new query string, and launches query
    _updateUrlAndDislayedData: function(currentPageUrlPath, lastUrlQueryStr, buildCsvExportUrl,
                                        buildQueryString, filterData) {
      if (!this.requiredDataLoaded || !this.initComplete) {
        return;
      }

      this.set('csvDownloadUrl', buildCsvExportUrl());
      let qs = buildQueryString();

      if (qs !== lastUrlQueryStr) {
        // update URL
        this.updateAppState(currentPageUrlPath, qs, true);
        // filter agreements
        if (this.requiredDataLoaded) {
          filterData();
        }
      } else {
        if (location.search === '') {
          // only update URL query string, without location change event being fired(no page refresh)
          this.updateAppState(currentPageUrlPath, qs, false);
        }
        if (this.forceDataRefresh && this.requiredDataLoaded) {
          // re-filter list data
          // this will only execute when [list-data]-loaded event is received
          filterData();
          this.set('forceDataRefresh', false);
        }
      }
      return qs;
    }

  };

  /** @polymerBehavior */
  EtoolsPmpApp.Behaviors.ListsCommon = [
    EtoolsPmpApp.Behaviors.AppNavigationHelper,
    EtoolsPmpApp.Behaviors.ListsCommonImpl
  ]
</script>
