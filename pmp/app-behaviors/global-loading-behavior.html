<link rel="import" href="app-navigation-helper-behavior.html">
<script>
  window.pmpBehaviors = window.pmpBehaviors || {};
  /** @polymerBehavior pmpBehaviors.globalLoadingBehaviorImpl */
  pmpBehaviors.globalLoadingBehaviorImpl = {

    properties: {
      loadingsCounter: {
        type: Number,
        value: 0,
        observer: '_manageGlobalLoadingState'
      },
      showLoading: Boolean,
      // loadingCounterDecrementAdjustment will be used to disable
      // a loading that came from a link tap event(like menu)
      loadingCounterDecrementAdjustment: {
        type: Number,
        value: 0
      },
      skipDecrementAdjustment: Boolean
    },

    listeners: {
      'global-loading': '_handleGlobalLoading'
    },

    _showLoading: function() {
      if (!this.showLoading) {
        this.set('showLoading', true);
      }
    },
    _hideLoading: function() {
      if (this.showLoading) {
        this.set('showLoading', false);
      }
    },
    _manageGlobalLoadingState: function(loadingsCounterVal) {
      if (loadingsCounterVal > 0) {
        this._showLoading();
      } else {
        this._hideLoading();
      }
    },
    _handleGlobalLoading: function(e) {
      e.stopImmediatePropagation();
      if (e.detail.resetCounter) {
        // loading event came from menu tap event,
        // it mean page will change and we need to reset the loadings counter
        this.loadingsCounter = 0;
      }
      if (e.detail.active === true) {
        // set loading message
        var loadingMsg = 'Loading...';
        if (e.detail && typeof e.detail.message === 'string' && e.detail.message !== '') {
          loadingMsg = e.detail.message;
        }
        //this.$$('#loading-message').innerHTML = loadingMsg;
        this.$.pageLoading.set('loadingText', loadingMsg);
        // update loadings counter
        this.loadingsCounter++;

        // got to new URL if needed, but using a delay to allow loading to show
        if (e.detail.newUrl) {
          this.async(function() {
            this.changeAppState(e.detail.newUrl);
            this.set('loadingCounterDecrementAdjustment', 1);
          }, 50);
        }
      } else {
        if (this.loadingsCounter > 0) {
          this.loadingsCounter--;

          // Check for loading counter adjustment
          if (!!this.loadingCounterDecrementAdjustment) {

            var loadingCounterNeedsAjustment = this._shouldAdjustLoadingCounter(this.loadingsCounter,
              this.loadingCounterDecrementAdjustment);

            /**
             * Loading counter adjustment is needed but is blocked.
             * For example this may occur because page has not been loaded yet and we need to keep loading active
             */
            if (loadingCounterNeedsAjustment && this.skipDecrementAdjustment) {
              this.set('skipDecrementAdjustment', false);
              return;
            }

            /**
             * Make loading counter adjustment. This is needed because there might not be enough deactivate loading
             * events to hide the loading.
             */

            this.loadingsCounter = this.loadingsCounter - this.loadingCounterDecrementAdjustment;
            this.set('loadingCounterDecrementAdjustment', 0);
            this.set('skipDecrementAdjustment', false);

            // Loading counter can not be negative after adjustment is done.
            if (this.loadingsCounter < 0) {
              this.loadingsCounter = 0;
            }
          }
        }
      }
    },
    _shouldAdjustLoadingCounter: function(counter, adjustVal) {
      return (counter - adjustVal) <= 0;
    }
  };

  /** @polymerBehavior pmpBehaviors.globalLoadingBehavior */
  pmpBehaviors.globalLoadingBehavior = [
    pmpBehaviors.AppNavigationHelperBehavior,
    pmpBehaviors.globalLoadingBehaviorImpl
  ];
</script>
