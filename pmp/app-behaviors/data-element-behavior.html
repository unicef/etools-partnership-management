<link rel="import" href="../app-config/app-dexie-db-config.html"/>
<link rel="import" href="../app-config/app-endpoints-behavior.html"/>
<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};
  /** @polymerBehavior EtoolsPmpApp.Behaviors.DataElementImpl */
  EtoolsPmpApp.Behaviors.DataElementImpl = {

    properties: {
      endpoint: {
        type: Object,
        observer: '_endpointChanged'
      },
      data: {
        type: Array,
        readOnly: true,
        notify: true
      },
      db: {
        type: Object,
        value: function() {
          return EtoolsPmpApp.DexieDb; // TODO: check if this is really needed
        }
      },
      fireDataLoaded: {
        type: Boolean,
        value: false
      },
      _refreshInterval: {
        type: Object,
        value: null
      }
    },

    detached: function() {
      this._removeAutomaticDataRefreshLoop();
    },

    ready: function() {
      this._elementReady();
    },

    _elementReady: function() {
      if (!this.endpointName) {
        console.warn('Please specify an endpointName property');
      } else {
        this.endpoint = this.getEndpoint(this.endpointName);
      }
    },

    _handleResponse: function(res) {
      this._setData(res.detail);
      if (this.fireDataLoaded) {
        if (!this.dataLoadedEventName) {
          console.warn('Please specify data loaded event name(dataLoadedEventName property)');
        } else {
          this.fire(this.dataLoadedEventName);
        }
      }
    },

    _endpointChanged: function() {
      // Check if endpoint has expire property set and it's bigger than 0
      if (this.method === 'GET' && newEndpoint.hasOwnProperty('exp') && newEndpoint.exp > 0) {
          this._removeAutomaticDataRefreshLoop();
          this._setAutomaticDataRefreshLoop();
        }
    },

    _removeAutomaticDataRefreshLoop: function() {
      if(this._refreshInterval !== null) {
        clearInterval(this._refreshInterval);
        this.set('_refreshInterval', null);
      }
    },

    _setAutomaticDataRefreshLoop: function() {
      if (!this.endpoint || !this.endpoint.exp) {
        return;
      }

      var refreshInterval = setInterval(function() {
        this.set('url', null);
        this.set('url', this.endpoint.url);
      }.bind(this), this.endpoint.exp);

      this.set('_refreshInterval', refreshInterval);
    },
  };

  /** @polymerBehavior EtoolsPmpApp.Behaviors.DataElement */
  EtoolsPmpApp.Behaviors.DataElement = [
    EtoolsPmpApp.Behaviors.Endpoints,
    EtoolsPmpApp.Behaviors.DataElementImpl
  ];

</script>
