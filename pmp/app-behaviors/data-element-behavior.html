<link rel="import" href="../app-config/app-dexie-db-config.html"/>
<link rel="import" href="../app-config/app-endpoints-behavior.html"/>
<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};
  /** @polymerBehavior EtoolsPmpApp.Behaviors.DataElementImpl */
  EtoolsPmpApp.Behaviors.DataElementImpl = {

    properties: {
      options: {
        type: Object,
        value: {
          endpoint: null,
          csrf: true
        },
      },
      data: {
        type: Array,
        readOnly: true,
        notify: true
      },
      db: {
        type: Object,
        value: function() {
          return EtoolsPmpApp.DexieDb; // TODO: check if this is really needed
        }
      },
      fireDataLoaded: {
        type: Boolean,
        value: false
      },
      _refreshInterval: {
        type: Object,
        value: null
      }
    },
    detached: function() {
      this._removeAutomaticDataRefreshLoop();
    },

    ready: function() {
      this._elementReady();
    },

    _elementReady: function() {
      if (!this.endpointName) {
        console.warn('Please specify an endpointName property');
      } else {
        this.options.endpoint = this.getEndpoint(this.endpointName);
        this._endpointChanged(this.options.endpoint);
      }
    },

    _handleResponse: function(res) {
      this._setData(res.detail);
      if (this.fireDataLoaded) {
        if (!this.dataLoadedEventName) {
          console.warn('Please specify data loaded event name(dataLoadedEventName property)');
        } else {
          this.fire(this.dataLoadedEventName);
        }
      }
    },

    _endpointChanged: function(newEndpoint) {
      // Check if endpoint has expire property set and it's bigger than 0
      if (newEndpoint.hasOwnProperty('exp') && newEndpoint.exp > 0) {
          this._removeAutomaticDataRefreshLoop();
          this._setAutomaticDataRefreshLoop(newEndpoint);
        }
    },

    _removeAutomaticDataRefreshLoop: function() {
      if(this._refreshInterval !== null) {
        clearInterval(this._refreshInterval);
        this.set('_refreshInterval', null);
      }
    },

    _setAutomaticDataRefreshLoop: function(newEndpoint) {
      console.log('loop set to', newEndpoint.exp);
      var refreshInterval = setInterval(function() {
        console.log('fire in the hole!');
        this.$.ajax.send();
      }.bind(this), newEndpoint.exp);

      this.set('_refreshInterval', refreshInterval);
    },
  };

  /** @polymerBehavior EtoolsPmpApp.Behaviors.DataElement */
  EtoolsPmpApp.Behaviors.DataElement = [
    EtoolsPmpApp.Behaviors.Endpoints,
    EtoolsPmpApp.Behaviors.DataElementImpl
  ];

</script>
