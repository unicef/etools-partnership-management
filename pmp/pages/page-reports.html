<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="behaviors/page-utils-behavior.html">
<link rel="import" href="../app-elements/etools-status/etools-action-button.html">
<link rel="import" href="../app-elements/reports/elems/behaviors/report-details-behavior.html">
<link rel="import" href="../app-elements/reports/elems/report-status.html">

<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">

<dom-module id="page-reports">

  <template strip-whitespace>

    <style include="page-layout-styles shared-styles buttons-styles">
      :host {
        display: block;
      }
      .main-title sup {
        font-size: 14px;
      }
      etools-action-button {
        min-width: 160px;
      }
    </style>

    <app-route
        route="{{route}}"
        pattern="reports/list"
        query-params="{{listPageQueryParams}}"
        active="{{listActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="reports/:id/:tab"
        active="{{tabsActive}}"
        data="{{routeData}}"></app-route>


    <div class$="page-top-content [[_getTopContentAdditionalClass(reportsPage)]]">
      <div class="top-content">
        <div class="top-content-row title-row">
          <h1 main-title>
            <template is="dom-if" if="[[listActive]]">
              Partner Reports
            </template>
            <template is="dom-if" if="[[tabsActive]]">
              <!-- TODO: replace lastReportPdRef with report.programme_document.reference_number when available -->
              <span>[[lastReportPdRef]]: [[report.reporting_period]]</span>
              <sup><report-status status="[[report.status]]"></report-status></sup>
            </template>
          </h1>
          <div class="top-content-actions-wrapper">
            <div class="top-content-action" hidden$="[[!tabsActive]]">
              <etools-action-button actions="[[reportActions]]"
                                    on-accept-report="_accept"
                                    on-send-back-to-partner="_sendBackToPartner"
                                    on-download-report="_download"></etools-action-button>
            </div>
          </div>
        </div>
        <template is="dom-if" if="[[tabsActive]]">
          <div class="top-content-row">
            <paper-tabs id="reportTabs"
                        selected="{{activeTab}}"
                        attr-for-selected="name"
                        noink bottom-item
                        on-iron-select="_handleTabSelectAction">

              <paper-tab name="summary" link>
                <span class="tab-content">Report Summary</span>
              </paper-tab>

              <paper-tab name="progress" link>
                <span class="tab-content">Progress</span>
              </paper-tab>

            </paper-tabs>
          </div>
        </template>
      </div>
    </div>

    <div id="main">
      <div id="pageContent">
        <iron-pages id="reportsPages"
                    selected="{{reportPage}}"
                    attr-for-selected="name"
                    role="main">

          <template is="dom-if" if="[[_pageEquals(reportPage, 'list')]]">
            <reports-list id="list"
                          name="list"
                          active="[[listActive]]"
                          url-params="[[listQueryParams]]"></reports-list>
          </template>

          <template is="dom-if" if="[[_pageEquals(reportPage, 'summary')]]">
            <report-summary name="summary" report="[[report]]"></report-summary>
          </template>

          <template is="dom-if" if="[[_pageEquals(reportPage, 'progress')]]">
            <report-progress id="reportDetails"
                             name="progress"
                             report="[[report]]"></report-progress>
          </template>
        </iron-pages>

      </div> <!-- page content end -->
      <!-- No sidebar here -->
    </div> <!-- main container end -->

  </template>

  <script>

    Polymer({

      is: 'page-reports',

      behaviors: [
        EtoolsLogsBehavior,
        EtoolsPmpApp.Behaviors.PageUtils,
        EtoolsPmpApp.Behaviors.ReportDetails
      ],

      properties: {
        tabsActive: {
          type: Boolean
        },
        reportPage: {
          type: String
        },
        routeData: {
          type: Object
        },
        activeTab: {
          type: String,
          value: '',
          observer: '_activeTabChanged'
        }
      },

      observers: [
        '_updateUrlTab(routeData.tab)',
        '_pageChanged(listActive, activeTab)',
        '_observeRouteDataId(routeData.id, listActive)',
      ],

      ready: function() {
        this.debounce('mockup-list-loaded', function() {
          this.fire('global-loading', {active: false});
        }.bind(this), 500)
      },

      attached: function() {
        // deactivate main page loading msg triggered in app-shell
        this.fire('global-loading', {active: false, loadingSource: 'main-page'});
        /**
         * Loading msg used on stamping tabs elements (disabled in each tab main element attached callback)
         */
        let loadingMsg = 'Loading ' + (this.listActive ? 'reports list' :
            (this._removeStrDash(this.activeTab) + ' page')) + ' elements...';
        this.fire('global-loading', {
          message: loadingMsg,
          active: true,
          loadingSource: 'reports-page'
        });
      },

      _setActivePage: function(listActive, tab) {
        let page = 'list';
        let pagePrefix = 'reports-';
        let pageBaseUrl = '../app-elements/reports/';
        if (!listActive) {
          page = tab;
          pagePrefix = 'report-';
        }
        if (page) {
          let self = this;
          self._importPageElement(page, pagePrefix, pageBaseUrl).then(function() {
            self.set('reportPage', page);
          }).catch(function(err) {
            self.logError('Report page import error occurred', '[report(s) ' + page + ']', err);
            self.fire('global-loading', {active: false, loadingSource: 'reports-page'});
            self._triggerPageNotFound();
          });
        }
      },

      _pageChanged: function(listActive, tab) {
        this._setActivePage(listActive, tab);
      },

      _activeTabChanged: function(activeTab) {
        if (activeTab) {
          this.set('routeData.tab', activeTab);
        }
      },

      _updateUrlTab: function(tab) {
        if (!tab) {
          return;
        }
        this.debounce('debounce-url-tab-update', function() {
          let tabs = this.$$('#reportTabs');
          if (tabs) {
            tabs.notifyResize();
          }
          this.fire('update-main-path', {path: this.route.path});
          this.set('activeTab', tab);
        }.bind(this), 50);
      },

      _handleTabSelectAction: function(e) {
        this._showTabChangeLoadingMsg(e, 'reports-page', 'report-');
      },

      _observeRouteDataId: function(reportId, listActive) {
        if (listActive) {
          return;
        }
        let id = parseInt(reportId, 10);
        if (this.report && this.report.id === id) {
          return;
        }
        this.async(function() {
          if (Number.isNaN(id)) {
            this.fire('toast', {text: 'Invalid report ID!', showCloseBtn: true});
            this.set('report', null);
            return;
          }
          this.debounce('loading-report-data', this.requestReportDetails.bind(this, id), 50);
        }.bind(this));
      },

      _accept: function(e) {
        console.log('accept report action here...');
      },

      _sendBackToPartner: function(e) {
        console.log('send report back to partner action here...');
      },

      _download: function(e) {
        console.log('download report action here...');
      }

    });

  </script>

</dom-module>
