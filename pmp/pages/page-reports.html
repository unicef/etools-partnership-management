<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="behaviors/page-utils-behavior.html">
<link rel="import" href="behaviors/subroute-behavior.html">
<link rel="import" href="../app-config/app-endpoints-behavior.html">

<link rel="import" href="../app-elements/page-header/page-content-header.html">
<link rel="import" href="../app-elements/common-elements/etools-tabs.html">
<link rel="import" href="../app-elements/etools-status/etools-action-button.html">
<link rel="import" href="../app-elements/reports/elems/behaviors/report-details-behavior.html">
<link rel="import" href="../app-elements/reports/elems/report-status.html">
<link rel="import" href="../app-elements/reports/elems/report-rating-dialog.html">
<link rel="import" href="../app-elements/reports/elems/report-reject-dialog.html">

<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">

<link rel="import" href="../../scripts/lodash/lodash.html">

<dom-module id="page-reports">

  <template strip-whitespace>

    <style include="page-layout-styles shared-styles buttons-styles">
      :host {
        display: block;
      }
      h1[main-title] sup {
        font-size: 14px;
      }
      etools-action-button {
        min-width: 160px;
      }
    </style>

    <app-route
        route="{{route}}"
        pattern="/list"
        query-params="{{listPageQueryParams}}"
        active="{{listActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="/:id/:tab"
        active="{{tabsActive}}"
        data="{{routeData}}"></app-route>

    <page-content-header with-tabs-visible="[[tabsActive]]">
      <div slot="page-title">
        <template is="dom-if" if="[[listActive]]">
          Partner Reports
        </template>
        <template is="dom-if" if="[[tabsActive]]">
          <span>[[report.programme_document.reference_number]]: [[report.reporting_period]]</span>
          <sup><report-status status="[[report.status]]"></report-status></sup>
        </template>
      </div>

      <div slot="title-row-actions" class="content-header-actions">
        <div class="action" hidden$="[[!tabsActive]]">
          <etools-action-button actions="[[reportActions]]"
                                on-accept-report="_accept"
                                on-send-back-to-partner="_sendBackToPartner"
                                on-download-report="_download"></etools-action-button>
        </div>
      </div>

      <template is="dom-if" if="[[tabsActive]]">
        <etools-tabs slot="tabs"
                     tabs="[[reportTabs]]"
                     active-tab="{{routeData.tab}}"
                     on-iron-select="_handleTabSelectAction"></etools-tabs>
      </template>
    </page-content-header>

    <div id="main">
      <div id="pageContent">
        <iron-pages id="reportsPages"
                    selected="{{activePage}}"
                    attr-for-selected="name"
                    role="main">

          <template is="dom-if" if="[[_pageEquals(activePage, 'list')]]">
            <reports-list id="list"
                          name="list"
                          active="[[listActive]]"
                          url-params="[[listQueryParams]]"></reports-list>
          </template>

          <template is="dom-if" if="[[_pageEquals(activePage, 'summary')]]">
            <report-summary name="summary" report="[[report]]"></report-summary>
          </template>

          <template is="dom-if" if="[[_pageEquals(activePage, 'progress')]]">
            <report-progress id="reportDetails"
                             name="progress"
                             report="[[report]]"></report-progress>
          </template>
        </iron-pages>

      </div> <!-- page content end -->
      <!-- No sidebar here -->
    </div> <!-- main container end -->
  </template>

  <script>

    Polymer({

      is: 'page-reports',

      behaviors: [
        EtoolsLogsBehavior,
        EtoolsPmpApp.Behaviors.PageUtils,
        EtoolsPmpApp.Behaviors.Subroute,
        EtoolsPmpApp.Behaviors.ReportDetails,
        EtoolsPmpApp.Behaviors.Endpoints
      ],

      properties: {
        reportTabs: {
          type: Array,
          value: [
            {
              tab: 'summary',
              tabLabel: 'Report Summary',
              hidden: false
            },
            {
              tab: 'progress',
              tabLabel: 'Progress',
              hidden: false
            }
          ]
        },
        reportRatingDialog: {
          type: Object
        },
        reportRejectDialog: {
          type: Object
        }
      },

      observers: [
        '_pageChanged(listActive, tabsActive, routeData)',
        '_observeRouteDataId(routeData.id, listActive, tabsActive)',
        '_reportChanged(report)'
      ],

      ready: function() {
        this.debounce('mockup-list-loaded', function() {
          this.fire('global-loading', {active: false});
        }.bind(this), 500);
      },

      attached: function() {
        // deactivate main page loading msg triggered in app-shell
        this.fire('global-loading', {active: false, loadingSource: 'main-page'});
        /**
         * Loading msg used on stamping tabs elements (disabled in each tab main element attached callback)
         */
        let loadingMsg = 'Loading ' + (this.listActive ? 'reports list' :
            (this._removeStrDash(this.routeData.tab) + ' page')) + ' elements...';
        this.fire('global-loading', {
          message: loadingMsg,
          active: true,
          loadingSource: 'reports-page'
        });

        this._createReportStatusUpdateDialogs();
      },

      _pageChanged: function(listActive, tabsActive, routeData) {
        if (!listActive && !tabsActive) {
          return;
        }

        this.scrollToTopOnCondition(!listActive);

        let fileImportDetails = {
          filenamePrefix: 'report',
          baseUrl: '../app-elements/reports/',
          importErrMsgPageCategory: 'Report',
          errPrefixTmpl: '[report(s) ##page##]',
          loadingMsgSource: 'reports-page'
        };
        this.setActivePage(listActive, routeData.tab, 'report', fileImportDetails);
      },

      _handleTabSelectAction: function(e) {
        this._showTabChangeLoadingMsg(e, 'reports-page', 'report-');
      },

      _observeRouteDataId: function(reportId, listActive) {
        if (listActive) {
          return;
        }
        let id = parseInt(reportId, 10);
        if (this.report && this.report.id === id) {
          return;
        }
        this.async(function() {
          if (isNaN(id)) {
            this.fire('toast', {text: 'Invalid report ID!', showCloseBtn: true});
            this.set('report', null);
            return;
          }
          this.debounce('loading-report-data', this.requestReportDetails.bind(this, id), 50);
        }.bind(this));
      },

      _accept: function() {
        this.reportRatingDialog.open();
      },

      _sendBackToPartner: function() {
        this.reportRejectDialog.open();
      },

      _computeReportFilename: function(report) {
        return report.programme_document.reference_number + '_' + report.id + '_' + report.status + '.pdf';
      },

      _download: function() {
        if (!this.report) {
          return;
        }
        let a = document.createElement('a');
        a.setAttribute('target', '_blank');
        let downloadEndpoint = this.getEndpoint('downloadReport', {reportId: this.report.id});
        a.href = downloadEndpoint.url;
        a.click();
      },

      detached: function() {
        if (this.reportRatingDialog) {
          document.querySelector('body').removeChild(this.reportRatingDialog);
        }
        if (this.reportRejectDialog) {
          document.querySelector('body').removeChild(this.reportRejectDialog);
        }
      },

      _createReportStatusUpdateDialogs: function() {
        this.reportRatingDialog = document.createElement('report-rating-dialog');
        this.reportRatingDialog.setAttribute('id', 'reportRatingDialog');
        this.reportRatingDialog.set('toastEventSource', this);
        this.reportRatingDialog.addEventListener('report-accepted', this._updateReportDetailsObj.bind(this));

        document.querySelector('body').appendChild(this.reportRatingDialog);

        this.reportRejectDialog = document.createElement('report-reject-dialog');
        this.reportRejectDialog.setAttribute('id', 'reportRejectDialog');
        this.reportRejectDialog.set('toastEventSource', this);
        this.reportRejectDialog.addEventListener('report-rejected', this._updateReportDetailsObj.bind(this));

        document.querySelector('body').appendChild(this.reportRejectDialog);
      },

      _reportChanged: function(report) {
        if (!report) {
          return;
        }
        this.reportRatingDialog.set('report', report);
        this.reportRejectDialog.set('report', report);
      },

      _updateReportDetailsObj: function(e) {
        e.stopImmediatePropagation();
        if (!e.detail.report) {
          return;
        }
        this.set('report', e.detail.report);
        // update reports list object data without makeing a new request
        this._updateReportDataOnList(e.detail.report);
      },

      _updateReportDataOnList: function(report) {
        let list = this.$$('#list');
        if (list) {
          let reportsDisplayList = list.$$('reports-display-list');
          if (reportsDisplayList && !_.isEmpty(reportsDisplayList.reports)) {
            let currentReports = reportsDisplayList.reports;
            let index = -1;
            for (let i = 0; i < currentReports.length; i++) {
              if (currentReports[i].id === report.id) {
                index = i;
                break;
              }
            }
            if (index > -1) {
              // updates report found in list => update shown data
              reportsDisplayList.set(['reports', index, 'status'], report.status);
              // TODO: find out if any of the next report properties can change on accept/send back
              reportsDisplayList.set(['reports', index, 'due_date'], report.due_date);
              reportsDisplayList.set(['reports', index, 'submission_date'], report.submission_date);
              reportsDisplayList.set(['reports', index, 'review_date'], report.review_date);
              reportsDisplayList.set(['reports', index, 'reporting_period'], report.reporting_period);
            }

          }
        }
      }

    });

  </script>

</dom-module>
