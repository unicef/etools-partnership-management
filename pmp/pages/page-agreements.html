<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../app-elements/page-header/page-header.html">
<link rel="import" href="../app-elements/partner-data/partner-data.html">
<link rel="import" href="../app-elements/agreements/agreements-list.html">
<link rel="import" href="../app-elements/agreements/agreement-details.html">

<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="page-agreements">

  <template>

    <style include="page-layout-styles shared-styles">

      :host {
        display: block;
      }

      .list-page {
        max-width: 920px;
        margin: 20px auto;
      }

    </style>

    <app-route
        route="{{route}}"
        pattern="/list"
        query-params="{{queryParams}}"
        active="{{listActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="/:id/details"
        active="{{detailsActive}}"
        data="{{routeData}}"></app-route>

    <partner-data partner-id="[[agreement.partner]]" partner="{{partner}}"></partner-data>

    <app-header-layout has-scrolling-region>

      <app-header id="header" fixed shadow>

        <page-header title="Agreements"></page-header>

      </app-header>

      <div class="page-top-content" hidden$="{{!detailsActive}}">
        <div class="top-content">
          <div class="top-content-row title-row">
            <h1 main-title>[[_setAgreementDetailsPageTitle(agreement, partner)]]</h1>
            <div class="top-content-actions-wrapper">
              <div class="top-content-action">
                <paper-button>
                  <iron-icon icon="print"></iron-icon>
                  Print
                </paper-button>
              </div>
            </div>
          </div>
          <div class="top-content-row">
            <paper-tabs
                selected="{{routeData.tab}}"
                attr-for-selected="name"
                fallback-selection="details" noink bottom-item>

              <paper-tab name="details" link>
                <span class="tab-content">Agreement Details</span>
              </paper-tab>

            </paper-tabs>
          </div>
        </div>
      </div>

      <iron-pages id="agreementsPages"
                  selected="{{agreementPage}}"
                  attr-for-selected="name"
                  fallback-selection="list"
                  role="main">

        <div class="list-page" name="list">
          <agreements-list id="list"></agreements-list>
        </div>
        <div class="page" name="details">
          <agreement-details agreement="[[agreement]]" partner="[[partner]]"></agreement-details>
        </div>
      </iron-pages>

    </app-header-layout>

  </template>

  <script>

    Polymer({

      is: 'page-agreements',

      properties: {

        agreementPage: {
          type: String,
        }

      },

      observers: [
        '_resizeHeader(detailsActive)',
        '_pageChanged(listActive, routeData.tab)',
      ],

      ready: function() {
        if (this.listActive) {
          this.$.list.init(this.queryParams);
        }

        // TODO: replace this placeholder data
        this.agreement = {
          "id":8,
          "created":"2016-04-21T08:52:31.214539Z",
          "modified":"2016-04-21T08:52:31.215398Z",
          "agreement_type":"PCA",
          "agreement_number":"PCA 2015/29-3",
          "attached_agreement":null,
          "start":"2015-09-30",
          "end":"2016-09-29",
          "signed_by_unicef_date":"2015-07-28",
          "signed_by_partner_date":"2015-07-28",
          "bank_name":null,
          "bank_address":"",
          "account_title":null,
          "account_number":null,
          "routing_details":null,
          "bank_contact_person":null,
          "partner":21,
          "signed_by":1152,
          "partner_manager":134
        };

      },

      _resizeHeader: function() {
        this.$$('app-header-layout').notifyResize();
      },

      _getActivePage: function(listActive, tab) {
        if (listActive) {
          return 'list';
        } else {
          return tab;
        }
      },

      _pageChanged: function(listActive, tab) {
        var activePage = this._getActivePage(listActive, tab);
        this.set('agreementPage', activePage);
      },

      _setAgreementDetailsPageTitle: function(agreement, partner) {
        if (typeof agreement === 'object'
            && agreement !== null && Object.keys(agreement).length > 0) {
          return partner.name + ': ' + agreement.agreement_number;
        } else {
          return 'Add Agreement';
        }
      }

    });

  </script>

</dom-module>
