<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/etools-behaviors/etools-logs-behavior.html">
<link rel="import" href="../app-behaviors/scroll-control-behavior.html">

<link rel="import" href="behaviors/page-utils-behavior.html">

<link rel="import" href="../app-elements/agreements/agreement-data/agreement-item-data.html">
<link rel="import" href="../app-elements/common-elements/etools-error-messages-box.html">

<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">

<dom-module id="page-agreements">

  <template strip-whitespace>

    <style include="page-layout-styles shared-styles buttons-styles">

      :host {
        display: block;
      }

    </style>

    <app-route
        route="{{route}}"
        pattern="/list"
        query-params="{{listPageQueryParams}}"
        active="{{agreementListActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="/:id/details"
        active="{{agreementDetailsActive}}"
        data="{{routeData}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="/new-agreement"
        active="{{newAgreementActive}}"></app-route>

    <div class$="page-top-content [[_getTopContentAdditionalClass(agreementPage)]]">
      <div class="top-content">
        <div class="top-content-row title-row">
          <h1 main-title>

            <template is="dom-if" if="[[agreementListActive]]">
              <span>Agreements</span>
            </template>

            <template is="dom-if" if="[[newAgreementActive]]">
              <span>Add Agreement</span>
            </template>

            <template is="dom-if" if="[[agreementDetailsActive]]">
              <span>[[_getAgreementDetailsTitle(agreement, agreement.id)]]</span>
            </template>

            </span>
          </h1>
          <div class="top-content-actions-wrapper">
            <div class="top-content-action" hidden$="[[!agreementListActive]]">
              <a target="_blank" href$="[[csvDownloadUrl]]">
                <paper-button>
                  <iron-icon icon="file-download"></iron-icon>
                  Export
                </paper-button>
              </a>
            </div>
            <div class="top-content-action" hidden$="[[!_showNewAgreementAddButton(agreementListActive, permissions)]]">
              <paper-button class="primary-btn with-prefix" on-tap="_goToNewAgreementPage">
                <iron-icon icon="add"></iron-icon>
                Add New Agreement
              </paper-button>
            </div>
          </div>
        </div>
        <template is="dom-if" if="[[_showPageTabs(agreementPage)]]">
          <div class="top-content-row">
            <paper-tabs
                selected="details"
                attr-for-selected="name"
                fallback-selection="details"
                noink bottom-item
                on-iron-select="_handleTabSelectAction">

              <paper-tab name="details" link>
                <span class="tab-content">Agreement Details</span>
              </paper-tab>

            </paper-tabs>
          </div>
        </template>
      </div>
    </div>

    <div id="main">
      <div id="pageContent">
        <etools-error-messages-box id="errorsBox"
                                   title="Errors Saving Agreement"
                                   errors="{{serverErrors}}"></etools-error-messages-box>
        <iron-pages id="agreementsPages"
                    selected="{{agreementPage}}"
                    attr-for-selected="name"
                    role="main">

          <template is="dom-if" if="[[_pageEquals(agreementPage, 'list')]]">
            <agreements-list id="list"
                             name="list"
                             active="[[agreementListActive]]"
                             csv-download-url="{{csvDownloadUrl}}"
                             url-params="[[listQueryParams]]">
            </agreements-list>
          </template>

          <template is="dom-if" if="[[_pageEquals(agreementPage, 'details')]]">
            <agreement-details
                id="agreementDetails"
                name="details"
                agreement="[[agreement]]"
                authorized-officers="{{authorizedOfficers}}"
                edit-mode="[[_hasEditPermissions(permissions)]]"
                is-new-agreement="[[newAgreementActive]]">
            </agreement-details>
          </template>
        </iron-pages>
      </div> <!-- page content end -->

      <template is="dom-if" if="[[_showSidebarStatus(agreementListActive, _subPageOrTabAttached, agreement)]]">
        <!-- sidebar content start -->
        <div id="sidebar">
          <agreement-status status$="[[agreement.status]]"
                            active="[[!agreementListActive]]"
                            new-agreement$="[[newAgreementActive]]"
                            agreement-id$="[[agreement.id]]"
                            agreement-type="[[agreement.agreement_type]]"
                            on-save-agreement="_validateAndTriggerAgreementSave"
                            edit-mode="[[_hasEditPermissions(permissions)]]"
                            on-update-agreement-status="_updateAgreementStatus">
          </agreement-status>
        </div><!-- sidebar content end -->
      </template>

    </div> <!-- main page content end -->

    <agreement-item-data id="agreementData"
                         agreement="{{agreement}}"
                         agreement-id="[[selectedAgreementId]]"
                         error-event-name="agreement-save-error"></agreement-item-data>

  </template>

  <script>

    Polymer({

      is: 'page-agreements',

      behaviors: [
        EtoolsLogsBehavior,
        EtoolsPmpApp.Behaviors.PageUtils,
        EtoolsPmpApp.Behaviors.ScrollControl
      ],

      properties: {
        agreementPage: {
          type: String,
          notify: true
        },
        permissions: {
          type: Object
        },
        selectedAgreementId: {
          type: Number
        },
        newAgreementModel: {
          type: Object,
          value: {
            id: undefined,
            authorized_officers: [],
            amendments: [],
            agreement_type: null,
            agreement_number: undefined,
            attached_agreement: undefined,
            start: undefined,
            end: undefined,
            signed_by_unicef_date: null,
            signed_by_partner_date: null,
            status: undefined,
            partner: null,
            country_programme: undefined,
            signed_by: null,
            partner_manager: null,
            permissions: {
              edit: {
                agreement_type: true,
                amendments: false,
                attached_agreement: true,
                authorized_officers: true,
                country_programme: true,
                end: true,
                partner: true,
                partner_manager: true,
                signed_by: true,
                signed_by_id: true,
                signed_by_partner_date: true,
                signed_by_unicef_date: true,
                start: true,
              },
              required: {
                agreement_type: true,
                partner: true,
                country_programme: true,
                partner_manager: false,
                signed_by: false,
                signed_by_partner_date: false,
                signed_by_unicef_date: false,
              }
            }
          }
        },
        csvDownloadUrl: {
          type: String
        },
        agreementDetailsActive: {
          type: Boolean
        },
        newAgreementActive: {
          type: Boolean
        },
        routeData: {
          type: Object
        },
        agreement: {
          type: Object,
          observer: '_agreementChanged'
        },
        serverErrors: {
          type: Array,
          value: []
        },
      },

      observers: [
        '_pageChanged(agreementListActive, newAgreementActive, agreementDetailsActive)',
        '_observeRouteDataId(routeData.id)'
      ],

      listeners: {
        'agreement-save-error': '_agreementSaveErrors',
        'reload-list': '_reloadAgreementsList',
        'agreements-page-attached': '_handlePageTabAttached'
      },
      ready: function() {
        if (this.newAgreementActive) {
          // Useful when refreshing the page
          this.set('agreement', JSON.parse(JSON.stringify(this.newAgreementModel)));
        }
      },

      attached: function() {
        // deactivate main page loading msg triggered in app-shell
        this.fire('global-loading', {active: false, loadingSource: 'main-page'});
        /**
         * Loading msg used on stamping tabs elements (disabled in each tab main element attached callback)
         */
        this.fire('global-loading', {
          message: 'Loading ' + (this.agreementListActive ? 'agreements list' : 'agreement details page') +
            ' elements...',
          active: true,
          loadingSource: 'ag-page'
        });
      },

      _showNewAgreementAddButton: function(agreementListActive, permissions) {
        if (!agreementListActive || !permissions || !permissions.partnershipManager) {
          return false;
        }
        return true;
      },
      // get active page name
      _setActivePage: function(listActive, newAgreementActive, detailsActive) {
        let page = 'list'; // default
        let pagePrefix = 'agreements-';
        let pageBaseUrl = '../app-elements/agreements/';

        if (detailsActive || newAgreementActive) {
          page = 'details';
          pagePrefix = 'agreement-';
        }
        if (page) {
          let self = this;
          self._importPageElement(page, pagePrefix, pageBaseUrl).then(function() {
            self.set('agreementPage', page);
          })
          .catch(function(err) {
            self.logError('Agreement page import error occurred', '[agreement(s) ' + page + ']', err);
            self.fire('global-loading', {active: false, loadingSource: 'ag-page'});
            self._triggerPageNotFound();
          });
        }
      },

      _pageChanged: function(listActive, newAgreementActive, detailsActive) {
        this._setActivePage(listActive, newAgreementActive, detailsActive);
      },

      // compute agreement details page title including partner name and agreement number
      _getAgreementDetailsTitle: function(agreement) {
        return agreement.partner_name + ': ' + agreement.agreement_number;
      },

      _hasEditPermissions: function(permissions) {
        if (permissions && permissions.editAgreementDetails === true) {
          return true;
        }
        return false;
      },

      _saveAgreement: function(agreementData) {
        // var agreementData = event.detail;
        if (!agreementData.id) {
          agreementData.status = 'draft';
        }
        this.$.agreementData.saveAgreement(agreementData, this._newAgreementSaved);
      },

      _updateAgreementStatus: function(event) {
        event.stopImmediatePropagation();
        this.$.agreementData.updateAgreementStatus(event.detail);
      },

      /**
       * Go to details page once the new agreement has been saved
       */
      _newAgreementSaved: function(agreement) {
        this.fire('update-main-path', {path: 'agreements/' + agreement.id + '/details'});
      },
      _agreementSaveErrors: function(event) {
        event.stopImmediatePropagation();
        if ((event.detail instanceof Array && event.detail.length > 0) ||
            (typeof event.detail === 'string' && event.detail !== '')) {
          this.set('serverErrors', event.detail);
          this._setContentScrollPosition(0);
        }
      },

      /**
       * Go to new agreement page, it's just tha same details page with an empty agreement
       * The new agreement model is defined in this element
       */
      _goToNewAgreementPage: function() {
        // go to new agreement
        this.set('agreement', JSON.parse(JSON.stringify(this.newAgreementModel)));
        this.set('selectedAgreementId', 0);
        this.fire('update-main-path', {path: 'agreements/new-agreement'});
      },
      _observeRouteDataId: function(id) {
        this.set('selectedAgreementId', id);
      },

      // TODO: this method could be common in all page categories, refactor!
      _reloadAgreementsList: function(e) {
        e.stopImmediatePropagation();
        try {
          var agreementsList = this.$$('#list');
          if (agreementsList && !agreementsList.classList.contains('hidden')) {
            agreementsList._filterAgreementsData(true);
          }
        } catch (err) {
          this.logWarn('List refresh error occurred', '[agreements-page]', err);
        }
      },

      _agreementChanged: function(agreement) {
        // keep a copy of the agreement before changes are made and use it later to save only the changes
        this.set('originalAgreementData', JSON.parse(JSON.stringify(agreement)));
        this.set('serverErrors', []);
        this._setContentScrollPosition(0);
      },

      /**
       * Save agreement if all fields are validated
       */
      _validateAndTriggerAgreementSave: function(event) {
        event.stopImmediatePropagation();
        if (!this._hasEditPermissions(this.permissions)) {
          return;
        }
        let agreementDetailsEl = this.$$('#agreementDetails');
        if (!agreementDetailsEl) {
          return;
        }
        if (!agreementDetailsEl._validateAgreement()) {
          this.fire('toast', {text: 'Please review invalid fields data!', showCloseBtn: true});
          return;
        }
        if (this.newAgreementActive) {
          this._saveAgreement(this._prepareNewAgreementDataForSave(this.agreement));
        } else {
          // check/get only changed content to be used as a body to the save request
          var changedAgreementProperties = this._getCurrentChanges();
          // we also need the id
          changedAgreementProperties.id = this.agreement.id;
          // fire update agreement
          this._saveAgreement(changedAgreementProperties);
        }
      },

      _prepareNewAgreementDataForSave: function(agreement) {
        var self = this;
        // we do not need all the agreement object data for the first save
        var newAgreement = {
          id: null,
          status: '',
          agreement_type: agreement.agreement_type,
          partner: agreement.partner,
          authorized_officers: this.authorizedOfficers
        };
        if (agreement.agreement_type === 'SSFA') {
          return newAgreement;
        }

        newAgreement = Object.assign(newAgreement, {
          signed_by_unicef_date: agreement.signed_by_unicef_date,
          signed_by_partner_date: agreement.signed_by_partner_date,
          signed_by: agreement.signed_by,
          partner_manager: agreement.partner_manager,
          attached_agreement: agreement.attached_agreement,
        });
        if (agreement.agreement_type === 'MOU') {
          newAgreement.start = agreement.start;
          newAgreement.end = agreement.end;
          delete newAgreement.authorized_officers;
        }
        if (agreement.agreement_type === 'PCA') {
          newAgreement.country_programme = agreement.country_programme;
        }
        return newAgreement;
      },

      /**
       * Get agreement changed properties
       */
      _getCurrentChanges: function() {
        var changes = {};
        if (!this.agreement || this.agreement.id !== this.originalAgreementData.id) {
          // prevent the possibility of checking 2 different agreements
          return {};
        }

        if (this._primitiveFieldIsModified('partner')) {
          changes.partner = this.agreement.partner;
        }
        if (this.agreement.agreement_type !== 'MOU') {
          if (this._authorizedOfficersChanged()) {
            changes.authorized_officers = this.authorizedOfficers;
          }
        }
        if (this.agreement.agreement_type !== 'SSFA') {
          if ((this.agreement.hasOwnProperty('attached_agreement')) &&
              (this.agreement.attached_agreement instanceof File)) {
            changes.attached_agreement = this.agreement.attached_agreement;
          }

          var signedByFields = ['partner_manager', 'signed_by', 'signed_by_partner_date', 'signed_by_unicef_date'];
          signedByFields.forEach(function(fieldName) {
            if (this._primitiveFieldIsModified(fieldName)) {
              changes[fieldName] = this.agreement[fieldName];
            }
          }.bind(this));
        }

        if (this.agreement.agreement_type === 'MOU') {
          ['start', 'end'].forEach(function(fieldName) {
            if (this._primitiveFieldIsModified(fieldName)) {
              changes[fieldName] = this.agreement[fieldName];
            }
          }.bind(this));
        }

        if (this.agreement.agreement_type === 'PCA') {
          if (this._primitiveFieldIsModified('country_programme')) {
            changes.country_programme = this.agreement.country_programme;
          }
          if (this._objectFieldIsModified('amendments')) {
            changes.amendments = this.agreement.amendments;
          }
        }
        return changes;
      },

      _primitiveFieldIsModified: function(fieldName) {
        return this.originalAgreementData[fieldName] !== this.agreement[fieldName];
      },

      _authorizedOfficersChanged: function() {
        var initialAuthOfficers = this._getInitialAuthorizedOfficersIds();
        return JSON.stringify(initialAuthOfficers) !== JSON.stringify(this.authorizedOfficers);
      },

      _objectFieldIsModified: function(fieldName) {
        // jscs:disable maximumLineLength
        return JSON.stringify(this.originalAgreementData[fieldName]) !== JSON.stringify(this.agreement[fieldName]);
        // jscs:enable maximumLineLength
      },

      _getInitialAuthorizedOfficersIds: function() {
        if (!this.originalAgreementData.authorized_officers) {
          return null;
        }
        return this.originalAgreementData.authorized_officers.map(function(off) {
              return off.id.toString();
            }
        );
      },

      _handleTabSelectAction: function(e) {
        this._showTabChangeLoadingMsg(e, 'ag-page', 'agreement-');
      }

    });

  </script>

</dom-module>
