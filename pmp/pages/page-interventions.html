<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import" href="../../bower_components/etools-behaviors/etools-logs-behavior.html">

<link rel="import" href="../app-elements/common-elements/etools-error-messages-box.html">
<link rel="import" href="../app-elements/interventions/behaviors/intervention-permissions-behavior.html">
<link rel="import" href="../app-elements/interventions/behaviors/save-intervention-behavior.html">
<link rel="import" href="behaviors/page-utils-behavior.html">
<link rel="import" href="../app-behaviors/scroll-control-behavior.html">

<link rel="import" href="../app-elements/interventions/intervention-data/intervention-item-data.html">
<link rel="import" href="../app-elements/agreements/agreement-data/agreement-item-data.html">

<link rel="import" href="../app-elements/interventions/intervention-status.html">
<link rel="import" href="../app-elements/interventions/reports/intervention-reports.html">
<link rel="import" href="../app-elements/interventions/progress/intervention-progress.html">

<link rel="import" href="../../styles/app-mixins.html">
<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">

<link rel="import" href="../../scripts/lodash/lodash.html">

<dom-module id="page-interventions">

  <template strip-whitespace>

    <style include="page-layout-styles shared-styles buttons-styles">
      :host {
        display: block;
      }

      .no-capitalization {
        text-transform: none;
      }
    </style>

    <app-route
        route="{{route}}"
        pattern="interventions/list"
        query-params="{{listPageQueryParams}}"
        active="{{intervListActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="interventions/:intId/:intTab"
        active="{{intervDetailsActive}}"
        data="{{routeData}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="interventions/new/:intTab"
        active="{{newInterventionActive}}"
        data="{{routeDataNewInterv}}"></app-route>

    <div class$="page-top-content [[_getTopContentAdditionalClass(interventionPage)]]">
      <div class="top-content">
        <div class="top-content-row title-row">
          <h1 main-title>
            <template is="dom-if" if="[[intervListActive]]">
              PD/SSFAs
            </template>
            <template is="dom-if" if="[[newInterventionActive]]">
              <span class="no-capitalization">Add Programme Document or SSFA</span>
            </template>
            <template is="dom-if" if="[[intervDetailsActive]]">
              [[_getInterventionDetailsTitle(intervention)]]
            </template>
          </h1>
          <div class="top-content-actions-wrapper">
            <div class="top-content-action" hidden$="[[!intervListActive]]">
              <a target="_blank" href$="[[csvDownloadUrl]]">
                <paper-button>
                  <iron-icon icon="file-download"></iron-icon>
                  Export
                </paper-button>
              </a>
            </div>
            <div class="top-content-action" hidden$="[[!_showAddNewIntervBtn(intervListActive, permissions)]]">
              <paper-button class="primary-btn with-prefix" on-tap="_goToNewInterventionPage">
                <iron-icon icon="add"></iron-icon>
                Add new PD/SSFA
              </paper-button>
            </div>
          </div>
        </div>
        <template is="dom-if" if="[[_showPageTabs(interventionPage)]]">
          <div class="top-content-row">
            <paper-tabs id="intTabs"
                        selected="{{activeTab}}"
                        attr-for-selected="name"
                        noink bottom-item
                        on-iron-select="_handleTabSelectAction">
              <template is="dom-if" if="[[!_newIntervention(newInterventionActive)]]">
                <paper-tab name="overview" link>
                  <span class="tab-content">Overview</span>
                </paper-tab>
              </template>

              <paper-tab name="details" link>
                <span class="tab-content">Details</span>
              </paper-tab>

              <paper-tab name="review-and-sign" link>
                <span class="tab-content">Review & Sign</span>
              </paper-tab>

              <paper-tab name="attachments" link>
                <span class="tab-content">Attachments</span>
              </paper-tab>

              <template is="dom-if" if="[[!_newIntervention(newInterventionActive)]]">
                <paper-tab name="reports" link>
                  <span class="tab-content">Reports</span>
                </paper-tab>

                <paper-tab name="progress" link>
                  <span class="tab-content">Progress</span>
                </paper-tab>
              </template>

            </paper-tabs>
          </div>
        </template>
      </div>
    </div>

    <div id="main">
      <div id="pageContent">

        <etools-error-messages-box id="errorsBox"
                                   title="[[errorMsgBox_Title]]"
                                   errors="{{serverErrors}}"></etools-error-messages-box>

        <iron-pages id="interventionsPages"
                    selected="{{interventionPage}}"
                    attr-for-selected="name"
                    role="main">

          <template is="dom-if" if="[[_pageEquals(interventionPage, 'list')]]">
            <interventions-list id="intList"
                                name="list"
                                active="[[intervListActive]]"
                                csv-download-url="{{csvDownloadUrl}}"
                                url-params="[[listQueryParams]]">
            </interventions-list>
          </template>

          <template is="dom-if" if="[[_vizibleTab(interventionPage, 'overview', newInterventionActive)]]">
            <intervention-overview name="overview"
                                   intervention="[[intervention]]"
                                   intervention-agreement="[[agreement]]">
            </intervention-overview>
          </template>

          <template is="dom-if" if="[[_pageEquals(interventionPage, 'details')]]">
            <intervention-details id="interventionDetails"
                                  name="details"
                                  intervention="{{intervention}}"
                                  new-intervention="[[_newIntervention(newInterventionActive)]]"
                                  on-update-intervention-status="_updateInterventionStatus"
                                  original-intervention="[[originalIntervention]]">
            </intervention-details>
          </template>

          <template is="dom-if" if="[[_pageEquals(interventionPage, 'review-and-sign')]]">
            <intervention-review-and-sign id="interventionReviewAndSign"
                                          name="review-and-sign"
                                          intervention="{{intervention}}"
                                          agreement="[[agreement]]">
            </intervention-review-and-sign>
          </template>

          <template is="dom-if" if="[[_pageEquals(interventionPage, 'attachments')]]">
            <intervention-attachments id="intervAttachments"
                                      name="attachments"
                                      active="[[_isAttachementsTabActive(activeTab)]]"
                                      intervention="[[intervention]]"
                                      file-model="[[_getAttachmentModel(intervention.id)]]"
                                      attachments="{{intervention.attachments}}"
                                      edit-mode="[[!_isAttachmentsTabReadonly(permissions, intervention, intervention.status)]]">
            </intervention-attachments>
          </template>

          <template is="dom-if" if="[[_vizibleTab(interventionPage, 'reports', newInterventionActive)]]">
            <intervention-reports id="interventionReports"
                                  name="reports"
                                  intervention-id="[[intervention.id]]"></intervention-reports>
          </template>

          <template is="dom-if" if="[[_vizibleTab(interventionPage, 'progress', newInterventionActive)]]">
            <intervention-progress name="progress"
                                   intervention-id="[[intervention.id]]"></intervention-progress>
          </template>

        </iron-pages>

        <intervention-item-data id="interventionData"
                                intervention="{{intervention}}"
                                intervention-id="[[selectedInterventionId]]"
                                original-intervention="[[originalIntervention]]"
                                error-event-name="intervention-save-error"></intervention-item-data>

        <agreement-item-data id="agreement"
                             agreement-id="[[intervention.agreement]]"
                             agreement="{{agreement}}"></agreement-item-data>

      </div> <!-- main page content end -->

      <!-- sidebar content start -->
      <template is="dom-if" if="[[_showInterventionSidebarStatus(intervListActive, _subPageOrTabAttached, interventionPage)]]">
        <div id="sidebar">
          <intervention-status status="[[intervention.status]]"
                               active="[[!intervListActive]]"
                               active-tab="[[routeData.intTab]]"
                               intervention-id$="[[intervention.id]]"
                               new-intervention="[[newInterventionActive]]"
                               intervention-agreement-status="[[agreement.status]]"
                               on-save-intervention="_validateAndSaveIntervention"
                               on-update-intervention-status="_updateInterventionStatus"
                               edit-mode="[[_hasEditPermissions(permissions, intervention)]]">
          </intervention-status>
        </div> <!-- sidebar content end -->
      </template>

    </div>

  </template>

  <script>

    Polymer({

      is: 'page-interventions',
      behaviors: [
        EtoolsLogsBehavior,
        etoolsBehaviors.DynamicDialogBehavior,
        EtoolsPmpApp.Behaviors.ScrollControl,
        EtoolsPmpApp.Behaviors.PageUtils,
        EtoolsPmpApp.Behaviors.InterventionPermissions,
        EtoolsPmpApp.Behaviors.SaveIntervention
      ],
      properties: {
        interventionPage: {
          type: String,
          notify: true
        },
        permissions: {
          type: Object
        },
        selectedInterventionId: {
          type: Number
        },
        intervention: {
          type: Object,
          notify: true
        },
        originalIntervention: {
          type: Object
        },
        agreement: {
          type: Object
        },
        csvDownloadUrl: {
          type: String
        },
        newInterventionModel: {
          type: Object,
          value: {
            id: null, // Required null, not undefined in order to trigger the observer
            agreement: undefined,
            document_type: undefined,
            country_programme: undefined,
            number: undefined,
            prc_review_document_file: undefined,
            title: undefined,
            status: '',
            start: null,
            end: null,
            submitted_to_prc: false,
            submission_date_prc: undefined,
            review_date_prc: undefined,
            submission_date: undefined,
            prc_review_document: undefined,
            signed_by_unicef_date: undefined,
            signed_by_partner_date: undefined,
            unicef_signatory: undefined,
            unicef_focal_points: [],
            partner_focal_points: [],
            partner_authorized_officer_signatory: undefined,
            offices: [],
            frs: [],
            frs_details: {
              frs: [],
              total_frs_amt: 0,
              earliest_start_date: null,
              latest_end_date: null
            },
            planned_visits: [],
            sections: [],
            planned_budget: {},
            result_links: [],
            amendments: [],
            attachments: [],
            distributions: []
          }
        },
        activeTab: {
          type: String,
          value: '',
          observer: '_activeTabChanged'
        },
        serverErrors: {
          type: Array,
          value: []
        },
        routeData: {
          type: Object
        },
        intervDetailsActive: {
          type: Boolean
        },
        newInterventionActive: Boolean,
        routeDataNewInterv: {
          type: Object
        },
        editMode: {
          type: Boolean
        },
        _redirectToNewIntervPageInProgress: Boolean,
        errorMsgBox_Title: {
          type: String,
          value: 'Errors Saving PD/SSFA'
        },
        saved: {
          type: Object,
          value: function() {
            return {
              interventionId: null,
              justSaved: false
            };
          }
        },
        _forceDetUiValidationOnAttach: Boolean,
        _forceReviewUiValidationOnAttach: Boolean,

      },
      observers: [
        /**
         * _updateUrlTab and _updateUrlTabNewInterv do the same thing but, we can not use a single observer for
         * both dependencies because all observer dependecies need to be defined for the observer to work
         */
        '_updateUrlTab(routeData.intTab)',
        '_updateUrlTabNewInterv(routeDataNewInterv.intTab)',
        '_pageChanged(intervListActive, intervDetailsActive, newInterventionActive, activeTab)',
        '_observeRouteDataId(routeData.intId)',
        '_interventionChanged(intervention, permissions)'
      ],

      listeners: {
        'intervention-save-error': '_interventionSaveErrors',
        'reload-list': '_reloadInterventionsList',
        'intervention-page-attached': '_interventionPageAttached'
      },

      ready: function() {
        if (this.newInterventionActive) {
          this.set('intervention', JSON.parse(JSON.stringify(this.newInterventionModel)));
        }
        let dialog = document.createElement('div');
        dialog.setAttribute('id', 'finalizeAmendmentConfirmation');
        dialog.innerHTML = 'All fields in the details tab will now be closed for editing. Do you want to continue?';
        this.finalizeAmendmentConfirmationDialog = this.createDialog('Finalize Amendment', 'md', 'Yes', 'Cancel',
            this._finalizeAmendmentConfirmationCallback.bind(this), dialog);
      },

      attached: function() {
        // deactivate main page loading msg triggered in app-shell
        this.fire('global-loading', {active: false, loadingSource: 'main-page'});
        /**
         * Loading msg used stamping tabs elements (disabled in each tab main element attached callback)
         */
        this.fire('global-loading', {
          message: 'Loading ' + (this.intervListActive ? 'PD/SSFA list' :
              (this._removeStrDash(this.activeTab) + ' page')) + ' elements...',
          active: true,
          loadingSource: 'interv-page'
        });
      },

      detached: function() {
        if (this.finalizeAmendmentConfirmationDialog) {
          this.removeDialog(this.finalizeAmendmentConfirmationDialog);
        }
      },

      _showFinalizeAmendmentDialog: function() {
        if (this.finalizeAmendmentConfirmationDialog) {
          this.finalizeAmendmentConfirmationDialog.opened = true;
        }
      },

      _interventionChanged: function(intervention, permissions) {
        this._displayAnyMigrationErrors(intervention);
        this._makeSureMigrationErrorIsNotShownAgainAfterSave(intervention);

        this.set('originalIntervention', JSON.parse(JSON.stringify(intervention)));
        if (intervention && typeof intervention === 'object' && Object.keys(intervention).length > 0) {
          // set edit permissions
          let isNewIntervention = this._redirectToNewIntervPageInProgress ||
              this._newIntervention(this.newInterventionActive);
          this.checkAndUpdateInterventionPermissions(intervention,
              this._hasEditPermissions(permissions), isNewIntervention);
          this.async(function() {
            // ensure intervention get/save/change status loading msgs close
            this.fire('global-loading', {active: false, loadingSource: 'pd-ssfa-data'});
            this._setContentScrollPosition(0);
          }.bind(this), 1000);
        }
      },
      _displayAnyMigrationErrors: function(intervention) {
        if (intervention.metadata && intervention.metadata.error_msg && intervention.metadata.error_msg.length) {
          if (this.saved.interventionId !== intervention.id && !this.saved.justSaved) {
            //Avoid showing msg again after save
            this.set('errorMsgBox_Title',
                'eTools validation code has been upgraded and this record is now considered invalid due to:');
            this.set('serverErrors', intervention.metadata.error_msg);
            this._setContentScrollPosition(0);
          }
        }
      },
      /* Show metadata error message on intervention detail 'page load'*/
      _makeSureMigrationErrorIsNotShownAgainAfterSave: function(intervention) {
        if (this.saved.interventionId !== intervention.id) {
          this.saved.justSaved = false;
        }
        this.saved.interventionId = intervention.id;
      },
      _isAttachmentsTabReadonly: function(permissions, intervention) {
        if (!this._hasEditPermissions(permissions, intervention)) {
          return true;
        }
        if (['suspended', 'terminated'].indexOf(intervention.status) > -1) {
          return true;
        }
        return false;
      },
      _activeTabChanged: function(activeTab) {
        if (activeTab) {
          if (this.newInterventionActive) {
            this.set('routeDataNewInterv.intTab', activeTab);
          } else {
            this.set('routeData.intTab', activeTab);
          }
        }
      },

      _updateUrlTab: function(tab) {
        if (!tab) {
          return;
        }
        this._updateUrl();
      },

      _updateUrlTabNewInterv: function(newIntervTab) {
        if (!newIntervTab) {
          return;
        }
        this._updateUrl();
      },

      _updateUrl: function() {
        if (!this.activeTab) {
          this.set('activeTab', this.newInterventionActive ? this.routeDataNewInterv.intTab : this.routeData.intTab);
        }
        this.debounce('debounce-url-tab-update', function() {
          let tabs = this.$$('#intTabs');
          if (tabs) {
            tabs.notifyResize();
          }
          this.fire('update-main-path', {path: this.route.path});
        }.bind(this), 50);
      },

      _setActivePage: function(intervListActive, intervDetailsActive, newInterventionActive) {
        let page = 'list';
        let pagePrefix = 'interventions-';
        let pageBaseUrl = '../app-elements/interventions/';
        if (intervListActive === false) {
          if (newInterventionActive) {
            // return new intervention page tab name
            page = this.routeDataNewInterv.intTab;
          } else {
            // return intervention page tab name
            page = this.routeData.intTab;
            if (['reports', 'progress'].indexOf(page) > -1) {
              pageBaseUrl += page + '/';
            }
          }
          pagePrefix = 'intervention-';
        }
        if (page) {
          let self = this;
          self._importPageElement(page, pagePrefix, pageBaseUrl).then(function() {
            if (page === 'list') {
              self.set('serverErrors', []);
              self.set('activeTab', 'details');
            }
            if (page === 'details') {
              self.set('activeTab', 'details');
            }
            self.set('interventionPage', page);
            if (self._redirectToNewIntervPageInProgress) {
              self.set('_redirectToNewIntervPageInProgress', false);
            }
          })
          .catch(function(err) {
            self.logError('Intervention page import error occurred', '[intervention(s) ' + page + ']', err);
            self.fire('global-loading', {active: false, loadingSource: 'interv-page'});
            self._triggerPageNotFound();
          });
        }
      },

      _pageChanged: function(intervListActive, intervDetailsActive, newInterventionActive) {
        this.debounce('pageChange', function() {
          this._setActivePage(intervListActive, intervDetailsActive, newInterventionActive);
        }.bind(this), 10);
      },

      _observeRouteDataId: function(id) {
        this.async(function() {
          id = parseInt(id, 10);
          if (isNaN(id)) {
            id = null;
          }
          this.set('selectedInterventionId', id);
        }.bind(this));
      },
      _finalizeAmendmentConfirmationCallback: function() {
        if (event.detail.confirmed) {
          this._validateAndSaveIntervention(null);
        }
      },
      _isNewIntervention: function() {
        return !!!this.intervention.id;
      },

      _updateInterventionStatus: function(event) {
        event.stopImmediatePropagation();
        this.$.interventionData.updateInterventionStatus(event.detail);
      },
      _hasEditPermissions: function(permissions, intervention) {
        if (permissions && permissions.editInterventionDetails === true) {
          if (intervention) {
            if (!(permissions.partnershipManager || permissions.PME) &&
                (!intervention.status || intervention.status !== 'draft')) {
              // other users than partnershipManager or PME will be able to edit only if intervention status is draft
              return false;
            }
          }
          return true;
        }
        return false;
      },

      _getAttachmentModel: function(interventionId) {
        return {
          id: null,
          created: null,
          intervention: interventionId ? interventionId : null,
          type: null
        };
      },

      _goToNewInterventionPage: function(event) {
        // go to new intervention
        if (!this._hasEditPermissions(this.permissions)) {
          return;
        }
        this.set('_redirectToNewIntervPageInProgress', true);
        this.set('intervention', JSON.parse(JSON.stringify(this.newInterventionModel)));
        this.set('selectedInterventionId', null);
        this.fire('update-main-path', {path: 'interventions/new/details'});
      },

      _newIntervention: function(newInterventionActive) {
        return newInterventionActive === true;
      },

      _vizibleTab: function(interventionPage, expectedPage, newInterventionActive) {
        return this._pageEquals(interventionPage, expectedPage) && !this._newIntervention(newInterventionActive);
      },

      /**
       * Go to details page once the new intervention has been saved
       */
      _newInterventionSaved: function(intervention) {
        this.fire('update-main-path', {path: 'interventions/' + intervention.id + '/details'});
      },

      /**
       * Get intervention details page title: 'partner name: intervention number'
       */
      _getInterventionDetailsTitle: function(intervention) {
        var title = '';
        if (intervention) {
          if (intervention.partner) {
            title += intervention.partner + ': ';
          }
          if (intervention.number) {
            title += intervention.number;
          }
        }
        return title;
      },

      _showAddNewIntervBtn: function(intervListActive, permissions) {
        if (intervListActive && this._hasEditPermissions(permissions)) {
          return true;
        }
        return false;
      },

      _interventionSaveErrors: function(event) {
        event.stopImmediatePropagation();
        if ((event.detail instanceof Array && event.detail.length > 0) ||
            (typeof event.detail === 'string' && event.detail !== '')) {
          this.set('serverErrors', event.detail);
          this._setContentScrollPosition(0);
        }
      },

      _isAttachementsTabActive: function(activeTab) {
        return activeTab === 'attachments';
      },

      _reloadInterventionsList: function(e) {
        e.stopImmediatePropagation();
        try {
          let interventions = this.$$('#intList');
          if (interventions && !interventions.$.list.classList.contains('hidden')) {
            interventions._filterInterventionsData(true);
          }
        } catch (err) {
          this.logWarn('List refresh error occurred', '[interventions-page]', err);
        }
      },

      _handleTabSelectAction: function(e) {
        this._showTabChangeLoadingMsg(e, 'interv-page', 'intervention-');
      },

      _interventionPageAttached: function(e) {
        this._handlePageTabAttached(e);
        // force styles updates according with intervention permissions
        // (event handled is triggered by interventions tab elements)
        this._updateRelatedPermStyles(false, this._forceDetUiValidationOnAttach, this._forceReviewUiValidationOnAttach);
      },

      _showInterventionSidebarStatus: function(intervListActive, _subPageOrTabAttached, interventionPage) {
        return (['reports', 'progress'].indexOf(interventionPage) > -1)
            ? false
            : this._showSidebarStatus(intervListActive, _subPageOrTabAttached);

      }
    });

  </script>

</dom-module>
