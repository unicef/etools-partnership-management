<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../app-elements/interventions/intervention-data/intervention-item-data.html">
<link rel="import" href="../app-elements/partners/partners-data/partner-item-data.html">
<link rel="import" href="../app-elements/agreements/agreement-data/agreement-item-data.html">

<link rel="import" href="../app-elements/interventions/interventions-list.html">
<link rel="import" href="../app-elements/interventions/intervention-details.html">
<link rel="import" href="../app-elements/interventions/intervention-overview.html">
<link rel="import" href="../app-elements/interventions/intervention-review-and-sign.html">
<link rel="import" href="../app-elements/interventions/intervention-attachments.html">
<link rel="import" href="../app-elements/interventions/intervention-status.html">

<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">

<dom-module id="page-interventions">

  <template>

    <style include="page-layout-styles shared-styles buttons-styles">

      :host {
        display: block;
      }

      .list-page {
        max-width: 920px;
        margin: 20px auto;
      }

    </style>

    <app-route
        route="{{route}}"
        pattern="interventions/list"
        query-params="{{interventionsQueryParams}}"
        active="{{listActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="interventions/:intId/:intTab"
        active="{{tabsActive}}"
        data="{{routeData}}"></app-route>

    <intervention-item-data id="interventionData"
                         intervention="{{intervention}}"
                         intervention-id="[[selectedInterventionId]]"></intervention-item-data>

    <partner-item-data id="partner"
                       partner-id="[[partnerId]]"
                       partner="{{partner}}"></partner-item-data>

    <agreement-item-data id="agreement"
                         agreement-id="[[intervention.agreement]]"
                         agreement="{{agreement}}"></agreement-item-data>

    <app-header-layout>
      <div class$="page-top-content [[_getTopContentAdditionalClass(interventionPage)]]">
        <div class="top-content">
          <div class="top-content-row title-row">
            <h1 main-title>
              PD/SSFA ToRs
            </h1>
            <div class="top-content-actions-wrapper">
              <div class="top-content-action"  hidden$="[[!listActive]]">
                <a target="_blank" href$="/api/v2/interventions/?[[csvQueryString]]">
                  <paper-button>
                    <iron-icon icon="file-download"></iron-icon>
                    Export
                  </paper-button>
                </a>  
              </div>
              <!-- Print functionality pending implementation -->
              <!--<div class="top-content-action"  hidden$="[[!listActive]]">
                <paper-button>
                  <iron-icon icon="print"></iron-icon>
                  Print
                </paper-button>
              </div>-->
              <div class="top-content-action"  hidden$="[[!listActive]]">
                <paper-button class="primary-btn with-prefix">
                  <iron-icon icon="add"></iron-icon>
                  Add new PD/SSFA ToR
                </paper-button>
              </div>
            </div>
          </div>
          <div class="top-content-row" hidden$="[[!_showPageTabs(interventionPage)]]">
            <paper-tabs
                selected="{{routeData.intTab}}"
                attr-for-selected="name"
                noink bottom-item>

              <paper-tab name="overview" link>
                <span class="tab-content">Overview</span>
              </paper-tab>

              <paper-tab name="details" link>
                <span class="tab-content">Details</span>
              </paper-tab>

              <paper-tab name="review-and-sign" link>
                <span class="tab-content">Review & Sign</span>
              </paper-tab>

              <paper-tab name="attachments" link>
                <span class="tab-content">Attachments</span>
              </paper-tab>

            </paper-tabs>
          </div>
        </div>
      </div>

      <div id="main">
        <div id="pageContent">
          <iron-pages id="interventionsPages"
                      selected="{{interventionPage}}"
                      attr-for-selected="name"
                      fallback-selection="list"
                      role="main">

            <div class="page" name="list">
              <interventions-list
                  active="[[listActive]]"
                  csv-query-string="{{csvQueryString}}"
                  url-params="[[interventionsQueryParams]]"></interventions-list>
            </div>
              <div class="page" name="overview">
          <intervention-overview intervention="[[intervention]]"></intervention-overview>
        </div>
            <div class="page" name="details">
              <intervention-details id="interventionDetails"
                                    intervention="{{intervention}}"
                                    partner="[[partner]]"
                                    edit-mode="[[_hasEditPermissions(permissions)]]"
                                    selected-partner-id="{{partnerId}}"
                                    on-update-intervention-status="_updateInterventionStatus"
                                    on-save-intervention="_saveIntervention"></intervention-details>
            </div>
            <div class="page" name="review-and-sign">
              <intervention-review-and-sign id="interventionReviewAndSign"
                                            intervention="{{intervention}}"
                                            agreement="[[agreement]]"
                                            edit-mode="[[_hasEditPermissions(permissions)]]"></intervention-review-and-sign>
            </div>
            <div class="page" name="attachments">
              <intervention-attachments id="intervAttachments"
                edit-mode="[[_hasEditPermissions(permissions)]]"
                file-model="[[_getAttachmentModel(intervention.id)]]"
                attachments={{intervention.attachments}}
                on-delete-file="_deleteAttachment"></intervention-attachments>
            </div>
          </iron-pages>
        </div> <!-- main page content end -->

        <!-- sidebar content start -->
        <div id="sidebar" hidden$="[[listActive]]">
           <intervention-status status="[[intervention.status]]"
                                intervention-id$="[[intervention.id]]"
                                on-save-intervention="_validateAndSaveIntervention"
                                on-update-intervention-status="_updateInterventionStatus"
                                show-save-btn$="[[editMode]]"></intervention-status>

        </div>
        <!-- sidebar content end -->
      </div>
    </app-header-layout>

  </template>

  <script>

    Polymer({

      is: 'page-interventions',

      properties: {
        interventionPage: {
          type: String,
          notify: true
        },
        permissions: {
          type: Object
        },
        selectedInterventionId: {
          type: Number
        },
        intervention: {
          type: Object
        },
        partner: {
          type: Object
        },
        partnerId: {
          type: Number
        },
        agreement: {
          type: Object
        },
        csvQueryString: {
          type: String
        },
      },

      observers: [
        '_resizeHeader(listActive, tabsActive)',
        '_updateUrlTab(routeData.intTab)',
        '_pageChanged(listActive, routeData.intTab)',
        '_observeRouteDataId(routeData.intId)'
      ],

      _resizeHeader: function() {
        this.$$('app-header-layout').notifyResize();
      },

      _updateUrlTab: function(tab) {
        if (!tab) {
          return;
        }
        this.debounce('debounce-url-tab-update', function() {
          this.fire('update-main-path', {path: this.route.path}, {bubbles: false});
        }.bind(this), 50);
      },

      _getActivePage: function(listActive, intTab) {
        if (listActive) {
          return 'list';
        } else {
          return intTab;
        }
      },

      _pageChanged: function(listActive, intTab) {
        var activePage = this._getActivePage(listActive, intTab);
        this.set('interventionPage', activePage);
      },

      _showPageTabs: function(interventionPage) {
        return interventionPage !== 'list';
      },

      _getTopContentAdditionalClass: function(interventionPage) {
        if (this._showPageTabs(interventionPage)) {
          return 'with-tabs';
        }
        return '';
      },

      _observeRouteDataId: function(id) {
        this.set('selectedInterventionId', id);
        // reset attachment prepare flag to ensure new intervention attachments will  be prepared after load
        this.$.intervAttachments.set('preparedAttachments', false);
      },

      _validateAndSaveIntervention: function(event) {
        event.stopImmediatePropagation();

        if (!this._hasEditPermissions(this.permissions)) {
          return;
        }

        var interventionDetails = this.$.interventionDetails;
        var validInterventionDetails = interventionDetails.validate();

        if (validInterventionDetails) {
          var interventionData = Object.assign({}, this.intervention);

          // on save sector_locations sector prop needs to be sector ID and not the sector obj
          interventionData.sector_locations = interventionDetails.prepareSectorLocations();
          // prepare fr numbers
          if (Array.isArray(interventionData.fr_numbers) && interventionData.fr_numbers.length > 0) {
            interventionData.fr_numbers = interventionData.fr_numbers.map(function(frNumber) {
              return frNumber.value;
            });
          }
          // prepare attachments
          if (Array.isArray(interventionData.attachments) && interventionData.attachments.length > 0) {
            interventionData.attachments = interventionData.attachments.map(function(attachment) {
              
              var _sendAttachmentFile = (attachment.raw instanceof File) ? true :  false;
              if (!_sendAttachmentFile && attachment.id) {
                return {
                  id: attachment.id
                };
              } else {
                return {
                  id: attachment.id,
                  intervention: attachment.intervention,
                  type: attachment.type,
                  attachment: attachment.raw
                };
              }
            });
          }
          // if prc_review_document is null we need to delete the property otherwise the 
          // file gets deleted from the backend
          if (interventionData.hasOwnProperty('prc_review_document') && !interventionData.prc_review_document) {
            delete interventionData.prc_review_document;
          }

          console.log('intervention data to be saved', interventionData);
          this.$.interventionData.saveIntervention(interventionData);
        } else {
          var msg = 'Please review invalid fields data!';
          if (this.interventionPage !== 'details') {
            msg = 'Please review invalid fields data from details tab!';
          }
          this.fire('toast', {text: msg, showCloseBtn: true});
        }
      },

      _updateInterventionStatus: function(event) {
        event.stopImmediatePropagation();
        this.$.interventionData.updateInterventionStatus(event.detail);
      },

      _hasEditPermissions: function(permissions) {
        if (typeof permissions === 'object' && permissions.editInterventionDetails === true) {
          return true;
        }
        return false;
      },

      _getAttachmentModel: function(interventionId) {
        return {
          id: null,
          intervention: interventionId ? interventionId : null,
          type: null 
        };
      },

      _deleteAttachment: function(event) {
        // TODO:  remove console.log ater attachment delete is implemented
        console.log('attachment to delete: ', event.detail);
        this.fire('toast', {text: 'Delete file not implemented yet! '
          + 'event.detail has all the date needed for delete action.', showCloseBtn: true});
      }

    });

  </script>

</dom-module>
