<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../app-elements/common-elements/etools-error-messages-box.html">

<link rel="import" href="../app-elements/interventions/intervention-data/intervention-item-data.html">
<link rel="import" href="../app-elements/agreements/agreement-data/agreement-item-data.html">
<link rel="import" href="../app-elements/partners/partners-data/partner-staff-members-data.html">

<link rel="import" href="../app-elements/interventions/interventions-list.html">
<link rel="import" href="../app-elements/interventions/intervention-details.html">
<link rel="import" href="../app-elements/interventions/intervention-overview.html">
<link rel="import" href="../app-elements/interventions/intervention-review-and-sign.html">
<link rel="import" href="../app-elements/interventions/intervention-attachments.html">
<link rel="import" href="../app-elements/interventions/intervention-status.html">

<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">
<link rel="import" href="../../scripts/lodash/lodash.html">

<dom-module id="page-interventions">

  <template strip-whitespace>

    <style include="page-layout-styles shared-styles buttons-styles">
      :host {
        display: block;
      }
    </style>

    <app-route
        route="{{route}}"
        pattern="interventions/list"
        query-params="{{interventionsQueryParams}}"
        active="{{intervListActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="interventions/:intId/:intTab"
        active="{{intervDetailsActive}}"
        data="{{routeData}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="interventions/new/:intTab"
        active="{{newInterventionActive}}"
        data="{{routeDataNewInterv}}"></app-route>

    <intervention-item-data id="interventionData"
                            intervention="{{intervention}}"
                            intervention-id="[[selectedInterventionId]]"
                            error-event-name="intervention-save-error"></intervention-item-data>

    <partner-staff-members-data partner-id="[[partnerId]]"
                                prepared-staff-members-data="{{partnerStaffMembers}}">
    </partner-staff-members-data>

    <agreement-item-data id="agreement"
                         agreement-id="[[intervention.agreement]]"
                         agreement="{{agreement}}"></agreement-item-data>

    <div class$="page-top-content [[_getTopContentAdditionalClass(interventionPage)]]">
      <div class="top-content">
        <div class="top-content-row title-row">
          <h1 main-title>
            <template is="dom-if" if="[[intervListActive]]">
              PD/SSFA ToRs
            </template>
            <template is="dom-if" if="[[newInterventionActive]]">
              Add Programme Document or PD/SSFA ToRs
            </template>
            <template is="dom-if" if="[[intervDetailsActive]]">
              [[_getInterventionDetailsTitle(intervention)]]
            </template>
          </h1>
          <div class="top-content-actions-wrapper">
            <div class="top-content-action" hidden$="[[!intervListActive]]">
              <a target="_blank" href$="[[csvDownloadUrl]]">
                <paper-button>
                  <iron-icon icon="file-download"></iron-icon>
                  Export
                </paper-button>
              </a>
            </div>
            <!-- Print functionality pending implementation -->
            <!--<div class="top-content-action"  hidden$="[[!intervListActive]]">
              <paper-button>
                <iron-icon icon="print"></iron-icon>
                Print
              </paper-button>
            </div>-->
            <div class="top-content-action" hidden$="[[!_showAddNewIntervBtn(intervListActive, permissions)]]">
              <paper-button class="primary-btn with-prefix" on-tap="_goToNewInterventionPage">
                <iron-icon icon="add"></iron-icon>
                Add new PD/SSFA ToR
              </paper-button>
            </div>
          </div>
        </div>
        <div class="top-content-row" hidden$="[[!_showPageTabs(interventionPage)]]">
          <paper-tabs
              selected="{{activeTab}}"
              attr-for-selected="name"
              noink bottom-item>
            <template is="dom-if" if="[[!_newIntervention(newInterventionActive)]]">
              <paper-tab name="overview" link>
                <span class="tab-content">Overview</span>
              </paper-tab>
            </template>

            <paper-tab name="details" link>
              <span class="tab-content">Details</span>
            </paper-tab>

            <paper-tab name="review-and-sign" link>
              <span class="tab-content">Review & Sign</span>
            </paper-tab>

            <paper-tab name="attachments" link>
              <span class="tab-content">Attachments</span>
            </paper-tab>

          </paper-tabs>
        </div>
      </div>
    </div>

    <div id="main">
      <div id="pageContent">

        <etools-error-messages-box id="errorsBox"
                                   title="Errors Saving PD/SSFA ToR"
                                   errors="{{serverErrors}}"></etools-error-messages-box>

        <iron-pages id="interventionsPages"
                    selected="{{interventionPage}}"
                    attr-for-selected="name"
                    fallback-selection="list"
                    role="main">

          <div class="page" name="list">
            <interventions-list
                active="[[intervListActive]]"
                csv-download-url="{{csvDownloadUrl}}"
                url-params="[[interventionsQueryParams]]">
            </interventions-list>
          </div>

          <template is="dom-if" if="[[!_newIntervention(newInterventionActive)]]">
            <div class="page" name="overview">
              <intervention-overview intervention="[[intervention]]"
                                     intervention-agreement="[[agreement]]">
              </intervention-overview>
            </div>
          </template>

          <div class="page" name="details">
            <intervention-details id="interventionDetails"
                                  permissions="[[permissions]]"
                                  intervention="{{intervention}}"
                                  partner-staff-members="[[partnerStaffMembers]]"
                                  selected-partner-id="{{partnerId}}"
                                  new-intervention="[[_newIntervention(newInterventionActive)]]"
                                  edit-mode="[[_hasEditPermissions(permissions, intervention)]]"
                                  on-update-intervention-status="_updateInterventionStatus">
            </intervention-details>
          </div>
          <div class="page" name="review-and-sign">
            <intervention-review-and-sign id="interventionReviewAndSign"
                                          intervention="{{intervention}}"
                                          permissions="[[permissions]]"
                                          agreement="[[agreement]]"
                                          new-intervention="[[_newIntervention(newInterventionActive)]]"
                                          edit-mode="[[_hasEditPermissions(permissions, intervention)]]">
            </intervention-review-and-sign>
          </div>
          <div class="page" name="attachments">
            <intervention-attachments id="intervAttachments"
                                      active="[[_isAttachementsTabActive(activeTab)]]"
                                      edit-mode="[[_hasEditPermissions(permissions, intervention)]]"
                                      permissions="[[permissions]]"
                                      intervention="[[intervention]]"
                                      file-model="[[_getAttachmentModel(intervention.id)]]"
                                      attachments="{{intervention.attachments}}"
                                      new-intervention="[[_newIntervention(newInterventionActive)]]">
            </intervention-attachments>
          </div>
        </iron-pages>
      </div> <!-- main page content end -->

      <!-- sidebar content start -->
      <div id="sidebar" hidden$="[[intervListActive]]">
        <intervention-status status="[[intervention.status]]"
                             intervention-id$="[[intervention.id]]"
                             intervention-agreement-status="[[agreement.status]]"
                             on-save-intervention="_validateAndSaveIntervention"
                             on-update-intervention-status="_updateInterventionStatus"
                             show-save-btn$="[[_hasEditPermissions(permissions, intervention)]]"></intervention-status>

      </div>
      <!-- sidebar content end -->
    </div>

  </template>

  <script>

    Polymer({

      is: 'page-interventions',

      properties: {
        interventionPage: {
          type: String,
          notify: true
        },
        permissions: {
          type: Object
        },
        selectedInterventionId: {
          type: Number
        },
        intervention: {
          type: Object,
          notify: true,
          observer: '_interventionChanged'
        },
        originalIntervention: {
          type: Object,
          value: {}
        },
        partnerStaffMembers: Array,
        partnerId: {
          type: Number
        },
        agreement: {
          type: Object
        },
        csvDownloadUrl: {
          type: String
        },
        newInterventionModel: {
          type: Object,
          value: {
            id: undefined,
            agreement: undefined,
            document_type: undefined,
            hrp: undefined,
            number: undefined,
            prc_review_document_file: undefined,
            title: undefined,
            status: 'draft',
            start: undefined,
            end: undefined,
            submission_date_prc: undefined,
            review_date_prc: undefined,
            submission_date: undefined,
            prc_review_document: undefined,
            signed_by_unicef_date: undefined,
            signed_by_partner_date: undefined,
            unicef_signatory: undefined,
            unicef_focal_points: [],
            partner_focal_points: [],
            partner_authorized_officer_signatory: undefined,
            offices: [],
            fr_numbers: undefined,
            planned_visits: [],
            sector_locations: [],
            planned_budget: [],
            result_links: [],
            amendments: [],
            attachments: [],
            distributions: []
          }
        },
        activeTab: {
          type: String,
          observer: '_activeTabChanged'
        },
        serverErrors: {
          type: Array,
          value: []
        },
        routeData: {
          type: Object
        },
        intervDetailsActive: {
          type: Boolean
        },
        routeDataNewInterv: {
          type: Object
        },
        editMode: {
          type: Boolean
        },
      },

      observers: [
        /**
         * _updateUrlTab and _updateUrlTabNewInterv do the same thing but, we can not use a single observer for
         * both dependencies because all observer dependecies need to be defined for the observer to work
         */
        '_updateUrlTab(routeData.intTab)',
        '_updateUrlTabNewInterv(routeDataNewInterv.intTab)',
        '_pageChanged(intervListActive, intervDetailsActive, newInterventionActive, activeTab)',
        '_observeRouteDataId(routeData.intId)'
      ],

      listeners: {
        'intervention-save-error': '_interventionSaveErrors'
      },

      ready: function() {
        if (this.newInterventionActive) {
          this.set('intervention', JSON.parse(JSON.stringify(this.newInterventionModel)));
        }
      },
      // TODO: do not remove this, we might needed back
      // _detailsPageDisableUpgrade: function(intervDetailsActive, newInterventionActive) {
      //   return !intervDetailsActive && !newInterventionActive;
      // },
      _interventionChanged: function(intervention) {
        this.set('originalIntervention', JSON.parse(JSON.stringify(intervention)));
        if (intervention && typeof intervention === 'object' && Object.keys(intervention).length > 0) {
          this.async(function() {
            // ensure loading msg close
            this.fire('global-loading', {active: false});
          }.bind(this), 1000);
        }
      },
      _activeTabChanged: function(activeTab) {
        if (activeTab) {
          if (this.newInterventionActive) {
            this.set('routeDataNewInterv.intTab', activeTab);
          } else {
            this.set('routeData.intTab', activeTab);
          }
        }
      },

      _updateUrlTab: function(tab) {
        if (!tab) {
          return;
        }
        this._updateUrl();
      },

      _updateUrlTabNewInterv: function(newIntervTab) {
        if (!newIntervTab) {
          return;
        }
        this._updateUrl();
      },

      _updateUrl: function() {
        if (!this.activeTab) {
          this.set('activeTab', this.newInterventionActive ? this.routeDataNewInterv.intTab : this.routeData.intTab);
        }
        this.debounce('debounce-url-tab-update', function() {
          this.fire('update-main-path', {path: this.route.path});
        }.bind(this), 50);
      },

      _getActivePage: function(intervListActive, intervDetailsActive, newInterventionActive) {
        var page = 'list';
        if (intervListActive === false) {
          if (newInterventionActive) {
            // return new intervention page tab name
            page = this.routeDataNewInterv.intTab;
          } else {
            // return intervention details page tab name
            page = this.routeData.intTab;
          }
        }
        return page;
      },

      _pageChanged: function(intervListActive, intervDetailsActive, newInterventionActive) {
        this.debounce('pageChange', function() {
          var activePage = this._getActivePage(intervListActive, intervDetailsActive, newInterventionActive);
          if (activePage === 'list') {
            this.set('activeTab', 'details');
          }
          this.set('interventionPage', activePage);
        }.bind(this), 50);
      },

      _showPageTabs: function(interventionPage) {
        return interventionPage !== 'list';
      },

      _getTopContentAdditionalClass: function(interventionPage) {
        if (this._showPageTabs(interventionPage)) {
          return 'with-tabs';
        }
        return '';
      },

      _observeRouteDataId: function(id) {
        this.async(function() {
          id = parseInt(id, 10);
          if (isNaN(id)) {
            id = null;
          }
          this.set('selectedInterventionId', id);
          // reset attachment prepare flag to ensure new intervention attachments will  be prepared after load
          this.$.intervAttachments.set('preparedAttachments', false);
        }.bind(this));
      },

      _validateAndSaveIntervention: function(event) {
        event.stopImmediatePropagation();
        this.set('serverErrors', []);
        if (!this._hasEditPermissions(this.permissions, this.intervention)) {
          return;
        }

        var interventionDetails = this.$.interventionDetails;
        var interventionDetailsAreValid = interventionDetails.validate();

        var reviewAndSign = this.$.interventionReviewAndSign;
        var reviewAndSignIsValid = reviewAndSign.validate();

        if (!interventionDetailsAreValid || !reviewAndSignIsValid) {
          this._showErrorsWarning(interventionDetailsAreValid, reviewAndSignIsValid);
          return;
        }

        var interventionData;
        if (this._isNewIntervention()) {
          interventionData = Object.assign({}, this.intervention);
        } else {
          var modifiedDetails = this._getModifiedInterventionDetails();
          var modifiedReviewAndSign = this._getModifiedReviewAndSign();
          interventionData = Object.assign({id: this.intervention.id}, modifiedDetails, modifiedReviewAndSign);
        }

        // on save sector_locations sector prop needs to be sector ID and not the sector obj
        if (interventionData.sector_locations) {//if there were any modifications
          interventionData.sector_locations = interventionDetails.prepareSectorLocations();
        }

        // prepare fr numbers
        if (Array.isArray(this.intervention.fr_numbers) && this.intervention.fr_numbers.length > 0
          && this._objectFieldIsModified('fr_numbers')) {
          interventionData.fr_numbers = this.intervention.fr_numbers.map(function(frNumber) {
            return frNumber.value;
          });
        }
        // fr_numbers_details are readonly, we do not have to send them to backend
        delete interventionData.fr_numbers_details;

        // prepare attachments
        interventionData.attachments = this._prepareAttachments();
        if (_.isEmpty(interventionData.attachments)) {
          delete interventionData.attachments;
        }

        // if prc_review_document is null we need to delete the property otherwise the
        // file gets deleted from the backend
        if (this.intervention.hasOwnProperty('prc_review_document') && !this.intervention.prc_review_document) {
          delete interventionData.prc_review_document;
        }

        this.$.interventionData.saveIntervention(interventionData, this._newInterventionSaved);
      },
      _getModifiedReviewAndSign: function() {
        var updatableFields = ['submission_date', 'submission_date_prc', 'review_date_prc', 'prc_review_document',
          'prc_review_document_file', 'partner_authorized_officer_signatory', 'signed_by_partner_date',
          'unicef_signatory', 'signed_by_unicef_date'];
        var updatableObjectFields = ['amendments'];

        return this._buildModifiedInterventionObject(updatableFields, updatableObjectFields);
      },
      _getModifiedInterventionDetails: function() {
        var updatableFields = ['agreement', 'document_type', 'title', 'hrp',
          'start', 'end'];
        var updatableObjectFields = ['offices', 'unicef_focal_points', 'partner_focal_points',
          'sector_locations', 'planned_budget', 'planned_visits'];
        var modifiedDetails = this._buildModifiedInterventionObject(updatableFields, updatableObjectFields);
        var modifiedExpectedResults = this._buildModifiedExpectedResultsObject();

        return Object.assign({}, modifiedDetails, modifiedExpectedResults);
      },
      _buildModifiedExpectedResultsObject: function() {
        var modifExpectedResultsArray = this._getNewOrModifiedExpectedResults();

        if (!_.isEmpty(modifExpectedResultsArray)) {
          return {result_links: modifExpectedResultsArray};
        }
        return {};
      },
      _getNewOrModifiedExpectedResults: function() {
        if (_.isEmpty(this.intervention.result_links)) {
          return [];
        }
        var modifExpResults = this.intervention.result_links
          .filter(this._expectedResultIsNewOrModified.bind(this))
          .map(function(resultLink) {
            if (_.isEmpty(resultLink.ll_results)) {
              return resultLink;
            }

            resultLink.ll_results = this._getNewOrModifiedPSorSSFATOROutput(resultLink.ll_results,
              this._getOriginalResultLink(resultLink.id));
            return resultLink;
          }.bind(this));

        return modifExpResults;
      },
      _getOriginalResultLink: function(id) {
        return this.originalIntervention.result_links.find(function(r) {
          return r.id === id;
        });
      },
      _getOriginalLlResult: function(id, originalResultLink) {
        return originalResultLink.ll_results.find(function(r) {
          return r.id === id;
        });
      },
      _getNewOrModifiedPSorSSFATOROutput: function(llResults, originalResultLink) {
        if (!originalResultLink || _.isEmpty(originalResultLink.ll_results)) {
          return llResults;
        }
        var modifLlResults = llResults.filter(function(llResult) {
          if (!llResult.id) {
            return true;
          }
          var originalLlResult = originalResultLink.ll_results.find(function(r) {
            return r.id === llResult.id;
          });

          if (!originalLlResult) {
            return true;
          }
          return (JSON.stringify(originalLlResult) !== JSON.stringify(llResult));
        }).map(function(llResult) {
          if (_.isEmpty(llResult.applied_indicators)) {
            return llResult;
          }
          llResult.applied_indicators = this._getNewOrModifiedIndicators(llResult.applied_indicators,
            this._getOriginalLlResult(llResult.id, originalResultLink));
          return llResult;
        }.bind(this));
        return modifLlResults;
      },
      _getNewOrModifiedIndicators: function(indicators, originalLlResult) {
        if (!originalLlResult || _.isEmpty(originalLlResult.applied_indicators)) {
          return indicators;
        }
        var modifIndicators = indicators.filter(function(indicator) {
          if (!indicator.id) {
            return true;
          }
          var originalIndicator = originalLlResult.applied_indicators.find(function(r) {
            return r.id === indicator.id;
          });
          if (!originalIndicator) {
            return true;
          }
          return (JSON.stringify(originalIndicator) !== JSON.stringify(indicator));
        });

        return modifIndicators;
      },
      _expectedResultIsNewOrModified: function(resultLink) {
        if (_.isEmpty(this.originalIntervention.result_links)) {
          return true;
        }
        if (!resultLink.id) {
          return true;
        }
        var originalResultLink = this._getOriginalResultLink(resultLink.id);
        if (!originalResultLink) {
          return true;
        }

        return (JSON.stringify(originalResultLink) !== JSON.stringify(resultLink));
      },
      _buildModifiedInterventionObject: function(updatableFields, updatableObjectFields) {
        var modifiedObject = {};

        updatableFields.forEach(function(fieldName) {
          if (this._primitiveFieldIsModified(fieldName)) {
            modifiedObject[fieldName] = this.intervention[fieldName];
          }
        }.bind(this));

        updatableObjectFields.forEach(function(fieldName) {
          if (this._objectFieldIsModified(fieldName)) {
            modifiedObject[fieldName] = this.intervention[fieldName];
          }
        }.bind(this));

        return modifiedObject;
      },
      _objectFieldIsModified: function(fieldName) {
        // jscs:disable
        var isModified = JSON.stringify(this.originalIntervention[fieldName]) !== JSON.stringify(this.intervention[fieldName]);
        // jscs:enable
        var dropdownArrayFields = ['partner_focal_points', 'unicef_focal_points', 'offices'];
        if (isModified && dropdownArrayFields.indexOf(fieldName) > -1) {
          // Covers dropdown arrays which can have same content but with changed order
          if (this._arraysAreEqual(this.originalIntervention[fieldName], this.intervention[fieldName])) {
            isModified = false;
          }
        }
        return isModified;
      },
      _arraysAreEqual: function(array1, array2) {
        var differencesArray = [];
        if (array1.length > array2.length) {
          differencesArray = _.difference(array1, array2);
        } else {
          differencesArray = _.difference(array2, array1);
        }
        return _.isEmpty(differencesArray);

      },
      _primitiveFieldIsModified: function(fieldName) {
        return this.originalIntervention[fieldName] !== this.intervention[fieldName];
      },
      _isNewIntervention: function() {
        return !!!this.intervention.id;
      },
      _prepareAttachments: function() {
        if (_.isEmpty(this.intervention.attachments)) {
          return [];
        }
        var modifAttachments = this.intervention.attachments
          .filter(this._attachmentIsNewOrModified.bind(this))
          .map(function(attachment) {
            var _sendAttachmentFile = (attachment.raw instanceof File) ? true : false;
            if (!_sendAttachmentFile && attachment.id) {
              return {
                id: attachment.id,
                type: attachment.type
              };
            } else {
              return {
                id: attachment.id,
                intervention: attachment.intervention,
                type: attachment.type,
                attachment: attachment.raw
              };
            }
          });
        return modifAttachments;
      },

      _attachmentIsNewOrModified: function(attachment) {
        if (_.isEmpty(this.originalIntervention.attachments)) {
          return true;
        }
        if (!attachment.id) {
          return true;
        }
        var originalAttachment = this.originalIntervention.attachments.find(function(att) {
          return att.id === attachment.id;
        });
        if (!originalAttachment) {
          return true;
        }
        return (JSON.stringify(originalAttachment) !== JSON.stringify(attachment));
      },
      _showErrorsWarning: function(validDetails, validReviewAndSign) {
        var msg = 'Please review invalid fields data';
        var tabs = [];
        if (validDetails === false) {
          tabs.push('DETAILS');
        }
        if (validReviewAndSign === false) {
          tabs.push('REVIEW & SIGN');
        }
        msg += ' from ' + ((tabs.length > 1) ? (tabs.join(', ') + ' tabs') : (tabs[0] + ' tab')) + '!';
        this.fire('toast', {text: msg, showCloseBtn: true});
      },

      _updateInterventionStatus: function(event) {
        event.stopImmediatePropagation();
        this.$.interventionData.updateInterventionStatus(event.detail);
      },

      _hasEditPermissions: function(permissions, intervention) {
        if (permissions && permissions.partnershipManager) {
          // TODO: revise this temporary permission, might not be needed
          // temporary edit permission for PM regardless status or other checks
          return true;
        }

        if (permissions && permissions.editInterventionDetails === true) {
          if (intervention) {
            if (!(permissions.partnershipManager || permissions.PME) &&
              (!intervention.status || intervention.status !== 'draft')) {
              // other users than partnershipManager or PME will be able to edit only if intervention status is draft
              return false;
            }
          }
          return true;
        }
        return false;
      },

      _getAttachmentModel: function(interventionId) {
        return {
          id: null,
          intervention: interventionId ? interventionId : null,
          type: null
        };
      },

      _goToNewInterventionPage: function(event) {
        // go to new intervention
        if (!this._hasEditPermissions(this.permissions)) {
          return;
        }
        this.set('intervention', JSON.parse(JSON.stringify(this.newInterventionModel)));
        this.set('selectedInterventionId', null);
        this.fire('update-main-path', {path: 'interventions/new/details'});
      },

      _newIntervention: function(newInterventionActive) {
        return newInterventionActive === true;
      },

      /**
       * Go to details page once the new intervention has been saved
       */
      _newInterventionSaved: function(intervention) {
        this.fire('update-main-path', {path: 'interventions/' + intervention.id + '/details'});
      },

      /**
       * Get intervention details page title: 'partner name: intervention number'
       */
      _getInterventionDetailsTitle: function(intervention) {
        var title = '';
        if (intervention) {
          if (intervention.partner) {
            title += intervention.partner + ': ';
          }
          if (intervention.number) {
            title += intervention.number;
          }
        }
        return title;
      },

      _showAddNewIntervBtn: function(intervListActive, permissions) {
        if (intervListActive && this._hasEditPermissions(permissions)) {
          return true;
        }
        return false;
      },

      _interventionSaveErrors: function(event) {
        event.stopImmediatePropagation();
        if ((event.detail instanceof Array && event.detail.length > 0) ||
          (typeof event.detail === 'string' && event.detail !== '')) {
          this.set('serverErrors', event.detail);
        }
      },

      _isAttachementsTabActive: function(activeTab) {
        return activeTab === 'attachments';
      }

    });

  </script>

</dom-module>
