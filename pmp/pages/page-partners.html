<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/etools-behaviors/etools-logs-behavior.html">

<link rel="import" href="../app-elements/partners/partners-data/partner-item-data.html">
<link rel="import" href="../app-elements/partners/partners-list.html">
<link rel="import" href="../app-elements/partners/partner-overview.html">
<link rel="import" href="../app-elements/partners/partner-details.html">
<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">
<link rel="import" href="../app-elements/partners/new-partner-dialog.html">

<dom-module id="page-partners">

  <template strip-whitespace>

    <style include="page-layout-styles shared-styles buttons-styles">

      :host {
        display: block;
      }

    </style>

    <app-route
        route="{{route}}"
        pattern="[[currentPage]]/list"
        query-params="{{queryParams}}"
        active="{{listActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="[[currentPage]]/:id/:tab"
        active="{{tabsActive}}"
        data="{{routeData}}"></app-route>

    <partner-item-data id="partnerData"
                       partner-id="[[selectedPartnerId]]"
                       partner="{{partner}}"
                       error-event-name="partner-save-error">
    </partner-item-data>

    <div class$="page-top-content [[_getTopContentAdditionalClass(listActive)]]">
      <div class="top-content">
        <div class="top-content-row title-row">
          <h1 main-title>
            <template is="dom-if" if="[[listActive]]">
              <span hidden$="[[showOnlyGovernmentType]]">Partners</span>
              <span hidden$="[[!showOnlyGovernmentType]]">Government Partners</span>
            </template>
            <template is="dom-if" if="[[tabsActive]]">
              <span>[[partner.name]]</span>
            </template>
          </h1>
          <div class="top-content-actions-wrapper">
            <div class="top-content-action" hidden$="[[!listActive]]">
              <a target="_blank" href$="[[csvDownloadUrl]]">
                <paper-button>
                  <iron-icon icon="file-download"></iron-icon>
                  Export
                </paper-button>
              </a>
            </div>
            <!-- Print functionality pending implementation -->
            <!--<div class="top-content-action">
              <paper-button>
                <iron-icon icon="print"></iron-icon>
                Print
              </paper-button>
            </div>-->
            <div class="top-content-action" hidden$="[[!_showNewPartnerBtn(listActive, permissions)]]">
              <paper-button class="primary-btn with-prefix" on-tap="_openNewPartnerDialog">
                <iron-icon icon="add"></iron-icon>
                Add New Partner
              </paper-button>
            </div>
          </div>
        </div>
        <template is="dom-if" if="[[tabsActive]]">
          <div class="top-content-row">
            <paper-tabs id="partnerTabs"
                selected="{{routeData.tab}}"
                attr-for-selected="name" noink bottom-item>

              <paper-tab name="overview" link>
                <span class="tab-content">Overview</span>
              </paper-tab>

              <paper-tab name="details" link>
                <span class="tab-content">Partner Details</span>
              </paper-tab>

            </paper-tabs>
          </div>
        </template>
      </div>
    </div>

    <iron-pages id="partnersPages"
                selected="{{partnerPage}}"
                attr-for-selected="name"
                fallback-selection="list"
                role="main">

      <div class="page" name="list">
        <partners-list id="list"
                       show-only-government-type="[[showOnlyGovernmentType]]"
                       current-page="[[currentPage]]"
                       active="[[listActive]]"
                       csv-download-url="{{csvDownloadUrl}}"
                       url-params="[[queryParams]]"></partners-list>
      </div>
      <div class="page" name="overview">
        <partner-overview partner="[[partner]]"></partner-overview>
      </div>
      <div class="page" name="details">
        <partner-details id="partnerDetails"
                         partner="[[partner]]"
                         edit-mode="[[_hasEditPermissions(permissions)]]"
                         on-save-partner="_savePartner"
                         on-delete-partner="_deletePartner"
                         on-hide-partner="_hidePartner"></partner-details>
      </div>
    </iron-pages>

  </template>

  <script>

    Polymer({

      is: 'page-partners',

      behaviors: [EtoolsLogsBehavior],

      properties: {
        tabsActive: {
          type: Boolean
        },
        partnerPage: {
          type: String,
        },
        routeData: {
          type: Object,
        },
        csvDownloadUrl: {
          type: String
        },
        selectedPartnerId: {
          type: Number
        },
        partner: {
          type: Object,
          observer: '_partnerChanged'
        },
        permissions: {
          type: Object
        },
        showOnlyGovernmentType: {
          type: Boolean,
          value: false
        },
        currentPage: String
      },

      observers: [
        '_updateUrlTab(routeData.tab)',
        '_pageChanged(listActive, routeData.tab)',
        '_observeRouteDataId(routeData.id)'
      ],

      listeners: {
        'partner-save-error': '_partnerSaveError',
        'create-partner': '_createPartner',
        'reload-list': '_reloadPartnersList'
      },
      ready: function() {
        this.newPartnerDialog = document.createElement('new-partner-dialog');
        this.newPartnerDialog.setAttribute('id', 'newPartnerDialog');
        Polymer.dom(document.querySelector('body')).appendChild(this.newPartnerDialog);

        this.newPartnerDialog.addEventListener('create-partner', function(event) {
          this.fire('create-partner', event.detail);
        }.bind(this), false);
      },
      detached: function() {
        if (this.newPartnerDialog) {
          Polymer.dom(document.querySelector('body')).removeChild(this.newPartnerDialog);
        }
      },

      _getActivePage: function(listActive, tab) {
        if (listActive) {
          return 'list';
        } else {
          return tab;
        }
      },

      _pageChanged: function(listActive, tab) {
        var activePage = this._getActivePage(listActive, tab);
        this.set('partnerPage', activePage);
      },

      _hasEditPermissions: function(permissions) {
        if (permissions && permissions.editPartnerDetails === true) {
          return true;
        }
        return false;
      },
      _updateUrlTab: function(tab) {
        if (!tab) {
          return;
        }
        this.debounce('debounce-url-tab-update', function() {
          var tabs = this.$$('#partnerTabs');
          if (tabs) {
            tabs.notifyResize();
          }
          this.fire('update-main-path', {path: this.route.path});
        }.bind(this), 50);
      },

      _getTopContentAdditionalClass: function(listActive) {
        if (!listActive) {
          return 'with-tabs';
        }
        return '';
      },
      _savePartner: function(event) {
        event.stopImmediatePropagation();
        this.$.partnerData.savePartner(event.detail);
      },
      _deletePartner: function(event) {
        event.stopImmediatePropagation();
        this.$.partnerData.deletePartner(this.partner);
      },
      _hidePartner: function(event) {
        event.stopImmediatePropagation();
        this.$.partnerData.hidePartner(event.detail);
      },
      _observeRouteDataId: function(id) {
        this.set('selectedPartnerId', id);
      },

      _partnerSaveError: function(event) {
        event.stopImmediatePropagation();
        if ((event.detail instanceof Array && event.detail.length > 0) ||
          (typeof event.detail === 'string' && event.detail !== '')) {
          this.$.partnerDetails.set('serverErrors', event.detail);
        }

      },
      _showNewPartnerBtn: function(listActive, permissions) {
        return listActive && this._hasEditPermissions(permissions);
      },
      _openNewPartnerDialog: function() {
        this.newPartnerDialog.openNewPartnerDialog();
      },
      _createPartner: function(event) {
        this.$.partnerData.createPartner(event.detail, this._newPartnerCreated,
          this._handleCreatePartnerError);
      },
      _newPartnerCreated: function(partner) {
        this.fire('update-main-path', {path: 'partners/' + partner.id + '/details'});
      },
      _handleCreatePartnerError: function(errorDetails) {
        var toastMsg = (typeof errorDetails === 'object' && errorDetails.error) ? errorDetails.error : errorDetails;
        this.fire('toast', {text: toastMsg, showCloseBtn: true});
      },

      _partnerChanged: function(partner) {
        if (typeof partner === 'object' && Object.keys(partner).length > 0) {
          // dismiss partner details pages loading
          this.fire('global-loading', {active: false});
        }
      },

      _reloadPartnersList: function(e) {
        e.stopImmediatePropagation();
        try {
          var partners = this.$.list;
          if (!partners.$.list.classList.contains('hidden')) {
            partners._filterPartnersData(true);
          }
        } catch (err) {
          this.logWarn('List refresh error occurred', '[partners-page]', err);
        }
      }

    });

  </script>

</dom-module>
