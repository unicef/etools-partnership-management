<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/etools-behaviors/etools-logs-behavior.html">

<link rel="import" href="../../scripts/lodash/lodash.html">

<link rel="import" href="behaviors/page-utils-behavior.html">
<link rel="import" href="../app-behaviors/scroll-control-behavior.html">

<link rel="import" href="../app-elements/partners/partners-data/partner-item-data.html">

<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">
<link rel="import" href="../app-elements/common-elements/etools-error-messages-box.html">
<link rel="import" href="../app-elements/partners/new-partner-dialog.html">
<link rel="import" href="../app-elements/partners/partner-status.html">

<dom-module id="page-partners">

  <template strip-whitespace>

    <style include="page-layout-styles shared-styles buttons-styles">
      :host {
        display: block;
      }
    </style>

    <app-route
        route="{{route}}"
        pattern="[[currentPage]]/list"
        query-params="{{listPageQueryParams}}"
        active="{{listActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="[[currentPage]]/:id/:tab"
        active="{{tabsActive}}"
        data="{{routeData}}"></app-route>

    <div class$="page-top-content [[_getTopContentAdditionalClass(partnerPage)]]">
      <div class="top-content">
        <div class="top-content-row title-row">
          <h1 main-title>
            <template is="dom-if" if="[[listActive]]">
              <span hidden$="[[showOnlyGovernmentType]]">Partners</span>
              <span hidden$="[[!showOnlyGovernmentType]]">Government Partners</span>
            </template>
            <template is="dom-if" if="[[tabsActive]]">
              <span>[[partner.name]]</span>
            </template>
          </h1>
          <div class="top-content-actions-wrapper">
            <div class="top-content-action" hidden$="[[!listActive]]">
              <a target="_blank" href$="[[csvDownloadUrl]]">
                <paper-button>
                  <iron-icon icon="file-download"></iron-icon>
                  Export
                </paper-button>
              </a>
            </div>
            <div class="top-content-action" hidden$="[[!_showNewPartnerBtn(listActive, permissions)]]">
              <paper-button class="primary-btn with-prefix" on-tap="_openNewPartnerDialog">
                <iron-icon icon="add"></iron-icon>
                Add New Partner
              </paper-button>
            </div>
          </div>
        </div>
        <template is="dom-if" if="[[_showPageTabs(partnerPage)]]">
          <div class="top-content-row">
            <paper-tabs id="partnerTabs"
                        selected="{{activeTab}}"
                        attr-for-selected="name"
                        noink bottom-item
                        on-iron-select="_handleTabSelectAction">

              <paper-tab name="overview" link>
                <span class="tab-content">Overview</span>
              </paper-tab>

              <paper-tab name="details" link>
                <span class="tab-content">Partner Details</span>
              </paper-tab>

            </paper-tabs>
          </div>
        </template>
      </div>
    </div>

    <div id="main">
      <div id="pageContent">

        <etools-error-messages-box id="errorsBox"
                                   title="Errors Saving Partner"
                                   errors="{{serverErrors}}"></etools-error-messages-box>
        <iron-pages id="partnersPages"
                    selected="{{partnerPage}}"
                    attr-for-selected="name"
                    role="main">

          <template is="dom-if" if="[[_pageEquals(partnerPage, 'list')]]">
            <partners-list id="list"
                           name="list"
                           show-only-government-type="[[showOnlyGovernmentType]]"
                           current-page="[[currentPage]]"
                           active="[[listActive]]"
                           csv-download-url="{{csvDownloadUrl}}"
                           url-params="[[listQueryParams]]">
            </partners-list>
          </template>

          <template is="dom-if" if="[[_pageEquals(partnerPage, 'overview')]]">
            <partner-overview name="overview" partner="[[partner]]"></partner-overview>
          </template>

          <template is="dom-if" if="[[_pageEquals(partnerPage, 'details')]]">
            <partner-details id="partnerDetails"
                             name="details"
                             partner="[[partner]]"
                             edit-mode="[[_hasEditPermissions(permissions)]]"></partner-details>
          </template>

        </iron-pages>

      </div> <!-- page content end -->

      <!-- sidebar content start -->
      <template is="dom-if" if="[[_showSidebarStatus(listActive, _subPageOrTabAttached, partner)]]">
        <div id="sidebar">
          <partner-status
              on-save-partner="_validateAndTriggerPartnerSave"
              on-delete-partner="_deletePartner"
              active="[[!listActive]]"
              partner="[[partner]]"
              edit-mode$="[[_hasEditPermissions(permissions)]]">
          </partner-status>
        </div> <!-- sidebar content end -->
      </template>

    </div> <!-- main container end -->

    <partner-item-data id="partnerData"
                       partner-id="[[selectedPartnerId]]"
                       partner="{{partner}}"
                       error-event-name="partner-save-error">
    </partner-item-data>

  </template>

  <script>

    Polymer({

      is: 'page-partners',

      behaviors: [
        EtoolsLogsBehavior,
        EtoolsPmpApp.Behaviors.PageUtils,
        EtoolsPmpApp.Behaviors.ScrollControl,
      ],

      properties: {
        tabsActive: {
          type: Boolean
        },
        partnerPage: {
          type: String,
        },
        routeData: {
          type: Object,
        },
        activeTab: {
          type: String,
          value: '',
          observer: '_activeTabChanged'
        },
        csvDownloadUrl: {
          type: String
        },
        selectedPartnerId: {
          type: Number
        },
        partner: {
          type: Object,
          observer: '_partnerChanged'
        },
        permissions: {
          type: Object
        },
        showOnlyGovernmentType: {
          type: Boolean,
          value: false
        },
        serverErrors: {
          type: Array,
          value: []
        },
        currentPage: String,
        originalPartnerData: Object,
        listActive: Boolean
      },

      observers: [
        '_updateUrlTab(routeData.tab)',
        '_pageChanged(listActive, activeTab)',
        '_observeRouteDataId(routeData.id)'
      ],

      listeners: {
        'partner-save-error': '_partnerSaveError',
        'create-partner': '_createPartner',
        'reload-list': '_reloadPartnersList',
        'partners-page-attached': '_handlePageTabAttached',
        'not-found-redirect': '_handleNotFound'
      },

      ready: function() {
        this.newPartnerDialog = document.createElement('new-partner-dialog');
        this.newPartnerDialog.setAttribute('id', 'newPartnerDialog');
        Polymer.dom(document.querySelector('body')).appendChild(this.newPartnerDialog);

        this.newPartnerDialog.addEventListener('create-partner', function(event) {
          this.fire('create-partner', event.detail);
        }.bind(this), false);
      },
      attached: function() {
        // deactivate main page loading msg triggered in app-shell
        this.fire('global-loading', {active: false, loadingSource: 'main-page'});
        /**
         * Loading msg used on stamping tabs elements (disabled in each tab main element attached callback)
         */
        this.fire('global-loading', {
          message: 'Loading ' + (this.listActive ? 'partners list' :
              (this._removeStrDash(this.activeTab) + ' page')) + ' elements...',
          active: true,
          loadingSource: 'partners-page'
        });
      },
      detached: function() {
        if (this.newPartnerDialog) {
          Polymer.dom(document.querySelector('body')).removeChild(this.newPartnerDialog);
        }
      },

      _activeTabChanged: function(activeTab) {
        if (activeTab) {
          this.set('routeData.tab', activeTab);
        }
      },

      _setActivePage: function(listActive, tab) {
        let page = 'list';
        let pagePrefix = 'partners-';
        let pageBaseUrl = '../app-elements/partners/';
        if (!listActive) {
          page = tab;
          pagePrefix = 'partner-';
        } else {
          this.set('serverErrors', []);
        }
        if (page) {
          let self = this;
          self._importPageElement(page, pagePrefix, pageBaseUrl).then(function() {
            self.set('partnerPage', page);
          })
          .catch(function(err) {
            self.logError('Agreement page import error occurred', '[partner(s) ' + page + ']', err);
            self.fire('global-loading', {active: false, loadingSource: 'partners-page'});
            self._triggerPageNotFound();
          });
        }
      },

      _pageChanged: function(listActive, tab) {
        this._setActivePage(listActive, tab);
      },

      _hasEditPermissions: function(permissions) {
        if (permissions && permissions.editPartnerDetails === true) {
          return true;
        }
        return false;
      },

      _handleNotFound: function() {
        this.fire('global-loading', {active: false, loadingSource: 'main-page'});
        this.fire('global-loading', {active: false, loadingSource: 'partners-page'});
        this.fire('global-loading', {active: false, loadingSource: 'partner-data'});
        this._updatePath('not-found');
      },

      _updateUrlTab: function(tab) {
        if (!tab) {
          return;
        }
        this.set('activeTab', tab);
        this._updateTabs();
        this._updatePath(this.route.path);
      },

      _updatePath: function(path) {
        this.fire('update-main-path', {path: path});
      },

      _updateTabs: function() {
        this.debounce('debounce-tab-update', function() {
          var tabs = this.$$('#partnerTabs');
          if (tabs) {
            tabs.notifyResize();
          }
        }.bind(this), 50);
      },

      _savePartner: function(newPartnerData) {
        let partnerData = this.$$('#partnerData');
        if (partnerData) {
          partnerData.savePartner(newPartnerData);
        }
      },

      _deletePartner: function(event) {
        event.stopImmediatePropagation();
        this.fire('global-loading', {
          active: true,
          message: 'Deleting partner...',
          loadingSource: 'partner-data'
        });

        let partnerData = this.$$('#partnerData');
        if (partnerData) {
          partnerData.deletePartner(this.partner,
              this._handlePartnerDeleted.bind(this), this._handlePartnerNotDeleted);
        }
      },

      _handlePartnerDeleted: function() {
        this.fire('global-loading', {active: false, loadingSource: 'partner-data'});
        this.fire('toast', {text: 'Partner successfully deleted', showCloseBtn: true});
        this.fire('update-main-path', {path: 'partners/list'});
      },

      _handlePartnerNotDeleted: function() {
        this.fire('global-loading', {active: false, loadingSource: 'partner-data'});
      },

      _observeRouteDataId: function(id) {
        if (this.route && this.route.path.indexOf('partners') > -1) {
          this.set('selectedPartnerId', id);
        }
      },

      _partnerSaveError: function(event) {
        event.stopImmediatePropagation();
        if ((event.detail instanceof Array && event.detail.length > 0) ||
            (typeof event.detail === 'string' && event.detail !== '')) {
          this.set('serverErrors', event.detail);
          this._setContentScrollPosition(0);
        }
      },

      _showNewPartnerBtn: function(listActive, permissions) {
        return listActive && this._hasEditPermissions(permissions);
      },

      _openNewPartnerDialog: function() {
        this.newPartnerDialog.openNewPartnerDialog();
      },

      _createPartner: function(event) {
        let partnerData = this.$$('#partnerData');
        if (partnerData) {
          partnerData.createPartner(event.detail, this._newPartnerCreated,
              this._handleCreatePartnerError);
        }
      },

      _newPartnerCreated: function(partner) {
        this.fire('update-main-path', {path: 'partners/' + partner.id + '/details'});
      },

      _handleCreatePartnerError: function(errorDetails) {
        this.fire('toast', {text: errorDetails, showCloseBtn: true});
      },

      _partnerChanged: function(partner) {
        if (!_.isEmpty(partner)) {
          // dismiss partner details pages loading
          this.fire('global-loading', {active: false, loadingSource: 'partner-data'});
          // keep a copy of loaded partner to be able to check changed data
          this.set('originalPartnerData', JSON.parse(JSON.stringify(partner)));
        }
        this.set('serverErrors', []);
        this._setContentScrollPosition(0);
      },

      _reloadPartnersList: function(e) {
        e.stopImmediatePropagation();
        try {
          var partners = this.$$('#list');
          if (partners && !partners.$.list.classList.contains('hidden')) {
            partners._filterPartnersData(true);
          }
        } catch (err) {
          this.logWarn('List refresh error occurred', '[partners-page]', err);
        }
      },

      _validateAndTriggerPartnerSave: function(event) {
        event.stopImmediatePropagation();
        if (!this._hasEditPermissions(this.permissions)) {
          return;
        }
        let partnerDetails = this.$$('#partnerDetails');
        if (partnerDetails && partnerDetails._validatePartner()) {
          var partnerChanges = this._cleanUpdateData(this.partner);
          partnerChanges.id = this.partner.id;
          this._savePartner(partnerChanges);
        } else {
          this.fire('toast', {
            text: 'Please check assessments and partner contacts for ' +
            'invalid fields or empty data rows!', showCloseBtn: true
          });
        }
      },

      _cleanUpdateData: function(partner) {
        var updateableFields = [
          'alternate_name',
          'shared_with',
          'staff_members',
          'assessments',
          'core_values_assessment'
        ];
        var changes = {};
        updateableFields.forEach(function(fieldName) {
          // TODO: improve this
          if (['shared_with', 'assessments', 'staff_members'].indexOf(fieldName) > -1) {
            if (JSON.stringify(partner[fieldName]) !== JSON.stringify(this.originalPartnerData[fieldName])) {
              changes[fieldName] = partner[fieldName];
            }
          } else if (fieldName === 'core_values_assessment') {
            if ((partner.hasOwnProperty('core_values_assessment')) &&
                (partner.core_values_assessment instanceof File)) {
              changes.core_values_assessment = partner.core_values_assessment;
            }
          } else {
            if (partner[fieldName] !== this.originalPartnerData[fieldName]) {
              changes[fieldName] = partner[fieldName];
            }
          }
        }.bind(this));
        return changes;
      },

      _handleTabSelectAction: function(e) {
        this._showTabChangeLoadingMsg(e, 'partners-page', 'partner-');
      },

    });

  </script>

</dom-module>
