<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Behaviors || {};
  /** @polymerBehavior EtoolsPmpApp.Behaviors.PageUtils */
  EtoolsPmpApp.Behaviors.PageUtils = {

    properties: {
      _subPageOrTabAttached: {
        type: Boolean,
        value: false
      },
      /* Gets updated by app-route */
      listPageQueryParams: {
        type: Object,
        observer: '_handleQueryParams'
      },
      /* Gets updated when listPageQueryParams changes, only if listPageQueryParams is not empty,
         otherwise preservedListQueryParams holds on to it's previous data.
         This is to preserve set list page filters like : rows per page , search string, any other filters,
         while navigating between pages from the same category
         (ex. go to intervention list, select to filter by intervention status, go to intervention details,
         click on the Interventions left side menu item => the intervention list is still filtered by intervention status).
      */
      preservedListQueryParams: {
        type: Object,
        value: {}
      },
      serverErrors: {
        type: Array,
        value: []
      }
    },

    listeners: {
      'clear-server-errors': '_clearServerErrors',
      'set-server-errors': '_setServerErrors'
    },

    _clearServerErrors: function() {
      this.set('serverErrors', []);
    },

    _setServerErrors: function(e) {
      this.set('serverErrors', e.detail);
    },

    _handleQueryParams: function(params) {
      if (params !== null && Object.keys(params).length) {
        this.set('preservedListQueryParams', params);
      }
    },

    _pageEquals: function(activePage, expectedPage) {
      return activePage === expectedPage;
    },

    _removeStrDash: function(str) {
      return str ? str.replace(new RegExp('-', 'g'), ' ') : '';
    },

    _showPageTabs: function(page) {
      return page !== 'list';
    },

    _showTabChangeLoadingMsg: function(e, loadingSource, tabPrefix, tab) {
      let clickedTabName = tab ? tab : e.detail.item.getAttribute('name');
      if (Polymer.isInstance(this.$$(tabPrefix + clickedTabName))) {
        // tab element already loaded, no need for loading messages
        return;
      }
      this.fire('global-loading', {
        message: 'Loading ' + this._removeStrDash(clickedTabName) + ' page elements...',
        active: true,
        loadingSource: loadingSource
      });
    },

    /**
     * "other" can be any property that must be defined before the method is executed
     */
    _showSidebarStatus: function(listPageActive, subPageOrTabAttached, other) {
      let showStatus = !listPageActive && !!subPageOrTabAttached;
      return !other ? showStatus : (showStatus && other);
    },

    _handlePageTabAttached: function(e) {
      e.stopImmediatePropagation();
      // just a flag to know when to show sidebar status element
      this.set('_subPageOrTabAttached', true);
    }

  };
</script>
