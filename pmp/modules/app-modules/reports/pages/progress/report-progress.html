<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../scripts/lodash.html">

<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/utils-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">

<link rel="import" href="../../../../layout/components/etools-ram-indicators.html">

<link rel="import" href="../../components/report-status.html">
<link rel="import" href="components/report-overall.html">
<link rel="import" href="components/indicator-report-target.html">
<link rel="import" href="components/indicator-details.html">
<link rel="import" href="components/sr-details.html">

<link rel="import" href="../../../../styles/page-common-styles.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">

<dom-module id="report-progress">
  <template strip-whitespace>
    <style include="page-common-styles grid-layout-styles paper-material-styles">
      *[hidden] {
        display: none !important;
      }

      .indicator + .indicator {
        border-top: 1px solid var(--primary-background-color);
      }

      .indicator-toggle,
      .indicator-header-title,
      .indicator-header-target {
        @apply --layout-vertical;
        @apply --layout-center-justified;
      }

      .indicator-toggle {
        position: relative;
        z-index: 1;
        color: white;
        padding: 0 4px;
        border-right: 1px solid var(--primary-background-color);
      }

      .indicator-toggle paper-icon-button {
        width: 24px;
        height: 24px;
        padding: 0;
      }

      .indicator-toggle {
        background-color: var(--primary-color);
      }

      .indicator-toggle.cluster-indicator {
        background-color: var(--ternary-color);
      }

      .indicator-header {
        padding: 8px 24px 8px 16px;
        background: var(--medium-theme-background-color);
      }

      .indicator-header-title h3 {
        margin: 0;
      }

      #no-report-data {
        background-color: var(--primary-background-color);
      }

      .calculation-formula {
        color: var(--secondary-text-color);
      }

      .calculation-formula-delimiter {
        margin: 0 16px;
      }
    </style>

    <!-- TODO: split this element and create separate elements for displaying SR vs QPR/HR req -->
    <template is="dom-if" if="[[_equals(report.report_type, 'SR')]]">
      <sr-details report="[[report]]" report-attachment="[[reportAttachment]]"></sr-details>
    </template>

    <template is="dom-if" if="[[!_equals(report.report_type, 'SR')]]">
      <div id="no-report-data"
           class="paper-material"
           elevation="1"
           hidden$="[[!_noReportDataToShow(report.programme_document.cp_outputs)]]">
        <div class="row-h">
          <p>There is no report data to display.</p>
        </div>
      </div>

      <template is="dom-repeat"
                items="[[report.programme_document.cp_outputs]]"
                as="result"
                index-as="resultIndex">
        <etools-content-panel class="content-section" panel-title="CP Output: [[result.title]]">

          <!-- RAM indicators display -->
          <etools-ram-indicators class="row-h"
                                 intervention-id="[[report.programme_document.external_id]]"
                                 cp-id="[[result.external_cp_output_id]]"></etools-ram-indicators>

          <template is="dom-repeat"
                    items="[[result.ll_outputs]]"
                    as="lowerResult"
                    index-as="lowerResultIndex">

            <report-overall lower-result-title="[[lowerResult.title]]"
                            latest-indicator="[[_getLowerResultLatestIndicator(lowerResult.id)]]"></report-overall>

            <template is="dom-repeat"
                      items="[[_getLowerResultIndicatorReports(lowerResult.id)]]"
                      as="indicatorReport"
                      index-as="indicatorReportIndex">

              <div class="indicator">
                <div class="layout-horizontal">
                  <div class$="indicator-toggle [[_getClusterIndicatorClass(indicatorReport)]]">
                    <paper-icon-button on-click="_toggle"
                                       toggles-ind-details$="[[resultIndex]]-[[lowerResultIndex]]-[[indicatorReportIndex]]"
                                       icon$="[[_computeIcon(indicatorReport.expanded)]]">
                    </paper-icon-button>
                  </div>

                  <div class="indicator-header layout-horizontal flex-c">
                    <div class="col col-8 indicator-header-title">
                      <h3>
                        [[_ternary(indicatorReport.reportable.blueprint.unit, 'number', '#', '%')]]
                        [[indicatorReport.reportable.blueprint.title]]
                      </h3>
                      <div class="layout-horizontal calculation-formula">
                        <span>
                          calculation method accross locations:
                          <strong>[[getDisplayValue(indicatorReport.reportable.blueprint.calculation_formula_across_locations)]]</strong>
                        </span>
                          <span class="calculation-formula-delimiter">|</span>
                          <span>
                          calculation across reporting periods:
                            <strong>[[getDisplayValue(indicatorReport.reportable.blueprint.calculation_formula_across_periods)]]</strong>
                        </span>
                      </div>
                    </div>
                    <div class="col col-4 indicator-header-target">
                      <indicator-report-target
                          display-type="[[indicatorReport.reportable.blueprint.display_type]]"
                          target="[[indicatorReport.reportable.target]]"
                          cumulative-progress="[[_ternary(indicatorReport.reportable.blueprint.display_type, 'number',
                              indicatorReport.reportable.achieved.v, indicatorReport.reportable.achieved.c)]]"
                          achievement="[[_ternary(indicatorReport.reportable.blueprint.display_type, 'number',
                              indicatorReport.total.v, indicatorReport.total.c)]]"
                          bold></indicator-report-target>
                    </div>
                  </div>
                </div>

                <iron-collapse id="collapse-[[resultIndex]]-[[lowerResultIndex]]-[[indicatorReportIndex]]"
                               opened="{{indicatorReport.expanded}}"
                               on-transitioning-changed="_indicatorDetailsTransitioningComplete">
                  <indicator-details
                      id$="indicator-details-[[resultIndex]]-[[lowerResultIndex]]-[[indicatorReportIndex]]"
                      indicator-report-id="[[indicatorReport.id]]"
                      is-cluster-indicator$="[[indicatorReport.is_cluster_indicator]]">
                  </indicator-details>
                </iron-collapse>
              </div>
            </template>

          </template>
        </etools-content-panel>
      </template>

    </template>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.Utils
     */
    class ReportProgress extends EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.Utils
    ], Polymer.Element) {

      static get is() {
        return 'report-progress';
      }

      static get properties() {
        return {
          report: Object,
          reportAttachment: Object
        };
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for report progress tab elements load,
         * triggered by parent element on stamp or by tap event on tabs
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'reports-page'});
      }

      _computeIcon(opened) {
        return opened ? 'icons:expand-less' : 'icons:expand-more';
      }

      _toggle(e) {
        let toggles = e.target.getAttribute('toggles-ind-details');
        let indicatorCollapsibleContent = this.shadowRoot.querySelector('#collapse-' + toggles);
        if (indicatorCollapsibleContent) {
          indicatorCollapsibleContent.toggle();
        }
      }

      _indicatorDetailsTransitioningComplete(e) {
        let indicatorCollapsibleContent = e.target;
        let indicatorDetails = indicatorCollapsibleContent.querySelector('indicator-details');
        if (indicatorDetails && !e.detail.value && indicatorCollapsibleContent.opened) {
          // trigger indicator details request
          indicatorDetails.getIndicatorDetails();
        }
      }

      _getClusterIndicatorClass(indicatorReport) {
        return (indicatorReport && indicatorReport.is_cluster_indicator) ? 'cluster-indicator' : '';
      }

      _noReportDataToShow(cpOutputs) {
        return _.isEmpty(cpOutputs);
      }

      _getLowerResultLatestIndicator(lowerResultId) {
        if (!lowerResultId || _.isEmpty(this.report.indicator_reports)) {
          return {};
        }
        let latestIndicatorReport = this.report.indicator_reports.find((rep) => {
          return rep.reportable_object_id === lowerResultId;
        });
        return latestIndicatorReport ? latestIndicatorReport : {};
      }

      _getLowerResultIndicatorReports(lowerResultId) {
        if (!lowerResultId || _.isEmpty(this.report.indicator_reports)) {
          return [];
        }
        return this.report.indicator_reports.filter((rep) => {
          return rep.reportable_object_id === lowerResultId;
        });
      }

    }

    window.customElements.define(ReportProgress.is, ReportProgress);
  </script>
</dom-module>
