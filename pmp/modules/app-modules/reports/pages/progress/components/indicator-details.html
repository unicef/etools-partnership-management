<link rel="import" href="../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../../../../bower_components/app-layout/app-grid/app-grid-style.html">

<link rel="import" href="../../../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../../bower_components/etools-loading/etools-loading.html">

<link rel="import" href="../../../../../scripts/lodash.html">

<link rel="import" href="../../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../../../mixins/utils-mixin.html">

<link rel="import" href="../../../components/report-status.html">
<link rel="import" href="disaggregations/disaggregation-table.html">

<dom-module id="indicator-details">
  <template>
    <style include="app-grid-style">
      :host {
        display: block;
        min-height: 150px;
        position: relative;

        --app-grid-columns: 2;
        --app-grid-gutter: 24px;
        --app-grid-item-height: auto;
        --paper-tab-ink: var(--primary-color);
        --paper-tabs-selection-bar-color: var(--primary-color);

        --paper-tabs: {
          padding-left: 13px;
          border-bottom: 1px solid var(--dark-divider-color);
        };
      }

      :host([is-cluster-indicator]) {
        --paper-tab-ink: var(--ternary-color);
        --paper-tabs-selection-bar-color: var(--ternary-color);
      }

      .tab-header {
        @apply --layout-horizontal;
        @apply --layout-justified;
        padding: 10px 24px;
        border-bottom: 1px solid var(--dark-divider-color);
        background-color: var(--light-theme-background-color);
      }

      .tab-header dl {
        margin: 0;
        font-size: 12px;
        color: var(--primary-text-color);
      }

      .tab-header dt,
      .tab-header dd {
        display: inline;
        margin: 0;
      }

      .tab-header dt:first-of-type,
      .tab-header dd:first-of-type {
        font-weight: bold;
        font-size: 13px;
      }

      .tab-header dt:last-of-type,
      .tab-header dd:last-of-type {
        color: var(--secondary-text-color);
      }

      .tab-header dd::after {
        content: '\A';
        white-space: pre;
      }

      .table-container {
        max-height: 500px;
        overflow: auto;
      }

    </style>

    <etools-loading active="[[loading]]">Loading...</etools-loading>

    <!-- TODO: Check if this can be replaced using etools-tabs element (future task) -->
    <template is="dom-if" if="[[!loading]]">
      <paper-tabs selected="{{selected}}"
                  selectable="paper-tab"
                  scrollable
                  hide-scroll-buttons>
        <template is="dom-repeat" items="[[locationData]]" as="topLevelLocation">
          <paper-tab>
            <report-status status="[[_computeLocationStatus(topLevelLocation)]]" no-label></report-status>
            [[topLevelLocation.title]]
          </paper-tab>
        </template>
      </paper-tabs>

      <iron-pages selected="{{selected}}">
        <template is="dom-repeat"
                  items="[[locationData]]"
                  as="topLevelLocation">
          <div>
            <paper-tabs selected="{{topLevelLocation.selected}}"
                        selectable="paper-tab"
                        hide-scroll-buttons
                        scrollable>
              <template
                  is="dom-repeat"
                  items="[[topLevelLocation.byEntity]]"
                  as="location">
                <paper-tab>[[location.reporting_entity.title]]</paper-tab>
              </template>
            </paper-tabs>

            <iron-pages selected="{{topLevelLocation.selected}}">
              <template
                  is="dom-repeat"
                  items="[[topLevelLocation.byEntity]]"
                  as="location">

                <div>
                  <div class="tab-header">
                    <dl>
                      <template is="dom-if" if="[[_equals(location.display_type, 'number')]]" restamp="true">
                        <dt>Location progress against [[location.reporting_entity.title]] target:</dt>
                        <dd>[[_formatNumber(location.location_progress.v, '0', 0, '\,')]]</dd>
                        <dt>Previous location progress:</dt>
                        <dd>[[_formatNumber(location.previous_location_progress.v, '0', 0, '\,')]]</dd>
                      </template>
                      <template is="dom-if" if="[[!_equals(location.display_type, 'number')]]" restamp="true">
                        <dt>Location progress:</dt>
                        <dd>[[_formatIndicatorValue(location.display_type, location.location_progress.c, true)]]</dd>
                        <dt>Previous location progress:</dt>
                        <dd>[[_formatIndicatorValue(location.display_type, location.previous_location_progress.c, true)]]</dd>
                      </template>
                    </dl>
                  </div>

                  <div class="table-container app-grid">
                    <div class="item">
                      <disaggregation-table data="[[location]]"
                                            mapping="[[indicatorReport.disagg_lookup_map]]"
                                            labels="[[indicatorReport.labels]]">
                      </disaggregation-table>
                    </div>
                  </div>
                </div>

              </template>
            </iron-pages>
          </div>

        </template>
      </iron-pages>
    </template>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.Utils
     */
    class IndicatorDetails extends EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.AjaxErrorsParser,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.Utils
    ], Polymer.Element) {

      static get is() {
        return 'indicator-details';
      }

      static get properties() {
        return {
          indicatorReportId: Number,
          indicatorReport: {
            type: Object,
            value: {}
          },
          loading: {
            type: Boolean,
            value: false
          },
          selected: {
            type: Number,
            value: 0
          },
          isClusterIndicator: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          locationData: {
            type: Array,
            computed: '_computeLocationData(indicatorReport.indicator_location_data)'
          }
        };
      }

      _shouldRefreshIndicatorDetails() {
        return this.indicatorReportId &&
            (_.isEmpty(this.indicatorReport) ||
              (!_.isEmpty(this.indicatorReport) && this.indicatorReport.id !== parseInt(this.indicatorReportId, 10)));
      }

      getIndicatorDetails() {
        if (!this._shouldRefreshIndicatorDetails()) {
          // indicator details already loaded
          return;
        }

        let params = this._computeParams(this.indicatorReportId);
        this._showLoading();
        let self = this;
        this.fireRequest('reportIndicatorsDetails', {}, {params: params}).then(function(response) {
          self.set('indicatorReport', (response && response[0]) ? response[0] : {});
          self._hideLoading();
        }).catch(function(error) {
          let errMsg = 'Indicator details data request failed!';
          self.logError(errMsg, 'reports-indicator-details', error);
          self.parseRequestErrorsAndShowAsToastMsgs(error, self);
          self._hideLoading();
        });
      }

      _showLoading() {
        this.set('loading', true);
      }

      _hideLoading() {
        this.set('loading', false);
      }

      _computeParams(indicatorReportId) {
        return {
          pks: indicatorReportId,
          limit: 1
        };
      }

      _computeLocationData(rawLocationData) {
        let byLocation = (rawLocationData || [])
            .reduce(function(acc, location) {
              let locationId = location.location.id;

              if (typeof acc[locationId] === 'undefined') {
                acc[locationId] = {
                  title: location.location.title,
                  byEntity: [],
                  selected: 0
                };
              }

              acc[locationId].byEntity.push(location);
              if (acc[locationId].byEntity.length >= 2) {
                acc[locationId].selected = acc[locationId].byEntity.length - 1;
              }
              return acc;
            }, {});

        return Object.keys(byLocation)
            .map(function(key) {
              return byLocation[key];
            })
            .sort(function(a, b) {
              return b.is_master_location_data - a.is_master_location_data;
            });
      }

      _computeLocationStatus(location) {
        return location.byEntity[0].is_complete ? 1 : 2; //  'success' : 'error'
      }

    }

    window.customElements.define(IndicatorDetails.is, IndicatorDetails);
  </script>
</dom-module>
