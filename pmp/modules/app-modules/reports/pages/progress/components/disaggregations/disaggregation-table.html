<link rel="import" href="../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../bower_components/polymer/lib/elements/dom-if.html">

<link rel="import" href="table-content/three-disaggregations.html">
<link rel="import" href="table-content/two-disaggregations.html">
<link rel="import" href="table-content/one-disaggregation.html">
<link rel="import" href="table-content/zero-disaggregations.html">

<link rel="import" href="../../../../../../mixins/utils-mixin.html">

<link rel="import" href="styles/disaggregation-table-styles.html">

<dom-module id="disaggregation-table">
  <template strip-whitespace>
    <style include="disaggregation-table-styles">
      .data-key {
        font-size: 12px;
        color: var(--secondary-text-color);
      }

      .data-key dt,
      .data-key dd {
        display: inline;
      }

      .data-key dd {
        margin: 0;
      }

    </style>

    <div>
      <template
      is="dom-if"
      if="[[viewLabel]]"
      restamp="true">
        <template
            is="dom-if"
            if="[[labels]]"
            restamp="true">
          <dl class="data-key">
            <dt>Label - </dt>
            <template
                is="dom-if"
                if="[[_equals(data.display_type, 'number')]]"
                restamp="true">
              <dd>[ [[_withDefault(labels.label)]] ]</dd>
            </template>
            <template
                is="dom-if"
                if="[[!_equals(data.display_type, 'number')]]"
                restamp="true">
              <dd>
                [ [[_withDefault(labels.numerator_label)]] ]
                /
                [ [[_withDefault(labels.denominator_label)]] ]
              </dd>
            </template>
          </template>
        </dl>
      </template>

      <table class="vertical layout">
        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 0)]]"
            restamp="true">
          <zero-disaggregations
              data="[[viewData]]"
              mapping="[[formattedMapping]]">
          </zero-disaggregations>
        </template>

        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 1)]]"
            restamp="true">
          <one-disaggregation
              data="[[viewData]]"
              mapping="[[formattedMapping]]">
          </one-disaggregation>
        </template>

        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 2)]]"
            restamp="true">
          <two-disaggregations
              data="[[viewData]]"
              mapping="[[formattedMapping]]">
          </two-disaggregations>
        </template>

        <template
            is="dom-if"
            if="[[_equals(formattedMapping.length, 3)]]"
            restamp="true">
          <three-disaggregations
              data="[[viewData]]"
              mapping="[[formattedMapping]]">
          </three-disaggregations>
        </template>
      </table>
    </div>

  </template>

  <script>
    'use strict';

    /**
     * This element is a modified PRP element to fit PMP functionality regarding disaggregation data display.
     * We do not need `disaggregation-switches` element here (for now) and there is no editable data.
     * Minimal changes were made here so we minimize the issues if we update from PRP.
     *
     * @polymer
     * @customElement
     * @appliesMixin EtoolsPmpApp.Mixins.Utils
     */
    class DisaggregationTable extends EtoolsPmpApp.Mixins.Utils(Polymer.Element) {

      static get is() {
        return 'disaggregation-table';
      }

      static get properties() {
        return {
          /**
           * `editable` and `editableBool` is only kept here because disaggregation elements are common with PRP app,
           * it will always be `0` and `false` in PMP.
           */
          editable: {
            type: Number,
            value: 0
          },

          data: {
            type: Object,
            observer: '_cloneData'
          },

          viewData: {
            type: Object,
            computed: '_computeViewData(formattedData, totals)'
          },

          formattedData: {
            type: Object
          },

          formattedMapping: {
            type: Array,
            computed: '_computeMapping(editableBool, formattedData, mapping)'
          },

          editableBool: {
            type: Boolean,
            computed: '_computeEditableBool(editable)'
          },

          indicatorType: {
            type: String,
            computed: '_computeIndicatorType(data)'
          },

          fields: Array,
          mapping: Array,
          labels: Object,
          viewLabel: {
            type: Boolean,
            computed: '_computeLabelVisibility(indicatorType)'
          },
          totals: Object
        };
      }

      static get observers() {
        return [
          '_resetFields(formattedData.disaggregation_reported_on)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        if (!this.totals) {
          this.set('totals', {});
        }
      }

      _resetFields(reportedOn) {
        if (typeof reportedOn === 'undefined') {
          return;
        }
        this.set('fields', []);
      }

      _computeLabelVisibility(indicatorType) {
        if (String(indicatorType) === 'number') {
          return false;
        } else {
          return true;
        }
      }

      _computeEditableBool(editable) {
        return editable === 1;
      }

      _computeMapping(editableBool, formattedData, mapping) {
        if (typeof editableBool === 'undefined' ||
            typeof formattedData === 'undefined' ||
            typeof mapping === 'undefined') {
          return;
        }
        let reportedOn = formattedData.disaggregation_reported_on;

        return editableBool ? mapping.filter(function(disagg) {
          return reportedOn.indexOf(disagg.id) !== -1;
        }) : mapping;
      }

      _computeIndicatorType(data) {
        if (typeof data === 'undefined') {
          return;
        }
        return data.display_type;
      }

      _cloneData(data) {
        if (typeof data === 'undefined') {
          return;
        }
        this.set('formattedData', JSON.parse(JSON.stringify(data)));
        this.set('totals', JSON.parse(JSON.stringify(this.formattedData.disaggregation)));
      }

      _computeViewData(data, totals) {
        return Object.assign({}, data, {
          disaggregation: Object.assign({}, data.disaggregation, totals)
        });
      }

    }

    window.customElements.define(DisaggregationTable.is, DisaggregationTable);
  </script>
</dom-module>
