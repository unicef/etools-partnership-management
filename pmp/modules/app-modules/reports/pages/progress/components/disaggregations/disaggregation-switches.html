<link rel="import" href="../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../../../../../../bower_components/paper-checkbox/paper-checkbox.html">


<link rel="import" href="../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../mixins/utils-mixin.html">
<link rel="import" href="../../../../../../mixins/event-helper-mixin.html">

<dom-module id="disaggregation-switches">
  <template strip-whitespaces>
    <style>
      :host {
        display: block;
      }

      .container {
        padding: 10px 24px;
        margin: 0 -24px;
        background: var(--paper-grey-100);
      }

      .container h4 {
        margin: 0 0 10px;
        font-size: 12px;
        line-height: 1;
      }

      paper-checkbox:not(:first-of-type) {
        margin-left: 24px;
      }

    </style>

    <template
        is="dom-if"
        if="[[editableBool]]"
        restamp>
      <div class="container">
        <h4>Enter data by disaggregation</h4>
        <template
            is="dom-repeat"
            items="[[mapping]]"
            as="field">
          <paper-checkbox
              id="[[field.id]]"
              checked="[[_computeChecked(field.id)]]"
              on-iron-form-element-register="_initField"
              on-change="_fieldValueChanged">
            [[_formatFieldName(field.name)]]
          </paper-checkbox>
        </template>

        <template
            is="dom-if"
            if="[[warning]]"
            restamp="true">
        </template>
      </div>
    </template>
  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     */
    class DisaggregationSwitches extends EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.Utils,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element) {

      static get is() {
        return 'disaggregation-switches';
      }

      static get properties() {
        return {
          mapping: Object,

          editable: Number,

          warning: {
            type: Boolean,
            value: true,
          },

          reportedOn: {
            type: Array,
            value: [],
          },

          formattedData: {
            type: Object,
            notify: true,
          },

          data: {
            type: Object,
            observer: '_cloneData',
          },

          editableBool: {
            type: Boolean,
            computed: '_computeEditableBool(editable)',
          }
        };
      }

      static get observers() {
        return [
          '_computeWarning(data, reportedOn.splices)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        this.set('reportedOn', []);
      }

      _computeEditableBool(editable) {
        return editable === 1;
      }

      _cloneData(data) {
        if (!data) {
          return;
        }
        this.set('formattedData', JSON.parse(JSON.stringify(data)));
      }

      _computeChecked(id) {
        return this.formattedData.disaggregation_reported_on.indexOf(id) !== -1;
      }

      _formatFieldName(name) {
        return this._capitalizeFirstLetter(name);
      }

      _fieldValueChanged(e) {
        let field = e.target;
        this._fieldValueChangedDebouncer = Polymer.Debouncer.debounce(this._fieldValueChangedDebouncer,
            Polymer.Async.timeOut.after(100),
            () => {
              this._recordField(field);
              this._confirmIntent(field)
                  .then(this._commit.bind(this))
                  .catch(this._revert.bind(this));
            });
      }

      _confirmIntent(field) {
        let deferred = this._deferred();

        this.fireEvent('disaggregation-modal-confirm', deferred);

        return deferred.promise.catch(function() {
          return Promise.reject(field);
        });
      }

      _commit() {
        this.set('formattedData', Object.assign({}, this.formattedData, {
          disaggregation: {},
          level_reported: this.reportedOn.length,
          disaggregation_reported_on: this.reportedOn,
        }));
      }

      _revert(field) {
        field.checked = !field.checked;

        this._recordField(field);
      }

      _computeWarning(data, _) {
        if (typeof data === 'undefined') {
          return;
        }
        this.set('warning', this.reportedOn.length < data.num_disaggregation);
      }

      _recordField(field) {
        let id = Number(field.id);
        let checked = field.checked;

        if (checked) {
          this.push('reportedOn', id);
        } else {
          this.splice('reportedOn', this.reportedOn.indexOf(id), 1);
        }
      }

      _initField(e) {
        this._recordField(e.target);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        // TODO: polymer 2 - check if this is still needed, isDebouncerActive is legacy code
        // if (this.isDebouncerActive('fieldValueChanged')) {
        //   this.cancelDebouncer('fieldValueChanged');
        // }
      }

    }

    window.customElements.define(DisaggregationSwitches.is, DisaggregationSwitches);
  </script>
</dom-module>
