<link rel="import" href="../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../../../mixins/event-helper-mixin.html">
<link rel="import" href="mixins/disaggregation-field.html">

<dom-module id="disaggregation-field">
  <template>
    <style>
      :host {
        display: block;

        --paper-input-container: {
          padding: 0;
        };

        --paper-input-container-input: {
          font-size: 13px;
        };

        --paper-input-container-input-webkit-spinner: {
          display: none;
        };
      }
    </style>

    <paper-input
        id="field"
        value="[[value]]"
        type="number"
        allowed-pattern="[+\-\d]"
        invalid="{{invalid}}"
        validator="[[validator]]"
        min="[[min]]"
        no-label-float
        required
        auto-validate>
    </paper-input>
  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.DisaggregationField
     */
    class DisaggregationField extends EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.DisaggregationField
    ], Polymer.Element) {

      static get is() {
        return 'disaggregation-field';
      }

      static get properties() {
        return {
          key: String,

          coords: String,

          min: Number,

          validator: String,

          value: {
            type: Number,
            notify: true
          },

          invalid: {
            type: Boolean,
            notify: true
          }
        };
      }

      ready() {
        super.ready();
        this.addEventListener('field.input', this._handleInput.bind(this));
      }

      connectedCallback() {
        super.connectedCallback();
        this.fireEvent('register-field', this);
      }

      // Cant deregister fields in lifecycle hooks due to:
      // https://github.com/Polymer/polymer/issues/1159
      // :( :( :(
      //
      // disconnectedCallback() {
      //   super.disconnectedCallback();
      // }

      validate() {
        return this.$.field.validate();
      }

      getField() {
        return this.$.field;
      }

      _handleInput(e) {
        let change = {};

        change[this.key] = e.target.value;

        this.fireEvent('field-value-changed', {
          key: this.coords,
          value: this._toNumericValues(change)
        });
      }

    }

    window.customElements.define(DisaggregationField.is, DisaggregationField);
  </script>
</dom-module>
