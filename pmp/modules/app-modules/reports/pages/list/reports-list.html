<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../../../../../../bower_components/etools-dropdown/etools-dropdown.html">
<link rel="import" href="../../../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../scripts/lodash.html">

<link rel="import" href="../../../../mixins/app-navigation-helper-mixin.html">
<link rel="import" href="../../../../mixins/list-filters-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../config/app-constants.html">
<link rel="import" href="../../../../redux/etools-data-redux-store.html">

<link rel="import" href="../../../../styles/app-mixins.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/list-filter-styles.html">

<link rel="import" href="../../components/reports-display-list.html">

<dom-module id="reports-list">
  <template strip-whitespaces>
    <style include="shared-styles list-filter-styles paper-material-styles">
    </style>

    <div id="filters" class="paper-material" elevation="1">

      <div id="filters-fields">

        <paper-input id="query"
                     class="filter"
                     type="search"
                     autocomplete="off"
                     value="{{queryParams.pd_ref_title}}"
                     placeholder="Search">
          <iron-icon icon="search" slot="prefix"></iron-icon>
        </paper-input>

        <template is="dom-repeat" items="[[selectedFilters]]" as="filter">
          <template is="dom-if" if="[[filter.singleSelection]]">
            <etools-dropdown
                class="filter"
                label="[[filter.filterName]]"
                placeholder="&#8212;"
                disabled$="[[!filter.selectionOptions.length]]"
                options="[[filter.selectionOptions]]"
                option-value="[[filter.optionValue]]"
                option-label="[[filter.optionLabel]]"
                selected="[[filter.alreadySelected]]"
                on-selected-changed="filterValueChanged"
                data-filter-path$="[[filter.path]]"
                hide-search="[[filter.hideSearch]]"
                min-width="[[filter.minWidth]]"
                horizontal-align="left"
                no-dynamic-align
                enable-none-option>
            </etools-dropdown>
          </template>
          <template is="dom-if" if="[[!filter.singleSelection]]">
            <etools-dropdown-multi
                class="filter"
                label="[[filter.filterName]]"
                placeholder="&#8212;"
                disabled$="[[!filter.selectionOptions.length]]"
                options="[[filter.selectionOptions]]"
                option-value="[[filter.optionValue]]"
                option-label="[[filter.optionLabel]]"
                selected-values="[[filter.alreadySelected]]"
                trigger-value-change-event
                on-etools-selected-items-changed="esmmValueChanged"
                data-filter-path$="[[filter.path]]"
                hide-search="[[filter.hideSearch]]"
                min-width="[[filter.minWidth]]"
                horizontal-align="left"
                no-dynamic-align>
            </etools-dropdown-multi>
          </template>
        </template>

      </div>

      <div class="fixed-controls">

        <paper-menu-button id="filterMenu" ignore-select horizontal-align="right">
          <paper-button class="button" slot="dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>
            Filters
          </paper-button>
          <paper-listbox slot="dropdown-content" multi>
            <template is="dom-repeat" items="[[listFilterOptions]]">
              <paper-icon-item on-tap="selectFilter" selected$="[[item.selected]]">
                <iron-icon icon="check" slot="item-icon" hidden$="[[!item.selected]]"></iron-icon>
                <paper-item-body>[[item.filterName]]</paper-item-body>
              </paper-icon-item>
            </template>
          </paper-listbox>
        </paper-menu-button>

      </div>

    </div>

    <reports-display-list query-params="[[queryParams]]"
                          paginator="{{paginator}}"
                          wait-query-params-init></reports-display-list>
  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsPmpApp.Mixins.AppNavigationHelper
     * @appliesMixin EtoolsPmpApp.Mixins.ListFilters
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const ReportsListRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.Constants,
      EtoolsPmpApp.Mixins.AppNavigationHelper,
      EtoolsPmpApp.Mixins.ListFilters,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin ReportsListRequiredMixins
     */
    class ReportsList extends ReportsListRequiredMixins {

      static get is() {
        return 'reports-list';
      }

      static get properties() {
        return {
          urlParams: {
            type: Object
          },
          active: {
            type: Boolean,
            value: false
          },
          csvDownloadUrl: {
            type: String,
            notify: true
          },
          // filters options
          partners: {
            type: Array,
            statePath: 'partnersDropdownData'
          },
          cpOutputs: {
            type: Array,
            statePath: 'cpOutputs'
          },
          sections: {
            type: Array,
            statePath: 'sections'
          },
          reportStatuses: {
            type: Array,
            statePath: 'reportStatuses'
          },
          reportTypes: {
            type: Array,
            statePath: 'reportTypes'
          },
          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          // selected filters values
          queryParams: {
            type: Object,
            value: {
              pd_ref_title: null,
              external_partner_id: null,
              cp_output: null,
              section: null,
              status: ['Sub', 'Ove', 'Sen'],
              report_type: null,
              unicef_focal_points: []
            }
          },
          paginator: {
            type: Object
          },
          _filtersInitialized: {
            type: Boolean,
            value: false
          },
          _initComplete: {
            type: Boolean,
            value: false
          },
          _prevFiltersChangedArgs: String
        };
      }

      static get observers() {
        return [
          '_initListFilters(partners, cpOutputs, sections, unicefUsersData, reportStatuses, reportTypes)',
          '_updateURL(queryParams.*, paginator.page, paginator.page_size, _initComplete)',
          '_init(active, _filtersInitialized)',
          '_filtersChanged(queryParams.pd_ref_title, queryParams.external_partner_id, ' +
            'queryParams.cp_output, queryParams.section, queryParams.status.length, queryParams.report_type, ' +
            'queryParams.unicef_focal_points.length)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for main list elements load,
         * triggered by parent element on stamp
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'reports-page'});
      }

      _initListFilters(partners, cpOutputs, sections, unicefUsersData, reportStatuses, reportTypes) {
        if (!partners || !cpOutputs || !sections || !unicefUsersData || !reportStatuses || !reportTypes) {
          return;
        }
        // init list filter options
        // IMPORTANT!!!
        // If you change filterName make sure you update it as well in _updateSelectedFiltersValues method
        // IMPORTANT!!!
        this.initListFiltersData([
          {
            filterName: 'CP Output',
            type: 'esmm',
            singleSelection: true,
            optionValue: 'id',
            optionLabel: 'name',
            selectionOptions: cpOutputs,
            alreadySelected: null,
            path: 'queryParams.cp_output',
            selected: false,
            minWidth: '400px'
          },
          {
            filterName: 'Partner',
            type: 'esmm',
            singleSelection: true,
            optionValue: 'value',
            optionLabel: 'label',
            selectionOptions: partners,
            alreadySelected: null,
            path: 'queryParams.external_partner_id',
            selected: false,
            minWidth: '400px'
          },
          {
            filterName: 'Report Status',
            type: 'esmm', // etools-dropdown-multi
            singleSelection: false,
            selectionOptions: reportStatuses,
            optionValue: 'value',
            optionLabel: 'label',
            alreadySelected: [],
            path: 'queryParams.status',
            selected: true,
            minWidth: '160px',
            hideSearch: true
          },
          {
            filterName: 'Report Type',
            type: 'esmm', // etools-dropdown-multi
            singleSelection: true,
            selectionOptions: reportTypes,
            optionValue: 'value',
            optionLabel: 'label',
            alreadySelected: [],
            path: 'queryParams.report_type',
            selected: true,
            minWidth: '300px',
            hideSearch: true
          },
          {
            filterName: 'Section',
            type: 'esmm',
            singleSelection: true,
            optionValue: 'id',
            optionLabel: 'name',
            selectionOptions: sections,
            alreadySelected: null,
            path: 'queryParams.section',
            selected: false,
            minWidth: '400px',
            hideSearch: true
          },
          {
            filterName: 'UNICEF focal points',
            type: 'esmm',
            singleSelection: false,
            optionValue: 'email',
            optionLabel: 'name',
            selectionOptions: unicefUsersData,
            alreadySelected: [],
            path: 'queryParams.unicef_focal_points',
            selected: false,
            minWidth: '400px'
          }
        ]);
        this.set('_filtersInitialized', true);
      }

      // update selected filters(prezent in URL) at page refresh
      _updateSelectedFiltersValues() {
        let filtersValues = [
          {
            filterName: 'Report Status',
            selectedValue: this.queryParams.status
          },
          {
            filterName: 'Report Type',
            selectedValue: this.queryParams.report_type
          },
          {
            filterName: 'Partner',
            selectedValue: this.queryParams.external_partner_id
          },
          {
            filterName: 'CP Output',
            selectedValue: this.queryParams.cp_output
          },
          {
            filterName: 'Section',
            selectedValue: this.queryParams.section
          },
          {
            filterName: 'UNICEF focal points',
            selectedValue: this.queryParams.unicef_focal_points
          }
        ];
        this.updateShownFilters(filtersValues);
      }

      _init(active, _filtersInitialized) {
        if (!active || !_filtersInitialized) {
          return;
        }
        let urlQueryParams = this.urlParams;
        this.set('_initComplete', false);
        this._initSelectedFilters = Polymer.Debouncer.debounce(this._initSelectedFilters,
            Polymer.Async.timeOut.after(0),
            () => {
              this.set('queryParams.pd_ref_title', urlQueryParams.pd_ref_title ? urlQueryParams.pd_ref_title : '');
              this.set('queryParams.external_partner_id',
                  urlQueryParams.external_partner_id ? urlQueryParams.external_partner_id : null);
              this.set('queryParams.cp_output', urlQueryParams.cp_output ? urlQueryParams.cp_output : null);
              this.set('queryParams.section', urlQueryParams.section ? urlQueryParams.section : null);
              this.set('queryParams.status',
                  urlQueryParams.status ? urlQueryParams.status.split('|') : this.queryParams.status);
              this.set('queryParams.unicef_focal_points',
                  urlQueryParams.unicef_focal_points ? urlQueryParams.unicef_focal_points.split('|') : []);
              this.set('queryParams.report_type', urlQueryParams.report_type ? urlQueryParams.report_type : null);

              this.set('paginator.page', urlQueryParams.page ? Number(urlQueryParams.page) : 1);
              this.set('paginator.page_size',
                  urlQueryParams.page_size ? Number(urlQueryParams.page_size) : this.CONSTANTS.DEFAULT_LIST_SIZE);

              this._updateSelectedFiltersValues();
              this.set('_initComplete', true);
            });
      }

      _updateURL(queryParamsData, pageNr, pageSize, _initComplete) {
        if (!_initComplete) {
          return;
        }
        if (!queryParamsData || !pageNr || !pageSize) {
          return;
        }

        let qs = this._buildQueryString();
        // update URL
        this.updateAppState('reports/list', qs, true);
      }

      // Outputs the query string for the list
      _buildQueryString() {
        let qStrData = [];
        if (!_.isEmpty(this.queryParams)) {
          Object.keys(this.queryParams).forEach(function(k) {
            let qStrVal;
            if (this.queryParams[k] instanceof Array && !_.isEmpty(this.queryParams[k])) {
              qStrVal = this.queryParams[k].join('|');
            } else if (['string', 'number'].indexOf(typeof this.queryParams[k]) > -1) {
              qStrVal = this.queryParams[k];
            }
            if (qStrVal) {
              qStrData.push(k + '=' + qStrVal);
            }
          }.bind(this));
        }
        if (!_.isEmpty(this.paginator)) {
          if (this.paginator.page) {
            qStrData.push('page=' + this.paginator.page);
          }
          if (this.paginator.page_size) {
            qStrData.push('page_size=' + this.paginator.page_size);
          }
        }
        return qStrData.join('&');
      }

      /**
       * _prevFiltersChangedArgs check will prevent page reset in case queryParams array values are updated,
       * but with the same value. Ex: by default queryParams.unicef_focal_points = [], when filter si selected from menu,
       * queryParams.unicef_focal_points is updated, but to a new empty array (by esmm) and this will
       * trigger _filtersChanged observer.
       * @private
       */
      _filtersChanged() {
        // eslint-disable-next-line
        let sAgrs = JSON.stringify(arguments);
        if (this._prevFiltersChangedArgs !== sAgrs) {
          this.set('paginator.page', 1);
          this._prevFiltersChangedArgs = sAgrs;
        }
      }
    }

    window.customElements.define(ReportsList.is, ReportsList);
  </script>
</dom-module>
