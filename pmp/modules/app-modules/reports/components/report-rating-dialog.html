<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../../../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../mixins/ajax-errors-parser-mixin.html">

<link rel="import" href="../../../styles/shared-styles.html">

<dom-module id="report-rating-dialog">
    <template>
      <style include="shared-styles">
        [hidden] {
          display: none !important;
        }

        #content-box {
          margin-bottom: 20px;
        }
      </style>
      <etools-dialog
          id="reportRatingDialog"
          size="md"
          keep-dialog-open
          spinner-text="Sending rating..."
          disable-confirm-btn="[[!selectedOverallStatus.length]]"
          ok-btn-text="Rate & Accept Report"
          cancel-btn-text="Cancel"
          dialog-title="Report for [[report.programme_document.reference_number]]: [[report.reporting_period]]"
          on-confirm-btn-clicked="saveStatus">
        <div id="content-box">
          <p>Rate the overall progress of this PD/SSFA in light of this report and monitoring visits.</p>
          <paper-radio-group id="overallStatus" selected="{{selectedOverallStatus}}">
            <paper-radio-button name="Met"> Met</paper-radio-button>
            <paper-radio-button name="OnT"> On track</paper-radio-button>
            <paper-radio-button name="NoP"> No progress</paper-radio-button>
            <paper-radio-button name="Con"> Constrained</paper-radio-button>
          </paper-radio-group>
        </div>
      </etools-dialog>
    </template>

    <script>
      'use strict';
      /*
        status: 'accepted'/'sent back'
        overall_status: if accepting, the status of things
        comment: required when sending a report back
      */
      class ReportRatingDialog extends EtoolsPmpApp.Mixins.AjaxErrorsParser(
          EtoolsPmpApp.Mixins.Endpoints(Polymer.Element)) {

        static get is() {
          return 'report-rating-dialog';
        }

        static get properties() {
          return {
            report: Object,
            toastEventSource: {
              type: Object
            },
            selectedOverallStatus: {
              type: String,
              value: ''
            }
          };
        }

        open() {
          this.set('selectedOverallStatus', '');
          this.$.reportRatingDialog.set('opened', true);
        }

        close() {
          this.$.reportRatingDialog.set('opened', false);
        }

        startSpinner() {
          this.$.reportRatingDialog.startSpinner();
        }

        stopSpinner() {
          this.$.reportRatingDialog.stopSpinner();
        }

        saveStatus() {
          let self = this;
          let requestBody = {
            status: 'Acc',
            overall_status: this.selectedOverallStatus
          };

          this.startSpinner();
          this.fireRequest('reportReview', {reportId: this.report.id}, {method: 'POST', body: requestBody})
              .then(function(response) {
                self.fire('report-accepted', {report: response});
                self.stopSpinner();
                self.close();
              }).catch(function(error) {
            self._handleErrorResponse(error);
          });
        }

        _handleErrorResponse(error) {
          this.stopSpinner();
          this.parseRequestErrorsAndShowAsToastMsgs(error, this.toastEventSource);
        }
      }

      window.customElements.define(ReportRatingDialog.is, ReportRatingDialog);
    </script>
</dom-module>
