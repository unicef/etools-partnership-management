<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../../scripts/lodash.html">
<link rel="import" href="../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../mixins/common-mixin.html">
<link rel="import" href="../../../mixins/pagination-mixin.html">
<link rel="import" href="../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../endpoints/endpoints-mixin.html">

<link rel="import" href="../../../styles/app-mixins.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="report-status.html">

<dom-module id="reports-display-list">
  <template strip-whitespace>
    <style include="data-table-styles grid-layout-styles paper-material-styles">
      :host {
        @apply --layout-flex;
        width: 100%;

        --paper-tooltip: {
          text-align: center;
          line-height: 1.4;
        };
      }

      .pd-ref,
      .view-report {
        @apply --text-btn-style;
      }

      .pd-ref {
        text-transform: none;
      }

      .final-badge {
        display: inline-block;
        border-radius: 1px;
        padding: 1px 6px;
        font-size: 10px;
        text-transform: uppercase;
        background-color: var(--paper-grey-300);
        margin-left: 5px;
        font-weight: bold;
      }

      .tooltip-trigger {
        position: relative;
      }

    </style>

    <div id="list" class="paper-material" elevation="1">

      <template is="dom-if" if="[[!reports.length]]">
        <div class="row-h">
          <p>There are no reports yet.</p>
        </div>
      </template>

      <template is="dom-if" if="[[reports.length]]">
        <etools-data-table-header id="listHeader"
                                  label="[[paginator.visible_range.0]]-[[paginator.visible_range.1]]
                                    of [[paginator.count]] results to show">
          <etools-data-table-column class="col-2">
            Report #
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            Partner
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            Report Status
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            Due Date
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            Reporting Period
          </etools-data-table-column>
          <template is="dom-if" if="[[!noPdSsfaRef]]" restamp>
            <etools-data-table-column class="col-2">
              PD/SSFA ref.#
            </etools-data-table-column>
          </template>
        </etools-data-table-header>

        <template is="dom-repeat" items="[[reports]]" as="report" on-dom-change="_listDataChanged">
          <etools-data-table-row>

            <div slot="row-data">
              <span class="col-data col-2">
                <span id$="tooltip-trigger-[[report.id]]" class="tooltip-trigger">
                  <a class="view-report"
                     href$="reports/[[report.id]]/progress"
                     hidden$="[[!_canViewReport(report.status)]]">
                    [[_getReportTitle(report)]]
                  </a>
                  <span hidden$="[[_canViewReport(report.status)]]">[[_getReportTitle(report)]]</span>
                  <template
                      is="dom-if"
                      if="[[report.is_final]]">
                    <span class="final-badge">final</span>
                  </template>
                </span>
                <paper-tooltip for$="tooltip-trigger-[[report.id]]"
                               position="right"
                               fit-to-visible-bounds>
                  [[report.programme_document.title]]
                </paper-tooltip>
              </span>
              <span class="col-data flex-c">
                <span id$="tooltip-partner-[[report.id]]" class="tooltip-trigger">
                  [[_displayOrDefault(report.partner_name)]]
                </span>

                <paper-tooltip for$="tooltip-partner-[[report.id]]"
                                position="right"
                                fit-to-visible-bounds>
                  [[report.partner_vendor_number]]
                </paper-tooltip>
              </span>
              <span class="col-data flex-c">
                <report-status status="[[report.status]]"></report-status>
              </span>
              <span class="col-data flex-c">
                [[_displayOrDefault(report.due_date)]]
              </span>
              <span class="col-data flex-c">
                [[getDisplayValue(report.reporting_period)]]
              </span>
              <template is="dom-if" if="[[!noPdSsfaRef]]" restamp>
                <span class="col-data col-2">
                  <a class="pd-ref truncate"
                     href$="interventions/[[report.programme_document.external_id]]/details"
                     title$="[[getDisplayValue(report.programme_document.reference_number)]]">
                    [[getDisplayValue(report.programme_document.reference_number)]]
                  </a>
                </span>
              </template>
            </div>

            <div slot="row-data-details">
              <div class="row-details-content">
                <span class="rdc-title flex-c">UNICEF Focal Points</span>
                <span>[[getDisplayValue(report.unicef_focal_points)]]</span>
              </div>
            </div>

          </etools-data-table-row>
        </template>

        <etools-data-table-footer
            page-size="[[paginator.page_size]]"
            page-number="[[paginator.page]]"
            total-results="[[paginator.count]]"
            visible-range="{{paginator.visible_range}}"
            on-page-size-changed="pageSizeChanged"
            on-page-number-changed="pageNumberChanged">
        </etools-data-table-footer>

      </template>
    </div>

  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsAjaxRequestMixin
     * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.Pagination
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const ReportsDisplayListMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.AjaxErrorsParser,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.Pagination,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin ReportsDisplayListMixins
     */
    class ReportsDisplayList extends ReportsDisplayListMixins {
      static get is() {
        return 'reports-display-list';
      }

      static get properties() {
        return {
          currentUser: {
            type: Object,
            statePath: 'currentUser'
          },
          interventionId: {
            type: Number,
            value: 0
          },
          reports: {
            type: Array,
            value: []
          },
          noPdSsfaRef: {
            type: Boolean,
            value: false
          },
          queryParams: {
            type: Object,
            value: null,
            notify: true
          },
          debounceInterval: {
            type: Number,
            value: 100
          },
          waitQueryParamsInit: Boolean,
          _endpointName: {
            type: String,
            value: 'reports'
          },
          _lastParamsUsed: Object
        };
      }

      static get observers() {
        return [
          '_loadReportsData(prpCountries, interventionId, currentUser, paginator.page_size,' +
          ' paginator.page, queryParams.*, queryParams.status.length)'
        ];
      }

      _loadReportsData(prpCountries, interventionId, currentUser, pageSize, page, qParamsData) {
        if (_.isEmpty(currentUser) || this._queryParamsNotInitialized(qParamsData) || _.isEmpty(prpCountries)) {
          return;
        }

        this._loadReportsDataDebouncer = Polymer.Debouncer.debounce(this._loadReportsDataDebouncer,
            Polymer.Async.timeOut.after(this.debounceInterval),
            () => {
              let params = this._prepareReqParamsObj(interventionId);

              if (JSON.stringify(this._lastParamsUsed) === JSON.stringify(params) ||
                  (this.noPdSsfaRef && !params.programme_document_ext)) {
                return;
              }

              this._lastParamsUsed = Object.assign({}, params);

              this.fireEvent('global-loading', {
                message: 'Loading...',
                active: true,
                loadingSource: 'reports-list'
              });

              let activeReportsReq = this.getActiveRequestByKey(this._endpointName);
              if (activeReportsReq) {
                // abort previous req and then fire a new one with updated params
                this.abortActiveRequest(activeReportsReq);
              }

              this.fireRequest('reports', {}, {params: params}, this._endpointName)
                  .then((response) => {
                    if (response) {
                      this.set('reports', response.results);
                      this.updatePaginatorTotalResults(response);
                    }
                    this.fireEvent('global-loading', {active: false, loadingSource: 'reports-list'});
                  })
                  .catch((error) => {
                    if (error.status === 0) {
                      // req aborted
                      return;
                    }
                    let errMsg = 'Reports list data request failed!';
                    this.logError(errMsg, 'reports-list', error);

                    this.parseRequestErrorsAndShowAsToastMsgs(error, this);
                    this.fireEvent('global-loading', {active: false, loadingSource: 'reports-list'});
                  });
            });
      }

      _prepareReqParamsObj(interventionId) {
        let params = {};
        if (interventionId > 0) {
          params.programme_document_ext = interventionId;
        }
        params = Object.assign({}, params, this._preserveExistingQueryParams(), this.getRequestPaginationParams());
        return params;
      }

      _canViewReport(status) {
        return ['Acc', 'Sen', 'Sub'].indexOf(status) > -1;
      }

      _preserveExistingQueryParams() {
        let params = {};
        if (!_.isEmpty(this.queryParams)) {
          Object.keys(this.queryParams).forEach(function(k) {
            if ((this.queryParams[k] instanceof Array && this.queryParams[k].length > 0) ||
                (this.queryParams[k] instanceof Array === false && this.queryParams[k])) {
              params[k] = this.queryParams[k];
            }
          }.bind(this));
        }
        return params;
      }

      _queryParamsNotInitialized(qParamsData) {
        return this.waitQueryParamsInit && !qParamsData.value && qParamsData.path === 'queryParams';
      }

      _displayOrDefault(val) {
        if (!val) {
          return '-';
        }
        return val;
      }

      _getReportTitle(report) {
        return report.report_type + report.report_number;
      }

      // TODO: this is the same function from lists common mixin, but we do not need that entire functionality here
      // refactor in near future
      _listDataChanged() {
        let rows = this.shadowRoot.querySelectorAll('etools-data-table-row');
        if (rows && rows.length) {
          for (let i = 0; i < rows.length; i++) {
            if (rows[i].detailsOpened) {
              rows[i].set('detailsOpened', false);
            }
          }
        }
      }
    }

    window.customElements.define(ReportsDisplayList.is, ReportsDisplayList);
  </script>
</dom-module>
