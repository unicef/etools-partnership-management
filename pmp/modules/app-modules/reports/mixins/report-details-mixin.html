<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../config/app-constants.html">
<link rel="import" href="../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../redux/etools-data-redux-store.html">

<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};

  /**
   * @polymerMixin
   * @mixinFunction
   * @appliesMixin EtoolsLogsMixin
   * @appliesMixin EtoolsPmpApp.Mixins.Constants
   * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
   * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
   * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
   * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
   */
  EtoolsPmpApp.Mixins.ReportDetails = superclass => class extends EtoolsMixinFactory.combineMixins([
    EtoolsLogsMixin,
    EtoolsPmpApp.Mixins.Constants,
    EtoolsPmpApp.Mixins.EventHelper,
    EtoolsPmpApp.Mixins.Endpoints,
    EtoolsPmpApp.Mixins.AjaxErrorsParser,
    EtoolsPmpApp.Mixins.EtoolsDataReduxStore], superclass) {

    static get properties() {
      return {
        report: Object,
        reportAttachment: Object,
        currentUser: {
          type: Object,
          statePath: 'currentUser'
        },
        reportActions: {
          type: Array,
          value: [
            {
              label: 'Accept',
              primary: true,
              event: 'accept-report'
            },
            {
              label: 'Send back to partner',
              event: 'send-back-to-partner'
            },
            {
              label: 'Download',
              event: 'download-report'
            }
          ]
        },
        _loadingMsgSource: {
          type: String,
          value: 'report-details'
        },
        _logMsgPrefix: {
          type: String,
          value: 'report-details-behavior'
        }
      };
    }

    requestReportDetails(id) {
      if (!this.currentUser) {
        this.logWarn('Logged user data not init in Redux store.', this._logMsgPrefix);
        return;
      }

      this.set('reportAttachment', null);

      this.fireEvent('global-loading', {
        message: 'Loading...',
        active: true,
        loadingSource: this._loadingMsgSource
      });

      this.fireRequest('reportDetails', {reportId: id}).then((response) => {
        this.set('report', response);
        this.fireEvent('global-loading', {active: false, loadingSource: this._loadingMsgSource});
        // get SR attachment
        if (this.isPrpSRReport(response.report_type)) {
          this._getSRAttachment(response.id);
        }
      }).catch((error) => {
        let errMsg = 'Reports details data request failed!';
        this.logError(errMsg, this._logMsgPrefix, error);
        this.parseRequestErrorsAndShowAsToastMsgs(error, this, true);
        this.fireEvent('global-loading', {active: false, loadingSource: this._loadingMsgSource});
      });
    }

    isPrpSRReport(repType) {
      return repType === this.CONSTANTS.REQUIREMENTS_REPORT_TYPE.SR;
    }

    _getSRAttachment(reportId) {
      this.fireEvent('global-loading', {
        message: 'Loading...',
        active: true,
        loadingSource: this._loadingMsgSource
      });
      this.fireRequest('srReportAttachment', {reportId: reportId}).then((response) => {
        this.set('reportAttachment', response);
        this.fireEvent('global-loading', {active: false, loadingSource: this._loadingMsgSource});
      }).catch((error) => {
        let errMsg = 'Reports details data request failed!';
        this.logError(errMsg, this._logMsgPrefix, error);
        this.parseRequestErrorsAndShowAsToastMsgs(error, this, true);
        this.fireEvent('global-loading', {active: false, loadingSource: this._loadingMsgSource});
      });
    }

  };

</script>
