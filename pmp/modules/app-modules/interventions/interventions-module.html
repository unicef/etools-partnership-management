<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../../bower_components/etools-dialog/dynamic-dialog-mixin.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../mixins/module-common-mixin.html">
<link rel="import" href="../mixins/module-routing-mixin.html">

<link rel="import" href="mixins/intervention-permissions-mixin.html">
<link rel="import" href="mixins/save-intervention-mixin.html">
<link rel="import" href="mixins/intervention-page-tabs-mixin.html">

<link rel="import" href="../../amendment-mode/redux-in-amendment-mixin.html">
<link rel="import" href="../../mixins/scroll-control-mixin.html">
<link rel="import" href="../../mixins/event-helper-mixin.html">
<link rel="import" href="../../environment-flags/environment-flags-mixin.html">

<link rel="import" href="../../layout/components/etools-error-messages-box.html">
<link rel="import" href="../../layout/page-content-header/page-content-header.html">
<link rel="import" href="../../layout/page-content-header/page-content-header-slotted-styles.html">
<link rel="import" href="../../layout/components/etools-tabs.html">

<link rel="import" href="data/intervention-item-data.html">
<link rel="import" href="../agreements/data/agreement-item-data.html">

<link rel="import" href="components/intervention-status.html">
<link rel="import" href="../../config/app-constants.html">
<link rel="import" href="../../endpoints/endpoints-mixin.html">

<link rel="import" href="../../styles/app-mixins.html">
<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">

<link rel="import" href="../../scripts/lodash.html">

<!-- lazy imports -->
<link rel="lazy-import" href="pages/list/interventions-list.html">
<link rel="lazy-import" href="pages/overview/intervention-overview.html">
<link rel="lazy-import" href="pages/details/intervention-details.html">
<link rel="lazy-import" href="pages/review-and-sign/intervention-review-and-sign.html">
<link rel="lazy-import" href="pages/attachments/intervention-attachments.html">
<link rel="lazy-import" href="pages/reports/intervention-reports.html">
<link rel="lazy-import" href="pages/progress/intervention-progress.html">

<dom-module id="interventions-module">
  <template strip-whitespace>
    <style include="page-layout-styles shared-styles buttons-styles page-content-header-slotted-styles">
      :host {
        display: block;
        min-height: calc(100vh - 120px);
      }

      .no-capitalization {
        text-transform: none;
      }

      .export-dd {
        width: 105px;
      }

      paper-menu-button {
        --paper-menu-button: {
          padding: 8px 0 0 0;
        };
      }

      #pdExportMenuBtn paper-item {
        --paper-item-selected: {
          font-weight: normal !important;
        };
        /* Prevent first item highlighted by default */
        --paper-item-focused-before: {
          background: none;
          opacity: 0;
        };
        --paper-item-focused-after: {
          background: none;
          opacity: 0;
        }
      }

    </style>

    <app-route
        route="{{route}}"
        pattern="/list"
        query-params="{{listPageQueryParams}}"
        active="{{listActive}}"></app-route>

    <app-route
        route="{{route}}"
        pattern="/:id/:tab"
        active="{{tabsActive}}"
        data="{{routeData}}"></app-route>

    <page-content-header with-tabs-visible="[[tabsActive]]">
      <div slot="page-title">
        <template is="dom-if" if="[[listActive]]">
          PD/SSFAs
        </template>
        <template is="dom-if" if="[[tabsActive]]">
          <span class="no-capitalization" hidden$="[[!newInterventionActive]]">
            Add Programme Document or SSFA
          </span>
          <span hidden$="[[newInterventionActive]]">
            <a class="primary"
               href$="[[rootPath]]partners/[[intervention.partner_id]]/overview"
               target="_blank">[[intervention.partner]]</a>
            <span>: [[intervention.number]]</span>
          </span>
        </template>
      </div>

      <div slot="title-row-actions" class="content-header-actions export-options">

        <div class="action" hidden$="[[!listActive]]">
          <paper-menu-button id="pdExportMenuBtn" close-on-activate>
            <paper-button slot="dropdown-trigger">
              <iron-icon icon="file-download"></iron-icon>
              Export
            </paper-button>
            <paper-listbox slot="dropdown-content">
              <paper-item on-tap="_exportPdBudget">[[CONSTANTS.PD_EXPORT_TYPES.PdBudget]] Export</paper-item>
              <paper-item on-tap="_exportPdResult">[[CONSTANTS.PD_EXPORT_TYPES.PdResult]] Export</paper-item>
              <paper-item on-tap="_exportPdLocations">[[CONSTANTS.PD_EXPORT_TYPES.PdLocations]] Export</paper-item>
            </paper-listbox>
          </paper-menu-button>
        </div>

        <div class="action" hidden$="[[!_showAddNewIntervBtn(listActive, permissions)]]">
          <paper-button class="primary-btn with-prefix" on-tap="_goToNewInterventionPage">
            <iron-icon icon="add"></iron-icon>
            Add new PD/SSFA
          </paper-button>
        </div>
      </div>

      <template is="dom-if" if="[[_showPageTabs(activePage)]]">
        <etools-tabs slot="tabs"
                     tabs="[[interventionTabs]]"
                     active-tab="{{routeData.tab}}"
                     on-iron-select="_handleTabSelectAction"></etools-tabs>
      </template>
    </page-content-header>

    <div id="main">
      <div id="pageContent">

        <etools-error-messages-box id="errorsBox"
                                   title$="[[errorMsgBoxTitle]]"
                                   errors="{{serverErrors}}"></etools-error-messages-box>

        <template is="dom-if" if="[[_pageEquals(activePage, 'list')]]">
          <interventions-list id="list"
                              name="list"
                              active="[[listActive]]"
                              csv-download-qs="{{csvDownloadQs}}"
                              url-params="[[preservedListQueryParams]]">
          </interventions-list>
        </template>

        <template is="dom-if" if="[[_visibleTabContent(activePage, 'overview', newInterventionActive)]]">
          <intervention-overview name="overview"
                                 intervention="[[intervention]]"
                                 intervention-agreement="[[agreement]]">
          </intervention-overview>
        </template>

        <template is="dom-if" if="[[_pageEquals(activePage, 'details')]]">
          <intervention-details id="interventionDetails"
                                name="details"
                                intervention="{{intervention}}"
                                new-intervention="[[newInterventionActive]]"
                                original-intervention="[[originalIntervention]]"
                                user-edit-permission="[[_hasEditPermissions(permissions, intervention)]]">
          </intervention-details>
        </template>

        <template is="dom-if" if="[[_pageEquals(activePage, 'review-and-sign')]]">
          <intervention-review-and-sign id="interventionReviewAndSign"
                                        name="review-and-sign"
                                        intervention="{{intervention}}"
                                        original-intervention="[[originalIntervention]]"
                                        agreement="[[agreement]]">
          </intervention-review-and-sign>
        </template>

        <template is="dom-if" if="[[_pageEquals(activePage, 'attachments')]]">
          <intervention-attachments id="intervAttachments"
                                    name="attachments"
                                    active="[[_isAttachementsTabActive(routeData.tab)]]"
                                    intervention="[[intervention]]"
                                    file-model="[[_getAttachmentModel(intervention.id)]]"
                                    attachments="{{intervention.attachments}}"
                                    edit-mode="[[!_isAttachmentsTabReadonly(permissions, intervention, intervention.status)]]">
          </intervention-attachments>
        </template>

        <template is="dom-if" if="[[_visibleTabContent(activePage, 'reports', newInterventionActive)]]" restamp>
          <intervention-reports id="interventionReports"
                                name="reports"
                                intervention-id="[[intervention.id]]"
                                active="[[_pageEquals(activePage, 'reports')]]"
                                prev-params="{{reportsPrevParams}}"></intervention-reports>
        </template>

        <template is="dom-if" if="[[_visibleTabContent(activePage, 'progress', newInterventionActive)]]" restamp>
          <intervention-progress name="progress"
                                 intervention-id="[[intervention.id]]"></intervention-progress>
        </template>

        <intervention-item-data id="interventionData"
                                intervention="{{intervention}}"
                                intervention-id="[[selectedInterventionId]]"
                                original-intervention="[[originalIntervention]]"
                                error-event-name="intervention-save-error"></intervention-item-data>

        <agreement-item-data id="agreement"
                             agreement-id="[[intervention.agreement]]"
                             agreement="{{agreement}}"></agreement-item-data>

      </div> <!-- main page content end -->

      <!-- sidebar content start -->
      <template is="dom-if" if="[[_showInterventionSidebarStatus(listActive, tabAttached, activePage)]]">
        <div id="sidebar">
          <intervention-status status="[[intervention.status]]"
                               active="[[!listActive]]"
                               active-tab="[[routeData.tab]]"
                               intervention-id="[[intervention.id]]"
                               new-intervention="[[newInterventionActive]]"
                               intervention-agreement-status="[[agreement.status]]"
                               on-save-intervention="_validateAndSaveIntervention"
                               on-update-intervention-status="_updateInterventionStatus"
                               on-delete-intervention="_deleteIntervention"
                               on-terminate-pd="_terminatePd"
                               edit-mode="[[_hasEditPermissions(permissions, intervention)]]">
          </intervention-status>
        </div> <!-- sidebar content end -->
      </template>

    </div>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsMixins.DynamicDialogMixin
     * @appliesMixin EtoolsPmpApp.Mixins.ReduxInAmendmentMixin
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.EnvironmentFlags
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.ScrollControl
     * @appliesMixin EtoolsPmpApp.Mixins.ModuleMainElCommonFunctionality
     * @appliesMixin EtoolsPmpApp.Mixins.ModuleRouting
     * @appliesMixin EtoolsPmpApp.Mixins.InterventionPageTabs
     * @appliesMixin EtoolsPmpApp.Mixins.InterventionPermissions
     * @appliesMixin EtoolsPmpApp.Mixins.SaveIntervention
     * @appliesMixin EtoolsPmpApp.Mixins.Constants
     */
    class InterventionsModule extends EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsMixins.DynamicDialogMixin,
      EtoolsPmpApp.Mixins.ReduxInAmendmentMixin,
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.EnvironmentFlags,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.ScrollControl,
      EtoolsPmpApp.Mixins.ModuleMainElCommonFunctionality,
      EtoolsPmpApp.Mixins.ModuleRouting,
      EtoolsPmpApp.Mixins.InterventionPageTabs,
      EtoolsPmpApp.Mixins.InterventionPermissions,
      EtoolsPmpApp.Mixins.SaveIntervention,
      EtoolsPmpApp.Mixins.Constants
    ], Polymer.Element) {

      static get is() {
        return 'interventions-module';
      }

      static get properties() {
        return {
          /**
           * User permissions at this level
           * TODO: rename to userPermissions
           */
          permissions: {
            type: Object
          },
          selectedInterventionId: {
            type: Number
          },
          intervention: {
            type: Object,
            notify: true
          },
          originalIntervention: {
            type: Object
          },
          agreement: {
            type: Object
          },
          csvDownloadQs: {
            type: String
          },
          newInterventionModel: {
            type: Object,
            value: {
              id: null, // Required null, not undefined in order to trigger the observer
              agreement: undefined,
              document_type: undefined,
              country_programme: undefined,
              number: undefined,
              reference_number_year: null,
              prc_review_attachment: null,
              signed_pd_attachment: null,
              title: undefined,
              status: '',
              start: null,
              end: null,
              submitted_to_prc: false,
              submission_date_prc: undefined,
              review_date_prc: undefined,
              submission_date: undefined,
              signed_by_unicef_date: undefined,
              signed_by_partner_date: undefined,
              unicef_signatory: undefined,
              unicef_focal_points: [],
              partner_focal_points: [],
              partner_authorized_officer_signatory: undefined,
              offices: [],
              frs: [],
              frs_details: {
                currencies_match: false,
                frs: [],
                total_frs_amt: 0,
                earliest_start_date: null,
                latest_end_date: null
              },
              sections: [],
              flat_locations: [],
              result_links: [],
              planned_budget: {},
              planned_visits: [],
              in_amendment: false,
              amendments: [],
              attachments: [],
              distributions: [],
              activation_letter_attachment: null
            }
          },
          newInterventionActive: {
            type: Boolean,
            computed: '_updateNewItemPageFlag(routeData, listActive)'
          },
          editMode: {
            type: Boolean
          },
          _redirectToNewIntervPageInProgress: Boolean,
          errorMsgBoxTitle: {
            type: String,
            value: 'Errors Saving PD/SSFA'
          },
          saved: {
            type: Object,
            value: function() {
              return {
                interventionId: null,
                justSaved: false
              };
            }
          },
          _forceDetUiValidationOnAttach: Boolean,
          _forceReviewUiValidationOnAttach: Boolean,
          reportsPrevParams: Object,

          moduleName: {
            type: String,
            value: 'interventions'
          },
          // This shouldn't be neccessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          rootPath: String
        };
      }

      static get observers() {
        return [
          '_pageChanged(listActive, tabsActive, routeData)',
          '_observeRouteDataId(routeData.id)',
          '_interventionChanged(intervention, permissions)',
          '_amendmentModeChanged(intervention.in_amendment, tabAttached, listActive)'
        ];
      }

      _initInterventionsModuleListeners() {
        this.addEventListener('intervention-save-error', this._interventionSaveErrors.bind(this));
        this.addEventListener('tab-content-attached', this._interventionPageAttached.bind(this));
        this.addEventListener('trigger-intervention-loading-msg',
            this._handleInterventionSelectionLoadingMsg.bind(this));
        this.addEventListener('refresh-intervention-permissions', this._refreshInterventionPermissions.bind(this));
        this.addEventListener('new-amendment-added', this._amendmentAddedHandler.bind(this));
      }

      ready() {
        super.ready();
        if (this.newInterventionActive) {
          this._prepareNewInterventionObj();
        }
        let dialog = document.createElement('div');
        dialog.setAttribute('id', 'finalizeAmendmentConfirmation');
        dialog.innerHTML = 'All fields in the details tab will now be closed for editing. Do you want to continue?';
        this.finalizeAmendmentConfirmationDialog = this.createDialog('Finalize Amendment', 'md', 'Yes', 'Cancel',
            this._finalizeAmendmentConfirmationCallback.bind(this), dialog);

        this._initInterventionsModuleListeners();
      }

      connectedCallback() {
        super.connectedCallback();
        // deactivate main page loading msg triggered in app-shell
        this.fireEvent('global-loading', {active: false, loadingSource: 'main-page'});
        this._showInterventionPageLoadingMessage();
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        if (this.finalizeAmendmentConfirmationDialog) {
          this.removeDialog(this.finalizeAmendmentConfirmationDialog);
        }
      }

      _showFinalizeAmendmentDialog() {
        if (this.finalizeAmendmentConfirmationDialog) {
          this.finalizeAmendmentConfirmationDialog.opened = true;
        }
      }

      _amendmentModeChanged(amendmentModeActive, tabAttached, listActive) {
        if (typeof amendmentModeActive === 'undefined' || !this.intervention || (!tabAttached && !listActive)) {
          return;
        }
        if (listActive) {
          this.updateReduxInAmendment(false);
          return;
        }
        if (this.selectedInterventionId === this.intervention.id) {
          this.updateReduxInAmendment(amendmentModeActive);
        }
      }

      _amendmentAddedHandler(event) {
        event.stopImmediatePropagation();
        // redirect to the details tab for editing
        this.set('routeData.tab', 'details');
      }

      _interventionChanged(intervention, permissions) {
        if (typeof intervention === 'undefined' || typeof permissions === 'undefined') {
          return;
        }
        this._displayAnyMigrationErrors(intervention);
        this._makeSureMigrationErrorIsNotShownAgainAfterSave(intervention);

        this.set('originalIntervention', JSON.parse(JSON.stringify(intervention)));
        if (!_.isEmpty(intervention)) {
          // set edit permissions
          let isNewIntervention = this._redirectToNewIntervPageInProgress || this.newInterventionActive;
          if (isNewIntervention) {
            this.set('intervention.reference_number_year', new Date().getFullYear());
          }
          this.checkAndUpdateInterventionPermissions(intervention,
              this._hasEditPermissions(permissions), isNewIntervention);
          setTimeout(() => {
            // ensure intervention get/save/change status loading msgs close
            this.fireEvent('global-loading', {active: false, loadingSource: 'pd-ssfa-data'});
          }, 1000);
        }
      }

      _displayAnyMigrationErrors(intervention) {
        if (intervention.metadata && intervention.metadata.error_msg && intervention.metadata.error_msg.length) {
          if (this.saved.interventionId !== intervention.id && !this.saved.justSaved) {
            // Avoid showing msg again after save
            this.set('errorMsgBoxTitle',
                'eTools validation code has been upgraded and this record is now considered invalid due to:');
            this.fireEvent('set-server-errors', intervention.metadata.error_msg);
          }
        }
      }

      /* Show metadata error message on intervention detail 'page load'*/
      _makeSureMigrationErrorIsNotShownAgainAfterSave(intervention) {
        if (this.saved.interventionId !== intervention.id) {
          this.saved.justSaved = false;
        }
        this.saved.interventionId = intervention.id;
      }

      _isAttachmentsTabReadonly(permissions, intervention) {
        if (typeof permissions === 'undefined' || typeof intervention === 'undefined') {
          return false;
        }
        if (!this._hasEditPermissions(permissions, intervention)) {
          return true;
        }
        return (['suspended', 'terminated'].indexOf(intervention.status) > -1);
      }

      _isPrpTab(tabName) {
        return ['reports', 'progress'].indexOf(tabName) > -1;
      }

      _canAccessPdTab(tabName) {
        if (this._isPrpTab(tabName)) {
          return this.showPrpReports();
        } else {
          // not prp tab, allow access
          return true;
        }
      }

      _resetRedirectToNewInterventionFlag() {
        if (this._redirectToNewIntervPageInProgress) {
          this.set('_redirectToNewIntervPageInProgress', false);
        }
      }

      _pageChanged(listActive, tabsActive, routeData) {
        // Using isActiveModule will prevent wrong page import
        if (!this.isActiveModule() || (!listActive && !tabsActive)) {
          return;
        }

        this.scrollToTopOnCondition(!listActive);

        if (listActive) {
          this.reportsPrevParams = {};
        }
        this._pageChangeDebouncer = Polymer.Debouncer.debounce(this._pageChangeDebouncer,
            Polymer.Async.timeOut.after(10),
            () => {
              let fileImportDetails = {
                filenamePrefix: 'intervention',
                baseUrl: '../app-elements/interventions/',
                importErrMsg: 'Interventions page import error occurred',
                errMsgPrefixTmpl: '[intervention(s) ##page##]',
                loadingMsgSource: 'interv-page'
              };
              this.setActivePage(listActive, routeData.tab, fileImportDetails, this._canAccessPdTab,
                  null, this._resetRedirectToNewInterventionFlag);
            });
      }

      _observeRouteDataId(id) {
        // Using isActiveModule will prevent PD details/reports/progress request with the wrong id (report id)
        if (!this.isActiveModule() || typeof id === 'undefined') {
          return;
        }
        setTimeout(() => {
          id = parseInt(id, 10);
          if (isNaN(id)) {
            id = null;
          }
          if (this.selectedInterventionId !== id) {
            this.set('selectedInterventionId', id);
            this.updateReduxInAmendment(false);
          }
        }, 0);
      }

      _finalizeAmendmentConfirmationCallback() {
        if (event.detail.confirmed) {
          this.set('intervention.in_amendment', false);
          this._validateAndSaveIntervention(null).then((successfull) => {
              if (!successfull) {
                // if save fails restore in_amendment flag
                this.set('intervention.in_amendment', true);
              }
            });
        }
      }

      _isNewIntervention() {
        return !this.intervention.id;
      }

      _refreshInterventionPermissions(e) {
        e.stopImmediatePropagation();
        this.$.interventionData._reqInterventionDataWithoutRespHandling()
            .then((resp) => {
              if (!_.isEmpty(resp.permissions)) {
                this.set('intervention.permissions', resp.permissions);
                this.set('intervention.in_amendment', resp.in_amendment);
                this.set('originalIntervention.in_amendment', resp.in_amendment);
                this.updateReduxPermissionsData(resp.permissions);
              }
            })
            .then(() => {
              this.checkAndUpdatePlannedBudgetPermissions(this.intervention.status);
            });
      }

      _updateInterventionStatus(e) {
        e.stopImmediatePropagation();
        this.$.interventionData.updateInterventionStatus(e.detail);
      }

      _deleteIntervention(e) {
        this.$.interventionData.deleteIntervention(e.detail.id);
      }

      _userHasEditPermissions(permissions) {
        return permissions && permissions.editInterventionDetails === true &&
            (permissions.partnershipManager || permissions.PME);
      }

      _hasEditPermissions(permissions, intervention) {
        if (permissions && permissions.editInterventionDetails === true) {
          if (intervention) {
            if (!(permissions.partnershipManager || permissions.PME) &&
                (!intervention.status ||
                 intervention.status !== this.CONSTANTS.STATUSES.Draft.toLowerCase())) {
              // other users than partnershipManager or PME will be able to edit only if intervention status is draft
              return false;
            }
          }
          return true;
        }
        return false;
      }

      _getAttachmentModel(interventionId) {
        return {
          id: null,
          created: null,
          intervention: interventionId ? interventionId : null,
          type: null
        };
      }

      _goToNewInterventionPage() {
        // go to new intervention
        if (!this._hasEditPermissions(this.permissions)) {
          return;
        }
        this.set('_redirectToNewIntervPageInProgress', true);
        this._prepareNewInterventionObj();
        this.set('selectedInterventionId', null);
        this.fireEvent('update-main-path', {path: 'interventions/new/details'});
        this._handleInterventionSelectionLoadingMsg();
      }

      _prepareNewInterventionObj() {
        this.set('intervention', JSON.parse(JSON.stringify(this.newInterventionModel)));
      }

      _visibleTabContent(activePage, expectedPage, newInterventionActive) {
        return this._pageEquals(activePage, expectedPage) && !newInterventionActive;
      }

      /**
       * Go to details page once the new intervention has been saved
       */
      _newInterventionSaved(intervention) {
        this.fireEvent('update-main-path', {path: 'interventions/' + intervention.id + '/details'});
      }

      _showAddNewIntervBtn(listActive, permissions) {
        return (listActive && this._hasEditPermissions(permissions));
      }

      _interventionSaveErrors(event) {
        event.stopImmediatePropagation();
        if ((event.detail instanceof Array && event.detail.length > 0) ||
            (typeof event.detail === 'string' && event.detail !== '')) {
          this.fireEvent('set-server-errors', event.detail);
          this.scrollToTop();
        }
      }

      _isAttachementsTabActive(activeTab) {
        return activeTab === 'attachments';
      }

      _handleTabSelectAction(e) {
        this._showTabChangeLoadingMsg(e, 'interv-page', 'intervention-');
      }

      _interventionPageAttached() {
        // force styles updates according with intervention permissions
        // (event handled is triggered by interventions tab elements)
        this._updateRelatedPermStyles(false, this._forceDetUiValidationOnAttach, this._forceReviewUiValidationOnAttach);
      }

      _showInterventionSidebarStatus(listActive, tabAttached, activePage) {
        return (['reports', 'progress'].indexOf(activePage) > -1)
            ? false
            : this._showSidebarStatus(listActive, tabAttached);
      }

      /**
       * Loading msg used stamping tabs elements (disabled in each tab main element attached callback)
       */
      _showInterventionPageLoadingMessage() {
        this.fireEvent('global-loading', {
          message: 'Loading...',
          active: true,
          loadingSource: 'interv-page'
        });
      }

      _handleInterventionSelectionLoadingMsg() {
        this._showTabChangeLoadingMsg(null, 'interv-page', 'intervention-', 'details');
      }

      _exportPdBudget() {
        this._exportPD(this.getEndpoint('interventions').url);
      }

      _exportPdResult() {
        this._exportPD(this.getEndpoint('resultExports').url);
      }

      _exportPdLocations() {
        this._exportPD(this.getEndpoint('pdLocationsExport').url);
      }

      _exportPD(endpoint) {
        let csvDownloadUrl = endpoint + '?' + this.csvDownloadQs;
        window.open(csvDownloadUrl, '_blank');
      }

    }

    window.customElements.define(InterventionsModule.is, InterventionsModule);
  </script>
</dom-module>
