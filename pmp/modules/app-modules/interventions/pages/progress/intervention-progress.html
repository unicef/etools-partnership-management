<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">

<link rel="import" href="../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import"
      href="../../../../../../bower_components/etools-currency-amount-input/mixins/etools-currency-mixin.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../scripts/lodash.html">

<link rel="import" href="../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../layout/components/etools-form-element-wrapper.html">
<link rel="import" href="../../../../layout/components/etools-progress-bar.html">
<link rel="import" href="../../../../layout/components/etools-ram-indicators.html">
<link rel="import" href="../../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../../mixins/date-mixin.html">
<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/utils-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">

<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/list-filter-styles.html">
<link rel="import" href="../../../../styles/page-common-styles.html">

<link rel="import" href="../../../reports/components/report-status.html">
<link rel="import" href="../../../reports/pages/progress/components/indicator-report-target.html">

<dom-module id="intervention-progress">
  <template strip-whitespace>
    <style
        include="page-common-styles shared-styles data-table-styles grid-layout-styles list-filter-styles paper-material-styles">

      #progress-summary etools-progress-bar {
        margin-top: 16px;
      }

      #cash-progress etools-form-element-wrapper {
        width: 140px;
      }

      #cash-progress etools-form-element-wrapper:first-child {
        margin-right: 24px;
      }

      etools-data-table-row {
        --list-row-collapse-wrapper: {
          padding: 0;
        };
      }

      .lower-result-status-date {
        margin-left: 4px;
      }

      .indicator-report {
        padding-bottom: 0;
      }

      .indicator-report,
      .progress-details {
        padding-left: 58px;
      }

      .progress-details + .indicator-report {
        border-top: 1px solid var(--list-divider-color);
      }

      .report-progress-bar {
        @apply --layout-flex;
        --etools-progress-bar-width: 100%;
      }

      .progress-details {
        @apply --layout-end-justified;
        padding-top: 0;
      }

      indicator-report-target {
        --indicator-report-target-row: {
          padding-right: 72px;
        }
      }

      etools-ram-indicators {
        border-top: 1px solid var(--list-divider-color);
        border-bottom: 1px solid var(--list-divider-color);
      }

      @media print {
        .indicator-report {
          @apply --layout-horizontal;
        }

        .indicator-report .col-data {
          max-width: calc(100% - 224px);
          flex: none;
          width: auto;
        }

        .indicator-report .progress-bar {
          min-width: 200px;
        }

        .indicator-report .col-data:first-child {
          margin-right: 24px;
        }

        .target-details {
          display: flex;
          width: auto;
          max-width: none;
          margin-top: 16px;
          flex: 1;
        }

        .progress-details {
          @apply --layout-start-justified;
        }
      }
    </style>

    <div id="progress-summary" class="content-section paper-material" elevation="1">
      <div class="row-h">
        <div class="layout-vertical col-4">
          <etools-form-element-wrapper label="PD Duration"
                                       value="[[_getPdDuration(progress.start_date, progress.end_date)]]">
          </etools-form-element-wrapper>
          <etools-progress-bar value="[[pdProgress]]" no-decimals></etools-progress-bar>
        </div>
        <div class="layout-vertical col-4">
          <div class="layout-horizontal" id="cash-progress">
            <etools-form-element-wrapper label="Cash Transfered"
                                         value="[[latestAcceptedPr.programme_document.funds_received_to_date_currency]]
                                         [[displayCurrencyAmount(latestAcceptedPr.programme_document.funds_received_to_date, '0', 0)]]">
            </etools-form-element-wrapper>
            <etools-form-element-wrapper label="UNICEF Cash"
                                         value="[[latestAcceptedPr.programme_document.total_unicef_cash_currency]]
                                         [[displayCurrencyAmount(latestAcceptedPr.programme_document.total_unicef_cash, '0', 0)]]">
            </etools-form-element-wrapper>
          </div>
          <etools-progress-bar value="[[cashProgress]]" no-decimals></etools-progress-bar>
        </div>
        <div class="col col-4">
          <etools-form-element-wrapper label="Overall PD/SSFA Rating by UNICEF"
                                       value="[[_getOverallPdStatusDate(latestAcceptedPr.review_date)]]"
                                       no-placeholder>
            <report-status status="[[latestAcceptedPr.review_overall_status]]" slot="prefix"></report-status>
          </etools-form-element-wrapper>
        </div>
      </div>
    </div>

    <etools-content-panel class="content-section" panel-title="Results reported">
      <div class="row-h" hidden$="[[!_emptyList(progress.details.cp_outputs)]]">
        <p>There are no results to show.</p>
      </div>
      <template is="dom-repeat" items="[[progress.details.cp_outputs]]">
        <div class="row-v row-second-bg">
          <strong>CP Output: [[item.title]]</strong>
        </div>

        <!-- RAM indicators display -->
        <etools-ram-indicators class="row-h" intervention-id="[[interventionId]]"
                               cp-id="[[item.external_cp_output_id]]"></etools-ram-indicators>

        <div class="row-h" hidden$="[[!_emptyList(item.ll_outputs)]]">
          <p>There are no PD Outputs or SSFA Expected Results.</p>
        </div>

        <div class="lower-results-table" hidden$="[[_emptyList(item.ll_outputs)]]">

          <etools-data-table-header id="listHeader" no-title>
            <etools-data-table-column class="col-9">
              PD Outputs or SSFA Expected Results
            </etools-data-table-column>
            <etools-data-table-column class="col-3">
              Current progress (Last Reported on)
            </etools-data-table-column>
          </etools-data-table-header>

          <template is="dom-repeat" items="[[item.ll_outputs]]" as="lowerResult">
            <etools-data-table-row>
              <div slot="row-data">
                <span class="col-data col-9">
                  [[lowerResult.title]]
                </span>
                <span class="col-data col-3">
                  <report-status status="[[_getLowerResultStatus(lowerResult.id)]]"></report-status>
                  <span class="lower-result-status-date">[[_getLowerResultStatusDate(lowerResult.id)]]</span>
                </span>
              </div>
              <div slot="row-data-details">
                <div class="row-details-content flex-c">
                  <div class="row-h" hidden$="[[_countIndicatorReports(lowerResult.id)]]">
                    No indicators on this PD Output or SSFA Expected Result
                  </div>
                  <template is="dom-repeat" items="[[_getIndicatorsReports(lowerResult.id)]]" as="indicatorReport">
                    <div class="row-h indicator-report">
                      <div class="col-data col-9">
                        [[_ternary(indicatorReport.reportable.blueprint.unit, 'number', '#', '%')]]
                        [[indicatorReport.reportable.blueprint.title]]
                      </div>
                      <div class="col-data col-3 progress-bar">
                        <etools-progress-bar class="report-progress-bar"
                                             value="[[indicatorReport.reportable.progress_percentage]]">
                        </etools-progress-bar>
                      </div>
                    </div>
                    <div class="row-h progress-details">
                      <div class="layout-vertical col-5 target-details">
                        <indicator-report-target
                            class="print-inline"
                            display-type="[[indicatorReport.reportable.blueprint.display_type]]"
                            target="[[indicatorReport.reportable.target]]"
                            cumulative-progress="[[_ternary(indicatorReport.reportable.blueprint.display_type, 'number',
                            indicatorReport.reportable.achieved.v, indicatorReport.reportable.achieved.c)]]"
                            achievement="[[_ternary(indicatorReport.reportable.blueprint.display_type, 'number',
                            indicatorReport.total.v, indicatorReport.total.c)]]"></indicator-report-target>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </etools-data-table-row>
          </template>

        </div>

      </template>
    </etools-content-panel>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsMixins.EtoolsCurrency
     * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.Date
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.Utils
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const InterventionProgressMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsMixins.EtoolsCurrency,
      EtoolsPmpApp.Mixins.AjaxErrorsParser,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.Date,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.Utils,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin InterventionProgressMixins
     */
    class InterventionProgress extends InterventionProgressMixins {

      static get is() {
        return 'intervention-progress';
      }

      static get properties() {
        return {
          interventionId: {
            type: Number
          },
          pdProgress: {
            type: Number,
            computed: '_getTimeProgress(progress.start_date, progress.end_date)'
          },
          cashProgress: {
            type: Number,
            computed: '_getCashProgress(latestAcceptedPr.programme_document.funds_received_to_date, ' +
            'latestAcceptedPr.programme_document.total_unicef_cash)'
          },
          progress: {
            type: Object,
            observer: '_progressDataObjChanged'
          },
          latestAcceptedPr: {
            type: Object,
            computed: '_computeLatestAcceptedPr(progress)'
          },
          indicatorReports: {
            type: Array,
            value: []
          }
        };
      }

      static get observers() {
        return [
          // `prpCountries` and `currentUser` are defined in endpoint behavior
          '_requestProgressData(interventionId, prpCountries, currentUser)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for progress tab elements load,
         * triggered by parent element on stamp or by tap event on tabs
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'interv-page'});
        this.fireEvent('tab-content-attached');
      }

      _requestProgressData(id, prpCountries, currentUser) {
        if (!id || _.isEmpty(prpCountries) || _.isEmpty(currentUser)) {
          return;
        }
        let self = this;

        self.fireEvent('global-loading', {
          message: 'Loading...',
          active: true,
          loadingSource: 'pd-progress'
        });

        this.fireRequest('interventionProgress', {pdId: id}).then(function(response) {
          self.set('progress', response);
          self.fireEvent('global-loading', {active: false, loadingSource: 'pd-progress'});
        }).catch(function(error) {
          let errMsg = 'PD/SSFA progress request failed!';
          self.logError(errMsg, 'intervention-progress', error);
          self.parseRequestErrorsAndShowAsToastMsgs(error, self);
          self.fireEvent('global-loading', {active: false, loadingSource: 'pd-progress'});
        });
      }

      _emptyList(dataSet) {
        return _.isEmpty(dataSet);
      }

      _computeLatestAcceptedPr(progress) {
        return (progress && progress.latest_accepted_pr) ? progress.latest_accepted_pr : null;
      }

      _progressDataObjChanged(progress) {
        if (!progress) {
          this.set('indicatorReports', []);
          return;
        }
        let self = this;
        if (!this._emptyList(progress.details.cp_outputs)) {
          progress.details.cp_outputs.forEach(function(result) {
            if (!self._emptyList(result.ll_outputs)) {
              result.ll_outputs.forEach(function(lowerResult) {
                self._prepareindicatorReportsData(lowerResult.id, progress.latest_accepted_pr_indicator_reports);
              });
            }
          });
        }
      }

      _prepareindicatorReportsData(lowerResultId, progressIndicatorReports) {
        let indicatorReportData = {
          lowerResultId: lowerResultId,
          reports: []
        };
        if (this._emptyList(progressIndicatorReports)) {
          return;
        }
        indicatorReportData.reports = progressIndicatorReports.filter(function(report) {
          return report.reportable_object_id === lowerResultId;
        });
        this.push('indicatorReports', indicatorReportData);
      }

      _countIndicatorReports(lowerResultId) {
        return !this._emptyList(this.indicatorReports) &&
            !!this.indicatorReports.find(function(indReports) {
              return indReports.lowerResultId === lowerResultId;
            });
      }

      _getIndicatorsReports(lowerResultId) {
        if (this._emptyList(this.indicatorReports)) {
          return [];
        }
        let indicatorsReports = this.indicatorReports.filter(function(indReports) {
          return indReports.lowerResultId === lowerResultId;
        });
        return indicatorsReports.length === 0 ? [] : indicatorsReports[0].reports;
      }

      /**
       * Assuming all indicators reports are already sort by date desc
       */
      _getLatestIndicatorReport(lowerResultId) {
        if (!this._emptyList(this.indicatorReports)) {
          let indReports = this.indicatorReports.find(function(indReports) {
            return indReports.lowerResultId === lowerResultId;
          });
          if (indReports && indReports.reports[0]) {
            return indReports.reports[0];
          }
        }
        return null;
      }

      _getLowerResultStatus(lowerResultId) {
        let status = null;
        let latestIndReport = this._getLatestIndicatorReport(lowerResultId);
        if (latestIndReport) {
          status = latestIndReport.overall_status;
        }
        return status;
      }

      _getLowerResultStatusDate(lowerResultId) {
        let resultStatusDateStr = '';
        let latestIndReport = this._getLatestIndicatorReport(lowerResultId);
        if (latestIndReport) {
          let d = this._convertToDisplayFormat(latestIndReport.submission_date);
          resultStatusDateStr = '(' + this.prettyDate(d) + ')';
        }
        return resultStatusDateStr;
      }

      _getPdDuration(start, end) {
        start = this._convertToDisplayFormat(start) || 'N/A';
        end = this._convertToDisplayFormat(end) || 'N/A';
        return start + ' - ' + end;
      }

      _getTimeProgress(start, end) {
        let today = new Date();
        let startDt = this._EdgeAcceptableDateParse(start);
        let endDt = this._EdgeAcceptableDateParse(end);
        try {
          if (this.dateIsBetween(startDt, endDt, today)) {
            let intervalTotalDays = this.dateDiff(startDt, endDt);
            let intervalDaysCompleted = this.dateDiff(startDt, today);
            return intervalDaysCompleted * 100 / intervalTotalDays;
          }
        } catch (err) {
          this.logWarn('Time progress compute error', 'intervention-progress', err);
        }
        // if end date is valid and is past date or today's date, progress should be 100%
        if (this.isValidDate(endDt) &&
            (this.dateIsAfter(today, endDt) || this.datesAreEqual(datetoday === endDt))) {
          return 100;
        }
        return 0;
      }

      _getCashProgress(actual, total) {
        return parseFloat(actual) * 100 / parseFloat(total);
      }

      _getOverallPdStatusDate(date) {
        return date ? ('(' + this._convertToDisplayFormat(date) + ')') : '';
      }

      _convertToDisplayFormat(strDt) {
        return moment(this._EdgeAcceptableDateParse(strDt)).format('D MMM YYYY');
      }

    }

    window.customElements.define(InterventionProgress.is, InterventionProgress);
  </script>
</dom-module>
