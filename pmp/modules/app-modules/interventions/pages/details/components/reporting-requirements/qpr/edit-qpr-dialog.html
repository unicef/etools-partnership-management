<link rel="import" href="../../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../../../../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../../../../../../bower_components/etools-datepicker/etools-simple-datepicker.html">
<link rel="import" href="../../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../../../../config/app-constants.html">
<link rel="import" href="../../../../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../../../../mixins/date-mixin.html">
<link rel="import" href="../../../../../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../../../../styles/buttons-styles.html">
<link rel="import" href="qpr-list.html">

<dom-module id="edit-qpr-dialog">
  <template strip-whitespace>
    <style include="grid-layout-styles buttons-styles">
      *[hidden] {
        display: none !important;
      }

      #qpr-edit-info {
        margin-right: 24px;
      }

      qpr-list {
        margin-top: 24px;
      }

      iron-label {
        margin-bottom: 24px;
      }

    </style>

    <etools-dialog id="editQprDialog"
                   size="lg"
                   dialog-title="Edit Quarterly Progress Reporting Requirements"
                   hidden$="[[addOrModifyQprDialogOpened]]"
                   on-confirm-btn-clicked="_saveModifiedQprData"
                   ok-btn-text="Save"
                   keep-dialog-open
                   spinner-text="Saving...">

      <div class="layout-horizontal">
        <span id="qpr-edit-info">All dates in the future can be edited before saving. | Or</span>
        <paper-button class="secondary-btn" on-click="_addNewQpr">
          Add Requirement
        </paper-button>
      </div>

      <qpr-list id="qprList"
                with-scroll
                qpr-data="[[qprData]]"
                edit-mode
                in-amendment="[[inAmendment]]"
                on-edit-qpr="_editQprDatesSet"
                on-delete-qpr="_deleteQprDatesSet"
                always-show-row-actions></qpr-list>

    </etools-dialog>

    <!-- add or edit a QPR row -->
    <etools-dialog id="addOrModifyQprDialog"
                   size="lg"
                   dialog-title="Edit Standard Quarterly Report Requirements"
                   opened="{{addOrModifyQprDialogOpened}}"
                   no-padding
                   on-close="_updateQprData"
                   ok-btn-text="Save">

      <div class="row-h" hidden$="[[_hideEditedIndexInfo(_qprDatesSetEditedIndex)]]">
        You are editing ID [[_getEditedQprDatesSetId(_qprDatesSetEditedIndex)]]
      </div>

      <div class="row-h">
        <div class="col layout-vertical">
          <iron-label for="startDate">
            Start Date
          </iron-label>
          <etools-simple-datepicker id="startDate"
                                    date="[[prepareDatepickerDate(_editedQprDatesSet.start_date)]]"
                                    pretty-date="{{_editedQprDatesSet.start_date}}"
                                    format="YYYY-MM-DD"></etools-simple-datepicker>
        </div>
        <div class="col layout-vertical">
          <iron-label for="endDate">
            End Date
          </iron-label>
          <etools-simple-datepicker id="endDate"
                                    date="[[prepareDatepickerDate(_editedQprDatesSet.end_date)]]"
                                    pretty-date="{{_editedQprDatesSet.end_date}}"
                                    format="YYYY-MM-DD"></etools-simple-datepicker>
        </div>
        <div class="col layout-vertical">
          <iron-label for="dueDate">
            Due Date
          </iron-label>
          <etools-simple-datepicker id="dueDate"
                                    date="[[prepareDatepickerDate(_editedQprDatesSet.due_date)]]"
                                    pretty-date="{{_editedQprDatesSet.due_date}}"
                                    format="YYYY-MM-DD"></etools-simple-datepicker>
        </div>
      </div>

    </etools-dialog>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.Date
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
     */
    class EditQprDialog extends EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.Date,
      EtoolsPmpApp.Mixins.Constants,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.AjaxErrorsParser
    ], Polymer.Element) {

      static get is() {
        return 'edit-qpr-dialog';
      }

      static get properties() {
        return {
          interventionId: Number,
          inAmendment: {
            type: Boolean,
            statePath: 'pageData.in_amendment'
          },
          qprData: {
            type: Array,
            value: []
          },
          addOrModifyQprDialogOpened: {
            type: Boolean,
            value: false
          },
          toastMsgLoadingSource: Object,
          _qprDatesSetModel: {
            type: Object,
            value: {
              start_date: null,
              end_date: null,
              due_date: null
            }
          },
          _editedQprDatesSet: Object,
          _qprDatesSetEditedIndex: {
            type: Number,
            value: -1
          }
        };
      }

      openQprDialog() {
        this.$.editQprDialog.opened = true;
      }

      closeQprDialog() {
        this.$.editQprDialog.opened = false;
      }

      _addNewQpr() {
        this.set('_editedQprDatesSet', Object.assign({}, this._qprDatesSetModel));
        this.set('addOrModifyQprDialogOpened', true);
      }

      _duplicateDueDate(dueDate) {
        let foundQpr = this.qprData.find(d => d.due_date === dueDate);
        if (this._qprDatesSetEditedIndex > -1 && foundQpr) {
          let foundQprIndex = this.qprData.indexOf(foundQpr);
          return foundQprIndex !== +this._qprDatesSetEditedIndex;
        }
        return !!foundQpr;
      }

      _updateQprData(e) {
        if (e.detail.confirmed) {
          if (this._duplicateDueDate(this._editedQprDatesSet.due_date)) {
            this.toastMsgLoadingSource.fireEvent('toast',
                {text: 'Requirement dates not added, selected Due Date is already in the list.', showCloseBtn: true});
            return;
          }
          if (this._qprDatesSetEditedIndex < 0) {
            // add
            this.push('qprData', this._editedQprDatesSet);
          } else {
            // edit
            this.splice('qprData', this._qprDatesSetEditedIndex, 1, this._editedQprDatesSet);
          }
        }
        this.set('_qprDatesSetEditedIndex', -1);
      }

      _editQprDatesSet(e) {
        this.set('_qprDatesSetEditedIndex', e.detail.index);
        this.set('_editedQprDatesSet', Object.assign({}, this.qprData[this._qprDatesSetEditedIndex]));
        this.set('addOrModifyQprDialogOpened', true);
      }

      _deleteQprDatesSet(e) {
        this.splice('qprData', e.detail.index, 1);
      }

      _hideEditedIndexInfo(index) {
        return index === -1;
      }

      _getEditedQprDatesSetId(index) {
        return this.$.qprList.getIndex(index, this.qprData.length);
      }

      _saveModifiedQprData() {
        let endpoint = this.getEndpoint('reportingRequirements', {
          intervId: this.interventionId,
          reportType: this.CONSTANTS.REQUIREMENTS_REPORT_TYPE.QPR
        });
        let dialog = this.$.editQprDialog;
        dialog.startSpinner();
        this.sendRequest({
          method: 'POST',
          endpoint: endpoint,
          body: {reporting_requirements: this.qprData}
        }).then((response) => {
          this.fireEvent('reporting-requirements-saved', response.reporting_requirements);
          dialog.stopSpinner();
          this.closeQprDialog();
        }).catch((error) => {
          this.logError('Failed to save/update qpr data!', 'edit-qpr-dialog', error);
          this.parseRequestErrorsAndShowAsToastMsgs(error, this.toastMsgLoadingSource);
          dialog.stopSpinner();
        });
      }

    }

    window.customElements.define(EditQprDialog.is, EditQprDialog);
  </script>
</dom-module>
