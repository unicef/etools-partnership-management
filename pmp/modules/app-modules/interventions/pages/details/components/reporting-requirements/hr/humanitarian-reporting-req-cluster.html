<link rel="import" href="../../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../../../../../scripts/lodash.html">

<link rel="import" href="../../../../../../../styles/grid-layout-styles.html">

<dom-module id="humanitarian-reporting-req-cluster">
  <template>
    <style include="grid-layout-styles data-table-styles">
      :host {
        display: block;
      }

      [hidden] {
        display: none !important;
      }
    </style>

    <div class="flex-c" hidden$="[[!reportingRequirements.length]]">
      <etools-data-table-header no-collapse
                                no-title class="w100">
        <etools-data-table-column class="col-2">Frequency</etools-data-table-column>
        <etools-data-table-column class="flex-c">Due Dates</etools-data-table-column>
      </etools-data-table-header>
      <template is="dom-repeat" items="{{reportingRequirements}}">
        <etools-data-table-row no-collapse>
          <div slot="row-data">
            <span class="col-data col-2">[[getFrequencyForDisplay(item.frequency)]]</span>
            <span class="col-data flex-c">[[getDatesForDisplay(item.cs_dates)]]</span>
          </div>
        </etools-data-table-row>
      </template>
    </div>

    <div class="row-h" hidden$="[[!_empty(reportingRequirements)]]">
      There are no cluster humanitarian report requirements set.
    </div>

  </template>


  <script>
    'use strict';
    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
     */
    const HumanitarianReportingReqClusterMixins = EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.AjaxErrorsParser
    ], Polymer.Element);

    /**
     * @customElement
     * @polymer
     */
    class HumanitarianReportingReqCluster extends HumanitarianReportingReqClusterMixins {
      static get is() {
        return 'humanitarian-reporting-req-cluster';
      }

      static get properties() {
        return {
          reportingRequirements: {
            type: Array,
            observer: 'reportingRequirementsChanged'
          },
          interventionId: {
            type: String,
            observer: 'interventionIdChanged'
          },
          requirementsCount: {
            type: Number,
            value: 0,
            notify: true
          },
          expectedResults: Array
        };
      }

      ready() {
        super.ready();
      }

      interventionIdChanged(newId) {
        if (!newId) {
          this.reportingRequirements = [];
          return;
        }

        let clusterIndicIds = this._getClusterIndicIds();
        if (_.isEmpty(clusterIndicIds)) {
          this.reportingRequirements = [];
          return;
        }

        this.fireRequest('hrClusterReportingRequirements', {}, {
          method: 'POST',
          body: {reportable_ids: clusterIndicIds}
        }).then((response) => {
          this.set('reportingRequirements', response);
        }).catch((error) => {
          this.logError('Failed to get hr cluster requirements from API!', 'humanitarian-reporting-req-cluster', error);
          this.parseRequestErrorsAndShowAsToastMsgs(error, this);
          this.reportingRequirements = [];
        });
      }

      _getClusterIndicIds() {
        if (_.isEmpty(this.expectedResults)) {
          return [];
        }
        let clusterIndicIds = [];
        this.expectedResults.forEach((r) => {
          return r.ll_results.forEach((llr) => {
            return llr.applied_indicators.forEach((i) => {
              if (i.cluster_indicator_id) {
                clusterIndicIds.push(i.cluster_indicator_id);
              }
            });
          });
        });

        return _.uniq(clusterIndicIds);
      }

      reportingRequirementsChanged(repReq) {
        this.set('requirementsCount', _.isEmpty(repReq) ? 0 : repReq.length);
      }

      getDatesForDisplay(dates) {
        if (!dates) {
          return '';
        }
        if (Array.isArray(dates)) {
          if (!dates.length) {
            return '';
          }
          let formatedDates = dates.map(d => this.getDateDisplayValue(d));
          return formatedDates.join(', ');
        } else {
          return this.getDateDisplayValue(dates);
        }
      }

      getFrequencyForDisplay(shortenFreq) {
        switch (shortenFreq) {
          case 'Wee':
            return 'Weekly';
          case 'Mon':
            return 'Monthly';
          case 'Qua':
            return 'Quarterly';
          case 'Csd':
            return 'Custom';
          default:
            return 'Custom';
        }
      }

      _empty(list) {
        return _.isEmpty(list);
      }
    }

    window.customElements.define(HumanitarianReportingReqCluster.is, HumanitarianReportingReqCluster);
  </script>
</dom-module>
