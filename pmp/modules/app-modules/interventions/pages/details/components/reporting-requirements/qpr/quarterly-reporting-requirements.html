<link rel="import" href="../../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../../../../mixins/event-helper-mixin.html">

<link rel="import" href="../../../../../../../styles/app-mixins.html">
<link rel="import" href="../../../../../../../styles/buttons-styles.html">
<link rel="import" href="../../../../../../../styles/grid-layout-styles.html">

<link rel="import" href="../mixins/generate-quarterly-reporting-requirements-mixin.html">
<link rel="import" href="../mixins/reporting-requirements-common-mixin.html">
<link rel="import" href="edit-qpr-dialog.html">
<link rel="import" href="qpr-list.html">

<dom-module id="quarterly-reporting-requirements">
  <template>
    <style include="buttons-styles grid-layout-styles">
      *[hidden] {
        display: none !important;
      }
    </style>

    <div class="flex-c" hidden$="[[_empty(reportingRequirements)]]">
      <qpr-list qpr-data="[[reportingRequirements]]"></qpr-list>
    </div>

    <div hidden$="[[!_empty(reportingRequirements)]]">
      <div class="row-h">
        There are no quarterly reporting requirements set.
      </div>
      <div class="row-h" hidden$="[[!editMode]]">
        <paper-button class="secondary-btn" on-click="openQuarterlyRepRequirementsDialog">
          Add Requirements
        </paper-button>
      </div>
    </div>
  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.ReportingRequirementsCommon
     * @appliesMixin EtoolsPmpApp.Mixins.GenerateQuarterlyReportingRequirements
     */
    const QuarterlyReportingRequirementsMixins = EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.ReportingRequirementsCommon,
      EtoolsPmpApp.Mixins.GenerateQuarterlyReportingRequirements
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin QuarterlyReportingRequirementsMixins
     */
    class QuarterlyReportingRequirements extends QuarterlyReportingRequirementsMixins {
      static get is() {
        return 'quarterly-reporting-requirements';
      }

      static get properties() {
        return {
          interventionStart: String,
          interventionEnd: String,
          editQprDialog: Object,
          editMode: Boolean
        };
      }

      ready() {
        super.ready();
        this._createEditQprDialog();
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._removeEditQprDialog();
      }

      _createEditQprDialog() {
        this.editQprDialog = document.createElement('edit-qpr-dialog');
        this.editQprDialog.set('toastMsgLoadingSource', this);
        this._onReportingRequirementsSaved = this._onReportingRequirementsSaved.bind(this);
        this.editQprDialog.addEventListener('reporting-requirements-saved', this._onReportingRequirementsSaved);
        document.querySelector('body').appendChild(this.editQprDialog);
      }

      _removeEditQprDialog() {
        if (this.editQprDialog) {
          this.editQprDialog.removeEventListener('reporting-requirements-saved', this._onReportingRequirementsSaved);
          document.querySelector('body').removeChild(this.editQprDialog);
        }
      }

      openQuarterlyRepRequirementsDialog() {
        if (!this.interventionStart || !this.interventionEnd) {
          this.fireEvent('toast', {text: 'You have to fill PD Start Date and End Date first!', showCloseBtn: true});
          return;
        }
        let qprData = [];
        if (this.requirementsCount === 0) {
          qprData = this.generateQPRData(this.interventionStart, this.interventionEnd);
        } else {
          qprData = JSON.parse(JSON.stringify(this.reportingRequirements));
        }
        this.editQprDialog.set('qprData', qprData);
        this.editQprDialog.set('interventionId', this.interventionId);
        this.editQprDialog.openQprDialog();
      }

      _getReportType() {
        return this.CONSTANTS.REQUIREMENTS_REPORT_TYPE.QPR;
      }

    }

    window.customElements.define(QuarterlyReportingRequirements.is, QuarterlyReportingRequirements);
  </script>
</dom-module>
