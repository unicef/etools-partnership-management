<link rel="import" href="../../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">

<link rel="import" href="../../../../../../../scripts/lodash.html">
<link rel="import" href="../../../../../../../config/app-constants.html">
<link rel="import" href="../../../../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../../../../mixins/ajax-errors-parser-mixin.html">

<script>
  'use strict';

  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};

  /**
   * @polymer
   * @mixinFunction
   * @appliesMixin EtoolsLogsMixin
   * @appliesMixin EtoolsPmpApp.Mixins.Constants
   * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
   * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
   */
  EtoolsPmpApp.Mixins.ReportingRequirementsCommon =
      baseClass => class extends EtoolsMixinFactory.combineMixins([
        EtoolsLogsMixin,
        EtoolsPmpApp.Mixins.Constants,
        EtoolsPmpApp.Mixins.Endpoints,
        EtoolsPmpApp.Mixins.AjaxErrorsParser
      ], baseClass) {

    static get properties() {
      return {
        reportingRequirements: {
          type: Array,
          value: []
        },
        requirementsCount: {
          type: Number,
          value: 0,
          notify: true
        },
        interventionId: {
          type: Number,
          observer: '_interventionIdChanged'
        }
      };
    }

    static get observers() {
      return [
        '_countReportingReq(reportingRequirements.length)'
      ];
    }

    _getEndpointObj(id, type, isSpecial) {
      if (isSpecial) {
        return this.getEndpoint('specialReportingRequirements', {intervId: id});
      }

      return this.getEndpoint('reportingRequirements', {
        intervId: id,
        reportType: type
      });
    }

    _interventionIdChanged(newId) {
      if (!newId) {
        this.reportingRequirements = [];
        return;
      }
      let type = this._getReportType();
      let isSpecial = type === this.CONSTANTS.REQUIREMENTS_REPORT_TYPE.SPECIAL;
      let endpoint = this._getEndpointObj(newId, type, isSpecial);
      this.sendRequest({method: 'GET', endpoint: endpoint})
          .then((response) => {
            this.set('reportingRequirements', isSpecial ? response : response.reporting_requirements);
          })
          .catch((error) => {
            this.logError('Failed to get qpr data from API!', 'reporting-requirements-common-mixin', error);
            this.parseRequestErrorsAndShowAsToastMsgs(error, this);
          });
    }

    _countReportingReq(length) {
      let l = (typeof length === 'number') ? length : 0;
      this.set('requirementsCount', l);
      if (typeof this._sortRequirementsAsc === 'function' && l > 0) {
        this._sortRequirementsAsc();
      }
    }

    _getIndex(index) {
      return index + 1;
    }

    _empty(list) {
      return _.isEmpty(list);
    }

    _onReportingRequirementsSaved(e) {
      this.set('reportingRequirements', e.detail);
    }

  };

</script>
