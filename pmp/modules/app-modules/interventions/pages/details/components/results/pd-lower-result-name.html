<link rel="import" href="../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">

<link rel="import" href="../../../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../../../../mixins/event-helper-mixin.html">

<dom-module id="pd-lower-result-name">
  <template>
    <style>
      .pd-output-name {
        padding: 0 0 30px;
      }
    </style>

    <etools-dialog id="pdLowerResultNameDialog"
                   size="md"
                   dialog-title="Add/Update PD Output or SSFA Expected Result"
                   ok-btn-text="Add/Update"
                   disable-confirm-btn="[[disableConfirmBtn]]"
                   keep-dialog-open
                   spinner-text="Saving PD Output or SSFA expected result..."
                   on-confirm-btn-clicked="_saveChanges">

      <div class="pd-output-name">
        <paper-input id="pdLowerResultNameField"
                     label="PD Output or SSFA expected result"
                     placeholder="&#8212;"
                     value="{{lowerResultName}}"
                     required
                     auto-validate
                     error-message="PD Output or SSFA expected result must be specified">
        </paper-input>
      </div>

    </etools-dialog>
  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    class PdLowerResultName extends EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.AjaxErrorsParser,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element) {

      static get is() {
        return 'pd-lower-result-name';
      }

      static get properties() {
        return {
          expectedResultId: Number,
          lowerResultId: Number,
          lowerResultName: {
            type: String,
            value: []
          },
          opened: {
            type: Boolean,
            value: false
          },
          disableConfirmBtn: {
            type: Boolean,
            value: false
          },
          toastEventSource: Object
        };
      }

      openDialog() {
        this.$.pdLowerResultNameDialog.set('opened', true);
      }

      closeDialog() {
        this.$.pdLowerResultNameDialog.set('opened', false);
      }

      resetData() {
        this.set('disableConfirmBtn', false);
        this.set('lowerResultId', null);
        this.set('lowerResultName', undefined);
        this.set('expectedResultId', null);
        this.$.pdLowerResultNameField.invalid = false;
      }

      _saveChanges() {
        if (!this.$.pdLowerResultNameField.validate()) {
          return false;
        }
        let lowerResult = {
          name: this.lowerResultName,
          result_link: this.expectedResultId
        };
        if (!lowerResult.result_link) {
          this.logError('Expected result ID is missing! Can not save lower result name.', 'lower-result-name-modal');
          return;
        }

        let endpoint;
        let method;
        if (!this.lowerResultId) {
          endpoint = this.getEndpoint('pdLowerResults', {resultId: lowerResult.result_link});
          method = 'POST';
        } else {
          endpoint = this.getEndpoint('pdLowerResultDetails', {llResultId: this.lowerResultId});
          method = 'PATCH';
        }
        this._saveLowerResult(endpoint, method, lowerResult, this._lowerResultSuccessfullySaved);
      }

      _saveLowerResult(endpoint, method, lowerResultData, successCallback) {
        let self = this;
        this.set('disableConfirmBtn', true);
        let dialog = this.$.pdLowerResultNameDialog;
        dialog.startSpinner();
        this.sendRequest({
          method: method,
          endpoint: endpoint,
          body: lowerResultData
        }).then(function(response) {
          dialog.stopSpinner();
          self.set('disableConfirmBtn', false);
          if (typeof successCallback === 'function') {
            successCallback.bind(self, response)();
          }
        }).catch(function(error) {
          dialog.stopSpinner();
          self.set('disableConfirmBtn', false);
          self.parseRequestErrorsAndShowAsToastMsgs(error, self.toastEventSource);
        });
      }

      _lowerResultSuccessfullySaved(response) {
        let data = {
          lowerResultId: this.lowerResultId,
          expectedResultId: this.expectedResultId,
          lowerResult: response
        };

        this._initializeToBeAbleToAddIndicator(data.lowerResult);

        this.fireEvent('lower-result-saved', data);
        this.closeDialog();
      }

      _initializeToBeAbleToAddIndicator(lowerResult) {
        if (!lowerResult.applied_indicators) {
          lowerResult.applied_indicators = [];
        }
      }
    }

    window.customElements.define(PdLowerResultName.is, PdLowerResultName);
  </script>
</dom-module>
