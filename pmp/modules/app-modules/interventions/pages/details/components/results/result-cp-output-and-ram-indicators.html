<link rel="import" href="../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../../../../../bower_components/etools-dropdown/etools-dropdown.html">
<link rel="import" href="../../../../../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">

<link rel="import" href="../../../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../../../../mixins/missing-dropdown-options-mixin.html">
<link rel="import" href="../../../../../../mixins/event-helper-mixin.html">

<link rel="import" href="../../../../../../styles/required-field-styles.html">

<dom-module id="result-cp-output-and-ram-indicators">
  <template>
    <style include="required-field-starred-styles">
      :host {
      }

      .cp-output-row {
        padding: 0 0 16px;
      }

      .ram-indicators-row {
        padding: 16px 0 30px;
      }
    </style>

    <etools-dialog id="cpOutputRamIndicatorsDialog"
                   size="md"
                   dialog-title="Add/Update CP Output/Ram Indicators"
                   ok-btn-text="Add/Update"
                   disable-confirm-btn="[[disableConfirmBtn]]"
                   on-confirm-btn-clicked="_saveChanges"
                   keep-dialog-open>

      <div class="cp-output-row">
        <etools-dropdown id="cpOutput"
                         label="CP Output"
                         placeholder="&#8212;"
                         options="[[availableCpOutputs]]"
                         option-value="id"
                         option-label="name"
                         selected="{{selectedCpOutputId}}"
                         required
                         auto-validate
                         error-message="Please select CP Output"
                         disable-on-focus-handling>
        </etools-dropdown>
      </div>

      <div class="ram-indicators-row">
        <etools-dropdown-multi id="indicators"
                               label="CP Indicators"
                               placeholder="&#8212;"
                               options="[[cpOutputRamIndicators]]"
                               option-value="id"
                               option-label="name"
                               selected-values="{{selectedRamIndicatorsIds}}"
                               required
                               auto-validate
                               error-message="Please select CP Indicators"
                               disable-on-focus-handling>
        </etools-dropdown-multi>
      </div>

    </etools-dialog>
  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixins EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixins EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixins EtoolsPmpApp.Mixins.AjaxErrorsParser
     * @appliesMixins EtoolsPmpApp.Mixins.MissingDropdownOptions
     */
    class ResultCpOutputAndRamIndicators extends EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.AjaxErrorsParser,
      EtoolsPmpApp.Mixins.MissingDropdownOptions
    ], Polymer.Element) {

      static get is() {
        return 'result-cp-output-and-ram-indicators';
      }

      static get properties() {
        return {
          interventionId: Number,
          expectedResultId: Number,
          availableCpOutputs: {
            type: Array,
            value: []
          },
          selectedCpOutputId: {
            type: Number,
            observer: '_cpOutputSelected'
          },
          cpOutputRamIndicators: {
            type: Array,
            value: []
          },
          selectedRamIndicatorsIds: {
            type: Array,
            value: []
          },
          autovalidateActive: {
            type: Boolean,
            value: false
          },
          ramIndicatorsLoadingMsg: {
            type: String,
            value: 'Loading...'
          },
          saveResultLoadingMsg: {
            type: String,
            value: 'Saving result...'
          },
          opened: {
            type: Boolean,
            value: false
          },
          preventRamIndicatorReset: Boolean,
          editIndex: {
            value: null
          },
          disableConfirmBtn: {
            type: Boolean,
            value: false
          },
          toastEventSource: Object
        };
      }

      ready() {
        super.ready();
        this.setDropdownMissingOptionsAjaxDetails(this.$.cpOutput, 'cpOutputsByIdsAsValues', {dropdown: true});
      }

      _enableAutovalidate() {
        this.set('autovalidateActive', true);
      }

      _cpOutputSelected(cpOutputId) {
        if (cpOutputId) {
          // request ram indicators list
          this._setRamIndicatorsSpinnerText(this.ramIndicatorsLoadingMsg);
          this._showRamIndicatorsLoadingSpinner(true);

          let ramIndicatorsEndpoint = this.getEndpoint('ramIndicators', {id: cpOutputId});
          let self = this;
          this.sendRequest({
            endpoint: ramIndicatorsEndpoint
          }).then(function(response) {
            self._handleRamIndicatorsReqResponse(response);
          }).catch(function(error) {
            self._showRamIndicatorsLoadingSpinner(false);
            self.parseRequestErrorsAndShowAsToastMsgs(error, self.toastEventSource);
          });
        }
      }

      _handleRamIndicatorsReqResponse(response) {
        if (this._thereAreSelectedIndicators() &&  // to prevent triggering validation
            !this.preventRamIndicatorReset) {
          this.set('selectedRamIndicatorsIds', []);
        }
        this.set('preventRamIndicatorReset', false);
        this.set('cpOutputRamIndicators', response);
        this.$.indicators.invalid = false;
        this._showRamIndicatorsLoadingSpinner(false);
      }

      _thereAreSelectedIndicators() {
        return this.selectedRamIndicatorsIds && this.selectedRamIndicatorsIds.length;
      }

      _showRamIndicatorsLoadingSpinner(show) {
        if (show) {
          this.$.cpOutputRamIndicatorsDialog.startSpinner();
        } else {
          this.$.cpOutputRamIndicatorsDialog.stopSpinner();
        }
      }

      _setRamIndicatorsSpinnerText(text) {
        this.$.cpOutputRamIndicatorsDialog.spinnerText = text;
      }

      openDialog() {
        this.$.cpOutputRamIndicatorsDialog.set('opened', true);
      }

      closeDialog() {
        this.$.cpOutputRamIndicatorsDialog.set('opened', false);
      }

      resetData() {
        this.set('disableConfirmBtn', false);
        this.set('editIndex', null);
        this.set('selectedCpOutputId', undefined);
        this.set('availableCpOutputs', []);
        this.set('cpOutputRamIndicators', []);
        this.set('selectedRamIndicatorsIds', []);

        this.$.cpOutput.set('invalid', false);
        this.$.indicators.set('invalid', false);
      }

      _saveChanges() {
        this.$.cpOutput.validate();
        this.$.indicators.validate();

        let result = {
          intervention: this.interventionId,
          cp_output: this.selectedCpOutputId,
          ram_indicators: (this.selectedRamIndicatorsIds instanceof Array) ? this.selectedRamIndicatorsIds : []
        };

        if (!this._isValidResult(result)) {
          return;
        }

        let endpoint;
        if (this._isNewResult()) {
          endpoint = this._getResultsEndpoint(result.intervention);
          this._saveExpectedResult(endpoint, 'POST', result, this._newResultSuccessfullyAdded);
        } else {
          endpoint = this._getResultDetailsEndpoint(this.expectedResultId);
          this._saveExpectedResult(endpoint, 'PATCH', result, this._resultSuccessfullyUpdated);
        }
      }

      _isValidResult(result) {
        let valid = true;
        if (!result.intervention) {
          this.logError('Intervention ID is missing! Can not save result.', 'expected-results-modal');
          valid = false;
        }
        if (!result.cp_output || result.ram_indicators.length === 0) {
          valid = false;
        }
        return valid;
      }

      _isNewResult() {
        return !this.expectedResultId;
      }

      _getResultsEndpoint(interventionId) {
        return this.getEndpoint('pdExpectedResults', {pdId: interventionId});
      }

      _getResultDetailsEndpoint(resultId) {
        return this.getEndpoint('pdExpectedResultDetails', {resultId: resultId});
      }

      _saveExpectedResult(endpoint, method, result, successCallback) {
        let self = this;
        this._setRamIndicatorsSpinnerText(this.saveResultLoadingMsg);
        this._showRamIndicatorsLoadingSpinner(true);
        this.set('disableConfirmBtn', true);
        this.sendRequest({
          method: method,
          endpoint: endpoint,
          body: result
        }).then(function(response) {
          self._showRamIndicatorsLoadingSpinner(false);
          self.set('disableConfirmBtn', false);
          if (typeof successCallback === 'function') {
            successCallback.bind(self, response)();
          }
        }).catch(function(error) {
          self._showRamIndicatorsLoadingSpinner(false);
          self.set('disableConfirmBtn', false);
          self.parseRequestErrorsAndShowAsToastMsgs(error, self.toastEventSource);
        });
      }

      _newResultSuccessfullyAdded(response) {
        this.fireEvent('new-expected-result-added', {result: response});
        this.closeDialog();
      }

      _resultSuccessfullyUpdated(response) {
        this.fireEvent('expected-result-updated', {index: this.editIndex, result: response});
        this.closeDialog();
      }

    }

    window.customElements.define(ResultCpOutputAndRamIndicators.is, ResultCpOutputAndRamIndicators);
  </script>
</dom-module>
