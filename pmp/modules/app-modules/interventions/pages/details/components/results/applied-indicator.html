<link rel="import" href="../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../../../scripts/lodash.html">
<link rel="import" href="../../../../../../config/app-constants.html">

<link rel="import" href="../../../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../../../styles/shared-styles.html">

<link rel="import" href="../../../../../../layout/components/icons-actions.html">

<dom-module id="applied-indicator">
  <template strip-whitespace>
    <style include="grid-layout-styles data-table-styles shared-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        /* '!important' is for IE */
        --list-bg-color: #eeeeee !important;
        --list-second-bg-color: #dfdfdf !important;
        --list-icon-color: white !important;
        --icons-actions: {
          background-color: #dfdfdf !important;
          margin-right: -8px;
        };
        --list-row-wrapper-padding: 0 24px 0 0 !important;

        --list-row-collapse-wrapper: {
          padding: 16px 24px 16px 24px !important;
          max-height: 220px;
          overflow-y: auto;
        };

        --icon-wrapper: {
          @apply --layout-horizontal;
          @apply --layout-center;
          @apply --layout-self-stretch;
          min-height: 48px;
          height: auto;
          padding: 0 !important;
          margin-right: 16px !important;
          background-color: var(--collapse-icon-bg-color, var(--primary-color));
          background-image: var(--collapse-icon-bg-image, none);
          background-size: 5.66px 5.66px;
        };
      }

      .divider {
        height: 24px;
      }

      .padd-left {
        padding-left: 16px;
      }

      icons-actions {
        visibility: hidden;
      }

      etools-data-table-row div[slot="row-data"]:hover icons-actions {
        visibility: visible;
      }

      .bolder-txt {
        font-weight: 600;
      }
    </style>

    <etools-data-table-row>
      <div slot="row-data" class="p-relative">
        <div class="col-8">
          [[_getIndicatorDisplayType(indicator.indicator.unit, indicator.indicator.display_type)]]
          <strong>[[_addInactivePrefix(indicator)]]</strong>
          [[_getIndicatorTitle(indicator)]]
        </div>
        <div class="col-2 right-align">
          [[_displayBaselineOrTarget(indicator.baseline, indicator.indicator.unit,
          indicator.indicator.display_type, indicator.cluster_indicator_id)]]
        </div>
        <div class="col-2 right-align">
          [[_displayBaselineOrTarget(indicator.target, indicator.indicator.unit,
          indicator.indicator.display_type, indicator.cluster_indicator_id)]]
        </div>
        <icons-actions hidden$="[[!editMode]]"
                       show-edit="[[indicator.is_active]]"
                       show-deactivate="[[_showDeactivate(inAmendment, indicator.is_active)]]"
                       show-delete="[[_showDelete(interventionStatus)]]">
        </icons-actions>
      </div>

      <div slot="row-data-details">
        <div class="layout-horizontal w100">
          <div class="col-4">
            <div class="header-text">Section / Cluster</div>
            <div>[[getSectionName(indicator.section, sections)]] / [[getClusterName(indicator.cluster_name)]]</div>
            <div class="divider"></div>
            <div class="header-text">Disaggregation</div>
            <template is="dom-repeat" items="[[disaggregationNames]]">
              <div><span class="bolder-txt">[[item.name]]</span>: [[item.groups]]</div>
            </template>
            <div hidden$="[[!_lengthIs0(disaggregationNames.length)]]">—</div>
          </div>
          <div class="col-8 padd-left">
            <div class="header-text">Locations</div>
            <template is="dom-repeat" items="[[locationNames]]">
              <div><span class="bolder-txt">[[item.name]]</span> [[item.adminLevel]]</div>
            </template>
          </div>
        </div>
      </div>
    </etools-data-table-row>
  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.Constants
     */
    class AppliedIndicator extends EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.Constants
    ], Polymer.Element) {

      static get is() {
        return 'applied-indicator';
      }

      static get properties() {
        return {
          indicator: {
            type: Object
          },
          inAmendment: {
            type: Boolean,
            statePath: 'pageData.in_amendment'
          },
          locations: {
            type: Array,
            statePath: 'locations'
          },
          locationNames: {
            type: Array,
            value: []
          },
          sections: {
            type: Array,
            statePath: 'sections'
          },
          disaggregations: {
            type: Array,
            statePath: 'disaggregations'
          },
          disaggregationNames: {
            type: Array,
            value: ['—']
          },
          editMode: {
            type: Boolean
          },
          interventionStatus: String
        };
      }

      static get observers() {
        return [
          'setIndicatorDetails(indicator, disaggregations, locations)'
        ];
      }

      ready() {
        super.ready();
        this._initAppliedIndicatorListeners();
      }

      _initAppliedIndicatorListeners() {
        this.addEventListener('edit', this._editIndicator.bind(this));
        this.addEventListener('delete', this._deleteIndicator.bind(this));
        this.addEventListener('deactivate', this._deactivateIndicator);
      }

      _showDeactivate(inAmendment, indicIsActive) {
        return (inAmendment && indicIsActive);
      }

      _showDelete(interventionStatus) {
        return (!interventionStatus ||
            interventionStatus === this.CONSTANTS.STATUSES.Draft.toLowerCase());
      }

      setIndicatorDetails(indicator, disaggregations, locations) {
        if (typeof indicator === 'undefined' ||
            typeof disaggregations === 'undefined' ||
            typeof locations === 'undefined') {
          return;
        }
        this._updateCollapsableIconBg(indicator);
        this._setLocationNames();
        this._setDisaggregationNames();
      }

      _editIndicator(e) {
        e.stopPropagation();
        this.fireEvent('edit-indicator');
      }

      _deleteIndicator(e) {
        e.stopPropagation();
        this.fireEvent('delete-indicator');
      }

      _deactivateIndicator(e) {
        e.stopPropagation();
        this.fireEvent('deactivate-indicator');
      }

      _updateCollapsableIconBg(indicator) {
        if (indicator.cluster_indicator_id) {
          this.updateStyles({'--collapse-icon-bg-color': 'var(--ternary-color)', '--collapse-icon-bg-image': 'none'});
        } else {
          let hfBgImg = 'none';
          if (indicator.is_high_frequency) {
            hfBgImg = 'linear-gradient(135deg, #066ac7 12.50%, #0099ff 12.50%, #0099ff 50%, #066ac7 50%, ' +
                '#066ac7 62.50%, #0099ff 62.50%, #0099ff 100%)';
          }
          this.updateStyles({
            '--collapse-icon-bg-color': 'var(--primary-color)',
            '--collapse-icon-bg-image': hfBgImg
          });
        }
      }

      _setLocationNames() {
        if (!this.locations) {
          return;
        }
        let locations = this.locations.filter(function(loc) {
          return this.indicator.locations.indexOf(parseInt(loc.id)) > -1;
        }.bind(this));
        let locNames = locations.map(function(l) {
          return {
            name: l.name.substring(0, l.name.indexOf('[')),
            adminLevel: l.name.substring(l.name.indexOf('['))
          };
        });
        this.locationNames = locNames;
      }

      getSectionName(sectionId) {
        let sectionName = '—';
        if (sectionId && !_.isEmpty(this.sections)) {
          let section = this.sections.find(function(s) {
            return parseInt(s.id) === parseInt(sectionId);
          });
          if (section) {
            sectionName = section.name;
          }
        }
        return sectionName;
      }

      getClusterName(clusterName) {
        return !clusterName ? '—' : clusterName;
      }

      _setDisaggregationNames() {
        if (!this.indicator.disaggregation || !this.indicator.disaggregation.length) {
          this.disaggregationNames = [];
          return;
        }
        let disaggregs = this.disaggregations.filter(function(d) {
          return this.indicator.disaggregation.indexOf(parseInt(d.id)) > -1;
        }.bind(this));
        let disaggregNames = disaggregs.map(function(d) {
          return {name: d.name, groups: this._getDisaggregGroups(d.disaggregation_values)};
        }.bind(this));
        this.disaggregationNames = disaggregNames;
      }

      _getDisaggregGroups(disaggregGroups) {
        if (!disaggregGroups || !disaggregGroups.length) {
          return '—';
        }
        let groups = disaggregGroups.reduce(function(flattened, current) {
          return flattened + ', ' + current.value;
        }, '');

        return groups.substring(1, groups.length);
      }

      _getIndicatorDisplayType(unit, displayType) {
        if (!unit) {
          return '';
        }

        switch (unit) {
          case 'number':
            return '# ';
          case 'percentage':
            if (displayType === 'percentage') {
              return '% ';
            } else if (displayType === 'ratio') {
              return '/ ';
            }
          default:
            return '';
        }
      }

      _getIndicatorTitle(indicator) {
        if (!indicator) {
          return '—';
        }
        if (indicator.cluster_indicator_id) {
          return indicator.cluster_indicator_title;
        } else {
          return indicator.indicator ? indicator.indicator.title : '—';
        }
      }


      _displayBaselineOrTarget(item, unit, displayType, isCluster) {
        if (!item) {
          return '—';
        }
        if (!item.v && parseInt(item.v) !== 0) {
          return '—';
        }

        if (isCluster && this._clusterIndIsRatio(item)) {
          return item.v + ' / ' + item.d;
        }

        if (unit === 'percentage' && displayType === 'ratio') {
          return item.v + ' / ' + item.d;
        }

        return item.v;
      }

      _clusterIndIsRatio(item) {
        return item.d && parseInt(item.d) !== 1 && parseInt(item.d) !== 100;
      }

      _addInactivePrefix(indicator) {
        return (!indicator || indicator.is_active) ? '' : '(inactive)';
      }

      _lengthIs0(length) {
        return length === 0;
      }

    }

    window.customElements.define(AppliedIndicator.is, AppliedIndicator);
  </script>
</dom-module>
