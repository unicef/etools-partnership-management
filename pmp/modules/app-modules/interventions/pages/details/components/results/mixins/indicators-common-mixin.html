<script>
  'use strict';

  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};

  /**
   * @polymer
   * @mixinFunction
   */
  EtoolsPmpApp.Mixins.IndicatorsCommon = Polymer.dedupingMixin(superClass => class extends superClass {

    static get properties() {
      return {
        numberPattern: { // allow only decimals separator `.` or `,`. ex: 1000,00 or 1000.00
          type: String,
          value: '(^\\d+(\\.?\\d+)?$)|(^\\d+(,?\\d+)?$)'
        },
        digitsNotStartingWith0Pattern: { // any number starting from 1
          type: String,
          value: '^[1-9]{1}(\\d+)?$'
        },
        digitsPattern: {
          type: String,
          value: '^\\d+'
        }
      };
    }

    _baselineChanged(baselineV) {
      if (!this.indicator || this._isEmptyExcept0(baselineV)) {
        return;
      }

      if (this._displayTypeIsPercentage(this.indicator)) {
        let val = this._getValidPercentageValue(baselineV);
        this.set('indicator.baseline.v', val);
      }
    }

    _targetChanged(targetV) {
      if (!this.indicator || this._isEmptyExcept0(targetV)) {
        return;
      }

      if (this._displayTypeIsPercentage(this.indicator)) {
        let val = this._getValidPercentageValue(targetV);
        this.set('indicator.target.v', val);
      }
    }

    _isEmptyExcept0(value) {
      return value === null || value === undefined || value === '';
    }

    _displayTypeIsPercentage(indicator) {
      return (indicator.indicator && indicator.indicator.unit === 'percentage' &&
          indicator.indicator.display_type !== 'ratio');
    }

    _getValidPercentageValue(val) {
      val = parseInt(val, 10);
      if (isNaN(val) || val < 0) {
        val = 0;
      }
      if (val > 100) {
        val = 100;
      }
      return val;
    }

    validateComponents(elemIds) {
      let valid = true;
      elemIds.forEach(function(elemId) {
        let elem = this.shadowRoot.querySelector('#' + elemId);
        if (elem) {
          valid = elem.validate() && valid;
        } else {
          this.logWarn('Elem ' + elemId + ' not found');
        }
      }, this);
      return valid;
    }

  });

</script>
