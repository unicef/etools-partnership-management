<link rel="import" href="../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../../../styles/shared-styles.html">

<link rel="import" href="../../../../../../mixins/repeatable-data-sets-mixin.html">
<link rel="import" href="../../../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../../../layout/components/edit-delete-actions.html">

<link rel="import" href="pd-lower-result-name.html">
<link rel="import" href="applied-indicators.html">

<dom-module id="result-link-lower-results">
  <template strip-whitespace>
    <style
        include="grid-layout-styles shared-styles data-table-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        --list-bg-color: #eeeeee;
        --edit-delete-actions: {
          background-color: var(--list-second-bg-color);
        };
      }
      .lborder {
        border-left: 1px solid var(--list-divider-color);
      }
      paper-icon-button {
        color: var(--dark-icon-color, #6f6f70);
      }

      .header-container {
        height: 56px;
        padding: 0 24px;
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      .border-b {
        border-bottom: 1px solid var(--list-divider-color);
      }

      edit-delete-actions {
        visibility: hidden;
      }
      .result-statement {
        padding-top: 12px;
        padding-bottom: 12px;
        padding-right: 12px;
      }
      div.result-statement:hover edit-delete-actions {
        visibility: visible;
      }

      div {
        box-sizing: border-box;
      }

      .lower-result-row {
        @apply --layout-center;
        padding: 0 24px;
        min-height: 49px; /* 1px for border */
      }
      .lower-result-row:not(:last-of-type) {
        border-bottom: 1px solid var(--list-divider-color);
      }

      .indicators-container {
        @apply --layout-center;
        @apply --layout-self-stretch;
      }
      .add-btn-row {
        height: 48px;
        padding-left: 16px;
        @apply --layout-horizontal;
        @apply --layout-center;
      }
      .add-btn-row.border-b {
        height: 49px;
      }

    </style>

    <div hidden$="[[!_emptyList(dataItems.length)]]">
      <etools-data-table-header no-title no-collapse>
        <etools-data-table-column class="col-12">PD Output or SSFA Expected Result</etools-data-table-column>
      </etools-data-table-header>
    </div>

    <div hidden$="[[_emptyList(dataItems.length)]]">
      <div class="header-container header-text border-b">
        <div class$="[[getColumnLength('result', thereAreIndicators)]]">PD/SSFA Result Statement</div>
        <div class="col flex-c">
          <div class="col col-8">Performance Indicator</div>
          <div class="col col-2 right-align" hidden$="[[!thereAreIndicators]]">Baseline</div>
          <div class="col col-2 right-align" hidden$="[[!thereAreIndicators]]">Target</div>
        </div>
      </div>

      <template is="dom-repeat" items="{{dataItems}}">
        <div class="layout-horizontal lower-result-row">
          <div class$="[[getColumnLength('result', thereAreIndicators)]] result-statement p-relative">
            <edit-delete-actions hidden$="[[!editMode]]" data-args$="[[index]]" on-edit="_editLowerResult"
                                 on-delete="_openDeleteConfirmation"></edit-delete-actions>
            <span>[[item.name]]</span>
          </div>
          <div class="flex-c lborder indicators-container">
            <div hidden="[[!item.applied_indicators.length]]">
              <applied-indicators data-items="[[item.applied_indicators]]"
                                  result-link-index="[[index]]"
                                  cp-output-id="[[cpOutputId]]"
                                  intervention-status="[[interventionStatus]]"
                                  edit-mode="[[editMode]]">
              </applied-indicators>
            </div>
            <div class="add-btn-row flex-c" hidden$="[[!editMode]]">
              <paper-icon-button icon="add-box"
                                 title="Add Indicator"
                                 on-tap="_addNewIndicator"
                                 data-ll-result-id$="[[item.id]]"
                                 disabled$="[[!editMode]]">
              </paper-icon-button>
            </div>
          </div>
        </div>
      </template>
    </div>

    <div class="add-btn-row border-b" hidden$="[[!editMode]]">
      <paper-icon-button icon="add-box"
                         on-tap="_addNewLowerResult"
                         title="Add PD or SSFA OUTPUT"
                         disabled$="[[!editMode]]">
        Add PD output or SSFA expected result
      </paper-icon-button>
    </div>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsPmpApp.Mixins.RepeatableDataSets
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    class ResultLinkLowerResults extends EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.RepeatableDataSets,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element) {

      static get is() {
        return 'result-link-lower-results';
      }

      static get properties() {
        return {
          _deleteEpName: {
            type: String,
            value: 'lowerResultsDelete',
            readOnly: true,
          },
          cpOutputId: {
            type: Number
          },
          editMode: {
            type: Boolean,
            value: false
          },
          expectedResultId: Number,
          thereAreIndicators: {
            type: Boolean,
            value: false
          },
          interventionStatus: String
        };
      }

      static get observers() {
        return [
          '_seeIfThereAreIndicators(dataItems.*)',
          '_makeSureDataItemsAreValid(dataItems)'
        ];
      }

      ready() {
        super.ready();
        this.addEventListener('delete-confirm', this._updateInterventionLocAndClusters.bind(this));
      }

      _seeIfThereAreIndicators(dataItemsMutation) {
        if (typeof dataItemsMutation === 'undefined') {
          return;
        }
        if (!this.dataItems) {
          this.thereAreIndicators = false;
          return;
        }
        let foundSomeIndicators = false;
        for (let i in this.dataItems) {
          if (this.dataItems[i].applied_indicators && this.dataItems[i].applied_indicators.length) {
            foundSomeIndicators = true;
            break;
          }
        }
        this.thereAreIndicators = foundSomeIndicators;
      }

      getColumnLength(column, thereAreIndicators) {
        switch (column) {
          case 'result':
            return thereAreIndicators ? 'col-4' : 'col-8';
          case 'indicator':
            return thereAreIndicators ? 'col-8' : 'col-4';
        }
      }
      
      _updateInterventionLocAndClusters() {
        this.fireEvent('indicators-changed');
      }
      
      _addNewLowerResult() {
        this.fireEvent('add-new-lower-result', {expectedResultId: this.expectedResultId});
      }

      _editLowerResult(e) {
        e.stopPropagation();
        let index = parseInt(e.target.getAttribute('data-args'), 10);
        if (index < 0) {
          this.logError('Can not edit, invalid index selected', 'lower-results');
          return;
        }

        let lowerResult = this.dataItems[index];
        if (!lowerResult) {
          this.logError('Lower result not found in data items by index: ' + index, 'lower-results');
          return;
        }

        this.fireEvent('edit-lower-result', {
          expectedResultId: this.expectedResultId,
          lowerResultId: lowerResult.id,
          lowerResultName: lowerResult.name
        });
      }

      _getIndicatorNr(indicatorIndex) {
        return parseInt(indicatorIndex, 10) + 1;
      }

      _addNewIndicator(event) {
        // build a map (actionParams) to know where to put indicator data at add/edit
        let resultMap = {
          cpOutputId: this.cpOutputId,
          llResultIndex: event.model.index,
          llResultId: parseInt(event.target.getAttribute('data-ll-result-id'), 10),
          indicatorData: null,
          appliedIndicatorsIndex: null
        };
        this.fireEvent('open-indicator-dialog', resultMap);
      }

    }

    window.customElements.define(ResultLinkLowerResults.is, ResultLinkLowerResults);
  </script>
</dom-module>
