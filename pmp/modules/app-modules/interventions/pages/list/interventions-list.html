<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">

<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">
<link rel="import" href="../../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import"
      href="../../../../../../bower_components/etools-currency-amount-input/mixins/etools-currency-mixin.html">
<link rel="import" href="../../../../../../bower_components/etools-info-tooltip/etools-info-tooltip.html">

<link rel="import" href="../../../../scripts/lodash.html">

<link rel="import" href="../../../../config/app-constants.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/list-filters-mixin.html">
<link rel="import" href="../../../../mixins/lists-common-mixin.html">
<link rel="import" href="../../../../mixins/pagination-mixin.html">
<link rel="import" href="../../mixins/fr-numbers-consistency-mixin.html">

<link rel="import" href="../../../../layout/components/etools-date-input.html">

<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/list-filter-styles.html">
<link rel="import" href="../../../../styles/app-mixins.html">

<link rel="import" href="../../styles/fr-warnings-styles.html">

<link rel="import" href="../../data/interventions-list-data.html">
<link rel="import" href="../../../../redux/etools-data-redux-store.html">

<dom-module id="interventions-list">
  <template strip-whitespace>
    <style
        include="shared-styles data-table-styles grid-layout-styles list-filter-styles paper-material-styles fr-warnings-styles">
      :host {
        @apply --layout-flex;
        width: 100%;
      }

      .pd-ref {
        @apply --text-btn-style;
        text-transform: none;
      }
    </style>

    <template is="dom-if" if="[[stampListData]]">
      <interventions-list-data id="interventions"
                               filtered-interventions="{{filteredInterventions}}"
                               total-results="{{paginator.count}}"
                               on-interventions-loaded="_requiredDataHasBeenLoaded"
                               list-data-path="filteredInterventions"
                               fire-data-loaded>
      </interventions-list-data>
    </template>

    <div id="filters" class="paper-material" elevation="1">

      <div id="filters-fields">
        <paper-input id="query"
                     class="filter"
                     type="search"
                     placeholder="Search"
                     autocomplete="off"
                     value="{{q}}">
          <iron-icon icon="search" slot="prefix"></iron-icon>
        </paper-input>

        <!--<etools-dropdown-multi-->
            <!--class="filter"-->
            <!--label="Status"-->
            <!--options="[[interventionStatuses]]"-->
            <!--selected-values="{{selectedStatuses}}"-->
            <!--hide-search-->
            <!--min-width="160px"-->
            <!--horizontal-align="left"-->
            <!--no-dynamic-align></etools-dropdown-multi>-->

        <!--<etools-dropdown-multi-->
            <!--class="filter"-->
            <!--label="PD/SSFA Type"-->
            <!--options="[[documentTypes]]"-->
            <!--selected-values="{{selectedDocumentTypes}}"-->
            <!--hide-search-->
            <!--min-width="400px"-->
            <!--horizontal-align="left"-->
            <!--no-dynamic-align></etools-dropdown-multi>-->

        <!--<etools-dropdown-multi-->
            <!--class="filter"-->
            <!--label="Sections"-->
            <!--options="[[sections]]"-->
            <!--option-value="id"-->
            <!--option-label="name"-->
            <!--selected-values="{{selectedSections}}"-->
            <!--hide-search-->
            <!--min-width="350px"-->
            <!--horizontal-align="left"-->
            <!--no-dynamic-align></etools-dropdown-multi>-->

        <!--<etools-dropdown-multi-->
            <!--class="filter"-->
            <!--label="Offices"-->
            <!--options="[[offices]]"-->
            <!--option-value="id"-->
            <!--option-label="name"-->
            <!--selected-values="{{selectedOffices}}"-->
            <!--hide-search-->
            <!--min-width="250px"-->
            <!--horizontal-align="left"-->
            <!--no-dynamic-align></etools-dropdown-multi>-->

        <!--<etools-dropdown-multi-->
            <!--class="filter"-->
            <!--label="CP Structure"-->
            <!--options="[[countryProgrammes]]"-->
            <!--selected-values="{{selectedCPStructures}}"-->
            <!--option-value="id"-->
            <!--option-label="name"-->
            <!--hide-search-->
            <!--min-width="400px"-->
            <!--horizontal-align="left"-->
            <!--no-dynamic-align></etools-dropdown-multi>-->

        <template is="dom-repeat" items="[[selectedFilters]]" as="filter">

          <template is="dom-if" if="[[filterTypeIs('esmm', filter.type)]]">
            <etools-dropdown-multi
                class="filter"
                label="[[filter.filterName]]"
                placeholder="&#8212;"
                disabled$="[[!filter.selectionOptions.length]]"
                options="[[filter.selectionOptions]]"
                option-value="[[filter.optionValue]]"
                option-label="[[filter.optionLabel]]"
                selected-values="[[filter.alreadySelected]]"
                trigger-value-change-event
                on-etools-selected-items-changed="esmmValueChanged"
                data-filter-path$="[[filter.path]]"
                hide-search="[[filter.hideSearch]]"
                min-width="[[filter.minWidth]]"
                horizontal-align="left"
                no-dynamic-align>
            </etools-dropdown-multi>
          </template>

          <template is="dom-if" if="[[filterTypeIs('datepicker', filter.type)]]">
            <etools-date-input id$="datepicker_[[filter.path]]"
                               class="filter date"
                               label="[[filter.filterName]]"
                               placeholder="&#8212;"
                               value="[[filter.dateSelected]]"
                               on-date-has-changed="_filterDateHasChanged"
                               data-filter-path$="[[filter.path]]"
                               fire-date-has-changed no-init show-clear-btn>
            </etools-date-input>
          </template>

        </template>
      </div>

      <div class="fixed-controls">

        <paper-menu-button id="filterMenu" ignore-select horizontal-align="right">
          <paper-button class="button" slot="dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>
            Filters
          </paper-button>
          <paper-listbox slot="dropdown-content" multi>
            <template is="dom-repeat" items="[[listFilterOptions]]">
              <paper-icon-item on-tap="selectFilter" selected$="[[item.selected]]">
                <iron-icon icon="check" slot="item-icon" hidden$="[[!item.selected]]"></iron-icon>
                <paper-item-body>[[item.filterName]]</paper-item-body>
              </paper-icon-item>
            </template>
          </paper-listbox>
        </paper-menu-button>

      </div>

    </div>

    <div id="list" class="paper-material" elevation="1">

      <etools-data-table-header
          id="listHeader"
          label="[[paginator.visible_range.0]]-[[paginator.visible_range.1]] of [[paginator.count]] results to show">
        <etools-data-table-column class="col-2" field="number" sortable>
          Reference #
        </etools-data-table-column>
        <etools-data-table-column class="col-3" field="partner_name" sortable>
          Partner Name
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="document_type">
          Document Type
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="status">
          Status
        </etools-data-table-column>
        <etools-data-table-column class="col-2" field="title">
          Title
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="start" sortable>
          Start Date
        </etools-data-table-column>
        <etools-data-table-column class="flex-c" field="end" sortable>
          End Date
        </etools-data-table-column>
      </etools-data-table-header>

      <template id="rows" is="dom-repeat" notify-dom-change items="[[filteredInterventions]]"
                as="intervention" initial-count="10" on-dom-change="_listDataChanged">
        <etools-data-table-row details-opened="[[detailsOpened]]">
          <div slot="row-data" class="p-relative">
            <span class="col-data col-2">
              <a class="pd-ref truncate"
                 href="interventions/[[intervention.id]]/details"
                 title="[[getDisplayValue(intervention.number)]]"
                 on-tap="_triggerInterventionLoadingMsg">
                [[getDisplayValue(intervention.number)]]
              </a>
            </span>
            <span class="col-data col-3" title="[[getDisplayValue(intervention.partner_name)]]">
                <span class="truncate">[[getDisplayValue(intervention.partner_name)]]</span>
            </span>
            <span class="col-data flex-c">
                [[getDisplayValue(intervention.document_type)]]
            </span>
            <span class="col-data flex-c capitalize">
                [[getDisplayValue(intervention.status)]]
            </span>
            <span class="col-data col-2" title="[[getDisplayValue(intervention.title)]]">
                [[getDisplayValue(intervention.title)]]
            </span>
            <span class="col-data flex-c">
              <etools-info-tooltip class="fr-nr-warn"
                                   custom-icon
                                   icon-first
                                   hide-tooltip$="[[_hideDateFrsWarningTooltip(intervention.start, intervention.frs_earliest_start_date, intervention.status)]]">
                <span slot="field">[[getDateDisplayValue(intervention.start)]]</span>
                <iron-icon icon="pmp-custom-icons:not-equal" slot="custom-icon"></iron-icon>
                <span slot="message">[[getFrsStartDateValidationMsg()]]</span>
              </etools-info-tooltip>
            </span>
            <span class="col-data flex-c">
               <etools-info-tooltip class="fr-nr-warn"
                                    custom-icon
                                    icon-first
                                    hide-tooltip$="[[_hideDateFrsWarningTooltip(intervention.end, intervention.frs_latest_end_date, intervention.status)]]">
                 <span slot="field">[[getDateDisplayValue(intervention.end)]]</span>
                 <iron-icon icon="pmp-custom-icons:not-equal" slot="custom-icon"></iron-icon>
                 <span slot="message">[[getFrsEndDateValidationMsg()]]</span>
              </etools-info-tooltip>
            </span>
          </div>

          <div slot="row-data-details" class="p-relative">

            <div class="row-details-content col-2">
              <span class="rdc-title">Offices</span>
              <span>[[getDisplayValue(intervention.offices_names)]]</span>
            </div>
            <div class="row-details-content col-2">
              <span class="rdc-title">Section</span>
              <span>[[getDisplayValue(intervention.section_names)]]</span>
            </div>
            <div class="row-details-content col-2">
              <span class="rdc-title">UNICEF Cash Contribution</span>
              <etools-info-tooltip
                  class$="fr-nr-warn [[getCurrencyMismatchClass(intervention.all_currencies_are_consistent)]]"
                  icon-first
                  custom-icon
                  hide-tooltip="[[hideIntListUnicefCashAmountTooltip(intervention.all_currencies_are_consistent, intervention.unicef_cash, intervention.frs_total_frs_amt, intervention, 'interventionsList')]]">
                <span slot="field">
                  <span class="amount-currency">[[intervention.budget_currency]]</span>
                  <span>[[displayCurrencyAmount(intervention.unicef_cash, '0.00')]]</span>
                </span>
                <iron-icon icon="[[getFrsCurrencyTooltipIcon(intervention.fr_currencies_are_consistent)]]"
                           slot="custom-icon"></iron-icon>
                <span slot="message">
                  <span>[[getIntListUnicefCashAmountTooltipMsg(intervention.all_currencies_are_consistent, intervention.fr_currencies_are_consistent)]]</span>
                </span>
              </etools-info-tooltip>
            </div>
            <div class="row-details-content col-2">
              <span class="rdc-title">Total Budget</span>
              <span>
                <span class="amount-currency">[[intervention.budget_currency]]</span>
                <span>[[displayCurrencyAmount(intervention.total_budget, '0.00')]]</span>
              </span>
            </div>

          </div>
        </etools-data-table-row>
      </template>

      <etools-data-table-footer
          page-size="{{paginator.page_size}}"
          page-number="{{paginator.page}}"
          total-results="[[paginator.count]]"
          visible-range="{{paginator.visible_range}}">
      </etools-data-table-footer>

    </div>

  </template>
  <script>
    'use strict';
    let _interventionsLastNavigated = null;

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsMixins.EtoolsCurrency
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.ListFilters
     * @appliesMixin EtoolsPmpApp.Mixins.ListsCommon
     * @appliesMixin EtoolsPmpApp.Mixins.FrNumbersConsistency
     * @appliesMixin EtoolsPmpApp.Mixins.Constants
     * @appliesMixin EtoolsPmpApp.Mixins.Pagination
     */
    class InterventionsList extends EtoolsMixinFactory.combineMixins([
      EtoolsMixins.EtoolsCurrency,
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.ListFilters,
      EtoolsPmpApp.Mixins.ListsCommon,
      EtoolsPmpApp.Mixins.FrNumbersConsistency,
      EtoolsPmpApp.Mixins.Constants,
      EtoolsPmpApp.Mixins.Pagination
    ], Polymer.Element) {

      static get is() {
        return 'interventions-list';
      }

      static get properties() {
        return {
          filteredInterventions: {
            type: Array,
            notify: true,
            observer: '_listChanged'
          },

          documentTypes: {
            type: Array,
            statePath: 'interventionDocTypes'
          },

          selectedDocumentTypes: {
            type: Array,
            value: []
          },

          interventionStatuses: {
            type: Array,
            statePath: 'interventionStatuses'
          },

          selectedStatuses: {
            type: Array,
            value: []
          },

          startDate: {
            type: String,
            observer: '_filtersChanged'
          },

          endDate: {
            type: String,
            observer: '_filtersChanged'
          },

          cpOutputs: {
            type: Array,
            statePath: 'cpOutputs'
          },
          selectedCpOutputs: {
            type: Array,
            value: [],
            observer: '_arrayFilterChanged'
          },

          countryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          sections: {
            type: Array,
            statePath: 'sections'
          },

          selectedSections: {
            type: Array,
            value: []
          },

          unicefUsersData: {
            type: Array,
            statePath: 'unicefUsersData'
          },

          selectedUnicefFocalPoints: {
            type: Array,
            value: [],
            observer: '_arrayFilterChanged'
          },

          offices: {
            type: Array,
            statePath: 'offices'
          },

          selectedOffices: {
            type: Array,
            value: []
          },

          donors: {
            type: Array,
            statePath: 'donors'
          },

          selectedDonors: {
            type: Array,
            value: [],
            observer: '_arrayFilterChanged'
          },

          grants: {
            type: Array,
            statePath: 'grants'
          },

          selectedGrants: {
            type: Array,
            value: [],
            observer: '_arrayFilterChanged'
          },

          csvDownloadQs: {
            type: String,
            notify: true
          },

          _sortableFieldNames: {
            type: Array,
            value: ['number', 'partner_name', 'start', 'end']
          },

          selectedCPStructures: {
            type: Array,
            value: [],
            observer: '_arrayFilterChanged'
          }
        };
      }

      static get observers() {
        return [
          '_filtersChanged(q, selectedStatuses.length, selectedDocumentTypes.length, ' +
              'selectedSections.length, selectedOffices.length, ' +
              'selectedCPStructures.length)', // used for non removable filters
          '_initFiltersMenuList(cpOutputs, unicefUsersData, donors, grants, countryProgrammes, offices, ' +
              'documentTypes, sections, interventionStatuses)',
          '_updateUrlAndData(q, selectedDocumentTypes.length, selectedCpOutputs.length, selectedStatuses.length, ' +
              'selectedSections.length, selectedUnicefFocalPoints.length, selectedOffices.length, ' +
              'selectedDonors.length, selectedGrants.length, startDate, endDate, selectedCPStructures.length, ' +
              'paginator.page, paginator.page_size, sortOrder, requiredDataLoaded, initComplete)',
          '_init(active)'
        ];
      }

      ready() {
        super.ready();
        this.$.list.classList.add('hidden');
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for main list elements load,
         * triggered by parent element on stamp
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'interv-page'});

        this.listAttachedCallback(this.active, 'Loading...', 'pd-ssfa-list');
      }

      _initFiltersMenuList(cpOutputs, unicefUsersData, donors, grants,
                           countryProgrammes, offices, documentTypes, sections, interventionStatuses) {

        if (!cpOutputs || !unicefUsersData || !donors || !grants || !countryProgrammes || !offices ||
            !documentTypes || !sections || !interventionStatuses) {
          // this is just to be safe, the method should only get triggered once when redux data is loaded
          return;
        }

        // init list filter options
        // IMPORTANT!!!
        // If you change filterName make sure you update it as well in _updateSelectedFiltersValues method
        // IMPORTANT!!!
        this.initListFiltersData([
          {
            filterName: 'CP Structure',
            type: 'esmm', // etools-dropdown-multi
            selectionOptions: countryProgrammes,
            optionValue: 'id',
            optionLabel: 'name',
            alreadySelected: [],
            path: 'selectedCPStructures',
            selected: true,
            minWidth: '400px',
            hideSearch: true
          },
          {
            filterName: 'Country Programme Output',
            type: 'esmm', // etools-dropdown-multi
            optionValue: 'id',
            optionLabel: 'name',
            selectionOptions: cpOutputs,
            alreadySelected: [],
            path: 'selectedCpOutputs',
            selected: false,
            minWidth: '400px'
          },
          {
            filterName: 'Donors',
            type: 'esmm', // etools-dropdown-multi
            optionValue: 'value',
            optionLabel: 'label',
            selectionOptions: donors,
            alreadySelected: [],
            path: 'selectedDonors',
            selected: false,
            minWidth: '400px'
          },
          {
            filterName: 'Ends Before',
            type: 'datepicker', // etools-datepicker
            path: 'endDate',
            dateSelected: '',
            selected: false
          },
          {
            filterName: 'Grants',
            type: 'esmm', // etools-dropdown-multi
            optionValue: 'value',
            optionLabel: 'label',
            selectionOptions: grants,
            alreadySelected: [],
            path: 'selectedGrants',
            selected: false,
            minWidth: '400px'
          },
          {
            filterName: 'Offices',
            type: 'esmm', // etools-dropdown-multi
            optionValue: 'id',
            optionLabel: 'name',
            selectionOptions: offices,
            alreadySelected: [],
            path: 'selectedOffices',
            selected: true,
            minWidth: '250px',
            hideSearch: true
          },
          {
            filterName: 'PD/SSFA Type',
            type: 'esmm', // etools-dropdown-multi
            optionValue: 'value',
            optionLabel: 'label',
            selectionOptions: documentTypes,
            alreadySelected: [],
            path: 'selectedDocumentTypes',
            selected: true,
            minWidth: '400px',
            hideSearch: true
          },
          {
            filterName: 'Sections',
            type: 'esmm', // etools-dropdown-multi
            optionValue: 'id',
            optionLabel: 'name',
            selectionOptions: sections,
            alreadySelected: [],
            path: 'selectedSections',
            selected: true,
            minWidth: '350px',
            hideSearch: true
          },
          {
            filterName: 'Starts After',
            type: 'datepicker', // etools-datepicker
            path: 'startDate',
            dateSelected: '',
            selected: false
          },
          {
            filterName: 'Status',
            type: 'esmm', // etools-dropdown-multi
            optionValue: 'value',
            optionLabel: 'label',
            selectionOptions: interventionStatuses,
            alreadySelected: [],
            path: 'selectedStatuses',
            selected: true,
            minWidth: '160px',
            hideSearch: true
          },
          {
            filterName: 'UNICEF focal point',
            type: 'esmm', // etools-dropdown-multi
            optionValue: 'id',
            optionLabel: 'name',
            selectionOptions: unicefUsersData,
            alreadySelected: [],
            path: 'selectedUnicefFocalPoints',
            selected: false,
            minWidth: '400px'
          }
        ]);
        this._updateSelectedFiltersValues();
      }

      // Input: URL query params
      // Initializes the properties of the list at page load
      // to the params interpretted from the URL string.
      _init(active) {
        let urlQueryParams = this.urlParams;
        if (!active || !urlQueryParams) {
          return;
        }
        if(_.isEmpty(urlQueryParams)) {
          urlQueryParams.status = 'draft|signed|active|ended|suspended';
        }

        this.set('initComplete', false);
        this.setProperties(
          {
            q: urlQueryParams.q ? urlQueryParams.q : '',
            selectedDocumentTypes: this._getFilterUrlValuesAsArray(urlQueryParams.type),
            selectedStatuses: this._getFilterUrlValuesAsArray(urlQueryParams.status),
            selectedCpOutputs: this._getFilterUrlValuesAsArray(urlQueryParams.cp_outputs),
            selectedSections: this._getFilterUrlValuesAsArray(urlQueryParams.section),
            selectedDonors: this._getFilterUrlValuesAsArray(urlQueryParams.donors),
            selectedGrants: this._getFilterUrlValuesAsArray(urlQueryParams.grants),
            selectedUnicefFocalPoints: this._getFilterUrlValuesAsArray(urlQueryParams.unicef_focal_points),
            selectedOffices: this._getFilterUrlValuesAsArray(urlQueryParams.offices),
            selectedCPStructures: this._getFilterUrlValuesAsArray(urlQueryParams.cpStructures),
            startDate: urlQueryParams.start ? urlQueryParams.start : '',
            endDate: urlQueryParams.end ? urlQueryParams.end : ''
          }
        );

        this.setPaginationDataFromUrlParams(urlQueryParams);

        // format of sort param is sort=field.order ex: sort=partner_name.asc
        let result = this.initSortFieldsValues({field: 'partner_name', direction: 'asc'}, urlQueryParams.sort);
        this.set('sortOrder', result);
        this.set('initComplete', true);

        this._updateSelectedFiltersValues();
      }

      // update selected filters(present in URL) at page refresh
      _updateSelectedFiltersValues() {
        this._updateFiltersValsDebouncer = Polymer.Debouncer.debounce(this._updateFiltersValsDebouncer,
            Polymer.Async.timeOut.after(100),
            () => {
              let filtersValues = [
                {
                  filterName: 'Status',
                  selectedValue: this.selectedStatuses
                },
                {
                  filterName: 'PD/SSFA Type',
                  selectedValue: this.selectedDocumentTypes
                },
                {
                  filterName: 'Sections',
                  selectedValue: this.selectedSections
                },
                {
                  filterName: 'Offices',
                  selectedValue: this.selectedOffices
                },
                {
                  filterName: 'CP Structure',
                  selectedValue: this.selectedCPStructures
                },
                {
                  filterName: 'Country Programme Output',
                  selectedValue: this.selectedCpOutputs
                },
                {
                  filterName: 'Donors',
                  selectedValue: this.selectedDonors
                },
                {
                  filterName: 'Grants',
                  selectedValue: this.selectedGrants
                },
                {
                  filterName: 'UNICEF focal point',
                  selectedValue: this.selectedUnicefFocalPoints
                },
                {
                  filterName: 'Starts After',
                  selectedValue: this.startDate
                },
                {
                  filterName: 'Ends Before',
                  selectedValue: this.endDate
                }
              ];
              this.updateShownFilters(filtersValues);
            });
      }

      // Updates URL state with new query string, and launches query
      _updateUrlAndData() {
        if (this._canFilterData()) {
          this.set('csvDownloadQs', this._buildCsvDownloadQueryString());
          let qs = this._buildQueryString();
          this._updateUrlAndDislayedData('interventions/list', _interventionsLastNavigated, qs,
              this._filterListData.bind(this));
          _interventionsLastNavigated = qs || _interventionsLastNavigated;
        }
      }

      _filterListData(forceNoLoading) {
        // Query is debounced with a debounce time
        // set depending on what action the user takes
        this._queryDebouncer = Polymer.Debouncer.debounce(this._queryDebouncer,
            Polymer.Async.timeOut.after(this.debounceTime),
            () => {
              let interventions = this.shadowRoot.querySelector('#interventions');
              if (!interventions) {
                return;
              }
              interventions.query(
                  this.sortOrder.field,
                  this.sortOrder.direction,
                  this.q.toLowerCase(),
                  this.selectedDocumentTypes,
                  this.selectedCpOutputs.map(cpo => String(cpo)),
                  this.selectedDonors,
                  this.selectedGrants,
                  this.selectedStatuses,
                  this.selectedSections.map(s => String(s)),
                  this.selectedUnicefFocalPoints.map(ufc => String(ufc)),
                  this.selectedOffices.map(o => String(o)),
                  this.selectedCPStructures,
                  this.startDate,
                  this.endDate,
                  this.paginator.page,
                  this.paginator.page_size,
                  forceNoLoading ? false : this.showQueryLoading
              );
            });
      }

      // Outputs the query string for the list
      _buildQueryString() {
        return this._buildUrlQueryString({
          page: this.paginator.page,
          size: this.paginator.page_size,
          q: this.q,
          type: this.selectedDocumentTypes.join('|'),
          status: this.selectedStatuses.join('|'),
          section: this.selectedSections.join('|'),
          offices: this.selectedOffices.join('|'),
          cp_outputs: this.selectedCpOutputs.join('|'),
          donors: this.selectedDonors.join('|'),
          grants: this.selectedGrants.join('|'),
          unicef_focal_points: this.selectedUnicefFocalPoints.join('|'),
          cpStructures: this.selectedCPStructures.join('|'),
          start: this.startDate,
          end: this.endDate,
          sort: this.sortOrder
        });
      }

      _buildCsvDownloadQueryString() {
        let params = {
          status: this.selectedStatuses,
          document_type: this.selectedDocumentTypes,
          sections: this.selectedSections,
          office: this.selectedOffices,
          donors: this.selectedDonors,
          grants: this.selectedGrants,
          unicef_focal_points: this.selectedUnicefFocalPoints,
          country_programme: this.selectedCPStructures,
          cp_outputs: this.selectedCpOutputs,
          start: this.startDate,
          end: this.endDate,
          search: this.q
        };
        return this._buildExportQueryString(params);
      }

      _filtersChanged() {
        this.set('debounceTime', 150);
        this.resetPageNumber();
      }

      _arrayFilterChanged(filterVal, oldFilterVals) {
        if (typeof oldFilterVals !== 'undefined' && filterVal.length !== oldFilterVals.length) {
          this._filtersChanged();
        }
      }

      _canShowListDatesFrsWarnings(status) {
        return (status !== this.CONSTANTS.STATUSES.Draft.toLowerCase() &&
                status !== this.CONSTANTS.STATUSES.Closed.toLowerCase());
      }

      _hideDateFrsWarningTooltip(pdDate, frsDate, status) {
        return !(this._canShowListDatesFrsWarnings(status) && !this.validateFrsVsInterventionDates(pdDate, frsDate));
      }

      _triggerInterventionLoadingMsg() {
        this.fireEvent('trigger-intervention-loading-msg');
      }

    }

    window.customElements.define(InterventionsList.is, InterventionsList);
  </script>
</dom-module>
