<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../reports/components/reports-display-list.html">
<link rel="import" href="../../../../mixins/app-navigation-helper-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">

<link rel="import" href="../../../../scripts/lodash.html">

<dom-module id="intervention-reports">
  <template>
    <style>
      :host {
        @apply --layout-flex;
        width: 100%;
      }
    </style>

    <reports-display-list intervention-id="[[interventionId]]"
                          paginator="{{paginator}}"
                          no-pd-ssfa-ref></reports-display-list>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsPmpApp.Mixins.AppNavigationHelper
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const InterventionReportsMixins = EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.AppNavigationHelper,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin InterventionReportsMixins
     */
    class InterventionReports extends InterventionReportsMixins {

      static get is() {
        return 'intervention-reports';
      }

      static get properties() {
        return {
          interventionId: Number,
          paginator: Object,
          prevParams: Object,
          active: Boolean,
          initComplete: Boolean
        };
      }

      static get observers() {
        return [
          '_init(active)',
          '_updateURL(paginator.page, paginator.page_size, interventionId, initComplete)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for reports tab elements load,
         * triggered by parent element on stamp or by tap event on tabs
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'interv-page'});
        this.fireEvent('tab-content-attached');
      }

      _init(active) {
        this.set('initComplete', false);
        if (!active) {
          return;
        }

        let page = (this.prevParams && this.prevParams.page) ? Number(this.prevParams.page) : 1;
        let pageSize = (this.prevParams && this.prevParams.page_size) ? Number(this.prevParams.page_size) : 10;
        this.set('paginator.page', page);
        this.set('paginator.page_size', pageSize);

        this.set('initComplete', true);
      }

      _updateURL(page, pageSize, interventionId, initComplete) {
        if (typeof page === 'undefined' || typeof pageSize === 'undefined') {
          return;
        }
        if (!initComplete || !interventionId) {
          return;
        }
        if (!_.isEmpty(this.prevParams) && page === this.prevParams.page &&
            pageSize === this.prevParams.page_size) {
          // avoid multiple url updates with the same params
          return;
        }

        this._debounceUrlUpdate = Polymer.Debouncer.debounce(this._debounceUrlUpdate,
            Polymer.Async.timeOut.after(20),
            () => {
              // prevent url change if active is changed to false before debounce func is executed
              if (!this.active) {
                return;
              }
              let qs = 'page=' + page + '&' + 'page_size=' + pageSize;
              this.updateAppState('interventions/' + interventionId + '/reports', qs, true);
              this.set('prevParams', Object.assign({}, {page: page, page_size: pageSize}));
            });
      }
    }

    window.customElements.define(InterventionReports.is, InterventionReports);
  </script>
</dom-module>
