<link rel="import" href="../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../../bower_components/etools-dialog/dynamic-dialog-mixin.html">
<link rel="import" href="../../../../../../../bower_components/etools-ajax/etools-ajax-request-mixin.html">
<link rel="import" href="../../../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../../../../bower_components/etools-info-tooltip/etools-info-tooltip.html">

<link rel="import" href="../../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../../mixins/array-helper-mixin.html">
<link rel="import" href="../../../../../mixins/fr-numbers-consistency-mixin.html">

<link rel="import" href="../../../../../styles/app-mixins.html">
<link rel="import" href="fr-warnings-styles.html">

<link rel="import" href="update-fr-numbers.html">

<dom-module id="intervention-fund-reservations">
  <template strip-whitespace>
    <style include="fr-warnings-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        display: block;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      #frs-container {
        padding: 16px 0;
      }
      .fr-number {
        padding: 8px 12px;
        font-size: 16px;
        box-sizing: border-box;
      }
      .warning {
        padding: 24px;
      }
      .warning,
      .fr-number {
        line-height: 24px;
      }
    </style>

    <etools-content-panel panel-title="Fund Reservations">
      <paper-icon-button slot="panel-btns"
                         icon="add-box"
                         on-tap="_openFrsUpdateDialog"
                         hidden$="[[!editMode]]"
                         disabled$="[[!editMode]]"></paper-icon-button>
      <div id="frs-container" hidden$="[[!noFrsWarning(intervention.frs_details)]]">
        <etools-info-tooltip class="frs-inline-list"
                             icon-first
                             custom-icon
                             hide-tooltip$="[[!frsConsistencyWarningIsActive(_frsConsistencyWarning)]]">
          <div slot="field">
            <template is="dom-repeat" items="[[intervention.frs_details.frs]]">
              <span class="fr-number">[[item.fr_number]]</span>
            </template>
          </div>
          <iron-icon icon="pmp-custom-icons:not-equal" slot="custom-icon"></iron-icon>
          <span slot="message"><span>[[_frsConsistencyWarning]]</span></span>
        </etools-info-tooltip>
      </div>
      <!-- class or slot? -->
      <div class="warning" hidden$="[[noFrsWarning(intervention.frs_details)]]">
        [[_getFrsWarningText(intervention.id)]]
      </div>

    </etools-content-panel>

  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsAjaxRequestMixin
     * @appliesMixin Polymer.GestureEventListeners
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.ArrayHelper
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsMixins.DynamicDialogMixin
     * @appliesMixin EtoolsPmpApp.Mixins.FrNumbersConsistency
     */
    const InterventionFundReservationsMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsAjaxRequestMixin,
      Polymer.GestureEventListeners,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.ArrayHelper,
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsMixins.DynamicDialogMixin,
      EtoolsPmpApp.Mixins.FrNumbersConsistency
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin InterventionFundReservationsMixins
     */
    class InterventionFundReservations extends InterventionFundReservationsMixins {
      static get is() {
        return 'intervention-fund-reservations';
      }

      static get properties() {
        return {
          intervention: {
            type: Object
          },
          editMode: {
            type: Boolean
          },
          updateFrNumbersEl: {
            type: Object
          },
          frsConfirmationsDialog: {
            type: Object
          },
          _frsDetailsRequestEndpoint: {
            type: Object
          },
          _lastFrsDetailsRequested: {
            type: Array,
            value: []
          },
          _lastFrsDetailsReceived: {
            type: Object
          },
          _frsConsistencyWarning: {
            type: String,
            value: ''
          },
          _frsConfirmationsDialogMessage: {
            type: String
          },
          _frsNrsLoadingMsgSource: {
            type: String,
            value: 'fr-nrs-check'
          }
        };
      }

      static get observers() {
        return [
          '_frsDetailsChanged(intervention.frs_details, intervention.planned_budget.unicef_cash_local,' +
            ' intervention.start, intervention.end)',
        ];
      },

      ready() {
        super.ready();
        this.set('_frsDetailsRequestEndpoint', this.getEndpoint('frNumbersDetails'));
      }

      connectedCallback() {
        super.connectedCallback();
        this._createUpdateFrNumbersEl();
        this._createFrsConfirmationsDialog();
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        // remove update frs el on fr el detached
        if (this.updateFrNumbersEl) {
          document.querySelector('body').removeChild(this.updateFrNumbersEl);
        }
        // remove confirmations frs dialog on fr element detached
        if (this.frsConfirmationsDialog) {
          this.removeDialog(this.frsConfirmationsDialog);
        }
      }

      _createUpdateFrNumbersEl() {
        // init frs update element
        this.updateFrNumbersEl = document.createElement('update-fr-numbers');
        this.updateFrNumbersEl.setAttribute('id', 'frNumbersUpdateEl');

        // attach frs update handler (on modal/dialog close)
        this.updateFrNumbersEl.addEventListener('update-frs-dialog-close', this.frNumbersUpdateHandler.bind(this));

        document.querySelector('body').appendChild(this.updateFrNumbersEl);
      }

      _createFrsConfirmationsDialog() {
        // init frs confirmations dialog element
        this._frsConfirmationsDialogMessage = document.createElement('span');
        this._frsConfirmationsDialogMessage.setAttribute('id', 'frsConfirmationsDialogMessage');

        this.frsConfirmationsDialog = this.createDialog('Fund Reservation Warning', 'md', 'Yes', 'No',
            this._frsUpdatesWarningConfirmationHandler.bind(this), this._frsConfirmationsDialogMessage);
      }

      _frsUpdateWarningMessage(warning) {
        if (!this.frsConfirmationsDialog) {
          return;
        }
        if (this._frsConfirmationsDialogMessage) {
          this._frsConfirmationsDialogMessage.innerHTML = warning + '<br><br>Do you want to continue?';
        } else {
          this.logWarn('frsConfirmationsDialogMessage element not found', 'Fund Reservations');
        }
      }

      _openFrsUpdateDialog(frNumbersList, enableConfirmBtn) {
        if (!this.editMode) {
          return;
        }
        if (this.updateFrNumbersEl) {
          // populate dialog with current frs numbers deep copy
          let currentFrs = this._getCurrentFrs();
          let frs = frNumbersList instanceof Array
              ? frNumbersList
              : currentFrs.map((fr) => {
                return {fr_number: fr.fr_number};
              });
          this.updateFrNumbersEl.set('dataItems', frs);
          // deactivate save button until any valid change is made
          enableConfirmBtn = typeof enableConfirmBtn === 'boolean' ? enableConfirmBtn : true;
          this.updateFrNumbersEl.set('disableConfirmBtn', enableConfirmBtn);

          this.updateFrNumbersEl.set('interventionStatus', this.intervention.status);
          // open dialog
          this.updateFrNumbersEl.openDialog();
        }
      }

      // get current intervention frs numbers
      _getCurrentFrs() {
        return (this.intervention.frs_details && this.intervention.frs_details.frs instanceof Array)
            ? this.intervention.frs_details.frs : [];
      }

      frNumbersUpdateHandler(e) {
        e.stopImmediatePropagation();
        let frNumbers = e.detail.frs;
        this.fireEvent('global-loading', {
          message: 'Checking FR Numbers updates...',
          active: true,
          loadingSource: this._frsNrsLoadingMsgSource
        });
        if (frNumbers.length === 0) {
          this._handleEmptyFrsAfterUpdate();
          return;
        }
        // FR Numbers not empty
        this._handleNotEmptyFrsAfterUpdate(frNumbers);
      }

      /**
        * After FR Numbers update the numbers list might be empty.
        * This can happen is the user removed all the existing numbers or if there is no change made
        */
      _handleEmptyFrsAfterUpdate() {
        let currentInterventionFrs = this._getCurrentFrs();
        if (currentInterventionFrs.length === 0) {
          // there is no change on FR Numbers
          this._disableFrsCheckLoadingMsg();
          return;
        }
        // all FR Numbers have been deleted
        this._triggerPdFrsUpdate({frs: []});
        this._disableFrsCheckLoadingMsg();
      }

      /**
        * Updates made and FR Numbers list is not empty
        */
      _handleNotEmptyFrsAfterUpdate(frNumbers) {
        let diff = this.getArraysDiff(this._getCurrentFrs(), frNumbers, 'fr_number');
        if (diff.length) {
          // request FR Numbers details from server
          this._triggerFrsDetailsRequest(frNumbers);
          return;
        } // else no changes have been made to FR Numbers
        this._disableFrsCheckLoadingMsg();
      }

      // handle frs validations warning confirmation
      _frsUpdatesWarningConfirmationHandler(e) {
        e.stopImmediatePropagation();
        if (e.detail.confirmed) {
          // confirmed, add numbers to intervention
          this._triggerPdFrsUpdate(Object.assign({}, this._lastFrsDetailsReceived));
          this.set('_lastFrsDetailsReceived', null);
        } else {
          // frs warning not confirmed/cancelled, frs update is canceled
          // re-check frs warning on initial data
          this._frsDetailsChanged(this.intervention.frs_details);
        }
      }

      /**
        * Get FR Numbers details from server
        */
      _triggerFrsDetailsRequest(frNumbers) {
        let url = this._frsDetailsRequestEndpoint.url + '?values=' + frNumbers.join(',');
        if (this.intervention.id) {
          url += '&intervention=' + this.intervention.id;
        }
        this.set('_lastFrsDetailsRequested', frNumbers);

        let self = this;
        this.sendRequest({
          endpoint: {url: url}
        }).then((resp) => {
          self._frsDetailsSuccessHandler(resp);
        }).catch((error) => {
          self._frsDetailsErrorHandler(error.response);
        });
      }

      /*
      * Frs details received, check frs consistency
      */
      _frsDetailsSuccessHandler(frsDetails) {
        // check added frs currencies mismatch
        frsDetails.currencies_match = this._frsCurrenciesMatch(frsDetails.frs);
        let warning = this.checkFrsConsistency(frsDetails, this.intervention, true);
        this.set('_frsConsistencyWarning', warning);
        if (warning) {
          this._frsUpdateWarningMessage(warning);
          this._disableFrsCheckLoadingMsg();
          // show warning
          this.set('_lastFrsDetailsReceived', frsDetails);
          this._openFrNumbersAmountsValidationWarning();
          return;
        }
        // append FR numbers to intervention
        this._disableFrsCheckLoadingMsg();
        this._triggerPdFrsUpdate(frsDetails);
      }

      /**
        * frs details request failed
        */
      _frsDetailsErrorHandle(responseErr) {
        this._disableFrsCheckLoadingMsg();
        let frs = this._lastFrsDetailsRequested.map((fr) => {
          return {fr_number: fr};
        });
        // open FR Numbers modal with the same state as before details request
        this._openFrsUpdateDialog(frs, false);
        this.set('_lastFrsDetailsRequested', []);
        // show the invalid frs warning
        this.fireEvent('toast', {
          text: responseErr.error,
          showCloseBtn: true
        });
      }

      // trigger new FR Numbers update on main intervention
      _triggerPdFrsUpdate(newFrsDetails) {
        this.fireEvent('frs-update', {frsDetails: newFrsDetails});
      }

      noFrsWarning(frsDetails) {
        let frs = this._getCurrentFrs();
        return !!frs.length;
      }

      _openFrNumbersAmountsValidationWarning() {
        if (this.frsConfirmationsDialog) {
          this.frsConfirmationsDialog.opened = true;
        }
      }

      _getFrsWarningText(interventionId) {
        let msg = 'There are no fund reservations numbers added.';
        if (!interventionId) {
          msg = 'You can not add FR Numbers. The PD/SSFA needs to be saved first.';
        }
        return msg;
      }

      _frsDetailsChanged(frsDetails) {
        this._frsDetailsDebouncer = Polymer.Debouncer.debounce(this._frsDetailsDebouncer,
          Polymer.Async.timeOut.after(10),
          () => {
            this.set('_frsConsistencyWarning', this.checkFrsConsistency(frsDetails, this.intervention));
          });
      }

      _disableFrsCheckLoadingMsg() {
        this.fireEvent('global-loading', {active: false, loadingSource: this._frsNrsLoadingMsgSource});
      }

    }

    window.customElements.define(InterventionFundReservations.is, InterventionFundReservations);
  </script>
</dom-module>
