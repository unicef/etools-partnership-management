<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../bower_components/etools-dropdown/etools-dropdown.html">
<link rel="import" href="../../../../../../bower_components/etools-upload/etools-upload.html">

<link rel="import" href="../../../../layout/components/etools-date-input.html">
<link rel="import" href="../../../../layout/components/etools-single-file.html">
<link rel="import" href="../../../../layout/components/etools-form-element-wrapper.html">

<link rel="import" href="../../../../styles/page-common-styles.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/file-styles.html">
<link rel="import" href="../../../../styles/required-field-styles.html">

<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">

<link rel="import" href="../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../config/app-constants.html">
<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/missing-dropdown-options-mixin.html">
<link rel="import" href="../../../../mixins/date-mixin.html">
<link rel="import" href="../../../../endpoints/endpoints.html">

<link rel="import" href="components/amendments/pd-amendments.html">
<link rel="import" href="components/fund-reservations/fund-reservations.html">

<dom-module id="intervention-review-and-sign">
  <template strip-whitespace>
    <style include="page-common-styles grid-layout-styles shared-styles file-styles required-field-starred-styles">
      :host {
        @apply --layout-vertical;
        width: 100%;

        --etools-file-upload-button: {
          /* overrides previus color, possibly from pd-attachements */
          color: var(--etools-file-main-btn-color);
        };
      }

      paper-input {
        width: 100%;
      }

      paper-checkbox {
        @apply --layout-horizontal;
        @apply --layout-center;
        min-height: 24px;
      }

      paper-checkbox[disabled] {
        cursor: not-allowed;
        --paper-checkbox-unchecked-color: black;
        --paper-checkbox-label: {
          color: var(--primary-text-color);
          opacity: 1;
        };
      }
    </style>

    <etools-content-panel class="content-section" panel-title="Signatures & Dates">
      <div class="row-h flex-c">
        <div class="col col-3">
          <!-- Document Submission Date -->
          <etools-date-input id="submissionDateField"
                             label="Document Submission Date"
                             value="{{intervention.submission_date}}"
                             readonly$="[[!permissions.edit.submission_date]]"
                             no-init show-clear-btn>
          </etools-date-input>
        </div>
        <div class="col col-3">
          <!-- Submitted to PRC? -->
          <etools-form-element-wrapper no-placeholder>
            <paper-checkbox checked="{{intervention.submitted_to_prc}}"
                            disabled$="[[_isSubmittedToPrcCheckReadonly(permissions.edit.prc_review_document, _lockSubmitToPrc)]]"
                            hidden$="[[!_submittedToPrcAvailable(intervention.document_type)]]">
              Submitted to PRC?
            </paper-checkbox>
          </etools-form-element-wrapper>
        </div>
      </div>
      <template is="dom-if" if="[[_showSubmittedToPrcFields(intervention.submitted_to_prc)]]">
        <div class="row-h flex-c row-second-bg">
          <div class="col col-3">
            <!-- Submission Date to PRC -->
            <etools-date-input id="submissionDatePrcField"
                               label="Submission Date to PRC"
                               value="{{intervention.submission_date_prc}}"
                               readonly$="[[!permissions.edit.submission_date_prc]]"
                               no-init show-clear-btn>
            </etools-date-input>
          </div>
          <div class="col col-3">
            <!-- Review Date by PRC -->
            <etools-date-input id="reviewDatePrcField"
                               label="Review Date by PRC"
                               value="{{intervention.review_date_prc}}"
                               readonly$="[[!permissions.edit.review_date_prc]]"
                               no-init show-clear-btn>
            </etools-date-input>
          </div>
          <div class="col col-6 file-container space-left">
            <!-- PRC Review Document -->
            <etools-upload
                       label="PRC Review Document"
                       accept=".doc,.docx,.pdf,.jpg,.png"
                       file-url="[[intervention.prc_review_attachment]]"
                       upload-endpoint="[[uploadEndpoint]]"
                       on-upload-finished="_prcRevDocUploadFinished"
                       auto-validate
                       readonly$="[[!permissions.edit.prc_review_document]]">
          </etools-upload>
          </div>
        </div>
      </template>
      <div class="row-h flex-c">
        <div class="col col-6">
          <!-- Signed By Partner Authorized Officer -->
          <etools-dropdown id="signedByAuthorizedOfficer"
                           label="Signed By Partner Authorized Officer"
                           placeholder="&#8212;"
                           options="[[agreementAuthorizedOfficers]]"
                           selected="{{intervention.partner_authorized_officer_signatory}}"
                           readonly$="[[!permissions.edit.partner_authorized_officer_signatory]]"
                           required$="[[permissions.required.partner_authorized_officer_signatory]]"
                           auto-validate
                           error-message="Please select Partner Authorized Officer">
          </etools-dropdown>
        </div>
        <div class="col col-3">
          <!-- Signed by Partner Date -->
          <etools-date-input id="signedByPartnerDateField"
                             label="Signed by Partner Date"
                             value="{{intervention.signed_by_partner_date}}"
                             readonly="[[!permissions.edit.signed_by_partner_date]]"
                             required$="[[permissions.required.signed_by_partner_date]]"
                             auto-validate
                             error-message="Date is required"
                             no-init show-clear-btn disable-future-dates>
          </etools-date-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <!-- Signed by UNICEF Authorized Officer -->
          <etools-form-element-wrapper no-placeholder>
              Signed by UNICEF Authorized Officer
          </etools-form-element-wrapper>
        </div>
        <div class="col col-3">
          <!-- Signed by UNICEF Date -->
          <etools-date-input id="signedByUnicefDateField"
                             label="Signed by UNICEF Date"
                             value="{{intervention.signed_by_unicef_date}}"
                             readonly="[[!permissions.edit.signed_by_unicef_date]]"
                             required$="[[permissions.required.signed_by_unicef_date]]"
                             auto-validate
                             error-message="Date is required"
                             no-init show-clear-btn disable-future-dates>
          </etools-date-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <!-- Signed by UNICEF -->
          <etools-dropdown id="signedByUnicef"
                           label="Signed by UNICEF"
                           placeholder="&#8212;"
                           options="[[getCleanEsmmOptions(signedByUnicefUsers, intervention)]]"
                           option-value="id"
                           option-label="name"
                           selected="{{intervention.unicef_signatory}}"
                           readonly$="[[!permissions.edit.unicef_signatory]]"
                           auto-validate
                           error-message="Please select UNICEF user">
          </etools-dropdown>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6 file-container space-left">
          <!-- Signed PD/SSFA -->
          <etools-upload id="signedIntervFile"
                       label="Signed PD/SSFA"
                       accept=".doc,.docx,.pdf,.jpg,.png"
                       file-url="[[intervention.signed_pd_attachment]]"
                       upload-endpoint="[[uploadEndpoint]]"
                       on-upload-finished="_signedPDUploadFinished"
                       auto-validate
                       readonly$="[[!permissions.edit.signed_pd_document]]"
                       required$="[[permissions.required.signed_pd_document]]"
                       error-message="Please select Signed PD/SSFA document">
          </etools-upload>
        </div>
        <template is="dom-if" if="[[_showDaysToSignedFields(intervention.status)]]">
          <div class="col col-3">
            <paper-input label="Days from Submission to Signed"
                             value="[[intervention.days_from_submission_to_signed]]"
                             placeholder="&#8212;" readonly>
            </paper-input>
          </div>
          <div class="col col-3">
            <paper-input label="Days from Review to Signed"
                             value="[[intervention.days_from_review_to_signed]]"
                             placeholder="&#8212;" readonly>
            </paper-input>
          </div>
        </template>

      </div>
    </etools-content-panel>

    <template is="dom-if" if="[[!_isDraft(intervention.status)]]">
      <pd-amendments class="content-section"
                     intervention-document-type="[[intervention.document_type]]"
                     intervention-id="[[intervention.id]]"
                     amendments="{{intervention.amendments}}"
                     edit-mode="[[permissions.edit.amendments]]">
      </pd-amendments>
    </template>

    <fund-reservations class="content-section"
                       intervention="[[intervention]]"
                       edit-mode="[[permissions.edit.frs]]"
                       on-frs-update="_handleFrsUpdate">
    </fund-reservations>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.Date
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.MissingDropdownOptions
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @applesMixin EtoolsPmpApp.Mixins.Constants
     */
    const InterventionReviewAndSignMixin = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.Date,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.MissingDropdownOptions,
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.Constants
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin InterventionReviewAndSignMixin
     */
    class InterventionReviewAndSign extends InterventionReviewAndSignMixin {

      static get is() {
        return 'intervention-review-and-sign';
      }

      static get properties() {
        return {
          intervention: {
            type: Object,
            notify: true,
            observer: '_interventionChanged'
          },
          permissions: {
            type: Object,
            statePath: 'pageData.permissions'
          },
          signedByUnicefUsers: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          agreement: {
            type: Object,
            value: null,
            observer: '_agreementChanged'
          },
          agreementAuthorizedOfficers: {
            type: Array,
            value: []
          },
          _lockSubmitToPrc: {
            type: Boolean,
            value: false
          },
          partnerDateValidatorErrorMessage: {
            type: String,
            value: ''
          },
          unicefDateValidatorErrorMessage: {
            type: String,
            value: ''
          },
          uploadEndpoint: String
        };
      }

      static get observers() {
        return [
          '_interventionDocTypeChanged(intervention.document_type)',
          '_signedPdDocHasChanged(intervention.signed_pd_attachment)',
          '_updateStyles(permissions.edit.prc_review_document, _lockSubmitToPrc)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for review and sign tab elements load,
         * triggered by parent element on stamp or by tap event on tabs
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'interv-page'});
        this.setDropdownMissingOptionsAjaxDetails(this.$.signedByUnicef, 'unicefUsers', {dropdown: true});
        this.fireEvent('tab-content-attached');
        this.set('uploadEndpoint', EtoolsPmpApp.Endpoints.attachmentsUpload.url);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
      }

      _updateStyles() {
        this.updateStyles();
      }

      _isDraft(status) {
        return status === this.CONSTANTS.STATUSES.Draft.toLowerCase() ||
               status === '';
      }

      _interventionChanged(intervention) {
        // check if submitted to PRC was already saved
        if (intervention && intervention.id && intervention.submitted_to_prc) {
          this.set('_lockSubmitToPrc', true);
        } else {
          this.set('_lockSubmitToPrc', false);
        }
        if (!intervention.prc_review_attachment) {
          this.set('intervention.prc_review_attachment', null);
        }
      }

      _hideDeleteBtn(status, fileUrl) {
        return this._isDraft(status) && fileUrl;
      }

      _agreementChanged(agreement) {
        if (agreement && typeof agreement === 'object' && Object.keys(agreement).length > 0) {
          let authorizedOfficerData = agreement.authorized_officers.map((officer) => {
            return {
              value: parseInt(officer.id, 10),
              label: officer.first_name + ' ' + officer.last_name
            };
          });

          this.set('agreementAuthorizedOfficers', authorizedOfficerData);
        }
      }

      validate() {
        let valid = true;
        let field = this.shadowRoot.querySelector('#signedIntervFile');
        if (field && !field.validate()) {
          valid = false;
        }
        return valid;
      }

      _showSubmittedToPrcFields(submittedToPrc) {
        return this._submittedToPrcAvailable(this.intervention.documentType) && submittedToPrc;
      }

      _submittedToPrcAvailable(documentType) {
        return documentType !== this.CONSTANTS.DOCUMENT_TYPES.SSFA;
      }

      _showDaysToSignedFields(status) {
        return !this._isDraft(status);
      }

      _isSubmittedToPrcCheckReadonly(isPrcDocEditable, lockSubmitToPrc) {
        return !isPrcDocEditable || lockSubmitToPrc;
      }

      _interventionDocTypeChanged(interventionDocumentType) {
        if (typeof interventionDocumentType === 'undefined') {
          return;
        }

        let submittedToPrc = this._submittedToPrcAvailable(interventionDocumentType);
        if (!submittedToPrc) {
          this.set('intervention.submitted_to_prc', false);
          this._resetPrcFields();
        }
      }

      _resetPrcFields() {
        this.set('intervention.intervention.submission_date_prc', null);
        this.set('intervention.review_date_prc', null);
        this.set('intervention.prc_review_attachment', null);
      }

      // update FR Number on intervention
      _handleFrsUpdate(e) {
        e.stopImmediatePropagation();
        try {
          this.set('intervention.frs_details', e.detail.frsDetails);
          let frIds = e.detail.frsDetails.frs.map(fr => fr.id);
          this.set('intervention.frs', frIds);
        } catch (err) {
          this.logError('[_handleFrsUpdate] An error occurred during FR Numbers update', null, err);
        }
      }

      /**
       * If a signed document is selected then all fields required
       * for the intervention to move in signed status are required; only for draft status.
       */
      _signedPdDocHasChanged(signedDocument) {
        if (typeof signedDocument === 'undefined') {
          return;
        }
        if (this.intervention &&
            (this.intervention.status === this.CONSTANTS.STATUSES.Draft.toLowerCase() ||
            this.intervention.status === '')) {

          if (isNaN(signedDocument)) {
            this.fireEvent('signed-doc-change-for-draft', {docSelected: false});// TODO
          } else {
            // new document selected
            this.fireEvent('signed-doc-change-for-draft', {docSelected: true});
          }
        }
      }

      _signedPDUploadFinished(e) {
        if (e.detail.success) {
          const response = JSON.parse(e.detail.success);
          this.set('intervention.signed_pd_attachment', response.id);
        }
      }

      _prcRevDocUploadFinished(e) {
        if (e.detail.success) {
          const response = JSON.parse(e.detail.success);
          this.set('intervention.prc_review_attachment', response.id);
        }
      }

    }

    window.customElements.define(InterventionReviewAndSign.is, InterventionReviewAndSign);
  </script>
</dom-module>
