<link rel="import" href="../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../../../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">

<link rel="import" href="../../../../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../../../config/app-constants.html">

<link rel="import" href="../../../../../../layout/components/etools-single-file.html">
<link rel="import" href="../../../../../../layout/components/etools-date-input.html">
<link rel="import" href="../../../../../../layout/components/etools-warn-message.html">
<link rel="import" href="../../../../../../validators/required-and-not-future-date-validator.html">

<link rel="import" href="../../../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../../../styles/file-styles.html">
<link rel="import" href="../../../../../../styles/buttons-styles.html">
<link rel="import" href="../../../../../../styles/shared-styles.html">

<dom-module id="add-amendment-dialog">
  <template>
    <style include="grid-layout-styles buttons-styles file-styles shared-styles">

      :host {
        --etools-file-upload-button: {
          /* overrides previus color, possibly from pd-attachements */
          color: var(--etools-file-main-btn-color);
        };
      }

      .type-warning {
        color: var(--warning-color);
      }

      paper-input#other {
        width: 100%;
      }

      .row-h {
        padding-top: 0;
        padding-bottom: 16px;
        overflow: hidden;
      }
    </style>

    <etools-dialog no-padding
                   keep-dialog-open
                   id="add-amendment"
                   opened="{{opened}}"
                   size="md"
                   hidden$="[[datePickerOpen]]"
                   ok-btn-text="Save"
                   dialog-title="Add Amendment"
                   on-confirm-btn-clicked="_validateAndSaveAmendment">

      <div class="row-h flex-c">
        <required-and-not-future-date-validator validator-name="signedDate_validator"
                                                field-selector="#signed-date">
        </required-and-not-future-date-validator>
        <!-- Signed Date -->
        <etools-date-input id="signed-date"
                           label="Signed date"
                           value="{{newAmendment.signed_date}}"
                           required
                           open="{{datePickerOpen}}"
                           validator="signedDate_validator"
                           auto-validate
                           no-init show-clear-btn>
        </etools-date-input>
      </div>
      <div class="row-h flex-c">
        <!-- Amendment Type -->
        <etools-dropdown-multi id="amendment-types"
                               label="Amendment Types"
                               placeholder="&#8212;"
                               options="[[filteredAmendmentTypes]]"
                               selected-values="{{newAmendment.types}}"
                               dynamic-align
                               required
                               hide-search
                               error-message="Type is required">
        </etools-dropdown-multi>
      </div>
      <div class="row-h flex-c" hidden$="[[!newAmendment.types.length]]">
        <etools-warn-message message="[[_getSelectedAmendmentTypeWarning(newAmendment.types, newAmendment.types.length)]]">

        </etools-warn-message>
      </div>
      <div class="row-h" hidden$="[[!_showOtherInput(newAmendment.types, newAmendment.types.length)]]">
        <paper-input id="other"
                     placeholder="&#8212;"
                     label="Other"
                     invalid
                     required
                     auto-validate
                     error-message="This is required"
                     value="{{newAmendment.other_description}}">
        </paper-input>
      </div>
      <div class="row-h flex-c">
        <!-- Signed Agreement -->
        <etools-single-file id="file-upload"
                            label="Signed Agreement"
                            internal-file="[[newAmendment.signed_amendment_file]]"
                            file="{{newAmendment.signed_amendment}}"
                            accept=".doc,.docx,.pdf,.jpg,.png"
                            error-message="Attachment required"
                            required
                            auto-validate>
        </etools-single-file>
      </div>
    </etools-dialog>

  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.Constants
     */
    const AddAmendmentDialogMixin = EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.AjaxErrorsParser,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Constants
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin AddAmendmentDialogMixin
     */
    class AddAmendmentDialog extends AddAmendmentDialogMixin {
      static get is() {
        return 'add-amendment-dialog';
      }

      static get properties() {
        return {
          endpointName: {
            type: String,
            value: 'interventionAmendmentAdd'
          },
          toastEventSource: {
            type: Object
          },
          datePickerOpen: {
            type: Boolean,
            value: false
          },
          opened: {
            type: Boolean,
            notify: true,
            observer: '_resetFields'
          },
          interventionId: {
            type: Number
          },
          interventionDocumentType: {
            type: String
          },
          amendmentTypes: {
            type: Object,
            statePath: 'interventionAmendmentTypes'
          },
          filteredAmendmentTypes: {
            type: Object
          },
          newAmendment: {
            type: Object
          },
          newAmendmentModel: {
            type: Object,
            value: {
              'types': [],
              'other_description': null,
              'signed_date': null,
              'signed_amendment': null,
              'signed_amendment_file': '',
              'amendment_number': null
            }
          }
        };
      }

      static get observers() {
        return [
          '_filterAmendmentTypes(amendmentTypes, interventionDocumentType)'
        ];
      }

      ready() {
        super.ready();
        this.resetAmendment();
      }

      resetAmendment() {
        // this is to trigger change detection on etools-single-file
        this.set('newAmendment.signed_amendment_file', null);
        this.set('newAmendment', JSON.parse(JSON.stringify(this.newAmendmentModel)));
      }

      startSpinner() {
        this.shadowRoot.querySelector('#add-amendment').startSpinner();
      }

      stopSpinner() {
        this.shadowRoot.querySelector('#add-amendment').stopSpinner();
      }

      _filterAmendmentTypes(amendmentTypes, interventionDocumentType) {
        if (!amendmentTypes || !interventionDocumentType) {
          return;
        }
        if (interventionDocumentType === this.CONSTANTS.DOCUMENT_TYPES.SSFA) {
          this.filteredAmendmentTypes = this.amendmentTypes.filter((newAmendment) => {
            return [this.CONSTANTS.PD_AMENDMENT_TYPES.Dates,
                    this.CONSTANTS.PD_AMENDMENT_TYPES.Other].indexOf(newAmendment.label) > -1;
          });
        } else {
          this.filteredAmendmentTypes = JSON.parse(JSON.stringify(this.amendmentTypes));
        }
      }

      _showOtherInput() {
        let amdTypes = this.newAmendment.types;
        return amdTypes && amdTypes.indexOf('other') > -1;
      }

      isValidAmendment() {
        let isValid1 = this._validateAmendmentTypes();
        let isValid2 = this._validateOtherInput();
        let isValid3 = this._validateSignedDate();
        let isValid4 = this._validateFileUpload(this.newAmendment);

        return (isValid1 && isValid2 && isValid3 && isValid4);
      }

      _validateOtherInput() {
        let valid = true;
        if (this._showOtherInput()) {
          let otherEl = this.shadowRoot.querySelector('#other');
          if (otherEl && !otherEl.validate()) {
            valid = false;
          }
        }
        return valid;
      }

      _validateAmendmentTypes() {
        let valid = true;
        let typeEl = this.shadowRoot.querySelector('#amendment-types');
        if (typeEl && !typeEl.validate()) {
          valid = false;
        }
        return valid;
      }

      _validateFileUpload(amendment) {
        let valid = true;
        let fileUplodEl = this.shadowRoot.querySelector('#file-upload');
        if (fileUplodEl) {
          valid = !!amendment.signed_amendment;
          fileUplodEl.invalid = !valid;
        }
        return valid;
      }

      _validateSignedDate() {
        let isValid = true;

        let signedDateEl = this.shadowRoot.querySelector('#signed-date');
        if (signedDateEl) {
          if (!signedDateEl.validate()) {
            isValid = false;
          }
        }
        return isValid;
      }

      _resetFields() {
        this.resetAmendment();
        this._resetAmendmentValidations();
      }

      _resetAmendmentValidations() {
        let typeEl = this.shadowRoot.querySelector('#amendment-types');
        if (typeEl) {
          typeEl.invalid = false;
        }
        let signedDateEl = this.shadowRoot.querySelector('#signed-date');
        if (signedDateEl) {
          signedDateEl.invalid = false;
        }
        let fileUpload = this.shadowRoot.querySelector('#file-upload');
        if (fileUpload) {
          fileUpload.invalid = false;
        }
        let otherField = this.shadowRoot.querySelector('#other');
        if (otherField) {
          otherField.invalid = false;
        }
      }

      _getSelectedAmendmentTypeWarning(types) {
        if (!types || !types.length) {
          return;
        }
        let message = 'Please make sure you update ';
        types.forEach((amdType) => {
          switch (amdType) {
            case 'dates':
              message += 'Dates, ';
              break;
            case 'results':
              message += 'Programme Results, ';
              break;
            case 'budget':
              message += 'Planned Budget, ';
              break;
            case 'other':
              message += 'Other, ';
              break;
          }
        });
        message = message.substring(0, message.length - 2);
        message += ' section' + (message.indexOf(',') > -1 ? 's' : '') + ' of this PD/SSFA';
        return message;
      }

      _validateAndSaveAmendment() {
        if (!this.isValidAmendment()) {
          return;
        }
        this.startSpinner();

        let options = {
          method: 'POST',
          endpoint: this.getEndpoint(this.endpointName, {intervId: this.interventionId}),
          body: this.newAmendment,
          multiPart: true,
          prepareMultipartData: true
        };

        this.sendRequest(options)
            .then((resp) => {
              this._handleResponse(resp);
            }).catch((error) => {
          this._handleErrorResponse(error);
        });
      }

      _handleResponse(response) {
        this.set('opened', false);
        this.fireEvent('amendment-added', response);
        this.stopSpinner();
      }

      _handleErrorResponse(error) {
        this.stopSpinner();
        this.parseRequestErrorsAndShowAsToastMsgs(error, this.toastEventSource);
      }
    }

    window.customElements.define(AddAmendmentDialog.is, AddAmendmentDialog);
  </script>
</dom-module>
