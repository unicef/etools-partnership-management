<link rel="import" href="../../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../../../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../../../../../../bower_components/etools-dialog/etools-dialog.html">

<link rel="import" href="../../../../../../mixins/repeatable-data-sets-mixin.html">

<link rel="import" href="../../../../../../styles/app-mixins.html">
<link rel="import" href="../../../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../../../styles/repeatable-data-sets-styles.html">
<link rel="import" href="../../../../../../styles/buttons-styles.html">

<dom-module id="update-fr-numbers">
  <template strip-whitespace>
    <style include="grid-layout-styles repeatable-data-sets-styles buttons-styles">
      [hidden] {
        display: none !important;
      }

      :host {
        --paper-dialog-scrollable: {
          width: 100%;
          overflow-x: hidden;
          overflow-y: auto;
          max-height: 400px;
          padding: 0;
          margin-top: -20px;
          box-sizing: border-box;
        };
        --etools-dialog-title: {
          margin-bottom: 0 !important;
        }
      }
      paper-input {
        width: 250px;
      }

    </style>

    <etools-dialog id="frsDialog"
                   size="md"
                   dialog-title="Add/Update FR Numbers"
                   ok-btn-text="Add/Update"
                   on-close="_checkFrNumbers"
                   disable-confirm-btn="[[disableConfirmBtn]]"
                   no-padding>
      <template is="dom-repeat" items="{{dataItems}}">
        <div class="row-h item-container">
          <div class="item-actions-container">
            <div class="actions">
              <paper-icon-button class="action delete"
                                 on-tap="_openDeleteConfirmation"
                                 data-args$="[[index]]"
                                 icon="cancel"
                                 disabled$="[[!_showDeleteFrBtn(interventionStatus, dataItems.length)]]">
              </paper-icon-button>
            </div>
          </div>
          <div class="item-content">
            <div class="row-h">
              <!-- FR Number -->
              <paper-input id$="fr-nr-[[index]]"
                           label="FR Number"
                           value="{{item.fr_number}}"
                           placeholder="&#8212;"
                           allowed-pattern="[0-9]"
                           required
                           auto-validate
                           error-message="Please fill FR Number or remove the field"
                           on-value-changed="_rfNrValueChanged">
              </paper-input>
            </div>
          </div>
        </div>
      </template>

      <div class="row-h" hidden$="[[!_emptyList(dataItems.length)]]">
        There are no fund reservations numbers added.
      </div>

      <div class="row-h">
        <paper-button class="secondary-btn" on-tap="_addNewFundReservation">
          <iron-icon icon="add"></iron-icon>
          Add FR Number
        </paper-button>
      </div>
    </etools-dialog>

  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsPmpApp.Mixins.RepeatableDataSets
     */
    class UpdateFrNumbers extends EtoolsPmpApp.Mixins.RepeatableDataSets(Polymer.Element) {
      static get is() {
        return 'update-fr-numbers';
      }

      static get properties() {
        return {
          editMode: {
            type: Boolean,
            value: true
          },
          deleteDialog: {
            type: Object,
            observer: '_delConfirmationDialogChange'
          },
          deleteConfirmationMessage: {
            type: String,
            value: 'Are you sure you want to delete this FR Number?'
          },
          disableConfirmBtn: {
            type: Boolean,
            value: true
          },
          interventionStatus: {
            type: String
          }
        };
      }

      static get observers() {
        return ['_itemsLengthChanged(dataItems.length)'];
      }

      ready() {
        super.ready();
        this.dataSetModel = {fr_number: null};
      }

      _showDeleteFrBtn(interventionStatus, dataItemsLength) {
        return !(interventionStatus === 'active' && dataItemsLength === 1);
      }

      _delConfirmationDialogChange() {
        // update delete confirmation dialog size
        this.deleteDialog.set('size', 'sm');
      }

      openDialog() {
        this.$.frsDialog.opened = true;
      }

      validate() {
        let valid  = true;
        if (this.dataItems instanceof Array && this.dataItems.length > 0) {
          this.dataItems.forEach((item, index) => {
            let lastItem = this.shadowRoot.querySelector('#fr-nr-' + index);
            if (lastItem && !lastItem.validate()) {
              valid = false;
            }
          });
        }

        return valid;
      }

      _addNewFundReservation() {
        if (!this.validate()) {
          this.set('disableConfirmBtn', true);
          return;
        }
        this._addElement();
        this.set('disableConfirmBtn', true);
        setTimeout(this._centerDialog.bind(this), 0);
        setTimeout(this._updateScroll.bind(this), 100);
      }

      _centerDialog() {
        let d = this._getPaperDialog();
        if (d) {
          d.center();
        }
      }

      _updateScroll() {
        let d = this._getPaperDialog();
        if (d) {
          // TODO: Test this on IE
          let dialogScrollable = Polymer.dom(d).querySelector('paper-dialog-scrollable');
          if (dialogScrollable) {
            let scrollTarget = dialogScrollable.scrollTarget;
            scrollTarget.scrollTop = scrollTarget.scrollHeight;
          }
        }
      }

      _getPaperDialog() {
        // TODO: Test this on IE
        return Polymer.dom(this.$.frsDialog.root).querySelector('paper-dialog');
      }

      _emptyList(length) {
        return length === 0;
      }

      _rfNrValueChanged() {
        if (!this.validate()) {
          this.set('disableConfirmBtn', true);
          return;
        }
        this.set('disableConfirmBtn', false);
      }

      _itemsLengthChanged() {
        this._rfNrValueChanged();
      }

      _checkFrNumbers(e) {
        if (e.detail.confirmed) {
          // resend rf number changes back to main fund reservations element
          this.fireEvent('update-frs-dialog-close', {frs: this._getUpdatedFrsNumbers()});
        }
      }

      // prepare the rf numbers list, used to verify them using API endpoint (/api/v2/funds/frs)
      _getUpdatedFrsNumbers() {
        if (this.dataItems instanceof Array && this.dataItems.length > 0) {
          return this.dataItems.map((item) => {
            return item.fr_number;
          });
        }
        return [];
      }
    }

    window.customElements.define(UpdateFrNumbers.is, UpdateFrNumbers);

  </script>
</dom-module>
