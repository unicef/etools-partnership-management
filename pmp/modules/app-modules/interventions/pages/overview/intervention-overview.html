<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../styles/page-common-styles.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/app-mixins.html">

<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../shared/monitoring-visits-list.html">
<link rel="import" href="components/fund-reservations-display.html">

<dom-module id="intervention-overview">
  <template strip-whitespace>
    <style include="page-common-styles grid-layout-styles shared-styles paper-material-styles">
      :host {
        @apply --layout-vertical;
        width: 100%;
      }

      .block {
        display: block;
      }

      .content {
        margin-top: 8px;
      }

      iron-label {
        color: var(--dark-secondary-text-color);
      }

      .secondary {
        color: var(--dark-secondary-text-color);
      }

      .blue {
        color: var(--paper-blue-500);
      }

      .sector-label {
        display: inline-block;
        white-space: nowrap;
        height: 19px;
        text-align: center;
        padding: 7px 10px;
        background-color: var(--warning-color);
        text-transform: capitalize;
        font-weight: bold;
        color: var(--light-primary-text-color, #FFFFFF);
      }

      #top-container {
        margin-bottom: 24px;
      }
    </style>

    <div class="paper-material" elevation="1" id="top-container">
      <div class="row-h flex-c">
        <div class="col col-12 block">
          <iron-label for="cp_outputs_list">
            Cp Output(s)
          </iron-label>
          <br/>
          <div class="content" id="cp_outputs_list">
            <template is="dom-repeat" items="[[interventionCpOutputs]]" as="cpOut">
              <strong>[[ cpOut ]]</strong><br/>
            </template>
          </div>
        </div>
      </div>

      <div class="row-h flex-c">
        <div class="col col-12 block">
          <iron-label for="document_title">
            Document Title
          </iron-label>
          <br/>
          <div class="content" id="document_title">
            [[ intervention.title ]]
          </div>

          <div class="secondary">
            Under <strong class="blue">[[interventionAgreement.agreement_type]]</strong> with
            <a href$="/pmp/partners/[[intervention.partner_id]]/details">
              <strong class="blue">[[intervention.partner]]</strong>
            </a>
          </div>
        </div>
      </div>

      <div class="row-h flex-c">
        <div class="col col-6 block">
          <iron-label for="interventions_timeline">
            Timeline
          </iron-label>
          <br/>
          <div class="content" id="interventions_timeline">
            [[getDateDisplayValue(intervention.start)]] - [[getDateDisplayValue(intervention.end)]]
          </div>
        </div>
        <div class="col col-6 block">
          <iron-label for="intervention-sections">
            Sections
          </iron-label>
          <br/>
          <div class="content" id="intervention-sections">
            [[getDisplayValue(inteventionSections)]]
          </div>
        </div>
      </div>
    </div>

    <etools-content-panel id="fund-reservation-display" class="content-section" panel-title="Implementation Status">
      <fund-reservations-display intervention="[[intervention]]"
                                 frs-details="[[intervention.frs_details]]"></fund-reservations-display>
    </etools-content-panel>

    <etools-content-panel id="monitoring-visits-panel" class="content-section" panel-title="Monitoring Visits">
      <monitoring-visits-list intervention-or-partner-id="[[intervention.id]]"
                              endpoint-name="monitoringVisits">
      </monitoring-visits-list>
    </etools-content-panel>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     */
    const InterventionOverviewMixins = EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin InterventionOverviewMixins
     */
    class InterventionOverview extends InterventionOverviewMixins {

      static get is() {
        return 'intervention-overview';
      }

      static get properties() {
        return {
          intervention: {
            type: Object
          },
          interventionAgreement: {
            type: Object
          },
          monitoringVisit: {
            type: Array
          },
          cpOutputs: {
            type: Array,
            statePath: 'cpOutputs'
          },
          interventionCpOutputs: {
            type: Array,
            value: []
          },
          sections: {
            type: Array,
            statePath: 'sections'
          },
          inteventionSections: {
            type: Array,
            value: []
          }
        };
      }

      static get observers() {
        return [
          '_parseSections(sections.length, intervention.sections.length)',
          '_parseCpOutputs(cpOutputs.length, intervention.result_links.length)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for overview tab elements load,
         * triggered by parent element on stamp or by tap event on tabs
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'interv-page'});
        this.fireEvent('tab-content-attached');
      }


      _parseCpOutputs(cpOutputsLength, resultsLength) {
        if (!cpOutputsLength || !resultsLength) {
          this.set('interventionCpOutputs', []);
          return;
        }
        let resultLinks = this.intervention.result_links;
        let ids = {};
        let uniqueIds = [];
        let interventionCpOutputs = [];

        resultLinks.forEach(function(res) {
          ids[res.cp_output] = true;
        });

        let id;
        for (id in ids) {
          if (id) {
            uniqueIds.push(parseInt(id));
          }
        }
        if (Array.isArray(this.cpOutputs) && this.cpOutputs.length > 0) {
          this.cpOutputs.forEach(function(cpo) {
            if (uniqueIds.indexOf(cpo.id) > -1) {
              interventionCpOutputs.push(cpo.name);
            }
          });

          this.set('interventionCpOutputs', interventionCpOutputs);
        }
      }

      _parseSections(sectionsLength, intSectionsLength) {
        if (!sectionsLength || !intSectionsLength) {
          this.set('inteventionSections', []);
          return;
        }
        let sections = [];
        let interventionSections = _.map(this.intervention.sections, function(sectionId) {
          return parseInt(sectionId, 10);
        });
        this.sections.forEach(function(section) {
          if (interventionSections.indexOf(parseInt(section.id, 10)) > -1) {
            sections.push(section.name);
          }
        });
        this.set('inteventionSections', sections);
      }

    }

    window.customElements.define(InterventionOverview.is, InterventionOverview);
  </script>
</dom-module>
