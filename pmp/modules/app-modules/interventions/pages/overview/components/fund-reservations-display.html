<link rel="import" href="../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../../bower_components/iron-label/iron-label.html">
<link rel="import"
      href="../../../../../../../bower_components/etools-currency-amount-input/mixins/etools-currency-mixin.html">
<link rel="import" href="../../../../../../../bower_components/etools-info-tooltip/etools-info-tooltip.html">
<link rel="import" href="../../../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../../mixins/date-mixin.html">
<link rel="import" href="../../../../../scripts/lodash.html">
<link rel="import" href="../../../mixins/fr-numbers-consistency-mixin.html">

<link rel="import" href="../../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../styles/fr-warnings-styles.html">

<dom-module id="fund-reservations-display">
  <template strip-whitespace>
    <style include="data-table-styles grid-layout-styles fr-warnings-styles">
      :host {
        --list-column-label: {
          margin-right: 0;
        };
      }

      [hidden] {
        display: none !important;
      }

      #totalsRow {
        --list-row-no-collapse: {
          background-color: var(--light-theme-background-color);
        };
        --list-row-wrapper-padding: 0 24px 0 56px;
      }

      #plannedUnicefCash {
        --list-row-wrapper-padding: 0 24px 0 56px;
      }

      #plannedUnicefCash .unicef-cash-col {
        background-color: var(--light-info-color);
        margin-top: -12px;
        margin-bottom: -12px;
        padding-top: 12px;
        padding-bottom: 12px;
        line-height: 16px;
        @apply --layout-vertical;
        @apply --layout-end;
      }

      .unicef-cash-col iron-label {
        font-size: 12px;
        color: var(--secondary-text-color);
        font-weight: bold;
      }

      div[simple-header] > span,
      div[simple-row] > span {
        padding-right: 24px;
      }

      div[simple-header] {
        color: var(--list-secondary-text-color, #757575);
      }

    </style>

    <template is="dom-if" if="[[!frsDetails.frs.length]]">
      <div class="row-h">
        <p>There are no fund reservations added for this intervention.</p>
      </div>
    </template>

    <div class="list-container" hidden$="[[_noFrs(frsDetails)]]">
      <etools-data-table-header id="listHeader"
                                no-title
                                hidden$="[[!frsDetails.frs.length]]">
        <etools-data-table-column class="col-2">
          FR#
        </etools-data-table-column>
        <etools-data-table-column class="col-2 right-align">
          FR Posting Date
        </etools-data-table-column>
        <etools-data-table-column class="col-2 right-align">
          FR Currency
        </etools-data-table-column>
        <etools-data-table-column class="col-2 right-align">
          FR Amount
        </etools-data-table-column>
        <etools-data-table-column class="col-2 right-align">
          Actual Disburs.
        </etools-data-table-column>
        <etools-data-table-column class="col-2 right-align">
          Outstanding DCT
        </etools-data-table-column>
      </etools-data-table-header>

      <template is="dom-repeat" items="[[frsDetails.frs]]" as="fr">
        <etools-data-table-row>
          <div slot="row-data">
            <span class="col-data col-2">[[fr.fr_number]]</span>
            <span class="col-data col-2 right-align">[[prettyDate(fr.start_date)]]</span>
            <span class="col-data col-2 right-align">
              <etools-info-tooltip class="fr-nr-warn currency-mismatch"
                                   icon-first
                                   custom-icon
                                   hide-tooltip="[[hideFrCurrencyTooltip(frsDetails.currencies_match, fr.currency, intervention.planned_budget.currency)]]">
                <span slot="field">[[fr.currency]]</span>
                <iron-icon icon="pmp-custom-icons:not-equal" slot="custom-icon"></iron-icon>
                <span slot="message">
                  <span>[[getFrCurrencyTooltipMsg()]]</span>
                </span>
              </etools-info-tooltip>
            </span>
            <span class="col-data col-2 right-align">[[displayCurrencyAmount(fr.total_amt_local, '0.00')]] </span>
            <span class="col-data col-2 right-align">
                <etools-info-tooltip class="fr-nr-warn currency-mismatch"
                                     icon-first
                                     custom-icon
                                     hide-tooltip="[[!frsConsistencyWarningIsActive(fr.multi_curr_flag)]]">
                  <span slot="field" class$="[[getFrsValueNAClass(fr.multi_curr_flag, 'true')]]">
                    [[getFrsTotal(fr.multi_curr_flag, fr.actual_amt_local, 'true')]]
                  </span>
                  <iron-icon icon="pmp-custom-icons:not-equal"
                             slot="custom-icon"></iron-icon>
                  <span slot="message">
                    <span>[[getFrsMultiCurrFlagErrTooltipMsg()]]</span>
                  </span>
                </etools-info-tooltip>
            </span>
            <span class="col-data col-2 right-align">[[displayCurrencyAmount(fr.outstanding_amt_local, '0.00')]]</span>
          </div>
          <div slot="row-data-details">
            <div class="flex-c" hidden$="[[_isEmpty(fr.line_item_details)]]">
              <div simple-header class="layout-horizontal">
                <span class="col-2">FR Line Item</span>
                <span class="col-2">Donor</span>
                <span class="col-2">Grant</span>
              </div>
              <template is="dom-repeat" items="[[fr.line_item_details]]" as="frInfo">
                <div simple-row class="layout-horizontal">
                  <span class="col-2">
                    <span>[[fr.fr_number]]-[[frInfo.line_item]]</span>
                  </span>
                  <span class$="col-2 [[_getOtherStyleIfNA(frInfo.donor)]]">
                    <span>[[getValueOrNA(frInfo.donor)]]</span>
                  </span>
                  <span class$="col-2 [[_getOtherStyleIfNA(frInfo.grant_number)]]">
                    <span>[[getValueOrNA(frInfo.grant_number)]]</span>
                  </span>
                </div>
              </template>
            </div>
            <div class="flex-c" hidden$="[[!_isEmpty(fr.line_item_details)]]">
              There are no details to display.
            </div>
          </div>
        </etools-data-table-row>
      </template>

      <etools-data-table-row no-collapse id="totalsRow">
        <div slot="row-data">
          <span class="col-data col-2"></span>
          <span class="col-data col-2 right-align"><strong>TOTAL of FRs</strong></span>
          <span class="col-data col-2 right-align">
            <etools-info-tooltip class="fr-nr-warn currency-mismatch"
                                 icon-first
                                 custom-icon
                                 hide-tooltip="[[allCurrenciesMatch(frsDetails.currencies_match, frsDetails.frs, intervention.planned_budget.currency)]]">
              <span slot="field" class$="[[getFrsValueNAClass(frsDetails.currencies_match)]]">
                [[getFrsCurrency(frsDetails.currencies_match, frsDetails.frs)]]
              </span>
              <iron-icon icon="[[getFrsCurrencyTooltipIcon(frsDetails.currencies_match)]]"
                         slot="custom-icon"></iron-icon>
              <span slot="message">[[getFrsCurrencyTooltipMsg(frsDetails.currencies_match)]]</span>
            </etools-info-tooltip>
          </span>
          <span class="col-data col-2 right-align">
            <etools-info-tooltip class="fr-nr-warn"
                                 custom-icon
                                 icon-first
                                 hide-tooltip$="[[hideFrsAmountTooltip(frsDetails.currencies_match, frsDetails.frs, intervention.planned_budget.currency, _frsTotalAmountWarning)]]">
              <span slot="field" class$="[[getFrsValueNAClass(frsDetails.currencies_match)]]">
                [[getFrsTotal(frsDetails.currencies_match, frsDetails.total_frs_amt)]]
              </span>
              <iron-icon icon="pmp-custom-icons:not-equal" slot="custom-icon"></iron-icon>
              <span slot="message">[[_frsTotalAmountWarning]]</span>
            </etools-info-tooltip>
          </span>
          <span class="col-data col-2 right-align">
            <etools-info-tooltip class="fr-nr-warn currency-mismatch"
                                 icon-first
                                 custom-icon
                                 hide-tooltip="[[!frsConsistencyWarningIsActive(frsDetails.multi_curr_flag)]]">
              <span slot="field" class$="[[getFrsValueNAClass(frsDetails.multi_curr_flag, 'true')]]">
                [[getFrsTotal(frsDetails.multi_curr_flag, frsDetails.total_actual_amt, 'true')]]
              </span>
              <iron-icon
                  icon="pmp-custom-icons:not-equal"
                  slot="custom-icon"></iron-icon>
              <span slot="message">
                  <span>[[getFrsMultiCurrFlagErrTooltipMsg()]]</span>
              </span>
            </etools-info-tooltip>
          </span>
          <span class$="col-data col-2 right-align [[getFrsValueNAClass(frsDetails.currencies_match)]]">
            [[getFrsTotal(frsDetails.currencies_match, frsDetails.total_outstanding_amt)]]
          </span>
        </div>
      </etools-data-table-row>

      <etools-data-table-row no-collapse id="plannedUnicefCash">
        <div slot="row-data">
          <span class="col-data col-2"></span>
          <span class="col-data col-2 right-align unicef-cash-col">
            <strong>PLANNED</strong><strong>UNICEF CASH</strong>
          </span>
          <span class="col-data col-2 right-align unicef-cash-col">
            <iron-label for="pd-currency">PD Currency</iron-label>
            <span id="pd-currency">[[intervention.planned_budget.currency]]</span>
          </span>
          <span class="col-data col-2 right-align unicef-cash-col">
            <iron-label for="unicef-cash">UNICEF Cash</iron-label>
            <span id="unicef-cash">[[displayCurrencyAmount(intervention.planned_budget.unicef_cash_local, 0.00)]]</span>
          </span>
          <span class="col-data col-4"></span>
        </div>
      </etools-data-table-row>
    </div>

  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsMixins.EtoolsCurrency
     * @appliesMixin EtoolsPmpApp.Mixins.Date
     * @appliesMixin EtoolsPmpApp.Mixins.FrNumbersConsistency
     */
    const FundReservationsDisplayMixins = EtoolsMixinFactory.combineMixins([
      EtoolsMixins.EtoolsCurrency,
      EtoolsPmpApp.Mixins.Date,
      EtoolsPmpApp.Mixins.FrNumbersConsistency
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin FundReservationsDisplayMixins
     */
    class FundReservationsDisplay extends FundReservationsDisplayMixins {

      static get is() {
        return 'fund-reservations-display';
      }

      static get properties() {
        return {
          intervention: {
            type: Object,
            value: null
          },
          frsDetails: {
            type: Object,
            value: null
          },
          _frsTotalAmountWarning: String
        };
      }

      static get observers() {
        return [
          '_checkFrsAmountConsistency(intervention, frsDetails, intervention.status)'
        ];
      }

      _noFrs(frsDetails) {
        return (!frsDetails || !frsDetails.frs || !frsDetails.frs.length);
      }

      _checkFrsAmountConsistency(intervention, frsDetails) {
        if (this._noFrs(frsDetails) || !intervention || intervention.status === 'closed') {
          this.set('_frsTotalAmountWarning', '');
          return;
        }
        let warn = this.checkFrsAndUnicefCashAmountsConsistency(intervention.planned_budget.unicef_cash_local,
            frsDetails.total_frs_amt, intervention, 'interventionDetails', true);
        this.set('_frsTotalAmountWarning', warn);
      }

      getValueOrNA(value) {
        return value ? value : 'N/A';
      }

      _getOtherStyleIfNA(value) {
        return (value ? '' : 'fr-val-not-available') + ' fund-reservations-display';
      }

      _isEmpty(value) {
        return _.isEmpty(value);
      }
    }

    window.customElements.define(FundReservationsDisplay.is, FundReservationsDisplay);
  </script>
</dom-module>
