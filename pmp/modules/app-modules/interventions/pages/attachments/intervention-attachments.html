<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">

<link rel="import" href="../../../../styles/page-common-styles.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/file-styles.html">

<dom-module id="intervention-attachments">
  <template>
    <style include="page-common-styles grid-layout-styles shared-styles file-styles">
      :host {
        @apply --layout-vertical;
        width: 100%;

        --etools-file-label: {
          display: none;
        };

        --ecp-content: {
          padding: 0;
          overflow: hidden;
        };
      }

      #attachments {
        --etools-file-upload-button-paper-btn: {
          font-weight: bold;
          padding: 5px 10px;
          background-color: var(--primary-color);
        };

        --etools-file-upload-button: {
          color: var(--light-primary-text-color, #FFFFFF) !important;
          max-width: 150px;
          margin-left: 24px;
        };

        --etools-file-area-with-type: {
          padding: 16px 24px;
        };
      }

      #no-attach-warning {
        display: block;
        position: relative;
        top: -10px;
        padding-left: 24px;
        padding-bottom: 24px;
      }

      #no-attach-warning p {
        margin: 0;
      }

      etools-file[multiple] {
        --etools-file-filename-container: {
          width: calc(100% - 255px);
        };
        --etools-file-readonly-filename-container: {
          width: calc(100% - 255px);
        };
      }

    </style>

    <etools-content-panel class="content-section" panel-title="Attachments">
      <etools-file id="attachments"
                   files="{{attachments}}"
                   file-model="[[fileModel]]"
                   file-types=[[fileTypes]]
                   label="Attachments"
                   multiple use-delete-events activate-file-types
                   hide-delete-btn show-upload-btn-above show-upload-date
                   on-delete-file="_deleteAttachment"
                   readonly$=[[!editMode]]
                   no-file-attached-msg=""
                   toast-fit-into="[[toastFitInto]]"
                   target="_blank">
      </etools-file>
      <div id="no-attach-warning" hidden$=[[_hideNoAttachmentsWarning(attachments.length)]]>
        <p>There are no attachments added.</p>
      </div>
    </etools-content-panel>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const InterventionAttachmentsMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin InterventionAttachmentsMixins
     */
    class InterventionAttachments extends InterventionAttachmentsMixins {

      static get is() {
        return 'intervention-attachments';
      }

      static get properties() {
        return {
          active: {
            type: Boolean
          },
          editMode: {
            type: Boolean
          },
          intervention: {
            type: Object
          },
          attachments: {
            type: Array,
            value: [],
            notify: true,
            observer: '_attachmentsChanged'
          },
          fileTypes: {
            type: Array,
            statePath: 'fileTypes'
          },
          fileModel: {
            type: Object,
            value: null
          },
          toastFitInto: Object
        };
      }

      static get observers() {
        return [
          '_checkEmptyFileTypesData(fileTypes, active)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();

        this.toastFitInto = document.querySelector('app-shell')
            .shadowRoot.querySelector('app-header-layout');
        /**
         * Disable loading message for attachments tab elements load,
         * triggered by parent element on stamp or by tap event on tabs
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'interv-page'});
        this.fireEvent('tab-content-attached');
      }

      _attachmentsChanged(attachments) {
        if (Array.isArray(attachments) &&
            attachments.length > 0 && !this._hasPath(attachments[0])) {
          // this should run only one time when attachments(intervention.attachments) are provided
          this.set('attachments', attachments.map(function(attachment) {
            return {
              id: attachment.id,
              created: attachment.created,
              intervention: attachment.intervention,
              type: attachment.type,
              attachment_file: attachment.attachment_file ? attachment.attachment_file : null,
              attachment: null,
              file_name: this._getFileName(attachment),
              path: this._getPath(attachment)
            };
          }.bind(this)));
        }
      }

      _getPath(attachment) {
        if (typeof attachment.attachment_file === 'string' && attachment.attachment_file !== '') {
          return attachment.attachment_file;
        }
        if (typeof attachment.attachment === 'string' && attachment.attachment !== '') {
          return attachment.attachment;
        }
        return null;
      }

      _getFileName(attachment) {
        if (typeof attachment.attachment_file === 'string' && attachment.attachment_file !== '') {
          return this.getFileNameFromURL(attachment.attachment_file);
        }
        if (typeof attachment.attachment === 'string' && attachment.attachment !== '') {
          return this.getFileNameFromURL(attachment.attachment);
        }
        return null;
      }

      _hasPath(file) {
        return typeof file.path === 'string' && file.path !== '';
      }

      _hideNoAttachmentsWarning(length) {
        return length > 0;
      }

      _deleteAttachment(event) {
        try {
          let attachment = this.get('attachments.' + event.detail.index);
          if (attachment) {
            if (attachment.id) {
              // delete from serve using endpoint
              // TODO: use an endpoint(once is implemented on backend) to delete attachments
              this.fireEvent('toast', {
                text: 'Delete file not implemented yet for already saved attachments!',
                showCloseBtn: true
              });
            } else {
              // file not saved yet(only selected), delete from local data
              this.splice('attachments', event.detail.index, 1);
            }
          }
        } catch (err) {
          this.logError('An error occurred on deleting attachment no: #' + (event.detail.index + 1),
              'intervention-attachments', err);
        }
      }

      _checkEmptyFileTypesData(fileTypes, active) {
        if (typeof fileTypes === 'undefined') {
          return;
        }
        if (active && !fileTypes.length) {
          // there are no file types in the current workspace
          this.fireEvent('toast', {
            text: 'File Type data required to save attachments is missing from current workspace!',
            showCloseBtn: true
          });
        }
      }
    }

    window.customElements.define(InterventionAttachments.is, InterventionAttachments);
  </script>
</dom-module>
