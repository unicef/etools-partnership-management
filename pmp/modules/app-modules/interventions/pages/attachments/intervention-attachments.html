<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../layout/components/icons-actions.html">
<link rel="import" href="../../../../config/app-constants.html">

<link rel="import" href="../../../../styles/page-common-styles.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/etools-cp-header-actions-bar-styles.html">

<link rel="import" href="components/attachment-dialog.html">

<dom-module id="intervention-attachments">
  <template>
    <style include="page-common-styles grid-layout-styles shared-styles data-table-styles etools-cp-header-actions-bar-styles">
      :host {
        display: block;

        --ecp-content: {
          padding: 0;
          overflow: hidden;
        };
      }

      .attachment {
        margin-right: 8px;
      }

      iron-icon {
        color: var(--dark-icon-color);
      }

      icons-actions {
        visibility: hidden;
      }

      etools-data-table-row:hover icons-actions {
        visibility: visible;
      }
    </style>

    <etools-content-panel class="content-section" panel-title$="Attachments ([[attachments.length]])">
      <div slot="panel-btns" class="cp-header-actions-bar">
        <paper-toggle-button id="showInactive"
                             checked="{{showInactive}}">
          Show inactive
        </paper-toggle-button>
        <div class="separator" hidden$="[[!editMode]]">
        </div>
        <paper-icon-button icon="add-box"
                           disabled="[[!editMode]]"
                           hidden$="[[!editMode]]"
                           title="Add"
                           on-tap="_addAttachment">
        </paper-icon-button>
      </div>

      <template is="dom-if" if="[[_showAttachmentsList(attachments.length)]]">
        <etools-data-table-header no-collapse no-title>
          <etools-data-table-column class="col-2">
            Date Uploaded
          </etools-data-table-column>
          <etools-data-table-column class="col-3">
            Document Type
          </etools-data-table-column>
          <etools-data-table-column class="col-4">
            File Attachment
          </etools-data-table-column>
          <etools-data-table-column class="col-2">
            Archived
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            <!-- Actions -->
          </etools-data-table-column>
        </etools-data-table-header>

        <template is="dom-repeat" items="[[attachments]]">
          <etools-data-table-row secondary-bg-on-hover no-collapse hidden$="[[!_isVisible(item.active, showInactive)]]">
            <div slot="row-data">
              <span class="col-data col-2">
                [[prettyDate(item.created)]]
              </span>
              <span class="col-data col-3">
                [[_getAttachmentType(item.type)]]
              </span>
              <span class="col-data col-4">
                <iron-icon icon="attachment" class="attachment"></iron-icon>
                <span class="break-word file-label">
                  <!-- target="_blank" is there for IE -->
                  <a href$="[[item.attachment]]" target="_blank" download>
                    [[getFileNameFromURL(item.attachment)]]
                  </a>
                </span>
              </span>
              <span class="col-data col-2">
                <span hidden$="[[item.active]]" class="placeholder-style">&#8212;</span>
                <iron-icon icon="check" hidden$="[[!item.active]]"></iron-icon>
              </span>
              <span class="col-data flex-c p-relative">
                <icons-actions item-id$="[[item.id]]"
                               hidden$="[[!editMode]]"
                               show-delete="[[_canDeleteAttachments(interventionStatus)]]"
                               on-edit="_editAttachment"
                               on-delete="_deleteAttachment">
                              </icons-actions>
              </span>
            </div>
          </etools-data-table-row>
        </template>
      </template>

      <template is="dom-if" if="[[!_showAttachmentsList(attachments.length)]]">
        <div class="row-h">
          <p>There are no attachments added.</p>
        </div>
      </template>

    </etools-content-panel>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.Constants
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const InterventionAttachmentsMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.AjaxErrorsParser,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.Constants,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin InterventionAttachmentsMixins
     */
    class InterventionAttachments extends InterventionAttachmentsMixins {

      static get is() {
        return 'intervention-attachments';
      }

      static get properties() {
        return {
          active: {
            type: Boolean
          },
          editMode: {
            type: Boolean
          },
          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          },
          interventionStatus: {
            type: String
          },
          attachments: {
            type: Array,
            value: []
          },
          fileTypes: {
            type: Array,
            statePath: 'fileTypes'
          },
          showInactive: {
            type: Boolean,
            value: false
          },
          attachmentDialog: Object
        };
      }

      static get observers() {
        return [
          '_checkEmptyFileTypesData(fileTypes, active)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        this._createAttachmentDialog();
        /**
         * Disable loading message for attachments tab elements load,
         * triggered by parent element on stamp or by tap event on tabs
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'interv-page'});
        this.fireEvent('tab-content-attached');
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._removeAttachmentDialog();
      }

      _createAttachmentDialog() {
        this.attachmentDialog = document.createElement('attachment-dialog');
        this.attachmentDialog.setAttribute('id', 'addAmendmentDialog');
        this.attachmentDialog.toastEventSource = this;
        this.attachmentDialog.fileTypes = this.fileTypes;

        this.newAttachmentAdded = this.newAttachmentAdded.bind(this);
        this.newAttachmentUpdated = this.newAttachmentUpdated.bind(this);
        this.attachmentDialog.addEventListener('attachment-added', this.newAttachmentAdded);
        this.attachmentDialog.addEventListener('attachment-updated', this.newAttachmentUpdated);
        document.querySelector('body').appendChild(this.attachmentDialog);
      }

      _removeAttachmentDialog() {
        if (this.attachmentDialog) {
          this.attachmentDialog.removeEventListener('attachment-added', this.newAttachmentAdded);
          this.attachmentDialog.removeEventListener('attachment-updated', this.newAttachmentUpdated);
          document.querySelector('body').removeChild(this.attachmentDialog);
        }
      }

      newAttachmentAdded(e) {
        this.push('attachments', e.detail);
      }

      newAttachmentUpdated(e) {
        const attachments = JSON.parse(JSON.stringify(this.attachments));
        const editedAttachmentIdx = attachments.findIndex(a => a.id === e.detail.id);
        if (editedAttachmentIdx > -1) {
          attachments.splice(editedAttachmentIdx, 1, e.detail);
        }
        this.set('attachments', attachments);
      }

      _showAttachmentsList(length) {
        return length > 0;
      }

      _checkEmptyFileTypesData(fileTypes, active) {
        if (typeof fileTypes === 'undefined') {
          return;
        }
        if (active && !fileTypes.length) {
          // there are no file types in the current workspace
          this.fireEvent('toast', {
            text: 'File Type data required to save attachments is missing from current workspace!',
            showCloseBtn: true
          });
        }
      }

      _interventionIdChanged(id) {
        if (!id || isNaN(id)) {
          this.set('attachments', []);
          return;
        }
        // get attachments
        this.fireEvent('global-loading', {
          message: 'Loading...',
          active: true,
          loadingSource: 'pd-attachments'
        });
        this.sendRequest({
          endpoint: this.getEndpoint('pdAttachments', {pdId: id})
        }).then((response) => {
          this.set('attachments', response);
        }).catch((error) => {
          this.logError('Error during pd attachments fetch.', 'pd-attachments', error);
          this.parseRequestErrorsAndShowAsToastMsgs(error);
        }).then(() => {
          this.fireEvent('global-loading', {
            active: false,
            loadingSource: 'pd-attachments'
          });
        });
      }

      _addAttachment() {
        if (this.attachmentDialog) {
          this.attachmentDialog.interventionId = this.interventionId;
          this.attachmentDialog.initAttachment();
          this.attachmentDialog.opened = true;
        }
      }

      _editAttachment(e) {
        if (this.attachmentDialog) {
          this.attachmentDialog.interventionId = this.interventionId;
          const editedAttachment = this.attachments.find(a => a.id === Number(e.target.getAttribute('item-id')));
          this.attachmentDialog.initAttachment(editedAttachment);
          this.attachmentDialog.opened = true;
        }
      }

      _deleteAttachment(e) {
        // TODO
      }

      _getAttachmentType(type) {
        const fileTypes = this.fileTypes instanceof Array === false ? [] : this.fileTypes;
        const attachmentType = fileTypes.find(t => t.id === type);
        return attachmentType ? attachmentType.name : '—';
      }

      _isVisible(active, showInactive) {
        return active || showInactive;
      }

      _canDeleteAttachments(status) {
        return status === this.CONSTANTS.STATUSES.Draft.toLowerCase();
      }
    }

    window.customElements.define(InterventionAttachments.is, InterventionAttachments);
  </script>
</dom-module>
