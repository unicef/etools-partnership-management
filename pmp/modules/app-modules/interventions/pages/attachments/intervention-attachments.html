<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">

<link rel="import" href="../../../../styles/page-common-styles.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">

<dom-module id="intervention-attachments">
  <template>
    <style include="page-common-styles grid-layout-styles shared-styles">
      :host {
        display: block;

        --ecp-content: {
          padding: 0;
          overflow: hidden;
        };
      }
    </style>

    <!--<etools-content-panel class="content-section" panel-title="Attachments">-->
      <!--<etools-file id="attachments"-->
                   <!--files="{{attachments}}"-->
                   <!--file-model="[[fileModel]]"-->
                   <!--file-types=[[fileTypes]]-->
                   <!--label="Attachments"-->
                   <!--multiple use-delete-events activate-file-types-->
                   <!--hide-delete-btn show-upload-btn-above show-upload-date-->
                   <!--on-delete-file="_deleteAttachment"-->
                   <!--readonly$=[[!editMode]]-->
                   <!--no-file-attached-msg=""-->
                   <!--toast-fit-into="[[toastFitInto]]"-->
                   <!--target="_blank">-->
      <!--</etools-file>-->
      <!--<div id="no-attach-warning" hidden$=[[_hideNoAttachmentsWarning(attachments.length)]]>-->
        <!--<p>There are no attachments added.</p>-->
      <!--</div>-->
    <!--</etools-content-panel>-->

    <etools-content-panel class="content-section" panel-title="Attachments ([[attachments.length]])">
      <div slot="panel-btns">
        <paper-toggle-button id="showInactive"
                             checked="{{showArchived}}">
          Show archived
        </paper-toggle-button>
        <div class="separator" hidden$="[[!editMode]]">
        </div>
        <paper-icon-button icon="add-box"
                           disabled="[[!editMode]]"
                           hidden$="[[!editMode]]"
                           title="Add"
                           on-tap="_addAttachment">
        </paper-icon-button>
      </div>

      <template is="dom-if" if="[[_showAttachmentsList(attachments.length)]]">
        <etools-data-table-header no-collapse no-title>
          <etools-data-table-column class="col-2">
            Date Uploaded
          </etools-data-table-column>
          <etools-data-table-column class="col-3">
            Document Type
          </etools-data-table-column>
          <etools-data-table-column class="col-4">
            File Attachment
          </etools-data-table-column>
          <etools-data-table-column class="col-2">
            Archived
          </etools-data-table-column>
          <etools-data-table-column class="flex-c">
            <!-- Actions -->
          </etools-data-table-column>
        </etools-data-table-header>

        <template is="dom-repeat" items="{{attachments}}">
          <etools-data-table-row secondary-bg-on-hover no-collapse hidden$="[[!_isVisible(item.active, showArchived)]]">
            <div slot="row-data" class$="p-relative">
              <span class="col-data col-2">
                [[prettyDate(item.created)]]
              </span>
              <span class="col-data col-3">
                [[_getAttachmentType(item.type)]]
              </span>
              <span class="col-data col-4">
                <iron-icon icon="attachment" class="attachment"></iron-icon>
                <span class="break-word file-label">
                  <!-- target="_blank" is there for IE -->
                  <a href$="[[item.attachment]]" target="_blank" download>
                    [[getFileNameFromURL(item.attachment)]]
                  </a>
                </span>
              </span>
              <span class="col-data col-2 center-align">
                <iron-icon icon="check" hidden$="[[!item.active]]"></iron-icon>
              </span>
              <span class="col-data flex-c">
                <icons-actions hidden$="[[!editMode]]"
                               on-edit="_editAttachment">
                              </icons-actions>
              </span>
            </div>
          </etools-data-table-row>
        </template>
      </template>

      <template is="dom-if" if="[[!_showAttachmentsList(attachments.length)]]">
        <div class="row-h">
          <p>There are no attachments added.</p>
        </div>
      </template>

    </etools-content-panel>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const InterventionAttachmentsMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin InterventionAttachmentsMixins
     */
    class InterventionAttachments extends InterventionAttachmentsMixins {

      static get is() {
        return 'intervention-attachments';
      }

      static get properties() {
        return {
          active: {
            type: Boolean
          },
          editMode: {
            type: Boolean
          },
          interventionId: {
            type: Number,
            observer: '_interventionIdChanged'
          },
          attachments: {
            type: Array,
            value: []
          },
          fileTypes: {
            type: Array,
            statePath: 'fileTypes'
          },
          showArchived: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_checkEmptyFileTypesData(fileTypes, active)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for attachments tab elements load,
         * triggered by parent element on stamp or by tap event on tabs
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'interv-page'});
        this.fireEvent('tab-content-attached');
      }

      _showAttachmentsList(length) {
        return length > 0;
      }

      _checkEmptyFileTypesData(fileTypes, active) {
        if (typeof fileTypes === 'undefined') {
          return;
        }
        if (active && !fileTypes.length) {
          // there are no file types in the current workspace
          this.fireEvent('toast', {
            text: 'File Type data required to save attachments is missing from current workspace!',
            showCloseBtn: true
          });
        }
      }

      _interventionIdChanged(id) {
        if (!id || isNaN(id)) {
          this.set('attachments', []);
          return;
        }
        // get attachments
        // TODO
      }

      _addAttachment() {
        // TODO
      }

      _editAttachment() {
        // TODO
      }

      _getAttachmentType(type) {
        // TODO
      }

      _isVisible(active, showArchived) {
        // TODO
      }
    }

    window.customElements.define(InterventionAttachments.is, InterventionAttachments);
  </script>
</dom-module>
