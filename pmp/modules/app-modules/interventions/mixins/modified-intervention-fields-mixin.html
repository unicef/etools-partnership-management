<link rel="import" href="../../../scripts/lodash.html">
<script>
  'use strict';

  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};

  /* eslint-disable arrow-parens */

  /**
   * PD/SSFA fields prepare for save functionality
   * @polymer
   * @mixinFunction
   */
  EtoolsPmpApp.Mixins.ModifiedInterventionFields = Polymer.dedupingMixin(superClass => class extends superClass {
    /* eslint-enable arrow-parens */
    _objectFieldIsModified(fieldName) {
      let isModified = JSON.stringify(this.originalIntervention[fieldName], this.numbersToString) !==
          JSON.stringify(this.intervention[fieldName], this.numbersToString);

      let dropdownArrayFields = ['partner_focal_points', 'unicef_focal_points', 'offices'];
      if (isModified && dropdownArrayFields.indexOf(fieldName) > -1) {
        // Covers dropdown arrays which can have same content but with changed order
        if (this._arraysAreEqual(this.originalIntervention[fieldName], this.intervention[fieldName])) {
          isModified = false;
        }
      }
      return isModified;
    }
    /**
     * Covers the case when the object from bk (this.originalIntervention)
     * has numbers but this.interventions has strings,
     * so we convert numbers to string before comparing
     */
    numbersToString(key, value) {
      if (value === '0.00') {
        // cover the case where API received values (ex: planned budget) can be strings like this `0.00`
        return '0';
      }
      if (typeof value === 'number') {
        return value.toString();
      }
      return value;
    }
    _arraysAreEqual(array1, array2) {
      let differencesArray = [];
      if ((!array1 && (array2 && array2.length)) || (!array2 && (array1 && array1.length))) {
        return false;
      }
      if (array1.length > array2.length) {
        differencesArray = _.difference(array1, array2);
      } else {
        differencesArray = _.difference(array2, array1);
      }
      return _.isEmpty(differencesArray);
    }

    _primitiveFieldIsModified(fieldName) {
      return this.originalIntervention[fieldName] !== this.intervention[fieldName];
    }

    _getModifiedReviewAndSign() {
      let updatableFields = ['submission_date', 'submission_date_prc', 'review_date_prc',
        'prc_review_attachment', 'partner_authorized_officer_signatory',
        'signed_by_partner_date', 'unicef_signatory', 'signed_by_unicef_date', 'signed_pd_attachment',
        'in_amendment'];

      return this._buildModifiedInterventionObject(updatableFields, []);
    }

    _getModifiedInterventionDetails(docType) {
      let updatableFields = ['agreement', 'document_type', 'title', 'country_programme',
        'start', 'end', 'activation_letter_attachment'];
      if (docType !== 'SSFA') {
        updatableFields.push('reference_number_year');
        updatableFields.push('contingency_pd');
      }
      let updatableObjectFields = ['offices', 'unicef_focal_points', 'partner_focal_points',
        'sections', 'flat_locations', 'planned_budget', 'planned_visits'];
      let modifiedDetails = this._buildModifiedInterventionObject(updatableFields, updatableObjectFields);

      return Object.assign({}, modifiedDetails);
    }

    _buildModifiedInterventionObject(updatableFields, updatableObjectFields) {
      let modifiedObject = {};

      updatableFields.forEach((fieldName) => {
        if (this._primitiveFieldIsModified(fieldName)) {
          modifiedObject[fieldName] = this.intervention[fieldName];
        }
      });

      updatableObjectFields.forEach((fieldName) => {
        if (this._objectFieldIsModified(fieldName)) {
          modifiedObject[fieldName] = this.intervention[fieldName];
        }
      });

      return modifiedObject;
    }

    _prepareAttachments() {
      if (_.isEmpty(this.intervention.attachments)) {
        return [];
      }
      let modifAttachments = this.intervention.attachments
          .filter(this._attachmentIsNewOrModified.bind(this))
          .map((attachment) => {
            let _sendAttachmentFile = (attachment.raw instanceof File) ? true : false;
            if (!_sendAttachmentFile && attachment.id) {
              return {
                id: attachment.id,
                type: attachment.type
              };
            } else {
              return {
                id: attachment.id,
                intervention: attachment.intervention,
                type: attachment.type,
                attachment: attachment.raw
              };
            }
          });
      return modifAttachments;
    }

    _attachmentIsNewOrModified(attachment) {
      if (_.isEmpty(this.originalIntervention.attachments)) {
        return true;
      }
      if (!attachment.id) {
        return true;
      }
      let originalAttachment = this.originalIntervention.attachments.find((att) => {
        return att.id === attachment.id;
      });
      if (!originalAttachment) {
        return true;
      }
      return (JSON.stringify(originalAttachment) !== JSON.stringify(attachment));
    }
  });

</script>
