<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="modified-intervention-fields-mixin.html">
<link rel="import" href="../../../mixins/array-helper-mixin.html">
<link rel="import" href="../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../mixins/ajax-errors-parser-mixin.html">

<link rel="import" href="../../../scripts/lodash.html">
<link rel="import" href="../../../config/app-constants.html">

<script>
  'use strict';

  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};

  /**
   * PD/SSFA save functionality
   * @polymer
   * @mixinFunction
   * @mixinFunction
   * @appliesMixin EtoolsPmpApp.Mixins.ArrayHelper
   * @appliesMixin EtoolsPmpApp.Mixins.ModifiedInterventionFields
   * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
   * @appliesMixin EtoolsPmpApp.Mixins.Constants
   * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
   */
  EtoolsPmpApp.Mixins.SaveIntervention = Polymer.dedupingMixin(
      superClass => class extends EtoolsMixinFactory.combineMixins([
        EtoolsPmpApp.Mixins.EventHelper,
        EtoolsPmpApp.Mixins.ArrayHelper,
        EtoolsPmpApp.Mixins.ModifiedInterventionFields,
        EtoolsPmpApp.Mixins.Constants,
        EtoolsPmpApp.Mixins.AjaxErrorsParser
      ], superClass) {

        _validateAndSaveIntervention(event) {
          if (event) {
            event.stopImmediatePropagation();
          }
          this.saved.justSaved = true;
          this.fireEvent('clear-server-errors');
          this.set('errorMsgBox_Title', 'Errors Saving PD/SSFA');
          if (!this._hasEditPermissions(this.permissions, this.intervention)) {
            return false;
          }

          let interventionDetailsAreValid = this._validateInterventionDetails();

          let reviewAndSignIsValid = this._validateReviewAndSign();

          if (!interventionDetailsAreValid || !reviewAndSignIsValid) {
            this._showErrorsWarning(interventionDetailsAreValid, reviewAndSignIsValid);
            return false;
          }

          let interventionData = this._getModifiedFields();
          interventionData = this._prepareDataForSave(interventionData);

          if (this.intervention.activation_letter_file_temp instanceof File) {
            this._uploadActivationLetter(this.intervention.activation_letter_file_temp)
              .then((response) => {
                delete interventionData.activation_letter_file_temp;

                interventionData.activation_letter_attachment = response.id;
                this.$.interventionData.saveIntervention(interventionData, this._newInterventionSaved);
              })
              .catch((err) => {
                this.parseRequestErrorsAndShowAsToastMsgs(err);
                return false;
              });
          } else {
            this.$.interventionData.saveIntervention(interventionData, this._newInterventionSaved);
          }

          return true;
        }

        _uploadActivationLetter(file) {
          let options = {
            method: 'POST',
            endpoint: this.getEndpoint('attachmentsUpload'),
            body: {file: file},
            multiPart: true,
            prepareMultipartData: true
          };
          return this.sendRequest(options)
              .then((resp) => {
                return resp;
              }).catch((error) => {
                throw error;
          });
        }

        _getModifiedFields() {
          let interventionData;
          if (this._isNewIntervention()) {
            interventionData = Object.assign({}, this.intervention);
            interventionData.status = this.CONSTANTS.STATUSES.Draft.toLowerCase();
          } else {
            let modifiedDetails = this._getModifiedInterventionDetails();
            let modifiedReviewAndSign = this._getModifiedReviewAndSign();
            interventionData = Object.assign({id: this.intervention.id}, modifiedDetails, modifiedReviewAndSign);
          }
          return interventionData;
        }

        _validateInterventionDetails() {
          let valid = false;
          let intervDetailsEl = this.shadowRoot.querySelector('#interventionDetails');

          if (intervDetailsEl && typeof intervDetailsEl.validate === 'function') {
            valid = intervDetailsEl.validate();
          } else {
            // details element not stamped...
            // validate current data that belongs to details tab against permissions
            let detailsPrimitiveFields = ['agreement', 'document_type', 'title', 'country_programme'];
            let detailsObjFields = ['unicef_focal_points', 'partner_focal_points',
              'sections', 'flat_locations', 'offices'];
            if (!this.intervention.contingency_pd || this.intervention.status === 'active') {
              detailsPrimitiveFields.push('start', 'end');
            }
            if (this.intervention.document_type !== 'SSFA' && ['', 'draft'].indexOf(this.intervention.status) > -1) {
              detailsPrimitiveFields.push('reference_number_year');
            }
            valid = this._validateInterventionPrimitiveFields(detailsPrimitiveFields) &&
                this._validateInterventionObjectFields(detailsObjFields);

            this.set('_forceDetUiValidationOnAttach', true);
          }

          return valid;
        }

        _validateReviewAndSign() {
          let valid = false;
          let reviewAndSignEl = this.shadowRoot.querySelector('#interventionReviewAndSign');

          if (reviewAndSignEl && typeof reviewAndSignEl.validate === 'function') {
            valid = reviewAndSignEl.validate();
          } else {
            // review and signed element not stamped...
            // validate current data that belongs to this tab against permissions
            let reviewAndSignPrimitiveFields = ['partner_authorized_officer_signatory', 'signed_by_partner_date',
              'unicef_signatory', 'signed_by_unicef_date'];
            let reviewAndSignObjFields = ['signed_pd_document'];
            valid = this._validateInterventionPrimitiveFields(reviewAndSignPrimitiveFields) &&
                this._validateInterventionObjectFields(reviewAndSignObjFields);
            this.set('_forceReviewUiValidationOnAttach', true);
          }
          return valid;
        }

        _validateInterventionObjectFields(interventionFields) {
          return this._validateInterventionFields(interventionFields, _.isEmpty);
        }

        _validateInterventionPrimitiveFields(interventionFields) {
          return this._validateInterventionFields(interventionFields, this._primitiveFieldIsEmpty);
        }

        _validateInterventionFields(interventionFields, isEmptyPredicate) {
          let valid = true;
          let i;
          let fieldRequired;
          let fieldVal;
          for (i = 0; i < interventionFields.length; i++) {
            fieldRequired = this.intervention.permissions.required[interventionFields[i]];
            fieldVal = this.intervention[interventionFields[i]];
            if (fieldRequired && isEmptyPredicate(fieldVal)) {
              valid = false;
              break;
            }
          }
          return valid;
        }

        _primitiveFieldIsEmpty(fieldVal) {
          return fieldVal === null || fieldVal === undefined || fieldVal === '';
        }

        _prepareDataForSave(interventionData) {
          // prepare fr numbers
          if (Array.isArray(this.intervention.frs) && this._needFrsUpdate(this.intervention.frs)) {
            interventionData.frs = this.intervention.frs;
          }
          // frs_details are readonly, we do not have to send them to backend
          delete interventionData.frs_details;

          // no need to send planned_budget.total to backend
          if (interventionData.planned_budget) {
            delete interventionData.planned_budget.total;
          }

          // prepare attachments
          interventionData.attachments = this._prepareAttachments();
          if (_.isEmpty(interventionData.attachments)) {
            delete interventionData.attachments;
          }

          // if prc_review_document is null we need to delete the property otherwise the
          // file gets deleted from the backend
          if (this.intervention.hasOwnProperty('prc_review_document') &&
              !(this.intervention.prc_review_document instanceof File)) {
            delete interventionData.prc_review_document;
            delete interventionData.prc_review_document_file;
          }

          return interventionData;
        }

        _showErrorsWarning(validDetails, validReviewAndSign) {
          let msg = '';
          if (this.intervention.status === this.CONSTANTS.STATUSES.Draft.toLowerCase() &&
              this.intervention.signed_pd_document instanceof File) {
            msg = 'Status of the PD/SSFA will change to signed once all required fields are completed ' +
                '(check DETAILS and REVIEW & SIGN tabs).';
          } else {
            msg = 'Document can not be saved because of missing data';
            let tabs = [];
            if (validDetails === false) {
              tabs.push('DETAILS');
            }
            if (validReviewAndSign === false) {
              tabs.push('REVIEW & SIGN');
            }
            msg += ' from ' + ((tabs.length > 1) ? (tabs.join(', ') + ' tabs') : (tabs[0] + ' tab')) + '.';
          }

          this.fireEvent('toast', {text: msg, showCloseBtn: true});
        }

        _needFrsUpdate(frs) {
          let diff = this.getArraysDiff(this.originalIntervention.frs, frs);
          return diff.length > 0;
        }

        _terminatePd(e) {
          let terminationData = {
            id: e.detail.interventionId,
            status: this.CONSTANTS.STATUSES.Terminated.toLowerCase(),
            end: e.detail.terminationData.date,
            termination_doc_attachment: e.detail.terminationData.fileId
          };
          this.$.interventionData.saveIntervention(terminationData);
        }
      });

</script>
