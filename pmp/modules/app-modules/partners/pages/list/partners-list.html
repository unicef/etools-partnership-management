<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../../../../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../../../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">
<link rel="import"
      href="../../../../../../bower_components/etools-currency-amount-input/mixins/etools-currency-mixin.html">

<link rel="import" href="../../../../scripts/lodash.html">

<link rel="import" href="../../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../mixins/lists-common-mixin.html">
<link rel="import" href="../../../../mixins/pagination-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../mixins/list-filters-mixin.html">

<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/list-filter-styles.html">
<link rel="import" href="../../../../styles/partner-status-styles.html">
<link rel="import" href="../../../../styles/app-mixins.html">

<link rel="import" href="../../data/partners-list-data.html">

<dom-module id="partners-list">
  <template strip-whitespace>
    <style
        include="shared-styles data-table-styles iron-flex iron-flex-factors partner-status-styles list-filter-styles paper-material-styles">

      .sm-status-wrapper {
        padding-left: 10px;
      }

      .vendor-nr {
        @apply --text-btn-style;
        text-transform: none;
      }
    </style>

    <template is="dom-if" if="[[stampListData]]">
      <partners-list-data id="partners"
                          filtered-partners="{{filteredPartners}}"
                          total-results="{{paginator.count}}"
                          on-partners-loaded="_requiredDataHasBeenLoaded"
                          list-data-path="filteredPartners"
                          fire-data-loaded>
      </partners-list-data>
    </template>

    <div id="filters" class="paper-material" elevation="1">
      <div id="filters-fields">

        <paper-input id="query"
                     class="filter"
                     type="search"
                     autocomplete="off"
                     value="{{q}}"
                     placeholder="Search">
          <iron-icon icon="search" slot="prefix"></iron-icon>
        </paper-input>

        <template is="dom-repeat" items="[[selectedFilters]]" as="filter">
          <template is="dom-if" if="[[filterTypeIs('esmm', filter.type)]]">
            <!-- esmm multi -->
            <etools-dropdown-multi
                class="filter"
                label="[[filter.filterName]]"
                placeholder="Select"
                disabled$="[[filter.disabled]]"
                options="[[filter.selectionOptions]]"
                selected-values="[[filter.alreadySelected]]"
                data-filter-path$="[[filter.path]]"
                on-etools-selected-items-changed="esmmValueChanged"
                trigger-value-change-event
                hide-search="[[filter.hideSearch]]"
                min-width="[[filter.minWidth]]"
                horizontal-align="left"
                no-dynamic-align>
            </etools-dropdown-multi>
          </template>

          <template is="dom-if" if="[[filterTypeIs('paper-toggle', filter.type)]]">
            <div id="hiddenToggle" class="filter">
              [[filter.filterName]]
              <paper-toggle-button checked="[[filter.value]]"
                                   data-filter-path$="[[filter.path]]"
                                   on-checked-changed="toggleValueChanged"></paper-toggle-button>
            </div>
          </template>

        </template>
      </div>

      <div class="fixed-controls">
        <paper-menu-button id="filterMenu" ignore-select horizontal-align="right">
          <paper-button class="button" slot="dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>
            Filters
          </paper-button>
          <paper-listbox slot="dropdown-content" multi>
            <template is="dom-repeat" items="[[listFilterOptions]]">
              <paper-icon-item on-tap="selectFilter" disabled$="[[item.disabled]]"  selected$="[[item.selected]]">
                <iron-icon icon="check" slot="item-icon" hidden$="[[!item.selected]]"></iron-icon>
                <paper-item-body>[[item.filterName]]</paper-item-body>
              </paper-icon-item>
            </template>
          </paper-listbox>
        </paper-menu-button>
      </div>

    </div>

    <div id="list" elevation="1" class="paper-material hidden">

      <etools-data-table-header
          id="listHeader"
          label="[[paginator.visible_range.0]]-[[paginator.visible_range.1]] of [[paginator.count]] results to show">
        <etools-data-table-column class="flex" field="vendor_number" sortable>
          Vendor No.
        </etools-data-table-column>
        <etools-data-table-column class="flex-3" field="name" sortable>
          Name (Short/Full)
        </etools-data-table-column>
        <etools-data-table-column class="flex-2" field="partner_type">
          Partner Type
        </etools-data-table-column>
        <etools-data-table-column class="flex" field="rating">
          Risk Rating
        </etools-data-table-column>
      </etools-data-table-header>

      <template id="rows" is="dom-repeat"
                items="[[filteredPartners]]" as="partner"
                initial-count="10" on-dom-change="_listDataChanged">
        <etools-data-table-row details-opened="[[detailsOpened]]">
          <div slot="row-data">
              <span class="col-data flex">
                <a class="vendor-nr truncate"
                   href$="[[currentModule]]/[[partner.id]]/details"
                   title$="[[getDisplayValue(partner.vendor_number)]]"
                   on-tap="_triggerPartnerLoadingMsg">
                  [[getDisplayValue(partner.vendor_number)]]
                </a>
              </span>
            <span class="col-data flex-3">
                <span>[[_computeName(partner.name, partner.short_name)]]</span>

                <span class="sm-status-wrapper" hidden$="[[!partner.deleted_flag]]">
                  <span class="marked-for-deletion">
                    <iron-icon icon="delete"></iron-icon>
                  </span>
                </span>

                <span class="sm-status-wrapper" hidden$="[[!partner.blocked]]">
                  <span class="blocked">
                    <iron-icon icon="block"></iron-icon>
                  </span>
                </span>

              </span>
            <span class="col-data flex-2">
                [[_computeType(partner.cso_type, partner.partner_type)]]
              </span>
            <span class="col-data flex" style="text-transform: capitalize">
                [[getDisplayValue(partner.rating)]]
              </span>
          </div>
          <div slot="row-data-details">
            <div class="row-details-content flex">
              <span class="rdc-title">Shared Partner</span>
              <span>[[getDisplayValue(partner.shared_with)]]</span>
            </div>
            <div class="row-details-content flex">
              <span class="rdc-title">Email</span>
              <span>[[getDisplayValue(partner.email)]]</span>
            </div>
            <div class="row-details-content flex">
              <span class="rdc-title">Phone Number</span>
              <span>[[getDisplayValue(partner.phone_number)]]</span>
            </div>
            <div class="row-details-content flex">
              <span class="rdc-title">Actual Cash Transfer for CP</span>
              <span>$ [[displayCurrencyAmount(partner.total_ct_cp, '0')]]</span>
            </div>
            <div class="row-details-content flex">
              <span class="rdc-title">Actual Cash Transfer for Current Year</span>
              <span>$ [[displayCurrencyAmount(partner.total_ct_ytd, '0')]]</span>
            </div>
          </div>
        </etools-data-table-row>
      </template>

      <etools-data-table-footer
          page-size="{{paginator.page_size}}"
          page-number="{{paginator.page}}"
          total-results="[[paginator.count]]"
          visible-range="{{paginator.visible_range}}">
      </etools-data-table-footer>

    </div>

  </template>
  <script>
    'use strict';
    // eslint-disable-next-line
    var _partnersLastNavigated = null;
    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsMixins.EtoolsCurrency
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.ListFilters
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.ListsCommon
     * @appliesMixin EtoolsPmpApp.Mixins.Pagination
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const PartnersListRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsMixins.EtoolsCurrency,
      EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.ListFilters,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.ListsCommon,
      EtoolsPmpApp.Mixins.Pagination,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);


    /**
     * @polymer
     * @customElement
     * @appliesMixin PartnersListRequiredMixins
     */
    class PartnersList extends PartnersListRequiredMixins {
      static get is() {
        return 'partners-list';
      }

      static get properties() {
        return {
          filteredPartners: {
            type: Array,
            notify: true,
            observer: '_listChanged'
          },
          csoTypes: {
            type: Array,
            statePath: 'csoTypes'
          },
          partnerTypes: {
            type: Array,
            statePath: 'partnerTypes'
          },
          riskRatings: {
            type: Array,
            statePath: 'partnerRiskRatings'
          },
          selectedPartnerTypes: {
            type: Array,
            value: []
          },
          selectedCsoTypes: {
            type: Array,
            value: []
          },
          selectedRiskRatings: {
            type: Array,
            value: []
          },
          showHidden: {
            type: Boolean
          },
          showOnlyGovernmentType: {
            type: Boolean,
            value: false,
            observer: '_showOnlyGovernmentTypeFlagChanged'
          },
          currentModule: String,
          _sortableFieldNames: {
            type: Array,
            value: ['vendor_number', 'name']
          },
          _governmentLockedPartnerTypes: {
            type: Array,
            value: ['Government']
          }
        };
      }

      static get observers() {
        return [
          '_initFiltersMenuList(partnerTypes, csoTypes, riskRatings)',
          'resetPageNumber(q, selectedPartnerTypes.length, selectedCsoTypes.length, ' +
          'selectedRiskRatings.length, showHidden)',
          '_updateUrlAndData(q, selectedPartnerTypes.length, selectedCsoTypes.length, selectedRiskRatings.length, ' +
          'paginator.page, paginator.page_size, sortOrder, showHidden, requiredDataLoaded, initComplete)',
          '_init(active)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for main list elements load,
         * triggered by parent element on stamp
         */
        this.fireEvent('global-loading', {
          active: false,
          loadingSource: 'partners-page'
        });
        this.listAttachedCallback(this.active, 'Loading...', 'partners-list');
      }

      _initFiltersMenuList(partnerTypes, csoTypes, riskRatings) {
        if (!partnerTypes || !csoTypes || !riskRatings) {
          // this is just to be safe, the method should only get triggered once when redux data is loaded
          return;
        }
        // init list filter options
        this.initListFiltersData([
          {
            filterName: 'Partner Type',
            type: 'esmm', // etools-dropdown-multi
            selectionOptions: partnerTypes,
            alreadySelected: [],
            path: 'selectedPartnerTypes',
            selected: true,
            minWidth: '350px',
            hideSearch: true,
            disabled: this.showOnlyGovernmentType || partnerTypes.length === 0
          },
          {
            filterName: 'CSO Type',
            type: 'esmm', // etools-dropdown-multi
            selectionOptions: csoTypes,
            alreadySelected: [],
            path: 'selectedCsoTypes',
            selected: true,
            minWidth: '350px',
            hideSearch: false,
            disabled: csoTypes.length === 0
          },
          {
            filterName: 'Risk Rating',
            type: 'esmm', // etools-dropdown-multi
            selectionOptions: riskRatings,
            alreadySelected: [],
            path: 'selectedRiskRatings',
            selected: true,
            minWidth: '160px',
            hideSearch: false,
            disabled: riskRatings.length === 0
          },
          {
            filterName: 'Show hidden',
            type: 'paper-toggle',
            value: this.showHidden,
            path: 'showHidden',
            selected: true
          }
        ]);
        this._updateSelectedFiltersValues();
      }

      _updateSelectedFiltersValues() {
        this.updateShownFilterDebouncer = Polymer.Debouncer.debounce(this.updateShownFilterDebouncer,
            Polymer.Async.timeOut.after(20),
            () => {
              let filtersValues = [
                {
                  filterName: 'Partner Type',
                  selectedValue: this.selectedPartnerTypes,
                  disabled: this.showOnlyGovernmentType,
                  allowEmpty: true,
                  disableMenuOption: this.showOnlyGovernmentType
                },
                {
                  filterName: 'CSO Type',
                  selectedValue: this.selectedCsoTypes,
                  allowEmpty: true
                },
                {
                  filterName: 'Risk Rating',
                  selectedValue: this.selectedRiskRatings,
                  allowEmpty: true
                },
                {
                  filterName: 'Show hidden',
                  selectedValue: this.showHidden,
                  allowEmpty: true
                }
              ];
              this.updateShownFilters(filtersValues);
            });
      }

      _getSelectedPartnerTypes(selectedPartnerTypes) {
        return this.showOnlyGovernmentType
            ? this._governmentLockedPartnerTypes
            : this._getFilterUrlValuesAsArray(selectedPartnerTypes);
      }

      // Input: URL query params
      // Initializes the properties of the list at page load
      // to the params interpretted from the URL string.
      _init(active) {
        let urlQueryParams = this.urlParams;
        if (!active || !urlQueryParams) {
          return;
        }
        this.set('initComplete', false);
        this.set('q', urlQueryParams.q ? urlQueryParams.q : '');
        this.set('selectedPartnerTypes', this._getSelectedPartnerTypes(urlQueryParams.partner_types));
        this.set('selectedCsoTypes', this._getFilterUrlValuesAsArray(urlQueryParams.cso_types));
        this.set('selectedRiskRatings', this._getFilterUrlValuesAsArray(urlQueryParams.risk_ratings));
        this.set('showHidden', urlQueryParams.hidden ? true : false);

        this.setPaginationDataFromUrlParams(urlQueryParams);

        // format of sort param is sort=field.order ex: sort=name.asc
        let result = this.initSortFieldsValues({field: 'name', direction: 'asc'}, urlQueryParams.sort);
        this.set('sortOrder', result);
        this.set('initComplete', true);
        this._updateSelectedFiltersValues();
      }

      // Updates URL state with new query string, and launches query
      _updateUrlAndData() {
        if (this._canFilterData()) {
          this.set('csvDownloadUrl', this._buildCsvDownloadUrl());
          let qs = this._buildQueryString();

          this._updateUrlAndDislayedData(this.currentModule + '/list',
              _partnersLastNavigated,
              qs,
              this._filterListData.bind(this));

          _partnersLastNavigated = qs || _partnersLastNavigated;
        }
      }

      _filterListData(forceNoLoading) {
        // Query is debounced with a debounce time
        // set depending on what action the user takes
        this._actionsChangedDebouncer = Polymer.Debouncer.debounce(this._actionsChangedDebouncer,
            Polymer.Async.timeOut.after(this.debounceTime),
            () => {
              this._handleFilterPartnersData(forceNoLoading);
            });
      }

      _handleFilterPartnersData(forceNoLoading) {
        let partners = this.shadowRoot.querySelector('#partners');
        if (!partners) {
          return;
        }
        partners.query(
            this.sortOrder.field,
            this.sortOrder.direction,
            this.q.toLowerCase(),
            this.selectedPartnerTypes,
            this.selectedCsoTypes,
            this.selectedRiskRatings,
            this.paginator.page,
            this.paginator.page_size,
            this.showHidden,
            forceNoLoading ? false : this.showQueryLoading
        );
      }

      // Outputs the query string for the list
      _buildQueryString() {
        return this._buildUrlQueryString({
          page: this.paginator.page,
          size: this.paginator.page_size,
          q: this.q,
          partner_types: this.selectedPartnerTypes,
          cso_types: this.selectedCsoTypes,
          risk_ratings: this.selectedRiskRatings,
          hidden: this.showHidden ? 'true' : '',
          sort: this.sortOrder
        });
      }

      _buildCsvDownloadUrl() {
        let endpointUrl = this.getEndpoint('partners').url;
        let params = {
          search: this.q,
          partner_type: this.selectedPartnerTypes,
          cso_type: this.selectedCsoTypes,
          rating: this.selectedRiskRatings,
          hidden: this.showHidden ? 'true' : 'false'
        };
        return this._buildCsvExportUrl(params, endpointUrl);
      }

      _computeName(name, shortName) {
        return this.getDisplayValue([shortName, name], false, ' / ', true);
      }

      _computeType(csoType, partnerType) {
        if (!csoType) {
          return partnerType;
        } else if (csoType === 'Community Based Organization') {
          return 'CSO / Community Based';
        } else {
          return 'CSO / ' + csoType;
        }
      }


      _showOnlyGovernmentTypeFlagChanged(showOnlyGovernmentType) {
        if (showOnlyGovernmentType) {
          // lock list to government partners only
          this.set('selectedPartnerTypes', this._governmentLockedPartnerTypes);
        } else {
          // unlock list from government partners only
          this.set('selectedPartnerTypes', []);
        }
        this.set('selectedCsoTypes', []);
        this.set('selectedRiskRatings', []);
        this.set('q', '');
        this.resetPageNumber();
        this.set('showHidden', false);
        this._updateSelectedFiltersValues();
      }

      _triggerPartnerLoadingMsg() {
        this.fireEvent('trigger-partner-loading-msg');
      }
    }

    window.customElements.define(PartnersList.is, PartnersList);
  </script>
</dom-module>
