<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../bower_components/etools-file/etools-file.html">
<link rel="import" href="../../../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">
<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../../../../bower_components/etools-data-table/etools-data-table.html">
<link rel="import" href="../../../../layout/components/etools-form-element-wrapper.html">

<link rel="import" href="../../../../layout/components/etools-error-messages-box.html">
<link rel="import" href="../../../../layout/components/icons-actions.html">
<link rel="import" href="../../../../scripts/lodash.html">

<link rel="import" href="../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/risk-rating-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">

<link rel="import" href="../../../../styles/app-mixins.html">
<link rel="import" href="../../../../styles/page-common-styles.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/risk-rating-styles.html">

<link rel="import" href="components/staff-members.html">
<link rel="import" href="components/edit-core-values-assessment.html">

<dom-module id="partner-details">
  <template>
    <style include="page-common-styles grid-layout-styles shared-styles risk-rating-styles data-table-styles">
      :host {
        @apply --layout-vertical;
        width: 100%;

        --etools-file-upload-button: {
          /* overrides previus color, possibly from pd-attachements */
          color: var(--etools-file-main-btn-color);
        };
      }

      paper-input {
        width: 100%;
      }

      paper-toggle-button#showArchived {
        font-size: 16px;
        --paper-toggle-button-label-color: white;
        --paper-toggle-button-checked-bar-color: white;
      }

      icons-actions {
        visibility: hidden;
      }

      etools-data-table-row:hover icons-actions {
        visibility: visible;
      }

      iron-icon {
        color: var(--dark-secondary-text-color);
      }

    </style>

    <etools-content-panel class="content-section" panel-title="Partner Details">
      <div class="row-h flex-c">
        <div class="col col-4">
          <etools-form-element-wrapper label="Full Name" title$="[[partner.name]]" value="[[partner.name]]">
          </etools-form-element-wrapper>
        </div>
        <div class="col col-4">
          <etools-form-element-wrapper label="Short Name" value="[[partner.short_name]]">
          </etools-form-element-wrapper>
        </div>
        <div class="col col-4">
          <paper-input label="Alternate Name"
                       value="{{partner.alternate_name}}"
                       placeholder="&#8212;"
                       readonly$="[[!editMode]]"></paper-input>
        </div>
      </div>

      <div class="row-h flex-c">
        <div class="col col-4">
          <etools-form-element-wrapper label="Vendor Number" value="[[partner.vendor_number]]">
          </etools-form-element-wrapper>
        </div>
        <div class="col col-4">
          <etools-form-element-wrapper label="Partner Type" value="[[_partnerComputedType]]">
          </etools-form-element-wrapper>
        </div>
        <div class="col col-4">
          <etools-dropdown-multi label="Shared Partner"
                                 options="[[sharedPartenerValues]]"
                                 selected-values="{{partner.shared_with}}"
                                 dynamic-align
                                 readonly$="[[!editMode]]">
          </etools-dropdown-multi>
        </div>
      </div>

      <div class="row-h flex-c">
        <etools-form-element-wrapper label="Address" title$="[[partner.address]]" value="[[partner.address]]">
          <iron-icon slot="prefix" icon="communication:location-on"></iron-icon>
        </etools-form-element-wrapper>
      </div>
      <div class="row-h flex-c">
        <div class="col col-4">

          <etools-form-element-wrapper label="Phone Number" value="[[partner.phone_number]]">
            <iron-icon slot="prefix" icon="communication:phone"></iron-icon>
          </etools-form-element-wrapper>
        </div>
        <div class="col col-4">

          <etools-form-element-wrapper label="E-mail address" title$="[[partner.email]]" value="[[partner.email]]">
            <iron-icon icon="communication:email" slot="prefix"></iron-icon>
          </etools-form-element-wrapper>

        </div>
        <div class="col col-4"></div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-4">
          <!-- Risk rating -->
            <etools-form-element-wrapper label="Partner Risk Rating"
                                         no-placeholder>
              <span class$="risk-rating-field [[getRiskRatingClass(partner.rating)]]">
                [[getRiskRatingValue(partner.rating)]]
              </span>
            </etools-form-element-wrapper>

        </div>
        <div class="col col-4">
          <!-- Type of assessment -->
          <etools-form-element-wrapper label="Type of Assessment" value="[[partner.type_of_assessment]]">
          </etools-form-element-wrapper>
        </div>
        <div class="col col-4">
          <!--Date last assessed-->
          <etools-form-element-wrapper label="Date of Report" value="[[prettyDate(partner.last_assessment_date)]]">
            <iron-icon icon="date-range" slot="prefix"></iron-icon>
          </etools-form-element-wrapper>

        </div>
      </div>
    </etools-content-panel>

    <etools-content-panel class="content-section" panel-title="Core Values Assessments">
      <div slot="panel-btns" id="show-archived">
          <paper-toggle-button id="showArchived"
                          checked="{{showArchivedAssessments}}">
            Show Archived
          </paper-toggle-button>
      </div>

      <div hidden$="[[_empty(partner.core_values_assessments)]]">
        <etools-data-table-header no-title no-collapse>
          <etools-data-table-column class="col-4">
            <div>Date Last Assessed</div>
            <div>(from VISION)</div>
          </etools-data-table-column>
          <etools-data-table-column class="col-6">
            Core Values Assesment
          </etools-data-table-column>
          <etools-data-table-column class="col-2">
            Archived
          </etools-data-table-column>
        </etools-data-table-header>
        <template is="dom-repeat" items="{{partner.core_values_assessments}}">
          <etools-data-table-row no-collapse
            secondary-bg-on-hover$="[[_canEditCVA(item.assessment_file, item.archived, showCoreValuesAssessmentAttachment)]]"
            hidden$="[[!_shouldShowCVA(item.archived, showArchivedAssessments)]]">
            <div slot="row-data" class="p-relative">
              <span class="col-4">
                [[prettyDate(item.date)]]
                <span hidden$="[[!_isEmptyDate(item.date)]]" class="placeholder-style">&#8212;</span>
              </span>
              <span class="col-6">
                  <iron-icon icon="attachment" hidden$="[[!item.assessment_file]]"></iron-icon>
                  <span hidden$="[[item.assessment_file]]" class="placeholder-style">&#8212;</span>
                  <a href$="[[item.assessment_file]]"
                          target="_blank" download>[[getFileNameFromURL(item.assessment_file)]]</a>
              </span>
              <span class="col-2">
                <iron-icon icon="check" hidden$="[[!item.archived]]"></iron-icon>
              </span>
              <icons-actions item$="[[item]]"
                      hidden$="[[!_canEditCVA(item.assessment_file, item.archived, showCoreValuesAssessmentAttachment)]]"
                      show-delete="[[showDelete]]"
                      on-edit="_editCoreValuesAssessment">
              </icons-actions>
            </div>
          </etools-data-table-row>
        </template>
      </div>
      <div class="row-h" hidden$="[[!_empty(partner.core_values_assessments)]]">
        There are no Core Value Assessments.
      </div>
    </etools-content-panel>

    <staff-members id="staffMembersList"
                    data-items="[[partner.staff_members]]"
                    edit-mode="[[editMode]]">
    </staff-members>

  </template>
  <script>
    'use strict';
    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     * @appliesMixin EtoolsPmpApp.Mixins.RiskRating
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const PartnerDetailsRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Common,
      EtoolsPmpApp.Mixins.RiskRating,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     */
    class PartnerDetails extends PartnerDetailsRequiredMixins {

      static get is() {
        return 'partner-details';
      }

      static get properties() {
        return {
          partner: {
            type: Object,
            value: {},
            notify: true,
            observer: '_partnerChanged'
          },
          editMode: {
            type: Boolean,
            value: false
          },
          csoTypes: {
            type: Array,
            statePath: 'csoTypes'
          },
          partnerTypes: {
            type: Array,
            statePath: 'partnerTypes'
          },
          sharedPartenerValues: {
            type: Array,
            statePath: 'agencyChoices'
          },
          showCoreValuesAssessmentAttachment: {
            type: Boolean,
            value: false
          },
          _partnerComputedType: {
            type: String,
            computed: '_computePartnerType(partner)'
          },
          showArchivedAssessments: {
            type: Boolean,
            value: false
          },
          showDelete: {
            type: Boolean,
            value: false
          },
          editCVADialog: {
            type: Object
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        /**
         * Disable loading message for details tab elements load,
         * triggered by parent element on stamp or by tap event on tabs
         */
        this.fireEvent('global-loading', {active: false, loadingSource: 'partners-page'});
        this.fireEvent('tab-content-attached');
        this._createEditCoreValuesAssessmentsDialog();
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        if (this.editCVADialog) {
          document.querySelector('body').removeChild(this.editCVADialog);
        }
      }

      _shouldShowCVA(archived, showArchived) {
        if (showArchived) {
          return true;
        }
        return !archived;
      }

      _createEditCoreValuesAssessmentsDialog() {
        this.editCVADialog = document.createElement('edit-core-values-assessment');
        this.editCVADialog.addEventListener('save-core-values-assessment',
            this._saveCoreValuesAssessment.bind(this));
        document.querySelector('body').appendChild(this.editCVADialog);
      }

      _editCoreValuesAssessment(e) {
        this.editCVADialog.item = JSON.parse(e.target.getAttribute('item'));
        this.editCVADialog.open();
      }

      _saveCoreValuesAssessment(e) {
        this.fireEvent('save-core-values-assessment', e.detail);
      }

      _hideDeleteBtn() {
        return this.partner && this.partner.core_values_assessment_file;
      }

      _canEditCVA(attachment, archived) {
        if (attachment || archived) {
          return false;
        }
        return this.showCoreValuesAssessmentAttachment;
      }

      _partnerChanged(partner) {
        if (!_.isEmpty(partner)) {
          // decide if we should show core values assessment attachment
          this.set('showCoreValuesAssessmentAttachment',
              this._showCoreValueAssessment(partner.partner_type, partner.cso_type));

          if (this.showCoreValuesAssessmentAttachment && partner.core_values_assessment_file) {
            this._displayAssessmentNotification(partner.core_values_assessment_date, 'Core Values Assessment');
          }
          if (partner.type_of_assessment === 'Micro Assessment') {
            this._displayAssessmentNotification(partner.last_assessment_date, 'Micro Assessment');
          }

          this._sortCvaDescByDate();
        }
      }

      _sortCvaDescByDate() {
        this.partner.core_values_assessments.sort((a,b) => {
          return new Date(b.date) - new Date(a.date);
        })
      }

      _displayAssessmentNotification(assesmentDateString, assesmentType) {
        if (!assesmentDateString) {
          return;
        }
        let datesFormat = 'YYYY-MM-DD';
        let today = moment.utc().format(datesFormat);
        let assessmentDate = this._convertDate(assesmentDateString);
        let assessmentExpDate = moment(assessmentDate).add(60, 'months');

        let daysUntilExpire = assessmentExpDate.diff(today, 'days');

        let notifMessage = '';
        if (daysUntilExpire < 1) {
          notifMessage = 'The ' + assesmentType + ' is expired (' + assessmentExpDate.format(datesFormat) + ')';
        } else {
          let notifStartDate = moment(assessmentDate).add(57, 'months');
          if (moment(today).isAfter(notifStartDate)) {
            notifMessage = 'The ' + assesmentType + ' will expire in ' + daysUntilExpire + ' days';
          }
        }
        if (notifMessage) {
          setTimeout(() => {
            this.fireEvent('toast', {text: notifMessage, showCloseBtn: true});
          }, 0);
        }
      }

      _computePartnerType(partner) {
        return !_.isEmpty(partner)
          ? this._getPartnerType(partner.partner_type, partner.cso_type)
          : '';
      }

      _getPartnerType(partnerType, csoType) {
        return (csoType !== null) ? (partnerType + '/' + csoType) : partnerType;
      }

      /**
       * Show core values assessment attachment only if partner type is 'Civil Society Organization'
       * and cso_type is 'National'
       */
      _showCoreValueAssessment(partnerType, csoType) {
        return partnerType === 'Civil Society Organization' &&
            (['National', 'Academic Institution', 'Community Based Organization'].indexOf(csoType) > -1);
      }

      _validatePageData() {
        return this.$.staffMembersList.validate();
      }
      _isEmptyDate(date) {
        if (!date) {
          return true;
        }
        let converted = this.prettyDate(date);
        return !converted;
      }

      _empty(val) {
        return _.isEmpty(val);
      }

    }

    window.customElements.define(PartnerDetails.is, PartnerDetails);
  </script>
</dom-module>
