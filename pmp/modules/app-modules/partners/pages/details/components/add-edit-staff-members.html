<link rel="import" href="../../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../../bower_components/etools-dialog/etools-dialog.html">

<link rel="import" href="../../../../../layout/components/etools-form-element-wrapper.html">
<link rel="import" href="../../../../../mixins/event-helper-mixin.html">

<link rel="import" href="../../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../../styles/shared-styles.html">

<dom-module id="add-edit-staff-members">
  <template>
    <style include="grid-layout-styles shared-styles">
      paper-input {
        width: 100%;
      }

      .col:first-of-type {
        padding-right: 12px;
      }
      .col:not(:first-of-type) {
        padding-left: 12px;
      }
    </style>
    <etools-dialog id="staffMemberDialog" dialog-title="Partner Contact" size="md"
                   ok-btn-text="Save" keep-dialog-open spinner-Text="Saving..."
                   on-confirm-btn-clicked="_savePartnerContact">
      <div class="row-h flex-c">
        <div class="col col-6">
          <paper-input id="position" label="Position"
                  value="{{item.title}}"
                  placeholder="&#8212;"
                  invalid$="[[!_isValid('title', item.title, item.first_name, item.last_name, item.email, item.phone)]]"
                  error-message="Position is required"></paper-input>
        </div>
        <div class="col col-6">
          <etools-form-element-wrapper>
            <paper-checkbox checked="{{item.active}}">
              Active?
            </paper-checkbox>
          </etools-form-element-wrapper>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
            <paper-input id="firstName"
                         label="First Name"
                         value="{{item.first_name}}"
                         placeholder="&#8212;"
                         invalid$="[[!_isValid('firstName', item.title, item.first_name, item.last_name, item.email, item.phone)]]"
                         error-message="First name is required">
            </paper-input>
        </div>
        <div class="col col-6">
            <paper-input id="lastName"
                         label="Last Name"
                         value="{{item.last_name}}"
                         placeholder="&#8212;"
                         invalid$="[[!_isValid('lastName', item.title, item.first_name, item.last_name, item.email, item.phone)]]"
                         error-message="Last name is required">
            </paper-input>
        </div>
      </div>
      <div class="row-h flex-c">
        <div class="col col-6">
          <paper-input id="email"
                       label="E-mail address"
                       value="{{item.email}}"
                       placeholder="&#8212;"
                       invalid$="[[!_isValid('emailAddress', item.title, item.first_name, item.last_name, item.email, item.phone)]]"
                       error-message="A valid & unused email address is required">
            <iron-icon slot="prefix" icon="communication:email"></iron-icon>
          </paper-input>
        </div>
        <div class="col col-6">
            <paper-input id="phone"
                         label="Phone number"
                         value="{{item.phone}}"
                         placeholder="&#8212;"
                         allowed-pattern="[0-9\ \.\+\-\(\)]">
              <iron-icon slot="prefix" icon="communication:phone"></iron-icon>
            </paper-input>
        </div>
      </div>
    </etools-dialog>
  </template>
  <script>
    'use strict';
    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    class AddEditStaffMembers extends EtoolsPmpApp.Mixins.EventHelper(Polymer.Element) {
      static get is() {
        return 'add-edit-staff-members';
      }

      static get properties() {
        return {
          item: {
            type: Object
          },
          dataItems: {
            type: Array,
            value: []
          }
        };
      }

      open() {
        this.$.staffMemberDialog.opened = true;
      }

      _isValid(field, title, firstName, lastName, emailAddress, phone) {
        let valid = true;
        switch (field) {
          case 'title':
            if (!this._notEmpty(title) && (this._notEmpty(firstName) || this._notEmpty(lastName) ||
                    this._notEmpty(emailAddress) || this._notEmpty(phone))) {
              valid = false;
            }
            break;
          case 'firstName':
            if (!this._notEmpty(firstName) && (this._notEmpty(title) || this._notEmpty(lastName) ||
                    this._notEmpty(emailAddress) || this._notEmpty(phone))) {
              valid = false;
            }
            break;
          case 'lastName':
            if (!this._notEmpty(lastName) && (this._notEmpty(title) || this._notEmpty(firstName) ||
                    this._notEmpty(emailAddress) || this._notEmpty(phone))) {
              valid = false;
            }
            break;
          case 'emailAddress':
            if (this._notEmpty(emailAddress)) {
              valid = this._validStaffMemberEmailAddress(emailAddress);
            } else {
              if (this._notEmpty(phone) || this._notEmpty(title) || this._notEmpty(firstName) ||
                  this._notEmpty(lastName)) {
                valid = false;
              } else {
                valid = true; // empty staff member data, hide error msgs
              }
            }
            break;
        }
        return valid;
      }

      _notEmpty(value) {
        return typeof value !== 'undefined' && value !== null && value !== '';
      }

      _validStaffMemberEmailAddress(emailAddress) {
        let valid = true;

        if (this._emailAlreadyUsed(emailAddress)) {
          valid = false;
        } else {
          // eslint-disable-next-line
          let re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
          valid = re.test(emailAddress);
        }
        return valid;
      }

      _emailAlreadyUsed(emailAddress) {
        let sameEmailItems = this.dataItems.filter((el) => {
          return el.email === emailAddress
            && Number(el.id) !== Number(this.item.id);
        });

        return sameEmailItems.length > 0;
      }

      _emptyStaffMemberData(member) {
        return member
            && !this._notEmpty(member.first_name)
            && !this._notEmpty(member.last_name)
            && !this._notEmpty(member.phone)
            && !this._notEmpty(member.email);
      }

      validate() {
        let valid = true;
        if (this.dataItems instanceof Array && this.dataItems.length > 0) {
          for (let j = 0; j < this.dataItems.length; j++) {
            if (this._emptyStaffMemberData(this.dataItems[j])) {
              valid = false;
              break;
            }
            let fields = ['#firstName', '#lastName',
              '#phone', '#email', '#title'];
            for (let i = 0; i < fields.length; i++) {
              let el = this.$.staffMemberDialog.querySelector(fields[i]);
              if (el && el.invalid) {
                valid = false;
                break;
              }
            }
            if (!valid) {
              break;
            }
          }
        }
        return valid;
      }

      _savePartnerContact() {
        if (this.validate()) {
          this.fireEvent('save-partner-contact', this.item);
          this.$.staffMemberDialog.opened = false;
        }
      }

    }
    window.customElements.define(AddEditStaffMembers.is, AddEditStaffMembers);
  </script>

</dom-module>
