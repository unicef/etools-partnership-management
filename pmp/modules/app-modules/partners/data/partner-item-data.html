<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../bower_components/etools-ajax/etools-ajax-request-mixin.html">
<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../config/dexie-db-config.html">
<link rel="import" href="../../../endpoints/endpoints-mixin.html">
<link rel="import" href="../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../mixins/ajax-server-errors-mixin.html">
<link rel="import" href="../../../redux/etools-data-redux-store.html">

<dom-module id="partner-item-data">
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsAjaxRequestMixin
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.AjaxServerErrors
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const PartnerItemDataRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin, EtoolsAjaxRequestMixin, EtoolsPmpApp.Mixins.Endpoints,
      EtoolsPmpApp.Mixins.AjaxServerErrors, EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin PartnerItemDataRequiredMixins
     */
    class PartnerItemData extends PartnerItemDataRequiredMixins {

      static get is() {
        return 'partner-item-data';
      }

      static get properties() {
        return {
          partnerEndpoints: {
            type: Object,
            value: {
              DETAILS: 'partnerDetails',
              CREATE: 'createPartner',
              DELETE: 'deletePartner'
            }
          },
          partner: {
            type: Object,
            readOnly: true,
            notify: true
          },
          partnerId: {
            type: Number,
            notify: true,
            observer: '_partnerIdChanged'
          },
          deletedPartnerId: {
            type: Number
          },
          handleSuccResponseAdditionalCallback: Object,
          handleErrResponseAdditionalCallback: Object,
          _skipDefaultErrorHandler: Boolean,
          /**
           * ajaxLoadingMsgSource use is required for request errors handling in AjaxServerErrorsBehavior
           */
          ajaxLoadingMsgSource: {
            type: String,
            value: 'partner-data'
          }
        };
      }

      static get actions() {
        return {
          deletePartner: function(partnerId) {
            return {
              type: 'DELETE_PARTNER',
              partnerId: partnerId
            };
          }
        };
      }

      _partnerIdChanged(newId) {
        if (newId) {
          // set an empty partner
          this._setPartner({});
          // set the new endpoint
          this.fireEvent('global-loading', {
            message: 'Loading...',
            active: true,
            loadingSource: this.ajaxLoadingMsgSource
          });
          this._triggerPartnerRequest({endpoint: this.getEndpoint(this.partnerEndpoints.DETAILS, {id: newId})});
        }
      }

      _triggerPartnerRequest(options) {
        let ajaxMethod = options.method || 'GET';
        this.sendRequest(options).then((resp) => {
          this._handleSuccResponse(resp, ajaxMethod);
        }).catch((error) => {
          this._handleErrorResponse(error, ajaxMethod);
        });
      }

      _handleSuccResponse(response, ajaxMethod) {
        this._setPartner(response);

        if (typeof this.handleSuccResponseAdditionalCallback === 'function') {
          this.handleSuccResponseAdditionalCallback.bind(this, response)();
          // reset callback
          this.set('handleSuccResponseAdditionalCallback', null);
          this.set('handleErrResponseAdditionalCallback', null);
        }

        if (['GET', 'DELETE'].indexOf(ajaxMethod) === -1) {
          // update the partners list in dexieDB
          EtoolsPmpApp.DexieDb.table('partners').put(response).then(() => {
            this.fireEvent('reload-list');
          });
        }
        if (ajaxMethod === 'DELETE') {
          this.dispatch('deletePartner', this.deletedPartnerId);
          this._deletePartnerFromDexie(this.deletedPartnerId);
        }
      }

      _deletePartnerFromDexie(id) {
        EtoolsPmpApp.DexieDb.partners.where('id')
            .equals(parseInt(id, 10))
            .delete()
            .then(deleteCount => this._handlePartnerDeleteFromDexieSuccess(deleteCount))
            .catch(dexieDeleteErr => this._handlePartnerDeleteFromDexieErr(dexieDeleteErr))
            .then(() => {
              // disable loading
              this.fireEvent('global-loading', {
                active: false,
                loadingSource: this.ajaxLoadingMsgSource
              });
              // go to partners list after delete
              this.fireEvent('update-main-path', {path: 'partners/list'});
            });
      }

      _handlePartnerDeleteFromDexieSuccess(deleteCount) {
        if (deleteCount === 1) {
          this.fireEvent('reload-list');
          this.fireEvent('toast', {
            text: 'Partner successfully deleted.',
            showCloseBtn: true
          });
        } else {
          throw new Error('Partner was not deleted from dexie!');
        }
      }

      _handlePartnerDeleteFromDexieErr(dexieDeleteErr) {
        // Partner dexie deleted issue
        this.logError('Partner delete from local dexie db failed!', 'partner-item-data', dexieDeleteErr);
        this.fireEvent('toast', {
          text: 'The partner was deleted from server database, but there was an issue on cleaning ' +
          'partner data from browser cache. Use refresh data functionality to update cached partners data.',
          showCloseBtn: true
        });
      }

      _handleErrorResponse(response, ajaxMethod) {
        if (this._skipDefaultErrorHandler) {
          this.fireEvent('global-loading', {
            active: false,
            loadingSource: this.ajaxLoadingMsgSource
          });
        } else {
          this.handleErrorResponse(response, ajaxMethod, true);
        }
        this.set('_skipDefaultErrorHandler', false);

        if (typeof this.handleErrResponseAdditionalCallback === 'function') {
          this.handleErrResponseAdditionalCallback.bind(this,
              this.formatServerErrorAsText(this.tryGetResponseError(response)))();
        }
        this.handleErrResponseAdditionalCallback = null;
        this.handleSuccResponseAdditionalCallback = null;
      }

      createPartner(vendorNoObj, successCallback, errorCallback) {
        if (!vendorNoObj && !vendorNoObj.vendor) {
          this.fireEvent('toast', {
            text: 'Invalid Vendor Number for new partner!',
            showCloseBtn: true
          });
          return;
        }
        this.fireEvent('global-loading', {
          message: 'Importing partner information...',
          active: true,
          loadingSource: this.ajaxLoadingMsgSource
        });

        this.handleSuccResponseAdditionalCallback = successCallback;
        this.handleErrResponseAdditionalCallback = errorCallback;

        this.set('_skipDefaultErrorHandler', true);
        let endpoint = this.getEndpoint(this.partnerEndpoints.CREATE, vendorNoObj);
        this._triggerPartnerRequest({method: 'POST', endpoint: endpoint, body: {}});
      }

      deletePartner(partner) {
        if (!partner.id) {
          return;
        }
        this.deletedPartnerId = partner.id;
        let endpoint = this.getEndpoint(this.partnerEndpoints.DELETE, {id: partner.id});
        this._triggerPartnerRequest({method: 'DELETE', endpoint: endpoint, body: {}});
      }

      savePartner(partner, callback) {
        if (typeof partner === 'object' && Object.keys(partner).length === 0) {
          this.fireEvent('toast', {text: 'Invalid partner data!', showCloseBtn: true});
        } else {
          let endpoint = null;
          let partnerId = partner.id;
          // remove id from data
          if (partner.id) {
            delete partner.id;
          }
          if (Object.keys(partner).length > 0) {
            if (partnerId) {
              // prepare PATCH endpoint
              endpoint = this.getEndpoint(this.partnerEndpoints.DETAILS, {id: partnerId});
            } else {
              // no valid partner id, cannot update
              this.fireEvent('toast', {
                text: 'Update cannot be made. Invalid partner ID.',
                showCloseBtn: true
              });
              return;
            }
            // set additional callback if any
            if (callback) {
              this.set('handleSuccResponseAdditionalCallback', callback);
            }
            let withUpload = false; // used to set multipart prop on etools-ajax
            if (partner.hasOwnProperty('core_values_assessments')) {
              if (partner.core_values_assessments.length) {
                for(let i = 0; i < partner.core_values_assessments.length; i++) {
                  if (partner.core_values_assessments[i].attachment instanceof File) {
                    withUpload = true;
                    break;
                  }
                }
                if (!withUpload) {
                delete partner.core_values_assessments;
                }
              }
            }
            if (partner.hasOwnProperty('assessments')) {
              if ((Array.isArray(partner.assessments)) && (partner.assessments.length > 0)) {
                partner.assessments = partner.assessments.map(function(assessment) {
                  if (assessment.report instanceof File) {
                    withUpload = true;
                  } else {
                    delete assessment.report;
                  }
                  return assessment;
                }, this);
              }
            }
            this.fireEvent('global-loading', {
              message: 'Saving...',
              active: true,
              loadingSource: this.ajaxLoadingMsgSource
            });
            // fire in the hole
            this._triggerPartnerRequest({
              method: 'PATCH', endpoint: endpoint, body: partner,
              multiPart: withUpload, prepareMultipartData: withUpload
            });
          } else {
            this.fireEvent('toast', {
              text: 'There is nothing to save. No change detected on this partner.',
              showCloseBtn: true
            });
          }
        }
      }

    }

    window.customElements.define(PartnerItemData.is, PartnerItemData);
  </script>
</dom-module>
