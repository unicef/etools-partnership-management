<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">

<link rel="import" href="../../../scripts/lodash.html">

<link rel="import" href="../../../mixins/list-data-mixin.html">
<link rel="import" href="../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../config/dexie-db-config.html">
<link rel="import" href="../../../redux/etools-data-redux-store.html">

<dom-module id="partners-list-data">
  <script>
    'use strict';
    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.ListData
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     */
    const PartnersListDataRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.ListData,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin PartnersListDataRequiredMixins
     */
    class PartnersListData extends PartnersListDataRequiredMixins {
      static get is() {
        return 'partners-list-data';
      }

      static get properties() {
        return {
          endpointName: {
            type: String,
            value: 'partners'
          },

          dataLoadedEventName: {
            type: String,
            value: 'partners-loaded'
          },

          filteredPartners: {
            type: Array,
            readOnly: true,
            notify: true
          },

          totalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },

          currentQuery: {
            type: Object,
            value: null
          },

          partnersDropdownData: {
            type: Array,
            notify: true
          },

          partnersFilteredDropdownData: {
            type: Array,
            notify: true
          },

          prepareDropdownData: {
            type: Boolean,
            value: false
          }
        };
      }

      static get actions() {
        return {
          setPartnersDropdown: function(partnersDropdownData) {
            return {
              type: 'SET_PARTNERS_DROPDOWN',
              partnersDropdownData: partnersDropdownData
            };
          },
          setPartners: function(partnersData) {
            return {
              type: 'SET_PARTNERS',
              partnersData: partnersData
            };
          },
          setCivilSocietyOrganizationPartners: function(csoPartners) {
            return {
              type: 'SET_CSO_PARTNERS',
              csoPartners: csoPartners
            };
          }
        };
      }

      _handleMyResponse(res) {
        this._handleResponse(res);
        if (res && res.length) {
          this.dispatch('setPartners', res);
          let preparedData = [];
          let civilSocietyOrganizationPartners = [];
          res.forEach(function(p) {
            if (!p.hidden && p.partner_type === 'Civil Society Organization') {
              civilSocietyOrganizationPartners.push(p);
            }
            if (!p.hidden) {
              preparedData.push({
                value: p.id,
                label: p.name
              });
            }
          });
          this.dispatch('setPartnersDropdown', preparedData);
          this.dispatch('setCivilSocietyOrganizationPartners', civilSocietyOrganizationPartners);
        }
      }

      query(field, order, searchString, partnerTypes, csoTypes, riskRatings,
            pageNumber, pageSize, showHidden, showQueryLoading) {

        // If an active query transaction exists, abort it and start
        // a new one
        if (this.currentQuery) {
          this.currentQuery.abort();
        }

        let self = this;

        if (showQueryLoading) {
          this.fireEvent('global-loading', {
            message: 'Loading...',
            active: true,
            loadingSource: 'partners-list'
          });
        }

        let partnersDexieTable = EtoolsPmpApp.DexieDb.partners;
        EtoolsPmpApp.DexieDb.transaction('r', partnersDexieTable, function() {
          self.currentQuery = Dexie.currentTransaction;

          let queryResult = partnersDexieTable;
          if (field) {
            // note: null values don't appear in result set of sort
            queryResult = queryResult.orderBy(field);
          }
          if (order === 'desc') {
            queryResult = queryResult.reverse();
          }

          queryResult = queryResult.filter(function(partner) {
            if (!_.isEmpty(partnerTypes) && partnerTypes.indexOf(partner.partner_type) === -1) {
              return false;
            }

            if (!_.isEmpty(csoTypes) && csoTypes.indexOf(partner.cso_type) === -1) {
              return false;
            }

            if (!_.isEmpty(riskRatings) && riskRatings.indexOf(partner.rating) === -1) {
              return false;
            }

            if (searchString && searchString.length) {
              let vnMatch = true;
              if (partner.vendor_number) {
                vnMatch = partner.vendor_number.toString().toLowerCase().indexOf(searchString) < 0;
              }
              if (partner.name.toLowerCase().indexOf(searchString) < 0 &&
                  partner.short_name.toLowerCase().indexOf(searchString) < 0 &&
                  vnMatch) {
                return false;
              }
            }

            if (!showHidden && partner.hidden) {
              return false;
            }

            return true;
          });

          // This special Dexie function allows the work of counting
          // the number of query results to be done in a parallel process,
          // instead of blocking the main query
          Dexie.ignoreTransaction(function() {
            queryResult.count(function(count) {
              self._setTotalResults(count);
            });
          });

          return queryResult
              .offset((pageNumber - 1) * pageSize)
              .limit(pageSize)
              .toArray();

        }).then(function(result) {
          self._setFilteredPartners(result);
          self.fireEvent('global-loading', {
            active: false,
            loadingSource: 'partners-list'
          });
        }).catch(function(error) {
          self.logError('Error querying partners!', 'partners-list-data', error, true);
          self.fireEvent('global-loading', {
            active: false,
            loadingSource: 'partners-list'
          });

          if (error.name === 'DatabaseClosedError') {
            window.location.reload(true);
          }
        });
      }
    }

    window.customElements.define(PartnersListData.is, PartnersListData);
  </script>
</dom-module>
