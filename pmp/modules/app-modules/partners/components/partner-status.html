<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../../../bower_components/etools-dialog/dynamic-dialog-mixin.html">

<link rel="import" href="../../../scripts/lodash.html">
<link rel="import" href="../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../config/app-constants.html">
<link rel="import" href="../../../layout/components/etools-status/etools-status-common-mixin.html">
<link rel="import" href="../../../layout/components/etools-status/etools-status.html">
<link rel="import" href="../../../styles/app-mixins.html">

<dom-module id="partner-status">
  <template>
    <style>
      :host {
        width: 100%;
        --etools-status-container: {
          height: auto;
          min-height: 40px;
        };
        --etools-status-label-style: {
          font-weight: normal;
          width: 120px;
        };
      }
      /* HD res: 1360/1366 x 768 */
      @media only screen and (max-width: 1359px) {
        :host {
          --etools-status-label-style: {
            font-weight: normal;
            width: 100%;
          };
        }
      }

    </style>

    <etools-status statuses="[[possibleStatuses]]"
                   actions="[[possibleActions]]"
                   on-partner-delete="_showDeleteConfirmationDialog">
    </etools-status>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsMixins.DynamicDialogMixin
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsStatusCommon
     * @appliesMixin EtoolsPmpApp.Mixins.Constants
     */
    class PartnerStatus extends EtoolsMixinFactory.combineMixins([
      EtoolsMixins.DynamicDialogMixin,
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.EtoolsStatusCommon,
      EtoolsPmpApp.Mixins.Constants
    ], Polymer.Element) {

      static get is() {
        return 'partner-status';
      }

      static get properties() {
        return {
          partner: {
            type: Object,
            notify: true
          },
          editMode: {
            type: Boolean,
            value: false
          },
          deleteWarningDialogContent: {
            type: Object
          },
          possibleStatuses: {
            type: Array,
            value: []
          },
          possibleActions: {
            type: Array,
            value: [
              {
                label: 'Save',
                hidden: true,
                primary: true,
                // save action is hadled inside the parent
                event: 'save-partner'
              },
              {
                label: 'Delete',
                hidden: true,
                event: 'partner-delete'
              }
            ]
          }
        };
      }

      static get observers() {
        return [
          '_partnerStatusChanged(partner.vision_synced, partner.deleted_flag, partner.blocked, possibleStatuses)',
          '_computeAvailableActions(partner.hidden, editMode)'
        ];
      }

      ready() {
        super.ready();

        this.deleteWarningDialogContent = document.createElement('div');
        this.deleteWarningDialogContent.setAttribute('id', 'deleteWarningContent');
        this._dialogConfirmationCallback = this._dialogConfirmationCallback.bind(this);
        this.warningDialog = this.createDialog('Delete Confirmation', 'md', 'Yes', 'No',
            this._dialogConfirmationCallback, this.deleteWarningDialogContent);
        this.warningDialog.updateStyles({'--paper-dialog-scrollable': 'var(--pmp-paper-dialog-content)'});

        this._handleStickyScroll();
        setTimeout(this.setPossibleStatuses.bind(this), 0);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this.warningDialog.removeEventListener('close', this._dialogConfirmationCallback);
      }

      setPossibleStatuses() {
        this.set('possibleStatuses', [
          {
            label: this.CONSTANTS.PARTNER_STATUSES.NotSynced,
            icon: 'info',
            iconStyles: 'width: 19px; height: 19px; color: ' +
            this.getComputedStyleValue('--primary-background-color'),
            iconContainerStyles: 'background-color: ' +
            this.getComputedStyleValue('--status-not-synced-color'),
            hidden: true,
            completed: false
          },
          {
            label: this.CONSTANTS.PARTNER_STATUSES.SyncedFromVISION,
            icon: 'autorenew',
            iconStyles: 'width: 19px; height: 19px; color: ' +
            this.getComputedStyleValue('--primary-background-color'),
            iconContainerStyles: 'background-color: ' + this.getComputedStyleValue('--status-synced-color'),
            hidden: true,
            completed: false
          },
          {
            label: this.CONSTANTS.PARTNER_STATUSES.BlockedInVISION,
            icon: 'block',
            iconStyles: 'width: 19px; height: 19px; color: ' +
            this.getComputedStyleValue('--primary-background-color'),
            iconContainerStyles: 'background-color: ' + this.getComputedStyleValue('--status-blocked-color'),
            hidden: true,
            completed: false
          },
          {
            label: this.CONSTANTS.PARTNER_STATUSES.MarkedForDeletionInVISION,
            icon: 'delete-forever',
            iconStyles: 'color: ' + this.getComputedStyleValue('--error-color'),
            iconContainerStyles: 'background-color: ' +
            this.getComputedStyleValue('--primary-background-color'),
            hidden: true,
            completed: false
          }
        ]);
      }

      _partnerStatusChanged(visionSynced, deletedFlag, blocked, possibleStatuses) {
        if (typeof visionSynced === 'undefined' && typeof deletedFlag === 'undefined'
          && typeof blocked === 'undefined' && _.isEmpty(possibleStatuses)) {
          return;
        }
        this._computeAvailableStatuses();
        this._forceScollPositionRecalculation();
      }

      _isHidden(hidden) {
        if (typeof hidden === 'undefined' || hidden === null) {
          return true;
        }
        return hidden;
      }
      _showDeleteConfirmationDialog() {
        if (!this.warningDialog) {
          this.logWarn('warningDialog not created!', 'pmp partner status change');
          return;
        }

        if (!this.deleteWarningDialogContent) {
          this.logWarn('#deleteWarningContent element not found!', 'pmp partner status change');
          return;
        }
        let warningMessage = 'Are you sure you want to delete partner ' + this.partner.name + '?';
        this.deleteWarningDialogContent.innerHTML = warningMessage;
        this.warningDialog.opened = true;
      }

      _dialogConfirmationCallback(event) {
        if (event.detail.confirmed) {
          if (!this.editMode) {
            return;
          }
          this.fireEvent('delete-partner', {id: this.partner.id});
        }
      }

      _computeAvailableActions(hidden, editMode) {
        if (!editMode || !this.partner) {
          return;
        }
        this._setAllActionsToHidden();
        let availableOptions = ['Save', 'Delete'];

        for (let key in this.possibleActions) {
          if (this.possibleActions[key].label) {
            let actionName = this.possibleActions[key].label;

            if (availableOptions.indexOf(actionName) > -1) {
              this.set(['possibleActions', key, 'hidden'], false);
            }
          }
        }
      }
      _computeAvailableStatuses() {
        let activeStatus;
        this._setAllStatusesToHidden();
        if (!this.partner) {
          return;
        }
        switch (true) {
          case this._showNotSyncedStatus():
            activeStatus = this.CONSTANTS.PARTNER_STATUSES.NotSynced;
            break;
          case this._showSyncedStatus():
            activeStatus = this.CONSTANTS.PARTNER_STATUSES.SyncedFromVISION;
            break;
          case this._showBlockedStatus():
            activeStatus = this.CONSTANTS.PARTNER_STATUSES.BlockedInVISION;
            break;
          case this._showMakedForDeletionStatus():
            activeStatus = this.CONSTANTS.PARTNER_STATUSES.MarkedForDeletionInVISION;
            break;
        }

        for (let key = this.possibleStatuses.length - 1; key >= 0; key--) {
          if (this.possibleStatuses[key].label === activeStatus) {
            this.set(['possibleStatuses', key, 'completed'], true);
            this.set(['possibleStatuses', key, 'hidden'], false);
          }
        }
      }
      _showSyncedStatus() {
        return this.partner.vision_synced === true && this.partner.deleted_flag === false &&
            (typeof this.partner.blocked === 'undefined' || this.partner.blocked === false);
      }

      _showBlockedStatus() {
        return this.partner.deleted_flag === false &&
            (typeof this.partner.blocked !== 'undefined' && this.partner.blocked === true);
      }

      _showMakedForDeletionStatus() {
        return this.partner.deleted_flag;
      }

      _showNotSyncedStatus() {
        return this.partner.vision_synced === false;
      }

    }

    window.customElements.define(PartnerStatus.is, PartnerStatus);
  </script>
</dom-module>
