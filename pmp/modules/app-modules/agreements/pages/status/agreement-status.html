<link rel="import" href="../../../../../../bower_components/iron-icons/av-icons.html">

<link rel="import" href="../../../../styles/app-theme.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../../layout/components/etools-status/etools-status.html">
<link rel="import" href="../../../../layout/components/etools-status/etools-status-common-mixin.html">



<dom-module id="agreement-status">
  <template strip-whitespace>
    <style>
       :host {
        width: 100%;
        --status-top: auto;
      }
      etools-status {
        top: var(--status-top);
      }
    </style>
    <etools-status statuses="[[possibleStatuses]]"
                    actions="[[possibleActions]]"
                    on-agreement-suspend-event="_setStatusSuspended"
                    on-agreement-terminate-event="_setStatusTerminated"
                    on-agreement-unsuspend-event="_unsuspendAgreement">
    </etools-status>
  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsStatusCommon
     */

    const AgreementStatusRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.EventHelper,
      EtoolsPmpApp.Mixins.EtoolsStatusCommon
    ], Polymer.Element);


   /**
    * @polymer
    * @customElement
    * @appliesMixin AgreementStatusRequiredMixins
    */
    class AgreementStatus extends AgreementStatusRequiredMixins {
      static get is() {
        return 'agreement-status';
      }

      static get properties() {
        return {
          agreementId: {
            value: null
          },
          agreementType: {
            type: String,
            value: ''
          },
          newAgreement: {
            type: Boolean,
            value: false
          },
          possibleStatuses: {
            type: Array,
            value: function() {
              return [
                {
                  label: 'Draft',
                  hidden: false,
                  completed: false
                },
                {
                  label: 'Signed',
                  hidden: false,
                  completed: false
                },
                {
                  label: 'Suspended',
                  icon: 'av:pause-circle-filled',
                  iconStyles: 'color: ' + ShadyCSS.getComputedStyleValue(this, '--warning-color'),
                  hidden: false,
                  completed: false
                },
                {
                  label: 'Terminated',
                  icon: 'report-problem',
                  iconStyles: 'color: ' + ShadyCSS.getComputedStyleValue(this, '--error-color'),
                  hidden: false,
                  completed: false
                },
                {
                  label: 'Ended',
                  hidden: false,
                  completed: false
                },
              ];
            }
          },
          possibleActions: {
            type: Array,
            value: [
              {
                label: 'Save',
                hidden: true,
                primary: true,
                event: 'save-agreement'
                // save-agreement event is handeled by the parnent
              },
              {
                label: 'Suspend',
                hidden: true,
                event: 'agreement-suspend-event'
              },
              {
                label: 'Unsuspend',
                hidden: true,
                event: 'agreement-unsuspend-event'
              },
              {
                label: 'Terminate',
                hidden: true,
                event: 'agreement-terminate-event'
              },
            ]
          }
        };
      }

      ready() {
        super.ready();
        this.set('sectionName', 'Agreement');
        this._createStatusChangeWarningDialog();
        this._handleStickyScroll();
      }

      _computeAvailableActions(status) {
        this._setAllActionsToHidden();
        if (!this.editMode) {
          return;
        }
        let availableOptions = [];

        switch (status) {
          case 'signed':
            availableOptions.push('Save');
            if (this.agreementType !== 'SSFA') {
              availableOptions.push('Suspend');
              availableOptions.push('Terminate');
            }
            break;

          case 'suspended':
            if (this.agreementType !== 'SSFA') {
              availableOptions.push('Unsuspend');
            }
            break;

          case 'terminated':
            break;

          case 'ended':
            break;

          default:
            availableOptions.push('Save');
            break;
        }

        for (let key in this.possibleActions) {
          let actionName = this.possibleActions[key].label;

          if (availableOptions.indexOf(actionName) > -1) {
            this.set(['possibleActions', key, 'hidden'], false);
          }
        }
      }

      _computeAvailableStatuses(status) {
        this._setAllStatusesToHidden();
        let availableStatuses = [];
        let completedFlag = false;
        let activeStatus;

        switch (status) {
          case 'draft':
            availableStatuses = [
              'Draft',
              'Signed',
              'Ended',
            ];
            activeStatus = 'Draft';
            break;

          case 'signed':
            availableStatuses = [
              'Draft',
              'Signed',
              'Ended',
            ];
            activeStatus = 'Signed';
            break;

          case 'suspended':
            availableStatuses = [
              'Draft',
              'Signed',
              'Suspended',
              'Ended',
            ];
            activeStatus = 'Suspended';
            break;

          case 'terminated':
            availableStatuses = [
              'Draft',
              'Signed',
              'Terminated',
              'Ended',
            ];
            activeStatus = 'Terminated';
            break;

          case 'ended':
            availableStatuses = [
              'Draft',
              'Signed',
              'Ended',
            ];
            activeStatus = 'Ended';
            break;
          default:
            availableStatuses = [
              'Draft',
              'Signed',
              'Ended',
            ];
            activeStatus = '';
            break;
        }

        for (let key = this.possibleStatuses.length - 1; key >= 0; key--) {
          let workingStatusLabel = this.possibleStatuses[key].label;
          if (workingStatusLabel === activeStatus && !this.newAgreement) {
            completedFlag = true;
          }
          if (availableStatuses.indexOf(workingStatusLabel) > -1) {
            this.set(['possibleStatuses', key, 'hidden'], false);
          }
          this.set(['possibleStatuses', key, 'completed'], completedFlag);
        }
      }

      _statusChangeConfirmationCallback(event) {
        if (event.detail.confirmed) {
          this.fireEvent('update-agreement-status', {
            agreementId: this.agreementId,
            status: this.newStatus + ''
          });
          this.fireEvent('reload-list');
        }
        this.set('newStatus', '');
      }

      _statusChangeIsValid(newStatus) {
        if (this.newAgreement) {
          return false;
        }

        if (newStatus === 'draft') { //TODO Is this check necessary?
          // if agreement was not saved (is new) or the status is already changed
          // from draft, stop status change
          if (this.status !== 'draft') {
            return false;
          }
        }
        if (['suspended', 'terminated'].indexOf(newStatus) > -1) {
          if (this.status !== 'signed') {
            //prevent suspending or terminating anything other than signed agreement
            return false;
          }
        }
        return true;
      }

      _computeWarningMessage(newStatus) {
        switch (newStatus) {
          case 'terminated':
            this.set('warningMessage', 'You are about to terminate this Agreement. Do you want to continue?');
            break;
          case 'suspended':
            this.set('warningMessage', 'You are about to suspend this Agreement. Do you want to continue?');
            break;
          case 'signed':
            this.set('warningMessage', 'You are about to unsuspend this Agreement. Do you want to continue?');
            break;
          default:
            this.set('warningMessage', this._getDefaultWarningMessage());
            break;
        }
      }

      _setStatusTerminated() {
        this._updateStatus('terminated');
      }

      _setStatusSuspended() {
        this._updateStatus('suspended');
      }

      _unsuspendAgreement() {
        this._updateStatus('signed');
      }
    }

    window.customElements.define(AgreementStatus.is, AgreementStatus);
  </script>
</dom-module>
