<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../../bower_components/etools-content-panel/etools-content-panel.html">
<link rel="import" href="../../../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">
<link rel="import" href="../../../../../../bower_components/etools-dropdown/etools-dropdown.html">

<link rel="import" href="../../../../layout/components/etools-form-element-wrapper.html">
<link rel="import" href="../../../../layout/components/etools-single-file.html">
<link rel="import" href="../../../../layout/components/etools-date-input.html">

<link rel="import" href="../../../../styles/required-field-styles.html">
<link rel="import" href="../../../../styles/buttons-styles.html">
<link rel="import" href="../../../../styles/app-mixins.html">
<link rel="import" href="../../../../styles/page-common-styles.html">
<link rel="import" href="../../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../styles/shared-styles.html">

<link rel="import" href="../../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../../../modules/mixins/missing-dropdown-options-mixin.html">
<link rel="import" href="../../../../mixins/common-mixin.html">
<link rel="import" href="../../../../mixins/event-helper-mixin.html">
<link rel="import" href="../../../partners/mixins/staff-members-data-mixin.html">

<link rel="import" href="components/agreement-amendments.html">
<link rel="import" href="components/generate-PCA-dialog.html">

<dom-module id="agreement-details">
  <template strip-whitespace>

    <style include="page-common-styles grid-layout-styles shared-styles required-field-starred-styles buttons-styles">
      :host {
        @apply --layout-vertical;
        width: 100%;
        --esmm-list-wrapper: {
          max-height: 400px;
        }
      }

      .type-warning {
        width: 100%;
        color: var(--warning-color);
        @apply --layout-self-center;
        @apply --layout-vertical;
      }

      paper-input,
      etools-date-input {
        width: 100%;
      }

      .generate-pca {
        /* TODO: change Generate PCA btn template - this should be applied on etools-form-element-wrapper with width auto */
        border-right: 1px solid var(--dark-divider-color);
        margin-right: 24px;
      }

      .generate-pca[hidden] + .col {
        padding-left: 0;
      }
    </style>

    <etools-content-panel class="content-section" panel-title="Agreement Details">

      <div class="row-h flex-c b-border row-second-bg">
        <div class="col col-6">
          <!-- Agreement Type -->
          <etools-dropdown
              id="agreementType"
              label="Agreement Type"
              placeholder="&#8212;"
              options="[[agreementTypes]]"
              selected="{{agreement.agreement_type}}"
              dynamic-align
              hide-search
              readonly$="[[_isAgreementTypeReadonly(agreement)]]"
              auto-validate
              error-message="Please select agreement type"
              required>
          </etools-dropdown>
        </div>
        <div class="col col-3">
          <!-- Reference Number -->
          <paper-input label="Reference Number"
                       value="[[agreement.agreement_number]]"
                       title$="[[agreement.agreement_number]]"
                       hidden$="[[!agreement.id]]"
                       placeholder="&#8212;"
                       readonly>
          </paper-input>
        </div>
        <template is="dom-if" if="[[_typeMatches(agreement.agreement_type, 'PCA')]]">
          <div class="col col-3">
            <etools-form-element-wrapper label="Duration (Signed Date - CP End Date)" hidden$="[[!agreement.id]]">
              <span>[[prettyDate(agreement.start)]] &#8212; [[prettyDate(agreement.end)]]</span>
            </etools-form-element-wrapper>
          </div>
        </template>
      </div>

      <div class="row-h flex-c">
        <div class="col col-6">
          <!-- Partner name -->
          <etools-dropdown
              id="partner"
              label="Partner Name"
              placeholder="&#8212;"
              options="[[partnersDropdownData]]"
              selected="{{agreement.partner}}"
              dynamic-align
              hidden$="[[!agreement.permissions.edit.partner]]"
              auto-validate
              error-message="Please select a partner"
              required
              avoid-header-overlapping-dropdown>
          </etools-dropdown>
          <etools-form-element-wrapper label="Partner Name" required$="[[agreement.permissions.required.partner]]"
                                       hidden$="[[agreement.permissions.edit.partner]]">
            <span>[[agreement.partner_name]]</span>
          </etools-form-element-wrapper>
        </div>
        <template is="dom-if" if="[[_typeMatches(agreement.agreement_type, 'MOU')]]" restamp>
          <div class="col col-3">
            <etools-date-input id="startDateField"
                               label="Start date"
                               value="{{agreement.start}}"
                               readonly$="[[!agreement.permissions.edit.start]]"
                               no-init show-clear-btn
                               required$="[[agreement.permissions.required.start]]">
            </etools-date-input>
          </div>
          <div class="col col-3">
            <etools-date-input id="endDateField"
                               label="End date"
                               value="{{agreement.end}}"
                               readonly$="[[!agreement.permissions.edit.end]]"
                               no-init show-clear-btn
                               required$="[[agreement.permissions.required.end]]">
            </etools-date-input>
          </div>
        </template>
        <template is="dom-if" if="[[_typeMatches(agreement.agreement_type, 'PCA')]]" restamp>
          <div class="col col-6">
            <etools-dropdown
                id="cpStructure"
                label="CP Structure"
                placeholder="&#8212;"
                options="[[cpStructureOptions]]"
                option-value="id"
                option-label="name"
                hide-search
                selected="{{agreement.country_programme}}"
                readonly$="[[!agreement.permissions.edit.country_programme]]"
                error-message="Please select CP Structure"
                required$="[[agreement.permissions.required.country_programme]]">
            </etools-dropdown>
          </div>
        </template>
      </div>

      <div hidden$="[[_typeMatches(agreement.agreement_type, 'SSFA')]]">
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed By Partner -->
            <etools-dropdown
                id="signedByPartner"
                label="Signed By Partner"
                placeholder="&#8212;"
                options="[[staffMembers]]"
                option-value="id"
                option-label="name"
                selected="{{agreement.partner_manager}}"
                dynamic-align
                auto-validate
                error-message="Please select Signed By Partner"
                hidden$="[[!agreement.permissions.edit.partner_manager]]"
                required$="[[_isSignedByFieldRequired(agreement.permissions.required.partner_manager, agreement.signed_by_partner_date, agreement)]]"
                avoid-header-overlapping-dropdown>
            </etools-dropdown>
            <etools-form-element-wrapper label="Partner Name"
                                         required$="[[agreement.permissions.required.partner_manager]]"
                                         hidden$="[[agreement.permissions.edit.partner_manager]]">
              <span>[[_getReadonlySignedByPartner(staffMembers, agreement.partner_manager)]]</span>
            </etools-form-element-wrapper>
          </div>
          <div class="col col-3">
            <!-- Signed By Partner Date -->
            <etools-date-input id="signedByPartnerDateField"
                               label="Signed By Partner Date"
                               value="{{agreement.signed_by_partner_date}}"
                               no-init show-clear-btn
                               auto-validate
                               readonly$="[[!agreement.permissions.edit.signed_by_partner_date]]"
                               error-message="Please select Signed By Partner Date"
                               required$="[[_isSignedByFieldRequired(agreement.permissions.required.signed_by_partner_date, agreement.partner_manager, agreement)]]">
            </etools-date-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <!-- Signed By UNICEF -->
            <etools-dropdown
                id="signedByUnicef"
                label="Signed By UNICEF"
                placeholder="&#8212;"
                options="[[unicefSeniorStaff]]"
                option-value="id"
                option-label="name"
                selected="{{agreement.signed_by}}"
                dynamic-align
                error-message="Please select Signed By UNICEF"
                readonly$="[[!agreement.permissions.edit.signed_by]]"
                auto-validate
                required$="[[_isSignedByFieldRequired(agreement.permissions.required.signed_by, agreement.signed_by_unicef_date, agreement)]]"
                avoid-header-overlapping-dropdown>
            </etools-dropdown>
          </div>

          <div class="col col-3">
            <!-- Signed By UNICEF Date -->
            <etools-date-input id="signedByUnicefDateField"
                               label="Signed By UNICEF Date"
                               value="{{agreement.signed_by_unicef_date}}"
                               readonly$="[[!agreement.permissions.edit.signed_by_unicef_date]]"
                               no-init show-clear-btn auto-validate
                               error-message="Please select Signed By UNICEF Date"
                               required$="[[_isSignedByFieldRequired(agreement.permissions.required.signed_by_unicef_date, agreement.signed_by, agreement)]]">
            </etools-date-input>
          </div>
        </div>
      </div>

      <div class="row-h flex-c" hidden$="[[_typeMatches(agreement.agreement_type, 'MOU')]]">
        <!-- Partner Authorized Officers (partner staff members) -->
        <etools-dropdown-multi id="officers"
                               label="Authorized Officers"
                               placeholder="&#8212;"
                               options="[[_getAvailableAuthOfficers(staffMembers, agreement.authorized_officers)]]"
                               option-value="id"
                               option-label="name"
                               selected-values="{{authorizedOfficers}}"
                               hidden$="[[!_allowAuthorizedOfficersEditing(agreement.status, editMode, enableEditForAuthorizedOfficers)]]"
                               error-message="Please enter Partner Authorized Officer(s)"
                               required$="[[agreement.permissions.required.authorized_officers]]"
                               auto-validate$="[[enableEditForAuthorizedOfficers]]">
        </etools-dropdown-multi>
        <etools-form-element-wrapper label="Authorized Officers"
                                     required$="[[agreement.permissions.required.authorized_officers]]"
                                     hidden$="[[_allowAuthorizedOfficersEditing(agreement.status, editMode, enableEditForAuthorizedOfficers)]]">
          <span>[[_getReadonlyAuthorizedOfficers(agreement)]]</span>
        </etools-form-element-wrapper>
      </div>

      <div class$="row-h flex-c [[_getTBorderClassIfApplicable(agreement.agreement_type)]]">
        <div class="generate-pca col col-3"
             hidden$="[[!_showGeneratePcaBtn(agreement.agreement_type, isNewAgreement)]]">
          <paper-input-container
              class="form-field-wrapper secondary-btn-wrapper"
              always-float-label>
            <!-- Generate PCA -->
            <label slot="label" aria-hidden="true">PCA Agreement to Sign</label>
            <paper-button slot="input" class="paper-input-input secondary-btn" id="generateMyPca"
                          on-tap="_openGeneratePCADialog">
              <iron-icon icon="refresh"></iron-icon>
              GENERATE
            </paper-button>
          </paper-input-container>
        </div>
        <div class="generate-pca col col-3"
             hidden="[[!_showGeneratePcaWarning(agreement.agreement_type, isNewAgreement)]]">
          <span class="type-warning"> You have to save the agreement before you can generate a PCA template </span>
        </div>
        <div class="col col-9" hidden$="[[_typeMatches(agreement.agreement_type, 'SSFA')]]">
          <etools-single-file
              file="{{agreement.attached_agreement}}"
              internal-file="[[agreement.attached_agreement_file]]"
              label="Signed Agreement"
              accept=".doc,.docx,.pdf,.jpg,.png"
              hide-delete-btn="[[_hideDeleteBtn(agreement.status, agreement.attached_agreement)]]"
              readonly$="[[!agreement.permissions.edit.attached_agreement]]"
              required$="[[agreement.permissions.required.attached_agreement]]">
          </etools-single-file>
        </div>
      </div>
    </etools-content-panel>

    <template is="dom-if" if="[[_showAmendments(agreement.agreement_type, agreement.status)]]">
      <etools-content-panel class="content-section" panel-title="Amendments ([[agreement.amendments.length]])">
        <agreement-amendments id="agreementAmendments"
                              data-items="{{agreement.amendments}}"
                              agreement-type="[[agreement.agreement_type]]"
                              edit-mode$="[[agreement.permissions.edit.amendments]]"
                              on-unlock-authorized-officers="_unlockAuthorizedOfficers"
                              on-lock-authorized-officers="_lockAuthorizedOfficersAndRestoreSelection">
        </agreement-amendments>
      </etools-content-panel>
    </template>

  </template>

  <script>
    'use strict';
    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsPmpApp.Mixins.MissingDropdownOptions
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixin EtoolsPmpApp.Mixins.StaffMembersData
     * @appliesMixin EtoolsPmpApp.Mixins.Common
     */
    const AgreementDetailsRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsPmpApp.Mixins.MissingDropdownOptions,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.StaffMembersData,
      EtoolsPmpApp.Mixins.Common
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin AgreementDetailsRequiredMixins
     */
    class AgreementDetails extends AgreementDetailsRequiredMixins {
      static get is() {
        return 'agreement-details';
      }

      static get properties() {
        return {
          agreement: {
            type: Object,
            notify: true,
            observer: '_agreementChanged'
          },
          editMode: {
            type: Boolean,
            value: false,
            observer: '_editModeChanged'
          },
          isNewAgreement: {
            type: Boolean,
            value: false,
            observer: '_isNewAgreementChanged'
          },
          partnersDropdownData: {
            type: Array,
            value: [],
            statePath: 'partnersDropdownData'
          },
          agreementTypes: {
            type: Array,
            value: [],
            statePath: 'agreementTypes'
          },
          staffMembers: {
            type: Array,
            value: []
          },
          authorizedOfficers: {
            type: Array,
            value: [],
            notify: true
          },
          unicefSeniorStaff: {
            type: Array,
            value: [],
            statePath: 'signedByUnicefUsers'
          },
          originalAgreementData: {
            type: Object,
            value: null
          },
          amendments: {
            type: Array,
            value: []
          },
          oldSelectedPartnerId: Number,
          countryProgrammes: {
            type: Array,
            value: [],
            statePath: 'countryProgrammes'
          },
          cpStructureOptions: {
            type: Object,
            value: []
          },
          enableEditForAuthorizedOfficers: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_agreementFieldChanged(agreement.*)',
          '_partnerChanged(agreement.partner)',
          '_countryProgrammesChanged(countryProgrammes, agreement)'
        ];
      }

      ready() {
        super.ready();
        this.generatePCADialog = document.createElement('generate-pca-dialog');
        this.generatePCADialog.setAttribute('id', 'generatePCADialog');
        document.querySelector('body').appendChild(this.generatePCADialog);
      }

      connectedCallback() {
        super.connectedCallback();

        // Disable loading message for details tab elements load,
        // triggered by parent element on stamp
        this.fireEvent('global-loading', {active: false, loadingSource: 'ag-page'});
        this.fireEvent('tab-content-attached');

        this.setDropdownMissingOptionsAjaxDetails(this.$.signedByUnicef, 'unicefUsers', {dropdown: true});
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        if (this.generatePCADialog) {
          document.querySelector('body').removeChild(this.generatePCADialog);
        }
      }

      _isSignedByFieldRequired(permission, relatedSignedByField) {
        return (permission || !!relatedSignedByField);
      }

      _getTBorderClassIfApplicable(agreementType) {
        return agreementType !== 'SSFA'? 't-border' : '';
      }

      // Editing Agreement Type is allowed only if Agreement is new/unsaved
      _isAgreementTypeReadonly() {
        return (this.agreement && this.agreement.id);
      }

      // Refer to unicef/etools-issues#232:
      // For Draft Status, only Change option is available. No delete option is available in Draft.
      _hideDeleteBtn() {
        return this._isDraft() && this.agreement && this.agreement.attached_agreement_file;
      }

      _isNewAgreementChanged(isNew) {
        this._setDraftStatus(this.editMode, isNew);
      }

      _editModeChanged(editMode) {
        if (typeof editMode !== 'undefined') {
          this._setDraftStatus(editMode, this.isNewAgreement);
        }
      }

      _setDraftStatus(editMode, isNewAgreement) {
        if (editMode && isNewAgreement && this.agreement && !this._isDraft()) {
          this.set('agreement.status', '');
        }
      }

      _showAmendments(type, status) {
        return type === 'PCA' && !this._isDraft();
      }

      // When agreement data is changed we need to check and prepare attached agreement file and
      // display amendments if needed
      _agreementChanged(agreement) {
        if (this.generatePCADialog) {
          this.generatePCADialog.agreementId = agreement.id;
        }

        if (typeof agreement === 'object' && agreement !== null && agreement.id) {
          // prevent wrong new agreement value
          this.set('isNewAgreement', false);

          this.set('oldSelectedPartnerId', agreement.partner);

          // keep a copy of the agreement before changes are made and use it later to save only the changes
          this.set('originalAgreementData', JSON.parse(JSON.stringify(agreement)));

          this.fieldValidationReset('#cpStructure');
          this.set('enableEditForAuthorizedOfficers', false);

          this.resetAttachedAgreementElem(agreement);
          this._initAuthorizedOfficers(agreement.authorized_officers);
        } else {
          this.set('agreement.attached_agreement', {});
          this.set('agreement.attached_agreement_file', '');
          // new agreement, update status to draft and reset fields
          this._setDraftStatus(this.editMode, this.isNewAgreement);
          this._resetDropdown('#partner');
          this._resetDropdown('#agreementType');
        }
        this.fireEvent('global-loading', {active: false, loadingSource: 'ag-data'});
      }

      resetAttachedAgreementElem(agreement) {
        // forces etools-single-file to redraw the element
        if (!agreement.attached_agreement) {
          this.set('agreement.attached_agreement', {});
        }
        if (!agreement.attached_agreement_file) {
          this.set('agreement.attached_agreement_file', '');
        }
      }

      _resetDropdown(selector) {
        let field = this.fieldValidationReset(selector);
        if (field) {
          field.set('selected', null);
        }
      }

      // Verify if agreement status is 'draft'
      _isDraft() {
        return this.isNewAgreement || (this.agreement && this.agreement.status === 'draft');
      }

      _allowEdit(agreementStatus, editMode) {
        editMode = editMode || this.editMode;
        if (!editMode) {
          return false;
        }
        return !(this.agreement && this.agreement.id > 0) || (agreementStatus && this._isDraft());
      }

      _showGeneratePcaBtn(type, isNewAgreement) {
        return type === 'PCA' && this._isDraft() && !isNewAgreement;
      }

      _showGeneratePcaWarning(type, isNewAgreement) {
        return type === 'PCA' && isNewAgreement;
      }

      _partnerChanged(currentPartnerId) {
        if (typeof currentPartnerId === 'undefined') {
          return;
        }

        this.set('staffMembers', []);
        if (this.agreement && currentPartnerId !== this.oldSelectedPartnerId) {
          // partner not set or changed, reset related fields
          this.set('agreement.partner_manager', null);
          this.set('authorizedOfficers', []);
          this.set('agreement.authorized_officers', []);
          this.set('oldSelectedPartnerId', currentPartnerId);
        }
        this.getPartnerStaffMembers(currentPartnerId);
      }

      // Validate agreements fields on change
      _agreementFieldChanged(agreementProperty) {
        if (typeof agreementProperty === 'undefined') {
          return;
        }
        // check edit permissions and continue only if true; no validations in view mode
        if (this.agreement && !this._allowEdit(this.agreement.status)) {
          return;
        }

        if (agreementProperty && agreementProperty.path === 'agreement.agreement_type') {
          if (agreementProperty.value !== 'PCA') {
            // reset country_programme as it's available only for PCA type
            this.set('agreement.country_programme', null);
            // reset start and end date
            // TODO: decide if we reset start and end dates when type is changed
            // this.set('agreement.start', null);
            // this.set('agreement.end', null);
          } else {
            if (this.cpStructureOptions instanceof Array && this.cpStructureOptions.length === 1) {
              this.set('agreement.country_programme', this.cpStructureOptions[0].id);
            }
          }
        }
      }

      _getAvailableAuthOfficers(staffMembers, agreementAuthorizedOfficers) {
        if (staffMembers instanceof Array && staffMembers.length) {
          return staffMembers;
        }
        if (agreementAuthorizedOfficers instanceof Array && agreementAuthorizedOfficers.length) {
          return agreementAuthorizedOfficers.map(function(staffMember) {
            return {
              id: staffMember.id,
              name: staffMember.first_name + ' ' + staffMember.last_name
            };
          });
        }
        return [];
      }

      _getReadonlySignedByPartner(staffMembers, selectedId) {
        if (!this.agreement) {
          return '';
        }
        if (this.agreement.partner_signatory) {
          return this.agreement.partner_signatory.first_name + ' ' + this.agreement.partner_signatory.last_name;
        } else if (this.staffMembers && this.staffMembers.length) {
          let selectedPartner = this.staffMembers.filter(function(s) {
            return parseInt(s.id) === parseInt(selectedId);
          });
          if (selectedPartner && selectedPartner.length) {
            return selectedPartner[0];
          }
        }
        return '';
      }

      _getReadonlyAuthorizedOfficers(agreement) {
        if (!agreement.authorized_officers || !agreement.authorized_officers.length) {
          return '';
        }
        let names = agreement.authorized_officers.map(function(officer) {
          return officer.first_name + ' ' + officer.last_name;
        });
        return names.join(' | ');
      }

      // Check if agreement type is expected type
      _typeMatches(agreementType, expectedType) {
        return agreementType === expectedType;
      }

      // Filter Country programmes:
      //   - omit any CP where the end date is in the past
      //   - omit any CP with indicator 99 as the last two digits of WBS (e.g. 3930/A0/99)
      //   - omit any CP that has an indicator other than “A0” after the first slash (e.g. omit 2490/PC/07)
      _filterCountryProgrammesForAgreements(countryProgrammes) {
        return countryProgrammes.filter(function(cp) {
          return (cp.active || cp.future);
        });
      }

      _openGeneratePCADialog() {
        if (!this.generatePCADialog.agreementId) {
          this.generatePCADialog.set('agreementId', this.agreement.id);
        }
        this.generatePCADialog.open();
      }

      // Filter CP to obtain agreement CP Structure options.
      // If the result is just one option then set it as selected by default, make dropdown readonly
      _countryProgrammesChanged(cp, agreement) {
        if (typeof cp === 'undefined' || typeof agreement === 'undefined') {
          return;
        }
        let cpStructure = [];
        let isEditableField = agreement.permissions.edit.country_programme;
        if (agreement && !isEditableField) {
          // old agreement / agreement not in 'draft' status
          cpStructure = cp;
        } else {
          // editable agreement
          cpStructure = this._filterCountryProgrammesForAgreements(cp);
        }

        this.set('cpStructureOptions', cpStructure);
        let cpStructureIsOld = this._hasNotAvailableCpAssigned(this.agreement.country_programme);
        if (cpStructure.length === 1 && !cpStructureIsOld) {
          this.set('agreement.country_programme', cpStructure[0].id);
        }
        if (cpStructureIsOld && isEditableField && this.agreement && this.agreement.agreement_type === 'PCA') {
          // let the user know cp structure is expired/old
          this.fireEvent('toast', {text: 'This agreement has an old/expired CP Structure!', showCloseBtn: true});
          this.set('agreement.country_programme', null);
        }
      }

      _initAuthorizedOfficers(authOfficers) {
        if (authOfficers instanceof Array && authOfficers.length) {
          this.set('authorizedOfficers', authOfficers.map(function(authOfficer) {
            return authOfficer.id + '';
          }));
          return;
        }
        this.set('authorizedOfficers', []);
      }

      // trigger authorized officers field to be locked/unlocked
      _unlockAuthorizedOfficers(e) {
        e.stopImmediatePropagation();
        this.set('enableEditForAuthorizedOfficers', true);
      }

      // set authorized officers field readonly mode
      _allowAuthorizedOfficersEditing(agreementStatus, editMode, enableEditForAuthorizedOfficers) {
        if (!this.agreement) {
          return false;
        }
        if (!editMode) {
          // used has no edit permissions
          return false;
        }

        // canBeEdited = false - either field is locked or the user has no edit permissions;
        // not knowing exactly why is false we need to check user editMode first(first method lines)
        let canBeEdited = this.agreement.permissions.edit.authorized_officers;
        // if is locked (in signed status), enableEditForAuthorizedOfficers will make this field editable
        if (!canBeEdited && enableEditForAuthorizedOfficers) {
          // reset existing officers selection
          this.set('authorizedOfficers', []);
          return true;
        }
        return canBeEdited;
      }

      // trugger authorized officers field lock and restore initial value(if needed)
      _lockAuthorizedOfficersAndRestoreSelection(e) {
        e.stopImmediatePropagation();
        if (!this.enableEditForAuthorizedOfficers) {
          // stop; enableEditForAuthorizedOfficers already set to false
          return;
        }
        // restore officers selection (because you do not have any new amendment for changing this field)
        this._initAuthorizedOfficers(this.originalAgreementData.authorized_officers);
        this.set('enableEditForAuthorizedOfficers', false);
      }

      _hasNotAvailableCpAssigned(agCp) {
        if (agCp > 0 && this.cpStructureOptions instanceof Array) {
          let cp = this.cpStructureOptions.find(function(cp) {
            return parseInt(cp.id, 10) === parseInt(agCp, 10);
          });
          if (!cp) {
            return true;
          }
        }
        return false;
      }

      // Validate agreement fields
      _validateAgreement() {
        let valid = true;
        let reqFieldsSelectors = ['#partner', '#agreementType', '#officers'];
        if (this.agreement.agreement_type === 'PCA') {
          reqFieldsSelectors.push('#cpStructure');
          reqFieldsSelectors.push('#agreementAmendments');
        }
        if (this.agreement.agreement_type !== 'SSFA') {
          if (!this._validateSignedByFields()) {
            valid = false;
          }
        }
        reqFieldsSelectors.forEach(function(fSelector) {
          let field = this.shadowRoot.querySelector(fSelector);
          if (field && !field.validate()) {
            valid = false;
          }
        }.bind(this));
        return valid;
      }

      _validateSignedByFields() {
        let valid = true;
        let signedByFields = ['#signedByPartner', '#signedByPartnerDateField',
          '#signedByUnicef', '#signedByUnicefDateField'];
        signedByFields.forEach(function(selector) {
          let field = this.shadowRoot.querySelector(selector);
          if (field && !field.validate()) {
            valid = false;
          }
        }.bind(this));
        return valid;
      }
    }

    window.customElements.define(AgreementDetails.is, AgreementDetails);
  </script>
</dom-module>
