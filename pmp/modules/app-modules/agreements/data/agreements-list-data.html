<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../../bower_components/etools-behaviors/etools-logs-mixin.html">

<link rel="import" href="../../../scripts/lodash.html">

<link rel="import" href="../../../config/dexie-db-config.html">
<link rel="import" href="../../../mixins/list-data-mixin.html">
<link rel="import" href="../../../redux/etools-data-redux-store.html">
<link rel="import" href="../../../mixins/event-helper-mixin.html">

<dom-module id="agreements-list-data">

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.ListData
     * @appliesMixin EtoolsPmpApp.Mixins.EventHelper
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     */
    const AgreementsListDataRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.ListData,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.EventHelper
    ], Polymer.Element);

    /**
     * @polymer
     * @customElement
     * @appliesMixin AgreementsListDataRequiredMixins
     */
    class AgreementsListData extends AgreementsListDataRequiredMixins {

      static get is() {
        return 'agreements-list-data';
      }

      static get properties() {
        return {
          endpointName: {
            type: String,
            value: 'agreements'
          },

          dataLoadedEventName: {
            type: String,
            value: 'agreements-loaded'
          },

          filteredAgreements: {
            type: Array,
            readOnly: true,
            notify: true
          },

          totalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },

          currentQuery: {
            type: Object,
            value: null
          }
        };
      }

      static get actions() {
        return {
          setAgreements: function(agreements) {
            return {
              type: 'SET_AGREEMENTS',
              agreementsList: agreements
            };
          }
        };
      }

      _handleMyResponse(res) {
        this._handleResponse(res);
        this.dispatch('setAgreements', res);
      }

      query(field, order, searchString, agreementTypes,
            agreementStatuses, selectedPartnerNames, startDate,
            endDate, cpStructures, pageNumber, pageSize, showQueryLoading) {
        // If an active query transaction exists, abort it and start
        // a new one
        if (this.currentQuery) {
          this.currentQuery.abort();
        }

        let self = this;

        if (showQueryLoading) {
          this.fireEvent('global-loading', {
            message: 'Loading...',
            active: true,
            loadingSource: 'ag-list'
          });
        }
        let agreementsDexieTable = EtoolsPmpApp.DexieDb.agreements;
        EtoolsPmpApp.DexieDb.transaction('r', agreementsDexieTable, function() {
          self.currentQuery = Dexie.currentTransaction;

          let queryResult = agreementsDexieTable;
          if (field) {
            // note: null values don't appear in result set of sort
            queryResult = queryResult.orderBy(field);
          }
          if (order === 'desc') {
            queryResult = queryResult.reverse();
          }

          queryResult = queryResult.filter(function(agreement) {
            if (selectedPartnerNames &&
                selectedPartnerNames.length &&
                !_.includes(selectedPartnerNames, agreement.partner_name)) {
              return false;
            }

            if (!_.isEmpty(agreementTypes) && agreementTypes.indexOf(agreement.agreement_type) === -1) {
              return false;
            }

            if (!_.isEmpty(agreementStatuses) && agreementStatuses.indexOf(agreement.status) === -1) {
              return false;
            }

            if (startDate && startDate.length &&
                (!agreement.start || !moment.utc(agreement.start).isAfter(moment.utc(startDate)))) {
              return false;
            }

            if (endDate && endDate.length &&
                (!agreement.end || !moment.utc(agreement.end).isBefore(moment.utc(endDate)))) {
              return false;
            }

            if (!_.isEmpty(cpStructures) && cpStructures.indexOf(agreement.country_programme) === -1) {
              return false;
            }

            if (searchString && searchString.length &&
                agreement.agreement_number.toLowerCase().indexOf(searchString) < 0 &&
                agreement.partner_name.toLowerCase().indexOf(searchString) < 0) {
              return false;
            }

            return true;
          });

          // This special Dexie function allows the work of counting
          // the number of query results to be done in a parallel process,
          // instead of blocking the main query
          Dexie.ignoreTransaction(function() {
            queryResult.count(function(count) {
              self._setTotalResults(count);
            });
          });

          return queryResult
              .offset((pageNumber - 1) * pageSize)
              .limit(pageSize)
              .toArray();
        }).then(function(result) {
          self._setFilteredAgreements(result);
          self.fireEvent('global-loading', {active: false, loadingSource: 'ag-list'});
        }).catch(function(error) {
          self.logError('Error querying agreements: ', 'agreements-list-data', error, true);
          self.fireEvent('global-loading', {active: false, loadingSource: 'ag-list'});
        });
      }
    }

    window.customElements.define(AgreementsListData.is, AgreementsListData);
  </script>
</dom-module>
