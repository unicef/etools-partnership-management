<link rel="import" href="../../modules/config/app-constants.html">
<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};

  /**
   * @polymer
   * @mixinFunction
   * @appliesMixin EtoolsPmpApp.Mixins.Constants
   */
  EtoolsPmpApp.Mixins.Pagination = Polymer.dedupingMixin(
      baseClass => class extends EtoolsPmpApp.Mixins.Constants(baseClass) {
        static get properties() {
          return {
            paginator: {
              type: Object,
              value: function() {
                return {
                  page: 1,
                  page_size: 10,
                  count: null,
                  visible_range: []
                };
              },
              notify: true
            }
          };
        }

        static get observers() {
          return [
            '_pageInsidePaginationRange(paginator.page, paginator.count)',
            'resetPageNumber(paginator.page_size)'
          ];
        }

        pageSizeChanged(e) {
          this.resetPageNumber();
          this.setPageSize(parseInt(e.detail.value, 10));
        }

        pageNumberChanged(e) {
          this.setPageNumber(parseInt(e.detail.value, 10));
        }

        getRequestPaginationParams() {
          return {
            page: this.paginator.page,
            page_size: this.paginator.page_size
          };
        }

        updatePaginatorTotalResults(reqResponse) {
          if (reqResponse && reqResponse.count) {
            let count = parseInt(reqResponse.count, 10);
            if (!isNaN(count)) {
              this.set('paginator.count', count);
              return;
            }
          }
          this.set('paginator.count', 0);
        }

        setPageSize(size) {
          this.set('paginator.page_size', size);
        }

        setPageNumber(page) {
          this.set('paginator.page', page);
        }

        resetPageNumber() {
          this.setPageNumber(1);
        }

        setPaginationDataFromUrlParams(urlParams) {
          this.setPageNumber(urlParams.page ? parseInt(urlParams.page) : 1);
          this.setPageSize(urlParams.size ? parseInt(urlParams.size) : this.DEFAULT_LIST_SIZE);
        }

        _pageInsidePaginationRange(page, totalResults) {
          if (page < 1) {
            this.resetPageNumber();
          }
          let total = parseInt(totalResults, 10);
          if (isNaN(total)) {
            return;
          }

          let lastPageNr = this._getLastPageNr(this.paginator.page_size, total);
          if (page > lastPageNr) {
            // page is bigger than last page number (possible by modifying url page param)
            // set page to last available page
            this.setPageNumber(lastPageNr);
          }
        }

        _getLastPageNr(pageSize, total) {
          return pageSize < total ? (Math.ceil(total / pageSize)) : 1;
        }
      });
</script>
