<link rel="import" href="ajax-errors-parser-mixin.html">
<script>
    /* @namespace EtoolsPmpApp */
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};
   /*
  * @polymer
  * @mixinFunction
  */
  EtoolsPmpApp.Mixins.AjaxServerErrorsImpl  = (baseClass) => class extends EtoolsPmpApp.Mixins.AjaxErrorsParser(baseClass) {

    static get properties() {
      return {
        serverErrors: {
          type: Array,
          notify: true
        },
        options: Object,
        useToastEvent: {
          type: Boolean,
          value: true
        },
        errorEventName: {
          value: null,
          observer: '_errorEventNameChange'
        },
        ajaxLoadingMsgSource: {
          type: String,
          value: ''
        },
      };
    }

    handleErrorResponse(response, ajaxMethod, redirectOn404) {
      if (redirectOn404 && response.status === 404) {
        this.dispatchEvent(new CustomEvent('404', {bubbles: true, composed: true}));
        return;
      }

      let eventPayload = {
        active: false,
        loadingSource: !!this.ajaxLoadingMsgSource ? this.ajaxLoadingMsgSource : null
      };
      this.dispatchEvent(new CustomEvent('global-loading', {detail: eventPayload, bubbles: true, composed: true}));

      let errors = this.tryGetResponseError(response);

      let errorMessage = this.globalMessage;

      if (!ajaxMethod) {
        ajaxMethod = 'GET';
      }

      if (['POST', 'PATCH', 'DELETE'].indexOf(ajaxMethod) > -1) {
        this.set('serverErrors', this._getErrorsArray(errors, this.useToastEvent));
      }
      this.serverErrors = this.serverErrors ? this.serverErrors : [];
      if (this.useToastEvent) {
        if (this.serverErrors.length > 1) {
          errorMessage = this.serverErrors.join('\n');
        }
        let eventPayload = {text: errorMessage, showCloseBtn: true};
        this.dispatchEvent(new CustomEvent('toast', {detail: eventPayload, bubbles: true, composed: true}));
      } else {
        if (this.serverErrors.length === 0) {
          this._fireAjaxErrorEvent(errorMessage);
        } else {
          this._fireAjaxErrorEvent(this.serverErrors);
        }
      }
    }

    _fireAjaxErrorEvent(errors) {
      if (typeof this.errorEventName === 'string' && this.errorEventName !== '') {
        if (typeof errors === 'string') {
          errors = [errors];
        }
        this.dispatchEvent(new CustomEvent(this.errorEventName, {detail: errors, bubbles: true, composed: true}));
      }
    }

    _errorEventNameChange(eventName) {
      if (typeof eventName === 'string' && eventName !== '') {
        // disable toasts error notifications if eventName is given
        this.set('useToastEvent', false);
      }
    }

  };

</script>
