<link rel="import" href="../endpoints/endpoints-mixin.html"/>
<link rel="import" href="ajax-server-errors-mixin.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-mixin.html">
<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};
   /*
  * @polymer
  * @mixinFunction
  * @appliesMixin EtoolsAjaxRequestMixin
  * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
  * @appliesMixin EtoolsPmpApp.Mixins.AjaxServerErrors
  */
  EtoolsPmpApp.Mixins.ListData = (baseClass) => class extends EtoolsAjaxRequestMixin(EtoolsPmpApp.Mixins.Endpoints(EtoolsPmpApp.Mixins.AjaxServerErrors(baseClass))) {

    static get properties() {
      return {
        options: {
          type: Object,
          value: {
            endpoint: null,
            csrf: true
          },
        },
        data: {
          type: Array,
          readOnly: true,
          notify: true
        },
        globalMessage: {
          type: String,
          value: 'An error occurred while trying to fetch the data!'
        },
        fireDataLoaded: {
          type: Boolean,
          value: false
        },
        _refreshInterval: {
          type: Object,
          value: null
        }
      };
    }
    static get observers() {
      return [
       '_endpointChanged(options.endpoint)'
      ];
    }

    disconnectedCallback () {
      super.disconnectedCallback ();
      this._removeAutomaticDataRefreshLoop();
    }

    ready() {
      super.ready();
      this._elementReady();
    }

    _elementReady() {
      if (!this.endpointName) {
        console.warn('Please specify an endpointName property');
      } else {
        this.set('options.endpoint', this.getEndpoint(this.endpointName));
        this._requestListData();
      }
    }
    _requestListData() {
      let self = this;
      this.sendRequest(this.options)
        .then(function(resp) {
          self._handleMyResponse(resp);
        }).catch(function(error) {
          self.handleErrorResponse(error);
        });
    }
    // some children overwrite this function for custom data processing
    _handleMyResponse(res) {
      this._handleResponse(res);
    }

    _handleResponse(res) {
      this._setData(res);
      if (this.fireDataLoaded) {
        if (!this.dataLoadedEventName) {
          console.warn('Please specify data loaded event name(dataLoadedEventName property)');
        } else {
          this.dispatchEvent(new CustomEvent(this.dataLoadedEventName, {bubbles: true, composed: true }));
        }
      }
    }

    _endpointChanged(newEndpoint) {
      if (newEndpoint === undefined) {
        return;
      }
      if (newEndpoint && newEndpoint.hasOwnProperty('exp') && newEndpoint.exp > 0) {
          this._removeAutomaticDataRefreshLoop();
          this._setAutomaticDataRefreshLoop(newEndpoint);
        }
    }

    _removeAutomaticDataRefreshLoop() {
      if (this._refreshInterval !== null) {
        clearInterval(this._refreshInterval);
        this.set('_refreshInterval', null);
      }
    }

    _setAutomaticDataRefreshLoop(newEndpoint) {
      this._refreshInterval = setInterval(function() {
        this._requestListData();
      }.bind(this), newEndpoint.exp);
    }
  };

</script>
