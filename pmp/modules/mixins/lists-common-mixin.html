<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};

  /*
  * @polymer
  * @mixinFunction
  */
  EtoolsPmpApp.Mixins.ListsCommon = (baseClass) => class extends baseClass {
    static get properties() {
      return {
        q: {
          type: String,
          notify: true,
          observer: '_qChanged'
        },

        sortOrder: Object,

        debounceTime: {
          type: Number,
          value: 50
        },

        pageSize: {
          type: Number
        },

        pageNumber: {
          type: Number
        },

        active: Boolean,

        detailsOpened: Boolean,

        forceDataRefresh: {
          type: Boolean,
          value: false
        },

        requiredDataLoaded: {
          type: Boolean,
          value: false
        },

        defaultListsSize: {
          type: Number,
          value: 10
        },

        showQueryLoading: {
          type: Boolean,
          value: false
        },

        stampListData: Boolean,
        totalResults: Number
      };
    }

    // When the list data rows are changing check and close any details opened
    _listDataChanged(event) {
      var rows = this.$.list.querySelectorAll('etools-data-table-row');
      if (rows && rows.length) {
        for (var i = 0; i < rows.length; i++) {
          if (rows[i].detailsOpened) {
            rows[i].set('detailsOpened', false);
          }
        }
      }
    }

    _sortOrderChanged(e) {
      this.set('debounceTime', 150);
      this.set('sortOrder', e.detail);
    }

    _pageSizeChanged(e) {
      this.set('debounceTime', 200);
      this.set('pageNumber', 1);
      this.set('pageSize', parseInt(e.detail.value));
    }

    _pageNumberChanged(e) {
      this.set('debounceTime', 50);
      this.set('pageNumber', e.detail.value);
    }

    _qChanged(q) {
      if (q === undefined) {
        return;
      }
      this.set('debounceTime', 300);
      this.set('pageNumber', 1);
    }

    // List fade in fade out effect
    _listChanged(filteredList, oldFilteredList) {
      var classList = this.$.list.classList;
      if (filteredList instanceof Array && classList.contains('hidden')) {
        classList.remove('hidden');
      }
      if (typeof oldFilteredList === 'undefined') {
        this.set('showQueryLoading', true);
      }
    }

    /**
     * At page refresh Dexie DBs might be wiped out and the list
     *(filteredPartners,filteredAgreements etc) will be empty.
     * Because of this we need to refilter after list data is saved locally.
     * list-data-path holds the name of the list : filteredAgreements,filteredPartners, etc
     */
    _requiredDataHasBeenLoaded(event) {
      event.stopImmediatePropagation();

      var listDataPath = event.target.getAttribute('list-data-path');
      var list = this.get(listDataPath);

      if (typeof list === 'undefined' ||
          (Array.isArray(list) && list.length === 0)) {
        this.set('forceDataRefresh', true);
      }
      // recheck params to trigger agreements filtering
      this.set('initComplete', false); // TODO : 2 flags that seem very similar..great..
      this.set('requiredDataLoaded', true);
      this._init(this.active);
    }

    listAttachedCallback(active, loadingMsg, loadingSource) {
      this.set('stampListData', true);
      if (active) {
        this.dispatchEvent(new CustomEvent('global-loading'), {detail:{message: loadingMsg, active: true, loadingSource: loadingSource},
         bubbles: true, composed: true});
      } else {
        this.set('showQueryLoading', true);
      }
    }

    /**
     * Make sure you define _sortableFieldNames on *-list element properties level.
     * Ex for partners:
     * _sortableFieldNames: {
     *    type: Array,
     *    value: ['vendor_number', 'name']
     *  }
     */
    _isValidSortField(fieldName) {
      return this._sortableFieldNames instanceof Array && this._sortableFieldNames.indexOf(fieldName) > -1;
    }

    initSortFieldsValues(defaultSortData, urlQueryParamsSortData) {
      if (urlQueryParamsSortData) {
        let p = urlQueryParamsSortData.split('.');
        if (this._isValidSortField(p[0])) {
          return {field: p[0], direction: p[1]};
        }
      }
      return defaultSortData;
    }
  };
</script>
