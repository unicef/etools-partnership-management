<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/iron-validatable-behavior/iron-validatable-behavior.html">

<link rel="import" href="../../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../mixins/date-mixin.html">

<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="etools-date-input">

  <template>
    <style include="shared-styles">
      :host {
        width: 235px;
        @apply --etools-date-input;
      }

      /* TODO: Find a way to separate readonly CSS from shared-styles, and use it here,
      then include it in shared-styles(do not use shared-styles here) */
    </style>

    <paper-input id="dateInput"
                 label="[[label]]"
                 value="[[prettyDate(value)]]"
                 placeholder="[[placeholder]]"
                 on-down="openDatePicker"
                 data-selector="datePickerButton"
                 disabled$="[[disabled]]"
                 readonly$="[[readonly]]"
                 required$="[[required]]"
                 invalid$="[[invalid]]"
                 error-message="[[errorMessage]]">
      <span slot="prefix">
        <iron-icon icon="date-range" hidden$="[[!readonly]]"></iron-icon>
        <etools-datepicker-button id="datePickerButton"
                                  format="[[format]]"
                                  pretty-date="{{value}}"
                                  json-date="{{jsonValue}}"
                                  date="[[prepareDate(value)]]"
                                  is-disabled$="[[_disabledDatepicker(readonly, disabled)]]"
                                  hidden$="[[readonly]]"
                                  no-init="[[noInit]]"
                                  open="{{open}}"
                                  show-clear-btn="[[showClearBtn]]">
        </etools-datepicker-button>
      </span>
    </paper-input>
  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     */
    const EtoolsDateInputRequiredMixins = EtoolsPmpApp.Mixins.Date(Polymer.Element);
    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsPmpApp.Mixins.Date
     */
    class EtoolsDateInput extends
        Polymer.mixinBehaviors([Polymer.IronValidatableBehavior], EtoolsDateInputRequiredMixins) {

      static get is() {
        return 'etools-date-input';
      }

      static get properties() {
        return {
          label: String,
          value: {
            value: null,
            notify: true,
            observer: '_valueChanged'
          },
          jsonValue: {
            value: null,
            notify: true
          },
          placeholder: {
            type: String,
            value: 'â€”'
          },
          noInit: Boolean,
          showClearBtn: Boolean,
          readonly: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: '_readonlyStateChange'
          },
          disabled: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
          },
          required: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: '_requiredChange'
          },
          autoValidate: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          invalid: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          open: {
            type: Boolean,
            value: false,
            notify: true
          },
          errorMessage: {
            type: String,
            value: 'Please select a date'
          },
          format: {
            type: String,
            value: 'YYYY-MM-DD'
          },
          validator: String
        };
      }

      _readonlyStateChange(newValue, oldValue) {
        this._refreshStyles(newValue, oldValue);
      }

      _requiredChange(newValue, oldValue) {
        this._refreshStyles(newValue, oldValue);
      }

      _refreshStyles(newVal, oldVal) {
        if (newVal !== oldVal) {
          this.updateStyles();
        }
      }

      _disabledDatepicker(readonly, disabled) {
        return readonly || disabled;
      }

      _valueChanged(value) {
        if (this.autoValidate && value !== undefined) {
          this.validate();
        }
      }

      /**
       * overwrites default functionality from iron-input
       * @return {boolean}
       */
      validate() {
        let hasValidator = this.hasValidator();
        let valid = true;

        if (hasValidator) {
          // custom validator provided, use it to validate this field
          valid = Polymer.IronValidatableBehavior.validate.call(this, this.value);
        } else {
          // let paper-input use it's default validator
          valid = this.$.dateInput.validate();
        }

        this.set('invalid', !valid);
        return valid;
      }

      resetInvalidState() {
        this.set('invalid', false);
        // because `invalid` has one-way binding, the paper-input doesn't always follow the invalid flag
        // so to make sure, we have to set it manually
        this.$.dateInput.set('invalid', false);
      }

    }

    window.customElements.define(EtoolsDateInput.is, EtoolsDateInput);
  </script>
</dom-module>
