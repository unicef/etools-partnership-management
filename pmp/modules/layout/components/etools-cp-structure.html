<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/etools-dropdown/etools-dropdown.html">

<link rel="import" href="etools-form-element-wrapper.html">

<link rel="import" href="../../redux/etools-data-redux-store.html">
<link rel="import" href="../../scripts/lodash.html">

<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/required-field-styles.html">

<dom-module id="etools-cp-structure">
  <template>
    <style include="shared-styles required-field-starred-styles">
      :host {
        @apply --layout-horizontal;
      }

      *[hidden] {
        display: none !important;
      }

      #readonly-cp {
        width: auto;
      }

      .edit-exp-cp {
        @apply --layout-self-end;
        color: var(--dark-icon-color);
        margin-bottom: 4px;
        margin-left: 16px;
      }

      .edit-exp-cp[icon="cancel"] {
        color: var(--error-color);
        margin-bottom: 0;
      }

      #cpStructure {
        width: 100%;
      }
    </style>

    <etools-dropdown id="cpStructure"
                      label="CP Structure"
                      placeholder="&#8212;"
                      options="[[countryProgrammes]]"
                      option-value="id"
                      option-label="name"
                      selected="{{selectedCp}}"
                      hide-search
                      readonly$="[[!editMode]]"
                      required$="[[required]]"
                      auto-validate
                      error-message="Please select CP Structure">
    </etools-dropdown>

  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     */
    const EtoolsCpStructureRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore
    ], Polymer.Element);


    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsCpStructureRequiredMixins
     */
    class EtoolsCpStructure extends EtoolsCpStructureRequiredMixins {
      static get is() {
        return 'etools-cp-structure';
      }

      static get properties() {
        return {
          countryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          selectedCp: {
            type: Number,
            notify: true
          },
          /**
           * appModuleItem could be agreement or intervention
           */
          appModuleItem: {
            type: Object,
            value: null
          },
          /**
           * module will indicate the appmodule where cp selector is used;
           * could be agreements or intervention
           */
          module: {
            type: String
          },
          editMode: {
            type: Boolean,
            value: false
          },
          required: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_countryProgrammesChanged(countryProgrammes, appModuleItem)'
        ];
      }

      /**
       * Same filtering is applied to agreements and intervention.
       */
      _getAvailableCpOptions(countryProgrammes) {
        return countryProgrammes.filter(cp => cp.active || cp.future);
      }

      _getCurrentCountryProgramme(cpOptions) {
        if (_.isEmpty(cpOptions)) {
          return null;
        }

        if (cpOptions.length === 1) {
          // just one cp available
          return cpOptions[0];
        } else {
          // more than 1 cp available, use first one found that is active, not special and not future
          return cpOptions.find(cp => cp.active && !cp.future && !cp.special);
        }
      }

      setDefaultSelectedCpStructure() {
        if (_.isEmpty(this.countryProgrammes)) {
          return;
        }

        let currentCP = this._getCurrentCountryProgramme(this.countryProgrammes);

        this.set('selectedCp', currentCP ? currentCP.id : null);
      }

      _countryProgrammesChanged(countryProgrammes, appModuleItem) {
        this.cpInitDebouncer = Polymer.Debouncer.debounce(this.cpInitDebouncer,
            Polymer.Async.timeOut.after(10),
            () => {
              if (appModuleItem) {
                this._sortCPs();

                if (!this.selectedCp) {
                  this.setDefaultSelectedCpStructure();
                } else {
                  if (this._hasExpiredCpAssigned(this.selectedCp)) {
                    this.logWarn(this._getExpiredCPWarning());
                  }
                }
              }
            });
      }

      _sortCPs() {
        console.log('sorting');
        let sorted = _.orderBy(this.countryProgrammes, ['future', 'active', 'special'], ['desc', 'desc', 'asc']);
        let i;
        for (i = 0; i < sorted.length; i++) {
          this.countryProgrammes[i] = JSON.parse(JSON.stringify(sorted[i]));
        }
      }

      _hasExpiredCpAssigned(cpId) {
        if (cpId || !_.isEmpty(this.countryProgrammes)) {
          return false;
        }

        return this.countryProgrammes.some((cp) => {
          return parseInt(cp.id, 10) === parseInt(cpId, 10) && cp.expired;
        });

      }

      _getExpiredCPWarning() {
        let msg = '';
        switch (this.module) {
          case 'agreements':
            msg = `Agreement ${this.appModuleItem.agreement_number}`;
            break;
          case 'interventions':
            msg = `PD/SSFA ${this.appModuleItem.number}`;
            break;
        }
        return msg + ' has an old/expired CP Structure!';
      }

      resetCpDropdownInvalidState() {
        let cp = this._getCpStructureDropdown();
        if (cp) {
          cp.resetInvalidState();
        }
      }

      validate() {
        let cp = this._getCpStructureDropdown();
        return cp ? cp.validate() : true;
      }

      _getCpStructureDropdown() {
        return this.shadowRoot.querySelector('#cpStructure');
      }

    }

    window.customElements.define(EtoolsCpStructure.is, EtoolsCpStructure);
  </script>
</dom-module>
