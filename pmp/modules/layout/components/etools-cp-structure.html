<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/etools-dropdown/etools-dropdown.html">

<link rel="import" href="../../redux/etools-data-redux-store.html">
<link rel="import" href="../../scripts/lodash.html">

<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/required-field-styles.html">

<dom-module id="etools-cp-structure">
  <template>
    <style include="shared-styles required-field-starred-styles">
      :host {
        @apply --layout-horizontal;
      }

      *[hidden] {
        display: none !important;
      }

      #cpStructure {
        width: 100%;
      }
    </style>

    <etools-dropdown id="cpStructure"
                      label="CP Structure"
                      placeholder="&#8212;"
                      options="[[sortedCountryProgrammes]]"
                      option-value="id"
                      option-label="name"
                      selected="{{selectedCp}}"
                      hide-search
                      readonly$="[[!editMode]]"
                      required$="[[required]]"
                      auto-validate
                      error-message="Please select CP Structure">
    </etools-dropdown>

  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     */
    const EtoolsCpStructureRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin,
      EtoolsPmpApp.Mixins.EtoolsDataReduxStore
    ], Polymer.Element);


    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsCpStructureRequiredMixins
     */
    class EtoolsCpStructure extends EtoolsCpStructureRequiredMixins {
      static get is() {
        return 'etools-cp-structure';
      }

      static get properties() {
        return {
          countryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          sortedCountryProgrammes: {
            type: Array
          },
          selectedCp: {
            type: Number,
            notify: true
          },
          /**
           * appModuleItem could be agreement or intervention
           */
          appModuleItem: {
            type: Object,
            value: null
          },
          /**
           * module will indicate the appmodule where cp selector is used;
           * could be agreements or intervention
           */
          module: {
            type: String
          },
          editMode: {
            type: Boolean,
            value: false
          },
          required: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          '_countryProgrammesChanged(countryProgrammes, appModuleItem)'
        ];
      }

      _getCurrentCountryProgramme(cpOptions) {
        if (_.isEmpty(cpOptions)) {
          return null;
        }

        if (cpOptions.length === 1) {
          // just one cp available
          return cpOptions[0];
        } else {
          // more than 1 cp available, use first one found that is active, not special and not future
          return cpOptions.find(cp => cp.active && !cp.future && !cp.special);
        }
      }

      setDefaultSelectedCpStructure() {
        if (_.isEmpty(this.sortedCountryProgrammes)) {
          return;
        }

        let currentCP = this._getCurrentCountryProgramme(this.sortedCountryProgrammes);

        this.set('selectedCp', currentCP ? currentCP.id : null);
      }

      _countryProgrammesChanged(countryProgrammes, appModuleItem) {
        this.cpInitDebouncer = Polymer.Debouncer.debounce(this.cpInitDebouncer,
            Polymer.Async.timeOut.after(10),
            () => {
              if (appModuleItem) {
                this._prepareCpsForDisplay();

                if (!this.selectedCp) {
                  this.setDefaultSelectedCpStructure();
                } else {
                  if (this._hasExpiredCpAssigned(this.selectedCp)) {
                    this.logWarn(this._getExpiredCPWarning());
                  }
                }
              }
            });
      }

      _prepareCpsForDisplay() {
        let displayableCps = _.orderBy(this.countryProgrammes,
                                      ['future', 'active', 'special'],
                                      ['desc', 'desc', 'asc']);

        // NOTE: Do not remove this code yet, it might be restored in the future
        // if (!this.appModuleItem || !this.appModuleItem.id) {
        //   // On new intervention or agreement
        //   this._markExpiredCpsAsDisabled(displayableCps);
        // } else {
        //   this._resetExpiredCpsMarkedAsDisabled(displayableCps);
        // }

        this.sortedCountryProgrammes = displayableCps;
      }

      // _markExpiredCpsAsDisabled(sortedCps) {
      //   this._markExpiredCps(sortedCps, true);
      // }

      // _resetExpiredCpsMarkedAsDisabled(sortedCps) {
      //   this._markExpiredCps(sortedCps, false);
      // }

      // _markExpiredCps(sortedCps, disabled) {
      //   sortedCps.forEach((element) => {
      //     if (element.expired) {
      //       element.disableSelection = disabled;
      //     }
      //   });
      // }

      _hasExpiredCpAssigned(cpId) {
        if (cpId || !_.isEmpty(this.countryProgrammes)) {
          return false;
        }

        return this.countryProgrammes.some((cp) => {
          return parseInt(cp.id, 10) === parseInt(cpId, 10) && cp.expired;
        });

      }

      _getExpiredCPWarning() {
        let msg = '';
        switch (this.module) {
          case 'agreements':
            msg = `Agreement ${this.appModuleItem.agreement_number}`;
            break;
          case 'interventions':
            msg = `PD/SSFA ${this.appModuleItem.number}`;
            break;
        }
        return msg + ' has an old/expired CP Structure!';
      }

      resetCpDropdownInvalidState() {
        let cp = this._getCpStructureDropdown();
        if (cp) {
          cp.resetInvalidState();
        }
      }

      validate() {
        let cp = this._getCpStructureDropdown();
        return cp ? cp.validate() : true;
      }

      _getCpStructureDropdown() {
        return this.shadowRoot.querySelector('#cpStructure');
      }

    }

    window.customElements.define(EtoolsCpStructure.is, EtoolsCpStructure);
  </script>
</dom-module>
