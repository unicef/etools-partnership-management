<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-mixin.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../endpoints/endpoints-mixin.html">
<link rel="import" href="../redux/etools-data-redux-store.html">

<dom-module id="environment-flags">
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliedMixins EtoolsAjaxRequestMixin
     * @appliedMixins EtoolsLogsMixin
     * @appliedMixins EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliedMixins EtoolsPmpApp.Mixins.Endpoints
     */
    const EnvironmentFlagsRequiredMixins = EtoolsMixinFactory.combineMixins([EtoolsAjaxRequestMixin,
      EtoolsLogsMixin, EtoolsPmpApp.Mixins.EtoolsDataReduxStore, EtoolsPmpApp.Mixins.Endpoints], Polymer.Element);

    /**
     * This element will request and set the environment flags into redux store
     * @polymer
     * @customElement
     * @appliedMixin EnvironmentFlagsRequiredMixins
     */
    class EnvironmentFlags extends EnvironmentFlagsRequiredMixins {

      static get is() {
        return 'environment-flags';
      }

      static get actions() {
        return {
          setEnvFlags: function(envFlags) {
            let flags = envFlags.active_flags;
            let flagObject = {
              prp_mode_off: false
            };

            for (let key in flags) {
              let flag = flags[key];
              flagObject[flag] = true;
            }

            return {
              type: 'SET_ENV_FLAGS',
              envFlags: flagObject
            };
          }
        };
      }

      ready() {
        super.ready();
        let requestConfig = {
          endpoint: EtoolsPmpApp.Endpoints.environmentFlags
        };

        this.sendRequest(requestConfig).then((response) => {
          if (response) {
            this.dispatch('setEnvFlags', response);
          }
        }).catch((error) => {
          this.logError('Env flags request failed', null, error);
        });
      }

    }

    window.customElements.define(EnvironmentFlags.is, EnvironmentFlags);
  </script>
</dom-module>
