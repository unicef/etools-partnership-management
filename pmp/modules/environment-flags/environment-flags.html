<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-mixin.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../endpoints/endpoints-mixin.html">
<link rel="import" href="../redux/etools-data-redux-store.html">

<dom-module id="environment-flags">
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixins EtoolsAjaxRequestMixin
     * @appliesMixins EtoolsLogsMixin
     * @appliesMixins EtoolsPmpApp.Mixins.EtoolsDataReduxStore
     * @appliesMixins EtoolsPmpApp.Mixins.Endpoints
     */
    const EnvironmentFlagsRequiredMixins = EtoolsMixinFactory.combineMixins([
      EtoolsAjaxRequestMixin, EtoolsLogsMixin, EtoolsPmpApp.Mixins.EtoolsDataReduxStore,
      EtoolsPmpApp.Mixins.Endpoints
    ], Polymer.Element);

    /**
     * This element will request and set the environment flags into redux store
     * @polymer
     * @customElement
     * @appliesMixin EnvironmentFlagsRequiredMixins
     */
    class EnvironmentFlags extends EnvironmentFlagsRequiredMixins {

      static get is() {
        return 'environment-flags';
      }

      static get properties() {
        return {
          envFlagsDefaultValue: {
            type: Object,
            value: {
              prp_mode_off: true,
              prp_server_on: false
            }
          }
        };
      }

      static get actions() {
        return {
          processAndSetEnvFlags: function(envFlags) {
            let flags = envFlags.active_flags;
            let flagObject = {
              prp_mode_off: false
            };

            for (let key in flags) {
              let flag = flags[key];
              flagObject[flag] = true;
            }
            return {
              type: 'SET_ENV_FLAGS',
              envFlags: flagObject
            };
          },
          setEnvFlags: function(flagsObj) {
            return {
              type: 'SET_ENV_FLAGS',
              envFlags: flagsObj
            };
          }
        };
      }

      ready() {
        super.ready();
        let requestConfig = {
          endpoint: EtoolsPmpApp.Endpoints.environmentFlags
        };

        this.sendRequest(requestConfig).then((response) => {
          if (response) {
            this.dispatch('processAndSetEnvFlags', response);
          } else {
            this.dispatch('setEnvFlags', this.envFlagsDefaultValue);
          }
        }).catch((error) => {
          this.logError('Env flags request failed', null, error);
          this.dispatch('setEnvFlags', this.envFlagsDefaultValue);
        });
      }

    }

    window.customElements.define(EnvironmentFlags.is, EnvironmentFlags);
  </script>
</dom-module>
