<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-mixin.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-mixin-factory.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-page-refresh-mixin.html">

<link rel="import" href="../endpoints/endpoints-mixin.html">
<link rel="import" href="../redux/etools-data-redux-store.html">
<link rel="import" href="user-permissions-mixin.html">

<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Mixins || {};

  /**
    * @polymer
    * @mixinFunction
    * @appliesMixin EtoolsPageRefreshMixin
    * @appliesMixin EtoolsAjaxRequestMixin
    * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
    * @appliesMixin EtoolsPmpApp.Mixins.EtoolsDataReduxStore
    * @appliesMixin EtoolsPmpApp.Mixins.UserPermissions
    */

  EtoolsPmpApp.Mixins.UserData = (baseClass) =>
    class extends EtoolsPageRefreshMixin(
        EtoolsAjaxRequestMixin(
          EtoolsPmpApp.Mixins.Endpoints(
            EtoolsPmpApp.Mixins.EtoolsDataReduxStore(
              EtoolsPmpApp.Mixins.UserPermissions(baseClass)
            )
          )
        )
      ) {
    // TODO: find a way to clean up the above syntax

    static get properties() {
      return {
        endpointName: {
          type: String,
          value: 'myProfile'
        },
        user: {
          type: Object,
          readOnly: true,
          notify: true
        },
        userGroups: {
          type: Array,
          readOnly: true
        },
        permissions: {
          type: Object,
          readOnly: true,
          notify: true,
        }
      };
    }
    static get actions() {
      return {
        setCurrentUser: function(user) {
          return {
            type: 'SET_CURRENT_USER',
            user: user
          };
        }
      }
    }
    connectedCallback() {
      super.connectedCallback();
      this.sendRequest({
        endpoint: this.getEndpoint(this.endpointName)
      }).then((res) => {
        // TODO: check response to make sure it contains a valid user
        this._setUserData(res);
        this.dispatch('setCurrentUser', res);
        this.checkDexieCountryIsUserCountry(res);
      }).catch((error) => {
        this._resetUserAndPermissions();
        this.logError('Error occurred on logged user data request', 'user request', error);
        if (error.status === 403) {
          this.fireEvent('forbidden', {bubbles: true, composed: true});
        }
      });
    }
    checkDexieCountryIsUserCountry(user) {
      let country = {
        id: user.country.id,
        name: user.country.name
      };
      EtoolsPmpApp.DexieDb.ajaxDefaultDataTable.where('cacheKey').equals('currentCountry').toArray()
          .then((response) => {
            if (response.length > 0) {
              if (parseInt(response[0].data.id) !== parseInt(user.country.id)) {
                let eventPayload = {
                  message: 'Please wait while data is refreshed...',
                  active: true,
                  loadingSource: 'country-update'
                };
                this.fireEvent('global-loading', {
                  detail: eventPayload,
                  bubbles: true,
                  composed: true
                });
                this.refresh();
              }
            } else {
              this.addCountryInIndexedDb(country);
            }
          });
    }
    addCountryInIndexedDb(country) {
      let dataToCache = {
        cacheKey: 'currentCountry',
        data: country,
      };
      EtoolsPmpApp.DexieDb.ajaxDefaultDataTable.add(dataToCache);
    }
    _findGroup(groupName) {
      return _.find(this.userGroups, function(grp) {
        return grp.name === groupName;
      });
    }
    _resetUserAndPermissions() {
      this._setUser(null);
      this._setPermissions(null);
    }
    _setUserData(data) {
      let _user = data;
      let _permissions = {};
      this._setUser(_user);
      let permissionsList = this.getAllPermissions();
      if (!_.isEmpty(data)) {
        this._setUserGroups(_user.groups);
        permissionsList.defaultPermissions.forEach(function(perm) {
          _permissions[perm] = true;
        });
        if (this._findGroup('UNICEF User')) {
          permissionsList.unicefUserPermissions.forEach(function(perm) {
            _permissions[perm] = true;
          });
        }
        if (this._findGroup('Partnership Manager')) {
          permissionsList.partnershipManagerPermissions.forEach(function(perm) {
            _permissions[perm] = true;
          });
        }
        if (this._findGroup('PME')) {
          permissionsList.PMEPermissions.forEach(function(perm) {
            _permissions[perm] = true;
          });
        }
        if (this._findGroup('ICT')) {
          permissionsList.ICTPermissions.forEach(function(perm) {
            _permissions[perm] = true;
          });
        }
      } else {
        // TODO: we need to redirect to login page if no user data received
        // permissionsList.superPermissions.forEach(function(perm) {
        //  _permissions[perm] = true;
        // });
      }
      this._setPermissions(_permissions);
    }

    fireEvent(eventName, eventDetail) {
      this.dispatchEvent(new CustomEvent(eventName,  {
        detail: eventDetail,
        bubbles: true,
        composed: true
      }));
    }
  }
</script>
