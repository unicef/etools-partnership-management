<!-- <link rel="import" href="../../../../bower_components/polymer/polymer.html"> -->
<link rel="import" href="../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="user-data-mixin.html">

<script>
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Behaviors = window.EtoolsPmpApp.Mixins || {};

   /**
    * @polymer
    * @mixinFunction
    * @appliedMixin EtoolsPmpApp.Mixins.UserData
    * @appliedMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
    */

  EtoolsPmpApp.Mixins.ProfileOperations = (baseClass) =>
    class extends EtoolsPmpApp.Mixins.UserData(
        EtoolsPmpApp.Mixins.AjaxErrorsParser(baseClass)
      ) {

    static get properties() {
      return {
        endpoint: {
          type: String
        },
        _saveActionInProgress: Boolean,
        profileSaveLoadingMsgSource: {
          type: String,
          value: 'profile-modal'
        }
      };
    }

    _dispatchSaveProfileRequest(profile) {
      let self = this;
      let config = {
        endpoint: this.endpoint,
        method: 'PATCH',
        body: profile
      };

      this.sendRequest(config).then(function(resp) {
        self._handleResponse(resp);
      }).catch(function(error) {
        self.parseRequestErrorsAndShowAsToastMsgs(error);
        self._hideProfileSaveLoadingMsg();
      });
    }

    saveProfile(profile) {
      if (_.isEmpty(profile)) {
        // empty profile means no changes found
        this.fire('toast', {
          text: 'There is nothing to save. No change detected on your profile.',
          showCloseBtn: true
        });
        return;
      }

      this.fire('global-loading', {
        message: 'Saving profile data...',
        active: true,
        loadingSource: this.profileSaveLoadingMsgSource
      });
      this.set('_saveActionInProgress', true);
      this._dispatchSaveProfileRequest(profile);
    }

    _handleResponse(response) {
      this.dispatch('setCurrentUser', response);
      this._hideProfileSaveLoadingMsg();
    }

    _hideProfileSaveLoadingMsg() {
      if (this._saveActionInProgress) {
        this.fire('global-loading', {active: false, loadingSource: this.profileSaveLoadingMsgSource});
        this.set('_saveActionInProgress', false);
      }
    }

  }
</script>

