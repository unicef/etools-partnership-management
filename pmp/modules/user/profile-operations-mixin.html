<!-- <link rel="import" href="../../../../bower_components/polymer/polymer.html"> -->
<link rel="import" href="../mixins/ajax-errors-parser-mixin.html">
<link rel="import" href="user-data-mixin.html">

<script>
  'use strict';
  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};

   /**
    * @polymer
    * @mixinFunction
    * @appliesMixin EtoolsPmpApp.Mixins.UserData
    * @appliesMixin EtoolsPmpApp.Mixins.AjaxErrorsParser
    */
  EtoolsPmpApp.Mixins.ProfileOperations = baseClass =>
    class extends EtoolsPmpApp.Mixins.UserData(
        EtoolsPmpApp.Mixins.AjaxErrorsParser(baseClass)
      ) {

    static get properties() {
      return {
        _saveActionInProgress: Boolean,
        profileSaveLoadingMsgSource: {
          type: String,
          value: 'profile-modal'
        }
      };
    }

    _dispatchSaveProfileRequest(profile) {
      let self = this;
      let config = {
        endpoint: this.getEndpoint(this.endpointName),
        method: 'PATCH',
        body: profile
      };

      this.sendRequest(config).then(function(resp) {
        self._handleResponse(resp);
      }).catch(function(error) {
        self.parseRequestErrorsAndShowAsToastMsgs(error);
        self._hideProfileSaveLoadingMsg();
      });
    }

    saveProfile(profile) {
      if (_.isEmpty(profile)) {
        // empty profile means no changes found
        this.fireEvent('toast', {
          text: 'All changes are saved.',
          showCloseBtn: false
        });
        return;
      }

      this.fireEvent('global-loading', {
        message: 'Saving...',
        active: true,
        loadingSource: this.profileSaveLoadingMsgSource
      });
      this.set('_saveActionInProgress', true);
      this._dispatchSaveProfileRequest(profile);
    }

    _handleResponse(response) {
      this.dispatch('setCurrentUser', response);
      this._hideProfileSaveLoadingMsg();
    }

    _hideProfileSaveLoadingMsg() {
      if (this._saveActionInProgress) {
        this.fireEvent('global-loading', {
          active: false,
          loadingSource: this.profileSaveLoadingMsgSource
        });
        this.set('_saveActionInProgress', false);
      }
    }
  };
</script>

