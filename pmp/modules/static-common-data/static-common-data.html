<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-logs-mixin.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax-request-mixin.html">
<link rel="import" href="../../../bower_components/etools-behaviors/etools-mixin-factory.html">

<link rel="import" href="../endpoints/endpoints-mixin.html">
<link rel="import" href="../config/dexie-db-config.html">
<link rel="import" href="../environment-flags/environment-flags-mixin.html">

<link rel="import" href="mixins/country-programmes-data.html">
<link rel="import" href="mixins/dropdowns-pmp-data.html">
<link rel="import" href="mixins/dropdowns-static-data.html">
<link rel="import" href="mixins/locations-data.html">
<link rel="import" href="mixins/offices-data.html">
<link rel="import" href="mixins/sections-data.html">
<link rel="import" href="mixins/unicef-users-data.html">
<link rel="import" href="mixins/user-country-data.html">
<link rel="import" href="mixins/disaggregations-data.html">
<link rel="import" href="mixins/prp-countries.html">

<dom-module id="static-common-data">
  <script>
    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsLogsMixin
     * @appliesMixin EtoolsAjaxRequestMixin
     * @appliesMixin EtoolsPmpApp.Mixins.EnvironmentFlags
     * @appliesMixin EtoolsPmpApp.Mixins.Endpoints
     * @appliesMixin EtoolsPmpApp.Mixins.CountryProgrammesData
     * @appliesMixin EtoolsPmpApp.Mixins.DropdownsPmpData
     * @appliesMixin EtoolsPmpApp.Mixins.DropdownsStaticData
     * @appliesMixin EtoolsPmpApp.Mixins.LocationsData
     * @appliesMixin EtoolsPmpApp.Mixins.OfficesData
     * @appliesMixin EtoolsPmpApp.Mixins.SectionsData
     * @appliesMixin EtoolsPmpApp.Mixins.UnicefUsersData
     * @appliesMixin EtoolsPmpApp.Mixins.UserCountryData
     * @appliesMixin EtoolsPmpApp.Mixins.DisaggregationsData
     * @appliesMixin EtoolsPmpApp.Mixins.PRPCountries
     */
    const StaticCommonDataMixin = EtoolsMixinFactory.combineMixins([
      EtoolsLogsMixin, EtoolsAjaxRequestMixin, EtoolsPmpApp.Mixins.EnvironmentFlags,
      EtoolsPmpApp.Mixins.Endpoints, EtoolsPmpApp.Mixins.CountryProgrammesData,
      EtoolsPmpApp.Mixins.DropdownsPmpData, EtoolsPmpApp.Mixins.DropdownsStaticData,
      EtoolsPmpApp.Mixins.LocationsData, EtoolsPmpApp.Mixins.OfficesData,
      EtoolsPmpApp.Mixins.SectionsData, EtoolsPmpApp.Mixins.UnicefUsersData, EtoolsPmpApp.Mixins.UserCountryData,
      EtoolsPmpApp.Mixins.DisaggregationsData, EtoolsPmpApp.Mixins.PRPCountries
    ], Polymer.Element);

    class StaticCommonData extends StaticCommonDataMixin {
      static get is() {
        return 'static-common-data';
      }

      static get properties() {
        return {
          pmpStaticDataEndpointsNames: {
            type: Array,
            value: ['countryProgrammes', 'dropdownsPmp', 'dropdownsStatic', 'locations', 'offices',
              'sections', 'unicefUsers', 'userCountryDetails']
          },
          pmpDataEndpointNamesForPrpSections: {
            type: Array,
            value: ['addGetDisaggregations']
          },
          prpStaticDataEndpointsNames: {
            type: Array,
            value: ['getPRPCountries']
          }
        };
      }

      ready() {
        super.ready();
        // get PMP static data
        this._getStaticData(this.pmpStaticDataEndpointsNames);
        this._handlePrpData();
      }

      _handlePrpData() {
        this._waitForEnvFlagsToLoad().then(function() {
          if (this.showPrpReports()) {
            this._getStaticData(this.pmpDataEndpointNamesForPrpSections);
            if (this.prpServerIsOn()) {
              this._getStaticData(this.prpStaticDataEndpointsNames);
            }
          }
        }.bind(this));
      }

      _getStaticData(endpointsNames) {
        let self = this;
        endpointsNames.forEach(function(endpointName) {
          self._makeRequest(endpointName, self._getEndpointSuccessHandler(endpointName), self._errorHandler);
        });
      }

      _makeRequest(endpointName, successHandler, errorHandler) {
        let self = this;
        this.fireRequest(endpointName, {}).then(function(resp) {
          successHandler.bind(self, resp)();
        }).catch(function(error) {
          errorHandler.bind(self, error)();
        });
      }

      _errorHandler(err) {
        this.logError('Error getting static data', 'static-common-data', err);
      }

      _getEndpointSuccessHandler(endpointName) {
        switch (endpointName) {
          case 'countryProgrammes':
            return this._handleCountryProgrammesResponse;
          case 'dropdownsPmp':
            return this._handleDropdownsPmpResponse;
          case 'dropdownsStatic':
            return this._handleDropdownsStaticResponse;
          case 'locations':
            return this._handleLocationsResponse;
          case 'offices':
            return this._handleOfficesResponse;
          case 'sections':
            return this._handleSectionsResponse;
          case 'unicefUsers':
            return this._handleUnicefUsersResponse;
          case 'userCountryDetails':
            return this._handleUserCountryDataResponse;
          case 'addGetDisaggregations':
            return this._handleDisaggregationsResponse;
          case 'getPRPCountries':
            return this._handlePRPCountryDataResponse;
        }
      }

    }

    window.customElements.define(StaticCommonData.is, StaticCommonData);
  </script>
</dom-module>
