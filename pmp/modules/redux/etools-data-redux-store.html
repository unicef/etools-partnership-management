<link rel="import" href="../scripts/redux.html">
<link rel="import" href="../../../bower_components/polymer-redux/polymer-redux.html">

<script>
  'use strict';
  // shuts up the linting script
  var Redux = Redux || {}; // eslint-disable-line
  var PolymerRedux = PolymerRedux || {}; // eslint-disable-line

  let reduxStoreDefaultData = {
    fileTypes: [],
    signedByUnicefUsers: [],
    cpOutputs: [],
    countryProgrammes: [],
    interventionDocTypes: [],
    interventionStatuses: [],
    sections: [],
    unicefUsersData: [],
    locations: [],
    offices: [],
    partners: [],
    agreementsDropdownData: [],
    partnersDropdownData: [],
    agreementsList: [],
    agencyChoices: [],
    agreementAmendmentTypes: [],
    csoTypes: [],
    partnerTypes: [],
    assessmentTypes: [],
    interventionAmendmentTypes: [],
    currencies: [],
    agreementTypes: [],
    agreementStatuses: [],
    csoPartners: [],
    countryData: {},
    disaggregations: [],
    PRPCountryData: [],
    currentUser: {},
    reportStatuses: [
      // TODO: reports list filter statuses? To be confirmed by unicef team.
      {value: 'Acc', label: 'Accepted'},
      {value: 'Due', label: 'Due'},
      {value: 'Sen', label: 'Sent Back'},
      {value: 'Sub', label: 'Submitted'},
      {value: 'Ove', label: 'Overdue'}
    ],
    reportTypes: [
      {value: 'HR', label: 'Humanitarian Reports'},
      {value: 'QPR', label: 'Quarterly Progress Reports'},
      {value: 'SR', label: 'Special Reports'}
    ],
    locationTypes: [],
    grants: [],
    donors: [],
    partnerRiskRatings: [],
    pageData: {
      permissions: null,
      in_amendment: false
    },
    uploadsInProgress: 0,
    thereAreUnsavedUploads: false
  };

  const reduxStoreReducer = (state, action) => {
    /* eslint-disable indent */
    let partnersDdDataCopy;
    let disaggregsCopy;
    let agreementsCopy;
    let csoPartnerCopy;
    let indexP;
    let index;
    let pageDataWithPermsUpdated;
    let pageDataInAmendment;

    switch (action.type) {
      case 'SET_FILE_TYPES':
        return Object.assign({}, state, {fileTypes: action.fileTypes});

      case 'SET_CP_OUTPUTS':
        return Object.assign({}, state, {cpOutputs: action.cpOutputs});

      case 'SET_CP_DATA':
        return Object.assign({}, state, {countryProgrammes: action.countryProgrammes});

      case 'SET_SIGNED_BY_UNICEF_USERS':
        return Object.assign({}, state, {signedByUnicefUsers: action.signedByUnicefUsers});

      case 'SET_INTERVENTION_DOC_TYPES':
        return Object.assign({}, state, {interventionDocTypes: action.interventionDocTypes});

      case 'SET_INTERVENTION_STATUSES':
        return Object.assign({}, state, {interventionStatuses: action.statuses});

      case 'SET_SECTIONS':
        return Object.assign({}, state, {sections: action.sections});

      case 'SET_LOCATIONS':
        return Object.assign({}, state, {locations: action.locations});

      case 'SET_UNICEF_USERS_DATA':
        return Object.assign({}, state, {unicefUsersData: action.unicefUsersData});

      case 'SET_OFFICES':
        return Object.assign({}, state, {offices: action.offices});

      case 'SET_PARTNERS':
        return Object.assign({}, state, {partners: action.partnersData});

      case 'SET_AGREEMENTS':
        return Object.assign({}, state, {agreementsList: action.agreementsList});

      case 'ADD_EDIT_AGREEMENT':
        agreementsCopy = state.agreementsList.slice(0);
        index = agreementsCopy.findIndex(function(agr) {
          return agr.id === action.agreement.id;
        });

        if (index > -1) {
          agreementsCopy[index] = action.agreement;
        } else {
          agreementsCopy.push(action.agreement);
        }
        return Object.assign({}, state, {agreementsList: agreementsCopy});

      case 'SET_PARTNERS_DROPDOWN':
        return Object.assign({}, state, {partnersDropdownData: action.partnersDropdownData});

      case 'DELETE_PARTNER':
        csoPartnerCopy = state.csoPartners.slice(0);
        partnersDdDataCopy = state.partnersDropdownData.slice(0);

        indexP = csoPartnerCopy.findIndex(function(partner) {
          return partner.id === action.partnerId;
        });
        if (indexP > -1) {
          csoPartnerCopy.splice(indexP, 1);
        }
        indexP = partnersDdDataCopy.findIndex(function(partner) {
          return partner.value === action.partnerId;
        });
        if (indexP > -1) {
          partnersDdDataCopy.splice(indexP, 1);
        }
        return Object.assign({}, state, {
          partnersDropdownData: partnersDdDataCopy,
          csoPartners: csoPartnerCopy
        });

      case 'SET_AGREEMENTS_DROPDOWN':
        return Object.assign({}, state, {agreementsDropdownData: action.agreementsDropdownData});

      case 'SET_CURRENCIES':
        return Object.assign({}, state, {currencies: action.currencies});

      case 'SET_AGREEMENT_TYPES':
        return Object.assign({}, state, {agreementTypes: action.agreementTypes});

      case 'SET_AGREEMENT_STATUSES':
        return Object.assign({}, state, {agreementStatuses: action.statuses});

      case 'SET_CSO_PARTNERS':
        return Object.assign({}, state, {csoPartners: action.csoPartners});

      case 'SET_CSO_TYPES':
        return Object.assign({}, state, {csoTypes: action.csoTypes});

      case 'SET_PARTNER_TYPES':
        return Object.assign({}, state, {partnerTypes: action.partnerTypes});

      case 'SET_AGENCY_CHOICHES':
        return Object.assign({}, state, {agencyChoices: action.agencyChoices});

      case 'SET_AGREEMENT_AMENDMENT_TYPES':
        return Object.assign({}, state, {agreementAmendmentTypes: action.agreementAmendmentTypes});

      case 'SET_ASSESSMENT_TYPES':
        return Object.assign({}, state, {assessmentTypes: action.assessmentTypes});

      case 'SET_INTERVENTION_AMENDMENT_TYPES':
        return Object.assign({}, state, {interventionAmendmentTypes: action.interventionAmendmentTypes});

      case 'SET_USER_COUNTRY_DATA':
        return Object.assign({}, state, {countryData: action.countryData});

      case 'SET_DISAGGREGATIONS_DATA':
        return Object.assign({}, state, {disaggregations: action.disaggregations});

      case 'ADD_DISAGGREGATION':
        disaggregsCopy = state.disaggregations.slice(0);
        disaggregsCopy.push(action.disaggregation);
        return Object.assign({}, state, {disaggregations: disaggregsCopy});

      case 'SET_CURRENT_USER':
        return Object.assign({}, state, {currentUser: action.user});

      case 'SET_LOCATION_TYPES':
        return Object.assign({}, state, {locationTypes: action.locationTypes});

      case 'SET_DONORS':
        return Object.assign({}, state, {donors: action.donors});

      case 'SET_GRANTS':
        return Object.assign({}, state, {grants: action.grants});

      case 'SET_PARTNER_RISK_RATINGS':
        return Object.assign({}, state, {partnerRiskRatings: action.partnerRiskRatings});

      case 'SET_PRP_COUNTRY_DATA':
        return Object.assign({}, state, {PRPCountryData: action.PRPCountryData});

      case 'SET_ENV_FLAGS':
        return Object.assign({}, state, {envFlags: action.envFlags});

      case 'SET_PAGE_DATA_PERMISSIONS':
        pageDataWithPermsUpdated = Object.assign({}, state.pageData, {permissions: action.permissions});
        return Object.assign({}, state, {pageData: pageDataWithPermsUpdated});

      case 'SET_IN_AMENDMENT_MODE_STATE':
        pageDataInAmendment = Object.assign({}, state.pageData, {in_amendment: action.in_amendment});
        return Object.assign({}, state, {pageData: pageDataInAmendment});
      case 'INCREASE_UPLOADS_IN_PROGRESS':
        return Object.assign({}, state, {uploadsInProgress: state.uploadsInProgress + 1});
      case 'DECREASE_UPLOADS_IN_PROGRESS':
        return Object.assign({}, state, {uploadsInProgress: state.uploadsInProgress - 1});
      case 'SET_THERE_ARE_UNSAVED_UPLOADS':
        return Object.assign({}, state, {thereAreUnsavedUploads: action.thereAreUnsavedUploads});

      default:
        // no change
        return reduxStoreDefaultData;
    }
    /* eslint-enable indent */
  };

  const dataReduxStore = Redux.createStore(reduxStoreReducer, reduxStoreDefaultData);

  window.addEventListener('storage', function(e) {
    if (e.key !== 'update-redux' || !e.newValue) {
      return;
    }
    dataReduxStore.dispatch(JSON.parse(e.newValue));
  });

  window.addEventListener('beforeunload', function(e) {
    if (Number(dataReduxStore.getState().uploadsInProgress) > 0 ||
        dataReduxStore.getState().thereAreUnsavedUploads) {
       // Cancel the event as stated by the standard.
      e.preventDefault();
      // Chrome requires returnValue to be set.
      e.returnValue = 'Are you sure? Uploads in progress will be lost!';
    }

});

  window.EtoolsPmpApp = window.EtoolsPmpApp || {};
  window.EtoolsPmpApp.Mixins = window.EtoolsPmpApp.Mixins || {};

  /**
   * Etools redux store mixin
   * @polymer
   * @mixinFunction
   */
  EtoolsPmpApp.Mixins.EtoolsDataReduxStore =
      Polymer.dedupingMixin(PolymerRedux(dataReduxStore)) || {}; // eslint-disable-line
  // the || {} at the end is there to make the linting script happy
</script>
