<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="piwik-element">
  <script>
    // _paq array initialization and tracking script
    var _paq = _paq || [];
    _paq.push(["trackPageView"]);
    _paq.push(["enableLinkTracking"]);
    (function () {
      var u="//czue-unicef.innocraft.cloud/";
      _paq.push(["setTrackerUrl", u + "piwik.php"]);
      _paq.push(["setSiteId", '1']);
      var d = document, g = d.createElement("script"), s = d.getElementsByTagName("script")[0];
      g.type = "text/javascript"; g.defer = true; g.async = true; g.src = u + "piwik.js";
      s.parentNode.insertBefore(g, s);
    })();

    Polymer({
      is: 'piwik-element',
      properties: {
        page: {
          type: String,
          observer: 'pageView'
        },
        queryEntered: {
          type: Boolean,
          value: false
        },
      },

      // tracks exports and filtering
      trackEvent: function(e) {
        switch (e.detail.sourceEvent.currentTarget.innerText) {
          case 'EXPORT':
            _paq.push([
              'trackEvent',
              document.title,
              'export',
              e.srcElement.__data__.user.groups.map(g => g.name)
            ])
            break
          case 'GET CHART':
            _paq.push([
              'trackEvent',
              document.title,
              'chart filtered',
              e.srcElement.__data__.user.groups.map(g => g.name)
            ])
            break
          case 'ADD FILTER':
            _paq.push([
              'trackEvent',
              document.title,
              'chart filtered',
              e.srcElement.__data__.user.groups.map(g => g.name)
            ])
        }
      },

      // sets global event listeners, sets global error listener
      attached: function() {
        document.addEventListener('tap', this.trackEvent.bind(this));
        document.addEventListener('keyup', this.typing.bind(this));
        window.onerror = this.error
      },

      // checks if typing is in relevant input field, tracks search bar filtering
      typing: function() {
        if (event.path[0].value && event.path[7].id === 'query' && this.queryEntered === false) {
          _paq.push([
            'trackEvent',
            document.title,
            'search bar used',
            event.srcElement.__data__.user.groups.map(g => g.name)
          ])
          this.set('queryEntered', true)
        }
      },

      // handles tracking error messages
      error: function (msg, url, lineNo, columnNo, error) {
        var message = [
          'Message: ' + msg,
          'URL: ' + url,
          'Line: ' + lineNo,
          'Column: ' + columnNo,
          'Error object: ' + JSON.stringify(error)
        ].join(' - ');
        _paq.push(['trackEvent', 'error', 'javascript error', message])
      },

      // validationError: function() {
      //   debugger
        // event.detail.text
        // event.path[0].attributes[1].value
        // event.path[0].__data__.endpoint.url
      // },

      // tracks internal pageviews that aren't picked up with trackPageView
      pageView: function() {
        if (event && event.srcElement.__data__.route) {
          _paq.push([
            'trackEvent',
            event.srcElement.__data__.route.path,
            'tap',
            'in-app navigation'
          ])
        }
      },
    });
  </script>
</dom-module>
