<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>Partners List Tests</title>

  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <script src="../../node_modules/redux/dist/redux.min.js"></script>

  <link rel="import" href="../../pmp/app-config/app-dexie-db-config.html">
  <link rel="import" href="../test-helpers/testing-utils.html">
  <link rel="import" href="mockup-data/partner-tests-mockup-data.html">

  <!-- Import the element to test -->
  <link rel="import" href="../../pmp/app-elements/partners/partners-list.html">

</head>
<body>

  <test-fixture id="partners-list">
    <template>
      <partners-list></partners-list>
    </template>
  </test-fixture>

  <script>
    (function() {
      'use strict';

      suite('Partners list tests with fake server', function() {
        let server;
        let partnersList;

        let defaultRoute = {
          prefix: '',
          path: 'partners/list',
          '__queryParams': {size: 10, sort :'name.asc'}
        };

        setup(function() {
          server = PmpTestsHelper.initializeFakeServer();
          partnersList = fixture('partners-list');
          partnersList.set('urlParams', defaultRoute.__queryParams);
        });

        teardown(function() {
          server.restore();
        });

        test('Partners list', function(done) {
          // activate partners list page
          partnersList.set('active', true);

          // fake partners request
          server.respondWith('GET', '/api/v2/partners/', [
            200, PmpTestsHelper.fakeServerResponseHeaders.json,
            JSON.stringify(PmpTests.Partners.MockupData.partnersListData)
          ]);
          server.respond();

          flush(function() {
            // Polymer.dom(partnersList.root).querySelector('partners-list-data'
            let partnersListDataEl = partnersList.$$('#partners');
            expect(partnersListDataEl.is).to.equal('partners-list-data');
            // /api/v2/partners/ response should match partnersListData
            expect(JSON.stringify(PmpTests.Partners.MockupData.partnersListData))
                .to.equal(JSON.stringify(partnersListDataEl.data));
            partnersListDataEl.fire(partnersListDataEl.dataLoadedEventName);
            expect(partnersList.requiredDataLoaded).to.equal(true);

            // check default query string to match default urlParams
            let defaultQueryString = Object.keys(partnersList.urlParams).map(function(k) {
              return k + '=' + partnersList.urlParams[k];
            }).join('&');
            expect(partnersList._buildQueryString()).to.equal(defaultQueryString);

            let dataListEl = partnersList.$$('#list');
            expect(dataListEl.is).to.equal('paper-material');
            expect(dataListEl.classList.contains('hidden')).to.equal(true);

            // assign some data to the list
            partnersList.set('filteredPartners', partnersListDataEl.data);
            expect(dataListEl.classList.contains('hidden')).to.equal(false);

            // use flush to make sure list rows were stamped before checking them
            flush(function() {
              let rowsDisplayed = dataListEl.querySelectorAll('etools-data-table-row');
              expect(rowsDisplayed.length).to.equal(partnersList.filteredPartners.length);
              done();
            });

          });
        });
      });
    })();
  </script>

</body>
</html>

