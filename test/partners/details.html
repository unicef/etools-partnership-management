<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>Partners Pages Tests</title>

  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <script src="../../node_modules/redux/dist/redux.min.js"></script>

  <script src="../../bower_components/iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="../../pmp/app-config/app-dexie-db-config.html">
  <link rel="import" href="../test-helpers/testing-utils.html">
  <link rel="import" href="../test-helpers/partner-tests-mockup-data.html">
  <link rel="import" href="../test-helpers/users-and-permissions-data-mockup.html">

  <!-- Import the element to test -->
  <link rel="import" href="../../pmp/app-elements/partners/partner-details.html">

</head>
<body>

  <test-fixture id="partner-details">
    <template>
      <partner-details></partner-details>
    </template>
  </test-fixture>

  <script>
    suite('Partner details elements tests', function() {
      let partnerDetails;
      let partnerData = PmpTestsHelper.deepCloneObject(PmpTests.Partners.MockupData.partnerDetailsExample1);

      setup(function() {
        partnerDetails = fixture('partner-details');
        partnerDetails.set('partner', partnerData);
        partnerDetails.set('editMode', appUserPermissions && appUserPermissions.editPartnerDetails);
      });

      test('Details main element is a valid', function() {
        expect(partnerDetails.is).to.equal('partner-details');
      });

      test('Current user should have edit permissions', function() {
        expect(partnerDetails.editMode).to.equal(true);
      });

      test('Partner details panel data displayed data test', function(done) {
        flush(function() {
          let fullName = Polymer.dom(partnerDetails.root).querySelector('paper-input[label="Full Name"]');
          expect(fullName.is).to.equal('paper-input');
          expect(fullName.readonly).to.equal(true);
          expect(fullName.value).to.equal('ABAAD RESOURCE CENTER FOR GENDER');

          let shortName = Polymer.dom(partnerDetails.root).querySelector('paper-input[label="Short Name"]');
          expect(shortName.is).to.equal('paper-input');
          expect(shortName.readonly).to.equal(true);
          expect(shortName.value).to.equal('abaad');

          let vendorNr = Polymer.dom(partnerDetails.root).querySelector('paper-input[label="Vendor Number"]');
          expect(vendorNr.is).to.equal('paper-input');
          expect(vendorNr.readonly).to.equal(true);
          expect(vendorNr.value).to.equal('2500225514');

          let partnerType = Polymer.dom(partnerDetails.root).querySelector('paper-input[label="Partner Type"]');
          expect(partnerType.is).to.equal('paper-input');
          expect(partnerType.readonly).to.equal(true);
          expect(partnerType.value).to.equal('Civil Society Organization/National');

          let address = Polymer.dom(partnerDetails.root).querySelector('paper-input[label="Address"]');
          expect(address.is).to.equal('paper-input');
          expect(address.readonly).to.equal(true);
          expect(address.value).to.equal('BUSTANI STREET');

          let phone = Polymer.dom(partnerDetails.root).querySelector('paper-input[label="Phone Number"]');
          expect(phone.is).to.equal('paper-input');
          expect(phone.readonly).to.equal(true);
          expect(phone.value).to.equal('03 663052');

          let email = Polymer.dom(partnerDetails.root).querySelector('paper-input[label="E-mail address"]');
          expect(email.is).to.equal('paper-input');
          expect(email.readonly).to.equal(true);
          expect(email.value).to.equal('GHIDA.ANANI@ABAADMENA.ORG');

          let alternateName = Polymer.dom(partnerDetails.root).querySelector('paper-input[label="Alternate Name"]');
          expect(alternateName.is).to.equal('paper-input');
          expect(alternateName.readonly).to.equal(false);
          expect(alternateName.value).to.equal('test');

          let sharedPartner = Polymer.dom(partnerDetails.root)
              .querySelector('etools-multi-selection-menu[label="Shared Partner"]');
          expect(sharedPartner.is).to.equal('etools-multi-selection-menu');
          expect(sharedPartner.readonly).to.equal(false);
          expect(sharedPartner.selectedValues).to.equal(null);
          expect(sharedPartner.selectedItems.length).to.equal(0);

          let coreValsAssessment = Polymer.dom(partnerDetails.root)
              .querySelector('#core-values-assessment');
          // core values assessment file should be visible for this partner
          expect(coreValsAssessment.hasAttribute('hidden')).to.equal(false);
          // no file selected
          let coreValsAssessmentFile = Polymer.dom(partnerDetails.root)
              .querySelector('#core-values-assessment etools-single-file');
          expect(coreValsAssessmentFile.is).to.equal('etools-single-file');
          expect(coreValsAssessmentFile.file).to.equal(null);
          expect(coreValsAssessmentFile.readonly).to.equal(false); // should be able to select file

          done();
        });
      });

      test('Partners assessments panel header row data should be readonly', function(done) {
        flush(function() {
          let riskRatingRow = Polymer.dom(partnerDetails.root).querySelector('#riskRatingRow');
          let risk = riskRatingRow.querySelector('paper-input[label="Risk Rating"]');
          expect(risk.is).to.equal('paper-input');
          expect(risk.readonly).to.equal(true);
          expect(risk.value).to.equal('Low');

          let assessmentType = riskRatingRow.querySelector('paper-input[label="Assessment Type"]');
          expect(assessmentType.is).to.equal('paper-input');
          expect(assessmentType.readonly).to.equal(true);
          expect(assessmentType.value).to.equal('Micro Assessment');

          let dateOfA = riskRatingRow.querySelector('paper-input[label="Date of Assessment"]');
          expect(dateOfA.is).to.equal('paper-input');
          expect(dateOfA.readonly).to.equal(true);
          expect(dateOfA.value).to.equal('13 Oct 2017');

          done();
        });
      });

      test('Partners assessments list tests: delete btn visibility, rendered assessments should be 4, ' +
          'displayed data is readonly and correctly shown', function(done) {

        flush(function() {
          let assessmentsList = Polymer.dom(partnerDetails.root).querySelector('#assessmentsList');
          expect(assessmentsList.is).to.equal('assessments-items');

          let assessmentsListRows = Polymer.dom(assessmentsList.root).querySelectorAll('.row-h.item-container');
          expect(assessmentsListRows.length).to.equal(4);

          let firstRow = assessmentsListRows[0];

          // delete btn should be visible
          let deleteBtn = firstRow.querySelector('.actions paper-icon-button');
          expect(PmpTestsHelper.elementIsVisible(deleteBtn)).to.equal(true);

          let assessmentType = firstRow.querySelector('[label="Assessment Type"]');
          if (!partnerDetails.editMode) {
            expect(assessmentType.is).to.equal('paper-input');
            expect(assessmentType.readonly).to.equal(true);
            expect(assessmentType.value).to.equal('Scheduled Audit report');
          } else {
            expect(assessmentType.is).to.equal('etools-single-selection-menu');
            expect(assessmentType.readonly).to.equal(false);
            expect(typeof assessmentType.selectedItem).to.equal('object');
            expect(assessmentType.selected).to.equal('Scheduled Audit report');
          }

          let dateOfA = firstRow.querySelector('[label="Date of Assessment"]');
          expect(dateOfA.is).to.equal('etools-date-input');
          expect(dateOfA.$$('#dateInput').value).to.equal('29 May 2015');

          let basisForRr = firstRow.querySelector('[label="Basis for Risk Rating"]');
          expect(basisForRr.is).to.equal('etools-checkable-input');
          expect(basisForRr.checked).to.equal(false);

          let report = firstRow.querySelector('[label="Report"]');
          expect(report.is).to.equal('etools-single-file');
          expect(report.attachments[0].file_name).to.equal('ABAAD_2015_Audit_OUz135C.pdf');

          done();
        });
      });

      test('Assessments should not allow more than 1 checked Basis for Risk Rating field', function(done) {

        function _getCheckedRiskratingFields(basisRiskRatingFields) {
          let checkedFieldsNr = 0;
          basisRiskRatingFields.forEach(function(bRiskrating) {
            if (bRiskrating.checked) {
              checkedFieldsNr++;
            }
          });
          return checkedFieldsNr;
        }

        function noMoreThanOneFieldSelected(basisRiskRatingFields) {
          let checkedFieldsNr = _getCheckedRiskratingFields(basisRiskRatingFields);
          assert.isAtMost(checkedFieldsNr, 1, 'No more than one field selected');
        }

        flush(function() {
          let assessmentsList = Polymer.dom(partnerDetails.root).querySelector('#assessmentsList');
          let basisRiskRatingFields = Polymer.dom(assessmentsList.root)
              .querySelectorAll('.row-h.item-container etools-checkable-input');
          noMoreThanOneFieldSelected(basisRiskRatingFields);

          // start changing risk rating basis fields, only one should be checked
          // tap on first field
          MockInteractions.tap(Polymer.dom(basisRiskRatingFields[0].root).querySelector('#el'));
          noMoreThanOneFieldSelected(basisRiskRatingFields);

          // tap on second field
          MockInteractions.tap(Polymer.dom(basisRiskRatingFields[1].root).querySelector('#el'));
          noMoreThanOneFieldSelected(basisRiskRatingFields);
          done();
        });
      });

      test('Add new assessment and validations', function(done) {
        flush(function() {
          let assessmentsList = Polymer.dom(partnerDetails.root).querySelector('#assessmentsList');
          let basisRiskRatingFields = Polymer.dom(assessmentsList.root).querySelectorAll('.row-h.item-container');
          let initialRowsNr = basisRiskRatingFields.length;
          let addNewAssessmentBtn = Polymer.dom(assessmentsList.root).querySelector('paper-fab');
          MockInteractions.tap(addNewAssessmentBtn);
          Polymer.dom.flush();
          basisRiskRatingFields = Polymer.dom(assessmentsList.root).querySelectorAll('.row-h.item-container');
          expect(basisRiskRatingFields.length).to.equal(initialRowsNr + 1);

          // validation method on new empty row should not rigger errors, but it should not pass
          let valid = assessmentsList.validate();
          expect(valid).to.equal(false);

          let newRowPrevAdded = basisRiskRatingFields[basisRiskRatingFields.length - 1];
          let assessmentType = newRowPrevAdded.querySelector('[label="Assessment Type"]');
          let dateOfA = newRowPrevAdded.querySelector('[label="Date of Assessment"]');
          let report = newRowPrevAdded.querySelector('[label="Report"]');
          // check invalid state
          expect(assessmentType.invalid).to.equal(false);
          expect(dateOfA.invalid).to.equal(false);
          expect(report.invalid).to.equal(false);

          // trigger validations messages to show
          let currentDate = new Date();
          let dateStr = currentDate.getFullYear() + '-' + (currentDate.getMonth() + 1) + '-' + currentDate.getDate();
          dateOfA.set('value', dateStr);
          Polymer.dom.flush();
          expect(assessmentType.invalid).to.equal(true);
          expect(dateOfA.invalid).to.equal(false);
          expect(report.invalid).to.equal(true);
          // check error messages
          expect(assessmentType.errorMessage).to.equal('Assessment Type is required');
          assert.isAtLeast(['This field is required!',
            'Date cannot be in the future!'].indexOf(dateOfA.errorMessage), 0);
          expect(report.errorMessage).to.equal('Please select the report file');

          done();
        });
      });

      test('Partner contacts rendered data', function(done) {
        flush(function() {
          let staff = Polymer.dom(partnerDetails.root).querySelector('#staffMembersList');
          let staffListRows = Polymer.dom(staff.root).querySelectorAll('.row-h.item-container');
          expect(staff.is).to.equal('staff-members');
          expect(staffListRows.length).to.equal(2);

          let position = staffListRows[0].querySelector('[label="Position"]');
          let firstName = staffListRows[0].querySelector('[label="First Name"]');
          let lastName = staffListRows[0].querySelector('[label="Last Name"]');
          let phone = staffListRows[0].querySelector('[label="Phone number"]');
          let email = staffListRows[0].querySelector('[label="E-mail address"]');
          let active = staffListRows[0].querySelector('etools-checkable-input');

          expect(position.value).to.equal('title');
          expect(firstName.value).to.equal('Ghida Anani');
          expect(lastName.value).to.equal('Ghida Anani');
          expect(phone.value).to.equal('');
          expect(email.value).to.equal('ghida.anani@abaadmena.org');
          expect(active.checked).to.equal(true);

          done();
        });
      });

      test('Partner contacts: delete btn should be hidden for saved staff members', function(done) {
        flush(function() {
          let staff = Polymer.dom(partnerDetails.root).querySelector('#staffMembersList');
          let staffListRows = Polymer.dom(staff.root).querySelectorAll('.row-h.item-container');
          // cannot delete a saved staff member
          // delete btn should be hidden
          staffListRows.forEach(function(row) {
            let deleteBtn = row.querySelector('.actions paper-icon-button');
            expect(PmpTestsHelper.elementIsVisible(deleteBtn)).to.equal(false);
          });

          done();
        });
      });

      test('Partner contacts: add new staff members and check validations', function(done) {
        flush(function() {
          let staff = Polymer.dom(partnerDetails.root).querySelector('#staffMembersList');
          let staffListRows = Polymer.dom(staff.root).querySelectorAll('.row-h.item-container');
          let initialStaffMembersNr = staffListRows.length;

          let addNewStaffMemberBtn = Polymer.dom(staff.root).querySelector('paper-fab');
          MockInteractions.tap(addNewStaffMemberBtn);

          Polymer.dom.flush();

          staffListRows = Polymer.dom(staff.root).querySelectorAll('.row-h.item-container');
          expect(staffListRows.length).to.equal(initialStaffMembersNr + 1);

          // new staff member row should have delete btn visible
          let newAddedRow = staffListRows[staffListRows.length - 1];
          let deleteBtn = newAddedRow.querySelector('.actions paper-icon-button');
          expect(PmpTestsHelper.elementIsVisible(deleteBtn)).to.equal(true);

          // add data and validate
          let valid = staff.validate();
          expect(valid).to.equal(false);

          let position = newAddedRow.querySelector('[label="Position"]');
          let firstName = newAddedRow.querySelector('[label="First Name"]');
          let lastName = newAddedRow.querySelector('[label="Last Name"]');
          let phone = newAddedRow.querySelector('[label="Phone number"]');
          let email = newAddedRow.querySelector('[label="E-mail address"]');
          let active = newAddedRow.querySelector('etools-checkable-input');

          // active is true by default
          expect(active.checked).to.equal(true);
          position.set('value', 'Developer');

          expect(position.invalid).to.equal(false);
          expect(position.errorMessage).to.equal('Position is required');

          expect(firstName.invalid).to.equal(true);
          expect(firstName.errorMessage).to.equal('First name is required');

          expect(lastName.invalid).to.equal(true);
          expect(lastName.errorMessage).to.equal('Last name is required');

          expect(phone.invalid).to.equal(true);
          expect(phone.errorMessage).to.equal('Phone number is required');

          expect(email.invalid).to.equal(true);
          expect(email.errorMessage).to.equal('A valid & unused email address is required');

          email.set('value', 'test.me@notanemailaddress.org');

          expect(email.invalid).to.equal(false);
          expect(phone.invalid).to.equal(false);

          firstName.set('value', 'John');
          lastName.set('value', 'Doe');

          valid = staff.validate();
          expect(valid).to.equal(true); // new partner data entered is valid

          done();
        });
      });

    });
  </script>

</body>
</html>
