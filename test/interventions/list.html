<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>Interventions Pages Tests</title>

  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <script src="../../node_modules/redux/dist/redux.min.js"></script>

  <link rel="import" href="../test-helpers/testing-utils.html">
  <link rel="import" href="../test-helpers/interventios-testing-helper.html">

  <link rel="import" href="../../pmp/app-config/app-dexie-db-config.html">

  <link rel="import" href="../../pmp/app-elements/interventions/interventions-list.html">
</head>
<body>
  <test-fixture id="interventionsListFixture">
    <template>
      <interventions-list></interventions-list>
    </template>
  </test-fixture>

  <script>
    suite('Interventions list tests', function() {
      var helper;

      setup(function(done) {
        helper = new InterventionsListHelper();
        helper.setupGetInterventionsList();
        helper.intializeElementUnderTest();
        helper.stubQuery();

        done();
      });

      teardown(function() {
        helper.server.restore();
        helper.interventionsList.interventionsListData.query.restore();
      });

      test('interventions-list element has been created', function() {
        assert.equal(helper.interventionsList.is , 'interventions-list');
      });

      test('interventions items are displayed on UI', function(done) {
        flush(function() {
          let rows = helper.interventionsList.$$('#list').querySelectorAll('etools-data-table-row');
          expect(rows.length).to.equal(helper.interventionsList.filteredInterventions.length);
          done();
        });
      });

      suite('when filtering', function() {
        var filterPaperMenu, ddContent;
        setup(function(done) {
          filterPaperMenu = helper.interventionsList.$$('#filterMenu');
          ddContent = Polymer.dom(filterPaperMenu).querySelector('.dropdown-content');
          done();
        });
        test('filter options are available', function(done) {
          flush(function() {
            PmpTestsHelper.PaperMenuButton.runAfterOpen(filterPaperMenu, function() {
              // expect(PmpTestsHelper.elementIsVisible(ddContent)).to.be.equal(true);
              expect(helper.interventionsList.availableListFilterOptions.length).to.be.greaterThan(0);
              done();
            });

            })
        });

        test('can filter by an option', function(done) {
          flush(function() {
            PmpTestsHelper.PaperMenuButton.runAfterOpen(filterPaperMenu, function() {
              var firstItem = ddContent.querySelector('paper-item');
              let initialAvFiltersLength = helper.interventionsList.availableListFilterOptions.length;
              PmpTestsHelper.PaperMenuButton.runAfterClose(filterPaperMenu, firstItem, function() {
                expect(helper.interventionsList.selectedFilters.length).to.be.greaterThan(0);
                expect(helper.interventionsList.availableListFilterOptions.length).to.be.equal(initialAvFiltersLength - 1);
                done();
              });
            });
          })
        });
      });


    });

  </script>
</body>
</html>
