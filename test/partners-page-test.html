<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>Partners Pages Tests</title>

  <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script src="../node_modules/redux/dist/redux.min.js"></script>

  <!-- Import test helpers data -->
  <link rel="import" href="test-helpers/users-and-permissions-data-mockup.html">
  <link rel="import" href="test-helpers/partner-tests-mockup-data.html">

  <link rel="import" href="../pmp/app-config/app-dexie-db-config.html">

  <!-- Import the element to test -->
  <link rel="import" href="../pmp/pages/page-partners.html">
  <link rel="import" href="../pmp/app-elements/partners/partners-list.html">
</head>
<body>

  <test-fixture id="partners">
    <template>
      <page-partners></page-partners>
    </template>
  </test-fixture>

  <test-fixture id="partners-list">
    <template>
      <partners-list></partners-list>
    </template>
  </test-fixture>

  <script>
    let defaultRoute = {
      prefix: '',
      path: 'partners/list',
      '__queryParams': {size: 10, sort :'name.asc'}
    };

    // disable request data caching functionality
    window.EtoolsRequestCacheDisabled = true;

    // setup fake server to mock requests then test partners pages
    suite('App partners pages tests', function() {
      let server;
      let responseHeaders = {
        json: { 'Content-Type': 'application/json' }
      };

      setup(function() {
        server = sinon.fakeServer.create();
        server.autoRespond = true;
        server.respondImmediately = true;
      });

      teardown(function() {
        server.restore();
      });

      suite('Main partners page tests', function() {
        let partners;

        setup(function() {
          // setup main partners page test-fixture
          partners = fixture('partners');
          partners.set('route', defaultRoute);
          partners.set('permissions', appUserPermissions);
          partners.set('partnerPage', 'list');
          partners.set('listActive', true);
        });

        test('Main partners element: page-partners is registered', function() {
          assert.equal(partners.is, 'page-partners');
        });

        test('Default active page should be partners list', function(done) {
          flush(function() {
            expect(partners.route.path).to.equal('partners/list');
            expect(partners.get('partnerPage')).to.equal('list');
            expect(partners._pageEquals(partners.partnerPage, 'list')).to.equal(true);
            expect(partners.listActive).to.equal(true);
            expect(partners.tabsActive).to.equal(false);

            let titleEl = Polymer.dom(partners.root).querySelector('h1[main-title]');
            let titleText = String(Polymer.dom(titleEl).querySelector('span:not([hidden])').innerHTML);
            expect(titleText).to.equal('Partners');

            let partnersListElement = partners.$$('#list');
            expect(partnersListElement.is).to.equal('partners-list');
            done();
          });
        });

      });

      // test partners list elements
      suite('Partners list elements tests', function() {
        let partnersList;
        setup(function() {
          partnersList = fixture('partners-list');
          partnersList.set('urlParams', defaultRoute.__queryParams);
        });

        test('Test partners list data', function(done) {
          // activate partners list page
          partnersList.set('active', true);

          // fake partners request
          server.respondWith('GET', '/api/v2/partners/', [
            200, responseHeaders.json,
            JSON.stringify(partnersListData)
          ]);
          server.respond();

          flush(function() {
            // Polymer.dom(partnersList.root).querySelector('partners-list-data'
            let partnersListDataEl = partnersList.$$('#partners');
            expect(partnersListDataEl.is).to.equal('partners-list-data');
            // /api/v2/partners/ response should match partnersListData
            expect(JSON.stringify(partnersListData)).to.equal(JSON.stringify(partnersListDataEl.data));
            partnersListDataEl.fire(partnersListDataEl.dataLoadedEventName);
            expect(partnersList.requiredDataLoaded).to.equal(true);

            // check default query string to match default urlParams
            let defaultQueryString = Object.keys(partnersList.urlParams).map(function(k) {
              return k + '=' + partnersList.urlParams[k];
            }).join('&');
            expect(partnersList._buildQueryString()).to.equal(defaultQueryString);

            let dataListEl = partnersList.$$('#list');
            expect(dataListEl.is).to.equal('paper-material');
            expect(dataListEl.classList.contains('hidden')).to.equal(true);

            // assign some data to the list
            partnersList.set('filteredPartners', partnersListDataEl.data);
            expect(dataListEl.classList.contains('hidden')).to.equal(false);

            // use flush to make sure list rows were stamped before checking them
            flush(function() {
              let rowsDisplayed = dataListEl.querySelectorAll('etools-data-table-row');
              expect(rowsDisplayed.length).to.equal(partnersList.filteredPartners.length);
              done();
            });

          });
        });

      });

      suite('Partner overview elements tests', function() {
        let partnerOverview;
        setup(function() {
          // partnerOverview = fixture('partner-overview');
        });

        test('Overview', function() {

        });
      });

      suite('Partner details elements tests', function() {
        let partnerDetails;
        setup(function() {
          // partnerDetails = fixture('partner-details');
        });

        test('Details', function() {

        });
      });

    });

  </script>
</body>
</html>
