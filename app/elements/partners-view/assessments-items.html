<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../styles/pmp/layout-styles.html">
<link rel="import" href="../../styles/pmp/form-fields-styles.html">

<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../common/files-upload/files-upload.html">
<link rel="import" href="../common/custom-radio-button/custom-radio-button.html">
<link rel="import" href="../common/custom-dropdown/custom-dropdown.html">
<link rel="import" href="../common/content-toggle-button/content-toggle-button.html">

<dom-module id="assessments-items">
  <template>
    <style include="layout-styles form-fields-styles">
      .assessments-header {
        position: relative;
        line-height: 30px;
      }
      .assessments-header paper-button {
        --paper-button: {
          width: 30px;
          height: 30px;
          min-width: 0;
          padding: 0;
          border-radius: 15px;
          background-color: var(--assessments-add-btn-bg-color, --third-text-color);
          color: var(--assessments-add-btn-color, #ffffff);
        };
      }
      .assessment {
        margin-top: 20px;
      }
      .remove-assessment {
        border-right: 1px solid var(--divider-color);
        width: 50px;
        margin-right: 26px;
      }
      .remove-assessment paper-icon-button {
        color: var(--assessments-remove-btn-color, --third-text-color);
        --paper-icon-button: {
          padding: 3px;
          width: 24px;
          min-width: 0;
          height: 24px;
        };
      }
      .remove-btn-container {
        height: 73px;
      }

    </style>
    <div class="assessments-header flex-horizontal">
      <content-toggle-button class="flex-child" label="Assessments" active="{{assessmentsActive}}"></content-toggle-button>
      <paper-button class="add-new-assesment" on-tap="addNewAssessmentItem">
        <iron-icon icon="add"></iron-icon>
      </paper-button>
    </div>
    <iron-collapse id="assessments" opened="{{assessmentsActive}}">
      <template is="dom-repeat" items="{{assessmentsData}}">
        <div class="assessment flex-horizontal">
          <div class="remove-assessment flex-horizontal flex-align-center-justified">
            <template is="dom-if" if="[[displayRemoveBtn(index)]]">
              <!-- Remove assessment btn -->
              <div class="flex-horizontal flex-align-center remove-btn-container">
                <paper-icon-button icon="remove-circle" on-tap="removeAssessment"  data-args$="[[index]]"></paper-icon-button>
              </div>
            </template>
          </div>

          <!-- Assessment type -->
          <custom-dropdown class="n-input-field"
                           label="Assessment Type"
                           dropdown-value="{{item.assessment_type}}"
                           options="[[assessmentTypes]]"></custom-dropdown>

          <!-- Completed by -->
          <paper-input class="n-input-field"
                       label="Completed By"
                       value="{{item.completed_by}}">
            <paper-icon-button prefix icon="event"></paper-icon-button>
          </paper-input>

          <!-- Report file -->
          <!-- TODO: populate report file field: item.report_file -->
          <div class="n-input-field">
            <files-upload target="/path/to/destination" label="Report"></files-upload>
          </div>

          <!-- Basis for risk rating checkbox -->
          <div class="custom-field-wrapper n-input-field">
            <custom-radio-button checked="{{item.basis_for_risk_rating}}" label="Basis for risk rating?" on-tap="basisForRiskRatingChanged"  data-args$="[[index]]"></custom-radio-button>
          </div>

        </div>
      </template>
    </iron-collapse>
    <paper-toast id="emptyAssessmentNotification" always-on-top="true" duration="3000" vertical-align="top" horizontal-align="right">
      <iron-icon icon="info"></iron-icon>
      Fill last added assessment fields to be able to add more.
    </paper-toast>
  </template>

  <script>
    (function() {
      // jscs:disable
      'use strict';

      Polymer({
        is: 'assessments-items',
        properties: {
          assessmentsData: {
            type: Array,
            value: function () {
              return [];
            },
            notify: true,
            reflectToAttribute: true
          },
          assessmentTypes: {
            type: Array
          }
        },
        ready: function () {
          this.assessmentsIronCollapse = this.$.assessments;
          if (this.assessmentsData.length === 0) {
            this.push('assessmentsData', this._getNewEmptyAssessmentItem());
          }
        },
        addNewAssessmentItem: function () {
          var open = false;
          if (this.assessmentsIronCollapse.opened === false) {
            open = true;
            this.assessmentsIronCollapse.show();
          }
          var newAssessment = this._getNewEmptyAssessmentItem();
          if (!this._checkAssessmentDuplicate(newAssessment)) {
            this.push('assessmentsData', newAssessment);
          } else {
            if (open === false) {
              this.$.emptyAssessmentNotification.open();
            }
          }
        },
        removeAssessment: function (event) {
          var index = parseInt(Polymer.dom(event).localTarget.getAttribute('data-args'));
          if (index !== -1) {
            this.splice('assessmentsData', index, 1);
          }
        },
        displayRemoveBtn: function (index) {
          if (index === 0) {
            return false;
          }
          return true;
        },
        basisForRiskRatingChanged: function (event) {
          var index = parseInt(Polymer.dom(event).localTarget.getAttribute('data-args'));
          for (var i = 0; i < this.assessmentsData.length; i++) {
            if (i !== index) {
              this.set('assessmentsData.' + i + '.basis_for_risk_rating', false);
            }
          }
        },
        _checkAssessmentDuplicate: function (assessment) {
          var duplicateFound = false;
          for (var i = 0; i < this.assessmentsData.length; i++) {
            if (JSON.stringify(this.assessmentsData[i]) === JSON.stringify(assessment) ) {
              duplicateFound = true;
              break;
            }
          }
          return duplicateFound;
        },
        _getNewEmptyAssessmentItem: function () {
          return {
            assessment_type: null,
            completed_by: null,
            report_file: null,
            basis_for_risk_rating: false
          };
        }
      });

    })();
  </script>
</dom-module>
