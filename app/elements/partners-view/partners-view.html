<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../partner-data/partner-data.html">

<dom-module id="partners-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      vaadin-combo-box {
        margin-bottom: 20px;
        --paper-input-container-label: {
          font-size: inherit;
        }
      }
    </style>

    <paper-material elevation="1">
      <div class="data-table">
        <partner-data id="partners" data="{{data}}"></partner-data>
        <vaadin-grid id="partnerTable" items="[[data]]" on-sort-order-changed="_sortOrderChanged" visible-rows="11">
          <table>
            <colgroup>
              <col name="name" sortable/>
              <col name="partner_type"/>
              <col name="vendor_number" sortable/>
              <col name="rating" sortable/>
              <col name="vision_synced"/>
            </colgroup>
          </table>
        </vaadin-grid>
      </div>
    </paper-material>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'partners-view',

        properties: {
          sortRules: {
            type: Array,
            value: [{ruleProperty: 'rating',
                            order: ['Non-Assessed', 'Low', 'Moderate', 'Significant', 'High']}]
          }
        },

        /* _sortOrderChanged: function(e) {
          var newSortOrder = e.detail.value[0];

          console.log("newSortOrder: ");
          console.log(e.detail.value);
          console.log("sortOrder: ");
          console.log(this._sortOrder);

          var idx = _.findIndex(this._sortOrder, {column: newSortOrder.column});
          if(idx !== -1) {
            if(this._sortOrder[idx].direction === 'asc')
              this._sortOrder[idx].direction = 'desc';
            else
              this._sortOrder.splice(idx, 1);
          }
          else {
            this._sortOrder.push(newSortOrder);
          }

          console.log("AFTER");

          console.log("newSortOrder: ");
          console.log(e.detail.value);
          console.log("sortOrder: ");
          console.log(this._sortOrder);

          this._sortTable();
        },*/

        _sortOrderChanged: function() {
          this._sortTable();
        },

        _parseRule: function(rule, value) {
          if (_(rule.order).isArray()) { return _(rule.order).indexOf(value); }
          if (_(rule.order).isFunction()) { return rule.order(value); }
        },

        _sortTable: function() {
          var _this = this;
          var grid = this.$.partnerTable;
          var data = this.$.partners.data;

          var properties = _.map(grid.sortOrder, function(item) {
            return grid.columns[item.column].name;
          });
          var directions = _.map(grid.sortOrder, function(item) {
            return item.direction === 'asc' ? 1 : -1;
          });

          var mapped = _.map(data, function(item, index) {
            return {index: index, specificity: _.map(properties, function(property) {
              var value = item[property];

              var ruleIndex = _(_.pluck(_this.sortRules, 'ruleProperty')).indexOf(property);
              if (ruleIndex !== -1) { value = _this._parseRule(_this.sortRules[ruleIndex], value); }

              if (_(value).isString()) { value = value.toLowerCase(); }
              return value;
            })};
          });

          var compareValue = 0;
          mapped.sort(function(a, b) {
            if (a.specificity.toString() === b.specificity.toString()) {
              return a.index - b.index;
            }

            for (var i in _.range(properties.length)) {
              compareValue = +(a.specificity[i] > b.specificity[i]) ||
                             +(a.specificity[i] === b.specificity[i]) - 1;
              compareValue *= directions[i];
              if (compareValue !== 0) { return compareValue; }
            }
            return compareValue;
          });

          this.$.partners.data = _.map(mapped, function(item) {
            return data[item.index];
          });
        }

      });
    })();
  </script>
</dom-module>
