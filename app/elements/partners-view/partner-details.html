<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!--<link rel="import" href="../common/etools-ajax/etools-ajax.html">-->

<link rel="import" href="../../styles/pmp/layout-styles.html">
<link rel="import" href="../../styles/pmp/form-fields-styles.html">

<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../common/content-panel/content-panel.html">
<link rel="import" href="../common/etools-datepicker/etools-datepicker.html">
<link rel="import" href="../common/files-upload/files-upload.html">
<link rel="import" href="../common/content-toggle-button/content-toggle-button.html">
<link rel="import" href="../common/custom-checkbox/custom-checkbox.html">
<link rel="import" href="../common/custom-dropdown/custom-dropdown.html">

<link rel="import" href="assessments-items.html">
<link rel="import" href="staff-members.html">
<link rel="import" href="bank-details.html">

<dom-module id="partner-details">
  <template>
    <style include="layout-styles"></style>
    <style include="form-fields-styles"></style>
    <style>
      :host {
        --paper-input-container-input: {
          text-transform: uppercase;
        }
      }

      .row:not(:first-child):not(.iron-collapse-closed) {
        margin-top: 20px;
      }

      .alternate-name-btn {
        margin-bottom: 7px;
        margin-left: 25px;
      }

      .alternate-fields {
        background-color: #f0f3f5;
      }

      .alternate-fields-content {
        padding: 10px;
        box-sizing: border-box;
      }

      .alternate-fields-content .org-diff-label {
        text-transform: uppercase;
        color: #737373;
        font-size: 12px;
        width: 210px;
        line-height: 1.4;
        padding: 11px 0;
      }
      .alternate-fields-content .org-diff-label.disabled {
        opacity: 0.33;
      }

      .contact-info,
      .assessments {
        border-top: 1px solid #dedede;
        padding-top: 20px;
      }
      .contact-info {
        margin-top: 10px;
      }
      .assessments {
        margin-top: 20px;
      }

      .right-to-left {
        text-align: right;
      }
      paper-input.right-to-left {
        --paper-input-container-input: {
          direction: rtl;
          unicode-bidi: bidi-override;
        }
      }
      .already-in-vision {
        font-size: 14px;
        padding: 10px 25px;
        min-height: 45px;
        box-sizing: border-box;
      }
      .already-in-vision-stripe {
        background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAIAAABv85FHAAAAXElEQVQImXXOQQrAIAxE0YkRwfsf0lUgK7HSxO5SsHb/mPl0i8w5lzsASqmUwswAANBSBWBmX0G3SMBN5GuMgMxcaw1BvbXjmZnRUj2evS3HHOqtbVMh8nL/y3kAPcpk9pdkfNAAAAAASUVORK5CYII=) repeat;;
      }
      .already-in-vision paper-checkbox {
        line-height: 21px;
      }
      .vendor-nr-label {
        margin-left: 25px;
      }
      .vendor-number {
        border-bottom: 1px solid #333333;
        border-top: none;
        border-left: none;
        border-right: none;
        background: transparent;
        padding: 3px 10px;
        font-size: 14px;
        outline: none;
        box-sizing: border-box;
      }
      .vendor-number::-webkit-input-placeholder {
        color: #e51919;
      }
      .vendor-number:-moz-placeholder { /* Firefox 18- */
        color: #e51919;
      }
      .vendor-number::-moz-placeholder {  /* Firefox 19+ */
        color: #e51919;
      }
      .vendor-number:-ms-input-placeholder {
        color: #e51919;
      }

      .submit-btn {
        margin-top: 20px;
      }

    </style>

    <form is="iron-form" id="addPartnerDetailsForm" method="post" action="/api/testing-custom-elements">
      <div class$="flex-horizontal already-in-vision [[alreadyInVisionClass]]">
        <paper-checkbox id="alreadyPartner" name="already_partner" checked="{{partnerAlreadyInVision}}">Partner already exists in VISION?</paper-checkbox>
        <template is="dom-if" if="[[partnerAlreadyInVision]]">
          <span class="vendor-nr-label">
            Enter
            <input class="n-input-field vendor-number" type="text" placeholder="Vendor Number" value="{{partner.vendor_number}}">
            so eTools can sync partner information.
          </span>
        </template>
      </div>
      <content-panel title="Partner Details" is-disabled$="[[partnerAlreadyInVision]]">
        <div class="row flex-horizontal">
          <!-- Organization name -->
          <paper-input name="organization_name"
                       class="b-input-field"
                       label="Organization's Full Name*"
                       value="{{partner.name}}"
                       required auto-validate
                       error-message="Please fill organization's full name!"
                       disabled$="[[partnerAlreadyInVision]]"></paper-input>

          <!-- Short name -->
          <paper-input name="short_name"
                       class="n-input-field"
                       label="Short Name"
                       value="{{partner.short_name}}"
                       disabled$="[[partnerAlreadyInVision]]"></paper-input>

          <!-- Alternate option -->
          <div class="alternate-name-btn flex-bottom-aligned">
            <content-toggle-button content="[[getIronCollapseElement('#alternateNameFields')]]"
                                   label="Alternate Name?"
                                   is-disabled$="[[partnerAlreadyInVision]]"></content-toggle-button>
          </div>

        </div>
        <iron-collapse id="alternateNameFields" class="row alternate-fields">
          <!-- Alternate option fields -->
          <div class="alternate-fields-content flex-horizontal">
            <span class$="org-diff-label [[orgAltNameLabelDisabledClass]]">Organization's name in a different language</span>

            <!-- Right to left option -->
            <div class="custom-field-wrapper n-input-field">
              <custom-checkbox checked="{{alternateNameRightToLeft}}"
                               label="Right to left"
                               is-disabled$="[[partnerAlreadyInVision]]"></custom-checkbox>
            </div>

            <!-- Alternate name -->
            <paper-input name="alternate_name"
                         class$="n-input-field [[rightToLeftAlignmentClass]]"
                         label="Alternate Name"
                         value="{{partner.alternate_name}}"
                         disabled$="[[partnerAlreadyInVision]]"></paper-input>

            <!-- Alternate ID -->
            <paper-input name="alternate_id"
                         class="n-input-field"
                         label="Alternate ID (if any)"
                         value="{{partner.alternate_id}}"
                         disabled$="[[partnerAlreadyInVision]]"></paper-input>
          </div>
        </iron-collapse>
        <div class="row flex-horizontal">
          <!-- Partner types -->

          <custom-dropdown class="n-input-field"
                           label="Partner Type*"
                           dropdown-value="{{partner.partner_type}}"
                           options="[[partnerDetailsData.partnerTypes]]"
                           is-disabled$="[[partnerAlreadyInVision]]"></custom-dropdown>

          <!-- CSO type -->
          <template is="dom-if" if="[[showCsoTypeField(partner.partner_type)]]">
            <custom-dropdown class="n-input-field"
                             label="CSO Type*"
                             dropdown-value="{{partner.cso_type}}"
                             options="[[partnerDetailsData.csoTypes]]"
                             is-disabled$="[[partnerAlreadyInVision]]"></custom-dropdown>
          </template>


          <template is="dom-if" if="[[showCoreValuesAssessment(partner.cso_type)]]">
            <!-- Core values assessment file -->
            <div class="n-input-field">
              <files-upload target="/path/to/destination" label="Core values assessment*"></files-upload>
            </div>

            <!-- Last accessed date -->
            <paper-input class="n-input-field"
                         label="Date last assessed*"
                         name="date_last_assessed"
                         readonly="true"
                         value="{{partner.core_values_assessment_date}}" on-tap="showDatePicker">
              <div prefix>
                <etools-datepicker pretty-date="{{partner.core_values_assessment_date}}" format="MM/DD/YYYY" open="{{showDatePickerModal}}"></etools-datepicker>
              </div>
            </paper-input>
          </template>

          <!-- Shared partner -->
          <custom-dropdown class="n-input-field"
                           label="Shared Partner"
                           dropdown-value="{{partner.shared_partner}}"
                           options="[[partnerDetailsData.sharedPartners]]"
                           is-disabled$="[[partnerAlreadyInVision]]"></custom-dropdown>
        </div>

        <div class="contact-info">
          <content-toggle-button content="[[getIronCollapseElement('#contactInfoFields')]]"
                                 label="Contact Info"
                                 is-disabled$="[[partnerAlreadyInVision]]"></content-toggle-button>
          <!-- Contact info fields -->
          <iron-collapse id="contactInfoFields">
            <div class="flex-horizontal">
              <!-- Address -->
              <paper-input name="address"
                           class="b-input-field"
                           label="Address"
                           value="{{partner.address}}"
                           disabled$="[[partnerAlreadyInVision]]">
                <paper-icon-button prefix icon="communication:location-on"></paper-icon-button>
              </paper-input>

              <!-- City -->
              <paper-input name="city"
                           class="n-input-field"
                           label="City"
                           value="{{partner.city}}"
                           disabled$="[[partnerAlreadyInVision]]">
              </paper-input>
            </div>
            <div class="flex-horizontal">
              <!-- Telephone number -->
              <paper-input name="phone_number"
                           class="n-input-field"
                           label="Phone Number"
                           value="{{partner.phone_number}}"
                           disabled$="[[partnerAlreadyInVision]]">
                <paper-icon-button prefix icon="communication:phone"></paper-icon-button>
              </paper-input>

              <!-- Email address -->
              <paper-input name="email_address"
                           class="n-input-field"
                           label="E-mail address"
                           value="{{partner.email}}"
                           disabled$="[[partnerAlreadyInVision]]">
                <paper-icon-button prefix icon="communication:email"></paper-icon-button>
              </paper-input>
            </div>
          </iron-collapse>
        </div>

      </content-panel>

      <content-panel title="Risk Rating & Assessments">
        <div class="row flex-horizontal">
          <!-- Risk rating -->
          <paper-dropdown-menu class="n-input-field"
                               label="Risk Rating"
                               disabled="true"
                               name="risk_rating"
                               value="{{partner.rating}}">
            <paper-listbox class="dropdown-content">
              <!-- TODO: populate dropdown with right data -->
              <paper-item>Low</paper-item>
              <paper-item>Moderate</paper-item>
              <paper-item>High</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>

          <!-- Type of assessment -->
          <paper-input name="assessment_type"
                       class="n-input-field"
                       disabled="true"
                       label="Type of Assessment"
                       value="{{partner.type_of_assessment}}"></paper-input>

          <!--Date last assessed-->
          <paper-input name="date_last_assessed"
                       class="n-input-field"
                       disabled="true"
                       label="Date Last Assessed"
                       value="{{partner.last_assessment_date}}"></paper-input>
        </div>

        <!-- Assessments section -->
        <div class="assessments">
          <assessments-items assessments-data="{{partner.assessments}}" assessment-types="[[partnerDetailsData.assessmentTypes]]"></assessments-items>
        </div>
      </content-panel>

      <content-panel no-header="true">
        <content-toggle-button content="[[getIronCollapseElement('#bankDetails')]]"
                               label="Bank Details"></content-toggle-button>
        <!-- Bank details-->
        <iron-collapse id="bankDetails">
          <bank-details bank-details="{{partner.bankDetails}}" vision-synced="[[partner.vision_synced]]"></bank-details>
        </iron-collapse>
      </content-panel>

      <content-panel no-header="true">
        <!-- Staff members details-->
        <staff-members staff-members-data="{{partner.staffMembers}}"></staff-members>
      </content-panel>

    </form>
    <paper-button class="submit-btn" raised on-tap="submitAddPartnerDetailsData">Submit</paper-button>

  </template>

  <script>
    (function() {
      // jscs:disable
      'use strict';

      Polymer({
        is: 'partner-details',
        properties: {
          partnerAlreadyInVision: {
            type: Boolean,
            value: false,
            observer: '_partnerAlreadyInVision'
          },
          alternateNameRightToLeft: {
            type: Boolean,
            value: false,
            observer: '_checkAlternateNameRightToLeftAlignment'
          },
          partnerDetailsData: {
            type: Object,
            value: {
              partnerTypes: [
                {
                  value: 'cso',
                  label: 'CSO'
                },
                {
                  value: 'type1',
                  label: 'Partner Type 1'
                },
                {
                  value: 'type2',
                  label: 'Partner Type 2'
                },
                {
                  value: 'type3',
                  label: 'Partner Type 3'
                }
              ],
              csoTypes: [
                {
                  value: 0,
                  label: 'National'
                },
                {
                  value: 1,
                  label: 'International'
                }
              ],
              sharedPartners: [
                {
                  value: 'shared_type_1',
                  label: 'Partner Type 1'
                },
                {
                  value: 'shared_type_2',
                  label: 'Partner Type 2'
                }
              ],
              assessmentTypes: [
                {
                  value: 'assess_1',
                  label: 'Assessment Type 1'
                },
                {
                  value: 'assess_2',
                  label: 'Assessment Type 2'
                }
              ],
//              userRights: []
            }
          },
          partner: {
            type: Object,
            value: {
              id: null,
              vision_synced: false,
              vendor_number: null,
              name: null,
              short_name: null,
              alternate_id: null,
              alternate_name: null,
              partner_type: null,
              cso_type: null,
              core_values_assessment_date: null,
              core_values_assessment: null,
              last_assessment_date: null,
              shared_partner: null,
              address: null,
              city: null,
              phone_number: null,
              email: null,
              rating: null,
              type_of_assessment: null,

              assessments: [],
              bankDetails: [],
              staffMembers: [],

              description: null
            },
            notify: true
          }
        },
        listeners: {
          'addPartnerDetailsForm.iron-form-presubmit': '_addPartnerDetailsDataPresubmit'
        },
        getIronCollapseElement: function (elementId) {
          return Polymer.dom(this.root).querySelector(elementId);
        },
        submitAddPartnerDetailsData: function () {
          this.$.addPartnerDetailsForm.submit();
        },
        showCsoTypeField: function (partnerType) {
          if (partnerType === 'cso') {
            return true;
          } else {
            if (typeof this.partner === 'object') {
              this.set('partner.cso_type', null);
              this.set('partner.core_values_assessment_date', null);
            }
            return false;
          }
        },
        showCoreValuesAssessment: function (csoType) {
          if (csoType !== undefined && csoType !== null && csoType !== 1) { // not international
            return true;
          } else {
            if (typeof this.partner === 'object') {
              this.partner.last_assessment_date = null;
            }
            return false;
          }
        },
        showDatePicker: function () {
          this.showDatePickerModal = true;
        },
        _addPartnerDetailsDataPresubmit: function (event) {
          event.preventDefault();
          console.log(this.partner);
        },
        _checkAlternateNameRightToLeftAlignment: function (alignRightToLeft) {
          if (alignRightToLeft === true) {
            this.rightToLeftAlignmentClass = 'right-to-left';
          } else {
            this.rightToLeftAlignmentClass = '';
          }
          this.updateStyles();
        },
        _partnerAlreadyInVision: function (alreadyInVision) {
          if (alreadyInVision === true) {
            this.alreadyInVisionClass = 'already-in-vision-stripe';
            this.orgAltNameLabelDisabledClass = 'disabled';
            this._resetPartnerData();
          } else {
            this.alreadyInVisionClass = '';
            this.orgAltNameLabelDisabledClass = '';
          }
        },
        _resetPartnerData: function () {
          this.set('partner.vision_synced', false);
          for (var property in this.partner) {
            if (this.partner[property] !== null && property !== 'vision_synced') {
              if (!Array.isArray(this.partner[property])) {
                this.set('partner.' + property, null);
              }
            }
          }
        },


      });

    })();
  </script>
</dom-module>