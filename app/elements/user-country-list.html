<dom-module id="user-country-list">
  <template>
    <style>
      :host {
        display: block;

        --paper-dropdown-menu-color: {
          color: #fff;
        }

        --paper-dropdown-menu: {
          width: 100px;
          overflow: hidden;
        }
      }
    </style>
    <iron-ajax
         auto
         url="/data/user.json"
         handle-as="json"
         on-response="_userResponse"></iron-ajax>

    <iron-ajax
       auto
       url="/data/countries.json"
       handle-as="json"
       on-response="_countriesResponse"></iron-ajax>

    <paper-dropdown-menu-light label="Country">
      <paper-listbox class="dropdown-content">
         <template is="dom-repeat" items="{{userCountryData}}">
          <paper-item value="{{item.id}}">{{item.name}}</paper-item>
         </template>
      </paper-listbox>
    </paper-dropdown-menu-light>
  </template>
  <script>
    Polymer({
      is: 'user-country-list',

      properties: {
        user: {
          type: Object,
          value: {}
        },
        countries: {
          type: Array,
          value: []
        },
        userCountryData: {
          type: Array,
          value: []
        }
      },

      observers: [
        '_dataChanged(user, countries)'
      ],

      _userResponse: function(event) {
        this.user = event.detail.response;
      },

      _countriesResponse: function(event) {
        this.countries = event.detail.response;
      },

      _dataChanged: function(user, countries) {
        if (this.user != {} && this.countries.length > 0) {
          var data = this.user;
          var userCountryData = [];

          if (this.user.profile.countries_available.length > 0) {
            var contriesAvailable = this.user.profile.countries_available;

            this.userCountryData = _
              .chain(this.countries)
              .filter(function(country) {
                  return _.find(contriesAvailable, function(contriesAvailableId) {
                    return contriesAvailableId === country.id;
                  });
              })
              .sortBy('name')
              .value();
          }
        }
      },

    });
  </script>
</dom-module>