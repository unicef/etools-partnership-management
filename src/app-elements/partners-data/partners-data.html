<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">

<dom-module id="partners-data">

  <template>

    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 on-success="_handleResponse"
                 dexie-db-collection="partners"></etools-ajax>

  </template>

  <script>

    var _data = {};
    var _partnersEls = [];

    var _setPartnersData = function(data) {
      _data.partners = data || {};
      this.load(_data);
      _partnersEls.forEach(function(el) {
        if (el !== this) { el.load(_data); }
      });
    };

    var curr = null;

    Polymer({

      is: 'partners-data',

      properties: {

        partners: {
          type: Array,
          readOnly: true,
          notify: true
        },

        filteredPartners: {
          type: Array,
          readOnly: true,
          notify: true
        },

        totalResults: {
          type: Number,
          readOnly: true,
          notify: true
        },

        db: {
          type: Object,
          value: function() {
            return etoolsAppConfig.appDexieDb;
          }
        }

      },

      ready: function() {
        this.$.ajax.alternateDexieDb = etoolsAppConfig.appDexieDb;
        this.load(_data);
      },

      attached: function() {
        if (_partnersEls.length === 0 && !_data.partners) {
          this.endpoint = etoolsAppConfig.globals.getEndpoint('partners');
        }
        _partnersEls.push(this);
      },

      detached: function() {
        _partnersEls.splice(_partnersEls.indexOf(this), 1);
      },

      load: function(data) {
        if (data.partners) {
          this._setPartners(data.partners);
        }
      },

      _handleResponse: function(res) {
        _setPartnersData.bind(this)(res.detail);
      },

      query: function(field, order, searchString, partnerType, pageNumber, pageSize, showHidden) {
        if (curr) curr.abort();
        var _this = this;
        var t0 = performance.now();
        this.db.transaction('r', this.db.partners, function() {
          curr = Dexie.currentTransaction;

          var queryResult = _this.db.partners;
          if (field) queryResult = queryResult.orderBy(field); //note: null values don't appear in result set of sort
          if (order === 'desc') queryResult = queryResult.reverse();

          queryResult = queryResult.filter(function(partner) {
            if (partnerType && partner.partner_type !== partnerType) {
              return false;
            }

            if (searchString && searchString.length) {
              var vnMatch = true;
              if (partner.vendor_number) {
                vnMatch = partner.vendor_number.indexOf(searchString) < 0;
              }
              if (partner.name.toLowerCase().indexOf(searchString) < 0 && vnMatch) {
                return false;
              }
            }

            if (!showHidden && partner.hidden) {
              return false;
            }

            return true;
          });

          Dexie.ignoreTransaction(function() {
            queryResult.count(function(count) {
              _this._setTotalResults(count);
            }).catch(function(error) {
              console.error('Error counting query: ' + error);
            });
          });

          return queryResult
            .offset((pageNumber - 1) * pageSize)
            .limit(pageSize)
            .toArray();

        }).then(function(result) {
          _this._setFilteredPartners(result);

          var t1 = performance.now();
          console.log('query took: ' + (t1 - t0) + 'milliseconds')
        }).catch(function(error) {
          console.error('Error querying partners: ' + error);
        });
      }

    });

  </script>

</dom-module>
