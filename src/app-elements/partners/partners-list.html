<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../app-elements/partner-data/partner-data.html">

<link rel="import" href="partner-item.html">

<link rel="import" href="../../../styles/shared-styles.html">

<dom-module id="partners-list">

  <template>

    <style include="shared-styles iron-flex iron-flex-factors">

      :host {
        display: block;
      }

      :host([hidden]) {
        display: none;
      }

      .header {
        @apply(--layout-horizontal);
        @apply(--layout-center);

        padding: 0 39px 0 49px;
        line-height: 56px;
        font-size: 12px;
        font-weight: bold;
        color: var(--dark-primary-text-color);
        border-bottom: 1px solid var(--dark-divider-color);
      }

      .header > div {
        min-width: 100px;
        margin-right: 10px;
      }

      .header > div > span {
        cursor: pointer;
      }

      #list {
        display: block;
        position: relative;
        margin: 20px auto;
        opacity: 1;
        transition: opacity 0.4s;
        max-width: 920px;
        background-color: #FFFFFF;
      }

      #list.hidden {
        transition: none;
        opacity: 0;
      }

      .row {
        @apply(--layout-vertical);

        cursor: pointer;
        overflow: hidden;
        padding: 15px 15px;
        font-size: 13px;
        border-bottom: 1px solid var(--dark-divider-color);
      }

      .row:hover {
        background: var(--dark-hover-color);
      }

    </style>

    <partners-data></partners-data>

    <input id="query"
        type="search"
        autocomplete="off"
        value="{{q::keyup}}"
        placeholder="Search"
        on-search="_onSearch"></input>

    <button type="button" name="button" on-tap="pageLeft"> < </button>
    <button type="button" name="button" on-tap="pageRight"> > </button>

    <div id="list">

      <div class="header">
        <!-- first class of div must be name of field -->
        <div class="name flex-2"><span on-tap="_buildSortOrder">Name</span></div>
        <div class="partner_type flex-2">Type</div>
        <div class="rating flex"><span on-tap="_buildSortOrder">Risk</span></div>
      </div>

      <template id="rows" is="dom-repeat" items="[[partners]]" initial-count="10">
        <partner-item class="row" partner="[[item]]"></partner-item>
      </template>

    </div>

  </template>

  <script>

    var _lastNavigated = null;

    Polymer({

      is: 'partners-list',

      properties: {

        partners: {
          type: Array,
          observer: '_partnersChanged'
        },

        q: {
          type: String,
          notify: true,
          observer: '_qChanged'
        },

        sortOrder: {
          type: Array,
          notify: true,
          observer: '_sortChanged'
        },

        page: {
          type: Number,
          notify: true,
        },

        debounceTime: {
          type: Number,
          value: 50
        },

        queryParams: {
          type: Object
        }

      },

      observers: [
        '_updateURL(q, page, sortOrder)'
      ],

      ready: function() {
        this.$.list.classList.add('hidden');
      },

      init: function() {
        if (this.queryParams.q) {
          this.set('q', this.queryParams.q);
        } else {
          this.set('q', '');
        }

        if (this.queryParams.page) {
          this.set('page', this.queryParams.page);
        } else {
          this.set('page', 1);
        }

        if (this.queryParams.sort) {
          var s = this.queryParams.sort.split('.');
          this.set('sortOrder', [{field: s[0], order: s[1]}]);
        } else {
          this.set('sortOrder', []);
        }
      },

      launchQuery: function() {
        console.log('quering');

        var params = this.queryParams;
        var db = etoolsAppConfig.appDexieDb;
        var collection = db.partners;
        var s = params.sort ? params.sort.split('.') : ['name', 'asc'];
        var q = params.q ? params.q.toLowerCase() : '';
        var p = params.page ? params.page : 1;

        this.debounce('search', function() {

          collection = this.sort(s[0], s[1], collection);

          collection = this.filter(q, collection);

          this.paginate(p, 20, collection)
            .toArray()
            .then(function(partners) {
              this.partners = partners;
            }.bind(this));
        }, this.debounceTime);

      },

      filter: function(query, collection) {
        return collection.filter(function(partner) {
          return partner.name.toLowerCase().includes(query);
        });
      },

      sort: function(field, order, collection) {
        collection = collection.orderBy(field);
        if (order === 'desc') collection = collection.reverse();
        return collection;
      },

      paginate: function(pageNumber, pageSize, collection) {
        return collection.offset((pageNumber - 1) * pageSize).limit(pageSize);
      },

      pageLeft: function() {
        if (this.page > 1) this.set('page', this.page - 1);
        this.set('debounceTime', 100);
      },

      pageRight: function() {
        if (this.page < 66) this.set('page', this.page + 1);
        this.set('debounceTime', 100);
      },

      _updateURL: function() {
        var qs = this._buildQueryString();
        if (qs !== _lastNavigated) {
          _lastNavigated = qs;
          var currentState = window.history.state;
          window.history.replaceState(currentState, null, 'list' + (qs.length ? '?' + qs : ''));
          window.dispatchEvent(new CustomEvent('location-changed'));
          this.launchQuery();
        }
      },

      _buildSortOrder: function(e) {
        var _field = e.path[1].classList[0];
        var _order = 'asc';
        if (this.sortOrder[0] && this.sortOrder[0].field === _field) {
          _order = this.sortOrder[0].order === 'asc' ? 'desc': 'asc';
        }
        this.set('sortOrder', [{field: _field, order: _order}]);
      },

      _buildQueryString: function() {
        var out = [];
        if (this.page && this.page > 1) out.push('page=' + this.page);
        if (this.q && this.q.length) out.push('q=' + this.q);
        if (this.sortOrder && this.sortOrder.length) {
          var sortQuery = [];
          this.sortOrder.forEach(function(sort) {
            if (sort.field && sort.order) {
              sortQuery.push('' + sort.field + '.' + sort.order);
            }
          });
          out.push('sort=' + sortQuery.join('+'));
        }
        return out.join("&");
      },

      _onSearch: function() {
        this.q = this.$.query.value;
      },

      _qChanged: function(q) {
        if (q) {
          this.async(function() {
            this.$.query.focus();
          });
        }
        this.set('page', 1);
        this.set('debounceTime', 300);
      },

      _sortChanged: function() {
        this.set('debounceTime', 50);
      },

      _partnersChanged: function() {
        this.$.list.classList.add('hidden');
        this.async(function() {
          this.$.list.classList.remove('hidden');
        }, 50);
      }

    });

  </script>

</dom-module>
