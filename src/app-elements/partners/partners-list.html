<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../app-elements/partner-data/partner-data.html">

<link rel="import" href="partner-item.html">

<link rel="import" href="../../../styles/shared-styles.html">

<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<dom-module id="partners-list">

  <template>

    <style include="shared-styles iron-flex iron-flex-factors">

      :host {
        display: block;
      }

      :host([hidden]) {
        display: none;
      }

      .header {
        @apply(--layout-horizontal);
        @apply(--layout-center);

        padding: 0 39px 0 49px;
        line-height: 56px;
        font-size: 12px;
        font-weight: bold;
        color: var(--dark-primary-text-color);
        border-bottom: 1px solid var(--dark-divider-color);
      }

      .header > div {
        min-width: 100px;
        margin-right: 10px;
      }

      .header > div > span {
        cursor: pointer;
      }

      #list {
        display: block;
        position: relative;
        margin: 20px auto;
        opacity: 1;
        transition: opacity 0.4s;
        max-width: 920px;
        background-color: #FFFFFF;
      }

      #list.hidden {
        transition: none;
        opacity: 0;
      }

      .row {
        @apply(--layout-vertical);

        cursor: pointer;
        overflow: hidden;
        padding: 15px 15px;
        font-size: 13px;
        border-bottom: 1px solid var(--dark-divider-color);
      }

      .row:hover {
        background: var(--dark-hover-color);
      }

    </style>

    <partners-data id="partners" filtered-partners="{{filteredPartners}}" total-results="{{totalResults}}"></partners-data>

    <h3>Showing [[visibleRange.0]] - [[visibleRange.1]] of [[totalResults]] results</h3>

    <input id="query"
        type="search"
        autocomplete="off"
        value="{{q::keyup}}"
        placeholder="Search"
        on-search="_onSearch"></input>

    <button type="button" name="button" on-tap="_pageLeft"> < </button>
    <button type="button" name="button" on-tap="_pageRight"> > </button>

    <paper-menu-button>
      <paper-item class="dropdown-trigger">[[pageSize]]</paper-item>
      <paper-menu class="dropdown-content" on-iron-select="_pageSizeSelected">
        <paper-item>5</paper-item>
        <paper-item>10</paper-item>
        <paper-item>25</paper-item>
        <paper-item>50</paper-item>
      </paper-menu>
    </paper-menu-button>

    <div id="list">

      <div class="header">
        <!-- first class of div must be name of field -->
        <div class="name flex-2"><span on-tap="_buildSortOrder">Name</span></div>
        <div class="partner_type flex-2">Type</div>
        <div class="rating flex"><span on-tap="_buildSortOrder">Risk</span></div>
      </div>

      <template id="rows" is="dom-repeat" items="[[filteredPartners]]" initial-count="10">
        <partner-item class="row" partner="[[item]]"></partner-item>
      </template>

    </div>

  </template>

  <script>

    var _lastNavigated = null;

    Polymer({

      is: 'partners-list',

      properties: {

        filteredPartners: {
          type: Array,
          notify: true,
          observer: '_partnersChanged'
        },

        q: {
          type: String,
          notify: true,
          observer: '_qChanged'
        },

        sortOrder: {
          type: Array,
          notify: true,
        },

        pageNumber: {
          type: Number,
          notify: true,
        },

        totalPages: {
          type: Number,
          notify: true,
          computed: '_computeTotalPages(pageSize, totalResults)',
          value: 20
        },

        visibleRange: {
          type: Array,
          computed: '_computeVisibleRange(pageNumber, pageSize, totalPages)'
        },

        pageSize: {
          type: Number,
          notify: true,
          value: 10
        },

        debounceTime: {
          type: Number,
          value: 50
        },

      },

      observers: [
        '_updateURL(q, pageNumber, pageSize, sortOrder)',
      ],

      ready: function() {
        this.$.list.classList.add('hidden');
      },

      init: function(urlParams) {
        if (!urlParams) return;
        this.set('q', urlParams.q ? urlParams.q : '');
        this.set('pageNumber', urlParams.page ? parseInt(urlParams.page) : 1);
        this.set('pageSize', urlParams.size ? parseInt(urlParams.size) : 5);
        var result = [{field: 'name', order: 'asc'}];
        if (urlParams.sort) {
          var p = urlParams.sort.split('.');
          result = [{field: p[0], order: p[1]}];
        }
        this.set('sortOrder', result);
      },

      _updateURL: function() {
        var qs = this._buildQueryString();
        if (qs !== _lastNavigated) {
          _lastNavigated = qs;
          var currentState = window.history.state;
          window.history.replaceState(currentState, null, 'list' + (qs.length ? '?' + qs : ''));
          window.dispatchEvent(new CustomEvent('location-changed'));

          this.debounce('query', function() {
            console.log('querying');
            this.$.partners.query(
              this.sortOrder[0].field,
              this.sortOrder[0].order,
              this.q,
              this.pageNumber,
              this.pageSize);
          }, this.debounceTime);

        }
      },

      _buildQueryString: function() {
        var out = [];
        if (this.pageNumber && this.pageNumber > 1) out.push('page=' + this.pageNumber);
        if (this.pageSize) out.push('size=' + this.pageSize);
        if (this.q && this.q.length) out.push('q=' + this.q);
        if (this.sortOrder && this.sortOrder.length) {
          var sortQuery = [];
          this.sortOrder.forEach(function(sort) {
            if (sort.field && sort.order) {
              sortQuery.push('' + sort.field + '.' + sort.order);
            }
          });
          out.push('sort=' + sortQuery.join('+'));
        }
        return out.join("&");
      },

      _buildSortOrder: function(e) {
        var _field = e.path[1].classList[0];
        var _order = 'asc';
        if (this.sortOrder[0] && this.sortOrder[0].field === _field) {
          _order = this.sortOrder[0].order === 'asc' ? 'desc': 'asc';
        }
        this.set('debounceTime', 150);
        this.set('sortOrder', [{field: _field, order: _order}]);
      },

      _pageLeft: function() {
        this.set('debounceTime', 20);
        if (this.pageNumber > 1) this.set('pageNumber', this.pageNumber - 1);
      },

      _pageRight: function() {
        this.set('debounceTime', 20);
        if (this.pageNumber < this.totalPages) this.set('pageNumber', this.pageNumber + 1);
      },

      _onSearch: function() {
        this.q = this.$.query.value;
      },

      _qChanged: function(q) {
        if (q) {
          this.async(function() {
            this.$.query.focus();
          });
        }
        this.set('debounceTime', 300);
        this.set('pageNumber', 1);
      },

      _pageSizeSelected: function(e, detail) {
        this.set('debounceTime', 200);
        this.set('pageNumber', 1);
        this.set('pageSize', parseInt(detail.item.innerText));
      },

      _computeTotalPages: function(pageSize, totalResults) {
        var result = 1;
        if (pageSize < totalResults) result = Math.ceil(totalResults / pageSize);
        return result;
      },

      _computeVisibleRange: function(pageNumber, pageSize, totalPages) {
        var start = 1;
        var end = this.totalResults;

        if (pageNumber !== 1)          start = (pageNumber - 1) * pageSize + 1;
        if (pageNumber !== totalPages) end = start + pageSize - 1;

        return [start, end];
      },

      _partnersChanged: function() {
        this.$.list.classList.add('hidden');
        this.async(function() {
          this.$.list.classList.remove('hidden');
        }, 50);
      }

    });

  </script>

</dom-module>
